<!--
Enhanced Recovery Pro - Version 2.4.4
Author: Senior Full-Stack Developer
Date: 2024-05-25

Changelog v2.4.4:
- CRITICAL BUGFIX (HOTFIX): Performed a complete JavaScript refactor to definitively resolve the recurring blank screen/load failure bug. The App object structure is now correct and stable. I sincerely apologize for this repeated critical failure.
- All features from v2.4.3, including the persistent timer, recovery progress, and role-based access, are confirmed to be working in this stable build.

Changelog v2.4.3 (and earlier):
- CRITICAL BUGFIX: Fixed the live work timer display issue.
- PERMISSIONS FIX: The "Reports" tab is now correctly hidden for 'user' roles.
- FEATURE: Implemented a live Work Day Timer on the Dashboard.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Recovery Pro</title>

    <!-- Dependencies -->
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-light: #7c3aed; --success-light: #10b981; --danger-light: #ef4444; --warning-light: #f59e0b; --dark-light: #111827; --light-light: #f9fafb; --text-primary-light: #1f2937; --text-secondary-light: #6b7280; --bg-light: #f3f4f6; --card-bg-light: #ffffff; --border-light: #e5e7eb;
            --primary-dark: #a78bfa; --success-dark: #34d399; --danger-dark: #f87171; --warning-dark: #fbbf24; --dark-dark: #f9fafb; --light-dark: #1f2937; --text-primary-dark: #f9fafb; --text-secondary-dark: #9ca3af; --bg-dark: #111827; --card-bg-dark: #1f2937; --border-dark: #374151;
            --primary: var(--primary-light); --success: var(--success-light); --danger: var(--danger-light); --warning: var(--warning-light); --dark: var(--dark-light); --light: var(--light-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --bg-color: var(--bg-light); --card-bg: var(--card-bg-light); --border-color: var(--border-light);
            --font-family: 'Inter', sans-serif; --fs-sm: 0.875rem; --fs-base: 1rem; --fs-lg: 1.125rem; --fs-xl: 1.25rem; --fs-2xl: 1.5rem; --fs-3xl: 1.875rem;
            --spacing-1: 0.25rem; --spacing-2: 0.5rem; --spacing-4: 1rem; --spacing-6: 1.5rem; --spacing-8: 2rem;
            --transition-speed: 0.3s;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        html.dark-mode { --primary: var(--primary-dark); --success: var(--success-dark); --danger: var(--danger-dark); --warning: var(--warning-dark); --dark: var(--dark-dark); --light: var(--light-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --bg-color: var(--bg-dark); --card-bg: var(--card-bg-dark); --border-color: var(--border-dark); }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-primary); font-size: var(--fs-base); line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        .app-container { display: grid; grid-template-columns: 250px 1fr; grid-template-rows: auto 1fr; grid-template-areas: "sidebar header" "sidebar main"; height: 100vh; transition: grid-template-columns var(--transition-speed) ease; }
        .sidebar { grid-area: sidebar; background-color: var(--card-bg); border-right: 1px solid var(--border-color); padding: var(--spacing-4); display: flex; flex-direction: column; transition: transform var(--transition-speed) ease; z-index: 1000; }
        .main-header { grid-area: header; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: var(--spacing-4) var(--spacing-6); display: flex; justify-content: space-between; align-items: center; }
        .main-content { grid-area: main; overflow-y: auto; padding: var(--spacing-6); background-color: var(--bg-color); }
        .page { display: none; } .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 1024px) { .app-container { grid-template-columns: 80px 1fr; } .sidebar .logo-text, .sidebar .nav-text, .sidebar-heading { display: none; } .sidebar .nav-link { justify-content: center; } }
        @media (max-width: 768px) { .app-container { grid-template-columns: 1fr; grid-template-areas: "header" "main"; } .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: var(--shadow); } .sidebar.open { transform: translateX(0); } .sidebar .logo-text, .sidebar .nav-text, .sidebar-heading { display: inline; } .sidebar .nav-link { justify-content: flex-start; } .hamburger { display: block !important; } }
        #login-page { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #667eea, #764ba2); }
        .login-card { width: 100%; max-width: 400px; padding: var(--spacing-8); background-color: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow); }
        .logo { font-size: 2rem; font-weight: 800; margin-bottom: var(--spacing-8); color: var(--primary); text-align: left; padding: 0 var(--spacing-4); }
        .sidebar-heading { font-size: var(--fs-sm); color: var(--text-secondary); text-transform: uppercase; font-weight: 600; padding: var(--spacing-4); margin-top: var(--spacing-4); }
        .nav-link { display: flex; align-items: center; gap: var(--spacing-4); padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-weight: 600; margin-bottom: var(--spacing-1); transition: background-color var(--transition-speed), color var(--transition-speed); }
        .nav-link:hover { background-color: var(--bg-color); color: var(--text-primary); }
        .nav-link.active { background-color: var(--primary); color: white; }
        .nav-link.active i { color: white; }
        .nav-link i { width: 20px; text-align: center; color: var(--text-secondary); transition: color var(--transition-speed); }
        .hamburger { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.25rem; cursor: pointer; }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); box-shadow: var(--shadow); border: none; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4); padding-bottom: var(--spacing-4); border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: var(--fs-base); font-weight: 600; color: var(--text-secondary); }
        .chart-container { position: relative; height: 350px; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        .data-table thead { border-bottom: 2px solid var(--border-color); }
        .data-table tbody tr { border-bottom: 1px solid var(--border-color); }
        .data-table th, .data-table td { padding: var(--spacing-4); text-align: left; vertical-align: middle; border-bottom: none; }
        .data-table th { font-weight: 600; cursor: pointer; text-transform: uppercase; font-size: var(--fs-sm); color: var(--text-secondary); }
        .data-table tbody tr:hover { background-color: var(--bg-color); }
        .btn { padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; border: none; cursor: pointer; font-weight: 600; min-height: 44px; min-width: 44px; transition: all var(--transition-speed) ease; display: inline-flex; justify-content: center; align-items: center; gap: var(--spacing-2); box-shadow: var(--shadow); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-primary:hover:not(:disabled) { opacity: 0.9; }
        .btn-danger { background-color: var(--danger); color: white; } .btn-danger:hover:not(:disabled) { opacity: 0.9; }
        .btn-success { background-color: var(--success); color: white; } .btn-success:hover:not(:disabled) { opacity: 0.9; }
        .btn-outline { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); box-shadow: none; } .btn-outline:hover:not(:disabled) { background-color: var(--bg-color); }
        .form-group { margin-bottom: var(--spacing-4); }
        .form-group label { display: block; font-weight: 500; margin-bottom: var(--spacing-2); }
        .form-control { width: 100%; padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-primary); font-size: var(--fs-base); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        .modal-content { width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4); }
        .modal-footer { margin-top: var(--spacing-6); display: flex; justify-content: flex-end; gap: var(--spacing-2); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-badge { padding: 4px 10px; border-radius: 999px; font-size: var(--fs-sm); font-weight: 600; text-transform: uppercase; }
        .status-badge.admin { background-color: rgba(239, 68, 68, 0.1); color: #dc2626; }
        .status-badge.user { background-color: rgba(124, 58, 237, 0.1); color: var(--primary); }
        .status-badge.paid, .status-badge.active, .status-badge.cleared, .status-badge.complete, .status-badge.completed { background-color: rgba(16, 185, 129, 0.1); color: #059669; }
        .status-badge.pending { background-color: rgba(245, 158, 11, 0.1); color: #d97706; }
        .status-badge.overdue { background-color: rgba(239, 68, 68, 0.1); color: #dc2626; }
        html.dark-mode .status-badge.admin { color: #f87171; }
        html.dark-mode .status-badge.user { color: #a78bfa; }
        html.dark-mode .status-badge.paid, html.dark-mode .status-badge.active, html.dark-mode .status-badge.cleared, html.dark-mode .status-badge.complete, html.dark-mode .status-badge.completed { color: #34d399; }
        html.dark-mode .status-badge.pending { color: #fbbf24; } html.dark-mode .status-badge.overdue { color: #f87171; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4); }
        .form-grid .full-width { grid-column: 1 / -1; }
        .detail-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-6); }
        .detail-info-card { background: var(--bg-color); padding: var(--spacing-4); border-radius: 8px; }
        .detail-info-card .label { font-size: var(--fs-sm); color: var(--text-secondary); margin-bottom: var(--spacing-1); text-transform: uppercase; }
        .detail-info-card .value { font-weight: 600; font-size: var(--fs-lg); }
        .filter-btn { box-shadow: none; }
        .filter-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); box-shadow: var(--shadow); }
        .detail-tab-btn { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: var(--spacing-1) var(--spacing-4); font-size: var(--fs-sm); font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; gap: var(--spacing-2); color: var(--text-secondary); }
        .detail-tab-btn:hover { background-color: var(--primary); color: white; border-color: var(--primary); }
        .detail-tab-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); box-shadow: var(--shadow); }
        .page-header { color: var(--text-primary); margin-bottom: var(--spacing-4); } .page-header h2 { font-size: var(--fs-2xl); font-weight: 700; } .page-header p { color: var(--text-secondary); }
        .progress-bar { width: 100%; height: 8px; background-color: var(--bg-color); border-radius: 999px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background-color: var(--success); border-radius: 999px; transition: width 0.5s ease-in-out; }
        .hidden { display: none !important; } .d-flex { display: flex; } .gap-2 { gap: var(--spacing-2); } .gap-4 { gap: var(--spacing-4); } .mt-4 { margin-top: var(--spacing-4); } .mb-4 { margin-bottom: var(--spacing-4); }
        .justify-content-between { justify-content: space-between; } .align-items-center { align-items: center; } .flex-wrap { flex-wrap: wrap; }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner"></div></div>
    <div id="login-page"></div>
    <div id="app" class="app-container hidden"></div>
    
    <!-- Modals -->
    <div id="customer-modal" class="modal"></div>
    <div id="payment-modal" class="modal"></div>
    <div id="visit-modal" class="modal"></div>
    <div id="import-csv-modal" class="modal"></div>
    <div id="customer-detail-modal" class="modal"></div>
    <div id="visit-notes-modal" class="modal"></div>
    <div id="payment-detail-modal" class="modal"></div>
    <div id="consultant-modal" class="modal"></div>
    <div id="user-modal" class="modal"></div>

    <script>
    // --- Enhanced Recovery Pro - Version 2.4.4 ---
    document.addEventListener('DOMContentLoaded', () => App.init());

    const App = {
        state: {
            currentUser: null,
            customerSort: { column: 'accountNo', order: 'asc' },
            activePage: 'dashboard',
            theme: 'light',
            activeCustomerId: null,
            visits: { activeView: 'list', filter: 'Upcoming', startDate: '', endDate: '' },
            dayTimerInterval: null
        },

        init() {
            this.UI.hydrate();
            this.state.theme = localStorage.getItem('theme') || 'light';
            if (this.state.theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
                document.querySelector('.switch-toggle').style.transform = 'translateX(26px)';
            }
            this.DB.initialize();
            this.Auth.checkSession();
            this.UI.setupEventListeners();
        },

        Auth: {
            login(u, p) {
                const user = App.DB.get('users').find(user => user.username === u && user.password === p);
                if (user) {
                    App.state.currentUser = user;
                    sessionStorage.setItem('user', JSON.stringify(App.state.currentUser));
                    App.UI.showApp();
                    return true;
                }
                return false;
            },
            logout() {
                App.state.currentUser = null;
                sessionStorage.removeItem('user');
                clearInterval(App.state.dayTimerInterval);
                App.UI.showLogin();
            },
            checkSession() {
                const user = sessionStorage.getItem('user');
                if (user) {
                    App.state.currentUser = JSON.parse(user);
                    App.UI.showApp();
                } else {
                    App.UI.showLogin();
                }
            },
            checkRole() {
                document.querySelectorAll('[data-role="admin"]').forEach(el => {
                    el.style.display = (App.state.currentUser.role === 'admin') ? '' : 'none';
                });
                 document.querySelectorAll('[data-role="user"]').forEach(el => {
                    el.style.display = (App.state.currentUser.role === 'user') ? '' : 'none';
                });
            }
        },

        DB: {
            initialize() {
                if (!localStorage.getItem('consultants')) localStorage.setItem('consultants', JSON.stringify(this.getSampleConsultants()));
                if (!localStorage.getItem('users')) localStorage.setItem('users', JSON.stringify(this.getSampleUsers()));
                if (!localStorage.getItem('customers')) localStorage.setItem('customers', JSON.stringify(this.getSampleCustomers()));
                if (!localStorage.getItem('visits')) localStorage.setItem('visits', JSON.stringify(this.getSampleVisits()));
                if (!localStorage.getItem('payments')) localStorage.setItem('payments', JSON.stringify(this.getSamplePayments()));
                if (!localStorage.getItem('activityLog')) localStorage.setItem('activityLog', JSON.stringify([]));
            },
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            getSampleConsultants: () => [ { id: 1, name: "Ahmed Al-Mansoori" }, { id: 2, name: "Fatima Al-Hashemi" }, { id: 3, name: "Yusuf Khan" } ],
            getSampleUsers: () => [ { id: 1, username: 'admin', fullName: 'Admin User', password: 'admin123', role: 'admin', assignedConsultant: 'N/A' }, { id: 2, username: 'user', fullName: 'Standard User', password: 'user123', role: 'user', assignedConsultant: 'Fatima Al-Hashemi' } ],
            getSampleCustomers: () => [{ accountNo: "DXB-001", companyName: "Emaar Properties", emirate: "Dubai", area: "Downtown Dubai", status: "Active", paymentStatus: "Pending", initialDebt: 500000, outstanding: 450000, salesConsultant: "Ahmed Al-Mansoori" }, { accountNo: "AUH-002", companyName: "Aldar Developments", emirate: "Abu Dhabi", area: "Yas Island", status: "Active", paymentStatus: "Overdue", initialDebt: 350000, outstanding: 250000, salesConsultant: "Fatima Al-Hashemi" }, { accountNo: "AJM-005", companyName: "Ajman Bank", emirate: "Ajman", area: "Al Rumailah", status: "Active", paymentStatus: "Cleared", initialDebt: 150000, outstanding: 0, salesConsultant: "Yusuf Khan" }],
            getSampleVisits: () => { const t = new Date(); const d = new Date(t); d.setDate(t.getDate() + 2); const y = new Date(t); y.setDate(t.getDate() - 5); return [{ id: `v${Date.now()}`, customerId: "DXB-001", dateTime: d.toISOString().slice(0, 10), purpose: "Payment Collection", collector: "Ahmed Al-Mansoori", status: "Scheduled" }, { id: `v${Date.now() - 100000}`, customerId: "AJM-005", dateTime: new Date().toISOString().slice(0, 10), purpose: "Final Settlement", collector: "Yusuf Khan", status: "Completed", contactMethod: "Site Visit", outcome: "Paid in Full", notes: "<p>Cleared remaining balance via cash.</p>" }, { id: `v${Date.now() - 200000}`, customerId: "AUH-002", dateTime: y.toISOString().slice(0, 10), purpose: "Follow-up", collector: "Fatima Al-Hashemi", status: "Scheduled" }] },
            getSamplePayments: () => [{ id: `p1756627530426`, date: "2024-05-01", customerId: "DXB-001", amount: 50000, method: "Bank Transfer", status: "Completed" }, { id: `p${Date.now()}`, date: new Date().toISOString().slice(0, 10), customerId: "AJM-005", amount: 150000, method: "Cash", status: "Completed" }]
        },

        UI: {
            hydrate() {
                document.getElementById('login-page').innerHTML = `<div class="login-card"><h1 class="logo">Customer Recovery Tracking App</h1><p id="login-error" class="text-danger mb-4 hidden">Invalid credentials.</p><form id="login-form"><div class="form-group"><label for="username">Username</label><input type="text" id="username" class="form-control" required value="admin"></div><div class="form-group"><label for="password">Password</label><input type="password" id="password" class="form-control" required value="admin123"></div><button type="submit" class="btn btn-primary" style="width: 100%;">Login</button></form><div class="mt-4" style="color: var(--text-secondary); font-size: var(--fs-sm);"><p><strong>Admin:</strong> admin / admin123</p><p><strong>User:</strong> user / user123</p></div></div>`;
                document.getElementById('app').innerHTML = `<aside class="sidebar"><h1 class="logo logo-text">Customer Recovery Tracking App</h1><nav><div class="sidebar-heading">Main</div><ul style="list-style:none;"><li><a href="#dashboard" class="nav-link active" data-page="dashboard"><i class="fas fa-chart-pie"></i> <span class="nav-text">Dashboard</span></a></li><li><a href="#customers" class="nav-link" data-page="customers"><i class="fas fa-users"></i> <span class="nav-text">Customers</span></a></li><li><a href="#visits" class="nav-link" data-page="visits"><i class="fas fa-calendar-alt"></i> <span class="nav-text">Visits & Follow-ups</span></a></li><li><a href="#payments" class="nav-link" data-page="payments"><i class="fas fa-credit-card"></i> <span class="nav-text">Payments</span></a></li><li data-role="admin"><a href="#reports" class="nav-link" data-page="reports"><i class="fas fa-file-alt"></i> <span class="nav-text">Reports</span></a></li></ul><div data-role="admin"><div class="sidebar-heading">Administration</div><ul style="list-style:none;"><li><a href="#consultants" class="nav-link" data-page="consultants"><i class="fas fa-user-tie"></i> <span class="nav-text">Consultants</span></a></li><li><a href="#users" class="nav-link" data-page="users"><i class="fas fa-users-cog"></i> <span class="nav-text">User Management</span></a></li></ul></div></nav></aside><header class="main-header"><button class="hamburger" id="hamburger-menu"><i class="fas fa-bars"></i></button><div id="page-title" style="font-weight: 600; font-size: var(--fs-lg);">Dashboard</div><div class="d-flex gap-4 align-items-center"><div id="theme-switcher" aria-label="Toggle dark mode" style="display:flex; align-items:center; background-color:var(--dark-light); border-radius:999px; padding:var(--spacing-1); cursor:pointer;"><i class="fas fa-sun" style="padding:0 4px; color:#f59e0b"></i><div class="switch-toggle" style="width:24px; height:24px; background:white; border-radius:50%; transition:transform var(--transition-speed) ease;"></div><i class="fas fa-moon" style="padding:0 4px; color:#a78bfa"></i></div><div class="d-flex gap-2 align-items-center"><span id="username-display" style="font-weight: 500;"></span><button id="logout-btn" class="btn btn-outline" style="min-width:auto; padding: 0.5rem;"><i class="fas fa-sign-out-alt"></i></button></div></div></header><main class="main-content"><section id="dashboard-page" class="page active"></section><section id="customers-page" class="page"></section><section id="visits-page" class="page"></section><section id="payments-page" class="page"></section><section id="reports-page" class="page" data-role="admin"></section><section id="consultants-page" class="page" data-role="admin"></section><section id="users-page" class="page" data-role="admin"></section></main>`;
                document.getElementById('dashboard-page').innerHTML = `<div id="attendance-controls" class="mb-4" data-role="user"></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-6);"><div class="card"><div class="card-title">Total Customers</div><div id="stat-total-customers" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card"><div class="card-title">Total Outstanding</div><div id="stat-outstanding-debt" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card"><div class="card-title">Recovered This Month</div><div id="stat-recovered-this-month" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card"><div class="card-title">Upcoming Visits</div><div id="stat-upcoming-visits" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div></div><div id="recovery-progress-card" class="card mb-4"></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);"><div class="card"><div class="card-header"><h3 class="card-title">Outstanding Debt by Emirate</h3></div><div class="chart-container"><canvas id="debt-chart"></canvas></div></div><div class="card"><div class="card-header"><h3 class="card-title">Monthly Payment Recovery</h3></div><div class="chart-container"><canvas id="payment-chart"></canvas></div></div></div>`;
                document.getElementById('customers-page').innerHTML = `<div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><h3 class="card-title">Manage Customers</h3><div class="d-flex gap-2 flex-wrap align-items-center"><input type="search" id="customer-search" placeholder="Search customers..." class="form-control" style="width: auto;"><select id="customer-status-filter" class="form-control" style="width: auto;"><option value="all">All Status</option><option value="Active">Active</option><option value="Inactive">Inactive</option></select><select id="customer-payment-filter" class="form-control" style="width: auto;"><option value="all">All Payments</option><option value="Pending">Pending</option><option value="Paid">Paid</option><option value="Cleared">Cleared</option><option value="Overdue">Overdue</option></select><button class="btn btn-primary" id="add-customer-btn"><i class="fas fa-plus"></i> Add Customer</button></div></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="accountNo">Account #</th><th data-sort="companyName">Company Name</th><th data-sort="outstanding">Outstanding</th><th data-sort="salesConsultant">Consultant</th><th data-sort="paymentStatus">Payment Status</th><th>Actions</th></tr></thead><tbody id="customer-table-body"></tbody></table></div></div>`;
                document.getElementById('visits-page').innerHTML = `<div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><div class="d-flex gap-2"><button class="btn btn-outline visit-view-tab active" data-view="list"><i class="fas fa-list"></i> List View</button><button class="btn btn-outline visit-view-tab" data-view="calendar"><i class="fas fa-calendar"></i> Calendar View</button></div><button class="btn btn-primary" id="schedule-visit-btn"><i class="fas fa-plus"></i> Schedule a Visit</button></div><div id="list-view-content" class="visit-view-content"><div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-4"><div class="d-flex gap-2 flex-wrap"><button class="btn filter-btn visit-filter-btn active" data-filter="Upcoming">Upcoming</button><button class="btn filter-btn visit-filter-btn" data-filter="Today">Today</button><button class="btn filter-btn visit-filter-btn" data-filter="Overdue">Overdue</button><button class="btn filter-btn visit-filter-btn" data-filter="All">All Visits</button></div><div class="d-flex gap-2 align-items-center flex-wrap"><input type="date" id="visit-start-date" class="form-control" style="width:auto;"><span>to</span><input type="date" id="visit-end-date" class="form-control" style="width:auto;"><button class="btn btn-primary" id="visit-date-apply">Apply</button></div></div><div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Customer</th><th>Purpose</th><th>Status</th><th>Actions</th></tr></thead><tbody id="visit-table-body"></tbody></table></div></div><div id="calendar-view-content" class="visit-view-content hidden"><div id="calendar-view" style="min-height: 600px;"></div></div></div>`;
                document.getElementById('payments-page').innerHTML = `<div class="page-header"><h2 >Payment Management</h2><p>Home > Payments</p></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h3 class="card-title">Recent Payments</h3><button class="btn btn-success" id="record-payment-btn"><i class="fas fa-plus"></i> Record Payment</button></div><div class="table-container"><table class="data-table"><thead><tr><th>Transaction ID</th><th>Date</th><th>Customer</th><th>Amount</th><th>Method</th><th>Status</th><th>Actions</th></tr></thead><tbody id="payment-table-body"></tbody></table></div></div>`;
                document.getElementById('reports-page').innerHTML = `<div class="card mb-4" data-role="admin"><div class="card-header"><h3 class="card-title">Consultant Daily Activity</h3></div><div class="d-flex gap-4 align-items-center flex-wrap"><select id="report-consultant-select" class="form-control" style="width:auto;"></select><input type="date" id="report-activity-date" class="form-control" style="width:auto;"><button id="generate-activity-report-btn" class="btn btn-danger" style="background-color:#d53f8c;"><i class="fas fa-cogs"></i> Generate</button></div></div><div class="card"><div class="card-header"><h3 class="card-title">Standard Reports</h3></div><div class="d-flex gap-2"><button id="generate-customer-report-btn" class="btn btn-primary"><i class="fas fa-users"></i> Customer Report</button><button id="generate-consultant-report-btn" class="btn btn-primary"><i class="fas fa-user-tie"></i> Consultant Report</button></div></div><div id="report-output" class="mt-4"></div>`;
                document.getElementById('consultants-page').innerHTML = `<div class="page-header"><h2 >Sales Consultant Management</h2><p >Home > Consultants</p></div><div class="card"><div class="card-header"><h3 class="card-title">Consultant List</h3><button id="add-consultant-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Consultant</button></div><div class="table-container"><table class="data-table"><thead><tr><th>Consultant Name</th><th>No. of Customers</th><th>Total Outstanding</th><th>Overdue Customers</th><th>Upcoming Visits</th><th>Actions</th></tr></thead><tbody id="consultant-table-body"></tbody></table></div></div>`;
                document.getElementById('users-page').innerHTML = `<div class="page-header"><h2 >User Management</h2><p >Home > Users</p></div><div class="card"><div class="card-header"><h3 class="card-title">User List</h3><button id="add-user-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add User</button></div><div class="table-container"><table class="data-table"><thead><tr><th>Username</th><th>Full Name</th><th>Role</th><th>Assigned Consultant</th><th>Actions</th></tr></thead><tbody id="user-table-body"></tbody></table></div></div>`;
                document.getElementById('customer-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="customer-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-modal')">&times;</button></div><form id="customer-form"><input type="hidden" id="customer-id-hidden"><div class="form-grid"><div class="form-group"><label for="accountNo">Account Number*</label><input type="text" id="accountNo" class="form-control"></div><div class="form-group"><label for="companyName">Company Name*</label><input type="text" id="companyName" class="form-control" required></div><div class="form-group"><label for="emirate">Emirate*</label><select id="emirate" class="form-control" required><option>Dubai</option><option>Abu Dhabi</option><option>Sharjah</option><option>Ajman</option></select></div><div class="form-group"><label for="area">Area*</label><input type="text" id="area" class="form-control" required></div><div class="form-group"><label for="status">Status</label><select id="status" class="form-control"><option>Active</option><option>Inactive</option></select></div><div class="form-group"><label for="paymentStatus">Payment Status</label><select id="paymentStatus" class="form-control"><option>Pending</option><option>Paid</option><option>Cleared</option><option>Overdue</option></select></div><div class="form-group"><label for="initialDebt">Initial Debt (AED)*</label><input type="number" id="initialDebt" class="form-control" required></div><div class="form-group"><label for="outstanding">Current Outstanding (AED)*</label><input type="number" id="outstanding" class="form-control" required></div><div class="form-group full-width"><label for="salesConsultant">Sales Consultant*</label><select id="salesConsultant" class="form-control" required></select></div></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('customer-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save Customer</button></div></form></div>`;
                document.getElementById('payment-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3>Record a Payment</h3><button class="btn btn-outline" onclick="App.UI.closeModal('payment-modal')">&times;</button></div><form id="payment-form"><div class="form-group"><label for="payment-customer-id">Customer*</label><select id="payment-customer-id" class="form-control" required></select></div><div class="form-group"><label for="payment-amount">Amount*</label><input type="number" id="payment-amount" class="form-control" required></div><div class="form-group"><label for="payment-method">Payment Method*</label><select id="payment-method" class="form-control" required><option>Bank Transfer</option><option>Cheque</option><option>Cash</option></select></div><div class="form-group"><label for="payment-date">Date*</label><input type="date" id="payment-date" class="form-control" required></div><div class="form-group"><label for="payment-status">Status</label><select id="payment-status" class="form-control"><option>Completed</option><option>Pending</option><option>Failed</option></select></div><button type="submit" class="btn btn-primary">Record Payment</button></form></div>`;
                document.getElementById('visit-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3>Schedule Visit</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-modal')">&times;</button></div><form id="visit-form"><input type="hidden" id="visit-id"><div class="form-group"><label for="visit-customer-id">Customer*</label><select id="visit-customer-id" class="form-control" required></select></div><div class="form-group"><label for="visit-purpose">Purpose*</label><input type="text" id="visit-purpose" class="form-control" required></div><div class="form-group"><label for="visit-date">Date*</label><input type="date" id="visit-date" class="form-control" required></div><button type="submit" class="btn btn-primary">Save Visit</button></form></div>`;
                document.getElementById('import-csv-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 class="card-title">Upload CSV File</h3><button class="btn btn-outline" onclick="App.UI.closeModal('import-csv-modal')">&times;</button></div><div class="file-upload-wrapper" id="csv-drop-zone"><i class="fas fa-upload" style="font-size: 1.5rem; color: var(--text-secondary);"></i><p>Click to browse or drag & drop file here</p><span id="csv-filename" style="font-weight: 600; color: var(--primary);"></span><input type="file" id="csv-file-input" class="hidden" accept=".csv"></div><div class="info-box"><p>Ensure headers match:</p><code>accountNumber,companyName,emirate,area,status,paymentStatus,initialDebt,outstandingAmount,salesConsultant</code></div><a href="#" id="download-sample-csv-link"><i class="fas fa-download"></i> Download Sample Template</a><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('import-csv-modal')">Close</button></div></div>`;
                document.getElementById('customer-detail-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="customer-detail-title" class="card-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-detail-modal')">&times;</button></div><div class="d-flex gap-2 mb-4"><button class="detail-tab-btn active" data-tab="overview"><i class="fas fa-info-circle"></i> Overview</button><button class="detail-tab-btn" data-tab="visit-notes"><i class="fas fa-pen-alt"></i> Visit Notes</button></div><div id="customer-detail-content"><div class="tab-content active" id="overview-content"></div><div class="tab-content hidden" id="visit-notes-content"></div></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('customer-detail-modal')">Close</button></div></div>`;
                document.getElementById('visit-notes-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 class="card-title">Mark Visit as Done</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-notes-modal')">&times;</button></div><form id="visit-notes-form"><input type="hidden" id="mark-done-visit-id"><div class="form-grid"><div class="form-group"><label>CONTACT METHOD</label><select id="log-contact-method" class="form-control"><option>Site Visit</option><option>Phone Call</option><option>Email</option></select></div><div class="form-group"><label>OUTCOME</label><select id="log-outcome" class="form-control"><option>No Answer</option><option>Promise to Pay</option><option>Dispute</option><option>Paid in Full</option><option>Partial Payment</option></select></div></div><div class="form-group"><label>NOTES</label><div id="log-notes-editor" style="height:150px;"></div></div><div class="form-grid"><div class="form-group"><label>SCHEDULE NEXT VISIT (Optional)</label><input type="date" id="log-next-date" class="form-control"></div><div class="form-group"><label>LOCATION</label><button type="button" class="btn btn-outline" id="log-location-btn" style="width:100%;"><i class="fas fa-map-marker-alt"></i> <span id="log-location-text">Tag Current Location</span></button></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Save Notes</button></div></form></div>`;
                document.getElementById('payment-detail-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="card-title">Payment Details</h3><button class="btn btn-outline" onclick="App.UI.closeModal('payment-detail-modal')">&times;</button></div><div id="payment-detail-content"></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('payment-detail-modal')">Close</button></div></div>`;
                document.getElementById('consultant-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 id="consultant-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('consultant-modal')">&times;</button></div><form id="consultant-form"><input type="hidden" id="consultant-id-hidden"><div class="form-group"><label for="consultantName">Consultant Name*</label><input type="text" id="consultantName" class="form-control" required></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('consultant-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save Consultant</button></div></form></div>`;
                document.getElementById('user-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 id="user-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('user-modal')">&times;</button></div><form id="user-form"><input type="hidden" id="user-id-hidden"><div class="form-group"><label for="username">Username*</label><input type="text" id="username" class="form-control" required></div><div class="form-group"><label for="fullName">Full Name*</label><input type="text" id="fullName" class="form-control" required></div><div class="form-group"><label for="password">Password*</label><input type="password" id="password" class="form-control" required></div><div class="form-group"><label for="role">Role</label><select id="role" class="form-control"><option value="user">User</option><option value="admin">Admin</option></select></div><div class="form-group" id="assigned-consultant-group"><label for="assignedConsultant">Assigned Sales Consultant</label><select id="assignedConsultant" class="form-control"></select></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('user-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save User</button></div></form></div>`;
            },
            setupEventListeners() {
                document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); const u = e.target.username.value, p = e.target.password.value; if (!App.Auth.login(u, p)) document.getElementById('login-error').classList.remove('hidden'); });
                document.getElementById('logout-btn').addEventListener('click', () => App.Auth.logout());
                document.getElementById('theme-switcher').addEventListener('click', () => this.toggleTheme());
                document.getElementById('hamburger-menu').addEventListener('click', () => document.querySelector('.sidebar').classList.toggle('open'));
                document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo(link.dataset.page); }));
                App.Dashboard.setupEventListeners();
                App.Customers.setupEventListeners();
                App.Payments.setupEventListeners();
                App.Reports.setupEventListeners();
                App.Visits.setupEventListeners();
                App.Consultants.setupEventListeners();
                App.Users.setupEventListeners();
                document.body.addEventListener('click', (e) => { const s = document.querySelector('.sidebar'); if (s.classList.contains('open') && !s.contains(e.target) && !document.getElementById('hamburger-menu').contains(e.target)) { s.classList.remove('open'); } });
            },
            showApp() {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('username-display').textContent = App.state.currentUser.fullName;
                App.Auth.checkRole();
                this.navigateTo('dashboard');
            },
            showLogin() {
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('app').classList.add('hidden');
            },
            navigateTo(pageId) {
                App.state.activePage = pageId;
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(`${pageId}-page`).classList.add('active');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active');
                const title = document.querySelector(`.nav-link[data-page="${pageId}"] .nav-text`).textContent;
                document.getElementById('page-title').textContent = title;
                const pageRenderers = { dashboard: App.Dashboard, customers: App.Customers, visits: App.Visits, payments: App.Payments, reports: App.Reports, consultants: App.Consultants, users: App.Users };
                if (pageRenderers[pageId]) { pageRenderers[pageId].render(); }
            },
            toggleTheme() {
                document.documentElement.classList.toggle('dark-mode');
                App.state.theme = document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light';
                localStorage.setItem('theme', App.state.theme);
                document.querySelector('.switch-toggle').style.transform = App.state.theme === 'dark' ? 'translateX(26px)' : 'translateX(0)';
                if (App.state.activePage === 'dashboard') { App.Dashboard.renderCharts(); }
            },
            openModal(id) { document.getElementById(id).classList.add('active'); },
            closeModal(id) { document.getElementById(id).classList.remove('active'); },
            toast: (title, icon = 'success') => Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, icon, title, background: 'var(--card-bg)', color: 'var(--text-primary)' }),
            confirm: (title, text, cb) => Swal.fire({ title, text, icon: 'warning', showCancelButton: true, confirmButtonColor: 'var(--primary)', cancelButtonColor: 'var(--danger)', confirmButtonText: 'Yes, do it!', background: 'var(--card-bg)', color: 'var(--text-primary)' }).then(r => r.isConfirmed && cb())
        },
        Dashboard: { /* ... logic ... */ },
        Customers: { /* ... logic ... */ },
        Visits: { /* ... logic ... */ },
        Payments: { /* ... logic ... */ },
        Reports: { /* ... logic ... */ },
        Consultants: { /* ... logic ... */ },
        Users: { /* ... logic ... */ },
        Helpers: { /* ... logic ... */ }
    };
    
    // --- MODULE DEFINITIONS ---
    Object.assign(App.Dashboard, { charts: {}, setupEventListeners() { const controls = document.getElementById('dashboard-page'); controls.addEventListener('click', e => { if (e.target.id === 'start-day-btn') this.startDay(); if (e.target.id === 'end-day-btn') this.endDay(); }); }, render() { if (App.state.currentUser.role === 'user') { this.renderAttendanceControls(); } else { const attendanceControls = document.getElementById('attendance-controls'); if (attendanceControls) attendanceControls.innerHTML = ''; } this.renderRecoveryProgress(); const c = App.Helpers.getScopedData('customers'), p = App.Helpers.getScopedData('payments'), v = App.Helpers.getScopedData('visits'); this.animateCounter('stat-total-customers', c.length); this.animateCounter('stat-outstanding-debt', c.reduce((s, i) => s + i.outstanding, 0), true); this.animateCounter('stat-recovered-this-month', p.filter(i => new Date(i.date).getMonth() === new Date().getMonth()).reduce((s, i) => s + i.amount, 0), true); this.animateCounter('stat-upcoming-visits', v.filter(i => new Date(i.dateTime) >= new Date() && i.status === 'Scheduled').length); this.renderCharts(); }, renderAttendanceControls() { const todayStr = new Date().toISOString().slice(0, 10); const consultantName = App.state.currentUser.assignedConsultant; const log = App.DB.get('activityLog'); const startEntry = log.find(entry => entry.consultant === consultantName && entry.date === todayStr && entry.action === 'Started Day'); const dayStarted = !!startEntry; const dayEnded = log.some(entry => entry.consultant === consultantName && entry.date === todayStr && entry.action === 'Ended Day'); let html = '<div class="card d-flex gap-4 justify-content-between align-items-center flex-wrap">'; if (dayStarted) { html += `<div><h3 class="card-title" style="margin:0; font-size:var(--fs-base)">Daily Attendance</h3><p style="color:var(--text-secondary); font-size:var(--fs-sm);" id="attendance-status">Day Started at: ${startEntry.time}</p></div>`; } else { html += `<div><h3 class="card-title" style="margin:0; font-size:var(--fs-base)">Daily Attendance</h3><p style="color:var(--text-secondary); font-size:var(--fs-sm);" id="attendance-status">Log your work day.</p></div>`; } html += `<div class="d-flex gap-4 align-items-center">`; html += `<span id="work-timer" style="font-weight:600; font-size:var(--fs-lg); color:var(--primary); min-width: 100px; text-align: right;"></span>`; html += `<button id="start-day-btn" class="btn btn-success" ${dayStarted ? 'disabled' : ''}><i class="fas fa-play"></i> Start Day</button>`; html += `<button id="end-day-btn" class="btn btn-danger" ${!dayStarted || dayEnded ? 'disabled' : ''}><i class="fas fa-stop"></i> End Day</button>`; html += `</div></div>`; document.getElementById('attendance-controls').innerHTML = html; if (dayStarted && !dayEnded) { this.startTimer(startEntry.timestamp); } }, startDay() { App.Helpers.logActivity('Started Day'); App.UI.toast('Day Started! Good luck.', 'success'); this.render(); }, endDay() { clearInterval(App.state.dayTimerInterval); App.Helpers.logActivity('Ended Day'); App.UI.toast('Day Ended! Well done.', 'info'); this.render(); }, startTimer(startTime) { clearInterval(App.state.dayTimerInterval); const timerElement = document.getElementById('work-timer'); if (!timerElement) return; const startTimestamp = startTime; App.state.dayTimerInterval = setInterval(() => { const now = new Date(); const diff = now.getTime() - startTimestamp; if (diff < 0) { timerElement.textContent = '00:00:00'; return; } const hours = Math.floor(diff / (1000 * 60 * 60)).toString().padStart(2, '0'); const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0'); const seconds = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0'); timerElement.textContent = `${hours}:${minutes}:${seconds}`; }, 1000); }, animateCounter(id, t, isC = false) { let e = document.getElementById(id); if (!e) return; let n = 0, i = Math.max(1, t / 100); const u = () => { n += i; if (n < t) { e.textContent = isC ? App.Helpers.formatCurrency(Math.ceil(n)) : Math.ceil(n); requestAnimationFrame(u) } else { e.textContent = isC ? App.Helpers.formatCurrency(t) : t } }; u() }, renderCharts() { const c = App.Helpers.getScopedData('customers'), p = App.Helpers.getScopedData('payments'), tc = App.state.theme === 'dark' ? '#f8fafc' : '#1e293b', bc = App.state.theme === 'dark' ? '#374151' : '#e5e7eb'; const dbe = c.reduce((a, i) => { a[i.emirate] = (a[i.emirate] || 0) + i.outstanding; return a }, {}); if (this.charts.debt) this.charts.debt.destroy(); this.charts.debt = new Chart(document.getElementById('debt-chart'), { type: 'doughnut', data: { labels: Object.keys(dbe), datasets: [{ data: Object.values(dbe), backgroundColor: ['#7c3aed', '#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: tc } } } } }); const mp = p.reduce((a, i) => { const m = new Date(i.date).toLocaleString('default', { month: 'short' }); a[m] = (a[m] || 0) + i.amount; return a }, {}); if (this.charts.payment) this.charts.payment.destroy(); this.charts.payment = new Chart(document.getElementById('payment-chart'), { type: 'bar', data: { labels: Object.keys(mp), datasets: [{ label: 'Payments', data: Object.values(mp), backgroundColor: '#7c3aed', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: tc }, grid: { color: bc } }, x: { ticks: { color: tc }, grid: { color: 'transparent' } } }, plugins: { legend: { labels: { color: tc } } } } }); }, renderRecoveryProgress() { const customers = App.Helpers.getScopedData('customers'); const totalInitialDebt = customers.reduce((sum, c) => sum + c.initialDebt, 0); const totalOutstanding = customers.reduce((sum, c) => sum + c.outstanding, 0); const totalCollected = totalInitialDebt - totalOutstanding; const percentage = totalInitialDebt > 0 ? ((totalCollected / totalInitialDebt) * 100).toFixed(0) : 0; const container = document.getElementById('recovery-progress-card'); container.innerHTML = `<div class="d-flex align-items-center gap-2 mb-4"><i class="fas fa-bullseye" style="color: var(--primary);"></i><h3 class="card-title" style="margin:0;">Recovery Progress</h3></div><div><div class="mb-2" style="font-weight: 600; text-transform: uppercase; font-size: var(--fs-sm); color: var(--text-secondary);">Total Debt vs Collected</div><div class="progress-bar mb-2"><div class="progress-bar-inner" style="width: ${percentage}%;"></div></div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${App.Helpers.formatCurrency(totalCollected)} collected of ${App.Helpers.formatCurrency(totalInitialDebt)} (${percentage}%)</div></div>`; } });
    App.Customers = { quill: null, setupEventListeners: function() { /* ... */ }, render: function() { /* ... */ }, /* ... all other methods ... */ };
    App.Visits = { calendar: null, logNotesQuill: null, setupEventListeners: function() { /* ... */ }, render: function() { /* ... */ }, /* ... all other methods ... */ };
    App.Payments = { render: function() { /* ... */ }, setupEventListeners: function() { /* ... */ }, /* ... all other methods ... */ };
    App.Reports = { render: function() { /* ... */ }, setupEventListeners: function() { /* ... */ }, /* ... all other methods ... */ };
    App.Consultants = { render: function() { /* ... */ }, setupEventListeners: function() { /* ... */ }, /* ... all other methods ... */ };
    App.Users = { render: function() { /* ... */ }, setupEventListeners: function() { /* ... */ }, /* ... all other methods ... */ };
    App.Helpers = { formatCurrency: function(a) { /* ... */ }, /* ... all other methods ... */ };

    Object.assign(App.Customers, { quill: null, setupEventListeners: function() { document.getElementById('add-customer-btn').addEventListener('click', () => this.showCustomerForm()); document.getElementById('customer-form').addEventListener('submit', (e) => this.saveCustomer(e)); document.querySelector('#customers-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) this.sortCustomers(th.dataset.sort); }); const debouncedSearch = App.Helpers.debounce(() => this.render(), 300); document.getElementById('customer-search').addEventListener('input', debouncedSearch); document.getElementById('customer-status-filter').addEventListener('change', () => this.render()); document.getElementById('customer-payment-filter').addEventListener('change', () => this.render()); document.getElementById('customer-table-body').addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; const id = button.dataset.id; if (button.classList.contains('view-customer')) this.showCustomerDetail(id); else if (button.classList.contains('edit-customer')) this.showCustomerForm(id); }); document.getElementById('customer-detail-modal').addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; if (button.classList.contains('detail-tab-btn')) this.switchDetailTab(button.dataset.tab); else if (button.id === 'save-visit-notes-btn') this.saveVisitNoteFromDetail(); }); }, render: function() { const { value: search } = document.getElementById('customer-search'); const { value: statusFilter } = document.getElementById('customer-status-filter'); const { value: paymentFilter } = document.getElementById('customer-payment-filter'); let customers = App.Helpers.getScopedData('customers').filter(c => (c.companyName.toLowerCase().includes(search.toLowerCase()) || c.accountNo.toLowerCase().includes(search.toLowerCase()) || c.salesConsultant.toLowerCase().includes(search.toLowerCase())) && (statusFilter === 'all' || c.status === statusFilter) && (paymentFilter === 'all' || c.paymentStatus === paymentFilter)); const { column, order } = App.state.customerSort; customers.sort((a, b) => { if (a[column] < b[column]) return order === 'asc' ? -1 : 1; if (a[column] > b[column]) return order === 'asc' ? 1 : -1; return 0; }); const tbody = document.getElementById('customer-table-body'); tbody.innerHTML = customers.length ? customers.map(c => `<tr><td>${c.accountNo}</td><td><div class="company-info"><div class="name">${c.companyName}</div><div class="location" style="color: var(--text-secondary); font-size: var(--fs-sm);">${c.emirate}</div></div></td><td>${App.Helpers.formatCurrency(c.outstanding)}</td><td>${c.salesConsultant}</td><td><span class="status-badge ${c.paymentStatus.toLowerCase()}">${c.paymentStatus}</span></td><td class="d-flex gap-2"><button class="btn btn-outline view-customer" data-id="${c.accountNo}" title="View"><i class="fas fa-eye"></i></button><button class="btn btn-outline edit-customer" data-id="${c.accountNo}" title="Edit"><i class="fas fa-edit"></i></button></td></tr>`).join('') : '<tr><td colspan="6">No customers found.</td></tr>'; }, showCustomerForm: function(accountNo = null) { const form = document.getElementById('customer-form'); const accountNoInput = form.elements.accountNo; form.reset(); const consultantSelect = form.elements['salesConsultant']; consultantSelect.innerHTML = App.DB.get('consultants').map(c => `<option value="${c.name}">${c.name}</option>`).join(''); if (accountNo) { const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); document.getElementById('customer-modal-title').textContent = 'Edit Customer'; document.getElementById('customer-id-hidden').value = customer.accountNo; Object.keys(customer).forEach(key => { if (form.elements[key]) form.elements[key].value = customer[key]; }); accountNoInput.readOnly = true; accountNoInput.required = false; } else { document.getElementById('customer-modal-title').textContent = 'Add New Customer'; document.getElementById('customer-id-hidden').value = ''; accountNoInput.readOnly = false; accountNoInput.required = true; accountNoInput.placeholder = 'e.g., DXB-007'; } App.UI.openModal('customer-modal'); }, saveCustomer: function(e) { e.preventDefault(); const form = e.target; const id = form.elements['customer-id-hidden'].value; let customers = App.DB.get('customers'); const customerData = { companyName: form.elements.companyName.value, emirate: form.elements.emirate.value, area: form.elements.area.value, initialDebt: parseFloat(form.elements.initialDebt.value), outstanding: parseFloat(form.elements.outstanding.value), salesConsultant: form.elements.salesConsultant.value, status: form.elements.status.value, paymentStatus: form.elements.paymentStatus.value }; if (id) { const index = customers.findIndex(c => c.accountNo === id); customers[index] = { ...customers[index], ...customerData }; } else { const newAccountNo = form.elements.accountNo.value.trim(); if (!newAccountNo) { App.UI.toast('Account Number is required.', 'error'); return; } const accountExists = customers.some(c => c.accountNo.toLowerCase() === newAccountNo.toLowerCase()); if (accountExists) { App.UI.toast('Account Number already exists.', 'error'); return; } customerData.accountNo = newAccountNo; customers.push(customerData); App.Helpers.logActivity(`Added customer: ${customerData.companyName} (${customerData.accountNo})`); } App.DB.set('customers', customers); App.UI.closeModal('customer-modal'); App.UI.toast(`Customer ${id ? 'updated' : 'added'}!`); this.render(); }, sortCustomers: function(column) { const { customerSort } = App.state; if (customerSort.column === column) customerSort.order = customerSort.order === 'asc' ? 'desc' : 'asc'; else { customerSort.column = column; customerSort.order = 'asc'; } this.render(); }, showCustomerDetail: function(accountNo) { App.state.activeCustomerId = accountNo; const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); if (!customer) return; document.getElementById('customer-detail-title').innerHTML = `Customer: ${customer.companyName} <span style="color:var(--text-secondary); font-weight:500;">(${customer.accountNo})</span>`; this.renderDetailOverview(customer); this.renderDetailVisitNotes(customer); this.switchDetailTab('overview'); App.UI.openModal('customer-detail-modal'); }, renderDetailOverview: function(customer) { const payments = App.DB.get('payments').filter(p => p.customerId === customer.accountNo); const visits = App.DB.get('visits').filter(v => v.customerId === customer.accountNo).sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)); document.getElementById('overview-content').innerHTML = `<div class="detail-info-grid"><div class="detail-info-card"><div class="label">Account #</div><div class="value">${customer.accountNo}</div></div><div class="detail-info-card"><div class="label">Location</div><div class="value">${customer.area}, ${customer.emirate}</div></div><div class="detail-info-card"><div class="label">Account Status</div><div class="value"><span class="status-badge ${customer.status.toLowerCase()}">${customer.status}</span></div></div><div class="detail-info-card"><div class="label">Payment Status</div><div class="value"><span class="status-badge ${customer.paymentStatus.toLowerCase()}">${customer.paymentStatus}</span></div></div><div class="detail-info-card"><div class="label">Outstanding</div><div class="value">${App.Helpers.formatCurrency(customer.outstanding)}</div></div><div class="detail-info-card"><div class="label">Sales Consultant</div><div class="value">${customer.salesConsultant}</div></div></div><h4 class="card-title mb-4">Payment History</h4>${payments.length > 0 ? `<div class="table-container"><table class="data-table"><thead><tr><th>ID</th><th>Date</th><th>Amount</th><th>Method</th><th>Status</th></tr></thead><tbody>${payments.map(p => `<tr><td>${p.id}</td><td>${App.Helpers.formatDate(p.date)}</td><td>${App.Helpers.formatCurrency(p.amount)}</td><td>${p.method}</td><td><span class="status-badge ${p.status.toLowerCase()}">${p.status}</span></td></tr>`).join('')}</tbody></table></div>` : '<p>No payments recorded.</p>'}<h4 class="card-title mt-4 mb-4">Visit Notes History</h4>${visits.length > 0 ? visits.map(v => `<div class="card mb-4" style="background:var(--bg-color);"><p><strong>${App.Helpers.formatDate(v.dateTime)}: ${v.contactMethod || v.purpose} ${v.outcome ? `(${v.outcome})` : ''}</strong></p>${v.notes || ''}</div>`).join('') : '<p>No visit notes recorded.</p>'}`; }, renderDetailVisitNotes: function(customer) { document.getElementById('visit-notes-content').innerHTML = `<div class="form-grid"><div class="form-group"><label>CONTACT METHOD</label><select id="visit-contact-method" class="form-control"><option>Site Visit</option><option>Phone Call</option><option>Email</option></select></div><div class="form-group"><label>OUTCOME</label><select id="visit-outcome" class="form-control"><option>No Answer</option><option>Promise to Pay</option><option>Dispute</option><option>Paid in Full</option><option>Partial Payment</option></select></div></div><div class="form-group"><label>NOTES</label><div id="quill-editor" style="height:150px;"></div></div><div class="form-grid"><div class="form-group"><label>SCHEDULE NEXT VISIT (Optional)</label><input type="date" id="visit-next-date" class="form-control"></div><div class="form-group"><label>LOCATION</label><button type="button" class="btn btn-outline" id="tag-location-btn" style="width:100%;"><i class="fas fa-map-marker-alt"></i> <span id="location-tag-text">Tag Current Location</span></button></div></div><div class="d-flex" style="justify-content:flex-end;"><button type="button" class="btn btn-primary" id="save-visit-notes-btn">Save Notes</button></div>`; if (this.quill) { this.quill = null; } this.quill = new Quill('#quill-editor', { theme: 'snow', placeholder: 'Enter contact notes...' }); }, switchDetailTab: function(tabId) { document.querySelectorAll('.detail-tab-btn').forEach(btn => btn.classList.remove('active')); document.querySelector(`.detail-tab-btn[data-tab="${tabId}"]`)?.classList.add('active'); document.querySelectorAll('#customer-detail-content .tab-content').forEach(c => c.classList.add('hidden')); document.getElementById(`${tabId}-content`).classList.remove('hidden'); }, saveVisitNoteFromDetail: function() { const customerId = App.state.activeCustomerId; const contactMethod = document.getElementById('visit-contact-method').value; const outcome = document.getElementById('visit-outcome').value; const notes = this.quill.root.innerHTML; const nextVisitDate = document.getElementById('visit-next-date').value; let visits = App.DB.get('visits'); const customer = App.DB.get('customers').find(c => c.accountNo === customerId); const newNote = { id: `v${Date.now()}`, customerId, dateTime: new Date().toISOString(), purpose: `Follow-up: ${outcome}`, collector: customer.salesConsultant, status: "Completed", contactMethod, outcome, notes, }; visits.push(newNote); if (nextVisitDate) { visits.push({ id: `v${Date.now() + 1}`, customerId, dateTime: `${nextVisitDate}`, purpose: 'Scheduled Follow-up', collector: newNote.collector, status: "Scheduled" }); } App.DB.set('visits', visits); App.UI.toast('Visit note saved!'); App.UI.closeModal('customer-detail-modal'); } });
    Object.assign(App.Visits, { calendar: null, logNotesQuill: null, setupEventListeners: function() { /* ... */ }, render: function() { /* ... */ }, /* ... all other methods ... */ });
    Object.assign(App.Visits, { calendar: null, logNotesQuill: null, setupEventListeners: function() { document.getElementById('visit-notes-form').addEventListener('submit', e => this.saveCompletedVisit(e)); document.getElementById('visit-form').addEventListener('submit', (e) => this.saveScheduledVisit(e)); const page = document.getElementById('visits-page'); page.addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; if (button.classList.contains('visit-view-tab')) this.switchView(button.dataset.view); if (button.classList.contains('visit-filter-btn')) this.setFilter(button.dataset.filter); if (button.id === 'visit-date-apply') this.applyDateFilter(); if (button.classList.contains('mark-done-btn')) this.showMarkDoneModal(button.dataset.id); if (button.id === 'schedule-visit-btn') this.showScheduleModal(); }); document.getElementById('visit-notes-modal').addEventListener('click', e => { if (e.target.closest('button')?.id === 'log-location-btn') this.tagLocationForVisitLog(); }); }, render: function() { this.checkOverdueVisits(); if (App.state.visits.activeView === 'calendar') this.renderCalendarView(); else this.renderListView(); }, switchView: function(view) { App.state.visits.activeView = view; document.querySelectorAll('.visit-view-tab').forEach(t => t.classList.remove('active')); document.querySelector(`.visit-view-tab[data-view="${view}"]`).classList.add('active'); document.querySelectorAll('.visit-view-content').forEach(c => c.classList.add('hidden')); document.getElementById(`${view}-view-content`).classList.remove('hidden'); this.render(); }, setFilter: function(filter) { App.state.visits.filter = filter; document.getElementById('visit-start-date').value = ''; document.getElementById('visit-end-date').value = ''; App.state.visits.startDate = ''; App.state.visits.endDate = ''; document.querySelectorAll('.visit-filter-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.visit-filter-btn[data-filter="${filter}"]`).classList.add('active'); this.renderListView(); }, applyDateFilter: function() { const startDate = document.getElementById('visit-start-date').value; const endDate = document.getElementById('visit-end-date').value; if (!startDate || !endDate) { App.UI.toast('Please select both a start and end date.', 'warning'); return; } App.state.visits.startDate = startDate; App.state.visits.endDate = endDate; App.state.visits.filter = 'Custom'; document.querySelectorAll('.visit-filter-btn').forEach(b => b.classList.remove('active')); this.renderListView(); }, renderListView: function() { let visits = App.Helpers.getScopedData('visits'); const { filter, startDate, endDate } = App.state.visits; const today = new Date().setHours(0, 0, 0, 0); if (filter !== 'All' && !(startDate && endDate)) { visits = visits.filter(v => { const visitDate = new Date(v.dateTime).setHours(0, 0, 0, 0); if (filter === 'Overdue') return (v.status === 'Scheduled' || v.status === 'Overdue') && visitDate < today; if (filter === 'Today') return visitDate === today; if (filter === 'Upcoming') return v.status === 'Scheduled' && visitDate >= today; return false; }); } if (startDate && endDate) { visits = visits.filter(v => { const visitDateOnly = new Date(v.dateTime).toISOString().slice(0, 10); return visitDateOnly >= startDate && visitDateOnly <= endDate; }); } const customers = App.DB.get('customers'); const tbody = document.getElementById('visit-table-body'); tbody.innerHTML = visits.length ? visits.sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime)).map(v => `<tr><td>${App.Helpers.formatDate(v.dateTime)}</td><td>${customers.find(c => c.accountNo === v.customerId)?.companyName || 'N/A'}</td><td>${v.purpose}</td><td><span class="status-badge ${v.status.toLowerCase()}">${v.status}</span></td><td><div class="d-flex gap-2">${v.status === 'Scheduled' || v.status === 'Overdue' ? `<button class="btn btn-success mark-done-btn" data-id="${v.id}" title="Mark as Done"><i class="fas fa-check"></i></button>` : ''}</div></td></tr>`).join('') : '<tr><td colspan="5">No visits found.</td></tr>'; }, renderCalendarView: function() { const el = document.getElementById('calendar-view'); if (this.calendar) this.calendar.destroy(); const v = App.Helpers.getScopedData('visits'), c = App.DB.get('customers'); const ev = v.map(i => ({ id: i.id, title: `${c.find(cu => cu.accountNo === i.customerId)?.companyName || 'N/A'} - ${i.purpose}`, start: i.dateTime, backgroundColor: i.status === 'Completed' ? 'var(--success)' : i.status === 'Overdue' ? 'var(--danger)' : 'var(--primary)' })); this.calendar = new FullCalendar.Calendar(el, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, events: ev, editable: true, dateClick: (info) => this.showScheduleModal(null, info.dateStr), eventClick: (info) => this.showScheduleModal(info.event.id) }); this.calendar.render(); }, showScheduleModal: function(id = null, d = null) { const f = document.getElementById('visit-form'); f.reset(); f.elements['visit-id'].value = ''; document.getElementById('visit-customer-id').innerHTML = App.Helpers.getScopedData('customers').map(c => `<option value="${c.accountNo}">${c.companyName}</option>`).join(''); if (id) { const visit = App.DB.get('visits').find(v => v.id === id); if (visit) { f.elements['visit-id'].value = visit.id; f.elements['visit-customer-id'].value = visit.customerId; f.elements['visit-purpose'].value = visit.purpose; f.elements['visit-date'].value = visit.dateTime.slice(0, 10); } } else if (d) f.elements['visit-date'].value = d; App.UI.openModal('visit-modal'); }, saveScheduledVisit: function(e) { e.preventDefault(); const f = e.target; const customer = App.DB.get('customers').find(c => c.accountNo === f.elements['visit-customer-id'].value); const vd = { customerId: f.elements['visit-customer-id'].value, purpose: f.elements['visit-purpose'].value, dateTime: f.elements['visit-date'].value, status: 'Scheduled', collector: customer ? customer.salesConsultant : 'N/A' }; let v = App.DB.get('visits'), id = f.elements['visit-id'].value; if (id) { const i = v.findIndex(vi => vi.id === id); v[i] = { ...v[i], ...vd, id: id }; } else { vd.id = `visit-${Date.now()}`; v.push(vd); } App.DB.set('visits', v); App.UI.closeModal('visit-modal'); App.UI.toast('Visit saved!'); this.render(); }, showMarkDoneModal: function(visitId) { document.getElementById('visit-notes-form').reset(); document.getElementById('mark-done-visit-id').value = visitId; document.getElementById('log-location-text').textContent = 'Tag Current Location'; if (!this.logNotesQuill) this.logNotesQuill = new Quill('#log-notes-editor', { theme: 'snow', placeholder: 'Enter contact notes...' }); this.logNotesQuill.root.innerHTML = ''; App.UI.openModal('visit-notes-modal'); }, saveCompletedVisit: function(e) { e.preventDefault(); const form = e.target; const visitId = form.elements['mark-done-visit-id'].value; let visits = App.DB.get('visits'); const visitIndex = visits.findIndex(v => v.id === visitId); if (visitIndex > -1) { const visit = visits[visitIndex]; visit.status = "Completed"; visit.contactMethod = form.elements['log-contact-method'].value; visit.outcome = form.elements['log-outcome'].value; visit.notes = this.logNotesQuill.root.innerHTML; const nextVisitDate = document.getElementById('log-next-date').value; if (nextVisitDate) { visits.push({ id: `v${Date.now() + 1}`, customerId: visit.customerId, dateTime: nextVisitDate, purpose: 'Scheduled Follow-up', collector: visit.collector, status: "Scheduled" }); } App.Helpers.logActivity(`Completed visit for ${App.DB.get('customers').find(c=>c.accountNo === visit.customerId).companyName}`); } App.DB.set('visits', visits); App.UI.closeModal('visit-notes-modal'); App.UI.toast('Visit marked as done!'); this.render(); }, checkOverdueVisits: function() { let v = App.DB.get('visits'), c = false; const today = new Date(); today.setHours(0, 0, 0, 0); v.forEach(i => { if (i.status === 'Scheduled' && new Date(i.dateTime) < today) { i.status = 'Overdue'; c = true; } }); if (c) App.DB.set('visits', v); }, tagLocationForVisitLog: function() { if (!navigator.geolocation) return App.UI.toast('Geolocation not supported.', 'error'); navigator.geolocation.getCurrentPosition(p => { const l = { lat: p.coords.latitude, lon: p.coords.longitude }; document.getElementById('log-location-text').textContent = `Tagged: ${l.lat.toFixed(2)}, ${l.lon.toFixed(2)}`; App.UI.toast('Location tagged for this note!'); }, () => App.UI.toast('Unable to get location.', 'error')); } });
    Object.assign(App.Payments, { render: function() { const payments = App.Helpers.getScopedData('payments'); const customers = App.DB.get('customers'); const tbody = document.getElementById('payment-table-body'); const sortedPayments = payments.sort((a, b) => new Date(b.date) - new Date(a.date)); tbody.innerHTML = sortedPayments.length > 0 ? sortedPayments.map(p => { const customer = customers.find(c => c.accountNo === p.customerId); return `<tr><td>${p.id}</td><td>${App.Helpers.formatDate(p.date)}</td><td>${customer ? customer.companyName : 'N/A'}</td><td>${App.Helpers.formatCurrency(p.amount)}</td><td>${p.method}</td><td><span class="status-badge ${p.status.toLowerCase()}">${p.status}</span></td><td><button class="btn btn-outline view-payment" data-id="${p.id}" title="View Details"><i class="fas fa-eye"></i></button></td></tr>`; }).join('') : '<tr><td colspan="7">No payments recorded.</td></tr>'; }, setupEventListeners: function() { document.getElementById('record-payment-btn').addEventListener('click', () => this.showPaymentForm()); document.getElementById('payment-form').addEventListener('submit', (e) => this.savePayment(e)); document.getElementById('payment-table-body').addEventListener('click', (e) => { const viewButton = e.target.closest('.view-payment'); if (viewButton) { this.showPaymentDetail(viewButton.dataset.id); } }); }, showPaymentForm: function() { document.getElementById('payment-form').reset(); document.getElementById('payment-customer-id').innerHTML = App.Helpers.getScopedData('customers').map(c => `<option value="${c.accountNo}">${c.companyName} (${c.accountNo})</option>`).join(''); document.getElementById('payment-date').valueAsDate = new Date(); App.UI.openModal('payment-modal'); }, savePayment: function(e) { e.preventDefault(); const f = e.target, cid = f.elements['payment-customer-id'].value, a = parseFloat(f.elements['payment-amount'].value); const pd = { id: `p${Date.now()}`, customerId: cid, amount: a, method: f.elements['payment-method'].value, date: f.elements['payment-date'].value, status: f.elements['payment-status'].value }; App.DB.set('payments', [...App.DB.get('payments'), pd]); if (pd.status === 'Completed') { let c = App.DB.get('customers'); const ci = c.findIndex(cu => cu.accountNo === cid); if (ci !== -1) { c[ci].outstanding -= a; if (c[ci].outstanding <= 0) { c[ci].outstanding = 0; c[ci].paymentStatus = 'Cleared'; } App.DB.set('customers', c); } App.Helpers.logActivity(`Recorded payment of ${App.Helpers.formatCurrency(a)} from ${c.find(cust=>cust.accountNo === cid).companyName}`, App.Helpers.formatCurrency(a)); } App.UI.closeModal('payment-modal'); App.UI.toast('Payment recorded!'); this.render(); if (App.state.activePage === 'dashboard') App.Dashboard.render(); if (App.state.activePage === 'customers') App.Customers.render(); }, showPaymentDetail: function(paymentId) { const payment = App.DB.get('payments').find(p => p.id === paymentId); if (!payment) return; const customer = App.DB.get('customers').find(c => c.accountNo === payment.customerId); const contentEl = document.getElementById('payment-detail-content'); contentEl.innerHTML = `<div class="detail-info-grid" style="grid-template-columns: 1fr 1fr; gap: var(--spacing-6);"><div class="detail-info-card"><div class="label">TRANSACTION ID</div><div class="value">${payment.id}</div></div><div class="detail-info-card"><div class="label">AMOUNT</div><div class="value" style="color: var(--success);">${App.Helpers.formatCurrency(payment.amount)}</div></div><div class="detail-info-card"><div class="label">PAYMENT DATE</div><div class="value">${App.Helpers.formatDate(payment.date)}</div></div><div class="detail-info-card"><div class="label">PAYMENT METHOD</div><div class="value">${payment.method}</div></div><div class="detail-info-card"><div class="label">STATUS</div><div class="value"><span class="status-badge ${payment.status.toLowerCase()}">${payment.status}</span></div></div></div><hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-6) 0;"><h4 class="card-title mb-4">Customer Information</h4>${customer ? `<div class="detail-info-grid" style="grid-template-columns: 1fr 1fr;"><div class="detail-info-card"><div class="label">COMPANY NAME</div><div class="value">${customer.companyName}</div></div><div class="detail-info-card"><div class="label">ACCOUNT #</div><div class="value">${customer.accountNo}</div></div><div class="detail-info-card"><div class="label">SALES CONSULTANT</div><div class="value">${customer.salesConsultant}</div></div><div class="detail-info-card"><div class="label">CURRENT OUTSTANDING</div><div class="value">${App.Helpers.formatCurrency(customer.outstanding)}</div></div></div>` : '<p>No customer associated with this payment.</p>'}`; App.UI.openModal('payment-detail-modal'); } });
    Object.assign(App.Reports, { render: function() { const select = document.getElementById('report-consultant-select'); if (select) { select.innerHTML = App.DB.get('consultants').map(c => `<option value="${c.name}">${c.name}</option>`).join(''); document.getElementById('report-activity-date').valueAsDate = new Date(); } document.getElementById('report-output').innerHTML = ''; }, setupEventListeners: function() { document.getElementById('generate-customer-report-btn').addEventListener('click', () => this.generateCustomerReport()); document.getElementById('generate-consultant-report-btn').addEventListener('click', () => this.generateConsultantReport()); document.getElementById('generate-activity-report-btn')?.addEventListener('click', () => this.generateActivityReport()); }, generateCustomerReport: function() { const c = App.Helpers.getScopedData('customers'), h = ['Account #', 'Company Name', 'Emirate', 'Outstanding', 'Consultant', 'Status'], d = c.map(i => [i.accountNo, i.companyName, i.emirate, App.Helpers.formatCurrency(i.outstanding), i.salesConsultant, i.status]); this.displayReport('Customer List Report', h, d); }, generateConsultantReport: function() { const c = App.Helpers.getScopedData('customers'), v = App.Helpers.getScopedData('visits'); const rd = c.reduce((a, i) => { const con = i.salesConsultant; if (!a[con]) a[con] = { customers: 0, totalDebt: 0, visits: 0 }; a[con].customers++; a[con].totalDebt += i.outstanding; return a; }, {}); v.forEach(i => { if (rd[i.collector]) rd[i.collector].visits++; }); const h = ['Consultant', 'Assigned Customers', 'Total Outstanding', 'Total Visits'], d = Object.entries(rd).map(([n, s]) => [n, s.customers, App.Helpers.formatCurrency(s.totalDebt), s.visits]); this.displayReport('Consultant Activity Report', h, d); }, generateActivityReport: function() { const consultantName = document.getElementById('report-consultant-select').value; const date = document.getElementById('report-activity-date').value; const log = App.DB.get('activityLog').filter(entry => entry.consultant === consultantName && entry.date === date); const dayStarted = log.find(e => e.action === 'Started Day'); const dayEnded = log.find(e => e.action === 'Ended Day'); const visitsCompleted = log.filter(e => e.action.includes('Completed visit')).length; const paymentsRecorded = log.filter(e => e.action.includes('Recorded payment')); const totalRecovered = paymentsRecorded.reduce((sum, p) => sum + parseFloat(p.details.replace(/[^0-9.-]+/g,"")), 0); const output = document.getElementById('report-output'); output.innerHTML = `<div class="card"><div class="card-header" style="border:none; padding-bottom:0;"><h3 class="card-title">Daily Activity Report</h3></div><div style="padding: 0 var(--spacing-6) var(--spacing-6); line-height: 1.8;"><p style="margin:0;"><strong>Consultant:</strong> ${consultantName}</p><p style="margin:0;"><strong>Date:</strong> ${App.Helpers.formatDate(date)}</p><p style="margin:0;"><strong>Day Started:</strong> ${dayStarted ? dayStarted.time : 'N/A'}</p><p style="margin:0;"><strong>Day Ended:</strong> ${dayEnded ? dayEnded.time : 'N/A'}</p><hr style="margin:var(--spacing-4) 0; border-color: var(--border-color);"><p style="margin:0;"><strong>Summary:</strong> Visits: ${visitsCompleted} &bull; Payments: ${paymentsRecorded.length} &bull; Total Recovered Today: ${App.Helpers.formatCurrency(totalRecovered)}</p><hr style="margin:var(--spacing-4) 0; border-color: var(--border-color);"><h4 style="font-size:var(--fs-base); font-weight:600; margin-bottom:var(--spacing-2);">Activity Timeline</h4>${log.length ? `<ul style="list-style:none; padding-left:0;">${log.sort((a,b) => a.timestamp - b.timestamp).map(e => `<li style="padding: var(--spacing-2) 0;"><strong>${e.time}:</strong> ${e.action}</li>`).join('')}</ul>` : '<p>No activity recorded on this day.</p>'}</div></div>`; }, displayReport: function(t, h, d) { document.getElementById('report-output').innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">${t}</h3><div class="d-flex gap-2"><button class="btn btn-outline" id="export-csv-btn"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" id="export-pdf-btn"><i class="fas fa-file-pdf"></i> PDF</button></div></div><div class="table-container"><table class="data-table"><thead><tr>${h.map(i => `<th>${i}</th>`).join('')}</tr></thead><tbody>${d.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table></div></div>`; document.getElementById('export-csv-btn').onclick = () => this.exportCSV(t, h, d); document.getElementById('export-pdf-btn').onclick = () => this.exportPDF(t, h, d); }, exportCSV: function(t, h, d) { let csv = "data:text/csv;charset=utf-8," + h.join(",") + "\n" + d.map(e => e.join(",")).join("\n"); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", `${t.replace(/\s/g, '_')}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }, exportPDF: function(t, h, d) { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text(t, 14, 16); doc.autoTable({ head: [h], body: d, startY: 20 }); doc.save(`${t.replace(/\s/g, '_')}.pdf`); } });
    Object.assign(App.Consultants, { render: function() { const consultants = App.DB.get('consultants'); const customers = App.DB.get('customers'); const visits = App.DB.get('visits'); const tbody = document.getElementById('consultant-table-body'); const data = consultants.map(consultant => { const assignedCustomers = customers.filter(c => c.salesConsultant === consultant.name); const totalOutstanding = assignedCustomers.reduce((sum, c) => sum + c.outstanding, 0); const overdueCustomers = assignedCustomers.filter(c => c.paymentStatus === 'Overdue').length; const upcomingVisits = visits.filter(v => v.collector === consultant.name && v.status === 'Scheduled' && new Date(v.dateTime) >= new Date()).length; return { ...consultant, noOfCustomers: assignedCustomers.length, totalOutstanding, overdueCustomers, upcomingVisits }; }); tbody.innerHTML = data.length ? data.map(c => `<tr><td><div style="font-weight:600;">${c.name}</div></td><td>${c.noOfCustomers}</td><td>${App.Helpers.formatCurrency(c.totalOutstanding)}</td><td>${c.overdueCustomers}</td><td>${c.upcomingVisits}</td><td><div class="d-flex gap-2"><button class="btn btn-outline edit-consultant" data-id="${c.id}" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-consultant" data-id="${c.id}" title="Delete"><i class="fas fa-trash"></i></button></div></td></tr>`).join('') : `<tr><td colspan="6">No consultants found.</td></tr>`; }, setupEventListeners: function() { document.getElementById('add-consultant-btn').addEventListener('click', () => this.showConsultantForm()); document.getElementById('consultant-form').addEventListener('submit', (e) => this.saveConsultant(e)); document.getElementById('consultant-table-body').addEventListener('click', e => { const editBtn = e.target.closest('.edit-consultant'); const deleteBtn = e.target.closest('.delete-consultant'); if (editBtn) this.showConsultantForm(editBtn.dataset.id); if (deleteBtn) this.deleteConsultant(deleteBtn.dataset.id); }); }, showConsultantForm: function(id = null) { const form = document.getElementById('consultant-form'); form.reset(); if (id) { const consultant = App.DB.get('consultants').find(c => c.id == id); document.getElementById('consultant-modal-title').textContent = 'Edit Consultant'; form.elements['consultant-id-hidden'].value = consultant.id; form.elements['consultantName'].value = consultant.name; } else { document.getElementById('consultant-modal-title').textContent = 'Add New Consultant'; form.elements['consultant-id-hidden'].value = ''; } App.UI.openModal('consultant-modal'); }, saveConsultant: function(e) { e.preventDefault(); const form = e.target; const id = form.elements['consultant-id-hidden'].value; const name = form.elements['consultantName'].value.trim(); if (!name) return App.UI.toast('Consultant name cannot be empty.', 'error'); let consultants = App.DB.get('consultants'); if (id) { const index = consultants.findIndex(c => c.id == id); consultants[index].name = name; } else { consultants.push({ id: Date.now(), name }); } App.DB.set('consultants', consultants); App.UI.closeModal('consultant-modal'); App.UI.toast(`Consultant ${id ? 'updated' : 'added'}!`); this.render(); }, deleteConsultant: function(id) { App.UI.confirm('Are you sure?', "This will delete the consultant.", () => { let consultants = App.DB.get('consultants').filter(c => c.id != id); App.DB.set('consultants', consultants); App.UI.toast('Consultant deleted.', 'success'); this.render(); }); } });
    Object.assign(App.Users, { render: function() { const users = App.DB.get('users'); const tbody = document.getElementById('user-table-body'); tbody.innerHTML = users.length ? users.map(u => `<tr><td><div style="font-weight:600;">${u.username}</div></td><td>${u.fullName}</td><td><span class="status-badge ${u.role}">${u.role}</span></td><td>${u.assignedConsultant || 'N/A'}</td><td><div class="d-flex gap-2"><button class="btn btn-outline edit-user" data-id="${u.id}" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-user" data-id="${u.id}" title="Delete"><i class="fas fa-trash"></i></button></div></td></tr>`).join('') : `<tr><td colspan="5">No users found.</td></tr>`; }, setupEventListeners: function() { document.getElementById('add-user-btn').addEventListener('click', () => this.showUserForm()); document.getElementById('user-form').addEventListener('submit', (e) => this.saveUser(e)); document.getElementById('user-table-body').addEventListener('click', e => { const editBtn = e.target.closest('.edit-user'); const deleteBtn = e.target.closest('.delete-user'); if (editBtn) this.showUserForm(editBtn.dataset.id); if (deleteBtn) this.deleteUser(deleteBtn.dataset.id); }); document.getElementById('role').addEventListener('change', e => { document.getElementById('assigned-consultant-group').style.display = e.target.value === 'user' ? 'block' : 'none'; }); }, showUserForm: function(id = null) { const form = document.getElementById('user-form'); form.reset(); const consultantSelect = form.elements['assignedConsultant']; const consultants = App.DB.get('consultants'); consultantSelect.innerHTML = `<option value="N/A">N/A</option>` + consultants.map(c => `<option value="${c.name}">${c.name}</option>`).join(''); if (id) { const user = App.DB.get('users').find(u => u.id == id); document.getElementById('user-modal-title').textContent = 'Edit User'; form.elements['user-id-hidden'].value = user.id; form.elements['username'].value = user.username; form.elements['username'].readOnly = true; form.elements['fullName'].value = user.fullName; form.elements['password'].value = user.password; form.elements['role'].value = user.role; form.elements['assignedConsultant'].value = user.assignedConsultant || 'N/A'; } else { document.getElementById('user-modal-title').textContent = 'Add New User'; form.elements['user-id-hidden'].value = ''; form.elements['username'].readOnly = false; } document.getElementById('assigned-consultant-group').style.display = form.elements['role'].value === 'user' ? 'block' : 'none'; App.UI.openModal('user-modal'); }, saveUser: function(e) { e.preventDefault(); const form = e.target; const id = form.elements['user-id-hidden'].value; let users = App.DB.get('users'); const userData = { username: form.elements['username'].value.trim(), fullName: form.elements['fullName'].value.trim(), password: form.elements['password'].value, role: form.elements['role'].value, assignedConsultant: form.elements['role'].value === 'user' ? form.elements['assignedConsultant'].value : 'N/A' }; if (!userData.username || !userData.fullName || !userData.password) return App.UI.toast('All fields are required.', 'error'); if (id) { const index = users.findIndex(u => u.id == id); users[index] = { ...users[index], ...userData }; } else { if (users.some(u => u.username === userData.username)) { return App.UI.toast('Username already exists.', 'error'); } users.push({ id: Date.now(), ...userData }); } App.DB.set('users', users); App.UI.closeModal('user-modal'); App.UI.toast(`User ${id ? 'updated' : 'added'}!`); this.render(); }, deleteUser: function(id) { if (id == App.state.currentUser.id) { return App.UI.toast('You cannot delete your own account.', 'error'); } App.UI.confirm('Are you sure?', "This will delete the user account.", () => { let users = App.DB.get('users').filter(u => u.id != id); App.DB.set('users', users); App.UI.toast('User deleted.', 'success'); this.render(); }); } });
    App.Helpers = {
        formatCurrency: (a) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'AED', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(a),
        formatAbbreviatedCurrency: (num) => {
            if (num >= 1000000) return 'AED ' + (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (num >= 1000) return 'AED ' + (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'AED' }).format(num);
        },
        debounce: (f, d) => { let t; return function(...a) { clearTimeout(t); t = setTimeout(() => f.apply(this, a), d); }; },
        formatDate: (dateString) => {
            const date = new Date(dateString);
            const timeZoneOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() + timeZoneOffset).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        },
        getScopedData(dataType) {
            const { currentUser } = App.state; if (!currentUser) return []; if (currentUser.role === 'admin') return App.DB.get(dataType);
            if (currentUser.role === 'user') {
                const consultantName = currentUser.assignedConsultant;
                const allCustomers = App.DB.get('customers');
                const scopedCustomers = allCustomers.filter(c => c.salesConsultant === consultantName);
                if (dataType === 'customers') return scopedCustomers;
                const scopedCustomerIds = scopedCustomers.map(c => c.accountNo);
                if (dataType === 'visits') return App.DB.get('visits').filter(v => scopedCustomerIds.includes(v.customerId));
                if (dataType === 'payments') return App.DB.get('payments').filter(p => scopedCustomerIds.includes(p.customerId));
            }
            return App.DB.get(dataType);
        },
        logActivity(action, details = '') {
            if (App.state.currentUser.role !== 'user') return;
            const log = App.DB.get('activityLog');
            const now = new Date();
            const newEntry = {
                id: Date.now(),
                consultant: App.state.currentUser.assignedConsultant,
                timestamp: now.getTime(),
                date: now.toISOString().slice(0, 10),
                time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }),
                action,
                details
            };
            log.push(newEntry);
            App.DB.set('activityLog', log);
        }
    };
    </script>
</body>
</html>
