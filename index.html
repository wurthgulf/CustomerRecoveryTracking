<!-- Version: 2.6 (Reports Aligned) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Recovery App - v2.6</title>

<!-- Dependencies -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

<!-- Phase 2 Dependencies -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>


<style>
	
	#upcoming-visits-tile:hover {
    transform: translateY(-5px);
    background-color: var(--bg-color);
    border-color: var(--primary);
    box-shadow: var(--shadow-lg);
}
    :root {
        /* Wuerth Group Inspired Color Palette */
        --primary: #e2000f; /* Wuerth Red */
        --success: #10b981;
        --danger: #dc3545;
        --warning: #ffc107;
        --dark: #212529; /* Black/Dark Grey */
        --light: #f8f9fa;
        --text-primary: #212529;
        --text-secondary: #6c757d; /* Grey */
        --bg-color: #f0f2f5; /* Light Grey Background */
        --card-bg: #ffffff; /* White */
        --border-color: #dee2e6;

        --font-family: 'Inter', sans-serif;
        --fs-sm: 0.875rem; --fs-base: 1rem; --fs-lg: 1.125rem; --fs-xl: 1.25rem; --fs-2xl: 1.5rem; --fs-3xl: 1.875rem;
        --spacing-1: 0.25rem; --spacing-2: 0.5rem; --spacing-4: 1rem; --spacing-6: 1.5rem; --spacing-8: 2rem;
        --transition-speed: 0.2s;
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    
    /* --- Dark Theme --- */
    body[data-theme="dark"] {
        --primary: #e2000f;
        --success: #10b981;
        --danger: #dc3545;
        --warning: #ffc107;
        --dark: #f8f9fa;
        --light: #212529;
        --text-primary: #f8f9fa;
        --text-secondary: #adb5bd;
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --border-color: #343a40;
    }
    body[data-theme="dark"] .btn-primary:hover:not(:disabled) { background: linear-gradient(to bottom, #ff333f, #e2000f); }
    body[data-theme="dark"] .btn-outline { background-color: var(--card-bg); border-color: var(--border-color); color: var(--text-primary); }
    body[data-theme="dark"] .btn-outline:hover:not(:disabled) { background-color: var(--bg-color); }
    body[data-theme="dark"] .data-table tbody tr:hover { background-color: #2c2c2c; }
    body[data-theme="dark"] .searchable-dropdown-item:hover { background-color: var(--bg-color); }
    body[data-theme="dark"] .detail-tab-btn:hover, body[data-theme="dark"] .detail-tab-btn.active { background-color: var(--dark); color: black; border-color: var(--dark); }
    body[data-theme="dark"] .leaflet-tile { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }
    body[data-theme="dark"] .leaflet-routing-container { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); }


    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-primary); font-size: var(--fs-base); line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }
    .app-container { display: grid; grid-template-columns: 250px 1fr; grid-template-rows: auto 1fr; grid-template-areas: "sidebar header" "sidebar main"; height: 100vh; transition: grid-template-columns var(--transition-speed) ease; }
    .sidebar { grid-area: sidebar; background-color: var(--card-bg); border-right: 1px solid var(--border-color); padding: var(--spacing-4); display: flex; flex-direction: column; transition: transform var(--transition-speed) ease, background-color var(--transition-speed) ease; z-index: 1000; }
    .main-header { grid-area: header; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: var(--spacing-4) var(--spacing-6); display: flex; justify-content: space-between; align-items: center; transition: background-color var(--transition-speed) ease; }
    .main-content { grid-area: main; overflow-y: auto; padding: var(--spacing-6); background-color: var(--bg-color); }
    .page { display: none; } .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    /* --- Tablet & iPad Optimized Layout --- */
      @media (max-width: 1180px) {
        .app-container { 
            grid-template-columns: 80px 1fr !important; /* Maintain distinct columns */
            overflow: hidden;
        }

        .sidebar {
            width: 80px !important;
            z-index: 2000 !important; /* Force sidebar to stay on TOP layer */
            position: relative;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        /* Hide text labels on iPad to save space, show only icons */
        .sidebar .logo-text, 
        .sidebar .nav-text, 
        .sidebar-heading { 
            display: none !important; 
        }

        /* Center the icons in the sidebar */
        .nav-link {
            justify-content: center !important;
            padding: 15px 0 !important;
        }

        .nav-link i {
            font-size: 1.4rem;
            margin: 0 !important;
        }

        /* Fix the Overlapping Buttons & Filters */
        .card-header, 
        .d-flex.gap-2.flex-wrap,
        #list-view-controls {
            display: flex !important;
            flex-direction: column !important; /* Stack items vertically on iPad */
            align-items: flex-start !important;
            gap: 15px !important;
        }

        /* Make search bars and dropdowns full width so they don't crowd each other */
        .input-with-icon, 
        .form-control, 
        .btn-group {
            width: 100% !important;
        }

        /* Ensure the main content doesn't slide under the sidebar */
        .main-content {
            width: auto;
            padding: 15px !important;
            overflow-x: hidden;
        }

        /* Fix the 'Today/Tomorrow' date filter overlap */
        .d-flex.gap-2.align-items-center.flex-wrap {
            display: grid !important;
            grid-template-columns: 1fr 1fr;
            width: 100%;
            gap: 10px;
        }
        
        /* Floating Action Button (Red +) Fix */
        .fab-container {
            bottom: 20px !important;
            right: 20px !important;
            z-index: 3000 !important;
        }
    }

    /* Fix for the Top Header on iPad */
    @media (max-width: 1180px) {
        .main-header {
            padding: 10px 15px !important;
        }
        #username-display {
            display: none; /* Hide name on iPad to save space */
        }
    }
    @media (max-width: 768px) { .app-container { grid-template-columns: 1fr; grid-template-areas: "header" "main"; } .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: var(--shadow); } .sidebar.open { transform: translateX(0); } .sidebar .logo-text, .sidebar .nav-text, .sidebar-heading { display: inline; } .sidebar .nav-link { justify-content: flex-start; } .hamburger { display: block !important; } }
    
    /* --- Login Page Enhancements --- */
    #login-page {
        display: flex; justify-content: center; align-items: center; height: 100vh;
        background: linear-gradient(135deg, #f0f2f5 0%, #e6e9ed 100%);
        overflow: hidden;
        position: relative;
    }
    .background-bubbles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; list-style: none; }
    .background-bubbles li { position: absolute; bottom: -160px; width: 40px; height: 40px; background-color: rgba(226, 0, 15, 0.15); border-radius: 50%; animation: floatUp 20s infinite linear; }
    .background-bubbles li:nth-child(1) { left: 10%; width: 80px; height: 80px; animation-delay: 0s; }
    .background-bubbles li:nth-child(2) { left: 20%; width: 30px; height: 30px; animation-delay: 2s; animation-duration: 12s; }
    .background-bubbles li:nth-child(3) { left: 25%; width: 50px; height: 50px; animation-delay: 4s; }
    .background-bubbles li:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
    .background-bubbles li:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
    .background-bubbles li:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; background-color: rgba(226, 0, 15, 0.1); }
    .background-bubbles li:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; background-color: rgba(226, 0, 15, 0.08); }
    .background-bubbles li:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
    .background-bubbles li:nth-child(9) { left: 85%; width: 45px; height: 45px; animation-delay: 2s; animation-duration: 25s; }
    .background-bubbles li:nth-child(10) { left: 90%; width: 15px; height: 15px; animation-delay: 11s; animation-duration: 35s; }
    @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-120vh); opacity: 0; } }

    #login-page .login-card {
        width: 100%; max-width: 400px; padding: var(--spacing-8); border-radius: 16px; text-align: center;
        animation: fadeInUp 0.6s ease-out both;
        z-index: 1;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }
    #login-page .form-group label { text-align: left; } 
    .login-card .logo { animation: fadeIn 0.8s 0.2s ease-out both; text-align: center; }
    .login-card h2 { animation: fadeIn 0.8s 0.4s ease-out both; }
    .login-card .form-group { animation: slideInFromBottom 0.6s ease-out both; }
    .login-card .form-group:nth-of-type(1) { animation-delay: 0.6s; }
    .login-card .form-group:nth-of-type(2) { animation-delay: 0.7s; }
    #login-page button[type="submit"] {
        animation: slideInFromBottom 0.6s 0.8s ease-out both;
        padding: 0.75rem 1.5rem;
        font-size: var(--fs-lg);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    #login-page button[type="submit"]:hover:not(:disabled) {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 10px 20px -5px rgba(226, 0, 15, 0.4);
    }
    #login-page .input-wrapper { position: relative; }
    #login-page .input-wrapper i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); transition: color 0.2s ease; }
    #login-page .input-wrapper .form-control { padding-left: 2.75rem; background-color: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.3); color: var(--text-primary); }
    #login-page .input-wrapper .form-control::placeholder { color: var(--text-secondary); opacity: 0.8; }
    #login-page .input-wrapper .form-control:focus { background-color: rgba(255, 255, 255, 0.3); border-color: var(--primary); box-shadow: 0 0 0 3px rgba(226, 0, 15, 0.2); }
    #login-page .input-wrapper .form-control:focus ~ i { color: var(--primary); }
    
    #login-error { background-color: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); padding: var(--spacing-2); border-radius: 8px; font-weight: 500; display: none; }
    #login-error.show { display: block; animation: shakeError 0.6s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shakeError { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    /* --- End Login Page Enhancements --- */

    .logo img { max-width: 250px; height: auto; margin: 0 auto; }
    .sidebar .logo { text-align: center; }
    .sidebar .logo img { max-width: 180px; margin: 0 auto; }

    .sidebar-heading { font-size: var(--fs-sm); color: var(--text-secondary); text-transform: uppercase; font-weight: 600; padding: var(--spacing-4); margin-top: var(--spacing-4); }
    .nav-link { display: flex; align-items: center; gap: var(--spacing-4); padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-weight: 600; margin-bottom: var(--spacing-1); transition: background-color var(--transition-speed), color var(--transition-speed); }
    .nav-link:hover { background-color: var(--bg-color); color: var(--text-primary); }
    .nav-link.active { background-color: var(--primary); color: white; box-shadow: 0 4px 8px rgba(226, 0, 15, 0.3); }
    .nav-link.active i { color: white; }
    .nav-link i { width: 20px; text-align: center; color: var(--text-secondary); transition: color var(--transition-speed); }
    .hamburger { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.25rem; cursor: pointer; }
    .card { background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); box-shadow: var(--shadow); border: 1px solid var(--border-color); transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease; }
    .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4); padding-bottom: var(--spacing-4); border-bottom: 1px solid var(--border-color); }
    .card-title { font-size: var(--fs-base); font-weight: 600; color: var(--text-secondary); }
    .chart-container { position: relative; height: 350px; }
    .table-container { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    .data-table thead { border-bottom: 2px solid var(--dark); }
    .data-table tbody tr { border-bottom: 1px solid var(--border-color); opacity: 0; transform: translateY(10px); animation: fadeInUpTableRow 0.5s ease-out forwards; }
    .data-table th, .data-table td { padding: var(--spacing-4); text-align: left; vertical-align: middle; border-bottom: none; }
    .data-table th { font-weight: 600; cursor: pointer; text-transform: uppercase; font-size: var(--fs-sm); color: var(--text-secondary); }
    .data-table tbody tr:hover { background-color: #f8f9fa; }
    .data-table tbody tr.clickable-row:hover { background-color: var(--bg-color); cursor: pointer; }
    .data-table th[data-sort]::after { content: ' \f0dc'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #ccc; }
    .data-table th[data-sort].sort-asc::after { content: ' \f0de'; color: var(--primary); }
    .data-table th[data-sort].sort-desc::after { content: ' \f0dd'; color: var(--primary); }
    .btn { padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; min-height: 44px; min-width: 44px; transition: all var(--transition-speed) ease; display: inline-flex; justify-content: center; align-items: center; gap: var(--spacing-2); text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1); }
    .btn:hover:not(:disabled) { transform: translateY(-2px); }
    .btn:active:not(:disabled) { transform: translateY(0); box-shadow: inset 0 2px 2px rgba(0,0,0,0.1); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
	.btn-primary { background: linear-gradient(to bottom, #ff1a28, #e2000f); color: white; border-color: #c0000d; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-primary:hover:not(:disabled) { background: linear-gradient(to bottom, #ff333f, #e2000f); }
    .btn-success { background: linear-gradient(to bottom, #12d493, #10b981); color: white; border-color: #0e9a6b; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-success:hover:not(:disabled) { background: linear-gradient(to bottom, #24e0a1, #10b981); }
    .btn-danger { background: linear-gradient(to bottom, #e34654, #dc3545); color: white; border-color: #b02a37; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-danger:hover:not(:disabled) { background: linear-gradient(to bottom, #ea5c69, #dc3545); }
    .btn-warning { background: linear-gradient(to bottom, #ffca2c, #ffc107); color: var(--dark); border-color: #d39e00; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-warning:hover:not(:disabled) { background: linear-gradient(to bottom, #ffd55b, #ffc107); }
    .btn-outline { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); text-shadow: none; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5); } .btn-outline:hover:not(:disabled) { background-color: var(--bg-color); }
    .form-group { margin-bottom: var(--spacing-4); }
    .form-group label { display: block; font-weight: 500; margin-bottom: var(--spacing-2); }
    .form-control { width: 100%; padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-primary); font-size: var(--fs-base); }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; }
    .modal.active { display: flex; animation: fadeIn 0.3s; }
    .modal-content { width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); transition: background-color var(--transition-speed) ease; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4); }
    .modal-footer { margin-top: var(--spacing-6); display: flex; justify-content: flex-end; gap: var(--spacing-2); }
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .spinner { width: 50px; height: 50px; border: 5px solid var(--light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInFromBottom { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInUpTableRow { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .status-badge { padding: 4px 10px; border-radius: 999px; font-size: var(--fs-sm); font-weight: 600; text-transform: uppercase; border: 1px solid; }
    .status-badge.admin { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; border-color: #dc3545; }
    .status-badge.user { background-color: rgba(226, 0, 15, 0.1); color: #e2000f; border-color: #e2000f; }
    .status-badge.paid, .status-badge.active, .status-badge.complete, .status-badge.completed { background-color: rgba(16, 185, 129, 0.1); color: #10b981; border-color: #10b981; }
    .status-badge.pending { background-color: rgba(255, 193, 7, 0.1); color: #d9a007; border-color: #ffc107;}
    .status-badge.overdue { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; border-color: #dc3545; }
    .status-badge.negotiation { background-color: rgba(255, 193, 7, 0.1); color: #d9a007; border-color: #ffc107;}
    .status-badge.settlement { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; border-color: #0d6efd;}
    .status-badge.legal { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; border-color: #dc3545; }
    .status-badge.write-off { background-color: rgba(108, 117, 125, 0.1); color: #6c757d; border-color: #6c757d; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4); }
    .form-grid .full-width { grid-column: 1 / -1; }
    .detail-info-grid, .kpi-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-6); }
    .detail-info-card { background: var(--bg-color); padding: var(--spacing-4); border-radius: 8px; border: 1px solid var(--border-color); }
    .detail-info-card .label { font-size: var(--fs-sm); color: var(--text-secondary); margin-bottom: var(--spacing-1); text-transform: uppercase; }
    .detail-info-card .value, .kpi-card .value { font-weight: 600; font-size: var(--fs-lg); }
    .kpi-card {background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
    .kpi-card .title {font-size: var(--fs-base); font-weight: 600; color: var(--text-secondary);}
    .kpi-card .value {font-size: var(--fs-3xl); font-weight: 700;}
    .filter-btn { box-shadow: none; }
    .filter-btn.active { background-color: var(--dark); color: white; border-color: var(--dark); }
    .detail-tab-btn { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: var(--spacing-1) var(--spacing-4); font-size: var(--fs-sm); font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; gap: var(--spacing-2); color: var(--text-secondary); }
    .detail-tab-btn:hover { background-color: var(--dark); color: white; border-color: var(--dark); }
    .detail-tab-btn.active { background-color: var(--dark); color: white; border-color: var(--dark); box-shadow: var(--shadow); }
    .page-header { color: var(--text-primary); margin-bottom: var(--spacing-4); } .page-header h2 { font-size: var(--fs-2xl); font-weight: 700; } .page-header p { color: var(--text-secondary); }
    .progress-bar { width: 100%; height: 8px; background-color: var(--bg-color); border-radius: 999px; overflow: hidden; border: 1px solid var(--border-color); }
    .progress-bar-inner { height: 100%; background-color: var(--primary); border-radius: 999px; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); width: 0; }
    .hidden { display: none !important; } .d-flex { display: flex; } .gap-2 { gap: var(--spacing-2); } .gap-4 { gap: var(--spacing-4); } .mt-4 { margin-top: var(--spacing-4); } .mb-4 { margin-bottom: var(--spacing-4); }
    .justify-content-between { justify-content: space-between; } .align-items-center { align-items: center; } .flex-wrap { flex-wrap: wrap; }
    
    .file-upload-wrapper { border: 2px dashed var(--border-color); border-radius: 8px; padding: var(--spacing-6); text-align: center; cursor: pointer; transition: border-color var(--transition-speed); }
    .file-upload-wrapper:hover, .file-upload-wrapper.dragover { border-color: var(--primary); }
    .file-upload-wrapper p { margin-top: var(--spacing-2); margin-bottom: var(--spacing-2); }
    .info-box { background: var(--bg-color); border: 1px solid var(--border-color); padding: var(--spacing-4); border-radius: 8px; margin: var(--spacing-4) 0; font-size: var(--fs-sm); }
    .info-box p { margin-bottom: var(--spacing-2); }
    .info-box code { background: var(--border-color); padding: 2px 6px; border-radius: 4px; }

    .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-6); }
    .report-card { background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); box-shadow: var(--shadow); border: 1px solid var(--border-color); text-decoration: none; color: var(--text-primary); transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
    .report-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .report-card .icon { font-size: 1.5rem; color: var(--primary); margin-bottom: var(--spacing-4); }
    .report-card h4 { font-weight: 600; font-size: var(--fs-lg); margin-bottom: var(--spacing-2); }
    .report-card p { font-size: var(--fs-sm); color: var(--text-secondary); }
    
    /* --- New & Modified Styles for v1.5 --- */
    .report-generators-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-6); margin-bottom: var(--spacing-6); }
    @media (max-width: 1024px) { .report-generators-grid { grid-template-columns: 1fr; } }

    .performance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--spacing-6); }
    
    .priority-action-item { list-style: none; padding: var(--spacing-4) 0; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color var(--transition-speed); }
    .priority-action-item:last-child { border-bottom: none; }
    .priority-action-item:hover { background-color: var(--bg-color); }
    .priority-action-item .icon { color: var(--primary); width: 20px; text-align: center; margin-right: var(--spacing-4); }
    
    .timeline { list-style: none; padding-left: 1.5rem; position: relative; }
    .timeline::before { content: ''; position: absolute; top: 0; left: 5px; height: 100%; width: 2px; background: var(--border-color); }
    .timeline-item { position: relative; margin-bottom: var(--spacing-6); }
    .timeline-item::before { content: ''; position: absolute; left: -1.5rem; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: var(--card-bg); border: 3px solid var(--primary); }
    .timeline-item-header { font-weight: 600; margin-bottom: var(--spacing-1); }
    .timeline-item-body { font-size: var(--fs-sm); color: var(--text-secondary); }
    .timeline-item-body .notes { border-left: 3px solid var(--border-color); padding-left: var(--spacing-2); margin-top: var(--spacing-2); }

    .column-toggle-dropdown { display: none; position: absolute; background-color: var(--card-bg); box-shadow: var(--shadow-lg); border-radius: 8px; border: 1px solid var(--border-color); padding: var(--spacing-2); z-index: 10; min-width: 180px; }
    .column-toggle-dropdown label { display: block; padding: var(--spacing-2); cursor: pointer; border-radius: 4px; }
    .column-toggle-dropdown label:hover { background-color: var(--bg-color); }
    /* --- End New Styles --- */

    .searchable-dropdown { position: relative; }
    .searchable-dropdown-results { position: absolute; top: 100%; left: 0; right: 0; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 2010; box-shadow: var(--shadow); }
    .searchable-dropdown-item { padding: var(--spacing-2) var(--spacing-4); cursor: pointer; line-height: 1.4; }
    .searchable-dropdown-item:hover { background-color: var(--bg-color); }
    .searchable-dropdown-item.no-results { color: var(--text-secondary); cursor: default; }
    .sdi-main { font-weight: 500; color: var(--text-primary); }
    .sdi-secondary { font-size: var(--fs-sm); color: var(--text-secondary); }

    .input-with-icon { position: relative; display: inline-block; }
    .input-with-icon .form-control { padding-right: 2.5rem; }
    .input-with-icon .icon { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
    .input-with-icon .clear-icon { display: none; cursor: pointer; }
    .input-with-icon .form-control:not(:placeholder-shown) ~ .clear-icon { display: block; }
    body[data-theme="dark"] .input-with-icon .form-control:not(:placeholder-shown) { padding-right: 2.5rem; } /* Fix for dark mode padding */

    #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; transition: opacity 0.3s; }

    .pagination-controls { display: flex; justify-content: space-between; align-items: center; padding-top: var(--spacing-4); border-top: 1px solid var(--border-color); margin-top: var(--spacing-4); }
    .empty-state { text-align: center; padding: var(--spacing-8); color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: var(--spacing-4); display: block; }
    .empty-state h4 { font-size: var(--fs-lg); margin-bottom: var(--spacing-2); color: var(--text-primary); }
    .empty-state p { margin-bottom: var(--spacing-4); }
    
    .numbered-marker {
        background-color: var(--primary);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        text-align: center;
        line-height: 28px;
        font-weight: bold;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.4);
    }
    
    /* --- Phase 1: Status Markers --- */
    .leaflet-div-icon {
        border: none;
        background: none;
    }
    .status-marker {
        position: relative;
        font-size: 28px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .status-marker.good { color: var(--success); }
    .status-marker.warning { color: var(--warning); }
    .status-marker.critical { color: var(--danger); }
    .status-marker.completed { color: #6c757d; } /* Grey for completed */
    .status-marker::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 8px;
        height: 8px;
        background: black;
        border-radius: 50%;
        opacity: 0.2;
        filter: blur(3px);
    }

    /* --- New styles for v1.1 & v2.2 enhancements --- */
    .customer-tag {
        display: inline-block;
        font-size: var(--fs-sm);
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid;
        margin: 2px;
    }
    .clickable-tag {
        cursor: pointer;
        transition: transform var(--transition-speed) ease;
    }
    .clickable-tag:hover {
        transform: scale(1.05);
    }
    .comment-item {
        border-bottom: 1px solid var(--border-color);
        padding: var(--spacing-4) 0;
    }
    .comment-item:last-child {
        border-bottom: none;
    }
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-2);
    }
    .comment-author {
        font-weight: 600;
    }
    .comment-date {
        font-size: var(--fs-sm);
        color: var(--text-secondary);
    }
    
    /* -- New for v2.0 and v2.2 enhancements -- */
    .breakdown-item {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: var(--spacing-2);
        flex-wrap: wrap;
    }
    .breakdown-item .value {
        font-size: var(--fs-lg);
        font-weight: 600;
    }
    .breakdown-item .percentage {
        font-size: var(--fs-sm);
        font-weight: 500;
        color: var(--text-secondary);
    }
    .report-table-small th, .report-table-small td {
        padding: var(--spacing-2) !important;
        font-size: var(--fs-sm) !important;
    }
    .report-table-small thead th {
        color: var(--primary);
    }
    .dynamic-filter-row {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: var(--spacing-4);
        margin-bottom: var(--spacing-2);
        display: grid;
        grid-template-columns: minmax(200px, 1fr) minmax(150px, 1fr) minmax(200px, 1.5fr) auto;
        gap: var(--spacing-2);
        align-items: center;
        background-color: var(--bg-color);
    }
    .dynamic-filter-row:hover {
        background-color: var(--card-bg);
    }
    
    /* --- My Day Page Styles --- */
    .myday-task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-2) 0;
        border-bottom: 1px solid var(--border-color);
    }
     .myday-task-item:last-child {
        border-bottom: none;
    }
    .myday-task-item.clickable {
        cursor: pointer;
    }
     .myday-task-item.clickable:hover {
        background-color: var(--bg-color);
     }
    .myday-task-info {
        display: flex;
        flex-direction: column;
    }
    .myday-task-info .customer-name {
        font-weight: 600;
    }
     .myday-task-info .task-details {
        font-size: var(--fs-sm);
        color: var(--text-secondary);
    }

    /* Health Score Indicator */
    .health-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
    }
    .health-dot.good { background-color: var(--success); }
    .health-dot.warning { background-color: var(--warning); }
    .health-dot.critical { background-color: var(--danger); }

    /* --- Reports Page Improvements (NEW) --- */
    .report-section-header {
        font-size: var(--fs-lg);
        font-weight: 700;
        color: var(--text-primary);
        margin-top: var(--spacing-8);
        margin-bottom: var(--spacing-4);
        padding-bottom: var(--spacing-2);
        border-bottom: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: var(--spacing-2);
    }

    .report-section-header i {
        color: var(--primary);
    }

    .report-category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--spacing-6);
    }

    /* Make cards equal height and push buttons to bottom */
    .report-category-grid .card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .report-category-grid .card .form-grid {
        flex-grow: 1; /* Pushes the button down */
    }

    .report-category-grid .card button {
        margin-top: var(--spacing-4);
        align-self: flex-start;
    }

    /* Improve Standard Reports Buttons */
    .standard-reports-buttons {
        display: flex;
        gap: var(--spacing-4);
        flex-wrap: wrap;
    }

    .standard-reports-buttons button {
        flex: 1 1 calc(20% - var(--spacing-4)); /* distribute evenly */
        min-width: 140px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-4);
        gap: var(--spacing-2);
    }

    .standard-reports-buttons button i {
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    /* --- Accessibility --- */
    *:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; border-radius: 4px; }
    
    @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
        }
    }
	
	/* Context Menu Styles */
    .context-menu {
        position: absolute;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        padding: 5px 0;
        min-width: 180px;
        z-index: 9999;
        display: none;
        animation: fadeIn 0.1s ease-out;
    }
    .context-menu-item {
        padding: 8px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-primary);
        font-size: var(--fs-sm);
        transition: background 0.1s;
    }
    .context-menu-item:hover {
        background-color: var(--bg-color);
        color: var(--primary);
    }
    .context-menu-item i {
        width: 16px;
        text-align: center;
        color: var(--text-secondary);
    }
    .context-menu-divider {
        height: 1px;
        background-color: var(--border-color);
        margin: 4px 0;
    }
	
	/* Kanban Board Styles */
    .kanban-container {
        display: flex;
        gap: var(--spacing-4);
        overflow-x: auto;
        padding-bottom: var(--spacing-4);
        height: calc(100vh - 250px);
    }
    .kanban-column {
        min-width: 280px;
        width: 320px;
        background-color: var(--bg-color);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
    }
    .kanban-header {
        padding: var(--spacing-4);
        font-weight: 700;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--card-bg);
        border-radius: 12px 12px 0 0;
        position: sticky;
        top: 0;
    }
    .kanban-body {
        padding: var(--spacing-4);
        overflow-y: auto;
        flex-grow: 1;
        min-height: 100px; /* Drop target area */
    }
    .kanban-card {
        background: var(--card-bg);
        padding: var(--spacing-4);
        border-radius: 8px;
        box-shadow: var(--shadow);
        margin-bottom: var(--spacing-4);
        cursor: grab;
        border: 1px solid var(--border-color);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    .kanban-card:active {
        cursor: grabbing;
    }
    .kanban-card.dragging {
        opacity: 0.5;
        border: 2px dashed var(--primary);
    }
    .kanban-column.drag-over {
        background-color: rgba(226, 0, 15, 0.05); /* Light red tint */
        border: 2px dashed var(--primary);
    }
	
	/* Floating Action Button (FAB) */
    .fab-container {
        position: fixed;
        bottom: 90px;
        right: 30px;
        z-index: 1000;
        display: flex;
        flex-direction: column-reverse;
        align-items: center;
        gap: 15px;
    }
    .fab-main {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #ff1a28, #e2000f);
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(226, 0, 15, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .fab-main:hover {
        transform: scale(1.1) rotate(90deg);
    }
    .fab-action {
        width: 45px;
        height: 45px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--text-secondary);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        cursor: pointer;
        opacity: 0;
        transform: translateY(20px) scale(0);
        transition: all 0.3s ease;
        position: relative;
    }
    .fab-action:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    /* Tooltip text for actions */
    .fab-action::after {
        content: attr(data-tooltip);
        position: absolute;
        right: 60px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }
    .fab-action:hover::after {
        opacity: 1;
    }
    /* Animation State */
    .fab-container.active .fab-action {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    .fab-container.active .fab-action:nth-child(2) { transition-delay: 0.05s; }
    .fab-container.active .fab-action:nth-child(3) { transition-delay: 0.1s; }
    .fab-container.active .fab-action:nth-child(4) { transition-delay: 0.15s; }
	
	/* Smart Search Highlight */
    mark.highlight {
        background-color: #fff3cd;
        color: #856404;
        padding: 0 2px;
        border-radius: 2px;
        font-weight: 600;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Sticky Table Headers */
    .table-container {
        max-height: 70vh; /* Limit height to trigger scroll */
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    .data-table thead th {
        position: sticky;
        top: 0;
        background-color: var(--card-bg); /* Opaque background needed */
        z-index: 10;
        box-shadow: 0 2px 4px -1px rgba(0,0,0,0.1); /* Subtle shadow line */
        border-bottom: 2px solid var(--primary); /* Strong visual anchor */
    }
	
	/* Smart Avatars */
    .avatar-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        text-transform: uppercase;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Micro Progress Bar (Table) */
    .micro-progress-container {
        width: 100px;
        background-color: var(--border-color);
        height: 6px;
        border-radius: 3px;
        margin-top: 6px;
        overflow: hidden;
    }
    .micro-progress-bar {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease;
    }
    .consultant-row-wrapper {
        display: flex;
        align-items: center;
    }
	
	/* 1. Force the container holding the dropdown to be on top of everything */
	.card-header, 
	.card-tools, 
	.d-flex.justify-content-between,
	.toolbar-container {
		position: relative !important;
		z-index: 2000 !important; /* Higher than the sticky header */
		overflow: visible !important;
	}

	/* 2. Ensure the dropdown itself is high up */
	.dropdown-menu {
		z-index: 3000 !important;
	}

	/* 3. Lower the sticky table header slightly so it sits behind the dropdown */
	thead.sticky-top th,
	th.sticky-top {
		z-index: 100 !important; /* Must be lower than 2000 */
	}

</style>

<style id="wuerth-glossy-theme">
    /* Glossy Theme Enhancements */
    .card, .sidebar, .main-header, .modal-content {
        background: linear-gradient(to bottom, #ffffff, #fdfdfd);
    }
    body[data-theme="dark"] .card,
    body[data-theme="dark"] .sidebar,
    body[data-theme="dark"] .main-header,
    body[data-theme="dark"] .modal-content {
        background: linear-gradient(to bottom, #2a2a2a, #1e1e1e);
    }

    .nav-link.active {
        background: linear-gradient(to bottom, #ff1a28, #e2000f);
        border: 1px solid #c0000d;
    }
    .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(226, 0, 15, 0.2);
    }
</style>
</head> <body> <!-- App containers that will be populated by JavaScript --> <div id="login-page"></div> <div id="app" class="app-container hidden"></div>

<!-- Modal containers -->
<div id="customer-modal" class="modal"></div>
<div id="user-modal" class="modal"></div>
<div id="payment-modal" class="modal"></div>
<div id="visit-modal" class="modal"></div>
<div id="import-csv-modal" class="modal"></div>
<div id="customer-detail-modal" class="modal"></div>
<div id="visit-notes-modal" class="modal"></div>
<div id="payment-detail-modal" class="modal"></div>
<div id="consultant-modal" class="modal"></div>
<div id="visit-detail-modal" class="modal"></div>
<div id="consultant-customers-modal" class="modal"></div>
<div id="reassign-customers-modal" class="modal"></div>
<div id="reassign-and-delete-consultant-modal" class="modal"></div>
<div id="forecast-modal" class="modal"></div>
<div id="customer-forecast-modal" class="modal"></div>
<div id="report-modal" class="modal"></div>
<div id="bulk-update-customers-modal" class="modal"></div>
<div id="changelog-detail-modal" class="modal"></div>
<div id="route-planner-modal" class="modal"></div>

<!-- Notification Dropdown -->
<div id="notification-dropdown" class="card hidden" style="position: absolute; width: 350px; z-index: 1001; max-height: 400px; overflow-y: auto; padding: var(--spacing-4);">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 style="margin: 0;">Notifications</h4>
    </div>
    <ul id="notification-list" style="list-style: none; padding: 0; margin: 0;">
        <!-- Notifications will be rendered here -->
    </ul>
</div>

<!-- Command Palette Modal -->
<div id="command-palette-modal" class="modal" style="align-items: flex-start; padding-top: 10vh;">
    <div class="modal-content" style="max-width: 600px; padding: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
        <div class="d-flex align-items-center gap-2 p-3" style="border-bottom: 1px solid var(--border-color); background: var(--card-bg);">
            <i class="fas fa-search" style="color: var(--text-secondary); font-size: 1.2rem;"></i>
            <input type="text" id="command-palette-input" class="form-control" placeholder="Type a command or search..." style="border: none; background: transparent; box-shadow: none; font-size: 1.1rem; padding: 0.5rem;">
            <div style="font-size: 0.8rem; color: var(--text-secondary); border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px;">ESC</div>
        </div>
        <div id="command-palette-results" style="max-height: 400px; overflow-y: auto; padding: 0.5rem;">
            </div>
        <div class="p-2" style="background: var(--bg-color); border-top: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-secondary); text-align: right;">
            <span style="margin-right: 10px;">Select <i class="fas fa-arrow-down"></i> <i class="fas fa-arrow-up"></i></span>
            <span>Open <i class="fas fa-level-down-alt" style="transform: rotate(90deg);"></i></span>
        </div>
    </div>
    <style>
        .command-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 15px; transition: all 0.1s; border-left: 3px solid transparent; }
        .command-item.selected { background-color: var(--bg-color); border-left-color: var(--primary); }
        .command-item:hover { background-color: var(--bg-color); }
        .command-group-title { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 10px 0 5px 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    </style>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
    <div class="spinner"></div>
</div>

<!-- Sidebar Overlay for Mobile -->
<div id="sidebar-overlay" class="hidden"></div>

<div id="command-palette-modal" class="modal" style="align-items: flex-start; padding-top: 10vh;">
    <div class="modal-content" style="max-width: 600px; padding: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
        <div class="d-flex align-items-center gap-2 p-3" style="border-bottom: 1px solid var(--border-color); background: var(--card-bg);">
            <i class="fas fa-search" style="color: var(--text-secondary); font-size: 1.2rem;"></i>
            <input type="text" id="command-palette-input" class="form-control" placeholder="Search customers, pages, or actions..." style="border: none; background: transparent; box-shadow: none; font-size: 1.1rem; padding: 0.5rem;">
            <div style="font-size: 0.8rem; color: var(--text-secondary); border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px;">ESC</div>
        </div>
        <div id="command-palette-results" style="max-height: 400px; overflow-y: auto; padding: 0.5rem;">
            </div>
        <div class="p-2" style="background: var(--bg-color); border-top: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-secondary); text-align: right;">
            <span style="margin-right: 10px;">Select <i class="fas fa-arrow-down"></i> <i class="fas fa-arrow-up"></i></span>
            <span>Open <i class="fas fa-level-down-alt" style="transform: rotate(90deg);"></i></span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Version Control & Session Recovery Logic
    const currentAppVersion = '2.6';
    const storedVersion = localStorage.getItem('appVersion');

    if (storedVersion !== currentAppVersion) {
        console.warn(`App version mismatch. Stored: ${storedVersion}, Current: ${currentAppVersion}. Clearing local storage.`);
        // Clear all local data which might be in an old format
        localStorage.clear();
        // Set the new version
        localStorage.setItem('appVersion', currentAppVersion);
        // We reload the page to ensure a completely clean state
        location.reload();
        return; // Stop further execution
    }
    
    // Session Recovery for corrupt data within the same version
    const userSession = sessionStorage.getItem('user');
    if (userSession) {
        try {
            JSON.parse(userSession);
        } catch (error) {
            console.warn("Corrupt session data detected. Clearing session and reloading.");
            sessionStorage.removeItem('user');
            location.reload();
            return; 
        }
    }
    App.init();
});


const App = {
    state: { 
        currentUser: null, 
        reports: { activityView: 'summary', customReportFilters: [] }, 
        activePage: 'dashboard', 
        activeCustomerId: null, 
        activeConsultantId: null,
        visits: { activeView: 'list', filter: 'Upcoming', startDate: '', endDate: '', search: '', consultantFilter: 'all', mapDate: new Date().toISOString().slice(0, 10), mapConsultant: 'all', plannedRoute: null },
        payments: { search: '', statusFilter: 'all', methodFilter: 'all'},
        adminDashboardView: 'overview', dayTimerInterval: null, dashboardInterval: null, paymentFlowOrigin: null, breakStartTime: null, totalBreakTime: 0,
        dashboardTimeFrame: null,
        tableSorts: {
            customers: { column: 'accountNo', order: 'asc' },
            users: { column: 'username', order: 'asc' },
            consultants: { column: 'name', order: 'asc' },
            visits: { column: 'dateTime', order: 'desc' },
            payments: { column: 'date', order: 'desc' },
            changelog: { column: 'timestamp', order: 'desc' },
            myday: { column: 'dateTime', order: 'asc' },
        },
        pagination: {
            customers: { currentPage: 1, rowsPerPage: 10 },
            users: { currentPage: 1, rowsPerPage: 10 },
            consultants: { currentPage: 1, rowsPerPage: 10 },
            visits: { currentPage: 1, rowsPerPage: 10 },
            payments: { currentPage: 1, rowsPerPage: 10 },
            changelog: { currentPage: 1, rowsPerPage: 25 },
            myday: { currentPage: 1, rowsPerPage: 100 },
        },
        customerTableColumns: {
            accountNo: true, companyName: true, customerStatus: false, agingCategory: true, outstanding: true,
            balance_2020_2025: true, balance_2019_2020: true, balance_lte_2018: true, forecastAmount: false,
            salesConsultantId: true, paymentStatus: true, email: false, mobile: false,
        }
    },
    
    // --- FIXED INIT SEQUENCE ---
    async init() { 
        console.log("App Starting...");
        
        // 1. Draw UI & Enable Buttons IMMEDIATELY
        this.UI.hydrate(); 
        this.UI.setupEventListeners(); 
        
        // 2. Initialize Helpers
        this.CommandPalette.init(); 
        this.Notifications.init(); 
        this.Import.init(); 
        this.Offline.init();
        if(this.ContextMenu) this.ContextMenu.init(); 
        if(this.FAB) this.FAB.init();
        this.UI.applyTheme(); 

        // 3. Connect to Database (Async)
        // We do NOT await this anymore so the UI stays responsive
        this.DB.initialize().then(() => {
            console.log("DB Connected.");
        });
        
        // 4. Session Check
        const now = new Date();
        this.state.dashboardTimeFrame = {
            year: now.getFullYear(),
            month: (now.getMonth() + 1).toString().padStart(2, '0')
        };
        this.Auth.checkSession(); 

        // 5. Safety
        window.addEventListener('beforeunload', (e) => {
            if (App.DB.pendingSyncs > 0) { e.preventDefault(); e.returnValue = ''; }
        });
    },
    Auth: {}, DB: {}, UI: {}, Dashboard: {}, Customers: {}, Visits: {}, Payments: {}, Reports: {}, Analytics: {}, Consultants: {}, Users: {}, Notifications: {}, CommandPalette: {}, Helpers: {}, ChangeLog: {}, Import: {}, Settings: {}, Performance: {}, MyDay: {}, Geo: {}, Offline: {}, FAB: {}, ContextMenu: {} 
};

Object.assign(App.Auth, { 
    async login(u, p) { 
        // 1. Force a fresh data pull from the sheet before checking credentials
        // This ensures we have the correct assignedConsultantId from the Admin
        App.UI.toggleLoading(true, "Verifying Credentials...");
        await App.DB.initialize(); 
        
        const users = App.DB.get('users');
        const encodedP = btoa(p); 
        const userIndex = users.findIndex(user => user.username === u && user.password === encodedP); 
        
        if (userIndex > -1) { 
            const user = users[userIndex];
            user.lastLogin = Date.now();
            
            // Save the updated lastLogin to the cloud while preserving the consultant ID
            App.DB.set('users', users);
            
            App.state.currentUser = user; 
            sessionStorage.setItem('user', JSON.stringify(App.state.currentUser)); 
            App.UI.showApp(); 
            this.setupAutoLogout();
            App.UI.toggleLoading(false);
            return true; 
        } 
        App.UI.toggleLoading(false);
        return false; 
    }, 
    logout() { 
        App.state.currentUser = null; 
        sessionStorage.removeItem('user'); 
        clearInterval(App.state.dayTimerInterval); 
        clearInterval(App.state.dashboardInterval); 
        App.UI.showLogin(); 
    }, 
    checkSession() { 
        const user = sessionStorage.getItem('user'); 
        if (user) { 
            App.state.currentUser = JSON.parse(user); 
            App.UI.showApp(); 
            this.setupAutoLogout(); // <--- Start the timer if session exists
        } else { 
            App.UI.showLogin(); 
        } 
    }, 
    checkRole() { 
        document.querySelectorAll('[data-role="admin"]').forEach(el => { el.style.display = (App.state.currentUser.role === 'admin') ? '' : 'none'; }); 
        document.querySelectorAll('[data-role="user"]').forEach(el => { el.style.display = (App.state.currentUser.role === 'user') ? '' : 'none'; }); 
    },
    // --- NEW SECURITY FUNCTION ---
    setupAutoLogout() {
        let timer;
        const logoutTime = 15 * 60 * 1000; // 15 Minutes
        
        const resetTimer = () => {
            if(!App.state.currentUser) return; // Don't run if already logged out
            clearTimeout(timer);
            timer = setTimeout(() => {
                Swal.fire({
                    title: 'Session Expired',
                    text: 'For security, you have been logged out due to inactivity.',
                    icon: 'warning',
                    confirmButtonText: 'Login Again',
                    allowOutsideClick: false
                }).then(() => {
                    this.logout();
                });
            }, logoutTime);
        };

        // Listen for any user activity
        window.onload = resetTimer;
        document.onmousemove = resetTimer;
        document.onkeypress = resetTimer;
        document.onclick = resetTimer;
        document.onscroll = resetTimer;
        
        resetTimer(); // Start immediately
    }
});

// --- REPLACE ENTIRE APP.DB SECTION WITH THIS ---
Object.assign(App.DB, { 
    apiUrl: 'https://script.google.com/macros/s/AKfycbwyANA2bFw8DdwMu0wiCYxPb20f06nQ4JvAhjSRmLSucBj6iAuyPa94kti_idakHd25/exec',
    cache: {},
    pendingSyncs: 0,

    async initialize() {
        App.UI.toggleLoading(true, "Syncing Data...");
        
        try {
            // Force fresh fetch
            const response = await fetch(this.apiUrl + '?t=' + Date.now());
            const cloudData = await response.json();
            
            this.cache = {};
            const tables = ['consultants', 'users', 'customers', 'visits', 'payments', 'activityLog', 'notifications', 'changeLog', 'forecasts', 'customerComments', 'customerForecasts'];
            
            tables.forEach(table => {
                let raw = cloudData[table];
                if (typeof raw === 'string') { try { raw = JSON.parse(raw); } catch(e) { raw = []; } }
                if (!Array.isArray(raw)) raw = [];

                if (table === 'customers') {
                    // Normalize every row to fix missing columns AND FORCE STRING IDs
                    this.cache[table] = raw.map(row => this.normalizeCustomer(row));
                } else {
                    this.cache[table] = raw;
                }
            });

            if (!this.cache['users'] || this.cache['users'].length === 0) {
                const defaultAdmin = { id: 1, username: 'admin', fullName: 'Admin User', password: btoa('admin123'), role: 'admin', department: 'Administration', lastLogin: null, assignedConsultantId: null };
                this.cache['users'] = [defaultAdmin];
                this.set('users', this.cache['users']); 
            }

            App.UI.toggleLoading(false);
            App.UI.updateCloudStatus('saved');
            
            if (App.state.activePage) {
                const pageMod = App[App.state.activePage.charAt(0).toUpperCase() + App.state.activePage.slice(1)];
                if (pageMod && pageMod.render) pageMod.render();
            }

        } catch (error) {
            console.error("DB Error:", error);
            App.UI.toggleLoading(false);
            App.UI.updateCloudStatus('error');
        }
    }, 

    // --- SMART NORMALIZER (Fixed for String IDs) ---
    // --- UNIVERSAL FIX: Finds Status in ANY column and ACCEPTS IT ---
    normalizeCustomer(row) {
        if (!row) return {};
        
        // Helper to find value regardless of spaces, underscores, or casing in headers
        const find = (targets) => {
            const keys = Object.keys(row);
            for (let t of targets) {
                const normalizedTarget = t.toLowerCase().replace(/[^a-z0-9]/g, '');
                const match = keys.find(k => k.toLowerCase().replace(/[^a-z0-9]/g, '') === normalizedTarget);
                if (match) return row[match];
            }
            return undefined;
        };

        const pNum = (v) => {
            if (typeof v === 'number') return v;
            return parseFloat(String(v || 0).replace(/[^0-9.-]/g, '')) || 0;
        };

        // Priority header check
        let rawCustStatus = find(['customerStatus', 'Customer Bucket', 'Segment']);
        let rawAccStatus = find(['status', 'Account Status']) || 'Active';

        // Fix logic: If data is in the wrong column, swap them
        if (!rawCustStatus && (String(rawAccStatus).includes('Sales') || String(rawAccStatus).includes('Month'))) {
            rawCustStatus = rawAccStatus;
            rawAccStatus = 'Active'; 
        }

        return {
            accountNo: String(find(['accountNo', 'accountNumber', 'Code']) || 'UNKNOWN'),
            companyName: find(['companyName', 'Name', 'Customer']) || 'Unknown',
            email: find(['email']) || '',
            mobile: find(['mobile', 'Phone']) || '',
            emirate: find(['emirate', 'City']) || 'Dubai',
            area: find(['area', 'Location']) || '',
            status: rawAccStatus, 
            paymentStatus: find(['paymentStatus']) || 'Negotiation',
            salesConsultantId: find(['salesConsultantId', 'salesConsultant', 'Sales Rep']),
            initialDebt: pNum(find(['initialDebt'])),
            // Map aging buckets exactly as per your CSV
            balance_2020_2025: pNum(find(['balance2020_2025', 'balance20202025'])),
            balance_2019_2020: pNum(find(['balance2019_2020', 'balance20192020'])),
            balance_lte_2018: pNum(find(['balance_lte_2018', 'balancelte2018'])),
            outstanding: pNum(find(['outstanding', 'balance', 'Total Due'])),
            latitude: pNum(find(['latitude', 'lat'])),
            longitude: pNum(find(['longitude', 'lng'])),
            debtSince: find(['debtSince', 'Date']) || new Date().toISOString().slice(0, 10),
            customerStatus: rawCustStatus || 'Collectors', // Final fallback
            agingCategory: App.Helpers.calculateAgingCategory(find(['debtSince'])),
            tags: [] 
        };
    },

    get(key) { return this.cache[key] || []; },

    set(key, data) {
        this.cache[key] = data;
        this.pendingSyncs++;
        App.UI.updateCloudStatus('syncing');
        fetch(this.apiUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ table: key, data: data }) })
        .then(() => {
            this.pendingSyncs = Math.max(0, this.pendingSyncs - 1);
            if (this.pendingSyncs === 0) App.UI.updateCloudStatus('saved');
        })
        .catch(err => {
            console.error(err);
            this.pendingSyncs = Math.max(0, this.pendingSyncs - 1);
            App.UI.updateCloudStatus('error');
        });
    },
    runMigrations() {}
});

Object.assign(App.UI, { 
    intersectionObserver: null,
    hydrate() { 
        document.getElementById('login-page').innerHTML = `
            <ul class="background-bubbles"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul>
            <div class="login-card">
                <div class="logo"><img src="https://i.ibb.co/pvvsMy1X/Wurth-Gulf-CMYK-PNG-01.png" alt="Wuerth Gulf Logo"></div>
                <h2 style="font-weight: 500; color: var(--text-secondary); margin-bottom: var(--spacing-6);">Customer Recovery App</h2>
                <p id="login-error">Invalid credentials.</p>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <div class="input-wrapper">
                            <i class="fas fa-user"></i>
                            <input type="text" id="username" class="form-control" required placeholder="Enter your username">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="password" class="form-control" required placeholder="Enter your password">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>
                <div class="mt-4" style="color: var(--text-secondary); font-size: var(--fs-sm);"></div>
            </div>`; 
        document.getElementById('app').innerHTML = `<aside class="sidebar"><div class="logo logo-text"><img src="https://i.ibb.co/pvvsMy1X/Wurth-Gulf-CMYK-PNG-01.png" alt="Wuerth Gulf Logo"></div><nav><div class="sidebar-heading">Main</div><ul style="list-style:none;"><li><a href="#dashboard" class="nav-link active" data-page="dashboard"><i class="fas fa-chart-pie"></i> <span class="nav-text">Dashboard</span></a></li><li data-role="user"><a href="#myday" class="nav-link" data-page="myday"><i class="fas fa-clipboard-list"></i> <span class="nav-text">My Day</span></a></li><li><a href="#customers" class="nav-link" data-page="customers"><i class="fas fa-users"></i> <span class="nav-text">Customers</span></a></li><li><a href="#visits" class="nav-link" data-page="visits"><i class="fas fa-calendar-alt"></i> <span class="nav-text">Visits & Follow-ups</span></a></li><li><a href="#payments" class="nav-link" data-page="payments"><i class="fas fa-credit-card"></i> <span class="nav-text">Payments</span></a></li><li data-role="admin"><a href="#analytics" class="nav-link" data-page="analytics"><i class="fas fa-chart-line"></i> <span class="nav-text">Analytics</span></a></li><li data-role="admin"><a href="#reports" class="nav-link" data-page="reports"><i class="fas fa-file-alt"></i> <span class="nav-text">Reports</span></a></li></ul><div data-role="admin"><div class="sidebar-heading">Administration</div><ul style="list-style:none;"><li><a href="#performance" class="nav-link" data-page="performance"><i class="fas fa-tachometer-alt"></i> <span class="nav-text">Performance</span></a></li><li><a href="#consultants" class="nav-link" data-page="consultants"><i class="fas fa-user-tie"></i> <span class="nav-text">Consultants</span></a></li><li><a href="#users" class="nav-link" data-page="users"><i class="fas fa-users-cog"></i> <span class="nav-text">User Management</span></a></li><li><a href="#changelog" class="nav-link" data-page="changelog"><i class="fas fa-history"></i> <span class="nav-text">Change Log</span></a></li><li><a href="#settings" class="nav-link" data-page="settings"><i class="fas fa-cog"></i> <span class="nav-text">Settings</span></a></li></ul></div></nav></aside><header class="main-header"><button class="hamburger" id="hamburger-menu"><i class="fas fa-bars"></i></button><div id="page-title" style="font-weight: 600; font-size: var(--fs-lg);">Dashboard</div><div class="d-flex gap-4 align-items-center"><div id="notification-bell-wrapper" data-role="admin" style="position: relative;"><button id="notification-bell-btn" class="btn btn-outline" style="min-width:auto; padding: 0.5rem; border-radius: 50%; width: 44px; height: 44px;"><i class="fas fa-bell"></i></button><span id="notification-badge" class="hidden" style="position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: var(--fs-sm); display: flex; justify-content: center; align-items: center; font-weight: 600; border: 2px solid var(--card-bg);">0</span></div><button id="theme-toggle-btn" class="btn btn-outline" style="min-width:auto; padding: 0.5rem; border-radius: 50%; width: 44px; height: 44px;"><i class="fas fa-moon"></i></button><div class="d-flex gap-2 align-items-center"><span id="username-display" style="font-weight: 500;"></span><button id="logout-btn" class="btn btn-outline" style="min-width:auto; padding: 0.5rem;"><i class="fas fa-sign-out-alt"></i></button></div></div></header><main class="main-content"><section id="dashboard-page" class="page active"></section><section id="myday-page" class="page" data-role="user"></section><section id="customers-page" class="page"></section><section id="visits-page" class="page"></section><section id="payments-page" class="page"></section><section id="analytics-page" class="page" data-role="admin"></section><section id="reports-page" class="page" data-role="admin"></section><section id="performance-page" class="page" data-role="admin"></section><section id="consultants-page" class="page" data-role="admin"></section><section id="users-page" class="page" data-role="admin"></section><section id="changelog-page" class="page" data-role="admin"></section><section id="settings-page" class="page" data-role="admin"></section></main>`; 
        document.getElementById('customers-page').innerHTML = `<div class="kpi-card-grid" data-role="admin"><div class="kpi-card"><div class="title">Total Customers</div><div id="customer-kpi-total" class="value">0</div></div><div class="kpi-card"><div class="title">Total Outstanding</div><div id="customer-kpi-outstanding" class="value">0</div></div><div class="kpi-card"><div class="title">Active Accounts</div><div id="customer-kpi-active" class="value">0</div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><h3 class="card-title">Manage Customers</h3><div class="d-flex gap-2 flex-wrap align-items-center"><div class="input-with-icon"><input type="search" id="customer-search" placeholder="Search customers..." class="form-control" style="width: auto;"><i class="fas fa-times-circle icon clear-icon" title="Clear search"></i></div><div class="input-with-icon"><input type="search" id="customer-tag-filter" placeholder="Filter by tag..." class="form-control" style="width: auto;"><i class="fas fa-times-circle icon clear-icon" title="Clear tag filter"></i></div><select id="customer-account-status-filter" class="form-control" style="width: auto;"><option value="all">All Account Status</option><option>Active</option><option>Inactive</option></select><select id="customer-status-filter" class="form-control" style="width: auto;"><option value="all">All Statuses</option><option>Collectors</option><option>Sales (Above 3 Months)</option><option>Sales (Above 360 Days)</option></select><div style="position: relative;"><button class="btn btn-outline" id="toggle-columns-btn"><i class="fas fa-columns"></i> Columns</button><div id="column-toggle-dropdown" class="column-toggle-dropdown"></div></div><div data-role="admin" class="d-flex gap-2"><button class="btn btn-outline" id="export-customers-csv"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" id="export-customers-pdf"><i class="fas fa-file-pdf"></i> PDF</button><button class="btn btn-outline" id="import-customer-btn"><i class="fas fa-upload"></i> Import</button><button class="btn btn-primary" id="add-customer-btn"><i class="fas fa-plus"></i> Add Customer</button><button class="btn btn-warning" id="bulk-update-btn"><i class="fas fa-edit"></i> Bulk Update</button></div></div></div><div class="table-container"><table class="data-table"><thead></thead><tbody id="customer-table-body"></tbody></table></div><div id="customers-pagination" class="pagination-controls"></div></div>`; 
        document.getElementById('users-page').innerHTML = `<div class="page-header"><h2 >User Management</h2><p >Home > Users</p></div><div class="card"><div class="card-header"><h3 class="card-title">User List</h3><button id="add-user-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add User</button></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="username">Username</th><th data-sort="fullName">Full Name</th><th data-sort="role">Role</th><th data-sort="assignedConsultantId">Assigned Consultant</th><th data-sort="department">Department</th><th data-sort="lastLogin">Last Login</th><th>Actions</th></tr></thead><tbody id="user-table-body"></tbody></table></div><div id="users-pagination" class="pagination-controls"></div></div>`; 
        document.getElementById('user-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 id="user-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('user-modal')">&times;</button></div><form id="user-form"><input type="hidden" id="user-id-hidden"><div class="form-grid"><div class="form-group"><label for="username">Username*</label><input type="text" id="username" class="form-control" required></div><div class="form-group"><label for="fullName">Full Name*</label><input type="text" id="fullName" class="form-control" required></div></div><div class="form-group"><label for="password">Password*</label><input type="password" id="password" class="form-control" required></div><div class="form-group"><label for="department">Department</label><input type="text" id="department" class="form-control" placeholder="e.g., Collections"></div><div class="form-group"><label for="role">Role</label><select id="role" class="form-control"><option value="user">User</option><option value="admin">Admin</option></select></div><div class="form-group" id="assigned-consultant-group"><label for="assignedConsultantId">Assigned Sales Consultant</label><select id="assignedConsultantId" class="form-control"></select></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('user-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save User</button></div></form></div>`;
        
		document.getElementById('dashboard-page').innerHTML = `
    <div id="admin-dashboard-wrapper" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <h2 class="page-header" style="margin-bottom: 0;">Admin Dashboard</h2>
            <div class="d-flex gap-2 align-items-center">
                <label for="dashboard-month-select" style="margin-bottom:0;">Data for:</label>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-2);">
                    <select id="dashboard-month-select" class="form-control" style="width: auto;"></select>
                    <select id="dashboard-year-select" class="form-control" style="width: auto;"></select>
                </div>
            </div>
            <div id="consultant-dashboard-header" class="hidden"></div>
            <button id="toggle-dashboard-view-btn" class="btn btn-outline"><i class="fas fa-chart-bar"></i> Switch to Chart View</button>
        </div>
        <div id="admin-dashboard-content"></div>
    </div>
    <div id="chart-dashboard-wrapper">
        <div id="attendance-controls" class="mb-4"></div>
        <div id="todays-agenda" class="mb-4"></div>
        <div id="priority-actions" class="mb-4"></div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-6);">
            <div class="card"><div class="card-title">Total Customers</div><div id="stat-total-customers" class="value">0</div></div>
            <div class="card"><div class="card-title">Total Outstanding</div><div id="stat-outstanding-debt" class="value">0</div></div>
            <div class="card" id="user-dashboard-forecast-card"><div class="card-title">Total Forecast</div><div id="stat-total-forecast" class="value">0</div></div>
            <div class="card"><div class="card-title">Recovered This Month</div><div id="stat-recovered-this-month" class="value">0</div></div>
            
            <!-- FIXED: UPCOMING VISITS TILE IS NOW CLICKABLE -->
            <div class="card" id="upcoming-visits-tile" style="cursor: pointer; transition: all 0.2s ease;">
                <div class="card-title">Upcoming Visits</div>
                <div id="stat-upcoming-visits" class="value">0</div>
                <div style="font-size: var(--fs-sm); color: var(--primary); margin-top: 8px; font-weight: 600;">
                    View List <i class="fas fa-chevron-right" style="font-size: 0.7rem;"></i>
                </div>
            </div>
        </div>
        <div id="recovery-progress-card" class="card mb-4"></div>
        <div id="dashboard-bottom-content"></div>
    </div>`;
		
        document.getElementById('myday-page').innerHTML = `<div class="page-header"><h2 id="myday-title">My Day</h2><p id="myday-date"></p></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);"><div class="card"><div class="card-header"><h3 class="card-title"><i class="fas fa-tasks" style="margin-right: 8px;"></i>Today's Visits</h3></div><div id="myday-visits-list"></div></div><div class="card"><div class="card-header"><h3 class="card-title"><i class="fas fa-map-route" style="margin-right: 8px;"></i>Today's Map Route</h3></div><div id="myday-map-view" style="height: 400px; border-radius: 8px;"></div></div><div class="card"><div class="card-header"><h3 class="card-title"><i class="fas fa-hand-holding-usd" style="margin-right: 8px;"></i>Follow-ups Due Today</h3></div><div id="myday-promises-list"></div></div><div class="card" style="border-color: var(--danger);"><div class="card-header"><h3 class="card-title" style="color: var(--danger);"><i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>Overdue Tasks</h3></div><div id="myday-overdue-list"></div></div></div>`;
        document.getElementById('visits-page').innerHTML = `<div class="kpi-card-grid"><div class="kpi-card"><div class="title">Upcoming Visits</div><div id="visit-kpi-upcoming" class="value">0</div></div><div class="kpi-card"><div class="title">Overdue Visits</div><div id="visit-kpi-overdue" class="value">0</div></div><div class="kpi-card"><div class="title">Completed Today</div><div id="visit-kpi-completed-today" class="value">0</div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><div class="d-flex gap-2"><button class="btn btn-outline visit-view-tab active" data-view="list"><i class="fas fa-list"></i> List View</button><button class="btn btn-outline visit-view-tab" data-view="calendar"><i class="fas fa-calendar"></i> Calendar View</button><button class="btn btn-outline visit-view-tab" data-view="map"><i class="fas fa-map-marked-alt"></i> Map View</button></div><div id="visits-header-actions" class="d-flex gap-2"></div></div><div id="list-view-controls" class="d-flex justify-content-between align-items-center my-4 flex-wrap gap-4"><div class="d-flex gap-2 flex-wrap"><div class="d-flex gap-2" data-role="admin"><div class="input-with-icon"><input type="search" id="visit-search" placeholder="Search customer or purpose..." class="form-control" style="width: auto;"><i class="fas fa-times-circle icon clear-icon"></i></div><select id="visit-consultant-filter" class="form-control" style="width: auto;"><option value="all">All Consultants</option></select></div><button class="btn filter-btn visit-filter-btn active" data-filter="Upcoming">Upcoming</button><button class="btn filter-btn visit-filter-btn" data-filter="Today">Today</button><button class="btn filter-btn visit-filter-btn" data-filter="Overdue">Overdue</button><button class="btn filter-btn visit-filter-btn" data-filter="All">All Visits</button></div><div class="d-flex gap-2 align-items-center flex-wrap"><input type="date" id="visit-start-date" class="form-control" style="width:auto;"><div class="d-flex gap-1"><button class="btn btn-outline" id="set-visit-date-today">Today</button><button class="btn btn-outline" id="set-visit-date-tomorrow">Tomorrow</button></div><span>to</span><input type="date" id="visit-end-date" class="form-control" style="width:auto;"><button class="btn btn-primary" id="visit-date-apply">Apply</button></div></div><div id="map-view-controls" class="hidden d-flex justify-content-between align-items-center my-4 flex-wrap gap-4"><div class="d-flex gap-2 flex-wrap align-items-center"><div data-role="admin" class="form-group mb-0"><label for="map-consultant-filter">Consultant</label><select id="map-consultant-filter" class="form-control"></select></div><div class="form-group mb-0"><label for="map-date-filter">Date</label><input type="date" id="map-date-filter" class="form-control"></div></div><button id="clear-route-btn" class="btn btn-outline hidden"><i class="fas fa-times"></i> Clear Route</button></div><div id="list-view-content" class="visit-view-content"><div class="table-container"><table class="data-table"><thead></thead><tbody id="visit-table-body"></tbody></table></div><div id="visits-pagination" class="pagination-controls"></div></div><div id="calendar-view-content" class="visit-view-content hidden"><div id="calendar-view" style="min-height: 600px;"></div></div><div id="map-view-content" class="visit-view-content hidden"><div id="map-view" style="height: 600px; border-radius: 8px;"></div></div></div>`; 
        document.getElementById('payments-page').innerHTML = `<div class="kpi-card-grid"><div class="kpi-card"><div class="title">Recovered This Month</div><div id="payment-kpi-recovered-month" class="value">0</div></div><div class="kpi-card"><div class="title">Total Payments Recorded</div><div id="payment-kpi-total-count" class="value">0</div></div><div class="kpi-card"><div class="title">Pending Payments</div><div id="payment-kpi-pending" class="value">0</div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><h3 class="card-title">Recent Payments</h3><div class="d-flex gap-2"><div class="input-with-icon"><input type="search" id="payment-search" placeholder="Search customer..." class="form-control" style="width: auto;"><i class="fas fa-times-circle icon clear-icon"></i></div><select id="payment-status-filter" class="form-control" style="width: auto;"><option value="all">All Status</option><option>Completed</option><option>Pending</option><option>Failed</option></select><select id="payment-method-filter" class="form-control" style="width: auto;"><option value="all">All Methods</option><option>Bank Transfer</option><option>Cheque</option><option>Cash</option></select></div><div class="d-flex gap-2"><div data-role="admin" class="d-flex gap-2"><button class="btn btn-outline" id="export-payments-csv"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" id="export-payments-pdf"><i class="fas fa-file-pdf"></i> PDF</button></div><button class="btn btn-success" id="record-payment-btn"><i class="fas fa-plus"></i> Record Payment</button></div></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="date">Date</th><th data-sort="customerId">Customer</th><th data-sort="consultantId">Consultant</th><th data-sort="amount">Amount</th><th data-sort="method">Method</th><th data-sort="status">Status</th><th>Actions</th></tr></thead><tbody id="payment-table-body"></tbody></table></div><div id="payments-pagination" class="pagination-controls"></div></div>`; 
        document.getElementById('analytics-page').innerHTML = `<div class="page-header"><h2>Analytics Dashboard</h2><p>Visual insights into recovery performance and activities.</p></div><div id="analytics-kpi-grid" class="kpi-card-grid"></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);"><div class="card"><div class="card-header"><h3 class="card-title">Recovery Performance by Consultant</h3></div><div class="chart-container"><canvas id="recovery-by-consultant-chart"></canvas></div></div><div class="card"><div class="card-header"><h3 class="card-title">Outstanding Debt by Emirate</h3></div><div class="chart-container"><canvas id="recovery-by-emirate-chart"></canvas></div></div><div class="card"><div class="card-header"><h3 class="card-title">Payment Methods</h3></div><div class="chart-container" style="height: 300px; max-width: 300px; margin: auto;"><canvas id="payment-methods-chart"></canvas></div></div><div class="card"><div class="card-header"><h3 class="card-title">Visit Outcome Analysis</h3></div><div class="chart-container" style="height: 300px; max-width: 300px; margin: auto;"><canvas id="visit-outcome-chart"></canvas></div></div></div>`;
        
        // UPDATED REPORTS PAGE HTML STRUCTURE
        document.getElementById('reports-page').innerHTML = `
    <!-- 1. Custom Report Builder (Full Width) -->
    <div class="card mb-4">
        <div class="card-header"><h3 class="card-title"><i class="fas fa-magic"></i> Custom Report Generator</h3></div>
        <p class="text-secondary" style="margin-bottom: var(--spacing-4);">Build your own report by selecting data sources, columns, and filters.</p>
        
        <div id="custom-report-builder">
            <!-- Step 1: Select Data Source -->
            <h4 style="font-size: var(--fs-base); font-weight: 600; margin-bottom: var(--spacing-2);">1. Select Data Source</h4>
            <div class="form-group">
                <div id="data-source-selector" class="d-flex gap-2 flex-wrap">
                     <label class="btn btn-outline filter-btn active" style="box-shadow: none;">
                        <input type="radio" name="dataSource" value="customers" class="hidden" checked> <i class="fas fa-users"></i> Customers
                    </label>
                    <label class="btn btn-outline filter-btn" style="box-shadow: none;">
                        <input type="radio" name="dataSource" value="payments" class="hidden"> <i class="fas fa-credit-card"></i> Payments
                    </label>
                    <label class="btn btn-outline filter-btn" style="box-shadow: none;">
                        <input type="radio" name="dataSource" value="visits" class="hidden"> <i class="fas fa-calendar-check"></i> Visits
                    </label>
                </div>
            </div>

            <!-- Step 2: Select Columns -->
            <h4 style="font-size: var(--fs-base); font-weight: 600; margin-bottom: var(--spacing-2); margin-top: var(--spacing-4);">2. Choose Columns</h4>
            <div id="column-selector" class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); background: var(--bg-color); padding: var(--spacing-4); border-radius: 8px;">
                <!-- Column checkboxes inserted via JS -->
            </div>

            <!-- Step 3: Filters -->
            <h4 style="font-size: var(--fs-base); font-weight: 600; margin-bottom: var(--spacing-2); margin-top: var(--spacing-4);">3. Apply Filters</h4>
            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="form-group">
                    <label for="custom-report-consultant-filter">Sales Consultant</label>
                    <select id="custom-report-consultant-filter" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label for="custom-report-start-date">Date From</label>
                    <input type="date" id="custom-report-start-date" class="form-control">
                </div>
                <div class="form-group">
                    <label for="custom-report-end-date">Date To</label>
                    <input type="date" id="custom-report-end-date" class="form-control">
                </div>
            </div>
            
            <!-- Dynamic Filters -->
            <div class="d-flex justify-content-between align-items-center mt-2">
                <label style="font-weight: 500;">Advanced Filters</label>
                <button class="btn btn-outline btn-sm" id="add-dynamic-filter-btn"><i class="fas fa-plus"></i> Add Condition</button>
            </div>
            <div id="dynamic-filter-container" class="mt-2"></div>
            
            <div id="custom-report-preview" class="card mt-4 p-4" style="background: var(--bg-color); box-shadow: none; border: 1px dashed var(--border-color);">
                <h5 class="card-title" style="font-size: var(--fs-sm);">Live Preview (First 5 Rows)</h5>
                <div class="table-container">
                    <table class="data-table report-table-small" id="custom-report-preview-table"><thead></thead><tbody></tbody></table>
                </div>
            </div>

            <button id="generate-custom-report-btn" class="btn btn-primary mt-4" style="width: 100%;"><i class="fas fa-file-export"></i> Generate Custom Report</button>
        </div>
    </div>

    <!-- 2. Performance Reports Section -->
    <div class="report-section-header"><i class="fas fa-tachometer-alt"></i> Performance & Targets</div>
    <div class="report-category-grid">
         <!-- Comprehensive Performance -->
         <div class="card">
            <div class="card-header"><h3 class="card-title">Comprehensive Performance</h3></div>
             <p class="text-secondary mb-4">Overview of all key consultant KPIs (Target vs Actual, Visits, etc).</p>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Consultant (Optional)</label>
                    <select id="report-comprehensive-consultant-select" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>Month</label>
                    <div class="d-flex gap-2">
                        <select id="report-comprehensive-month-select" class="form-control"></select>
                        <select id="report-comprehensive-year-select" class="form-control"></select>
                    </div>
                </div>
            </div>
            <button id="generate-comprehensive-perf-btn" class="btn btn-primary"><i class="fas fa-chart-bar"></i> Generate Report</button>
        </div>

        <!-- Target Performance -->
         <div class="card">
            <div class="card-header"><h3 class="card-title">Target vs. Actual</h3></div>
             <p class="text-secondary mb-4">Analyze monthly target vs. actual collections.</p>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Consultant</label>
                    <select id="report-target-consultant-select" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>Month</label>
                    <div class="d-flex gap-2">
                        <select id="report-target-month-select" class="form-control"></select>
                        <select id="report-target-year-select" class="form-control"></select>
                    </div>
                </div>
            </div>
            <button id="generate-target-perf-btn" class="btn btn-primary"><i class="fas fa-bullseye"></i> Generate Report</button>
        </div>

        <!-- Forecast Performance -->
         <div class="card">
            <div class="card-header"><h3 class="card-title">Forecast vs. Actual</h3></div>
             <p class="text-secondary mb-4">Analyze monthly forecast vs. actual collections.</p>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Consultant</label>
                    <select id="report-forecast-consultant-select" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>Month</label>
                    <div class="d-flex gap-2">
                        <select id="report-forecast-month-select" class="form-control"></select>
                        <select id="report-forecast-year-select" class="form-control"></select>
                    </div>
                </div>
            </div>
            <button id="generate-forecast-perf-btn" class="btn btn-primary"><i class="fas fa-chart-line"></i> Generate Report</button>
        </div>
        
        <!-- Status Target Performance -->
        <div class="card">
            <div class="card-header"><h3 class="card-title">Status Target Performance</h3></div>
            <p class="text-secondary mb-4">Analyze performance against targets for specific statuses (Collectors, Sales).</p>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Consultant</label>
                    <select id="report-status-target-consultant-select" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label>Month</label>
                    <div class="d-flex gap-2">
                        <select id="report-status-target-month-select" class="form-control"></select>
                        <select id="report-status-target-year-select" class="form-control"></select>
                    </div>
                </div>
            </div>
            <button id="generate-status-target-perf-btn" class="btn btn-primary"><i class="fas fa-tasks"></i> Generate Report</button>
        </div>
    </div>

    <!-- 3. Financial & Aging Section -->
    <div class="report-section-header"><i class="fas fa-coins"></i> Financial & Aging</div>
    <div class="report-category-grid">
        <!-- Aging Collection -->
        <div class="card">
            <div class="card-header"><h3 class="card-title">Collection by Aging</h3></div>
            <p class="text-secondary mb-4">Analyze collected amounts against aging buckets.</p>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Consultant (Optional)</label>
                    <select id="report-aging-collection-consultant-select" class="form-control"></select>
                </div>
                <div class="d-flex gap-2">
                    <div class="form-group flex-grow-1">
                        <label>Start</label>
                        <input type="date" id="report-aging-collection-start-date" class="form-control">
                    </div>
                    <div class="form-group flex-grow-1">
                        <label>End</label>
                        <input type="date" id="report-aging-collection-end-date" class="form-control">
                    </div>
                </div>
            </div>
            <button id="generate-aging-collection-report-btn" class="btn btn-primary"><i class="fas fa-hourglass-half"></i> Generate Report</button>
        </div>

        <!-- Detailed Aging -->
        <div class="card">
            <div class="card-header"><h3 class="card-title">Detailed Aging Breakdown</h3></div>
            <p class="text-secondary mb-4">Deep dive into collections vs aging debt per customer.</p>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                 <div class="d-flex gap-2">
                    <div class="form-group flex-grow-1">
                        <label>Start</label>
                        <input type="date" id="report-aging-start-date" class="form-control">
                    </div>
                    <div class="form-group flex-grow-1">
                        <label>End</label>
                        <input type="date" id="report-aging-end-date" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Consultant</label>
                    <select id="report-aging-consultant-select" class="form-control"></select>
                </div>
                 <div class="form-group">
                    <label>Customer (Optional)</label>
                    <div id="report-aging-customer-select-container"></div>
                </div>
            </div>
            <button id="generate-detailed-aging-report-btn" class="btn btn-primary"><i class="fas fa-list-ol"></i> Generate Report</button>
        </div>

        <!-- Collection Details -->
        <div class="card">
            <div class="card-header"><h3 class="card-title">Collection Transaction Log</h3></div>
            <p class="text-secondary mb-4">Detailed list of all collections within date range.</p>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="d-flex gap-2">
                    <div class="form-group flex-grow-1">
                        <label>Start</label>
                        <input type="date" id="report-collection-start-date" class="form-control">
                    </div>
                    <div class="form-group flex-grow-1">
                        <label>End</label>
                        <input type="date" id="report-collection-end-date" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="report-collection-method-filter" class="form-control">
                        <option value="all">All Methods</option>
                        <option>Bank Transfer</option>
                        <option>Cheque</option>
                        <option>Cash</option>
                    </select>
                </div>
            </div>
            <button id="generate-collection-report-btn" class="btn btn-primary"><i class="fas fa-money-bill-wave"></i> Generate Report</button>
        </div>
    </div>

    <!-- 4. Operational & Risk Section -->
    <div class="report-section-header"><i class="fas fa-clipboard-list"></i> Operations & Risk</div>
    <div class="report-category-grid">
         <!-- Consultant Visits -->
         <div class="card">
            <div class="card-header"><h3 class="card-title">Consultant Visits</h3></div>
            <p class="text-secondary mb-4">Detailed visit history and performance stats.</p>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label>Consultant</label>
                    <select id="report-visits-consultant-select" class="form-control"></select>
                </div>
                <div class="d-flex gap-2">
                    <div class="form-group flex-grow-1">
                        <label>Start</label>
                        <input type="date" id="report-visits-start-date" class="form-control">
                    </div>
                    <div class="form-group flex-grow-1">
                        <label>End</label>
                        <input type="date" id="report-visits-end-date" class="form-control">
                    </div>
                </div>
            </div>
            <button id="generate-consultant-visits-btn-new" class="btn btn-primary"><i class="fas fa-route"></i> Generate Report</button>
        </div>

        <!-- Risk Report -->
        <div class="card" style="border-left: 4px solid var(--danger);">
            <div class="card-header"><h3 class="card-title text-danger">Risk & Exception Report</h3></div>
             <p class="text-secondary mb-4">Identify high-risk customers based on criteria.</p>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div class="d-flex gap-2">
                    <div class="form-group flex-grow-1">
                        <label>Min Outstanding</label>
                        <input type="number" id="report-risk-min-balance" class="form-control" value="10000">
                    </div>
                    <div class="form-group flex-grow-1">
                        <label>Days Since Visit</label>
                        <input type="number" id="report-risk-days-since-visit" class="form-control" value="30">
                    </div>
                </div>
                <div class="form-group">
                    <label>Missed Promise</label>
                    <select id="report-risk-missed-promise" class="form-control">
                        <option value="false">Include All</option>
                        <option value="true">Only with Missed Promise</option>
                    </select>
                </div>
            </div>
            <button id="generate-risk-report-btn" class="btn btn-danger"><i class="fas fa-exclamation-triangle"></i> Generate Risk Report</button>
        </div>
        
        <!-- Visit Outcome -->
        <div class="card">
            <div class="card-header"><h3 class="card-title">Visit Outcome Analysis</h3></div>
            <p class="text-secondary mb-4">Analyzes the results of all completed visits in a chart.</p>
            <div class="form-group">
                <p style="font-size: var(--fs-sm); color: var(--text-secondary);">Generates a Pie Chart visualization of outcomes (Paid, Promise to Pay, No Answer, etc).</p>
            </div>
            <button id="generate-outcome-analysis-btn" class="btn btn-primary"><i class="fas fa-chart-pie"></i> Generate Analysis</button>
        </div>
    </div>

    <!-- 5. Daily Activity & Standard Exports -->
    <div class="report-section-header"><i class="fas fa-print"></i> Daily Activity & Standard Exports</div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: var(--spacing-6);">
        <!-- Consultant Daily Activity -->
        <div class="card" data-role="admin">
            <div class="card-header"><h3 class="card-title">Consultant Daily Activity</h3></div>
            <div class="d-flex flex-column gap-3">
                <div class="d-flex gap-2 flex-wrap align-items-end">
                    <div class="form-group mb-0 flex-grow-1">
                        <label>Consultant</label>
                        <select id="report-consultant-select" class="form-control"></select>
                    </div>
                    <div class="form-group mb-0">
                        <label>Date Range</label>
                        <div class="d-flex gap-2 align-items-center">
                            <input type="date" id="report-activity-start-date" class="form-control">
                            <span>to</span>
                            <input type="date" id="report-activity-end-date" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Customer Filter (Optional)</label>
                    <div id="report-activity-customer-filter-container"></div>
                </div>
                <div class="d-flex gap-2 justify-content-between align-items-center">
                    <div class="d-flex gap-2">
                        <button id="activity-report-summary-btn" class="btn btn-outline filter-btn active"><i class="fas fa-chart-pie"></i> Summary</button>
                        <button id="activity-report-table-btn" class="btn btn-outline filter-btn"><i class="fas fa-table"></i> Table</button>
                    </div>
                    <button id="generate-activity-report-btn" class="btn btn-primary"><i class="fas fa-play"></i> Generate</button>
                </div>
            </div>
        </div>

        <!-- Quick Standard Reports -->
        <div class="card">
            <div class="card-header"><h3 class="card-title">Standard List Exports</h3></div>
            <div class="form-group mb-4">
                <label>Date Range (Optional for some reports)</label>
                <div class="d-flex gap-2">
                    <input type="date" id="report-standard-start-date" class="form-control">
                    <input type="date" id="report-standard-end-date" class="form-control">
                </div>
            </div>
            <div class="standard-reports-buttons">
                <button id="generate-customer-report-btn" class="btn btn-primary">
                    <i class="fas fa-users"></i>
                    <span>Customer List</span>
                </button>
                <button id="generate-consultant-report-btn" class="btn btn-primary">
                    <i class="fas fa-user-tie"></i>
                    <span>Consultants</span>
                </button>
                <button id="generate-aging-report-btn" class="btn btn-info">
                    <i class="fas fa-history"></i>
                    <span>Aging List</span>
                </button>
                <button id="generate-customer-status-report-btn" class="btn btn-info">
                    <i class="fas fa-user-check"></i>
                    <span>Status Report</span>
                </button>
                <button id="generate-recovery-report-btn" class="btn btn-success">
                    <i class="fas fa-percentage"></i>
                    <span>Recovery Perf.</span>
                </button>
            </div>
        </div>
    </div>
    
    <div id="report-output" class="mt-4"></div>`; 
        document.getElementById('performance-page').innerHTML = `<div class="page-header"><h2>Performance Snapshot</h2><p>An at-a-glance overview of consultant performance for the current month.</p></div><div id="performance-grid-container" class="performance-grid"></div>`;
        document.getElementById('consultants-page').innerHTML = `<div class="page-header"><h2 >Sales Consultant Management</h2><p >Home > Consultants</p></div><div class="card"><div class="card-header"><h3 class="card-title">Consultant List</h3><button id="add-consultant-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Consultant</button></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="name">Consultant Name</th><th data-sort="noOfCustomers">No. of Customers</th><th data-sort="totalOutstanding">Total Outstanding</th><th data-sort="totalForecast">Total Forecast</th><th data-sort="currentTarget">Current Month Target</th><th data-sort="overdueCustomers">Overdue Customers</th><th data-sort="upcomingVisits">Upcoming Visits</th><th>Actions</th></tr></thead><tbody id="consultant-table-body"></tbody></table></div><div id="consultants-pagination" class="pagination-controls"></div></div>`; 
        document.getElementById('changelog-page').innerHTML = `<div class="page-header"><h2>Change Log</h2><p>Tracks all data modifications in the system.</p></div><div class="card"><div class="card-header"><h3 class="card-title">Log Entries</h3><div class="d-flex gap-2 align-items-center flex-wrap"><div class="input-with-icon"><input type="search" id="changelog-search" placeholder="Search log..." class="form-control" style="width: auto;"><i class="fas fa-times-circle icon clear-icon"></i></div><select id="changelog-entity-filter" class="form-control" style="width:auto;"><option value="all">All Entities</option><option value="Customer">Customer</option><option value="Payment">Payment</option><option value="Visit">Visit</option><option value="Consultant">Consultant</option><option value="User">User</option></select><select id="changelog-action-filter" class="form-control" style="width:auto;"><option value="all">All Actions</option><option value="Created">Created</option><option value="Updated">Updated</option><option value="Deleted">Deleted</option></select></div></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="timestamp">Timestamp</th><th data-sort="user">User</th><th data-sort="action">Action</th><th data-sort="entityName">Entity</th><th>Change Details</th><th>Actions</th></tr></thead><tbody id="changelog-table-body"></tbody></table></div><div id="changelog-pagination" class="pagination-controls"></div></div>`; 
        document.getElementById('settings-page').innerHTML = `
            <div class="page-header"><h2>System Settings</h2><p>Manage application-wide configurations and data.</p></div>
            
            <div class="card">
                <div class="card-header"><h3 class="card-title">Backup & Restore</h3></div>
                <p class="text-secondary mb-4">Save all your application data to a file or restore it from a backup.</p>
                <div class="d-flex align-items-center gap-4 mb-4">
                    <div class="form-group mb-0">
                        <label class="d-flex align-items-center gap-2"><input type="radio" name="backup-format" value="json" checked> JSON (Full Backup)</label>
                        <label class="d-flex align-items-center gap-2"><input type="radio" name="backup-format" value="csv"> CSV (Data Tables)</label>
                    </div>
                    <button id="backup-data-btn" class="btn btn-primary"><i class="fas fa-download"></i> Backup Data</button>
                </div>
                <hr style="margin: var(--spacing-4) 0; border-color: var(--border-color);">
                <h4>Restore from Backup</h4>
                <div class="info-box" style="background: rgba(255, 193, 7, 0.1); border-color: var(--warning);">
                    <p><strong>Warning:</strong> Restoring will <strong style="color: var(--danger);">completely overwrite</strong> all current data.</p>
                </div>
                <div class="form-group">
                    <label for="restore-file-input">Select Backup File (.json, .csv)</label>
                    <input type="file" id="restore-file-input" class="form-control" accept=".json,.csv">
                </div>
                <button id="restore-data-btn" class="btn btn-warning" disabled><i class="fas fa-upload"></i> Restore Data</button>
            </div>

            <div class="card mt-4">
                <div class="card-header"><h3 class="card-title">Offline Capability</h3></div>
                <p class="text-secondary mb-4">Enable offline access for map tiles. (Requires initial download)</p>
                <button id="enable-offline-mode-btn" class="btn btn-primary"><i class="fas fa-wifi"></i> Enable Offline Maps</button>
            </div>

            <div class="card mt-4" style="border-left: 4px solid var(--success);">
                <div class="card-header"><h3 class="card-title">Developer Tools</h3></div>
                <p class="text-secondary mb-4">Instantly populate the app with realistic test data. <strong style="color:var(--danger)">Warning: This wipes existing data.</strong></p>
                <button id="generate-demo-data-btn" class="btn btn-success"><i class="fas fa-magic"></i> Generate 50+ Test Records</button>
            </div>
            `;
        document.getElementById('customer-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="customer-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-modal')"></button></div><form id="customer-form"><input type="hidden" id="customer-id-hidden"><div class="form-grid"><div class="form-group" data-admin-only="true"><label for="accountNo">Account Number*</label><input type="text" id="accountNo" class="form-control"></div><div class="form-group" data-admin-only="true"><label for="companyName">Company Name*</label><input type="text" id="companyName" class="form-control" required></div><div class="form-group" data-admin-only="true"><label for="email">Contact Email</label><input type="email" id="email" class="form-control"></div><div class="form-group" data-admin-only="true"><label for="mobile">Contact Mobile</label><input type="tel" id="mobile" class="form-control"></div><div class="form-group" data-admin-only="true"><label for="debtSince">Debt Since</label><input type="date" id="debtSince" class="form-control"></div><div class="form-group" data-admin-only="true"><label for="emirate">Emirate*</label><select id="emirate" class="form-control" required><option>Dubai</option><option>Abu Dhabi</option><option>Sharjah</option><option>Ajman</option></select></div><div class="form-group" data-admin-only="true"><label for="area">Area*</label><input type="text" id="area" class="form-control" required></div>
        
        <div class="form-group" data-admin-only="true"><label for="latitude">Latitude (e.g., 25.2048)</label><input type="number" step="any" id="latitude" class="form-control" placeholder="Optional"></div>
        <div class="form-group" data-admin-only="true"><label for="longitude">Longitude (e.g., 55.2708)</label><input type="number" step="any" id="longitude" class="form-control" placeholder="Optional"></div>
        <div class="form-group" data-admin-only="true"><label for="status">Account Status</label><select id="status" class="form-control"><option>Active</option><option>Inactive</option></select></div><div class="form-group"><label for="paymentStatus">Payment Status</label><select id="paymentStatus" class="form-control"><option>Negotiation</option><option>Settlement</option><option>Legal</option><option>Write-Off</option></select></div><div class="form-group" data-admin-only="true"><label for="initialDebt">Initial Debt (AED)*</label><input type="number" id="initialDebt" class="form-control" required></div><div class="form-group" data-admin-only="true"><label for="salesConsultantId">Sales Consultant*</label><select id="salesConsultantId" class="form-control" required></select></div><div class="form-group"><label for="customerStatus">Customer Status</label><select id="customerStatus" class="form-control"><option>Collectors</option><option>Sales (Above 3 Months)</option><option>Sales (Above 360 Days)</option></select></div><div class="form-group"><label for="agingCategory">Aging Category</label><select id="agingCategory" class="form-control" disabled><option>Auto-Calculated</option></select></div><div class="form-group" data-admin-only="true"><label for="balance_2020_2025">Balance 2020-2025 (AED)</label><input type="number" step="any" id="balance_2020_2025" class="form-control balance-detail"></div><div class="form-group" data-admin-only="true"><label for="balance_2019_2020">Balance 2019-2020 (AED)</label><input type="number" step="any" id="balance_2019_2020" class="form-control balance-detail"></div><div class="form-group" data-admin-only="true"><label for="balance_lte_2018">Balance <=2018 (AED)</label><input type="number" step="any" id="balance_lte_2018" class="form-control balance-detail"></div><div class="form-group" data-admin-only="true"><label for="outstanding">Total Outstanding Balance (AED)*</label><input type="number" id="outstanding" class="form-control" required readonly style="background-color: var(--border-color);"></div></div><div class="form-group full-width"><label for="customer-tags">Tags</label><input type="text" id="customer-tags" class="form-control" placeholder="e.g. High-Risk, VIP, Disputed"></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('customer-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save Customer</button></div></form></div>`;
		
        document.getElementById('payment-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3>Record a Payment</h3><button class="btn btn-outline" onclick="App.UI.closeModal('payment-modal')">&times;</button></div><form id="payment-form"><div class="form-group"><label for="payment-customer-id">Customer*</label><div id="payment-customer-select-container"></div></div><div id="payment-details-grid" class="form-grid"><div class="form-group"><label for="payment-amount-2025">For 2020-2025</label><input type="number" step="any" id="payment-amount-2025" class="form-control payment-detail-input" placeholder="0.00"></div><div class="form-group"><label for="payment-amount-2020">For 2019-2020</label><input type="number" step="any" id="payment-amount-2020" class="form-control payment-detail-input" placeholder="0.00"></div><div class="form-group"><label for="payment-amount-2018">For <=2018</label><input type="number" step="any" id="payment-amount-2018" class="form-control payment-detail-input" placeholder="0.00"></div><div class="form-group"><label for="payment-amount">Total Amount*</label><input type="number" id="payment-amount" class="form-control" required readonly style="background-color: var(--border-color);"></div></div><div class="form-group"><label for="payment-method">Payment Method*</label><select id="payment-method" class="form-control" required><option>Bank Transfer</option><option>Cheque</option><option>Cash</option></select></div><div class="form-group"><label for="payment-date">Date*</label><input type="date" id="payment-date" class="form-control" required></div><div class="form-group"><label for="payment-status">Status</label><select id="payment-status" class="form-control"><option>Completed</option><option>Pending</option><option>Failed</option></select></div><button type="submit" class="btn btn-primary">Record Payment</button></form></div>`; 
        document.getElementById('visit-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3>Schedule Visit</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-modal')">&times;</button></div><form id="visit-form"><input type="hidden" id="visit-id"><div class="form-group"><label for="visit-customer-id">Customer*</label><div id="visit-customer-select-container"></div></div><div class="form-group"><label for="visit-purpose">Purpose*</label><input type="text" id="visit-purpose" class="form-control" required></div><div class="form-group"><label for="visit-date">Date & Time*</label><input type="datetime-local" id="visit-date" class="form-control" required></div><button type="submit" class="btn btn-primary">Save Visit</button></form></div>`; 
        document.getElementById('import-csv-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 class="card-title">Upload CSV File</h3><button class="btn btn-outline" onclick="App.UI.closeModal('import-csv-modal')">&times;</button></div><div class="file-upload-wrapper" id="csv-drop-zone"><i class="fas fa-upload" style="font-size: 1.5rem; color: var(--text-secondary);"></i><p>Click to browse or drag & drop file here</p><span id="csv-filename" style="font-weight: 600; color: var(--primary);"></span><input type="file" id="csv-file-input" class="hidden" accept=".csv"></div><div class="info-box"><p>Ensure headers match:</p><code>accountNumber,companyName,email,mobile,emirate,area,status,paymentStatus,initialDebt,salesConsultant,customerStatus,debtSince,balance2020_2025,balance2019_2020,balancelte2018</code></div><a href="#" id="download-sample-csv-link"><i class="fas fa-download"></i> Download Sample Template</a><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('import-csv-modal')">Close</button></div></div>`; 
        document.getElementById('customer-detail-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="customer-detail-title" class="card-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-detail-modal')"></button></div>
        <div class="d-flex gap-2 mb-4">
            <button class="detail-tab-btn active" data-tab="overview"><i class="fas fa-info-circle"></i> Overview</button>
            <button class="detail-tab-btn" data-tab="timeline"><i class="fas fa-history"></i> Activity</button>
            <button class="detail-tab-btn" data-tab="comments"><i class="fas fa-comments"></i> Comments</button>
            <button class="detail-tab-btn" data-tab="calculator"><i class="fas fa-calculator"></i> Payment Plan</button>
        </div>
        <div id="customer-detail-content">
            <div class="tab-content active" id="overview-content"></div>
            <div class="tab-content hidden" id="timeline-content"></div>
            <div class="tab-content hidden" id="comments-content"></div>
            <div class="tab-content hidden" id="calculator-content"></div>
        </div>
        <div class="modal-footer" style="justify-content: space-between;"><div class="d-flex gap-2"><button class="btn btn-success" id="detail-record-payment-btn"><i class="fas fa-dollar-sign"></i> Record Payment</button><button class="btn btn-primary" id="detail-schedule-visit-btn"><i class="fas fa-calendar-plus"></i> Schedule Visit</button></div><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('customer-detail-modal')">Close</button></div></div>`;
        document.getElementById('visit-notes-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 class="card-title">Mark Visit as Done</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-notes-modal')">&times;</button></div><form id="visit-notes-form"><input type="hidden" id="mark-done-visit-id"><input type="hidden" id="log-location-hidden"><div class="form-grid"><div class="form-group"><label>CONTACT METHOD</label><select id="log-contact-method" class="form-control"><option>Site Visit</option><option>Phone Call</option><option>Email</option></select></div><div class="form-group"><label>OUTCOME</label><select id="log-outcome" class="form-control"><option>No Answer</option><option>Promise to Pay</option><option>Dispute</option><option>Paid in Full</option><option>Partial Payment</option></select></div></div><div id="promise-to-pay-fields" class="form-grid hidden"><div class="form-group"><label for="log-promise-amount">Promised Amount (AED)</label><input type="number" id="log-promise-amount" class="form-control"></div><div class="form-group"><label for="log-promise-date">Promised Date</label><input type="date" id="log-promise-date" class="form-control"></div></div><div class="form-group"><label>NOTES</label><div id="log-notes-editor" style="height:150px;"></div></div><div class="form-grid"><div class="form-group"><label>SCHEDULE NEXT VISIT (Optional)</label><input type="date" id="log-next-date" class="form-control"></div><div class="form-group"><label>LOCATION</label><button type="button" class="btn btn-outline" id="log-location-btn" style="width:100%;"><i class="fas fa-map-marker-alt"></i> <span id="log-location-text">Tag Current Location</span></button></div></div><div class="modal-footer" data-role="user"><button type="button" id="log-record-payment-btn" class="btn btn-success"><i class="fas fa-dollar-sign"></i> Record Payment</button><button type="submit" class="btn btn-primary">Save Notes</button></div></form></div>`; 
        document.getElementById('payment-detail-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="card-title">Payment Details</h3><button class="btn btn-outline" onclick="App.UI.closeModal('payment-detail-modal')">&times;</button></div><div id="payment-detail-content"></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('payment-detail-modal')">Close</button></div></div>`; 
        document.getElementById('consultant-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 id="consultant-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('consultant-modal')">&times;</button></div><form id="consultant-form"><input type="hidden" id="consultant-id-hidden"><div class="form-group"><label for="consultantName">Consultant Name*</label><input type="text" id="consultantName" class="form-control" required></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('consultant-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save Consultant</button></div></form></div>`; 
        document.getElementById('visit-detail-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="card-title">Visit Details</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-detail-modal')">&times;</button></div><div id="visit-detail-content"></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('visit-detail-modal')">Close</button></div></div>`;
        document.getElementById('consultant-customers-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="consultant-customers-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('consultant-customers-modal')">&times;</button></div><div id="consultant-customers-body" class="table-container"></div></div>`;
        document.getElementById('reassign-customers-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 id="reassign-customers-title">Reassign Customers</h3><button class="btn btn-outline" onclick="App.UI.closeModal('reassign-customers-modal')">&times;</button></div><form id="reassign-customers-form"><input type="hidden" id="from-consultant-hidden"><div class="form-group"><label>Customers assigned to <strong id="from-consultant-name"></strong></label><div id="reassign-customer-list" style="height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: var(--spacing-2); border-radius: 8px;"></div></div><div class="form-group"><label for="reassign-to-consultant">Reassign selected to</label><select id="reassign-to-consultant" class="form-control" required></select></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('reassign-customers-modal')">Cancel</button><button type="submit" class="btn btn-primary">Reassign</button></div></form></div>`;
        document.getElementById('reassign-and-delete-consultant-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 id="reassign-delete-title">Delete Consultant</h3><button class="btn btn-outline" onclick="App.UI.closeModal('reassign-and-delete-consultant-modal')">&times;</button></div><form id="reassign-and-delete-form"><input type="hidden" id="delete-consultant-id-hidden"><p id="reassign-delete-message"></p><div class="form-group mt-4"><label for="reassign-delete-to-consultant">Reassign all customers to</label><select id="reassign-delete-to-consultant" class="form-control" required></select></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('reassign-and-delete-consultant-modal')">Cancel</button><button type="submit" class="btn btn-danger">Reassign & Delete</button></div></form></div>`;
        document.getElementById('forecast-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="forecast-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('forecast-modal')">&times;</button></div><form id="forecast-form"><input type="hidden" id="forecast-consultant-id"><input type="hidden" id="forecast-id-hidden"><div class="form-grid"><div class="form-group"><label for="forecast-month-select">Month</label><div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-2);"><select id="forecast-month-select" class="form-control" required></select><select id="forecast-year-select" class="form-control" required></select></div></div><div class="form-group"><label for="forecast-amount">Overall Target Amount (AED)</label><input type="number" id="forecast-amount" class="form-control" required></div></div><hr style="margin: var(--spacing-4) 0; border-color: var(--border-color);"><h4 class="card-title mb-2">Targets by Customer Status (Optional)</h4><div class="form-grid"><div class="form-group"><label for="forecast-amount-collectors">"Collectors" Target</label><input type="number" step="any" id="forecast-amount-collectors" class="form-control" placeholder="0.00"></div><div class="form-group"><label for="forecast-amount-sales3m">"Sales (3+ Months)" Target</label><input type="number" step="any" id="forecast-amount-sales3m" class="form-control" placeholder="0.00"></div><div class="form-group full-width"><label for="forecast-amount-sales360d">"Sales (360+ Days)" Target</label><input type="number" step="any" id="forecast-amount-sales360d" class="form-control" placeholder="0.00"></div></div><button type="submit" class="btn btn-primary mt-4">Save Target</button></form><hr style="margin: var(--spacing-6) 0; border-color: var(--border-color);"><h4 class="card-title mb-4">Target History</h4><div class="table-container"><table class="data-table"><thead><tr><th>Month</th><th>Overall Target</th><th>Collectors</th><th>Sales (3+ mo)</th><th>Sales (360+ d)</th><th>Actions</th></tr></thead><tbody id="existing-forecasts-body"></tbody></table></div></div>`;
        document.getElementById('customer-forecast-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="customer-forecast-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-forecast-modal')">&times;</button></div><form id="customer-forecast-form"><input type="hidden" id="customer-forecast-accountNo"><input type="hidden" id="customer-forecast-id-hidden"><div class="form-grid"><div class="form-group"><label for="customer-forecast-month-select">Month</label><div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-2);"><select id="customer-forecast-month-select" class="form-control" required></select><select id="customer-forecast-year-select" class="form-control" required></select></div></div><div class="form-group"><label for="customer-forecast-amount">Forecast Amount (AED)</label><input type="number" id="customer-forecast-amount" class="form-control" required></div></div><button type="submit" class="btn btn-primary">Save Forecast</button></form><hr style="margin: var(--spacing-6) 0; border-color: var(--border-color);"><h4 class="card-title mb-4">Forecast History</h4><div class="table-container"><table class="data-table"><thead><tr><th>Month</th><th>Forecast Amount</th><th>Actions</th></tr></thead><tbody id="existing-customer-forecasts-body"></tbody></table></div></div>`;
        document.getElementById('report-modal').innerHTML = `<div class="modal-content" style="max-width: 90%; width: 1200px;"><div class="modal-header"><h3 id="report-modal-title" style="flex-grow: 1;"></h3><div id="report-modal-actions" class="d-flex gap-2"></div><button class="btn btn-outline" onclick="App.UI.closeModal('report-modal')" style="margin-left: 1rem;">&times;</button></div><div id="report-modal-body" style="margin-top: var(--spacing-4);"></div></div>`;
        document.getElementById('bulk-update-customers-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 class="card-title">Bulk Customer Update</h3><button class="btn btn-outline" onclick="App.UI.closeModal('bulk-update-customers-modal')">&times;</button></div><p id="bulk-update-count-msg" class="text-secondary"></p><form id="bulk-update-form"><div class="form-group"><label for="bulk-update-consultant">Assign to Consultant (Optional)</label><select id="bulk-update-consultant" class="form-control"><option value="">-- Do Not Change --</option></select></div><div class="form-group"><label for="bulk-update-status">Set Account Status (Optional)</label><select id="bulk-update-status" class="form-control"><option value="">-- Do Not Change --</option><option>Active</option><option>Inactive</option></select></div><div class="form-group"><label for="bulk-update-payment-status">Set Payment Status (Optional)</label><select id="bulk-update-payment-status" class="form-control"><option value="">-- Do Not Change --</option><option>Negotiation</option><option>Settlement</option><option>Legal</option><option>Write-Off</option></select></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('bulk-update-customers-modal')">Cancel</button><button type="submit" class="btn btn-warning">Apply Bulk Update</button></div></form></div>`;
        document.getElementById('changelog-detail-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="card-title">Change Log Detail</h3><button class="btn btn-outline" onclick="App.UI.closeModal('changelog-detail-modal')">&times;</button></div><div id="changelog-detail-content"></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('changelog-detail-modal')">Close</button></div></div>`;
        document.getElementById('route-planner-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="card-title">Plan Daily Route</h3><button class="btn btn-outline" onclick="App.UI.closeModal('route-planner-modal')">&times;</button></div><form id="route-planner-form"><div class="form-group"><label for="route-date">Select Date for Route</label><input type="date" id="route-date" class="form-control"></div><div class="form-group"><label>Select Customers to Visit</label><div id="route-customer-list" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); padding: var(--spacing-4); border-radius: 8px;"></div></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('route-planner-modal')">Cancel</button><button type="submit" class="btn btn-primary"><i class="fas fa-route"></i> Generate Route</button></div></form></div>`;
		this.renderLogin(); // Helper to keep init clean
    }, 
    
    // Helper to render login (if you wiped hydrate, put your HTML back here)
    renderLogin() {
        if(document.getElementById('login-page').innerHTML === '') {
             document.getElementById('login-page').innerHTML = `
            <ul class="background-bubbles"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul>
            <div class="login-card">
                <div class="logo"><img src="https://i.ibb.co/pvvsMy1X/Wurth-Gulf-CMYK-PNG-01.png" alt="Wuerth Gulf Logo"></div>
                <h2 style="font-weight: 500; color: var(--text-secondary); margin-bottom: var(--spacing-6);">Customer Recovery App</h2>
                <p id="login-error">Invalid credentials.</p>
                <form id="login-form">
                    <div class="form-group"><label>Username</label><div class="input-wrapper"><i class="fas fa-user"></i><input type="text" id="username" class="form-control" required></div></div>
                    <div class="form-group"><label>Password</label><div class="input-wrapper"><i class="fas fa-lock"></i><input type="password" id="password" class="form-control" required></div></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>
            </div>`; 
            // ... Plus the rest of your app HTML structure ...
            // IMPORTANT: If you already have the HTML structure in your file, 
            // you don't need to change hydrate(). Just update the functions below:
        }
    },
    setupEventListeners() { 
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const hamburger = document.getElementById('hamburger-menu');

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loginError = document.getElementById('login-error');
            loginError.classList.remove('show');
            const u = e.target.username.value, p = e.target.password.value;
            
            // Note the added 'await' here
            const success = await App.Auth.login(u, p);
            
            if (!success) {
                setTimeout(() => loginError.classList.add('show'), 50);
            }
        }); 
        document.getElementById('logout-btn').addEventListener('click', () => {
            this.confirm('Confirm Logout', 'Are you sure you want to log out?', () => {
                App.Auth.logout();
            });
        });
        document.getElementById('theme-toggle-btn').addEventListener('click', () => this.toggleTheme()); 
        hamburger.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        });
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.add('hidden');
        });
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo(link.dataset.page); })); 
        
        // Add listener for customer modal balance calculation
        document.getElementById('customer-modal').addEventListener('input', e => {
            if (e.target.classList.contains('balance-detail')) {
                const form = document.getElementById('customer-form');
                const bal1 = parseFloat(form.elements.balance_2020_2025.value) || 0;
                const bal2 = parseFloat(form.elements.balance_2019_2020.value) || 0;
                const bal3 = parseFloat(form.elements.balance_lte_2018.value) || 0;
                form.elements.outstanding.value = (bal1 + bal2 + bal3).toFixed(2);
            }
        });

        // Add listener for payment modal balance calculation
        document.getElementById('payment-modal').addEventListener('input', e => {
            if (e.target.classList.contains('payment-detail-input')) {
                const form = document.getElementById('payment-form');
                const amt1 = parseFloat(form.elements['payment-amount-2025'].value) || 0;
                const amt2 = parseFloat(form.elements['payment-amount-2020'].value) || 0;
                const amt3 = parseFloat(form.elements['payment-amount-2018'].value) || 0;
                form.elements['payment-amount'].value = (amt1 + amt2 + amt3).toFixed(2);
            }
        });

        App.Dashboard.setupEventListeners(); App.Customers.setupEventListeners(); App.Payments.setupEventListeners(); App.Reports.setupEventListeners(); App.Visits.setupEventListeners(); App.Consultants.setupEventListeners(); App.Users.setupEventListeners(); App.ChangeLog.setupEventListeners(); App.Settings.setupEventListeners(); App.Analytics.setupEventListeners(); App.Performance.setupEventListeners(); App.MyDay.setupEventListeners();
        document.body.addEventListener('click', (e) => { if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !hamburger.contains(e.target)) { sidebar.classList.remove('open'); overlay.classList.add('hidden'); } });
        
        // Setup clearable input listeners globally
        document.querySelectorAll('.input-with-icon .clear-icon').forEach(icon => {
            const input = icon.previousElementSibling;
            icon.addEventListener('click', () => {
                input.value = '';
                input.dispatchEvent(new Event('input', { bubbles: true })); // Trigger the input event to re-render tables
            });
        });
        
        // Dashboard Time Frame Listener
        document.getElementById('dashboard-month-select')?.addEventListener('change', () => {
            App.state.dashboardTimeFrame.month = document.getElementById('dashboard-month-select').value;
            App.Dashboard.render();
        });
        document.getElementById('dashboard-year-select')?.addEventListener('change', () => {
            App.state.dashboardTimeFrame.year = document.getElementById('dashboard-year-select').value;
            App.Dashboard.render();
        });
    }, 
    showApp() { 
        document.getElementById('login-page').style.display = 'none'; 
        document.getElementById('app').classList.remove('hidden'); 
        document.getElementById('username-display').textContent = App.state.currentUser.fullName; 
        App.Auth.checkRole(); 
        
        // Ensure dashboard month/year dropdowns are populated if they exist
        App.Helpers.populateMonthYearDropdowns('dashboard-month-select', 'dashboard-year-select', new Date().getMonth(), new Date().getFullYear());
        
        if (App.state.activeConsultantId !== null) {
            // If returning from a consultant dashboard, reset to the main admin view
            App.state.activeConsultantId = null;
            this.navigateTo('dashboard');
        } else {
            const initialPage = App.state.currentUser.role === 'user' ? 'myday' : 'dashboard';
            this.navigateTo(initialPage);
        }
    }, 
    showLogin() { document.getElementById('login-page').style.display = 'flex'; document.getElementById('app').classList.add('hidden'); }, 
    navigateTo(pageId, subId = null) {
        clearInterval(App.state.dashboardInterval);
        App.state.dashboardInterval = null;
        
        if (pageId === 'consultantDashboard') {
            App.state.activeConsultantId = subId;
            pageId = 'dashboard';
        } else if (pageId !== 'dashboard') {
            App.state.activeConsultantId = null;
        }

        App.state.activePage = pageId;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const targetPage = document.getElementById(`${pageId}-page`);
        if (targetPage) {
            targetPage.classList.add('active');
        }
        
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const targetLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
        if (targetLink) {
            targetLink.classList.add('active');
            const title = targetLink.querySelector('.nav-text').textContent;
            document.getElementById('page-title').textContent = title;
        }

        if (App.state.activeConsultantId) {
            const consultant = App.DB.get('consultants').find(c => c.id === App.state.activeConsultantId);
            document.getElementById('page-title').textContent = `Dashboard: ${consultant.name}`;
        }

        const pageRenderers = {
            dashboard: App.Dashboard,
            myday: App.MyDay,
            customers: App.Customers,
            visits: App.Visits,
            payments: App.Payments,
            reports: App.Reports,
            analytics: App.Analytics,
            performance: App.Performance,
            consultants: App.Consultants,
            users: App.Users,
            changelog: App.ChangeLog,
            settings: App.Settings
        };
        if (pageRenderers[pageId] && typeof pageRenderers[pageId].render === 'function') {
            pageRenderers[pageId].render();
        }
    },
	handleTableSort(pageKey, column) {
        const sortState = App.state.tableSorts[pageKey];
        if (sortState.column === column) {
            sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = column;
            sortState.order = 'asc';
        }
        App.state.pagination[pageKey].currentPage = 1;
        const renderer = App[pageKey.charAt(0).toUpperCase() + pageKey.slice(1)];
        if(renderer && typeof renderer.render === 'function') {
            renderer.render();
        } else if (pageKey === 'visits' && renderer.renderListView) {
            renderer.renderListView();
        }
    },
    updateSortIndicators(pageKey) {
        const { column, order } = App.state.tableSorts[pageKey];
        const pageElement = document.getElementById(`${pageKey}-page`);
        if (!pageElement) return;

        pageElement.querySelectorAll('th[data-sort]').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });
        const activeTh = pageElement.querySelector(`th[data-sort="${column}"]`);
        if (activeTh) {
            activeTh.classList.add(order === 'asc' ? 'sort-asc' : 'sort-desc');
        }
    },
    openModal(id) { 
        const modal = document.getElementById(id);
        if (!modal) return;
        const activeModals = document.querySelectorAll('.modal.active').length;
        modal.style.zIndex = 2000 + activeModals;
        modal.classList.add('active'); 
    }, 
    closeModal(id) { 
        const modal = document.getElementById(id);
        if (!modal) return;
        modal.classList.remove('active'); 
        modal.style.zIndex = '';
        if (id === 'visit-notes-modal') {
            App.state.paymentFlowOrigin = null; 
        }
        if (id === 'payment-modal' && App.state.paymentFlowOrigin) {
            App.Visits.updateVisitNotesUI();
        }
    }, 
    toast: (title, icon = 'success') => Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, icon, title, background: 'var(--card-bg)', color: 'var(--text-primary)' }), 
    confirm: (title, text, cb, target = null) => {
        const options = { 
            title, 
            text, 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: 'var(--primary)', 
            cancelButtonColor: 'var(--danger)', 
            confirmButtonText: 'Yes, do it!', 
            background: 'var(--card-bg)', 
            color: 'var(--text-primary)'
        };
        if (target) {
            options.target = target;
        }
        Swal.fire(options).then(r => r.isConfirmed && cb());
    },
    createSearchableDropdown(container, items, onSelect, placeholder = 'Select an option...') {
        container.innerHTML = `
            <div class="searchable-dropdown">
                <input type="text" class="form-control" placeholder="${placeholder}" autocomplete="off">
                <input type="hidden">
                <div class="searchable-dropdown-results hidden"></div>
            </div>
        `;
        const searchInput = container.querySelector('input[type="text"]');
        const hiddenInput = container.querySelector('input[type="hidden"]');
        const resultsContainer = container.querySelector('.searchable-dropdown-results');

        const renderResults = (filter = '') => {
            const lowerFilter = filter.toLowerCase();
            const filteredItems = items.filter(item => 
                item.mainText.toLowerCase().includes(lowerFilter) || 
                (item.secondaryText && item.secondaryText.toLowerCase().includes(lowerFilter))
            );
            if (filteredItems.length === 0) {
                resultsContainer.innerHTML = '<div class="searchable-dropdown-item no-results">No results found</div>';
            } else {
                resultsContainer.innerHTML = filteredItems.map(item => `
                    <div class="searchable-dropdown-item" data-id="${item.id}">
                        <div class="sdi-main">${item.mainText}</div>
                        <div class="sdi-secondary">${item.secondaryText}</div>
                    </div>
                `).join('');
            }
            resultsContainer.classList.remove('hidden');
        };

        searchInput.addEventListener('focus', () => renderResults());
        searchInput.addEventListener('input', () => renderResults(searchInput.value));

        resultsContainer.addEventListener('click', (e) => {
            const item = e.target.closest('.searchable-dropdown-item');
            if (item && item.dataset.id) {
                const selectedItem = items.find(i => i.id == item.dataset.id);
                searchInput.value = selectedItem.mainText;
                hiddenInput.value = selectedItem.id;
                resultsContainer.classList.add('hidden');
                if(onSelect) onSelect(selectedItem.id);
            }
        });

        document.addEventListener('click', (e) => {
            if (!container.contains(e.target)) {
                resultsContainer.classList.add('hidden');
            }
        });

        return {
            getValue: () => hiddenInput.value,
            setValue: (id) => {
                const selectedItem = items.find(i => i.id == id);
                if (selectedItem) {
                    searchInput.value = selectedItem.mainText;
                    hiddenInput.value = selectedItem.id;
                } else if (id === 'all') {
                    // Set special text for 'All' option if it exists
                    const allItem = items.find(i => i.id === 'all');
                    if (allItem) {
                        searchInput.value = allItem.mainText;
                        hiddenInput.value = allItem.id;
                    }
                }
            },
            getSearchInput: () => searchInput,
            getHiddenInput: () => hiddenInput
        };
    },
    animateTableRows(tbody) {
        if(!tbody) return;
        const rows = tbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.style.animationDelay = `${index * 0.05}s`;
        });
    },
    observeProgressBars() {
        if (!this.intersectionObserver) {
            this.intersectionObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const progressBar = entry.target;
                        const innerBar = progressBar.querySelector('.progress-bar-inner');
                        if (innerBar && innerBar.dataset.width) {
                            setTimeout(() => { innerBar.style.width = innerBar.dataset.width + '%' }, 100);
                        }
                        observer.unobserve(progressBar);
                    }
                });
            }, { threshold: 0.5 });
        }
        document.querySelectorAll('.progress-bar').forEach(bar => {
            const inner = bar.querySelector('.progress-bar-inner');
            if (inner) inner.style.width = '0%'; // Reset before observing
            this.intersectionObserver.observe(bar)
        });
    },
    toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', newTheme);
        this.applyTheme();
    },
    applyTheme() {
        const theme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', theme);
        const themeIcon = document.querySelector('#theme-toggle-btn i');
        if (theme === 'dark') {
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
        } else {
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
        }
    },
    getEmptyStateHTML(iconClass, title, message, buttonHTML = '') {
        return `
            <div class="empty-state" style="padding: var(--spacing-4);">
                <i class="fas ${iconClass}"></i>
                <h4>${title}</h4>
                <p>${message}</p>
                ${buttonHTML}
            </div>
        `;
    },
    renderPaginationControls(pageKey, totalRows) {
        const container = document.getElementById(`${pageKey}-pagination`);
        if (!container) return;

        const { currentPage, rowsPerPage } = App.state.pagination[pageKey];
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        const startRow = totalRows > 0 ? (currentPage - 1) * rowsPerPage + 1 : 0;
        const endRow = Math.min(currentPage * rowsPerPage, totalRows);

        let pageInfo;
        if (totalPages <= 1) {
            pageInfo = `<span>Showing ${totalRows} results</span>`;
        } else {
            pageInfo = `<span>Showing ${startRow}-${endRow} of ${totalRows} results</span>`;
        }

        const rowsSelector = `
            <div class="d-flex align-items-center gap-2">
                <label for="${pageKey}-rows-per-page" class="form-label" style="margin-bottom: 0; font-size: var(--fs-sm);">Rows:</label>
                <select id="${pageKey}-rows-per-page" class="form-control" style="width: auto; padding: 0.25rem 0.5rem;" onchange="App.UI.changeRowsPerPage('${pageKey}', this.value)">
                    <option value="10" ${rowsPerPage == 10 ? 'selected' : ''}>10</option>
                    <option value="25" ${rowsPerPage == 25 ? 'selected' : ''}>25</option>
                    <option value="50" ${rowsPerPage == 50 ? 'selected' : ''}>50</option>
                    <option value="100" ${rowsPerPage == 100 ? 'selected' : ''}>100</option>
                </select>
            </div>
        `;
        
        const pageButtons = totalPages <= 1 ? '' : `
            <div class="d-flex gap-2">
                <button class="btn btn-outline" ${currentPage === 1 ? 'disabled' : ''} onclick="App.UI.changePage('${pageKey}', -1)">Previous</button>
                <button class="btn btn-outline" ${currentPage === totalPages ? 'disabled' : ''} onclick="App.UI.changePage('${pageKey}', 1)">Next</button>
            </div>
        `;

        container.innerHTML = `
            <div class="d-flex align-items-center gap-4">
                ${pageInfo}
                ${rowsSelector}
            </div>
            ${pageButtons}
        `;
    },
    changePage(pageKey, direction) {
        App.state.pagination[pageKey].currentPage += direction;
        const renderer = App[pageKey.charAt(0).toUpperCase() + pageKey.slice(1)];
        if(renderer && typeof renderer.render === 'function') {
            renderer.render();
        } else if (pageKey === 'visits' && renderer.renderListView) {
            renderer.renderListView();
        }
    },
	
	updateCloudStatus(status) {
        // Create the element if it doesn't exist
        let statusEl = document.getElementById('cloud-sync-status');
        if (!statusEl) {
            const header = document.querySelector('.main-header .d-flex.gap-4');
            if (header) {
                statusEl = document.createElement('div');
                statusEl.id = 'cloud-sync-status';
                statusEl.style.fontSize = '0.85rem';
                statusEl.style.fontWeight = '600';
                statusEl.style.marginRight = '10px';
                statusEl.style.padding = '4px 10px';
                statusEl.style.borderRadius = '20px';
                statusEl.style.transition = 'all 0.3s ease';
                header.prepend(statusEl);
            }
        }

        if (!statusEl) return;

        if (status === 'syncing') {
            statusEl.innerHTML = '<i class="fas fa-sync fa-spin"></i> Saving...';
            statusEl.style.color = '#0d6efd'; // Blue
            statusEl.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
        } else if (status === 'saved') {
            statusEl.innerHTML = '<i class="fas fa-check"></i> Saved';
            statusEl.style.color = '#198754'; // Green
            statusEl.style.backgroundColor = 'rgba(25, 135, 84, 0.1)';
            // Fade out the "Saved" text after 3 seconds
            setTimeout(() => {
                if (App.DB.pendingSyncs === 0) statusEl.innerHTML = '';
                statusEl.style.backgroundColor = 'transparent';
            }, 3000);
        } else if (status === 'error') {
            statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sync Error';
            statusEl.style.color = '#dc3545'; // Red
            statusEl.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
        }
    },
	
	// Add this inside Object.assign(App.UI, { ... })
	toggleLoading(show, message = "Loading...") {
    const overlay = document.getElementById('loading-overlay');
    if (show) {
        overlay.style.display = 'flex';
        overlay.style.flexDirection = 'column';
        // Add or update text
        let textEl = overlay.querySelector('p');
        if(!textEl) {
            textEl = document.createElement('p');
            textEl.style.marginTop = '15px';
            textEl.style.fontWeight = '600';
            textEl.style.color = 'var(--primary)';
            overlay.appendChild(textEl);
        }
        textEl.textContent = message;
    } else {
        overlay.style.display = 'none';
    }
	},
    changeRowsPerPage(pageKey, value) {
        App.state.pagination[pageKey].rowsPerPage = parseInt(value, 10);
        App.state.pagination[pageKey].currentPage = 1;
        
        const paginationSettings = JSON.parse(localStorage.getItem('paginationSettings')) || {};
        if(!paginationSettings[pageKey]) paginationSettings[pageKey] = {};
        paginationSettings[pageKey].rowsPerPage = App.state.pagination[pageKey].rowsPerPage;
        localStorage.setItem('paginationSettings', JSON.stringify(paginationSettings));

        const renderer = App[pageKey.charAt(0).toUpperCase() + pageKey.slice(1)];
        if(renderer && typeof renderer.render === 'function') {
            renderer.render();
        } else if (pageKey === 'visits' && renderer.renderListView) {
            renderer.renderListView();
        }
    }
});

</script>
<script>
Object.assign(App.Dashboard, { 
    charts: {}, 
    setupEventListeners() { 
        document.getElementById('dashboard-page').addEventListener('click', e => { 
            if (e.target.id === 'start-day-btn') this.startDay(); 
            if (e.target.id === 'end-day-btn') this.endDay(); 
            if (e.target.id === 'start-break-btn') this.startBreak(); 
            if (e.target.id === 'end-break-btn') this.endBreak(); 
            
            // NEW: Handle Upcoming Visits Tile Click
            if (e.target.closest('#upcoming-visits-tile')) {
                this.showUpcomingVisitsPopup();
            }

            if (e.target.closest('#toggle-dashboard-view-btn')) { 
                App.state.adminDashboardView = App.state.adminDashboardView === 'overview' ? 'chart_view' : 'overview'; this.render(); 
            }
            const actionItem = e.target.closest('.priority-action-item');
            if (actionItem && actionItem.dataset.customerId) {
                App.Customers.showCustomerDetail(actionItem.dataset.customerId);
            }
        });
    }, 

    // NEW FUNCTION: Logic for the popup list
    showUpcomingVisitsPopup: function() {
        const consultantId = App.state.currentUser.assignedConsultantId;
        // Force string comparison for the consultant ID
        const visits = App.Helpers.getScopedData('visits', consultantId)
            .filter(v => (v.status === 'Scheduled' || v.status === 'In Progress') && new Date(v.dateTime) >= new Date())
            .sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));

        if (visits.length === 0) {
            return App.UI.toast('No upcoming visits scheduled.', 'info');
        }

        const customers = App.DB.get('customers');
        const headers = ['Date & Time', 'Customer Name', 'Purpose'];
        
        const data = visits.map(v => {
            const customer = customers.find(c => String(c.accountNo) === String(v.customerId));
            return [
                App.Helpers.formatDateTime(v.dateTime),
                customer ? customer.companyName : 'N/A',
                v.purpose
            ];
        });

        App.Reports.displayReport('My Upcoming Visits', headers, data, '', ['pdf']);
    },

    render() { 
        const consultantDashboardHeader = document.getElementById('consultant-dashboard-header');
        const adminDashboardWrapper = document.getElementById('admin-dashboard-wrapper');
        consultantDashboardHeader.classList.add('hidden');
        adminDashboardWrapper.style.display = '';

        const monthSelect = document.getElementById('dashboard-month-select');
        const yearSelect = document.getElementById('dashboard-year-select');
        if(monthSelect && yearSelect) {
            monthSelect.value = App.state.dashboardTimeFrame.month;
            yearSelect.value = App.state.dashboardTimeFrame.year;
        }

        if (App.state.activeConsultantId) {
            const chartWrapper = document.getElementById('chart-dashboard-wrapper');
            const consultant = App.DB.get('consultants').find(c => c.id === App.state.activeConsultantId);
            consultantDashboardHeader.innerHTML = `<h3 class="mb-0">Viewing Dashboard for: ${consultant.name}</h3><button class="btn btn-outline" onclick="App.UI.navigateTo('dashboard')">Back to Main Dashboard</button>`;
            consultantDashboardHeader.classList.remove('hidden');
            adminDashboardWrapper.style.display = 'none'; 
            chartWrapper.classList.remove('hidden'); 
            this.renderUserDashboard(App.state.activeConsultantId);
            return;
        }

        if(App.state.dashboardInterval) clearInterval(App.state.dashboardInterval); 
        const adminWrapper = document.getElementById('admin-dashboard-wrapper'); 
        const chartWrapper = document.getElementById('chart-dashboard-wrapper'); 
        const toggleBtn = document.getElementById('toggle-dashboard-view-btn'); 
        if (App.state.currentUser.role === 'admin') { 
            adminWrapper.classList.remove('hidden'); 
            if (App.state.adminDashboardView === 'overview') { 
                chartWrapper.classList.add('hidden'); 
                toggleBtn.innerHTML = `<i class="fas fa-chart-bar"></i> Switch to Chart View`; 
                this.renderAdminDashboard(); 
                App.state.dashboardInterval = setInterval(() => this.renderAdminDashboard(), 15000); 
            } else { 
                chartWrapper.classList.remove('hidden'); 
                document.getElementById('admin-dashboard-content').innerHTML = ''; 
                toggleBtn.innerHTML = `<i class="fas fa-tachometer-alt"></i> Switch to Overview`; 
                this.renderUserDashboard();
                this.renderAdminChartDashboard(); 
            } 
        } else { 
            adminWrapper.classList.add('hidden'); 
            chartWrapper.classList.remove('hidden'); 
            this.renderUserDashboard(); 
        } 
    },
    renderAdminChartDashboard() {
        const bottomContainer = document.getElementById('dashboard-bottom-content');
        let bottomHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);">
                <div class="card"><div class="card-header"><h3 class="card-title">Target vs. Collected (by Consultant)</h3></div><div class="chart-container"><canvas id="target-performance-chart"></canvas></div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">Forecast vs. Collected (by Consultant)</h3></div><div class="chart-container"><canvas id="forecast-performance-chart"></canvas></div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">Outstanding Debt by Emirate</h3></div><div class="chart-container"><canvas id="debt-chart"></canvas></div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">Monthly Payment Recovery</h3></div><div class="chart-container"><canvas id="payment-chart"></canvas></div></div>
            </div>
        `;
        bottomContainer.innerHTML = bottomHTML;
        this.renderCharts(); // Re-render general charts
        this.renderAdminPerformanceCharts(); // Render new admin-specific charts
    },
    renderAdminPerformanceCharts() {
        const consultants = App.DB.get('consultants');
        const customers = App.DB.get('customers');
        const payments = App.DB.get('payments');
        const forecasts = App.DB.get('forecasts');
        const customerForecasts = App.DB.get('customerForecasts');
        const currentMonthStr = `${App.state.dashboardTimeFrame.year}-${App.state.dashboardTimeFrame.month}`;
        const recoveredThisMonth = payments.filter(p => p.status === 'Completed' && p.date.startsWith(currentMonthStr));

        const labels = consultants.map(c => c.name);

        // Chart 1: Target vs Collected
        const targetData = consultants.map(consultant => {
            const targetEntry = forecasts.find(f => f.consultantId === consultant.id && f.month === currentMonthStr);
            const collected = recoveredThisMonth
                .filter(p => customers.find(c => c.accountNo === p.customerId)?.salesConsultantId === consultant.id)
                .reduce((sum, p) => sum + p.amount, 0);
            return {
                target: targetEntry ? targetEntry.amount : 0,
                collected: collected
            };
        });
        const targetCtx = document.getElementById('target-performance-chart').getContext('2d');
        if (this.charts.targetPerformance) this.charts.targetPerformance.destroy();
        this.charts.targetPerformance = new Chart(targetCtx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Target', data: targetData.map(d => d.target), backgroundColor: 'rgba(220, 53, 69, 0.5)' },
                    { label: 'Collected', data: targetData.map(d => d.collected), backgroundColor: 'rgba(16, 185, 129, 0.7)' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // Chart 2: Forecast vs Collected
        const forecastData = consultants.map(consultant => {
            const assignedCustomers = customers.filter(c => c.salesConsultantId === consultant.id);
            const assignedCustomerIds = assignedCustomers.map(c => c.accountNo);

            const totalForecast = customerForecasts
                .filter(f => f.month === currentMonthStr && assignedCustomerIds.includes(f.accountNo))
                .reduce((sum, f) => sum + f.amount, 0);

            const collected = recoveredThisMonth
                .filter(p => assignedCustomerIds.includes(p.customerId))
                .reduce((sum, p) => sum + p.amount, 0);

            return { forecast: totalForecast, collected };
        });

        const forecastCtx = document.getElementById('forecast-performance-chart').getContext('2d');
        if (this.charts.forecastPerformance) this.charts.forecastPerformance.destroy();
        this.charts.forecastPerformance = new Chart(forecastCtx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Forecast', data: forecastData.map(d => d.forecast), backgroundColor: 'rgba(255, 193, 7, 0.5)' },
                    { label: 'Collected', data: forecastData.map(d => d.collected), backgroundColor: 'rgba(16, 185, 129, 0.7)' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    },
    
	renderAdminDashboard() { 
        const container = document.getElementById('admin-dashboard-content'); 
        const customers = App.DB.get('customers'); 
        const activityLog = App.DB.get('activityLog'); 
        const consultants = App.DB.get('consultants');
        const payments = App.DB.get('payments');
        const customerForecasts = App.DB.get('customerForecasts');

        const currentMonthStr = `${App.state.dashboardTimeFrame.year}-${App.state.dashboardTimeFrame.month}`;
        const recoveredThisMonth = payments.filter(p => p.status === 'Completed' && p.date.startsWith(currentMonthStr)).reduce((sum, p) => sum + p.amount, 0);

        const totalForecastTarget = App.DB.get('forecasts')
            .filter(f => f.month === currentMonthStr)
            .reduce((sum, f) => sum + f.amount, 0);
        
        const totalForecastedAmount = customerForecasts
            .filter(f => f.month === currentMonthStr)
            .reduce((sum, f) => sum + f.amount, 0);

        const forecastPercentage = totalForecastTarget > 0 ? ((recoveredThisMonth / totalForecastTarget) * 100).toFixed(0) : 0;
        
        const totalInitial = customers.reduce((s, c) => s + c.initialDebt, 0); 
        const totalOutstanding = customers.reduce((s, c) => s + c.outstanding, 0); 
        const totalRecovered = totalInitial - totalOutstanding; 
        
        let targetHTML = `<div class="card"><div class="card-title">Monthly Target</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalForecastTarget)}</div><div class="progress-bar mt-4 mb-2"><div class="progress-bar-inner" data-width="${forecastPercentage}"></div></div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${App.Helpers.formatCurrency(recoveredThisMonth)} collected (${forecastPercentage}%)</div></div>`;
        let forecastHTML = `<div class="card"><div class="card-title">Total Forecasted</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalForecastedAmount)}</div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">From all customers</div></div>`;
        
        const chartHTML = `
            <div class="card mb-6">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">Daily Recovery Pulse (Actual vs. Promised)</h3>
                    <div style="font-size: var(--fs-sm); color: var(--text-secondary);">
                        <span style="display:inline-block; width:10px; height:10px; background:rgba(16, 185, 129, 0.7); margin-right:5px;"></span>Collected
                        <span style="display:inline-block; width:10px; height:10px; background:#ffc107; margin-left:10px; margin-right:5px;"></span>Promised
                    </div>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="daily-pulse-chart"></canvas>
                </div>
            </div>
        `;

        container.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-6);">
                <div class="card"><div class="card-title">Total Recovered (All Time)</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalRecovered)}</div></div>
                <div class="card"><div class="card-title">Total Outstanding</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalOutstanding)}</div></div>
                ${targetHTML}${forecastHTML}
            </div>
            ${chartHTML} 
            <div id="admin-dashboard-bottom-section"></div>
        `; 

        const bottomSection = document.getElementById('admin-dashboard-bottom-section');
        bottomSection.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);">
                <div id="stale-accounts-monitor"></div> <div id="attention-required"></div>
                <div id="admin-consultant-target-progress"></div>
                <div id="admin-consultant-forecast-progress"></div>
                <div id="admin-pending-promises"></div>
                <div id="admin-recent-activities"></div>
            </div>
            <div id="admin-upcoming-visits" class="mt-4"></div>
        `;
        
        // Render Widgets
        this.renderStaleAccounts(document.getElementById('stale-accounts-monitor')); // NEW CALL
        this.renderAttentionRequired(document.getElementById('attention-required'));
        this.renderConsultantTargetProgress(document.getElementById('admin-consultant-target-progress'), consultants, customers, payments, App.DB.get('forecasts'));
        this.renderConsultantForecastProgress(document.getElementById('admin-consultant-forecast-progress'), consultants, customers, payments);
        this.renderPendingPromisesWidget(document.getElementById('admin-pending-promises'));

        const upcomingVisits = App.DB.get('visits').filter(v => new Date(v.dateTime) >= new Date() && v.status === 'Scheduled').sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime)).slice(0, 10);
        const customerMap = App.DB.get('customers').reduce((map, customer) => { map[customer.accountNo] = customer.companyName; return map; }, {});
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        
        document.getElementById('admin-recent-activities').innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Recent Activities</h3></div><ul style="list-style:none; padding:0; max-height: 400px; overflow-y:auto;">${activityLog.sort((a,b) => b.timestamp - a.timestamp).slice(0, 10).map(log => `<li style="padding: var(--spacing-2) 0; border-bottom: 1px solid var(--border-color);"><div style="font-weight: 600;">${consultantMap[log.consultantId] || 'N/A'}</div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${log.action}${log.details ? ': ' + log.details : ''}</div><div style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${log.time}</div></li>`).join('')}</ul></div>`;
        document.getElementById('admin-upcoming-visits').innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Next 10 Upcoming Visits</h3></div><div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Company Name</th><th>Sales Consultant</th></tr></thead><tbody>${upcomingVisits.length > 0 ? upcomingVisits.map(v => `<tr><td>${App.Helpers.formatDateTime(v.dateTime)}</td><td>${customerMap[v.customerId] || 'N/A'}</td><td>${consultantMap[v.collectorId] || 'N/A'}</td></tr>`).join('') : '<tr><td colspan="3">No upcoming visits found.</td></tr>'}</tbody></table></div></div>`;
        
        this.renderDailyPulseChart();
        App.UI.observeProgressBars(); 
    },
	
	
	
	renderDailyPulseChart: function() {
        const ctx = document.getElementById('daily-pulse-chart');
        if (!ctx) return;

        // Destroy existing chart if it exists to prevent overlap
        if (this.charts.dailyPulse) this.charts.dailyPulse.destroy();

        const year = parseInt(App.state.dashboardTimeFrame.year);
        const month = parseInt(App.state.dashboardTimeFrame.month); 
        const daysInMonth = new Date(year, month, 0).getDate();
        const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);

        const dailyCollected = new Array(daysInMonth).fill(0);
        const dailyPromised = new Array(daysInMonth).fill(0);
        const currentMonthStr = `${year}-${month.toString().padStart(2, '0')}`;

        // 1. Sum Actual Collections by Day
        App.DB.get('payments').forEach(p => {
            if (p.status === 'Completed' && p.date.startsWith(currentMonthStr)) {
                const day = parseInt(p.date.split('-')[2]) - 1;
                if (dailyCollected[day] !== undefined) dailyCollected[day] += p.amount;
            }
        });

        // 2. Sum Promises by Day
        App.DB.get('visits').forEach(v => {
            if (v.outcome === 'Promise to Pay' && v.promiseDate && v.promiseDate.startsWith(currentMonthStr)) {
                const day = parseInt(v.promiseDate.split('-')[2]) - 1;
                if (dailyPromised[day] !== undefined) dailyPromised[day] += (v.promiseAmount || 0);
            }
        });

        // 3. Render Chart
        this.charts.dailyPulse = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Collected',
                        data: dailyCollected,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        order: 2
                    },
                    {
                        type: 'line',
                        label: 'Promised',
                        data: dailyPromised,
                        borderColor: '#ffc107',
                        borderWidth: 2,
                        pointBackgroundColor: '#ffc107',
                        tension: 0.3,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { color: 'var(--border-color)' } },
                    x: { grid: { display: false } }
                },
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + App.Helpers.formatCurrency(context.raw);
                            }
                        }
                    }
                }
            }
        });
    },
    renderUserDashboard(consultantId = null) { 
        // 1. Run the Morning Briefing Check immediately
        this.checkMorningBriefing(consultantId);

        const isConsultantView = consultantId !== null;
        const currentUser = isConsultantView ? { role: 'user', assignedConsultantId: consultantId } : App.state.currentUser;

        const attendanceControls = document.getElementById('attendance-controls'); 
        const todaysAgenda = document.getElementById('todays-agenda');
        const priorityActions = document.getElementById('priority-actions');

        if (currentUser.role === 'user' && !isConsultantView) { 
            attendanceControls.classList.remove('hidden'); 
            todaysAgenda.classList.remove('hidden');
            priorityActions.classList.remove('hidden');
            this.renderAttendanceControls(); 
            this.renderTodaysAgenda(todaysAgenda, currentUser);
            this.renderPriorityActions(priorityActions, currentUser);
        } else { 
            attendanceControls.classList.add('hidden'); 
            todaysAgenda.classList.add('hidden');
            priorityActions.classList.add('hidden');
        } 
        
        const scopedCustomers = App.Helpers.getScopedData('customers', consultantId);
        const scopedPayments = App.Helpers.getScopedData('payments', consultantId);
        const scopedVisits = App.Helpers.getScopedData('visits', consultantId);
        const customerForecasts = App.DB.get('customerForecasts');

        this.renderRecoveryProgress(scopedCustomers); 
        
        const currentMonthStr = `${App.state.dashboardTimeFrame.year}-${App.state.dashboardTimeFrame.month}`;
        const recoveredThisMonth = scopedPayments.filter(i => i.date.startsWith(currentMonthStr) && i.status === 'Completed').reduce((s, i) => s + i.amount, 0);
        
        const scopedCustomerIds = scopedCustomers.map(c => c.accountNo);
        let totalForecast = customerForecasts
            .filter(f => f.month === currentMonthStr && scopedCustomerIds.includes(f.accountNo))
            .reduce((s, f) => s + f.amount, 0);
        
        const forecastPercentage = totalForecast > 0 ? ((recoveredThisMonth / totalForecast) * 100).toFixed(0) : 0;
        const forecastCard = document.getElementById('user-dashboard-forecast-card');
        
        if (forecastCard) {
            forecastCard.innerHTML = `
                <div class="card-title">Forecast Progress</div>
                <div class="value" style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalForecast)}</div>
                <div class="progress-bar mt-4 mb-2"><div class="progress-bar-inner" data-width="${forecastPercentage}"></div></div>
                <div style="font-size: var(--fs-sm); color: var(--text-secondary);">${App.Helpers.formatCurrency(recoveredThisMonth)} collected (${forecastPercentage}%)</div>
            `;
        }

        this.animateCounter('stat-total-customers', scopedCustomers.length); 
        this.animateCounter('stat-outstanding-debt', scopedCustomers.reduce((s, i) => s + i.outstanding, 0), true); 
        this.animateCounter('stat-recovered-this-month', recoveredThisMonth, true); 
        this.animateCounter('stat-upcoming-visits', scopedVisits.filter(i => new Date(i.dateTime) >= new Date() && i.status === 'Scheduled').length); 
        
        const bottomContainer = document.getElementById('dashboard-bottom-content');
        
        let bottomHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);">
                <div id="pending-promises-container"></div>
                <div id="debt-chart-container" class="card"><div class="card-header"><h3 class="card-title">Outstanding Debt by Emirate</h3></div><div class="chart-container"><canvas id="debt-chart"></canvas></div></div>
                <div id="payment-chart-container" class="card"><div class="card-header"><h3 class="card-title">Monthly Payment Recovery</h3></div><div class="chart-container"><canvas id="payment-chart"></canvas></div></div>
            </div>
        `;
        
        bottomContainer.innerHTML = bottomHTML;
        this.renderPendingPromisesWidget(document.getElementById('pending-promises-container'), consultantId);
        this.renderCharts(consultantId);
        
        App.UI.observeProgressBars();
    },

    // --- NEW FUNCTION: Morning Briefing Logic ---
    checkMorningBriefing(consultantId) {
        // 1. Check if already shown in this session
        if (sessionStorage.getItem('morningBriefingShown')) return;

        // 2. Prepare Data
        const today = new Date().toISOString().slice(0, 10);
        const visits = App.Helpers.getScopedData('visits', consultantId);
        const customers = App.DB.get('customers');

        // 3. Filter for Promises Due TODAY that are NOT completed
        const promises = visits.filter(v => 
            v.outcome === 'Promise to Pay' && 
            v.promiseDate === today && 
            v.status !== 'Completed'
        );

        if (promises.length > 0) {
            // Calculate totals
            const totalAmount = promises.reduce((sum, v) => sum + (v.promiseAmount || 0), 0);
            
            // Format customer names list
            const customerMap = customers.reduce((map, c) => { map[c.accountNo] = c.companyName; return map; }, {});
            const namesList = promises.slice(0, 3).map(v => 
                `<li>${customerMap[v.customerId] || v.customerId} <span style="float:right; font-weight:600;">${App.Helpers.formatCurrency(v.promiseAmount)}</span></li>`
            ).join('');
            
            const moreCount = promises.length - 3;
            const moreText = moreCount > 0 ? `<li style="text-align:center; color:var(--text-secondary); margin-top:5px;">...and ${moreCount} others</li>` : '';

            // 4. Show the Alert
            Swal.fire({
                title: ' Morning Briefing',
                html: `
                    <div style="text-align: left;">
                        <p style="margin-bottom: 15px;">Good Morning! You have <strong>${promises.length} promises</strong> scheduled for today.</p>
                        
                        <div style="background: linear-gradient(to right, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success); margin-bottom: 15px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Expected Collection</div>
                            <div style="font-size: 1.75rem; font-weight: 800; color: var(--success);">${App.Helpers.formatCurrency(totalAmount)}</div>
                        </div>

                        <ul style="padding-left: 0; list-style: none; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
                            ${namesList}
                            ${moreText}
                        </ul>
                    </div>
                `,
                confirmButtonText: 'View My Day',
                confirmButtonColor: 'var(--primary)',
                showCancelButton: true,
                cancelButtonText: 'Dismiss',
                background: 'var(--card-bg)',
                color: 'var(--text-primary)',
                width: '400px'
            }).then((result) => {
                // If they click "View My Day", take them there
                if (result.isConfirmed) {
                    App.UI.navigateTo('myday');
                }
            });

            // 5. Set flag so it doesn't show again until page reload/re-login
            sessionStorage.setItem('morningBriefingShown', 'true');
        }
    },
    renderTodaysAgenda(container, user = App.state.currentUser) {
        const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c.companyName; return map; }, {});
        const visits = App.Helpers.getScopedData('visits', user.assignedConsultantId);
        const today = new Date().toISOString().slice(0, 10);
        
        const todaysVisits = visits.filter(v => v.dateTime.startsWith(today) && v.status === 'Scheduled');
        const todaysPromises = visits.filter(v => v.promiseDate === today && v.outcome === 'Promise to Pay');
        const overdueVisits = visits.filter(v => v.status === 'Overdue');
        const overduePromises = visits.filter(v => v.promiseDate && v.promiseDate < today && v.outcome === 'Promise to Pay');

        const createList = (items, type) => {
            if (items.length === 0) return `<p>No ${type} for today.</p>`;
            return `<ul style="list-style-type: none;">${items.map(item => `<li style="margin-bottom: var(--spacing-2);">${item}</li>`).join('')}</ul>`;
        };

        const visitList = createList(todaysVisits.map(v => `${customerMap[v.customerId] || 'N/A'}: ${v.purpose}`), 'visits');
        const promiseList = createList(todaysPromises.map(p => `${customerMap[p.customerId] || 'N/A'}: ${App.Helpers.formatCurrency(p.promiseAmount)}`), 'promises due');

        const overdueCount = overdueVisits.length + overduePromises.length;
        const overdueHTML = overdueCount > 0 
            ? `<div class="detail-info-card" style="background-color: rgba(220, 53, 69, 0.1); border-color: var(--danger);"><div class="label">Overdue Tasks</div><div class="value" style="color: var(--danger);">${overdueCount}</div></div>` 
            : `<div class="detail-info-card"><div class="label">Overdue Tasks</div><div class="value">0</div></div>`;

        container.innerHTML = `
            <div class="card">
                <div class="card-header"><h3 class="card-title">Today's Agenda</h3></div>
                <div class="detail-info-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="detail-info-card"><div class="label">Visits for Today</div>${visitList}</div>
                    <div class="detail-info-card"><div class="label">Promises Due Today</div>${promiseList}</div>
                    ${overdueHTML}
                </div>
            </div>`;
    },
    renderPriorityActions(container, user = App.state.currentUser) {
        const scopedVisits = App.Helpers.getScopedData('visits', user.assignedConsultantId);
        const scopedCustomers = App.Helpers.getScopedData('customers', user.assignedConsultantId);
        const customerMap = scopedCustomers.reduce((map, c) => { map[c.accountNo] = c; return map; }, {});

        let actions = [];
        const today = new Date();
        const todayStr = today.toISOString().slice(0, 10);
        const tenDaysAgo = new Date(new Date().setDate(today.getDate() - 10));

        // --- 1. NEW: Ghosting Detection (Highest Priority) ---
        scopedCustomers.forEach(c => {
            const cVisits = scopedVisits
                .filter(v => v.customerId === c.accountNo && v.status === 'Completed')
                .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
            
            // Check last 2 visits
            const recentOutcomes = cVisits.slice(0, 2).map(v => v.outcome);
            if (recentOutcomes.length >= 2 && recentOutcomes.every(o => o === 'No Answer')) {
                actions.push({
                    priority: 1, // Top Priority
                    type: 'Ghosting Alert',
                    icon: 'fa-user-slash',
                    style: 'color: var(--danger);',
                    text: `<strong>${c.companyName}</strong> has been unreachable for the last 2 visits. Try a different time or method.`,
                    customerId: c.accountNo
                });
            }
        });

        // --- 2. NEW: Legacy Debt (High Priority) ---
        scopedCustomers.filter(c => c.balance_lte_2018 > 0).forEach(c => {
            actions.push({
                priority: 2,
                type: 'Legacy Debt',
                icon: 'fa-history',
                style: 'color: var(--warning);',
                text: `<strong>${c.companyName}</strong> still holds debt from 2018 (${App.Helpers.formatCurrency(c.balance_lte_2018)}). Secure a payment plan.`,
                customerId: c.accountNo
            });
        });

        // --- 3. EXISTING: Overdue Visits ---
        scopedVisits.filter(v => v.status === 'Overdue').forEach(v => {
            actions.push({
                priority: 3,
                type: 'Overdue Visit',
                icon: 'fa-calendar-times',
                style: 'color: var(--text-primary);',
                text: `Contact <strong>${customerMap[v.customerId]?.companyName || 'N/A'}</strong> for visit on ${App.Helpers.formatDate(v.dateTime)}.`,
                customerId: v.customerId
            });
        });

        // --- 4. EXISTING: Promises Due ---
        scopedVisits.filter(v => v.outcome === 'Promise to Pay' && v.promiseDate && v.promiseDate <= todayStr && v.status !== 'Completed').forEach(v => {
            actions.push({
                priority: 4,
                type: 'Promise Due',
                icon: 'fa-hand-holding-usd',
                style: 'color: var(--success);',
                text: `Collect promised ${App.Helpers.formatCurrency(v.promiseAmount)} from <strong>${customerMap[v.customerId]?.companyName || 'N/A'}</strong>.`,
                customerId: v.customerId
            });
        });
        
        // --- 5. EXISTING: High-value & No Contact ---
        scopedCustomers.filter(c => c.outstanding > 20000).forEach(c => {
            const lastVisit = scopedVisits.filter(v => v.customerId === c.accountNo).sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime))[0];
            if (!lastVisit || new Date(lastVisit.dateTime) < tenDaysAgo) {
                 actions.push({
                    priority: 5,
                    type: 'High-Value Account',
                    icon: 'fa-exclamation-circle',
                    style: 'color: var(--text-secondary);',
                    text: `<strong>${c.companyName}</strong> (${App.Helpers.formatCurrency(c.outstanding)}) has not been contacted recently.`,
                    customerId: c.accountNo
                });
            }
        });

        // Sort by Priority (1 is highest)
        actions.sort((a,b) => a.priority - b.priority);

        let content;
        if (actions.length > 0) {
            content = `<ul>${actions.slice(0, 6).map(action => `
                <li class="priority-action-item" data-customer-id="${action.customerId}">
                    <div class="d-flex align-items-center">
                        <div style="width: 32px; text-align: center; margin-right: var(--spacing-4);">
                            <i class="fas ${action.icon}" style="font-size: 1.2rem; ${action.style}"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600; ${action.style}">${action.type}</div>
                            <div style="font-size: var(--fs-sm); color: var(--text-secondary);">${action.text}</div>
                        </div>
                    </div>
                </li>
            `).join('')}</ul>`;
        } else {
            content = `<div class="empty-state" style="padding: var(--spacing-4);"><i class="fas fa-check-circle" style="color: var(--success);"></i><h4>All Clear!</h4><p>No priority actions for today.</p></div>`;
        }

        container.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Priority Actions</h3></div>${content}</div>`;
    },
    renderAttentionRequired(container) {
        const visits = App.DB.get('visits');
        const customers = App.DB.get('customers');
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        
        const today = new Date();
        const daysAgo30 = new Date(today);
        daysAgo30.setDate(today.getDate() - 30);

        // 1. Calculate Risk Score for ALL customers
        let riskList = customers.map(c => {
            let score = 0;
            let reasons = [];

            // Get this customer's visits
            const customerVisits = visits
                .filter(v => v.customerId === c.accountNo)
                .sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));
            const lastVisit = customerVisits.find(v => v.status === 'Completed');

            // --- RISK FACTORS ---
            
            // A. Legacy Debt (+3)
            if (c.balance_lte_2018 > 0) {
                score += 3;
                reasons.push("Legacy Debt");
            }

            // B. Ghosting Pattern (+2)
            const recentOutcomes = customerVisits.slice(0, 2).map(v => v.outcome);
            if (recentOutcomes.length >= 2 && recentOutcomes.every(o => o === 'No Answer')) {
                score += 2;
                reasons.push("Ghosting");
            }

            // C. Missed Promise (+4)
            const hasMissedPromise = customerVisits.some(v => v.outcome === 'Promise to Pay' && v.promiseDate && new Date(v.promiseDate) < today);
            if (hasMissedPromise) {
                score += 4;
                reasons.push("Missed Promise");
            }

            // D. High Balance & No Contact (+2)
            if (c.outstanding > 20000 && (!lastVisit || new Date(lastVisit.dateTime) < daysAgo30)) {
                score += 2;
                reasons.push("High Val/No Contact");
            }

            return { ...c, score, reasons };
        })
        .filter(c => c.score > 0) // Only show customers with actual risk
        .sort((a, b) => b.score - a.score) // Highest risk at the top
        .slice(0, 5); // Take top 5

        // 2. Render the Widget
        let content;
        if(riskList.length > 0) {
             content = `<ul style="list-style: none;">${riskList.map(item => `
                <li class="priority-action-item" data-customer-id="${item.accountNo}" style="border-left: 4px solid var(--danger); padding-left: 1rem;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div style="font-weight: 600;">${item.companyName}</div>
                            <div style="font-size: var(--fs-sm); color: var(--text-secondary);">
                                <span style="color: var(--danger); font-weight: 700;">Risk Score: ${item.score}</span> 
                                 ${consultantMap[item.salesConsultantId] || 'Unassigned'}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                                ${item.reasons.map(r => `<span style="background: rgba(220, 53, 69, 0.1); color: var(--danger); padding: 1px 6px; border-radius: 4px; margin-right: 4px;">${r}</span>`).join('')}
                            </div>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="App.Customers.showCustomerDetail('${item.accountNo}')"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </li>
            `).join('')}</ul>`;
        } else {
             content = `<div class="empty-state" style="padding: var(--spacing-4);"><i class="fas fa-shield-alt" style="color: var(--success);"></i><h4>All Clear</h4><p>No high-risk accounts detected.</p></div>`;
        }
        
        container.innerHTML = `<div class="card" style="height: 100%;"><div class="card-header"><h3 class="card-title text-danger"><i class="fas fa-exclamation-triangle"></i> High Risk Watchlist</h3></div>${content}</div>`;
    },
    renderPendingPromisesWidget(container, consultantId = null) {
        const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c.companyName; return map; }, {});
        const promises = App.Helpers.getScopedData('visits', consultantId).filter(v => v.outcome === 'Promise to Pay' && v.promiseDate && v.status === 'Completed').sort((a, b) => new Date(a.promiseDate) - new Date(b.promiseDate));
        let content;
        if (promises.length === 0) {
            content = '<p>No pending payment promises.</p>';
        } else {
            const today = new Date().toISOString().slice(0, 10);
            content = `<div class="table-container"><table class="data-table"><thead><tr><th>Customer</th><th>Amount</th><th>Due Date</th></tr></thead><tbody>
                ${promises.map(p => `<tr>
                    <td>${customerMap[p.customerId] || 'N/A'}</td>
                    <td>${App.Helpers.formatCurrency(p.promiseAmount || 0)}</td>
                    <td style="${p.promiseDate < today ? 'color: var(--danger); font-weight: 600;' : ''}">${App.Helpers.formatDate(p.promiseDate)}</td>
                </tr>`).join('')}
            </tbody></table></div>`;
        }
        container.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Pending Promises</h3></div>${content}</div>`;
    },
    renderConsultantTargetProgress(container, consultants, allCustomers, allPayments, allForecasts) {
        const currentMonthStr = `${App.state.dashboardTimeFrame.year}-${App.state.dashboardTimeFrame.month}`;
        const recoveredThisMonth = allPayments.filter(p => p.status === 'Completed' && p.date.startsWith(currentMonthStr));

        const progressHTML = consultants.map(consultant => {
            const forecastEntry = allForecasts.find(f => f.consultantId === consultant.id && f.month === currentMonthStr);
            const totalTarget = forecastEntry ? forecastEntry.amount : 0;
            
            const assignedCustomerIds = new Set(allCustomers.filter(c => c.salesConsultantId === consultant.id).map(c => c.accountNo));
            const collectedThisMonth = recoveredThisMonth.filter(p => assignedCustomerIds.has(p.customerId)).reduce((sum, p) => sum + p.amount, 0);

            const percentage = totalTarget > 0 ? ((collectedThisMonth / totalTarget) * 100).toFixed(0) : 0;

            return `<div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span style="font-weight: 600;">${consultant.name}</span>
                            <span style="font-size: var(--fs-sm); color: var(--text-secondary);">${percentage}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-bar-inner" data-width="${percentage}"></div></div>
                        <div style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${App.Helpers.formatCurrency(collectedThisMonth)} of ${App.Helpers.formatCurrency(totalTarget)}</div>
                    </div>`;
        }).join('');
        
        container.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Consultant Target Progress (${currentMonthStr})</h3></div><div style="max-height: 400px; overflow-y: auto; padding-right: 1rem;">${progressHTML}</div></div>`;
    },
    renderConsultantForecastProgress(container, consultants, allCustomers, allPayments) {
        const currentMonthStr = `${App.state.dashboardTimeFrame.year}-${App.state.dashboardTimeFrame.month}`;
        const recoveredThisMonth = allPayments.filter(p => p.status === 'Completed' && p.date.startsWith(currentMonthStr));
        const customerForecasts = App.DB.get('customerForecasts');

        const progressHTML = consultants.map(consultant => {
            const assignedCustomers = allCustomers.filter(c => c.salesConsultantId === consultant.id);
            const assignedCustomerIds = new Set(assignedCustomers.map(c => c.accountNo));
            const totalForecast = customerForecasts
                .filter(f => f.month === currentMonthStr && assignedCustomerIds.has(f.accountNo))
                .reduce((sum, f) => sum + f.amount, 0);
            
            const collectedThisMonth = recoveredThisMonth.filter(p => assignedCustomerIds.has(p.customerId)).reduce((sum, p) => sum + p.amount, 0);

            const percentage = totalForecast > 0 ? ((collectedThisMonth / totalForecast) * 100).toFixed(0) : 0;

            return `<div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span style="font-weight: 600;">${consultant.name}</span>
                            <span style="font-size: var(--fs-sm); color: var(--text-secondary);">${percentage}%</span>
                        </div>
						                            <div class="progress-bar"><div class="progress-bar-inner" data-width="${percentage}" style="background-color: var(--warning);"></div></div>
                         <div style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${App.Helpers.formatCurrency(collectedThisMonth)} of ${App.Helpers.formatCurrency(totalForecast)}</div>
                    </div>`;
        }).join('');
        
        container.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Consultant Forecast Progress (${currentMonthStr})</h3></div><div style="max-height: 400px; overflow-y: auto; padding-right: 1rem;">${progressHTML}</div></div>`;
    },
	
	renderStaleAccounts(container) {
        // 1. Define Logic (90 Days Inactivity)
        const customers = App.DB.get('customers');
        const visits = App.DB.get('visits');
        const payments = App.DB.get('payments');
        
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

        // 2. Filter Customers
        const staleList = customers.filter(c => {
            if (c.outstanding <= 0) return false; // Ignore paid up customers

            // Get Last Visit Date
            const cVisits = visits.filter(v => v.customerId === c.accountNo);
            const lastVisit = cVisits.length > 0 
                ? cVisits.reduce((a, b) => new Date(a.dateTime) > new Date(b.dateTime) ? a : b) 
                : null;

            // Get Last Payment Date
            const cPayments = payments.filter(p => p.customerId === c.accountNo);
            const lastPayment = cPayments.length > 0 
                ? cPayments.reduce((a, b) => new Date(a.date) > new Date(b.date) ? a : b) 
                : null;

            // Check if BOTH are older than 90 days (or don't exist)
            const lastVisitDate = lastVisit ? new Date(lastVisit.dateTime) : new Date(0); // Epoch if null
            const lastPaymentDate = lastPayment ? new Date(lastPayment.date) : new Date(0); // Epoch if null

            // Returns TRUE if both are old
            return lastVisitDate < ninetyDaysAgo && lastPaymentDate < ninetyDaysAgo;
        });

        // 3. Render Widget
        if (staleList.length > 0) {
            const totalStaleValue = staleList.reduce((sum, c) => sum + c.outstanding, 0);
            
            // Attach function to global scope temporarily for the button onclick
            window.runStaleSweeper = () => this.tagStaleAccounts(staleList.map(c => c.accountNo));

            container.innerHTML = `
                <div class="card" style="border-left: 4px solid #6f42c1;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="card-title" style="color: #6f42c1;"><i class="fas fa-spider"></i> Stale Accounts</h3>
                        <span class="status-badge" style="background: #6f42c1; color: white;">${staleList.length}</span>
                    </div>
                    <div class="d-flex flex-column gap-2">
                        <p style="font-size: var(--fs-sm); color: var(--text-secondary); margin-bottom: 0;">
                            Customers with >90 days inactivity.
                        </p>
                        <div style="font-weight: 700; font-size: 1.2rem;">${App.Helpers.formatCurrency(totalStaleValue)}</div>
                        
                        <div class="table-container" style="max-height: 150px; overflow-y: auto; margin-bottom: 10px;">
                            <table class="data-table" style="font-size: 0.8rem;">
                                <tbody>
                                    ${staleList.slice(0, 5).map(c => `<tr><td>${c.companyName}</td><td style="text-align:right;">${App.Helpers.formatAbbreviatedCurrency(c.outstanding)}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>

                        <button onclick="window.runStaleSweeper()" class="btn btn-outline" style="width: 100%; border-color: #6f42c1; color: #6f42c1;">
                            <i class="fas fa-tags"></i> Tag All as "Neglected"
                        </button>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="card" style="height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; color: var(--text-secondary);">
                    <div>
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                        <p>No stale accounts.<br>Great coverage!</p>
                    </div>
                </div>
            `;
        }
    },

    tagStaleAccounts(accountNos) {
        App.UI.confirm('Run Stale Account Sweeper?', `This will add the "Neglected" tag to ${accountNos.length} customers.`, () => {
            let customers = App.DB.get('customers');
            let updatedCount = 0;

            customers = customers.map(c => {
                if (accountNos.includes(c.accountNo)) {
                    // Check if tag already exists
                    if (!c.tags) c.tags = [];
                    if (!c.tags.includes('Neglected')) {
                        c.tags.push('Neglected');
                        updatedCount++;
                    }
                }
                return c;
            });

            App.DB.set('customers', customers);
            App.Helpers.logChange('Bulk Action', 'Customers', 'Stale Account Sweeper', `Tagged ${updatedCount} customers as Neglected`);
            App.UI.toast(`Sweeper Complete! ${updatedCount} customers tagged.`, 'success');
            
            // Refresh
            this.renderAdminDashboard(); 
        });
    },
	
	
	
    renderAttendanceControls() {
        const todayStr = new Date().toISOString().slice(0, 10);
        const consultantId = App.state.currentUser.assignedConsultantId;
        const log = App.DB.get('activityLog');
        const startEntry = log.find(entry => entry.consultantId === consultantId && entry.date === todayStr && entry.action === 'Started Day');
        const dayStarted = !!startEntry;
        const dayEnded = log.some(entry => entry.consultantId === consultantId && entry.date === todayStr && entry.action === 'Ended Day');
        const onBreak = !!App.state.breakStartTime;
        
        let html = '<div class="card d-flex gap-4 justify-content-between align-items-center flex-wrap">';
        
        if (dayStarted) {
            let statusText = `Day Started at: ${startEntry.time}`;
            if (onBreak) { statusText = `<span style="color:var(--warning);">On Break</span>`; }
            html += `<div><h3 class="card-title" style="margin:0; font-size:var(--fs-base)">Daily Attendance</h3><p style="font-size:var(--fs-sm);" id="attendance-status">${statusText}</p></div>`;
        } else {
            html += `<div><h3 class="card-title" style="margin:0; font-size:var(--fs-base)">Daily Attendance</h3><p style="color:var(--text-secondary); font-size:var(--fs-sm);" id="attendance-status">Log your work day.</p></div>`;
        }

        html += `<div class="d-flex gap-4 align-items-center">`;
        html += `<span id="work-timer" style="font-weight:600; font-size:var(--fs-lg); color:var(--primary); min-width: 100px; text-align: right;"></span>`;

        if (!dayStarted) {
            html += `<button id="start-day-btn" class="btn btn-success"><i class="fas fa-play"></i> Start Day</button>`;
        } else if (dayEnded) {
            html += `<p style="font-weight:600; color:var(--success);">Day Completed!</p>`;
        } else if (onBreak) {
            html += `<button id="end-break-btn" class="btn btn-success"><i class="fas fa-play"></i> End Break</button>`;
        } else {
            html += `<button id="start-break-btn" class="btn btn-outline" style="border-color: var(--warning); color: var(--warning);"><i class="fas fa-pause"></i> Start Break</button>`;
            html += `<button id="end-day-btn" class="btn btn-danger"><i class="fas fa-stop"></i> End Day</button>`;
        }

        html += `</div></div>`;
        document.getElementById('attendance-controls').innerHTML = html;

        if (dayStarted && !dayEnded) {
            App.state.totalBreakTime = log
                .filter(e => e.consultantId === consultantId && e.date === todayStr && e.action === 'Ended Break' && e.duration)
                .reduce((sum, e) => sum + e.duration, 0);
            this.startTimer(startEntry.timestamp);
        }
    },
    startDay() {
        App.state.totalBreakTime = 0;
        App.state.breakStartTime = null;
        App.Helpers.logActivity('Started Day');
        App.UI.toast('Day Started! Good luck.', 'success');
        this.render();
    },
    endDay() {
        clearInterval(App.state.dayTimerInterval);
        const consultantId = App.state.currentUser.assignedConsultantId;
        const todayStr = new Date().toISOString().slice(0, 10);
        const todaysLog = App.DB.get('activityLog').filter(e => e.consultantId === consultantId && e.date === todayStr);

        const visitsCompleted = todaysLog.filter(e => e.action.includes('completed visit')).length;
        const paymentsRecorded = todaysLog.filter(e => e.action.includes('recorded a payment'));
        const totalCollected = paymentsRecorded.reduce((sum, p) => sum + (p.amount || 0), 0);
        const workTime = document.getElementById('work-timer')?.textContent || 'N/A';
        
        Swal.fire({
            title: 'Day Summary',
            html: `
                <div style="text-align: left; padding: 0 1rem;">
                    <p><strong>Total Work Time:</strong> ${workTime}</p>
                    <p><strong>Visits Completed:</strong> ${visitsCompleted}</p>
                    <p><strong>Payments Collected:</strong> ${paymentsRecorded.length} (${App.Helpers.formatCurrency(totalCollected)})</p>
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Great!',
            background: 'var(--card-bg)',
            color: 'var(--text-primary)'
        }).then(() => {
            App.Helpers.logActivity('Ended Day');
            App.UI.toast('Day Ended! Well done.', 'info');
            this.render();
        });
    },
    startBreak() {
        clearInterval(App.state.dayTimerInterval);
        App.state.breakStartTime = Date.now();
        App.Helpers.logActivity('Started Break');
        this.render();
    },
    endBreak() {
        if (!App.state.breakStartTime) return;
        const breakDuration = Date.now() - App.state.breakStartTime;
        App.state.totalBreakTime += breakDuration;
        App.Helpers.logActivity('Ended Break', `Duration: ${Math.round(breakDuration/60000)} min`, null, null, null, breakDuration);
        App.state.breakStartTime = null;
        this.render(); 
    },
    startTimer(startTime) {
        clearInterval(App.state.dayTimerInterval);
        const timerElement = document.getElementById('work-timer');
        if (!timerElement) return;

        if (App.state.breakStartTime) {
            const activeTimeBeforeBreak = (App.state.breakStartTime - startTime) - App.state.totalBreakTime;
            timerElement.textContent = App.Helpers.formatDuration(Math.max(0, activeTimeBeforeBreak));
            return;
        }
        
        const startTimestamp = startTime;
        App.state.dayTimerInterval = setInterval(() => {
            const activeTime = (Date.now() - startTimestamp) - App.state.totalBreakTime;
            timerElement.textContent = App.Helpers.formatDuration(Math.max(0, activeTime));
        }, 1000);
    },
    animateCounter(id, t, isC = false) { let e = document.getElementById(id); if (!e) return; let n = 0, i = Math.max(1, Math.ceil(t / 100)); const u = () => { n += i; if (n < t) { e.textContent = isC ? App.Helpers.formatCurrency(Math.ceil(n)) : Math.ceil(n); requestAnimationFrame(u) } else { e.textContent = isC ? App.Helpers.formatCurrency(t) : t } }; u() }, 
    renderCharts(consultantId = null) { 
        const customers = App.Helpers.getScopedData('customers', consultantId);
        const payments = App.Helpers.getScopedData('payments', consultantId);
        const tc = 'var(--text-primary)'; // text color
        const bc = 'var(--border-color)'; // border color

        // Debt by Emirate Chart
        const debtByEmirate = customers.reduce((acc, item) => { 
            acc[item.emirate] = (acc[item.emirate] || 0) + item.outstanding; 
            return acc; 
        }, {}); 
        const debtChartEl = document.getElementById('debt-chart'); 
        if (!debtChartEl) return; 
        if (this.charts.debt) this.charts.debt.destroy(); 
        this.charts.debt = new Chart(debtChartEl, { 
            type: 'bar', 
            data: { 
                labels: Object.keys(debtByEmirate), 
                datasets: [{ 
                    label: 'Outstanding Debt', 
                    data: Object.values(debtByEmirate), 
                    backgroundColor: ['#e2000f', '#10b981', '#ffc107', '#6c757d'], 
                    borderWidth: 0 
                }] 
            }, 
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const emirate = this.charts.debt.data.labels[index];
                        this.showCustomersByEmirate(emirate, consultantId);
                    }
                },
                scales: {
                    y: { ticks: { color: tc }, grid: { color: bc } },
                    x: { ticks: { color: tc }, grid: { color: 'transparent' } }
                }
            } 
        }); 
        
        // Monthly Payment Recovery Chart
        const paymentChartEl = document.getElementById('payment-chart'); 
        if (!paymentChartEl) return; 
        if (this.charts.payment) this.charts.payment.destroy(); 

        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const currentYear = App.state.dashboardTimeFrame.year;
        const monthlyData = { collected: Array(12).fill(0), target: Array(12).fill(0) };
        
        payments.filter(p => new Date(p.date).getFullYear() == currentYear && p.status === 'Completed').forEach(p => {
            const paymentYear = new Date(p.date).getFullYear();
            if (paymentYear == currentYear) {
                const monthIndex = new Date(p.date).getMonth();
                monthlyData.collected[monthIndex] += p.amount;
            }
        });
        
        const forecasts = consultantId 
            ? App.DB.get('forecasts').filter(f => f.consultantId === consultantId)
            : App.DB.get('forecasts');

        forecasts.filter(f => f.month.startsWith(currentYear)).forEach(forecast => {
            const monthIndex = parseInt(forecast.month.split('-')[1], 10) - 1;
            monthlyData.target[monthIndex] += forecast.amount;
        });

        this.charts.payment = new Chart(paymentChartEl, { 
            type: 'bar', 
            data: { 
                labels: months, 
                datasets: [
                    { label: 'Target', data: monthlyData.target, backgroundColor: 'rgba(220, 53, 69, 0.5)', borderRadius: 4 },
                    { label: 'Collected', data: monthlyData.collected, backgroundColor: 'rgba(16, 185, 129, 0.7)', borderRadius: 4 }
                ] 
            }, 
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: tc }, grid: { color: bc } }, x: { ticks: { color: tc }, grid: { color: 'transparent' } } }, plugins: { legend: { labels: { color: tc } } } } 
        }); 
    }, 
    renderRecoveryProgress(customers) { 
        const totalInitialDebt = customers.reduce((sum, c) => sum + c.initialDebt, 0); 
        const totalOutstanding = customers.reduce((sum, c) => sum + c.outstanding, 0); 
        const totalCollected = totalInitialDebt - totalOutstanding; 
        const percentage = totalInitialDebt > 0 ? ((totalCollected / totalInitialDebt) * 100).toFixed(0) : 0; 
        const container = document.getElementById('recovery-progress-card'); 
        container.innerHTML = `<div class="d-flex align-items-center gap-2 mb-4"><i class="fas fa-bullseye" style="color: var(--primary);"></i><h3 class="card-title" style="margin:0;">Recovery Progress</h3></div><div><div class="mb-2" style="font-weight: 600; text-transform: uppercase; font-size: var(--fs-sm); color: var(--text-secondary);">Total Debt vs Collected</div><div class="progress-bar mb-2"><div class="progress-bar-inner" data-width="${percentage}"></div></div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${App.Helpers.formatCurrency(totalCollected)} collected of ${App.Helpers.formatCurrency(totalInitialDebt)} (${percentage}%)</div></div>`; 
        App.UI.observeProgressBars(); 
    },
    showCustomersByEmirate(emirate, consultantId = null) {
        let customersInEmirate = App.Helpers.getScopedData('customers', consultantId)
            .filter(c => c.emirate === emirate && c.outstanding > 0)
            .sort((a,b) => b.outstanding - a.outstanding);

        const headers = ['Customer', 'Outstanding', 'Consultant'];
        const data = customersInEmirate.map(c => {
            const consultantName = App.DB.get('consultants').find(con => con.id === c.salesConsultantId)?.name || 'N/A';
            return [c.companyName, App.Helpers.formatCurrency(c.outstanding), consultantName];
        });

        const reportTitle = `Outstanding Customers in ${emirate}`;
        App.Reports.displayReport(reportTitle, headers, data, '', ['csv', 'pdf']);
    }
});

Object.assign(App.MyDay, {
    map: null,
    routingControl: null,
    setupEventListeners() {
        const page = document.getElementById('myday-page');
        page.addEventListener('click', e => {
            const visitBtn = e.target.closest('.mark-done-btn'); // Handles 'End Visit'
            const startBtn = e.target.closest('.start-visit-btn'); // Handles 'Start Visit'
            const snoozeBtn = e.target.closest('.snooze-btn');
            const taskItem = e.target.closest('.clickable');

            // --- NEW: Start Visit logic ---
            if (startBtn) {
                e.stopPropagation();
                App.Visits.checkIn(startBtn.dataset.id);
            }
            // ------------------------------

            if (visitBtn) {
                App.Visits.showMarkDoneModal(visitBtn.dataset.id);
            }
            
            if (snoozeBtn) {
                e.stopPropagation(); 
                const visitId = snoozeBtn.dataset.id;
                const visits = App.DB.get('visits');
                const visitIndex = visits.findIndex(v => v.id === visitId);
                
                if (visitIndex > -1) {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowStr = tomorrow.toISOString().slice(0, 10);
                    const originalTime = visits[visitIndex].dateTime.split('T')[1] || '09:00:00.000Z';
                    visits[visitIndex].dateTime = `${tomorrowStr}T${originalTime}`;
                    visits[visitIndex].status = 'Scheduled'; 
                    App.DB.set('visits', visits);
                    App.Helpers.logChange('Rescheduled', 'Visit', `Snoozed to ${tomorrowStr}`);
                    App.UI.toast('Task moved to tomorrow.', 'info');
                    this.render();
                }
            }

            if (taskItem && taskItem.dataset.customerId) {
                App.Customers.showCustomerDetail(taskItem.dataset.customerId);
            }
        });
    },
    render() {
        document.getElementById('myday-date').textContent = new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const consultantId = App.state.currentUser.assignedConsultantId;
        const allVisits = App.Helpers.getScopedData('visits', consultantId);
        const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c; return map; }, {});
        const today = new Date().toISOString().slice(0, 10);
        const todayStart = new Date();
        todayStart.setHours(0,0,0,0);

        // Render Today's Visits
        // --- NEW: Filter includes 'In Progress' ---
        const todaysVisits = allVisits.filter(v => 
            v.dateTime.startsWith(today) && (v.status === 'Scheduled' || v.status === 'In Progress')
        );
        const visitsListContainer = document.getElementById('myday-visits-list');
        
        if (todaysVisits.length > 0) {
            visitsListContainer.innerHTML = todaysVisits.map(v => {
                let actionBtn = '';
                
                // --- NEW: Button Logic ---
                if (v.status === 'Scheduled') {
                    actionBtn = `
                        <button class="btn btn-outline snooze-btn" data-id="${v.id}" title="Snooze" style="padding: 4px 8px; margin-right: 5px; color: #ffc107; border-color: #ffc107;"><i class="fas fa-clock"></i></button>
                        <button class="btn btn-success start-visit-btn" data-id="${v.id}" title="Check In" style="padding: 4px 12px;"><i class="fas fa-play"></i> Start</button>
                    `;
                } else if (v.status === 'In Progress') {
                    actionBtn = `
                        <button class="btn btn-danger mark-done-btn" data-id="${v.id}" title="Check Out" style="padding: 4px 12px;"><i class="fas fa-stop"></i> End</button>
                    `;
                }
                // -------------------------

                return `
                <div class="myday-task-item" style="${v.status === 'In Progress' ? 'background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; padding-left: 10px;' : ''}">
                    <div class="myday-task-info">
                        <span class="customer-name">${customerMap[v.customerId]?.companyName || 'N/A'}</span>
                        <span class="task-details">
                            ${v.status === 'In Progress' ? '<b style="color:#10b981;">IN PROGRESS</b>' : v.purpose}
                        </span>
                    </div>
                    <div class="d-flex align-items-center">
                        ${actionBtn}
                    </div>
                </div>
            `}).join('');
        } else {
            visitsListContainer.innerHTML = App.UI.getEmptyStateHTML('fa-check-circle', 'All Clear!', 'No visits scheduled for today.');
        }

        const promisesDue = allVisits.filter(v => v.outcome === 'Promise to Pay' && v.promiseDate === today);
        const promisesListContainer = document.getElementById('myday-promises-list');
         if (promisesDue.length > 0) {
            promisesListContainer.innerHTML = promisesDue.map(p => `
                <div class="myday-task-item clickable" data-customer-id="${p.customerId}">
                    <div class="myday-task-info">
                        <span class="customer-name">${customerMap[p.customerId]?.companyName || 'N/A'}</span>
                        <span class="task-details">Promised: ${App.Helpers.formatCurrency(p.promiseAmount)}</span>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            `).join('');
        } else {
            promisesListContainer.innerHTML = App.UI.getEmptyStateHTML('fa-calendar-check', 'No Follow-ups', 'No payment promises are due today.');
        }
        
        const overdueVisits = allVisits.filter(v => v.status === 'Overdue');
        const overduePromises = allVisits.filter(v => v.outcome === 'Promise to Pay' && v.promiseDate && new Date(v.promiseDate) < todayStart);
        const overdueListContainer = document.getElementById('myday-overdue-list');
        let overdueHTML = '';
        
        if (overdueVisits.length > 0) {
            overdueHTML += overdueVisits.map(v => `
                <div class="myday-task-item">
                    <div class="myday-task-info">
                        <span class="customer-name">${customerMap[v.customerId]?.companyName || 'N/A'}</span>
                        <span class="task-details" style="color:var(--danger);">Overdue since ${App.Helpers.formatDate(v.dateTime)}</span>
                    </div>
                    <button class="btn btn-outline snooze-btn" data-id="${v.id}" title="Move to Tomorrow" style="padding: 4px 8px;">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            `).join('');
        }
         if (overduePromises.length > 0) {
            overdueHTML += overduePromises.map(p => `
                 <div class="myday-task-item clickable" data-customer-id="${p.customerId}">
                    <div class="myday-task-info">
                        <span class="customer-name">${customerMap[p.customerId]?.companyName || 'N/A'}</span>
                        <span class="task-details">Missed Promise from ${App.Helpers.formatDate(p.promiseDate)}</span>
                    </div>
                     <i class="fas fa-chevron-right"></i>
                </div>
            `).join('');
        }
        if (overdueHTML === '') {
            overdueListContainer.innerHTML = App.UI.getEmptyStateHTML('fa-thumbs-up', 'Nothing Overdue', 'Great job staying on top of your tasks!');
        } else {
             overdueListContainer.innerHTML = overdueHTML;
        }

        this.renderMyDayMap(todaysVisits, customerMap);
    },
    renderMyDayMap(visits, customerMap) {
        const mapContainer = document.getElementById('myday-map-view');
        if (!mapContainer) return;
        if (this.map) { 
            if (this.routingControl) {
                this.map.removeControl(this.routingControl);
                this.routingControl = null;
            }
            this.map.remove(); 
            this.map = null; 
        }

        this.map = L.map('myday-map-view').setView([25.2048, 55.2708], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: ' OpenStreetMap contributors  CARTO'
        }).addTo(this.map);

        if (visits.length === 0) {
            mapContainer.innerHTML = App.UI.getEmptyStateHTML('fa-map-signs', 'No Visits on Map', 'Schedule visits for today to see them here.');
            return;
        }
        
        const validVisits = visits.filter(v => {
            const c = customerMap[v.customerId];
            return c && c.latitude && c.longitude;
        });
        
        if(validVisits.length < 2) { 
             validVisits.forEach(visit => {
                const customer = customerMap[visit.customerId];
                const icon = App.Helpers.getCustomerMarkerIcon(customer);
                L.marker([customer.latitude, customer.longitude], { icon })
                    .addTo(this.map)
                    .bindPopup(`<b>${customer.companyName}</b><br>${visit.purpose}`);
            });
            if(validVisits.length === 1) {
                const c = customerMap[validVisits[0].customerId];
                this.map.setView([c.latitude, c.longitude], 13);
            }
            return;
        }

        const waypoints = App.Helpers.optimizeRoute(validVisits.map(v => v.customerId))
            .map(id => {
                const c = customerMap[id];
                return L.latLng(c.latitude, c.longitude);
            });

        this.routingControl = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false,
            addWaypoints: false,
            show: false, 
            lineOptions: {
                styles: [{ color: 'var(--primary)', opacity: 0.8, weight: 6 }]
            },
             createMarker: (i, waypoint, n) => {
                const customerId = validVisits.find(v => {
                    const c = customerMap[v.customerId];
                    return c && c.latitude === waypoint.latLng.lat && c.longitude === waypoint.latLng.lng;
                })?.customerId;
                
                const customer = customerMap[customerId];
                if (!customer) return null;

                const icon = L.divIcon({
                    className: 'numbered-marker',
                    html: `<div>${i + 1}</div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });
                return L.marker(waypoint.latLng, { icon }).bindPopup(`<b>${i+1}. ${customer.companyName}</b>`);
            }
        }).addTo(this.map);
    }
});


// --- REPLACE ENTIRE APP.CUSTOMERS SECTION WITH THIS ---
Object.assign(App.Customers, { 
    viewMode: 'list', quill: null, 

    setupEventListeners: function() { 
        document.getElementById('add-customer-btn').addEventListener('click', () => this.showCustomerForm()); 
        document.getElementById('import-customer-btn').addEventListener('click', () => { document.getElementById('csv-filename').textContent = ''; App.UI.openModal('import-csv-modal'); }); 
        document.getElementById('bulk-update-btn')?.addEventListener('click', () => this.showBulkUpdateModal());
        document.getElementById('bulk-update-form')?.addEventListener('submit', (e) => this.performBulkUpdate(e));
        
        const exportCSVBtn = document.getElementById('export-customers-csv');
        if (exportCSVBtn) exportCSVBtn.addEventListener('click', () => { const visibleColumns = Object.keys(App.state.customerTableColumns).filter(key => App.state.customerTableColumns[key]); App.Helpers.exportTableData('csv', 'Customers', this.getCurrentFilteredData, visibleColumns); });
        const exportPDFBtn = document.getElementById('export-customers-pdf');
        if (exportPDFBtn) exportPDFBtn.addEventListener('click', () => { const visibleColumns = Object.keys(App.state.customerTableColumns).filter(key => App.state.customerTableColumns[key]); App.Helpers.exportTableData('pdf', 'Customers', this.getCurrentFilteredData, visibleColumns); });
        
        document.getElementById('customer-form').addEventListener('submit', (e) => this.saveCustomer(e)); 
        document.getElementById('customer-forecast-form').addEventListener('submit', (e) => this.saveCustomerForecast(e)); 
        const thead = document.querySelector('#customers-page .data-table thead');
        if(thead) thead.addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('customers', th.dataset.sort); }); 
        
        // Use debounce for search input
        const debouncedRender = App.Helpers.debounce(() => {App.state.pagination.customers.currentPage = 1; this.render()}, 300); 
        document.getElementById('customer-search').addEventListener('input', debouncedRender); 
        document.getElementById('customer-tag-filter').addEventListener('input', debouncedRender); 
        document.getElementById('customer-account-status-filter').addEventListener('change', () => {App.state.pagination.customers.currentPage = 1; this.render()}); 
        document.getElementById('customer-status-filter').addEventListener('change', () => {App.state.pagination.customers.currentPage = 1; this.render()}); 
        
        document.getElementById('customers-page').addEventListener('click', (e) => { 
            const button = e.target.closest('button');
            const tag = e.target.closest('.clickable-tag');
            if (button && button.id === 'view-toggle-list') { this.viewMode = 'list'; this.render(); }
            if (button && button.id === 'view-toggle-board') { this.viewMode = 'board'; this.render(); }
            if (button && button.closest('tbody')) { 
                const id = button.dataset.id; 
                if (button.classList.contains('view-customer')) this.showCustomerDetail(id); 
                else if (button.classList.contains('edit-customer')) this.showCustomerForm(id); 
                else if (button.classList.contains('delete-customer')) this.deleteCustomer(id); 
                else if (button.classList.contains('set-forecast')) this.showCustomerForecastForm(id); 
            } else if (tag) {
                const tagText = tag.dataset.tag;
                const tagFilterInput = document.getElementById('customer-tag-filter');
                tagFilterInput.value = tagText;
                tagFilterInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }); 

        const detailModal = document.getElementById('customer-detail-modal');
        detailModal.addEventListener('click', (e) => { 
            const button = e.target.closest('button'); 
            if (!button) return; 
            if (button.classList.contains('detail-tab-btn')) this.switchDetailTab(button.dataset.tab); 
            else if (button.id === 'detail-record-payment-btn') { App.UI.closeModal('customer-detail-modal'); App.Payments.showPaymentForm(App.state.activeCustomerId); } 
            else if (button.id === 'detail-schedule-visit-btn') { App.UI.closeModal('customer-detail-modal'); App.Visits.showScheduleModal(null, null, App.state.activeCustomerId); } 
            else if (button.id === 'add-comment-btn') { this.addComment(App.state.activeCustomerId); }
        }); 
        const toggleBtn = document.getElementById('toggle-columns-btn');
        const toggleDropdown = document.getElementById('column-toggle-dropdown');
        toggleBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleDropdown.style.display = toggleDropdown.style.display === 'block' ? 'none' : 'block'; });
        document.addEventListener('click', (e) => { if (!toggleDropdown.contains(e.target) && !toggleBtn.contains(e.target)) { toggleDropdown.style.display = 'none'; } });
        document.getElementById('existing-customer-forecasts-body').addEventListener('click', e => { 
            const deleteBtn = e.target.closest('.delete-customer-forecast'); 
            const editBtn = e.target.closest('.edit-customer-forecast'); 
            if(deleteBtn) this.deleteCustomerForecast(deleteBtn.dataset.id); 
            if(editBtn) this.editCustomerForecast(editBtn.dataset.id); 
        }); 
    }, 

    // --- UPDATED: Super Robust Filter Logic ---
    getCurrentFilteredData: function() {
        const { value: search } = document.getElementById('customer-search'); 
        const { value: tagFilter } = document.getElementById('customer-tag-filter'); 
        const { value: accountStatusFilter } = document.getElementById('customer-account-status-filter'); 
        const { value: statusFilter } = document.getElementById('customer-status-filter'); 
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        let customers = App.Helpers.getScopedData('customers');
        
        customers = customers.filter(c => {
            // 1. Safe Search
            const searchMatch = (
                String(c.companyName || '').toLowerCase().includes(search.toLowerCase()) || 
                String(c.accountNo || '').toLowerCase().includes(search.toLowerCase()) || 
                String(consultantMap[c.salesConsultantId] || '').toLowerCase().includes(search.toLowerCase())
            );

            // 2. Tag Filter
            const tagMatch = !tagFilter || (c.tags && c.tags.some(tag => tag.toLowerCase().includes(tagFilter.toLowerCase())));

            // 3. Account Status
            const accountStatusMatch = (accountStatusFilter === 'all' || c.status === accountStatusFilter);

            // 4. Customer Status Filter (FIXED)
            let statusMatch = true;
            if (statusFilter !== 'all') {
                // This function removes: Spaces, Brackets (), and words "days"/"months"
                const normalize = (s) => String(s || '').toLowerCase()
                    .replace(/[\s\(\)]/g, '')       // Remove spaces and brackets
                    .replace(/days?|months?/g, ''); // Remove 'day', 'days', 'month', 'months'

                const dbStatus = normalize(c.customerStatus);
                const filterVal = normalize(statusFilter);
                
                // Now "Sales(Above 360)" and "Sales (Above 360 Days)" both become "salesabove360"
                statusMatch = dbStatus === filterVal;
            }

            return searchMatch && tagMatch && accountStatusMatch && statusMatch;
        });
        
        const { column, order } = App.state.tableSorts.customers; 
        customers.sort((a, b) => {
            let valA = a[column], valB = b[column];
            if(column === 'salesConsultantId') { valA = consultantMap[valA] || ''; valB = consultantMap[valB] || ''; }
            if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
            if (valA < valB) return order === 'asc' ? -1 : 1; 
            if (valA > valB) return order === 'asc' ? 1 : -1; 
            return 0; 
        });
        return customers;
    },

    render: function() { 
        this.renderColumnToggle();
        if(App.state.currentUser.role === 'admin') {
            const customers = App.DB.get('customers');
            App.Dashboard.animateCounter('customer-kpi-total', customers.length);
            App.Dashboard.animateCounter('customer-kpi-outstanding', customers.reduce((sum, c) => sum + c.outstanding, 0), true);
            App.Dashboard.animateCounter('customer-kpi-active', customers.filter(c => c.status === 'Active').length);
        }
        App.Auth.checkRole(); 
        const headerActions = document.querySelector('#customers-page .card-header .d-flex.gap-2.flex-wrap');
        if (headerActions && !document.getElementById('view-toggle-list')) {
            const toggleHTML = `<div class="btn-group" style="display:inline-flex; margin-right: 10px;"><button class="btn btn-outline ${this.viewMode === 'list' ? 'active' : ''}" id="view-toggle-list" style="border-radius: 8px 0 0 8px;"><i class="fas fa-list"></i></button><button class="btn btn-outline ${this.viewMode === 'board' ? 'active' : ''}" id="view-toggle-board" style="border-radius: 0 8px 8px 0;"><i class="fas fa-columns"></i></button></div>`;
            headerActions.insertAdjacentHTML('afterbegin', toggleHTML);
        }
        document.getElementById('view-toggle-list')?.classList.toggle('active', this.viewMode === 'list');
        document.getElementById('view-toggle-board')?.classList.toggle('active', this.viewMode === 'board');
        const filteredCustomers = this.getCurrentFilteredData();
        const tableContainer = document.querySelector('#customers-page .table-container');
        const pagination = document.getElementById('customers-pagination');
        if (this.viewMode === 'board') {
            tableContainer.style.display = 'none'; pagination.style.display = 'none'; this.renderBoardView(filteredCustomers);
        } else {
            tableContainer.style.display = 'block'; pagination.style.display = 'flex';
            const existingBoard = document.getElementById('kanban-board-container'); if(existingBoard) existingBoard.remove();
            const { currentPage, rowsPerPage } = App.state.pagination.customers; const startIndex = (currentPage - 1) * rowsPerPage; const paginatedCustomers = filteredCustomers.slice(startIndex, startIndex + rowsPerPage);
            this.renderListView(paginatedCustomers); App.UI.renderPaginationControls('customers', filteredCustomers.length);
        }
    }, 

    renderListView: function(customers) {
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const customerForecasts = App.DB.get('customerForecasts');
        const currentMonthStr = `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`;
        const allPayments = App.DB.get('payments');
        const allVisits = App.DB.get('visits');
        const searchTerm = document.getElementById('customer-search').value.trim();
        const tbody = document.getElementById('customer-table-body'); 
        if (customers.length > 0) {
            tbody.innerHTML = customers.map(c => {
                const health = App.Helpers.calculateCustomerHealth(c, allPayments, allVisits);
                const healthDot = `<span class="health-dot ${health.status}" title="${health.title}"></span>`;
                const currentForecast = customerForecasts.find(f => f.accountNo === c.accountNo && f.month === currentMonthStr)?.amount || 0;
                const promiseIcon = App.DB.get('visits').some(v => v.customerId === c.accountNo && v.outcome === 'Promise to Pay' && v.promiseDate && v.promiseDate >= new Date().toISOString().slice(0,10)) ? '<span title="Has active promise"> </span>' : '';
                const tagsHTML = c.tags && c.tags.length > 0 ? c.tags.map(tag => App.Helpers.getTagHTML(tag, 'clickable-tag')).join('') : '';
                const cPayments = allPayments.filter(p => p.customerId === c.accountNo && p.status === 'Completed').sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
                let historyPoints = [c.outstanding]; let runningBalance = c.outstanding;
                cPayments.forEach(p => { runningBalance += p.amount; historyPoints.push(runningBalance); });
                const sparklineSVG = App.Helpers.createSparkline(historyPoints.reverse());
                const displayAccount = App.Helpers.highlightMatch(c.accountNo, searchTerm);
                const displayCompany = App.Helpers.highlightMatch(c.companyName, searchTerm);
                const displayConsultant = App.Helpers.highlightMatch(consultantMap[c.salesConsultantId] || 'N/A', searchTerm);
                let rowHTML = '<tr>';
                if (App.state.customerTableColumns.accountNo) rowHTML += `<td>${displayAccount}</td>`;
                if (App.state.customerTableColumns.companyName) rowHTML += `<td><div class="company-info d-flex align-items-center"><div class="name">${healthDot}${displayCompany}${promiseIcon}</div><div class="location" style="color: var(--text-secondary); font-size: var(--fs-sm);">${tagsHTML}</div></div></td>`;
                if (App.state.customerTableColumns.customerStatus) rowHTML += `<td>${c.customerStatus || 'N/A'}</td>`;
                if (App.state.customerTableColumns.agingCategory) rowHTML += `<td>${c.agingCategory || 'N/A'}</td>`;
                if (App.state.customerTableColumns.outstanding) rowHTML += `<td><div class="d-flex align-items-center">${App.Helpers.formatCurrency(c.outstanding)} ${sparklineSVG}</div></td>`;
                if (App.state.customerTableColumns.balance_2020_2025) rowHTML += `<td>${App.Helpers.formatCurrency(c.balance_2020_2025 || 0)}</td>`;
                if (App.state.customerTableColumns.balance_2019_2020) rowHTML += `<td>${App.Helpers.formatCurrency(c.balance_2019_2020 || 0)}</td>`;
                if (App.state.customerTableColumns.balance_lte_2018) rowHTML += `<td>${App.Helpers.formatCurrency(c.balance_lte_2018 || 0)}</td>`;
                if (App.state.customerTableColumns.forecastAmount) rowHTML += `<td>${App.Helpers.formatCurrency(currentForecast)}</td>`;
                if (App.state.customerTableColumns.salesConsultantId) rowHTML += `<td>${displayConsultant}</td>`;
                if (App.state.customerTableColumns.paymentStatus) rowHTML += `<td><span class="status-badge ${c.paymentStatus.toLowerCase().replace(' ', '-')}">${c.paymentStatus}</span></td>`;
                if (App.state.customerTableColumns.email) rowHTML += `<td>${App.Helpers.highlightMatch(c.email || 'N/A', searchTerm)}</td>`;
                if (App.state.customerTableColumns.mobile) rowHTML += `<td>${App.Helpers.highlightMatch(c.mobile || 'N/A', searchTerm)}</td>`;
                
                rowHTML += `<td class="d-flex gap-2"><button class="btn btn-outline view-customer" data-id="${c.accountNo}" title="View"><i class="fas fa-eye"></i></button><button class="btn btn-outline edit-customer" data-id="${c.accountNo}" title="Edit"><i class="fas fa-edit"></i></button>${App.state.currentUser.role === 'user' ? `<button class="btn btn-outline set-forecast" data-id="${c.accountNo}" title="Set Forecast"><i class="fas fa-bullseye"></i></button>` : ''}${App.state.currentUser.role === 'admin' ? `<button class="btn btn-danger delete-customer" data-id="${c.accountNo}" title="Delete"><i class="fas fa-trash"></i></button>` : ''}</td></tr>`;
                return rowHTML;
            }).join('');
        } else { tbody.innerHTML = `<tr><td colspan="100%">${App.UI.getEmptyStateHTML('fa-users-slash', 'No Customers Found', 'Try adjusting your filters.', '')}</td></tr>`; }
        App.UI.animateTableRows(tbody); App.UI.updateSortIndicators('customers');
    },

    renderBoardView: function(customers) {
        let container = document.getElementById('kanban-board-container');
        if (!container) { container = document.createElement('div'); container.id = 'kanban-board-container'; container.className = 'kanban-container'; const pageCard = document.querySelector('#customers-page .card'); pageCard.appendChild(container); } container.innerHTML = '';
        const columns = ['Negotiation', 'Settlement', 'Legal', 'Write-Off']; const columnColors = { 'Negotiation': '#ffc107', 'Settlement': '#0d6efd', 'Legal': '#dc3545', 'Write-Off': '#6c757d' };
        columns.forEach(status => {
            const colCustomers = customers.filter(c => c.paymentStatus === status); const totalVal = colCustomers.reduce((sum, c) => sum + c.outstanding, 0);
            const colDiv = document.createElement('div'); colDiv.className = 'kanban-column'; colDiv.innerHTML = `<div class="kanban-header" style="border-top: 4px solid ${columnColors[status]};"><div>${status} <span style="background:var(--bg-color); padding:2px 6px; border-radius:10px; font-size:0.8em; margin-left:5px;">${colCustomers.length}</span></div><div style="font-size:0.8em; color:var(--text-secondary);">${App.Helpers.formatAbbreviatedCurrency(totalVal)}</div></div><div class="kanban-body" data-status="${status}"></div>`;
            const body = colDiv.querySelector('.kanban-body');
            body.addEventListener('dragover', e => { e.preventDefault(); colDiv.classList.add('drag-over'); });
            body.addEventListener('dragleave', () => colDiv.classList.remove('drag-over'));
            body.addEventListener('drop', e => { e.preventDefault(); colDiv.classList.remove('drag-over'); const accountNo = e.dataTransfer.getData('text/plain'); this.updateCustomerStatus(accountNo, status); });
            colCustomers.forEach(c => {
                const card = document.createElement('div'); card.className = 'kanban-card'; card.draggable = true; card.innerHTML = `<div style="font-weight:600; margin-bottom:5px;">${c.companyName}</div><div style="font-size:0.85em; color:var(--text-secondary); margin-bottom:8px;">${c.accountNo}</div><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:700; color:var(--primary);">${App.Helpers.formatCurrency(c.outstanding)}</span><button class="btn btn-outline btn-sm view-customer" data-id="${c.accountNo}" style="padding: 2px 6px;"><i class="fas fa-eye"></i></button></div>`;
                card.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', c.accountNo); card.classList.add('dragging'); });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
                card.querySelector('.view-customer').addEventListener('click', (e) => { e.stopPropagation(); this.showCustomerDetail(c.accountNo); });
                body.appendChild(card);
            });
            container.appendChild(colDiv);
        });
    },

    updateCustomerStatus: function(accountNo, newStatus) {
        let customers = App.DB.get('customers'); const index = customers.findIndex(c => c.accountNo === accountNo);
        if (index > -1 && customers[index].paymentStatus !== newStatus) { const oldStatus = customers[index].paymentStatus; customers[index].paymentStatus = newStatus; App.DB.set('customers', customers); App.Helpers.logChange('Updated', 'Customer', `${customers[index].companyName}`, `Status changed: ${oldStatus} -> ${newStatus}`); App.UI.toast(`Moved to ${newStatus}`, 'success'); this.render(); }
    },

    renderColumnToggle() {
        const allColumns = { accountNo: 'Account #', companyName: 'Company Name', customerStatus: 'Customer Status', agingCategory: 'Aging Category', outstanding: 'Balance', balance_2020_2025: '2020-2025', balance_2019_2020: '2019-2020', balance_lte_2018: '<=2018', forecastAmount: 'Forecast', salesConsultantId: 'Consultant', paymentStatus: 'Payment Status', email: 'Email', mobile: 'Mobile' };
        const dropdown = document.getElementById('column-toggle-dropdown');
        dropdown.innerHTML = Object.entries(allColumns).map(([key, label]) => `<label><input type="checkbox" class="column-toggle-checkbox" data-column="${key}" ${App.state.customerTableColumns[key] ? 'checked' : ''}> ${label}</label>`).join('');
        const thead = document.querySelector('#customers-page .data-table thead');
        let headerHTML = '<tr>'; Object.entries(App.state.customerTableColumns).forEach(([key, isVisible]) => { if (isVisible) { headerHTML += `<th data-sort="${key}">${allColumns[key]}</th>`; } }); headerHTML += '<th>Actions</th></tr>';
        thead.innerHTML = headerHTML;
        document.querySelectorAll('.column-toggle-checkbox').forEach(checkbox => { checkbox.removeEventListener('change', this.handleColumnToggle); checkbox.addEventListener('change', this.handleColumnToggle.bind(this)); });
    },
    handleColumnToggle(e) { const column = e.target.dataset.column; App.state.customerTableColumns[column] = e.target.checked; localStorage.setItem('customerTableColumns', JSON.stringify(App.state.customerTableColumns)); this.render(); },
    
    showCustomerForm: function(accountNo = null) { 
        const form = document.getElementById('customer-form'); const accountNoInput = form.elements.accountNo; form.reset(); 
        const consultantSelect = form.elements['salesConsultantId']; consultantSelect.innerHTML = App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join(''); let originalCustomer = null; 
        form.querySelectorAll('[data-admin-only="true"]').forEach(el => el.style.display = App.state.currentUser.role === 'admin' ? '' : 'none');
        if (accountNo) { 
            const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); originalCustomer = {...customer}; document.getElementById('customer-modal-title').textContent = 'Edit Customer'; document.getElementById('customer-id-hidden').value = customer.accountNo; 
            Object.keys(customer).forEach(key => { if (form.elements[key]) form.elements[key].value = customer[key]; }); 
            form.elements['customer-tags'].value = customer.tags ? customer.tags.join(', ') : ''; accountNoInput.readOnly = true; accountNoInput.required = false; 
            // Populate GPS fields if available
            if(form.elements['latitude']) form.elements['latitude'].value = customer.latitude || '';
            if(form.elements['longitude']) form.elements['longitude'].value = customer.longitude || '';
        } else { 
            document.getElementById('customer-modal-title').textContent = 'Add New Customer'; document.getElementById('customer-id-hidden').value = ''; accountNoInput.readOnly = false; accountNoInput.required = true; accountNoInput.placeholder = 'e.g., DXB-007'; 
        } 
        App.UI.openModal('customer-modal'); form.originalData = originalCustomer; 
    }, 
    
    saveCustomer: async function(e) { 
        e.preventDefault(); const form = e.target; const id = form.elements['customer-id-hidden'].value; let customers = App.DB.get('customers'); const isAdmin = App.state.currentUser.role === 'admin'; const tags = form.elements['customer-tags'].value.split(',').map(tag => tag.trim()).filter(Boolean);
        let customerData = { paymentStatus: form.elements.paymentStatus.value, customerStatus: form.elements.customerStatus.value, tags: tags };
        if (isAdmin) {
            const bal_2020_2025 = parseFloat(form.elements.balance_2020_2025.value) || 0; const bal_2019_2020 = parseFloat(form.elements.balance_2019_2020.value) || 0; const bal_lte_2018 = parseFloat(form.elements.balance_lte_2018.value) || 0;
            
            // --- GPS LOGIC ---
            let finalLat, finalLng;
            const inputLat = parseFloat(form.elements.latitude.value);
            const inputLng = parseFloat(form.elements.longitude.value);
            
            if (!isNaN(inputLat) && !isNaN(inputLng)) {
                finalLat = inputLat;
                finalLng = inputLng;
            } else {
                // Fallback to address geocoding if fields are empty
                const addressString = `${form.elements.area.value}, ${form.elements.emirate.value}`; 
                const coords = await App.Geo.geocodeAddress(addressString, form.elements.accountNo.value);
                finalLat = coords.lat;
                finalLng = coords.lng;
            }
            // ----------------

            Object.assign(customerData, { companyName: form.elements.companyName.value, email: form.elements.email.value, mobile: form.elements.mobile.value, emirate: form.elements.emirate.value, area: form.elements.area.value, latitude: finalLat, longitude: finalLng, initialDebt: parseFloat(form.elements.initialDebt.value), outstanding: bal_2020_2025 + bal_2019_2020 + bal_lte_2018, balance_2020_2025: bal_2020_2025, balance_2019_2020: bal_2019_2020, balance_lte_2018: bal_lte_2018, salesConsultantId: parseInt(form.elements.salesConsultantId.value), status: form.elements.status.value, debtSince: form.elements.debtSince.value, agingCategory: App.Helpers.calculateAgingCategory(form.elements.debtSince.value) });
        }
        if (id) { const index = customers.findIndex(c => c.accountNo === id); const original = form.originalData; if (isAdmin) { customerData.agingCategory = App.Helpers.calculateAgingCategory(form.elements.debtSince.value); } const changes = App.Helpers.getObjectChanges(original, {...original, ...customerData}); customers[index] = { ...customers[index], ...customerData }; App.Helpers.logChange('Updated', 'Customer', `${customers[index].companyName} (${id})`, changes); } else { const newAccountNo = form.elements.accountNo.value.trim(); if (!newAccountNo) { App.UI.toast('Account Number is required.', 'error'); return; } const accountExists = customers.some(c => c.accountNo.toLowerCase() === newAccountNo.toLowerCase()); if (accountExists) { App.UI.toast('Account Number already exists.', 'error'); return; } customerData.accountNo = newAccountNo; customers.push(customerData); App.Helpers.logActivity('added a new customer', customerData.companyName, customerData.accountNo); App.Helpers.logChange('Created', 'Customer', `${customerData.companyName} (${newAccountNo})`); } 
        App.DB.set('customers', customers); App.UI.closeModal('customer-modal'); App.UI.toast(`Customer ${id ? 'updated' : 'added'}!`); this.render(); 
    },

    showCustomerForecastForm(accountNo) { const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); if (!customer) return App.UI.toast('Customer not found.', 'error'); document.getElementById('customer-forecast-modal-title').textContent = `Monthly Forecasts for ${customer.companyName}`; const form = document.getElementById('customer-forecast-form'); form.reset(); form.elements['customer-forecast-accountNo'].value = customer.accountNo; form.elements['customer-forecast-id-hidden'].value = ''; const now = new Date(); App.Helpers.populateMonthYearDropdowns('customer-forecast-month-select', 'customer-forecast-year-select', now.getMonth(), now.getFullYear()); form.elements['customer-forecast-month-select'].disabled = false; form.elements['customer-forecast-year-select'].disabled = false; this.renderForecastsForCustomer(accountNo); App.UI.openModal('customer-forecast-modal'); },
    renderForecastsForCustomer(accountNo) { const customerForecasts = App.DB.get('customerForecasts').filter(f => f.accountNo === accountNo).sort((a, b) => b.month.localeCompare(a.month)); const tbody = document.getElementById('existing-customer-forecasts-body'); tbody.innerHTML = customerForecasts.length > 0 ? customerForecasts.map(f => `<tr><td>${f.month}</td><td>${App.Helpers.formatCurrency(f.amount)}</td><td><div class="d-flex gap-2"><button class="btn btn-outline edit-customer-forecast" data-id="${f.id}"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-customer-forecast" data-id="${f.id}"><i class="fas fa-trash"></i></button></div></td></tr>`).join('') : '<tr><td colspan="3">No forecasts found.</td></tr>'; App.UI.animateTableRows(tbody); },
    editCustomerForecast(forecastId) { const forecast = App.DB.get('customerForecasts').find(f => f.id === forecastId); if (!forecast) return; const form = document.getElementById('customer-forecast-form'); form.elements['customer-forecast-id-hidden'].value = forecast.id; const [year, month] = forecast.month.split('-'); App.Helpers.populateMonthYearDropdowns('customer-forecast-month-select', 'customer-forecast-year-select', parseInt(month, 10) - 1, parseInt(year, 10)); form.elements['customer-forecast-month-select'].disabled = true; form.elements['customer-forecast-year-select'].disabled = true; form.elements['customer-forecast-amount'].value = forecast.amount; form.elements['customer-forecast-amount'].focus(); },
    deleteCustomerForecast(forecastId) { const forecasts = App.DB.get('customerForecasts'); const forecast = forecasts.find(f => f.id === forecastId); if (!forecast) return; App.UI.confirm('Delete this forecast?', `Are you sure you want to delete the forecast for ${forecast.month}?`, () => { const updatedForecasts = forecasts.filter(f => f.id !== forecastId); App.DB.set('customerForecasts', updatedForecasts); App.Helpers.logChange('Deleted', 'Customer Forecast', `for ${forecast.accountNo} on ${forecast.month}`); App.UI.toast('Forecast deleted.', 'success'); this.renderForecastsForCustomer(forecast.accountNo); if (App.state.activePage === 'performance') App.Performance.render(); }, '#customer-forecast-modal'); },
    saveCustomerForecast(e) { e.preventDefault(); const form = e.target; const accountNo = form.elements['customer-forecast-accountNo'].value; const monthVal = form.elements['customer-forecast-month-select'].value; const yearVal = form.elements['customer-forecast-year-select'].value; const amount = parseFloat(form.elements['customer-forecast-amount'].value); const forecastId = form.elements['customer-forecast-id-hidden'].value; if (!monthVal || !yearVal || isNaN(amount) || amount < 0) { App.UI.toast('Please select a valid month/year and amount.', 'error'); return; } const month = `${yearVal}-${monthVal}`; let forecasts = App.DB.get('customerForecasts'); if (forecastId) { const index = forecasts.findIndex(f => f.id === forecastId); if (index > -1) { forecasts[index].amount = amount; App.Helpers.logChange('Updated', 'Customer Forecast', `for ${accountNo} on ${month}`, `New amount: ${App.Helpers.formatCurrency(amount)}`); } } else { const existingIndex = forecasts.findIndex(f => f.accountNo === accountNo && f.month === month); if (existingIndex > -1) { forecasts[existingIndex].amount = amount; App.Helpers.logChange('Updated', 'Customer Forecast', `for ${accountNo} on ${month}`, `New amount: ${App.Helpers.formatCurrency(amount)}`); } else { const newForecast = { id: `cf-${Date.now()}`, accountNo, month, amount }; forecasts.push(newForecast); App.Helpers.logChange('Created', 'Customer Forecast', `for ${accountNo} on ${month}`, `Amount: ${App.Helpers.formatCurrency(amount)}`); } } App.DB.set('customerForecasts', forecasts); App.UI.toast('Forecast saved!', 'success'); form.reset(); form.elements['customer-forecast-id-hidden'].value = ''; form.elements['customer-forecast-accountNo'].value = accountNo; const now = new Date(); App.Helpers.populateMonthYearDropdowns('customer-forecast-month-select', 'customer-forecast-year-select', now.getMonth(), now.getFullYear()); form.elements['customer-forecast-month-select'].disabled = false; form.elements['customer-forecast-year-select'].disabled = false; this.renderForecastsForCustomer(accountNo); if (App.state.activePage === 'customers') this.render(); if (App.state.activePage === 'performance') App.Performance.render(); },
    showBulkUpdateModal() { const filteredCustomers = this.getCurrentFilteredData(); if (filteredCustomers.length === 0) { return App.UI.toast('No customers match the current filter criteria for a bulk update.', 'warning'); } document.getElementById('bulk-update-count-msg').textContent = `Applying update to ${filteredCustomers.length} filtered customer(s).`; const consultantSelect = document.getElementById('bulk-update-consultant'); consultantSelect.innerHTML = '<option value="">-- Do Not Change --</option>' + App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join(''); App.UI.openModal('bulk-update-customers-modal'); },
    performBulkUpdate(e) { e.preventDefault(); const form = e.target; const consultantId = form.elements['bulk-update-consultant'].value; const status = form.elements['bulk-update-status'].value; const paymentStatus = form.elements['bulk-update-payment-status'].value; if (!consultantId && !status && !paymentStatus) { return App.UI.toast('Please select at least one field to update.', 'warning'); } App.UI.confirm('Confirm Bulk Update', 'Are you sure you want to apply this update to ALL currently filtered customers?', () => { let customers = App.DB.get('customers'); const filteredCustomers = this.getCurrentFilteredData(); let updatedCount = 0; let changesLog = []; filteredCustomers.forEach(filteredCustomer => { const customerIndex = customers.findIndex(c => c.accountNo === filteredCustomer.accountNo); if (customerIndex > -1) { const original = { ...customers[customerIndex] }; let updated = false; if (consultantId) { customers[customerIndex].salesConsultantId = parseInt(consultantId); updated = true; } if (status) { customers[customerIndex].status = status; updated = true; } if (paymentStatus) { customers[customerIndex].paymentStatus = paymentStatus; updated = true; } if (updated) { updatedCount++; const changes = App.Helpers.getObjectChanges(original, customers[customerIndex]); changesLog.push(`Updated ${customers[customerIndex].companyName} (${customers[customerIndex].accountNo}): ${changes}`); } } }); App.DB.set('customers', customers); if (updatedCount > 0) { App.Helpers.logChange('Bulk Updated', 'Customers', `${updatedCount} records`, changesLog.join('; ')); App.UI.toast(`Successfully updated ${updatedCount} customers!`, 'success'); } else { App.UI.toast('No customers were updated.', 'info'); } App.UI.closeModal('bulk-update-customers-modal'); this.render(); }, '#bulk-update-customers-modal'); },
    showCustomerDetail: function(accountNo) { App.state.activeCustomerId = accountNo; const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {}); if (!customer) return; const visits = App.DB.get('visits').filter(v => v.customerId === accountNo && v.status === 'Completed').sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime)); const payments = App.DB.get('payments').filter(p => p.customerId === accountNo && p.status === 'Completed').sort((a,b) => new Date(b.date) - new Date(a.date)); const lastVisitDate = visits[0] ? App.Helpers.formatDate(visits[0].dateTime) : 'N/A'; const lastPaymentDate = payments[0] ? App.Helpers.formatDate(payments[0].date) : 'N/A'; document.getElementById('customer-detail-title').innerHTML = `Customer: ${customer.companyName} <span style="color:var(--text-secondary); font-weight:500;">(${customer.accountNo})</span>`; this.renderDetailOverview(customer, consultantMap, lastVisitDate, lastPaymentDate); this.renderDetailTimeline(customer); this.renderComments(accountNo); this.switchDetailTab('overview'); App.UI.openModal('customer-detail-modal'); }, 
    renderDetailOverview: function(customer, consultantMap, lastVisitDate, lastPaymentDate) { 
        const tagsHTML = customer.tags && customer.tags.length > 0 ? `<div class="detail-info-card full-width"><div class="label">Tags</div><div class="value">${customer.tags.map(tag => App.Helpers.getTagHTML(tag)).join('')}</div></div>` : '';
        let actionsHTML = '<span class="text-secondary">No contact info</span>';
        if (customer.mobile) { 
            const cleanNumber = customer.mobile.replace(/[^0-9]/g, ''); const message = `Hello ${customer.companyName}, regarding account ${customer.accountNo}. Outstanding: ${App.Helpers.formatCurrency(customer.outstanding)}.`; const waBtn = `<a href="https://wa.me/${cleanNumber}?text=${encodeURIComponent(message)}" target="_blank" class="btn btn-success btn-sm" style="background-color: #25D366; border-color: #25D366; padding: 4px 10px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px;"><i class="fab fa-whatsapp"></i> Chat</a>`; 
            let mapUrl = `http://googleusercontent.com/maps.google.com/9{encodeURIComponent(customer.area + ' ' + customer.emirate)}`; if (customer.latitude && customer.longitude) { mapUrl = `http://googleusercontent.com/maps.google.com/9{customer.latitude},${customer.longitude}`; } 
            const mapBtn = `<a href="${mapUrl}" target="_blank" class="btn btn-outline btn-sm" style="padding: 4px 10px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px;"><i class="fas fa-map-marker-alt"></i> Navigate</a>`; actionsHTML = `<div class="d-flex align-items-center gap-2"><span>${customer.mobile}</span> ${waBtn} ${mapBtn}</div>`; 
        }
        document.getElementById('overview-content').innerHTML = `<div class="d-flex justify-content-end mb-4"><button class="btn btn-outline" id="generate-soa-btn" data-id="${customer.accountNo}"><i class="fas fa-file-invoice"></i> Download Statement of Account</button></div><div class="detail-info-grid"><div class="detail-info-card"><div class="label">Account #</div><div class="value">${customer.accountNo}</div></div><div class="detail-info-card"><div class="label">Location</div><div class="value">${customer.area}, ${customer.emirate}</div></div><div class="detail-info-card"><div class="label">Account Status</div><div class="value"><span class="status-badge ${customer.status.toLowerCase()}">${customer.status}</span></div></div><div class="detail-info-card"><div class="label">Payment Status</div><div class="value"><span class="status-badge ${customer.paymentStatus.toLowerCase().replace(' ', '-')}">${customer.paymentStatus}</span></div></div><div class="detail-info-card"><div class="label">Outstanding</div><div class="value" style="font-weight: 700; color: var(--primary);">${App.Helpers.formatCurrency(customer.outstanding)}</div></div><div class="detail-info-card"><div class="label">Sales Consultant</div><div class="value">${consultantMap[customer.salesConsultantId] || 'N/A'}</div></div><div class="detail-info-card"><div class="label">Last Visit</div><div class="value">${lastVisitDate}</div></div><div class="detail-info-card"><div class="label">Last Payment</div><div class="value">${lastPaymentDate}</div></div><div class="detail-info-card"><div class="label">Email</div><div class="value">${customer.email || 'N/A'}</div></div><div class="detail-info-card full-width"><div class="label">Actions</div><div class="value">${actionsHTML}</div></div>${tagsHTML}</div>`;
        document.getElementById('generate-soa-btn').addEventListener('click', () => this.generateSOA(customer.accountNo));
    }, 
    renderDetailTimeline: function(customer) {
        const payments = App.DB.get('payments').filter(p => p.customerId === customer.accountNo); const visits = App.DB.get('visits').filter(v => v.customerId === customer.accountNo); const comments = App.DB.get('customerComments').filter(c => c.accountNo === customer.accountNo); const changes = App.DB.get('changeLog').filter(l => (l.entityType === 'Customer' && l.entityName.includes(`(${customer.accountNo})`)) || (l.entityType === 'Payment' && l.details.includes(customer.accountNo)));
        let events = [];
        payments.forEach(p => { events.push({ type: 'Payment', timestamp: new Date(p.date).getTime(), icon: 'fa-file-invoice-dollar', color: 'var(--success)', title: `Payment Received: ${App.Helpers.formatCurrency(p.amount)}`, detail: `Method: ${p.method} <span class="status-badge ${p.status.toLowerCase()}">${p.status}</span>` }); });
        visits.forEach(v => { const isDone = v.status === 'Completed'; let badgeHTML = ''; if (isDone && v.verificationStatus) { if (v.verificationStatus === 'Verified On-Site') { badgeHTML = `<span style="color:var(--success); font-weight:600; font-size:0.8em; border:1px solid var(--success); border-radius:4px; padding:1px 6px; margin-left:8px;"><i class="fas fa-shield-alt"></i> Verified On-Site</span>`; } else if (v.verificationStatus === 'Remote Update') { badgeHTML = `<span style="color:var(--text-secondary); font-weight:500; font-size:0.8em; border:1px solid var(--border-color); border-radius:4px; padding:1px 6px; margin-left:8px;"><i class="fas fa-laptop"></i> Remote Update</span>`; } } events.push({ type: 'Visit', timestamp: new Date(v.dateTime).getTime(), icon: isDone ? 'fa-check-circle' : 'fa-calendar-alt', color: isDone ? 'var(--primary)' : 'var(--text-secondary)', title: `${v.purpose} (${v.status}) ${badgeHTML} <span style="font-size:0.8em; color:var(--text-secondary); margin-left:5px;">(${v.duration || 0} min)</span>`, detail: `<strong>Outcome:</strong> ${v.outcome || 'Pending'} <br> ${v.notes ? App.Helpers.stripHtml(v.notes) : ''}` }); });
        comments.forEach(c => { events.push({ type: 'Comment', timestamp: c.timestamp, icon: 'fa-comment-dots', color: 'var(--warning)', title: `Comment by ${c.author}`, detail: c.text }); });
        changes.forEach(c => { events.push({ type: 'System', timestamp: c.timestamp, icon: 'fa-cog', color: 'var(--text-secondary)', title: `${c.action} by ${c.user}`, detail: `<span style="font-family: monospace; font-size: 0.85em;">${c.details || 'No details'}</span>` }); });
        events.sort((a, b) => b.timestamp - a.timestamp);
        let timelineHTML = '<ul class="timeline">'; if (events.length > 0) { events.forEach(e => { const dateStr = new Date(e.timestamp).toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }); timelineHTML += `<li class="timeline-item" style="padding-left: 2rem;"><div style="position: absolute; left: -9px; top: 0; background: var(--card-bg); padding: 5px;"><i class="fas ${e.icon}" style="color: ${e.color}; font-size: 1.1rem;"></i></div><div class="timeline-item-header" style="display: flex; justify-content: space-between; align-items: flex-start;"><div>${e.title}</div><span style="font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; margin-left: 10px;">${dateStr}</span></div><div class="timeline-item-body" style="margin-top: 4px; color: var(--text-primary);">${e.detail}</div></li>`; }); } else { timelineHTML += `<li style="list-style: none; padding: 1rem; color: var(--text-secondary); text-align: center;">No history recorded.</li>`; } timelineHTML += '</ul>'; document.getElementById('timeline-content').innerHTML = timelineHTML;
    },
    renderComments(accountNo) {
        const commentsContainer = document.getElementById('comments-content'); const comments = App.DB.get('customerComments').filter(c => c.accountNo === accountNo).sort((a, b) => b.timestamp - a.timestamp);
        let commentsHTML = `<div class="form-group"><label for="new-comment-input">Add a new comment</label><textarea id="new-comment-input" class="form-control" rows="3" placeholder="Type your comment..."></textarea></div><button id="add-comment-btn" class="btn btn-primary mb-4">Add Comment</button><div id="comments-list">`;
        if (comments.length > 0) { commentsHTML += comments.map(comment => `<div class="comment-item"><div class="comment-header"><span class="comment-author">${comment.author}</span><span class="comment-date">${new Date(comment.timestamp).toLocaleString()}</span></div><p class="comment-body">${comment.text}</p></div>`).join(''); } else { commentsHTML += `<p>No comments for this customer yet.</p>`; } commentsHTML += `</div>`; commentsContainer.innerHTML = commentsHTML;
    },
    addComment(accountNo) { const input = document.getElementById('new-comment-input'); const text = input.value.trim(); if (!text) return App.UI.toast('Comment cannot be empty.', 'warning'); const allComments = App.DB.get('customerComments'); const newComment = { id: `comment-${Date.now()}`, accountNo: accountNo, text: text, author: App.state.currentUser.fullName, timestamp: Date.now() }; allComments.push(newComment); App.DB.set('customerComments', allComments); App.Helpers.logChange('Added', 'Comment', `for customer ${accountNo}`); input.value = ''; this.renderComments(accountNo); App.UI.toast('Comment added!', 'success'); },
    switchDetailTab: function(tabId) { 
        document.querySelectorAll('.detail-tab-btn').forEach(btn => btn.classList.remove('active')); document.querySelector(`.detail-tab-btn[data-tab="${tabId}"]`)?.classList.add('active'); document.querySelectorAll('#customer-detail-content .tab-content').forEach(c => c.classList.add('hidden')); document.getElementById(`${tabId}-content`).classList.remove('hidden'); 
        if (tabId === 'calculator') { this.renderCalculator(App.state.activeCustomerId); }
    },
    renderCalculator: function(accountNo) {
        const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); if (!customer) return;
        const container = document.getElementById('calculator-content'); container.innerHTML = `<div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; align-items: end;"><div class="form-group"><label>Total Outstanding</label><input type="text" value="${App.Helpers.formatCurrency(customer.outstanding)}" class="form-control" disabled style="background: var(--border-color);"><input type="hidden" id="calc-total" value="${customer.outstanding}"></div><div class="form-group"><label>Down Payment (AED)</label><input type="number" id="calc-down" class="form-control" value="0" min="0"></div><div class="form-group"><label>Duration (Months)</label><input type="number" id="calc-months" class="form-control" value="3" min="1" max="60"></div></div><div class="card mt-4" style="background: var(--bg-color); border: 1px dashed var(--border-color);"><div class="d-flex justify-content-between align-items-center p-3"><div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">Estimated Monthly Installment</div><div id="calc-monthly-result" style="font-size: var(--fs-2xl); font-weight: 700; color: var(--primary);">AED 0.00</div></div><div style="text-align: right;"><div style="font-size: var(--fs-sm); color: var(--text-secondary);">Balance after Down Payment</div><div id="calc-balance-result" style="font-size: var(--fs-lg); font-weight: 600;">AED 0.00</div></div></div><div class="table-container p-3" style="max-height: 200px; overflow-y: auto;"><table class="data-table" style="font-size: var(--fs-sm);"><thead><tr><th>Installment #</th><th>Due Date</th><th>Amount</th></tr></thead><tbody id="calc-schedule-body"></tbody></table></div></div>`;
        const inputs = container.querySelectorAll('input'); inputs.forEach(input => input.addEventListener('input', () => this.updatePaymentPlan())); this.updatePaymentPlan();
    },
    updatePaymentPlan: function() {
        const total = parseFloat(document.getElementById('calc-total').value) || 0; const down = parseFloat(document.getElementById('calc-down').value) || 0; const months = parseInt(document.getElementById('calc-months').value) || 1;
        const balance = Math.max(0, total - down); const monthly = months > 0 ? balance / months : 0;
        document.getElementById('calc-balance-result').textContent = App.Helpers.formatCurrency(balance); document.getElementById('calc-monthly-result').textContent = App.Helpers.formatCurrency(monthly);
        const tbody = document.getElementById('calc-schedule-body'); let html = ''; let currentDate = new Date();
        for (let i = 1; i <= months; i++) { currentDate.setMonth(currentDate.getMonth() + 1); const dateStr = currentDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }); html += `<tr><td>${i}</td><td>${dateStr}</td><td>${App.Helpers.formatCurrency(monthly)}</td></tr>`; } tbody.innerHTML = html;
    },
    generateSOA: function(accountNo) {
        const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); const payments = App.DB.get('payments').filter(p => p.customerId === accountNo && p.status === 'Completed').sort((a,b) => new Date(a.date) - new Date(b.date)); if (!customer) return;
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFillColor(226, 0, 15); doc.rect(0, 0, 210, 40, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.text("Statement of Account", 14, 25);
        doc.setTextColor(0, 0, 0); doc.setFontSize(12); doc.text(`To: ${customer.companyName}`, 14, 55); doc.text(`Account No: ${customer.accountNo}`, 14, 62); doc.text(`Location: ${customer.area}, ${customer.emirate}`, 14, 69); doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 55);
        let balance = customer.initialDebt; const rows = []; rows.push([ customer.debtSince || 'N/A', 'Opening Balance / Initial Debt', '-', App.Helpers.formatCurrency(customer.initialDebt), App.Helpers.formatCurrency(balance) ]);
        payments.forEach(p => { balance -= p.amount; rows.push([ p.date, `Payment Received (${p.method})`, App.Helpers.formatCurrency(p.amount), '-', App.Helpers.formatCurrency(balance) ]); });
        doc.autoTable({ startY: 80, head: [['Date', 'Description', 'Credit (Paid)', 'Debit (Due)', 'Balance']], body: rows, theme: 'striped', headStyles: { fillColor: [60, 60, 60] }, columnStyles: { 2: { textColor: [16, 185, 129] }, 4: { fontStyle: 'bold' } } });
        const finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(12); doc.text(`Total Outstanding: ${App.Helpers.formatCurrency(customer.outstanding)}`, 140, finalY, { align: 'right' });
        doc.save(`SOA_${customer.companyName.replace(/[^a-z0-9]/gi, '_')}.pdf`); App.UI.toast('Statement generated successfully!', 'success');
    },
    deleteCustomer(accountNo) { const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); Swal.fire({ title: `Delete ${customer.companyName}?`, text: "This will permanently delete the customer and all their associated payments and visits. This action cannot be undone.", input: 'textarea', inputLabel: 'Reason for deletion', inputPlaceholder: 'Enter your reason here...', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: 'var(--danger)', background: 'var(--card-bg)', color: 'var(--text-primary)', inputValidator: (value) => { if (!value) { return 'You must provide a reason for deletion!' } } }).then(result => { if (result.isConfirmed && result.value) { let customers = App.DB.get('customers'); let visits = App.DB.get('visits'); let payments = App.DB.get('payments'); let comments = App.DB.get('customerComments'); App.DB.set('customers', customers.filter(c => c.accountNo !== accountNo)); App.DB.set('visits', visits.filter(v => v.customerId !== accountNo)); App.DB.set('payments', payments.filter(p => p.customerId !== accountNo)); App.DB.set('customerComments', comments.filter(c => c.accountNo !== accountNo)); App.Helpers.logChange('Deleted', 'Customer', `${customer.companyName} (${accountNo})`, `Reason: ${result.value}`); App.UI.toast('Customer deleted permanently.', 'success'); this.render(); } }); } 
});

Object.assign(App.Visits, { 
    calendar: null, logNotesQuill: null, map: null, 

    setupEventListeners: function() { 
        document.getElementById('visit-notes-form').addEventListener('submit', e => this.saveCompletedVisit(e)); 
        document.getElementById('visit-form').addEventListener('submit', (e) => this.saveScheduledVisit(e)); 
        
        const page = document.getElementById('visits-page'); 
        const debouncedRender = App.Helpers.debounce(() => {App.state.pagination.visits.currentPage = 1; this.renderListView()}, 300); 

        page.addEventListener('click', (e) => { 
            const button = e.target.closest('button'); 
            if (!button) return; 

            if (button.classList.contains('start-visit-btn')) this.checkIn(button.dataset.id); 
            if (button.classList.contains('visit-view-tab')) this.switchView(button.dataset.view); 
            if (button.classList.contains('visit-filter-btn')) this.setFilter(button.dataset.filter); 
            if (button.id === 'visit-date-apply') this.applyDateFilter(); 
            if (button.classList.contains('mark-done-btn')) this.showMarkDoneModal(button.dataset.id); 
            if (button.classList.contains('view-visit-btn')) this.showVisitDetail(button.dataset.id); 
            if (button.id === 'schedule-visit-btn') this.showScheduleModal(); 
            if (button.id === 'plan-route-btn') this.showRoutePlannerModal(); 
            if (button.id === 'clear-route-btn') this.clearRoute(); 
            if (button.classList.contains('delete-visit')) this.deleteVisit(button.dataset.id); 
            if (button.id === 'set-visit-date-today') this.setQuickDate('today'); 
            if (button.id === 'set-visit-date-tomorrow') this.setQuickDate('tomorrow');
            if (button.id === 'export-visits-csv') App.Helpers.exportTableData('csv', 'Visits', this.getCurrentFilteredData, ['dateTime', 'customerId', 'purpose', 'collectorId', 'status']);
            if (button.id === 'export-visits-pdf') App.Helpers.exportTableData('pdf', 'Visits', this.getCurrentFilteredData, ['dateTime', 'customerId', 'purpose', 'collectorId', 'status']);
        }); 
    
        document.getElementById('visit-search').addEventListener('input', (e) => { App.state.visits.search = e.target.value; debouncedRender(); });
        document.getElementById('visit-consultant-filter').addEventListener('change', (e) => { App.state.pagination.visits.currentPage = 1; App.state.visits.consultantFilter = e.target.value; this.renderListView(); });
        document.getElementById('map-consultant-filter').addEventListener('change', (e) => { App.state.visits.mapConsultant = e.target.value; this.renderMapView(); });
        document.getElementById('map-date-filter').addEventListener('change', (e) => { App.state.visits.mapDate = e.target.value; this.renderMapView(); });
        document.querySelector('#visits-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('visits', th.dataset.sort); });
        document.getElementById('route-planner-form').addEventListener('submit', (e) => this.generateRoute(e));
        
        const visitNotesModal = document.getElementById('visit-notes-modal');
        visitNotesModal.addEventListener('click', e => { 
            const button = e.target.closest('button');
            if (!button) return;
            if (button.id === 'log-location-btn') this.tagLocationForVisitLog(); 
            if (button.id === 'log-record-payment-btn') {
                const visitId = document.getElementById('mark-done-visit-id').value;
                const visit = App.DB.get('visits').find(v => v.id === visitId);
                if (visit) {
                    App.state.paymentFlowOrigin = { visitId: visit.id, paymentLogged: false };
                    App.Payments.showPaymentForm(visit.customerId);
                }
            }
        }); 
        visitNotesModal.addEventListener('change', e => {
            if (e.target.id === 'log-outcome') {
                document.getElementById('promise-to-pay-fields').classList.toggle('hidden', e.target.value !== 'Promise to Pay');
            }
        });
    }, 

    checkIn(visitId) {
        let visits = App.DB.get('visits');
        const index = visits.findIndex(v => v.id === visitId);
        if (index > -1) {
            visits[index].status = 'In Progress';
            visits[index].checkInTime = Date.now(); 
            App.DB.set('visits', visits);
            
            // --- NEW: Log Activity for Check-In ---
            App.Helpers.logActivity(
                'Started Visit', 
                'Check-In recorded.', 
                visits[index].customerId, 
                null, 
                visitId
            );
            // -------------------------------------

            App.UI.toast('Visit Started! Clock is ticking... ');
            this.render();
            if (App.state.activePage === 'myday') App.MyDay.render();
        }
    },

    setQuickDate(period) {
        const date = new Date();
        if(period === 'tomorrow') date.setDate(date.getDate() + 1);
        const yyyy = date.getFullYear();    
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        document.getElementById('visit-start-date').value = `${yyyy}-${mm}-${dd}`;
        document.getElementById('visit-end-date').value = `${yyyy}-${mm}-${dd}`;
    },
    getCurrentFilteredData: function() {
        let visits = App.Helpers.getScopedData('visits'); 
        const { filter, startDate, endDate, search, consultantFilter } = App.state.visits; 
        const today = new Date().setHours(0, 0, 0, 0); 
        const customerMap = App.DB.get('customers').reduce((map, c) => {map[c.accountNo] = c.companyName; return map;}, {});

        if (search) {
            const lowerSearch = search.toLowerCase();
            visits = visits.filter(v => 
                (customerMap[v.customerId] || '').toLowerCase().includes(lowerSearch) ||
                (v.purpose || '').toLowerCase().includes(lowerSearch)
            );
        }

        if (consultantFilter !== 'all') {
            visits = visits.filter(v => v.collectorId == consultantFilter);
        }

        if (filter !== 'All' && !(startDate && endDate)) { 
            visits = visits.filter(v => { 
                const visitDate = new Date(v.dateTime).setHours(0, 0, 0, 0); 
                if (filter === 'Overdue') return (v.status === 'Scheduled' || v.status === 'Overdue') && visitDate < today; 
                if (filter === 'Today') return visitDate === today; 
                if (filter === 'Upcoming') return (v.status === 'Scheduled' || v.status === 'In Progress') && visitDate >= today; 
                return false; 
            }); 
        } 
        if (startDate && endDate) { visits = visits.filter(v => { const visitDateOnly = new Date(v.dateTime).toISOString().slice(0, 10); return visitDateOnly >= startDate && visitDateOnly <= endDate; }); }
        
        const { column, order } = App.state.tableSorts.visits;
        const consultants = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});

        visits.sort((a, b) => {
            let valA, valB;
            if (column === 'customerId') { valA = customerMap[a.customerId] || ''; valB = customerMap[b.customerId] || ''; } 
            else if (column === 'collectorId') { valA = consultants[a.collectorId] || ''; valB = consultants[b.collectorId] || ''; } 
            else { valA = a[column]; valB = b[column]; }

            if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });

        return visits;
    },
    render: function() { 
        this.checkOverdueVisits();
        
        const allVisits = App.DB.get('visits');
        const todayStr = new Date().toISOString().slice(0,10);
        App.Dashboard.animateCounter('visit-kpi-upcoming', allVisits.filter(v => (v.status === 'Scheduled' || v.status === 'In Progress') && new Date(v.dateTime) >= new Date()).length);
        App.Dashboard.animateCounter('visit-kpi-overdue', allVisits.filter(v => v.status === 'Overdue').length);
        App.Dashboard.animateCounter('visit-kpi-completed-today', allVisits.filter(v => v.status === 'Completed' && v.dateTime.startsWith(todayStr)).length);
        
        const consultantFilter = document.getElementById('visit-consultant-filter');
        consultantFilter.innerHTML = '<option value="all">All Consultants</option>' + App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        consultantFilter.value = App.state.visits.consultantFilter;

        const headerActions = document.getElementById('visits-header-actions');
        headerActions.innerHTML = `
            <div data-role="admin" class="d-flex gap-2">
                <button class="btn btn-outline" id="export-visits-csv"><i class="fas fa-file-csv"></i> CSV</button>
                <button class="btn btn-outline" id="export-visits-pdf"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>
            <button class="btn btn-outline" id="plan-route-btn"><i class="fas fa-route"></i> Plan Route</button>
            <button class="btn btn-primary" id="schedule-visit-btn"><i class="fas fa-plus"></i> Schedule a Visit</button>
        `;

        if (App.state.visits.activeView === 'list') this.renderListView(); 
        else if (App.state.visits.activeView === 'calendar') this.renderCalendarView();
        else if (App.state.visits.activeView === 'map') this.renderMapView();

        document.getElementById('plan-route-btn').style.display = App.state.visits.activeView === 'map' ? 'inline-flex' : 'none';
    }, 
    switchView: function(view) { 
        App.state.visits.activeView = view; 
        document.querySelectorAll('.visit-view-tab').forEach(t => t.classList.remove('active')); 
        document.querySelector(`.visit-view-tab[data-view="${view}"]`).classList.add('active'); 
        document.querySelectorAll('.visit-view-content').forEach(c => c.classList.add('hidden')); 
        document.getElementById(`${view}-view-content`).classList.remove('hidden'); 
        
        document.getElementById('list-view-controls').style.display = view === 'list' ? 'flex' : 'none';
        document.getElementById('map-view-controls').classList.toggle('hidden', view !== 'map');
        document.getElementById('map-view-controls').style.display = view === 'map' ? 'flex' : 'none';
        
        this.render(); 
    }, 
    setFilter: function(filter) { App.state.visits.filter = filter; App.state.pagination.visits.currentPage = 1; document.getElementById('visit-start-date').value = ''; document.getElementById('visit-end-date').value = ''; App.state.visits.startDate = ''; App.state.visits.endDate = ''; document.querySelectorAll('.visit-filter-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.visit-filter-btn[data-filter="${filter}"]`).classList.add('active'); this.renderListView(); }, 
    applyDateFilter: function() { const startDate = document.getElementById('visit-start-date').value; const endDate = document.getElementById('visit-end-date').value; if (!startDate || !endDate) { App.UI.toast('Please select both a start and end date.', 'warning'); return; } App.state.pagination.visits.currentPage = 1; App.state.visits.startDate = startDate; App.state.visits.endDate = endDate; App.state.visits.filter = 'Custom'; document.querySelectorAll('.visit-filter-btn').forEach(b => b.classList.remove('active')); this.renderListView(); }, 
    renderListView: function() { 
        const isAdmin = App.state.currentUser.role === 'admin';
        let headers = [
            { text: 'Date', sortKey: 'dateTime' },
            { text: 'Customer', sortKey: 'customerId' },
            { text: 'Purpose', sortKey: 'purpose' }
        ];
        if (isAdmin) {
            headers.push({ text: 'Consultant', sortKey: 'collectorId' });
        }
        headers.push({ text: 'Status', sortKey: 'status' }, { text: 'Actions', sortKey: null });

        const thead = document.querySelector('#visits-page .data-table thead');
        thead.innerHTML = `<tr>${headers.map(h => `<th ${h.sortKey ? `data-sort="${h.sortKey}"` : ''}>${h.text}</th>`).join('')}</tr>`;

        const visits = this.getCurrentFilteredData();
        const { currentPage, rowsPerPage } = App.state.pagination.visits;
        const startIndex = (currentPage - 1) * rowsPerPage;
        const paginatedVisits = visits.slice(startIndex, startIndex + rowsPerPage);
        
        const customers = App.DB.get('customers'); 
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[String(c.id)] = c.name; return map; }, {});
        const tbody = document.getElementById('visit-table-body'); 
        
        if (paginatedVisits.length > 0) {
            tbody.innerHTML = paginatedVisits.map(v => { 
                // FIX: Force IDs to strings for comparison
                const customerObj = customers.find(c => String(c.accountNo) === String(v.customerId));
                const customerName = customerObj ? customerObj.companyName : 'N/A';
                
                const consultantCell = isAdmin ? `<td>${consultantMap[String(v.collectorId)] || 'N/A'}</td>` : '';
                
                const actions = [];
                if (v.status === 'Scheduled' || v.status === 'Overdue') {
                    if (isAdmin) {
                        actions.push(`<button class="btn btn-outline view-visit-btn" data-id="${v.id}" title="View Details"><i class="fas fa-eye"></i></button>`);
                    } else {
                        actions.push(`<button class="btn btn-success start-visit-btn" data-id="${v.id}" title="Start Visit"><i class="fas fa-play"></i> Start</button>`);
                    }
                } else if (v.status === 'In Progress') {
                    actions.push(`<button class="btn btn-danger mark-done-btn" data-id="${v.id}" title="End Visit"><i class="fas fa-stop"></i> End</button>`);
                } else if (v.status === 'Completed') {
                    actions.push(`<button class="btn btn-outline view-visit-btn" data-id="${v.id}" title="View Details"><i class="fas fa-eye"></i></button>`);
                }

                if (isAdmin) {
                    actions.push(`<button class="btn btn-danger delete-visit" data-id="${v.id}" title="Delete"><i class="fas fa-trash"></i></button>`);
                }
                
                return `<tr><td>${App.Helpers.formatDateTime(v.dateTime)}</td><td>${customerName}</td><td>${v.purpose}</td>${consultantCell}<td><span class="status-badge ${v.status.toLowerCase().replace(' ','-')}">${v.status}</span></td><td><div class="d-flex gap-2">${actions.join('')}</div></td></tr>`; 
            }).join('');
        } else {
            const buttonHTML = `<button class="btn btn-primary" onclick="App.Visits.showScheduleModal()"><i class="fas fa-plus"></i> Schedule a Visit</button>`;
            tbody.innerHTML = `<tr><td colspan="100%">${App.UI.getEmptyStateHTML('fa-calendar-times', 'No Visits Found', 'Try adjusting your filters or schedule a new visit.', buttonHTML)}</td></tr>`;
        }
        App.UI.animateTableRows(tbody);
        App.UI.renderPaginationControls('visits', visits.length);
        App.UI.updateSortIndicators('visits');
    }, 
    renderCalendarView: function() { const el = document.getElementById('calendar-view'); if (this.calendar) this.calendar.destroy(); const v = App.Helpers.getScopedData('visits'), c = App.DB.get('customers'); const ev = v.map(i => ({ id: i.id, title: `${c.find(cu => cu.accountNo === i.customerId)?.companyName || 'N/A'} - ${i.purpose}`, start: i.dateTime, backgroundColor: i.status === 'Completed' ? 'var(--success)' : i.status === 'Overdue' ? 'var(--danger)' : 'var(--primary)' })); this.calendar = new FullCalendar.Calendar(el, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, events: ev, editable: true, dateClick: (info) => this.showScheduleModal(null, info.dateStr), eventClick: (info) => this.showScheduleModal(info.event.id) }); this.calendar.render(); }, 
    renderMapView: function() {
        const mapContainer = document.getElementById('map-view');
        if (!mapContainer) return;

        const hasRoute = !!App.state.visits.plannedRoute;
        const clearBtn = document.getElementById('clear-route-btn');
        clearBtn.classList.toggle('hidden', !hasRoute);

        let navBtn = document.getElementById('start-nav-btn');
        if (!navBtn && hasRoute) {
            navBtn = document.createElement('button');
            navBtn.id = 'start-nav-btn';
            navBtn.className = 'btn btn-success';
            navBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Start Navigation';
            navBtn.style.marginLeft = '10px';
            navBtn.onclick = () => this.exportRouteToGoogleMaps();
            clearBtn.parentNode.insertBefore(navBtn, clearBtn.nextSibling);
        } else if (navBtn && !hasRoute) {
            navBtn.remove();
        }

        const isAdmin = App.state.currentUser.role === 'admin';
        const consultantFilterEl = document.getElementById('map-consultant-filter');
        const dateFilterEl = document.getElementById('map-date-filter');
        
        if (isAdmin) {
            consultantFilterEl.innerHTML = '<option value="all">All Consultants</option>' + App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            consultantFilterEl.value = App.state.visits.mapConsultant;
        }
        dateFilterEl.value = App.state.visits.mapDate;

        if (this.map) {
            this.map.remove();
            this.map = null;
        }
        
        const cartoVoyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: ' CARTO', maxZoom: 19 });
        this.map = L.map('map-view', { center: [25.2048, 55.2708], zoom: 11, layers: [cartoVoyager] });

        let customersToDisplay = App.Helpers.getScopedData('customers', isAdmin ? (App.state.visits.mapConsultant === 'all' ? null : App.state.visits.mapConsultant) : App.state.currentUser.assignedConsultantId);
        
        const markers = L.markerClusterGroup();
        customersToDisplay.forEach((customer) => {
            if (customer.latitude && customer.longitude) {
                const icon = App.Helpers.getCustomerMarkerIcon(customer);
                const popupContent = `<b>${customer.companyName}</b><br>${customer.area}<br>Balance: ${App.Helpers.formatCurrency(customer.outstanding)}`;
                markers.addLayer(L.marker([customer.latitude, customer.longitude], { icon }).bindPopup(popupContent));
            }
        });
        this.map.addLayer(markers);

        if (markers.getLayers().length > 0) this.map.fitBounds(markers.getBounds().pad(0.1));
        if (hasRoute) this.drawPlannedRoute();
    },
    exportRouteToGoogleMaps() {
        const routeIds = App.state.visits.plannedRoute;
        if (!routeIds || routeIds.length < 1) return;
        const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c; return map; }, {});
        const waypoints = routeIds
            .map(id => customerMap[id])
            .filter(c => c && c.latitude && c.longitude)
            .map(c => `${c.latitude},${c.longitude}`);
        if (waypoints.length === 0) return App.UI.toast('No valid GPS coordinates in route.', 'error');
        const baseUrl = "https://www.google.com/maps/dir/Current+Location/";
        const destinationString = waypoints.join("/");
        const finalUrl = baseUrl + destinationString;
        window.open(finalUrl, '_blank');
    },
    showScheduleModal: function(id = null, d = null, customerId = null) { 
        const f = document.getElementById('visit-form'); 
        f.reset(); 
        f.elements['visit-id'].value = ''; 
        const dateInput = f.elements['visit-date'];

        const container = document.getElementById('visit-customer-select-container');
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const customers = App.Helpers.getScopedData('customers').map(c => ({
            id: c.accountNo, 
            mainText: `${c.companyName}`,
            secondaryText: `${c.accountNo}  |  ${consultantMap[c.salesConsultantId] || 'Unassigned'}`
        }));
        const dropdown = App.UI.createSearchableDropdown(container, customers, null, 'Search by Name, Account #, or Consultant...');

        if (id) { 
            const visit = App.DB.get('visits').find(v => v.id === id); 
            if (visit) { 
                f.elements['visit-id'].value = visit.id; 
                dropdown.setValue(visit.customerId);
                f.elements['visit-purpose'].value = visit.purpose; 
                const visitDateObj = new Date(visit.dateTime);
                const localIso = new Date(visitDateObj.getTime() - (visitDateObj.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                dateInput.value = localIso; 
            } 
        } else if (d) { 
            dateInput.value = `${d}T09:00`;
        } else {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            dateInput.value = now.toISOString().slice(0, 16);
        }

        if (customerId) {
            dropdown.setValue(customerId);
        }
        App.UI.openModal('visit-modal'); 
    }, 
    saveScheduledVisit: function(e) { 
        e.preventDefault(); 
        const f = e.target; 
        const customerId = document.querySelector('#visit-customer-select-container input[type="hidden"]').value; 
        if(!customerId) return App.UI.toast('Please select a customer.', 'error'); 
        const customer = App.DB.get('customers').find(c => c.accountNo === customerId); 
        
        const visitDateTimeVal = f.elements['visit-date'].value; 
        if (!visitDateTimeVal) return App.UI.toast('Please select date and time', 'error');
        
        const visitDateTimeISO = new Date(visitDateTimeVal).toISOString();
        
        const vd = { 
            customerId: customerId, 
            purpose: f.elements['visit-purpose'].value, 
            dateTime: visitDateTimeISO, 
            status: 'Scheduled', 
            collectorId: customer ? customer.salesConsultantId : null 
        }; 
        let v = App.DB.get('visits'), id = f.elements['visit-id'].value; 
        if (id) { 
            const i = v.findIndex(vi => vi.id === id);
            const original = v[i];
            const changes = App.Helpers.getObjectChanges(original, {...original, ...vd});
            v[i] = { ...v[i], ...vd, id: id }; 
            App.Helpers.logChange('Updated', 'Visit', `For ${customer.companyName}`, changes); 
        } else { 
            vd.id = `visit-${Date.now()}`; 
            v.push(vd);
            App.Helpers.logChange('Scheduled', 'Visit', `For ${customer.companyName}`); 
        } 
        App.DB.set('visits', v); 
        App.UI.closeModal('visit-modal'); 
        App.UI.toast('Visit saved!'); 
        this.render(); 
    },
    showMarkDoneModal: function(visitId) { 
        const visit = App.DB.get('visits').find(v => v.id === visitId);
        if (!visit) return;
        const customer = App.DB.get('customers').find(c => c.accountNo === visit.customerId);

        const openModal = () => {
            document.getElementById('visit-notes-form').reset(); 
            document.getElementById('mark-done-visit-id').value = visitId; 
            document.getElementById('log-location-text').textContent = 'Tag Current Location'; 
            document.getElementById('log-location-hidden').value = ''; 
            if (!this.logNotesQuill) this.logNotesQuill = new Quill('#log-notes-editor', { theme: 'snow', placeholder: 'Enter contact notes...' }); 
            this.logNotesQuill.root.innerHTML = ''; 
            App.state.paymentFlowOrigin = null;
            document.getElementById('promise-to-pay-fields').classList.add('hidden');
            this.updateVisitNotesUI();
            App.UI.openModal('visit-notes-modal'); 
        };

        if (customer && customer.latitude && customer.longitude && navigator.geolocation) {
            App.UI.toast('Verifying GPS Location...', 'info');
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    const R = 6371e3; 
                    const 1 = userLat * Math.PI/180;
                    const 2 = customer.latitude * Math.PI/180;
                    const  = (customer.latitude - userLat) * Math.PI/180;
                    const  = (customer.longitude - userLon) * Math.PI/180;
                    const a = Math.sin(/2) * Math.sin(/2) + Math.cos(1) * Math.cos(2) * Math.sin(/2) * Math.sin(/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    const distance = R * c; 

                    if (distance > 500) {
                        Swal.fire({
                            title: 'GPS Warning ',
                            html: `You are <b>${(distance/1000).toFixed(2)}km</b> away from the customer.<br>Are you sure you are at the site?`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, Mark Anyway',
                            confirmButtonColor: '#d33',
                            cancelButtonText: 'Cancel',
                            background: 'var(--card-bg)',
                            color: 'var(--text-primary)'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                const distKm = (distance/1000).toFixed(2);
                                App.Helpers.logActivity(' GPS BYPASSED', `Force-completed visit ${distKm}km away from site.`, visit.customerId, null, visit.id);
                                App.Notifications.create(` SECURITY ALERT: ${App.state.currentUser.fullName} bypassed GPS check for ${customer.companyName} (${distKm}km away).`);
                                openModal(); 
                            }
                        });
                    } else {
                        App.UI.toast('GPS Verified: You are on site.', 'success');
                        openModal();
                    }
                },
                (error) => { console.warn("GPS Error:", error); openModal(); },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            openModal();
        }
    }, 
    updateVisitNotesUI: function() {
        const button = document.getElementById('log-record-payment-btn');
        if (!button) return;
        if (App.state.paymentFlowOrigin && App.state.paymentFlowOrigin.paymentLogged) {
            button.innerHTML = `<i class="fas fa-check-circle"></i> Payment Logged`;
            button.disabled = true;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline');
        } else {
            button.innerHTML = `<i class="fas fa-dollar-sign"></i> Record Payment`;
            button.disabled = false;
            button.classList.add('btn-success');
            button.classList.remove('btn-outline');
        }
    },
    showVisitDetail: function(visitId) { const visit = App.DB.get('visits').find(v => v.id === visitId); if (!visit) return App.UI.toast('Visit not found.', 'error'); const customer = App.DB.get('customers').find(c => c.accountNo === visit.customerId); const contentEl = document.getElementById('visit-detail-content'); const locationHTML = visit.location ? `<a href="https://www.google.com/maps?q=${visit.location}" target="_blank" style="color:var(--primary);">${visit.location}</a>` : 'N/A'; contentEl.innerHTML = `<div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));"><div class="detail-info-card"><div class="label">Customer</div><div class="value">${customer ? customer.companyName : 'N/A'}</div></div><div class="detail-info-card"><div class="label">Visit Date</div><div class="value">${App.Helpers.formatDateTime(visit.dateTime)}</div></div><div class="detail-info-card"><div class="label">Contact Method</div><div class="value">${visit.contactMethod || 'N/A'}</div></div><div class="detail-info-card"><div class="label">Outcome</div><div class="value">${visit.outcome || 'N/A'}</div></div><div class="detail-info-card"><div class="label">Duration</div><div class="value">${visit.duration ? visit.duration + ' min' : 'N/A'}</div></div><div class="detail-info-card"><div class="label">Location</div><div class="value">${locationHTML}</div></div></div><hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-6) 0;"><h4 class="card-title mb-4">Notes</h4><div class="card" style="background:var(--bg-color);">${visit.notes || '<p>No notes were entered for this visit.</p>'}</div>`; App.UI.openModal('visit-detail-modal'); }, 
    saveCompletedVisit: function(e) { 
        e.preventDefault(); 
        const form = e.target; 
        const visitId = form.elements['mark-done-visit-id'].value; 
        const location = document.getElementById('log-location-hidden').value; 
        let visits = App.DB.get('visits'); 
        const visitIndex = visits.findIndex(v => v.id === visitId); 
        
        if (visitIndex > -1) { 
            const visit = visits[visitIndex]; 
            visit.status = "Completed"; 
            
            if (visit.checkInTime) {
                const endTime = Date.now();
                const durationMins = Math.round((endTime - visit.checkInTime) / 60000); 
                visit.duration = durationMins > 0 ? durationMins : 1; 
                visit.checkOutTime = endTime;
            } else {
                visit.duration = null; 
            }

            visit.dateTime = new Date().toISOString(); 
            visit.contactMethod = form.elements['log-contact-method'].value; 
            visit.outcome = form.elements['log-outcome'].value; 
            visit.notes = this.logNotesQuill.root.innerHTML; 
            if (location) { 
                visit.location = location; 
            }
            
            if (visit.outcome === 'Promise to Pay') {
                visit.promiseAmount = parseFloat(document.getElementById('log-promise-amount').value);
                visit.promiseDate = document.getElementById('log-promise-date').value;
                if (!visit.promiseAmount || !visit.promiseDate) {
                    return App.UI.toast('Please enter a promised amount and date.', 'error');
                }
            }
            
            const nextVisitDate = document.getElementById('log-next-date').value; 
            if (nextVisitDate) { visits.push({ id: `v${Date.now() + 1}`, customerId: visit.customerId, dateTime: `${nextVisitDate}T09:00:00.000Z`, purpose: 'Scheduled Follow-up', collectorId: visit.collectorId, status: "Scheduled" }); } 
            
            let logDetails = `(Outcome: ${visit.outcome})`;
            if(visit.duration) logDetails += `, Duration: ${visit.duration} min`; 
            if(visit.location) logDetails += ', Location Tagged';
            
            // --- NEW: Log Activity for Check-Out ---
            App.Helpers.logActivity(
                'Completed Visit (Check-Out)', // Changed Text
                logDetails, 
                visit.customerId, 
                null, 
                visit.id
            );
            // -------------------------------------

            App.Helpers.logChange('Completed', 'Visit', `For customer ${visit.customerId}`);
        } 
        App.DB.set('visits', visits); 
        App.UI.closeModal('visit-notes-modal'); 
        App.UI.toast(`Visit marked as done! (${visits[visitIndex].duration || '0'} min)`);
        this.render(); 
        if (App.state.activePage === 'myday') App.MyDay.render();
    }, 
    checkOverdueVisits: function() { let v = App.DB.get('visits'), c = false; const today = new Date(); today.setHours(0, 0, 0, 0); v.forEach(i => { if (i.status === 'Scheduled' && new Date(i.dateTime) < today) { i.status = 'Overdue'; c = true; } }); if (c) App.DB.set('visits', v); }, 
    tagLocationForVisitLog: function() { 
        if (!navigator.geolocation) return App.UI.toast('Geolocation not supported.', 'error'); 
        const locationBtn = document.getElementById('log-location-btn');
        locationBtn.disabled = true;
        locationBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span id="log-location-text">Getting Location...</span>`;

        navigator.geolocation.getCurrentPosition(p => { 
            const coords = `${p.coords.latitude.toFixed(5)},${p.coords.longitude.toFixed(5)}`; 
            document.getElementById('log-location-text').textContent = `Tagged: ${coords}`; 
            document.getElementById('log-location-hidden').value = coords; 
            locationBtn.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success);"></i> <span id="log-location-text">Location Tagged!</span>`;
            App.UI.toast('Location tagged for this note!'); 
        }, () => {
            locationBtn.disabled = false;
            locationBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i> <span id="log-location-text">Tag Current Location</span>`;
            App.UI.toast('Unable to get location.', 'error');
        }); 
    }, 
    deleteVisit(visitId) { const visit = App.DB.get('visits').find(v => v.id === visitId); Swal.fire({ title: `Delete this visit?`, text: "This action cannot be undone.", input: 'textarea', inputLabel: 'Reason for deletion', inputPlaceholder: 'Enter your reason here...', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: 'var(--danger)', background: 'var(--card-bg)', color: 'var(--text-primary)', inputValidator: (value) => { if (!value) { return 'You must provide a reason for deletion!' } } }).then(result => { if (result.isConfirmed && result.value) { let visits = App.DB.get('visits'); App.DB.set('visits', visits.filter(v => v.id !== visitId)); App.Helpers.logChange('Deleted', 'Visit', `${visit.purpose} for customer ${visit.customerId}`, `Reason: ${result.value}`); App.UI.toast('Visit deleted.', 'success'); this.render(); } }); } ,
    showRoutePlannerModal() {
        const form = document.getElementById('route-planner-form');
        form.reset();
        document.getElementById('route-date').value = new Date().toISOString().slice(0, 10);
        const customers = App.Helpers.getScopedData('customers');
        const customerListEl = document.getElementById('route-customer-list');
        customerListEl.innerHTML = customers.length > 0 ? customers.map(c => `<div class="d-flex align-items-center gap-2"><input type="checkbox" name="customerToVisit" value="${c.accountNo}" id="route-${c.accountNo}"><label for="route-${c.accountNo}">${c.companyName}</label></div>`).join('') : '<p>No customers to select.</p>';
        App.UI.openModal('route-planner-modal');
    },
    generateRoute(e) {
        e.preventDefault();
        const form = e.target;
        const selectedCustomerNodes = form.querySelectorAll('input[name="customerToVisit"]:checked');
        if (selectedCustomerNodes.length < 2) {
            return App.UI.toast('Please select at least 2 customers to plan a route.', 'warning');
        }
        const customerIds = Array.from(selectedCustomerNodes).map(node => node.value);
        
        App.state.visits.plannedRoute = App.Helpers.optimizeRoute(customerIds);
        App.UI.closeModal('route-planner-modal');
        this.renderMapView();
    },
    clearRoute() {
        App.state.visits.plannedRoute = null;
        this.renderMapView();
    },
    drawPlannedRoute() {
        if (!this.map || !App.state.visits.plannedRoute) return;
        const route = App.state.visits.plannedRoute;
        const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c; return map; }, {});
        
        const markers = [];
        const latLngs = [];

        route.forEach((customerId, index) => {
            const customer = customerMap[customerId];
            if (!customer) return;

            let hash = 0;
            for (let i = 0; i < customer.accountNo.length; i++) hash = customer.accountNo.charCodeAt(i) + ((hash << 5) - hash);
            const mockLat = 25.2048 + ((hash % 100) / 10000);
            const mockLon = 55.2708 + (((hash / 1000) % 100) / 10000);

            const numberedIcon = L.divIcon({
                className: 'numbered-marker',
                html: `<div>${index + 1}</div>`,
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            });

            const marker = L.marker([mockLat, mockLon], { icon: numberedIcon }).addTo(this.map).bindPopup(`<b>${index + 1}. ${customer.companyName}</b>`);
            markers.push(marker);
            latLngs.push([mockLat, mockLon]);
        });

        if (latLngs.length > 1) {
            L.polyline(latLngs, { color: '#e2000f', weight: 3, opacity: 0.7 }).addTo(this.map);
        }
        
        if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            this.map.fitBounds(group.getBounds().pad(0.2));
        }
    }
});

Object.assign(App.Payments, { 
    getCurrentFilteredData: function() {
        let payments = App.Helpers.getScopedData('payments');
        const { search, statusFilter, methodFilter } = App.state.payments;
        const customerMap = App.DB.get('customers').reduce((map, c) => {map[c.accountNo] = c.companyName; return map;}, {});
        const consultants = App.DB.get('consultants').reduce((map, c) => {map[c.id] = c.name; return map;}, {});
        const customerConsultantMap = App.DB.get('customers').reduce((map, c) => {map[c.accountNo] = consultants[c.salesConsultantId] || ''; return map;}, {});

        if (search) {
            const lowerSearch = search.toLowerCase();
            payments = payments.filter(p => (customerMap[p.customerId] || '').toLowerCase().includes(lowerSearch));
        }
        if (statusFilter !== 'all') {
            payments = payments.filter(p => p.status === statusFilter);
        }
        if (methodFilter !== 'all') {
            payments = payments.filter(p => p.method === methodFilter);
        }
        
        const { column, order } = App.state.tableSorts.payments;
        payments.sort((a, b) => {
            let valA, valB;
            if (column === 'customerId') {
                valA = customerMap[a.customerId] || '';
                valB = customerMap[b.customerId] || '';
            } else if (column === 'consultantId') {
                valA = customerConsultantMap[a.customerId] || '';
                valB = customerConsultantMap[b.customerId] || '';
            } else {
                valA = a[column];
                valB = b[column];
            }

            if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });
        return payments;
    },
    render: function() { 
        const payments = App.DB.get('payments');
        const currentMonthStr = `${App.state.dashboardTimeFrame.year}-${App.state.dashboardTimeFrame.month}`;
        const recoveredThisMonth = payments.filter(p => p.date.startsWith(currentMonthStr) && p.status === 'Completed').reduce((s, p) => s + p.amount, 0);
        
        App.Dashboard.animateCounter('payment-kpi-recovered-month', recoveredThisMonth, true);
        App.Dashboard.animateCounter('payment-kpi-total-count', payments.length);
        App.Dashboard.animateCounter('payment-kpi-pending', payments.filter(p => p.status === 'Pending').length);

        const filteredPayments = this.getCurrentFilteredData(); 
        const { currentPage, rowsPerPage } = App.state.pagination.payments;
        const startIndex = (currentPage - 1) * rowsPerPage;
        const paginatedPayments = filteredPayments.slice(startIndex, startIndex + rowsPerPage);
        
        const customers = App.DB.get('customers');
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[String(c.id)] = c.name; return map; }, {});
        const tbody = document.getElementById('payment-table-body');
        
        if (paginatedPayments.length > 0) {
            tbody.innerHTML = paginatedPayments.map(p => { 
                // FIX: Force comparison as strings
                const customer = customers.find(c => String(c.accountNo) === String(p.customerId)); 
                const customerName = customer ? customer.companyName : 'N/A';
                
                // Ensure consultant ID is also treated as a string for lookup
                const consultantName = customer ? consultantMap[String(customer.salesConsultantId)] || 'N/A' : 'N/A';
                
                const actions = [ `<button class="btn btn-outline view-payment" data-id="${p.id}" title="View Details"><i class="fas fa-eye"></i></button>`, App.state.currentUser.role === 'admin' ? `<button class="btn btn-danger delete-payment" data-id="${p.id}" title="Delete"><i class="fas fa-trash"></i></button>` : '' ].join(''); 
                return `<tr><td>${App.Helpers.formatDate(p.date)}</td><td>${customerName}</td><td>${consultantName}</td><td>${App.Helpers.formatCurrency(p.amount)}</td><td>${p.method}</td><td><span class="status-badge ${p.status.toLowerCase()}">${p.status}</span></td><td><div class="d-flex gap-2">${actions}</div></td></tr>`; 
            }).join('');
        } else {
            const buttonHTML = `<button class="btn btn-success" onclick="App.Payments.showPaymentForm()"><i class="fas fa-plus"></i> Record First Payment</button>`;
            tbody.innerHTML = `<tr><td colspan="100%">${App.UI.getEmptyStateHTML('fa-credit-card', 'No Payments Found', 'Record a payment to see it listed here.', buttonHTML)}</td></tr>`;
        }
        App.UI.animateTableRows(tbody);
        App.UI.renderPaginationControls('payments', filteredPayments.length);
        App.UI.updateSortIndicators('payments');
    }, 
    setupEventListeners: function() { 
        const debouncedRender = App.Helpers.debounce(() => {App.state.pagination.payments.currentPage = 1; this.render()}, 300);
        document.getElementById('record-payment-btn').addEventListener('click', () => this.showPaymentForm()); 
        document.getElementById('payment-form').addEventListener('submit', (e) => this.savePayment(e)); 
        document.getElementById('payment-table-body').addEventListener('click', (e) => { const viewButton = e.target.closest('.view-payment'); if (viewButton) this.showPaymentDetail(viewButton.dataset.id); const deleteButton = e.target.closest('.delete-payment'); if (deleteButton) this.deletePayment(deleteButton.dataset.id); }); 
        document.getElementById('export-payments-csv').addEventListener('click', () => App.Helpers.exportTableData('csv', 'Payments', this.getCurrentFilteredData, ['date', 'customerId', 'consultantId', 'amount', 'method', 'status'])); 
        document.getElementById('export-payments-pdf').addEventListener('click', () => App.Helpers.exportTableData('pdf', 'Payments', this.getCurrentFilteredData, ['date', 'customerId', 'consultantId', 'amount', 'method', 'status']));
        document.querySelector('#payments-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('payments', th.dataset.sort); });
        document.getElementById('payment-search').addEventListener('input', (e) => { App.state.payments.search = e.target.value; debouncedRender(); });
        document.getElementById('payment-status-filter').addEventListener('change', (e) => { App.state.pagination.payments.currentPage = 1; App.state.payments.statusFilter = e.target.value; this.render(); });
        document.getElementById('payment-method-filter').addEventListener('change', (e) => { App.state.pagination.payments.currentPage = 1; App.state.payments.methodFilter = e.target.value; this.render(); });
    }, 
    showPaymentForm: function(customerId = null) { 
        const form = document.getElementById('payment-form');
        form.reset(); 
        
        const container = document.getElementById('payment-customer-select-container');
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const customers = App.Helpers.getScopedData('customers').map(c => ({
            id: c.accountNo, 
            mainText: `${c.companyName}`,
            secondaryText: `${c.accountNo}  |  ${consultantMap[c.salesConsultantId] || 'Unassigned'}`
        }));
        const dropdown = App.UI.createSearchableDropdown(container, customers, null, 'Search by Name, Account #, or Consultant...');
        
        if (customerId) {
            dropdown.setValue(customerId);
        }
        document.getElementById('payment-date').valueAsDate = new Date(); 
        App.UI.openModal('payment-modal'); 
    }, 
    savePayment: function(e) { 
        e.preventDefault(); 
        const f = e.target;
        const cid = document.querySelector('#payment-customer-select-container input[type="hidden"]').value;
        if(!cid) return App.UI.toast('Please select a customer.', 'error');
        const a = parseFloat(f.elements['payment-amount'].value); 

        if (isNaN(a) || a <= 0) {
            return App.UI.toast('Please enter a valid, positive payment amount.', 'error');
        }

        const amt2025 = parseFloat(f.elements['payment-amount-2025'].value) || 0;
        const amt2020 = parseFloat(f.elements['payment-amount-2020'].value) || 0;
        const amt2018 = parseFloat(f.elements['payment-amount-2018'].value) || 0;

        const pd = { id: `p${Date.now()}`, customerId: cid, amount: a, method: f.elements['payment-method'].value, date: f.elements['payment-date'].value, status: f.elements['payment-status'].value, amount_2020_2025: amt2025, amount_2019_2020: amt2020, amount_lte_2018: amt2018 }; 
        
        if (pd.status === 'Completed') {
            let visits = App.DB.get('visits');
            const promiseVisitIndex = visits.findIndex(v => v.customerId === cid && v.outcome === 'Promise to Pay' && v.promiseDate);
            if(promiseVisitIndex > -1) {
                visits[promiseVisitIndex].promiseAmount = null;
                visits[promiseVisitIndex].promiseDate = null;
                App.DB.set('visits', visits);
            }
        }

        App.DB.set('payments', [...App.DB.get('payments'), pd]); 
        if (pd.status === 'Completed') { 
            let customers = App.DB.get('customers'); 
            const customerIndex = customers.findIndex(c => c.accountNo === cid); 
            if (customerIndex !== -1) { 
                customers[customerIndex].outstanding -= a;
                customers[customerIndex].balance_2020_2025 -= amt2025;
                customers[customerIndex].balance_2019_2020 -= amt2020;
                customers[customerIndex].balance_lte_2018 -= amt2018;

                if (customers[customerIndex].outstanding <= 0) { 
                    customers[customerIndex].outstanding = 0; 
                    customers[customerIndex].paymentStatus = 'Settlement'; 
                } else { 
                    customers[customerIndex].paymentStatus = 'Negotiation';
                } 
                App.DB.set('customers', customers); 
            } 
            App.Helpers.logActivity('recorded a payment', `(Method: ${pd.method})`, pd.customerId, pd.amount); 
            App.Helpers.logChange('Recorded', 'Payment', `${App.Helpers.formatCurrency(pd.amount)} for ${cid}`);
        } 
        
        App.UI.toast('Payment recorded!'); 
        
        if (App.state.paymentFlowOrigin) {
            App.state.paymentFlowOrigin.paymentLogged = true;
            App.UI.closeModal('payment-modal');
        } else {
            App.UI.closeModal('payment-modal');
            this.render(); 
            if (App.state.activePage === 'dashboard') App.Dashboard.render(); 
            if (App.state.activePage === 'customers') App.Customers.render();
        }
    }, 
    showPaymentDetail: function(paymentId) { const payment = App.DB.get('payments').find(p => p.id === paymentId); if (!payment) return; const customer = App.DB.get('customers').find(c => c.accountNo === payment.customerId); const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {}); const contentEl = document.getElementById('payment-detail-content'); contentEl.innerHTML = `<div class="detail-info-grid" style="grid-template-columns: 1fr 1fr; gap: var(--spacing-6);"><div class="detail-info-card"><div class="label">TRANSACTION ID</div><div class="value">${payment.id}</div></div><div class="detail-info-card"><div class="label">AMOUNT</div><div class="value" style="color: var(--success);">${App.Helpers.formatCurrency(payment.amount)}</div></div><div class="detail-info-card"><div class="label">PAYMENT DATE</div><div class="value">${App.Helpers.formatDate(payment.date)}</div></div><div class="detail-info-card"><div class="label">PAYMENT METHOD</div><div class="value">${payment.method}</div></div><div class="detail-info-card"><div class="label">STATUS</div><div class="value"><span class="status-badge ${payment.status.toLowerCase()}">${payment.status}</span></div></div></div><hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-6) 0;"><h4 class="card-title mb-4">Customer Information</h4>${customer ? `<div class="detail-info-grid" style="grid-template-columns: 1fr 1fr;"><div class="detail-info-card"><div class="label">COMPANY NAME</div><div class="value">${customer.companyName}</div></div><div class="detail-info-card"><div class="label">ACCOUNT #</div><div class="value">${customer.accountNo}</div></div><div class="detail-info-card"><div class="label">SALES CONSULTANT</div><div class="value">${consultantMap[customer.salesConsultantId] || 'N/A'}</div></div><div class="detail-info-card"><div class="label">CURRENT OUTSTANDING</div><div class="value">${App.Helpers.formatCurrency(customer.outstanding)}</div></div></div>` : '<p>No customer associated with this payment.</p>'}`; App.UI.openModal('payment-detail-modal'); }, 
    deletePayment(paymentId) { const payment = App.DB.get('payments').find(p => p.id === paymentId); Swal.fire({ title: `Delete this payment?`, text: "This will add the amount back to the customer's outstanding balance. This action cannot be undone.", input: 'textarea', inputLabel: 'Reason for deletion', inputPlaceholder: 'Enter your reason here...', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: 'var(--danger)', background: 'var(--card-bg)', color: 'var(--text-primary)', inputValidator: (value) => { if (!value) { return 'You must provide a reason for deletion!' } } }).then(result => { if (result.isConfirmed && result.value) { let payments = App.DB.get('payments'); let customers = App.DB.get('customers'); const customerIndex = customers.findIndex(c => c.accountNo === payment.customerId); if (customerIndex !== -1) { customers[customerIndex].outstanding += payment.amount; if (customers[customerIndex].outstanding > 0) { customers[customerIndex].paymentStatus = 'Negotiation'; } App.DB.set('customers', customers); } App.DB.set('payments', payments.filter(p => p.id !== paymentId)); App.Helpers.logChange('Deleted', 'Payment', `${App.Helpers.formatCurrency(payment.amount)} for customer ${payment.customerId}`, `Reason: ${result.value}`); App.UI.toast('Payment deleted and balance adjusted.', 'success'); this.render(); if(App.state.activePage === 'dashboard') App.Dashboard.render(); if(App.state.activePage === 'customers') App.Customers.render(); } }); } 
});
Object.assign(App.Reports, { 
    charts: {}, 
    currentReportData: null, 
    currentConsultantVisitsData: null,
    activityCustomerDropdown: null,
    availableColumns: {
        customers: {
            accountNo: 'Account #', companyName: 'Company Name', email: 'Email', mobile: 'Mobile', emirate: 'Emirate', area: 'Area',
            status: 'Account Status', paymentStatus: 'Payment Status', initialDebt: 'Initial Debt', outstanding: 'Outstanding Balance',
            balance_2020_2025: 'Balance 2020-2025', balance_2019_2020: 'Balance 2019-2020', balance_lte_2018: 'Balance <=2018',
            salesConsultant: 'Sales Consultant', customerStatus: 'Customer Status', agingCategory: 'Aging Category', debtSince: 'Debt Since',
            tags: 'Tags', totalPaid: 'Total Amount Paid', lastPaymentDate: 'Last Payment Date', lastVisitDate: 'Last Visit Date',
            nextVisitDate: 'Next Visit Date', activePromiseDate: 'Active Promise Date', activePromiseAmount: 'Active Promise Amount'
        },
        payments: {
            id: 'ID', date: 'Date', customerId: 'Account #', customerName: 'Customer Name', amount: 'Total Amount', method: 'Method',
            status: 'Status', consultantName: 'Consultant', amount_2020_2025: 'For 2020-2025', amount_2019_2020: 'For 2019-2020', 
            amount_lte_2018: 'For <=2018'
        },
        visits: {
            id: 'ID', dateTime: 'Date/Time', customerId: 'Account #', customerName: 'Customer Name', consultantName: 'Consultant', 
            purpose: 'Purpose', status: 'Status', contactMethod: 'Contact Method', outcome: 'Outcome', notes: 'Notes (Preview)',
            promiseAmount: 'Promise Amount', promiseDate: 'Promise Date', location: 'Location'
        }
    },
    filterOperators: {
        'string': [{id: 'CONTAINS', name: 'Contains'}, {id: 'EQUALS', name: 'Equals'}, {id: 'STARTS_WITH', name: 'Starts With'}],
        'number': [{id: 'EQ', name: '='}, {id: 'GT', name: '>'}, {id: 'LT', name: '<'}],
        'date': [{id: 'ON', name: 'On'}, {id: 'BEFORE', name: 'Before'}, {id: 'AFTER', name: 'After'}],
        'select': [{id: 'EQ', name: 'Is'}, {id: 'NEQ', name: 'Is Not'}]
    },
	
	
    render: function() { 
        this.initializeCustomReportBuilder();
        const consultantSelects = ['report-consultant-select', 'report-visits-consultant-select', 'report-target-consultant-select', 'report-forecast-consultant-select', 'report-aging-consultant-select', 'report-comprehensive-consultant-select', 'report-aging-collection-consultant-select', 'report-status-target-consultant-select']; 
        
        consultantSelects.forEach(id => {
            const selectEl = document.getElementById(id);
            if(selectEl) {
                selectEl.innerHTML = (id.includes('consultant-select') ? '<option value="all">All Consultants</option>' : '') + App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                if (id === 'report-consultant-select') selectEl.value = App.DB.get('consultants')[0]?.id || 'all'; // Default to first consultant for activity report
            }
        });
        
        const customersForDropdown = App.DB.get('customers').map(c => ({id: c.accountNo, mainText: c.companyName, secondaryText: c.accountNo}));
        App.UI.createSearchableDropdown(document.getElementById('report-aging-customer-select-container'), customersForDropdown, null, 'Search for a customer...');
        App.Reports.activityCustomerDropdown = App.UI.createSearchableDropdown(document.getElementById('report-activity-customer-filter-container'), [{id: 'all', mainText: 'All Customers', secondaryText: ''}, ...customersForDropdown], null, 'Filter by Customer...');
        
        const today = new Date();
        App.Helpers.populateMonthYearDropdowns('report-target-month-select', 'report-target-year-select', today.getMonth(), today.getFullYear());
        App.Helpers.populateMonthYearDropdowns('report-forecast-month-select', 'report-forecast-year-select', today.getMonth(), today.getFullYear());
        App.Helpers.populateMonthYearDropdowns('report-comprehensive-month-select', 'report-comprehensive-year-select', today.getMonth(), today.getFullYear());
        App.Helpers.populateMonthYearDropdowns('report-status-target-month-select', 'report-status-target-year-select', today.getMonth(), today.getFullYear());
        
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const dateElements = ['report-activity-start-date', 'report-activity-end-date', 'report-collection-start-date', 'report-collection-end-date', 'report-standard-start-date', 'report-standard-end-date', 'report-visits-start-date', 'report-visits-end-date', 'report-aging-start-date', 'report-aging-end-date', 'report-aging-collection-start-date', 'report-aging-collection-end-date'];
        dateElements.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = id.includes('start-date') ? firstDayOfMonth.toISOString().slice(0, 10) : today.toISOString().slice(0, 10);
        });

        document.getElementById('report-output').innerHTML = ''; 
    }, 
    
    setupEventListeners: function() { 
        const reportsPage = document.getElementById('reports-page');
        reportsPage.addEventListener('click', (e) => {
            const target = e.target.closest('button, input');
            if (!target) return;
            
            const reportActions = {
                'generate-customer-report-btn': () => this.generateCustomerReport(),
                'generate-consultant-report-btn': () => this.generateConsultantReport(),
                'generate-recovery-report-btn': () => this.generateRecoveryPerformanceReport(),
                'generate-customer-status-report-btn': () => this.generateCustomerStatusReport(),
                'generate-outcome-analysis-btn': () => this.generateVisitOutcomeReport(),
                'generate-activity-report-btn': () => this.generateActivityReport(),
                'activity-report-summary-btn': () => { App.state.reports.activityView = 'summary'; this.updateActivityReportView(); },
                'activity-report-table-btn': () => { App.state.reports.activityView = 'table'; this.updateActivityReportView(); },
                'generate-collection-report-btn': () => this.generateCollectionReport(),
                'generate-aging-report-btn': () => this.generateAgingReport(),
                'generate-consultant-visits-btn-new': () => this.generateConsultantVisitsReport(),
                'generate-target-perf-btn': () => this.generateTargetPerformanceReport(),
                'generate-forecast-perf-btn': () => this.generateForecastPerformanceReport(),
                'generate-status-target-perf-btn': () => this.generateStatusTargetPerformanceReport(),
                'generate-detailed-aging-report-btn': () => this.generateDetailedAgingReport(),
                'generate-custom-report-btn': () => this.generateCustomReport(),
                'generate-comprehensive-perf-btn': () => this.generateComprehensivePerformanceReport(),
                'generate-aging-collection-report-btn': () => this.generateAgingCollectionReport(),
                'generate-risk-report-btn': () => this.generateCustomerRiskReport(),
                'add-dynamic-filter-btn': () => this.addDynamicFilter(),
            };
            if (reportActions[target.id]) {
                e.preventDefault();
                reportActions[target.id]();
            }

            if(target.name === 'dataSource') {
                document.querySelectorAll('input[name="dataSource"]').forEach(radio => radio.parentElement.classList.remove('active'));
                target.parentElement.classList.add('active');
                App.state.reports.customReportFilters = []; // Clear existing filters on data source change
                this.updateColumnSelector();
            }
        });
        
        // Dynamic preview listeners for custom report builder
        document.getElementById('column-selector').addEventListener('change', (e) => {
            if (e.target.name === 'customReportColumn') this.updateCustomReportPreview();
        });
        document.getElementById('custom-report-consultant-filter').addEventListener('change', () => this.updateCustomReportPreview());
        document.getElementById('custom-report-start-date').addEventListener('change', () => this.updateCustomReportPreview());
        document.getElementById('custom-report-end-date').addEventListener('change', () => this.updateCustomReportPreview());
        document.querySelector('#data-source-selector').addEventListener('change', () => this.updateCustomReportPreview());
        document.getElementById('dynamic-filter-container').addEventListener('change', (e) => {
            if (e.target.classList.contains('filter-column-select') || e.target.classList.contains('filter-operator-select')) {
                this.updateDynamicFilterRow(e.target.closest('.dynamic-filter-row'));
            }
            this.updateCustomReportPreview();
        });
        document.getElementById('dynamic-filter-container').addEventListener('input', (e) => {
            if (e.target.classList.contains('filter-value-input')) {
                this.updateCustomReportPreview();
            }
        });
        document.getElementById('dynamic-filter-container').addEventListener('click', (e) => {
            if (e.target.closest('.remove-filter-btn')) {
                e.target.closest('.dynamic-filter-row').remove();
                this.updateCustomReportPreview();
            }
        });

        // Click listener for customer status report table rows
        document.getElementById('report-modal-body').addEventListener('click', e => {
            const row = e.target.closest('tr.clickable-row');
            if (row && row.dataset.status) {
                this.generateDrillDownStatusReport(row.dataset.status);
            }
        });
    },
    
    addDynamicFilter() {
        const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
        const columns = this.availableColumns[dataSource] || {};
        const container = document.getElementById('dynamic-filter-container');
        const filterId = Date.now();

        const columnOptions = Object.entries(columns).map(([key, label]) => 
            `<option value="${key}" data-type="${App.Helpers.getColumnDataType(key)}">${label}</option>`
        ).join('');
        
        // Default to the first column's data type
        const firstColKey = Object.keys(columns)[0];
        const defaultDataType = App.Helpers.getColumnDataType(firstColKey);
        const operators = defaultDataType.startsWith('select') ? App.Reports.filterOperators['select'] : App.Reports.filterOperators[defaultDataType];
        const operatorOptions = operators.map(op => `<option value="${op.id}">${op.name}</option>`).join('');
        const defaultValueInput = App.Helpers.getFilterValueInputHTML(defaultDataType);
        
        const filterRowHTML = `
            <div class="dynamic-filter-row" data-filter-id="${filterId}">
                <select class="form-control filter-column-select">
                    ${columnOptions}
                </select>
                <select class="form-control filter-operator-select">
                    ${operatorOptions}
                </select>
                <div class="filter-value-input-container">
                    ${defaultValueInput}
                </div>
                <button type="button" class="btn btn-danger remove-filter-btn"><i class="fas fa-times"></i></button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', filterRowHTML);
        // Trigger a refresh of the filter array in the state
        this.updateCustomReportPreview();
    },
    
    updateDynamicFilterRow(rowElement) {
        const columnSelect = rowElement.querySelector('.filter-column-select');
        const operatorSelect = rowElement.querySelector('.filter-operator-select');
        const valueContainer = rowElement.querySelector('.filter-value-input-container');
        
        const selectedColumnOption = columnSelect.options[columnSelect.selectedIndex];
        const dataType = selectedColumnOption?.dataset.type || 'string';

        // 1. Update Operator Dropdown
        const operators = dataType.startsWith('select') ? App.Reports.filterOperators['select'] : App.Reports.filterOperators[dataType];
        const operatorOptions = operators.map(op => `<option value="${op.id}">${op.name}</option>`).join('');
        operatorSelect.innerHTML = operatorOptions;
        
        // 2. Update Value Input Type
        valueContainer.innerHTML = App.Helpers.getFilterValueInputHTML(dataType);
    },

    initializeCustomReportBuilder() {
        const consultantFilter = document.getElementById('custom-report-consultant-filter');
        consultantFilter.innerHTML = '<option value="all">All Consultants</option>' + App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        
        // Select 'Customers' by default and show its columns
        const defaultSource = document.querySelector('input[name="dataSource"][value="customers"]');
        if (defaultSource) {
            defaultSource.checked = true;
            defaultSource.parentElement.classList.add('active');
            this.updateColumnSelector();
            this.updateCustomReportPreview();
        }
        document.getElementById('dynamic-filter-container').innerHTML = '';
        App.state.reports.customReportFilters = [];
    },

    updateColumnSelector() {
        const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
        const columns = this.availableColumns[dataSource] || {};
        const container = document.getElementById('column-selector');
        
        const defaultColumns = {
            customers: ['companyName', 'accountNo', 'outstanding', 'salesConsultant'],
            payments: ['date', 'customerName', 'amount', 'method'],
            visits: ['dateTime', 'customerName', 'purpose', 'status']
        };

        container.innerHTML = Object.entries(columns).map(([key, label]) => {
            const checked = defaultColumns[dataSource]?.includes(key) ? 'checked' : '';
            return `
                <label class="d-flex align-items-center gap-2">
                    <input type="checkbox" name="customReportColumn" value="${key}" ${checked}>
                    ${label}
                </label>
            `;
        }).join('');
    },
    
    updateCustomReportPreview() {
        const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
        const selectedColumns = Array.from(document.querySelectorAll('input[name="customReportColumn"]:checked')).map(cb => cb.value);
        const previewTable = document.getElementById('custom-report-preview-table');
        
        if (selectedColumns.length === 0) {
            previewTable.innerHTML = '<thead><tr><th>Select columns to see a preview.</th></tr></thead><tbody><tr><td colspan="100%">No columns selected.</td></tr></tbody>';
            return;
        }

        // Collect dynamic filters
        App.state.reports.customReportFilters = [];
        document.querySelectorAll('.dynamic-filter-row').forEach(row => {
            const column = row.querySelector('.filter-column-select').value;
            const operator = row.querySelector('.filter-operator-select').value;
            const valueInput = row.querySelector('.filter-value-input');
            const value = valueInput.type === 'number' ? parseFloat(valueInput.value) : valueInput.value.trim();
            
            if (column && operator && String(value).length > 0) {
                 if (valueInput.type !== 'number' || !isNaN(value)) {
                    App.state.reports.customReportFilters.push({ column, operator, value });
                 }
            }
        });
        
        const consultantId = document.getElementById('custom-report-consultant-filter').value;
        const startDate = document.getElementById('custom-report-start-date').value;
        const endDate = document.getElementById('custom-report-end-date').value;
        
        const { data, headers } = App.Helpers.getReportData(dataSource, selectedColumns, { consultantId, startDate, endDate, dynamicFilters: App.state.reports.customReportFilters });

        const previewData = data.slice(0, 5); // Only show first 5 rows
        
        const headerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
        const bodyHTML = previewData.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
        
        previewTable.innerHTML = headerHTML + `<tbody>${bodyHTML || '<tr><td colspan="100%">No matching data found.</td></tr>'}</tbody>`;
        App.UI.animateTableRows(previewTable.querySelector('tbody'));
    },

    generateCustomReport() {
        const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
        const selectedColumns = Array.from(document.querySelectorAll('input[name="customReportColumn"]:checked')).map(cb => cb.value);

        if (selectedColumns.length === 0) {
            return App.UI.toast('Please select at least one column.', 'warning');
        }

        const consultantId = document.getElementById('custom-report-consultant-filter').value;
        const startDate = document.getElementById('custom-report-start-date').value;
        const endDate = document.getElementById('custom-report-end-date').value;
        
        let { data, headers } = App.Helpers.getReportData(dataSource, selectedColumns, { consultantId, startDate, endDate, dynamicFilters: App.state.reports.customReportFilters });

        const reportTitle = `Custom ${dataSource.charAt(0).toUpperCase() + dataSource.slice(1)} Report`;
        this.displayReport(reportTitle, headers, data);
    },
    
   generateCustomerRiskReport: function() {
        // 1. Get filter inputs from the UI
        const minBalance = parseFloat(document.getElementById('report-risk-min-balance').value) || 0;
        const daysSinceVisit = parseInt(document.getElementById('report-risk-days-since-visit').value) || 0;
        const onlyMissedPromise = document.getElementById('report-risk-missed-promise').value === 'true';

        let customers = App.DB.get('customers');
        const visits = App.DB.get('visits');
        const today = new Date();
        const daysAgo = new Date(today);
        daysAgo.setDate(today.getDate() - daysSinceVisit);

        // 2. Calculate Score per Customer
        let riskCustomers = customers.map(c => {
            let riskScore = 0;
            let flags = [];
            
            // Get visits for this customer and sort by date (newest first)
            const customerVisits = visits
                .filter(v => v.customerId === c.accountNo)
                .sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));
                
            const lastVisit = customerVisits.find(v => v.status === 'Completed');
            
            // Check for active missed promises
            const missedPromise = customerVisits.some(v => 
                v.outcome === 'Promise to Pay' && 
                v.promiseDate && 
                new Date(v.promiseDate) < today &&
                v.status !== 'Completed' 
            );

            // Factor 1: High Balance (Existing)
            if (c.outstanding >= minBalance) {
                riskScore += 2;
                flags.push(`High Balance (${App.Helpers.formatCurrency(c.outstanding)})`);
            }

            // Factor 2: Legacy Debt (New)
            if (c.balance_lte_2018 > 0) {
                riskScore += 3;
                flags.push(`Has Legacy Debt (<=2018)`);
            }

            // Factor 3: No Recent Contact (Existing)
            if (!lastVisit || new Date(lastVisit.dateTime) < daysAgo) {
                riskScore += 1;
                flags.push(`No Visit in ${daysSinceVisit}+ Days`);
            }

            // Factor 4: Missed Promise (Weighted higher now)
            if (missedPromise) {
                riskScore += 4;
                flags.push('Missed Promise to Pay');
            }

            // Factor 5: "Ghosting" Pattern (New)
            // If the last 2 completed visits were "No Answer", they are avoiding contact.
            const recentOutcomes = customerVisits
                .filter(v => v.status === 'Completed')
                .slice(0, 2)
                .map(v => v.outcome);
                
            if (recentOutcomes.length >= 2 && recentOutcomes.every(o => o === 'No Answer')) {
                riskScore += 2;
                flags.push('Potential Ghosting (Repeated No Answer)');
            }

            return {
                ...c,
                riskScore,
                flags: flags.join('; '),
                lastContact: lastVisit ? App.Helpers.formatDate(lastVisit.dateTime) : 'Never',
                nextAction: lastVisit && new Date(lastVisit.dateTime) >= today ? 'Visit Scheduled' : (missedPromise ? 'Urgent Follow-up' : 'Schedule Visit')
            };
        })
        // Filter out customers with 0 risk (unless they have specific flags you want)
        .filter(c => c.riskScore > 0 && (onlyMissedPromise ? c.flags.includes('Missed Promise') : true))
        .sort((a, b) => b.riskScore - a.riskScore); // Sort highest risk first

        // 3. Prepare Data for Display
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const headers = ['Risk Score', 'Company Name', 'Account #', 'Outstanding', 'Consultant', 'Risk Factors', 'Last Contact', 'Recommended Action'];
        
        const data = riskCustomers.map(c => [
            c.riskScore, 
            c.companyName, 
            c.accountNo, 
            App.Helpers.formatCurrency(c.outstanding), 
            consultantMap[c.salesConsultantId] || 'N/A', 
            c.flags, 
            c.lastContact, 
            c.nextAction
        ]);

        const reportTitle = 'Advanced Risk & Exception Report';
        
        // 4. Display Report
        this.displayReport(
            reportTitle, 
            headers, 
            data, 
            `<div class="alert alert-danger" style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px; color: var(--danger); margin-bottom: 1rem;">
                <strong>Risk Algorithm Updated:</strong> Now includes penalties for Legacy Debt (<=2018) and Ghosting patterns (repeated "No Answer").
             </div>`
        );
    },

    generateComprehensivePerformanceReport: function() {
        const consultantIdFilter = document.getElementById('report-comprehensive-consultant-select').value;
        const monthVal = document.getElementById('report-comprehensive-month-select').value;
        const yearVal = document.getElementById('report-comprehensive-year-select').value;
        const monthFilter = `${yearVal}-${monthVal}`;
        if (!monthVal || !yearVal) return App.UI.toast('Please select a month and year.', 'warning');

        let consultantsToReportOn = consultantIdFilter === 'all' ? App.DB.get('consultants') : App.DB.get('consultants').filter(c => c.id == consultantIdFilter);
        if (consultantsToReportOn.length === 0) return App.UI.toast('No consultants found for selection.', 'info');
        
        const allCustomers = App.DB.get('customers');
        const allPayments = App.DB.get('payments').filter(p => p.status === 'Completed' && p.date.startsWith(monthFilter));
        const allVisits = App.DB.get('visits').filter(v => v.dateTime.startsWith(monthFilter));
        const allForecasts = App.DB.get('forecasts').filter(f => f.month === monthFilter);
        const allCustomerForecasts = App.DB.get('customerForecasts').filter(f => f.month === monthFilter);

        const headers = ['Consultant', 'Assigned Customers', 'Total Outstanding', 'Monthly Target', 'Collected MTD', 'Target %', 'Total Forecast', 'Forecast %', 'Visits Completed', 'New Promises'];
        const reportData = consultantsToReportOn.map(consultant => {
            const assignedCustomers = allCustomers.filter(c => c.salesConsultantId === consultant.id);
            const assignedCustomerIds = assignedCustomers.map(c => c.accountNo);
            const totalOutstanding = assignedCustomers.reduce((sum, c) => sum + c.outstanding, 0);
            
            const totalForecast = allCustomerForecasts
                .filter(f => assignedCustomerIds.includes(f.accountNo))
                .reduce((sum, f) => sum + f.amount, 0);

            const targetAmount = allForecasts.find(f => f.consultantId === consultant.id)?.amount || 0;

            const collectedPayments = allPayments.filter(p => assignedCustomerIds.includes(p.customerId));
            const collectedAmount = collectedPayments.reduce((sum, p) => sum + p.amount, 0);

            const completedVisits = allVisits.filter(v => v.collectorId === consultant.id && v.status === 'Completed').length;
            const newPromises = allVisits.filter(v => v.collectorId === consultant.id && v.outcome === 'Promise to Pay' && v.status === 'Completed' && v.promiseDate).length;

            const targetPercentage = targetAmount > 0 ? ((collectedAmount / targetAmount) * 100).toFixed(1) + '%' : 'N/A';
            const forecastPercentage = totalForecast > 0 ? ((collectedAmount / totalForecast) * 100).toFixed(1) + '%' : 'N/A';

            return [
                consultant.name, assignedCustomers.length, App.Helpers.formatCurrency(totalOutstanding),
                App.Helpers.formatCurrency(targetAmount), App.Helpers.formatCurrency(collectedAmount),
                targetPercentage, App.Helpers.formatCurrency(totalForecast), forecastPercentage,
                completedVisits, newPromises
            ];
        }).sort((a,b) => App.Helpers.parseCurrency(b[4]) - App.Helpers.parseCurrency(a[4])); // Sort by Collected Amount

        const totalCollected = reportData.reduce((sum, row) => sum + App.Helpers.parseCurrency(row[4]), 0);
        const totalTarget = allForecasts.reduce((sum, f) => sum + f.amount, 0);
        const totalForecasted = allCustomerForecasts.reduce((sum, f) => sum + f.amount, 0);
        
        const summaryContent = `<div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: var(--spacing-4);"><div class="detail-info-card"><div class="label">Total Collected</div><div class="value" style="color: var(--success);">${App.Helpers.formatCurrency(totalCollected)}</div></div><div class="detail-info-card"><div class="label">Total Monthly Target</div><div class="value">${App.Helpers.formatCurrency(totalTarget)}</div></div><div class="detail-info-card"><div class="label">Total Customer Forecast</div><div class="value">${App.Helpers.formatCurrency(totalForecasted)}</div></div></div>`;

        this.displayReport(`Comprehensive Performance for ${monthFilter}`, headers, reportData, summaryContent);
    },
    
    generateAgingCollectionReport: function() {
        const consultantFilter = document.getElementById('report-aging-collection-consultant-select').value;
        const startDate = document.getElementById('report-aging-collection-start-date').value;
        const endDate = document.getElementById('report-aging-collection-end-date').value;
        if (!startDate || !endDate) return App.UI.toast('Please select a start and end date.', 'warning');
        
        let payments = App.DB.get('payments').filter(p => p.status === 'Completed' && p.date >= startDate && p.date <= endDate);
        
        if (consultantFilter !== 'all') {
             const customerIds = App.DB.get('customers').filter(c => c.salesConsultantId == consultantFilter).map(c => c.accountNo);
             payments = payments.filter(p => customerIds.includes(p.customerId));
        }

        const totalCollected = payments.reduce((sum, p) => sum + p.amount, 0);
        const collectedLte2018 = payments.reduce((sum, p) => sum + (p.amount_lte_2018 || 0), 0);
        const collected2019_2020 = payments.reduce((sum, p) => sum + (p.amount_2019_2020 || 0), 0);
        const collected2020_2025 = payments.reduce((sum, p) => sum + (p.amount_2020_2025 || 0), 0);
        
        const agingData = [
            { category: '<=2018', amount: collectedLte2018, color: '#e2000f' },
            { category: '2019-2020', amount: collected2019_2020, color: '#ffc107' },
            { category: '2020-2025', amount: collected2020_2025, color: '#10b981' }
        ];

        const summaryContent = `<div class="detail-info-grid" style="grid-template-columns: 1fr; margin-bottom: var(--spacing-4);"><div class="detail-info-card full-width"><div class="label">Total Collected</div><div class="value" style="color: var(--success);">${App.Helpers.formatCurrency(totalCollected)}</div></div></div>`;
        
        const tableHeaders = ['Aging Category', 'Collected Amount', 'Percentage of Total'];
        const tableData = agingData.map(d => [d.category, App.Helpers.formatCurrency(d.amount), totalCollected > 0 ? ((d.amount / totalCollected) * 100).toFixed(1) + '%' : '0%']);
        
        let content = `${summaryContent}<h4 class="card-title mt-4 mb-4">Collection Breakdown</h4><div class="table-container mb-6"><table class="data-table"><thead><tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${tableData.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
        content += `<div class="chart-container" style="max-width: 500px; margin: 0 auto;"><canvas id="aging-collection-chart"></canvas></div>`;
        
        this.displayReport(`Collection by Aging Category (${App.Helpers.formatDate(startDate)} - ${App.Helpers.formatDate(endDate)})`, [], [], content);

        if(this.charts && this.charts.agingCollection) this.charts.agingCollection.destroy();
        this.charts.agingCollection = new Chart(document.getElementById('aging-collection-chart'), {
            type: 'doughnut',
            data: { 
                labels: agingData.map(d => d.category), 
                datasets: [{ 
                    data: agingData.map(d => d.amount), 
                    backgroundColor: agingData.map(d => d.color), 
                }] 
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'var(--text-primary)' } } } }
        });
    },

    updateActivityReportView() {
        document.getElementById('activity-report-summary-btn').classList.toggle('active', App.state.reports.activityView === 'summary');
        document.getElementById('activity-report-table-btn').classList.toggle('active', App.state.reports.activityView === 'table');
        if (document.getElementById('report-modal-body').innerHTML.trim() !== '') {
            this.generateActivityReport();
        }
    },
    generateActivityReport: function() { 
        const consultantId = document.getElementById('report-consultant-select').value;
        const consultantIdParsed = consultantId === 'all' ? 'all' : parseInt(consultantId);
        
        const customerId = App.Reports.activityCustomerDropdown.getValue();
        
        const getConsultantName = (id) => App.DB.get('consultants').find(c => c.id === id)?.name || 'All Consultants';
        const consultantName = consultantId === 'all' ? 'All Consultants' : getConsultantName(consultantIdParsed);

        const startDate = document.getElementById('report-activity-start-date').value; 
        const endDate = document.getElementById('report-activity-end-date').value;
        if (!startDate || !endDate) { return App.UI.toast('Please select both a start and end date.', 'warning'); }
        
        let log = App.DB.get('activityLog').filter(entry => 
            (consultantId === 'all' || entry.consultantId === consultantIdParsed) && 
            entry.date >= startDate && 
            entry.date <= endDate
        ); 
        
        if (customerId && customerId !== 'all') {
            log = log.filter(entry => entry.customerId === customerId);
        }

        if (log.length === 0) { 
            this.displayReport(`Activity for ${consultantName}`, [], [], `<div class="empty-state"><i class="fas fa-search"></i><h4>No Activity Found</h4><p>No logged activity between ${App.Helpers.formatDate(startDate)} and ${App.Helpers.formatDate(endDate)}.</p></div>`);
            return;
        } 
        
        const reportTitle = `Activity for ${consultantName} (${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)})`; 
        
        if (App.state.reports.activityView === 'summary') { 
            // 1. KPI Calculations
            const activityByDay = log.reduce((acc, entry) => { (acc[entry.date] = acc[entry.date] || []).push(entry); return acc; }, {});
            const attendanceSummary = Object.entries(activityByDay).map(([date, entries]) => {
                const startEntry = entries.find(e => e.action === 'Started Day');
                const endEntry = entries.find(e => e.action === 'Ended Day');
                const totalBreakTime = entries.filter(e => e.action === 'Ended Break' && e.duration).reduce((sum, e) => sum + e.duration, 0);
                const workDuration = startEntry && endEntry ? (endEntry.timestamp - startEntry.timestamp) - totalBreakTime : 0;
                return { date, startTime: startEntry ? startEntry.time : 'N/A', endTime: endEntry ? endEntry.time : 'N/A', breakDuration: App.Helpers.formatDuration(totalBreakTime), workDuration: workDuration > 0 ? App.Helpers.formatDuration(workDuration) : 'N/A' };
            }).sort((a,b) => new Date(a.date) - new Date(b.date));

            // Case-insensitive checks for counters
            const completedVisits = log.filter(e => e.action.toLowerCase().includes('completed visit')).length; 
            const startedVisits = log.filter(e => e.action.toLowerCase().includes('started visit')).length;
            const gpsViolations = log.filter(e => e.action.includes('GPS BYPASSED')).length;
            const recordedPayments = log.filter(e => e.action.toLowerCase().includes('recorded a payment') || e.action.toLowerCase().includes('payment')).length; 
            const totalRecovered = log.filter(e => e.action.toLowerCase().includes('payment') && e.amount).reduce((sum, p) => sum + (p.amount || 0), 0);
            
            // 2. Summary Cards HTML
            const visitSummaryHTML = `
                <div class="detail-info-card">
                    <div class="label">VISIT FLOW</div>
                    <div class="value" style="font-size: 1rem;">
                        <div><i class="fas fa-play" style="color:var(--success); font-size: 0.8rem;"></i> Started: ${startedVisits}</div>
                        <div><i class="fas fa-check" style="color:var(--primary); font-size: 0.8rem;"></i> Completed: ${completedVisits}</div>
                    </div>
                </div>
            `;

            const violationHTML = gpsViolations > 0 
                ? `<div class="detail-info-card" style="border-color:var(--danger); background:rgba(220,53,69,0.05);"><div class="label" style="color:var(--danger);">GPS VIOLATIONS</div><div class="value" style="color:var(--danger);">${gpsViolations}</div></div>` 
                : '';

            let summaryContent = `<h4 class="card-title" style="font-size: var(--fs-lg); margin-bottom: var(--spacing-4);">Performance Summary</h4><div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));"><div class="detail-info-card"><div class="label">ACTIVE DAYS</div><div class="value">${attendanceSummary.length}</div></div>${visitSummaryHTML}${violationHTML}<div class="detail-info-card"><div class="label">PAYMENTS RECORDED</div><div class="value">${recordedPayments}</div></div><div class="detail-info-card"><div class="label">TOTAL RECOVERED</div><div class="value" style="color:var(--success);">${App.Helpers.formatCurrency(totalRecovered)}</div></div></div>`;
            
            // 3. Detailed Timeline Table (Fixed Filter)
            const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c; return map;}, {});
            const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map;}, {});

            // Filter for "interesting" events - NOW CASE INSENSITIVE
            const timelineEvents = log.filter(e => {
                const act = e.action.toLowerCase();
                return act.includes('visit') || act.includes('gps') || act.includes('payment');
            }).sort((a,b) => b.timestamp - a.timestamp);

            let tableRows = '<tr><td colspan="5" style="text-align:center; color:var(--text-secondary);">No timeline events found for this period.</td></tr>';

            if (timelineEvents.length > 0) {
                tableRows = timelineEvents.map(e => {
                    const customer = e.customerId ? customerMap[e.customerId] : null;
                    const customerName = customer ? customer.companyName : '-';
                    const consName = consultantMap[e.consultantId] || 'Unknown';
                    
                    let style = '';
                    let actionLabel = e.action;
                    const actLower = e.action.toLowerCase();

                    // Clean up labels and styles
                    if(actLower.includes('gps')) {
                        style = 'color:var(--danger); font-weight:bold;';
                        actionLabel = ' GPS Violation';
                    }
                    else if(actLower.includes('started')) {
                        style = 'color:var(--success);';
                        actionLabel = ' Started Visit';
                    }
                    else if(actLower.includes('completed')) {
                        style = 'color:var(--primary);';
                        actionLabel = ' Completed Visit';
                    }
                    else if(actLower.includes('payment')) {
                        style = 'color:#ffc107;';
                        actionLabel = ' Payment';
                    }
                    
                    return `<tr>
                        <td style="white-space:nowrap;">${App.Helpers.formatDate(e.date)} ${e.time}</td>
                        <td>${consName}</td>
                        <td style="${style}">${actionLabel}</td>
                        <td>${customerName}</td>
                        <td style="font-size:0.9em; color:var(--text-secondary);">${e.details || '-'}</td>
                    </tr>`;
                }).join('');
            }

            summaryContent += `
                <hr style="border: 0; border-top: 2px solid var(--border-color); margin: var(--spacing-6) 0;">
                <h4 class="card-title mb-4">Detailed Visit & Security Timeline</h4>
                <div class="table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                    <table class="data-table">
                        <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 1;">
                            <tr><th>Time</th><th>Consultant</th><th>Action</th><th>Customer</th><th>Details</th></tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;

            this.displayReport(reportTitle, [], [], summaryContent); 
        } else { 
            // --- TABLE VIEW (Case Insensitive Updates) ---
            const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c; return map;}, {});
            const visitMap = App.DB.get('visits').reduce((map, v) => { map[v.id] = v; return map; }, {});
            const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map;}, {});

            const headers = ['Date', 'Time', 'Consultant', 'Category', 'Customer', 'Action/Outcome', 'Details/Notes', 'Amount'];
            
            const data = log.sort((a, b) => a.timestamp - b.timestamp).map(entry => {
                const customer = entry.customerId ? customerMap[entry.customerId] : null;
                const rowConsultantName = consultantMap[entry.consultantId] || 'Unknown';
                
                let customerName = customer ? customer.companyName : '-'; 
                let category = 'General'; 
                let actionOutcome = entry.action; 
                let notes = entry.details || '-'; 
                let amount = '-'; 
                const actLower = entry.action.toLowerCase();

                if (actLower.includes('gps bypassed')) {
                    category = ' SECURITY';
                    actionOutcome = 'GPS Check Bypassed';
                    notes = `<span style="color:var(--danger); font-weight:600;">${entry.details}</span>`;
                }
                else if (actLower.includes('started visit')) {
                    category = 'Visit';
                    actionOutcome = ' Check-In';
                    notes = 'Clock started';
                }
                else if (actLower.includes('completed visit')) {
                    category = 'Visit';
                    actionOutcome = ' Check-Out';
                    notes = entry.details;
                }
                else if (actLower.includes('day') || actLower.includes('break')) { 
                    category = 'Attendance';
                } else if (actLower.includes('payment')) {
                    category = 'Payment';
                    const paymentDetails = App.Helpers.parsePaymentDetails(entry.details);
                    actionOutcome = paymentDetails.method;
                    if (entry.amount && typeof entry.amount === 'number') amount = App.Helpers.formatCurrency(entry.amount);
                } else if (actLower.includes('added a new customer')) {
                    category = 'Customer'; actionOutcome = 'New Account';
                }

                return [
                    App.Helpers.formatDate(entry.date), 
                    entry.time, 
                    rowConsultantName,
                    category, 
                    customerName, 
                    actionOutcome, 
                    notes, 
                    amount
                ];
            });
            this.displayReport(reportTitle, headers, data); 
        } 
    },
    generateCollectionReport: function() {
        const startDate = document.getElementById('report-collection-start-date').value;
        const endDate = document.getElementById('report-collection-end-date').value;
        const methodFilter = document.getElementById('report-collection-method-filter').value;
        if (!startDate || !endDate) return App.UI.toast('Please select a start and end date.', 'warning');
        
        let payments = App.DB.get('payments').filter(p => p.status === 'Completed' && p.date >= startDate && p.date <= endDate);
        if (methodFilter !== 'all') payments = payments.filter(p => p.method === methodFilter);
        
        const totalCollected = payments.reduce((sum, p) => sum + p.amount, 0);
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = { name: c.companyName, consultantId: c.salesConsultantId }; return map; }, {});
        const headers = ['Date', 'Customer', 'Amount', 'Method', 'Consultant'];
        const data = payments.sort((a, b) => new Date(a.date) - new Date(b.date)).map(p => { const customer = customerMap[p.customerId]; const consultantName = customer ? consultantMap[customer.consultantId] : 'N/A'; return [ App.Helpers.formatDate(p.date), customer ? customer.name : 'N/A', App.Helpers.formatCurrency(p.amount), p.method, consultantName ]; });
        const summaryContent = `<div class="detail-info-grid" style="grid-template-columns: 1fr; margin-bottom: var(--spacing-4);"><div class="detail-info-card"><div class="label">Total Collected from ${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)}</div><div class="value" style="color: var(--success);">${App.Helpers.formatCurrency(totalCollected)}</div></div></div>`;
        const reportTitle = `Collection Details from ${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)}`;
        this.displayReport(reportTitle, headers, data, summaryContent);
    },
    generateAgingReport: function() {
        const customers = App.DB.get('customers').filter(c => c.outstanding > 0);
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const headers = ['Account #', 'Company Name', 'Outstanding', 'Consultant', 'Aging Category'];
        const data = customers.map(c => [c.accountNo, c.companyName, App.Helpers.formatCurrency(c.outstanding), consultantMap[c.salesConsultantId] || 'N/A', c.agingCategory || 'N/A']).sort((a, b) => { const order = { '180+ Days': 0, '91-180 Days': 1, '61-90 Days': 2, '31-60 Days': 3, 'Current (0-30 Days)': 4 }; return (order[a[4]] || 99) - (order[b[4]] || 99); });
        this.displayReport('Customer Aging Report', headers, data);
    },
	generateDetailedAgingReport: function() {
        const startDate = document.getElementById('report-aging-start-date').value;
        const endDate = document.getElementById('report-aging-end-date').value;
        const consultantFilter = document.getElementById('report-aging-consultant-select').value;
        const customerFilter = document.querySelector('#report-aging-customer-select-container input[type="hidden"]').value;
    
        if (!startDate || !endDate) return App.UI.toast('Please select a start and end date.', 'warning');
        
        const allCustomers = App.DB.get('customers');
        let filteredCustomers = allCustomers;
        if (consultantFilter !== 'all') filteredCustomers = filteredCustomers.filter(c => c.salesConsultantId == consultantFilter);
        if (customerFilter && customerFilter !== 'all') filteredCustomers = filteredCustomers.filter(c => c.accountNo === customerFilter);
        
        const paymentsInPeriod = App.DB.get('payments').filter(p => p.status === 'Completed' && p.date >= startDate && p.date <= endDate);
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});

        const customerData = filteredCustomers.map(c => {
            const collectedPayments = paymentsInPeriod.filter(p => p.customerId === c.accountNo);
            
            // Collected amounts in the current period by category
            const collected_2020_2025 = collectedPayments.reduce((sum, p) => sum + (p.amount_2020_2025 || 0), 0);
            const collected_2019_2020 = collectedPayments.reduce((sum, p) => sum + (p.amount_2019_2020 || 0), 0);
            const collected_lte_2018 = collectedPayments.reduce((sum, p) => sum + (p.amount_lte_2018 || 0), 0);
            const collectedInPeriod = collected_2020_2025 + collected_2019_2020 + collected_lte_2018;

            // Initial Balance (Current Outstanding + Collected in Period)
            const initial_2020_2025 = (c.balance_2020_2025 || 0) + collected_2020_2025;
            const initial_2019_2020 = (c.balance_2019_2020 || 0) + collected_2019_2020;
            const initial_lte_2018 = (c.balance_lte_2018 || 0) + collected_lte_2018;
            const totalInitialBalance = c.outstanding + collectedInPeriod;

            // Determine oldest debt category
            let oldestDebtCategory = 'N/A';
            if (initial_lte_2018 > 0) { oldestDebtCategory = '<=2018'; } else if (initial_2019_2020 > 0) { oldestDebtCategory = '2019-2020'; } else if (initial_2020_2025 > 0) { oldestDebtCategory = '2020-2025'; }

            return { 
                accountNo: c.accountNo,
                name: c.companyName, 
                consultant: consultantMap[c.salesConsultantId] || 'N/A', 
                totalInitialBalance, 
                collectedInPeriod, 
                remainingBalance: c.outstanding, 
                oldestDebtCategory,
                initial_2020_2025, initial_2019_2020, initial_lte_2018,
                collected_2020_2025, collected_2019_2020, collected_lte_2018
            };
        }).filter(c => c.totalInitialBalance > 0);
        
        const summary = customerData.reduce((acc, curr) => ({ 
            initial: acc.initial + curr.totalInitialBalance, 
            collected: acc.collected + curr.collectedInPeriod, 
            remaining: acc.remaining + curr.remainingBalance 
        }), { initial: 0, collected: 0, remaining: 0 });
        
        const summaryContent = `<h4 class="card-title mb-4">Summary</h4><div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));"><div class="detail-info-card"><div class="label">Total Initial Balance</div><div class="value">${App.Helpers.formatCurrency(summary.initial)}</div></div><div class="detail-info-card"><div class="label">Total Collected in Period</div><div class="value" style="color: var(--success);">${App.Helpers.formatCurrency(summary.collected)}</div></div><div class="detail-info-card"><div class="label">Total Remaining Balance</div><div class="value">${App.Helpers.formatCurrency(summary.remaining)}</div></div></div>`;
        
        const detailHeaders = [
            'Customer', 'Consultant', 'Remaining Balance', 
            'Initial <=2018', 'Collected <=2018', 
            'Initial 2019-2020', 'Collected 2019-2020', 
            'Initial 2020-2025', 'Collected 2020-2025'
        ];
        
        const detailData = customerData.sort((a,b) => b.remainingBalance - a.remainingBalance).map(c => [ 
            c.name, c.consultant, App.Helpers.formatCurrency(c.remainingBalance), 
            App.Helpers.formatCurrency(c.initial_lte_2018), App.Helpers.formatCurrency(c.collected_lte_2018), 
            App.Helpers.formatCurrency(c.initial_2019_2020), App.Helpers.formatCurrency(c.collected_2019_2020), 
            App.Helpers.formatCurrency(c.initial_2020_2025), App.Helpers.formatCurrency(c.collected_2020_2025)
        ]);
        
        this.displayReport(`Detailed Aging from ${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)}`, detailHeaders, detailData, `${summaryContent}<h4 class="card-title mt-6 mb-4">Customer Breakdown</h4>`);
    },
    generateCustomerReport: function() { const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {}); const c = App.Helpers.getScopedData('customers'), h = ['Account #', 'Company Name', 'Emirate', 'Outstanding', 'Consultant', 'Status'], d = c.map(i => [i.accountNo, i.companyName, i.emirate, App.Helpers.formatCurrency(i.outstanding), consultantMap[i.salesConsultantId], i.status]); this.displayReport('Customer List Report', h, d); },
    generateConsultantReport: function() { const c = App.Helpers.getScopedData('customers'); const startDate = document.getElementById('report-standard-start-date').value; const endDate = document.getElementById('report-standard-end-date').value; let v = App.DB.get('visits'); if(startDate && endDate) { v = v.filter(visit => visit.dateTime >= startDate && visit.dateTime <= endDate); } const consultantMap = App.DB.get('consultants').reduce((map, con) => { map[con.id] = { name: con.name, customers: 0, totalDebt: 0, visits: 0 }; return map; }, {}); c.forEach(i => { if (consultantMap[i.salesConsultantId]) { consultantMap[i.salesConsultantId].customers++; consultantMap[i.salesConsultantId].totalDebt += i.outstanding; } }); v.forEach(i => { if (consultantMap[i.collectorId]) consultantMap[i.collectorId].visits++; }); const h = ['Consultant', 'Assigned Customers', 'Total Outstanding', 'Total Visits'], d = Object.values(consultantMap).map(s => [s.name, s.customers, App.Helpers.formatCurrency(s.totalDebt), s.visits]); this.displayReport('Consultant Activity Report', h, d); },
    generateOverdueReport: function() { const customers = App.Helpers.getScopedData('customers').filter(c => c.paymentStatus === 'Overdue'); const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {}); const headers = ['Account #', 'Company Name', 'Outstanding', 'Consultant', 'Emirate']; const data = customers.map(c => [c.accountNo, c.companyName, App.Helpers.formatCurrency(c.outstanding), consultantMap[c.salesConsultantId], c.emirate]); this.displayReport('Overdue Accounts Report', headers, data); },
    generateRecoveryPerformanceReport: function() { const consultants = App.DB.get('consultants'); const customers = App.Helpers.getScopedData('customers'); const headers = ['Consultant', 'Total Initial Debt', 'Total Outstanding', 'Total Recovered', 'Recovery Rate']; const data = consultants.map(consultant => { const assignedCustomers = customers.filter(c => c.salesConsultantId === consultant.id); const initialDebt = assignedCustomers.reduce((sum, c) => sum + c.initialDebt, 0); const outstandingDebt = assignedCustomers.reduce((sum, c) => sum + c.outstanding, 0); const recovered = initialDebt - outstandingDebt; const recoveryRate = initialDebt > 0 ? ((recovered / initialDebt) * 100).toFixed(2) + '%' : 'N/A'; return [consultant.name, App.Helpers.formatCurrency(initialDebt), App.Helpers.formatCurrency(outstandingDebt), App.Helpers.formatCurrency(recovered), recoveryRate]; }); this.displayReport('Debt Recovery Performance Report', headers, data); },
    generateVisitOutcomeReport: function() { const visits = App.DB.get('visits').filter(v => v.status === 'Completed' && v.outcome); const outcomeCounts = visits.reduce((acc, visit) => { acc[visit.outcome] = (acc[visit.outcome] || 0) + 1; return acc; }, {}); const labels = Object.keys(outcomeCounts); const data = Object.values(outcomeCounts); const content = `<div class="chart-container" style="height: 400px;"><canvas id="outcome-chart"></canvas></div>`; this.displayReport('Visit Outcome Analysis', [], [], content); if(this.charts && this.charts.outcome) this.charts.outcome.destroy(); this.charts.outcome = new Chart(document.getElementById('outcome-chart'), { type: 'pie', data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#e2000f', '#10b981', '#ffc107', '#dc3545', '#0d6efd', '#84cc16'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'var(--text-primary)' } } } } }); },
    generateConsultantVisitsReport: function() {
        const consultantFilter = document.getElementById('report-visits-consultant-select').value;
        const startDate = document.getElementById('report-visits-start-date').value;
        const endDate = document.getElementById('report-visits-end-date').value;
        if (!startDate || !endDate) return App.UI.toast('Please select a start and end date.', 'warning');
        let visits = App.DB.get('visits').filter(visit => { const visitDate = visit.dateTime.slice(0, 10); return visitDate >= startDate && visitDate <= endDate; });
        let consultantsToReportOn = consultantFilter === 'all' ? App.DB.get('consultants') : App.DB.get('consultants').filter(c => c.id == consultantFilter);
        const customers = App.DB.get('customers'); const consultantData = {};
        consultantsToReportOn.forEach(c => { consultantData[c.id] = { name: c.name, totalVisits: 0, completedVisits: 0, scheduledVisits: 0, overdueVisits: 0, successfulVisits: 0, visitDetails: [] }; });
        visits.forEach(visit => {
            if (!consultantData[visit.collectorId]) return;
            const customerName = customers.find(c => c.accountNo === visit.customerId)?.companyName || 'N/A';
            consultantData[visit.collectorId].totalVisits++;
            if (visit.status === 'Completed') { consultantData[visit.collectorId].completedVisits++; if (['Paid in Full', 'Partial Payment', 'Promise to Pay'].includes(visit.outcome)) consultantData[visit.collectorId].successfulVisits++; } 
            else if (visit.status === 'Scheduled') consultantData[visit.collectorId].scheduledVisits++; 
            else if (visit.status === 'Overdue') consultantData[visit.collectorId].overdueVisits++;
            consultantData[visit.collectorId].visitDetails.push({ date: App.Helpers.formatDateTime(visit.dateTime), customer: customerName, accountNo: visit.customerId, purpose: visit.purpose, status: visit.status, outcome: visit.outcome || 'N/A', contactMethod: visit.contactMethod || 'N/A', notes: visit.notes ? App.Helpers.stripHtml(visit.notes).substring(0, 100) + '...' : 'N/A' });
        });
        let content = `<div class="mb-4"><p class="text-secondary">Showing data from ${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)}</p></div>`;
        const summaryHeaders = ['Consultant', 'Total Visits', 'Completed', 'Scheduled', 'Overdue', 'Success Rate'];
        const summaryData = Object.values(consultantData).map(data => [data.name, data.totalVisits, data.completedVisits, data.scheduledVisits, data.overdueVisits, data.completedVisits > 0 ? ((data.successfulVisits / data.completedVisits) * 100).toFixed(1) + '%' : '0%']);
        content += `<h4 class="card-title mb-4">Visit Summary by Consultant</h4><div class="table-container mb-6"><table class="data-table"><thead><tr>${summaryHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${summaryData.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
        content += '<h4 class="card-title mb-4">Detailed Visit History</h4>';
        Object.values(consultantData).forEach(consultant => { if (consultant.visitDetails.length > 0) { content += `<div class="card mb-4" style="background: var(--bg-color);"><div class="card-header"><h5 style="margin: 0; color: var(--primary);">${consultant.name} - ${consultant.totalVisits} Visits</h5></div><div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Customer</th><th>Account #</th><th>Purpose</th><th>Status</th><th>Outcome</th><th>Contact Method</th><th>Notes</th></tr></thead><tbody>${consultant.visitDetails.map(visit => `<tr><td>${visit.date}</td><td>${visit.customer}</td><td>${visit.accountNo}</td><td>${visit.purpose}</td><td><span class="status-badge ${visit.status.toLowerCase()}">${visit.status}</span></td><td>${visit.outcome}</td><td>${visit.contactMethod}</td><td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${visit.notes}</td></tr>`).join('')}</tbody></table></div></div>`; } });
        this.currentConsultantVisitsData = { summary: { headers: summaryHeaders, data: summaryData }, details: Object.values(consultantData) };
        this.displayReport('Consultant Visits Report', [], [], content, ['csv_visits', 'pdf_visits']);
    },
    generateTargetPerformanceReport: function() {
        const consultantIdFilter = document.getElementById('report-target-consultant-select').value;
        const monthVal = document.getElementById('report-target-month-select').value;
        const yearVal = document.getElementById('report-target-year-select').value;
        const monthFilter = `${yearVal}-${monthVal}`;
        if (!monthVal || !yearVal) return App.UI.toast('Please select a month and year.', 'warning');
        const consultantsToReportOn = consultantIdFilter === 'all' ? App.DB.get('consultants') : App.DB.get('consultants').filter(c => c.id == consultantIdFilter);
        const reportData = consultantsToReportOn.map(consultant => {
            const targetAmount = App.DB.get('forecasts').find(f => f.consultantId === consultant.id && f.month === monthFilter)?.amount || 0;
            const collectedAmount = App.DB.get('payments').filter(p => p.status === 'Completed' && App.DB.get('customers').filter(c => c.salesConsultantId === consultant.id).map(c => c.accountNo).includes(p.customerId) && p.date.startsWith(monthFilter)).reduce((sum, p) => sum + p.amount, 0);
            return [ consultant.name, App.Helpers.formatCurrency(targetAmount), App.Helpers.formatCurrency(collectedAmount), targetAmount > 0 ? ((collectedAmount / targetAmount) * 100).toFixed(2) + '%' : 'N/A' ];
        });
        this.displayReport(`Target Performance for ${monthFilter}`, ['Consultant', 'Target Amount', 'Collected Amount', 'Performance'], reportData);
    },
    generateForecastPerformanceReport: function() {
        const consultantIdFilter = document.getElementById('report-forecast-consultant-select').value;
        const monthVal = document.getElementById('report-forecast-month-select').value;
        const yearVal = document.getElementById('report-forecast-year-select').value;
        const monthFilter = `${yearVal}-${monthVal}`;
        if (!monthVal || !yearVal) return App.UI.toast('Please select a month and year.', 'warning');
        const consultantsToReportOn = consultantIdFilter === 'all' ? App.DB.get('consultants') : App.DB.get('consultants').filter(c => c.id == consultantIdFilter);
        const reportData = consultantsToReportOn.map(consultant => {
            const consultantCustomers = App.DB.get('customers').filter(c => c.salesConsultantId === consultant.id);
            const consultantCustomerIds = consultantCustomers.map(c => c.accountNo);
            const forecastedAmount = App.DB.get('customerForecasts')
                .filter(f => f.month === monthFilter && consultantCustomerIds.includes(f.accountNo))
                .reduce((sum, f) => sum + f.amount, 0);
            const collectedAmount = App.DB.get('payments').filter(p => p.status === 'Completed' && consultantCustomerIds.includes(p.customerId) && p.date.startsWith(monthFilter)).reduce((sum, p) => sum + p.amount, 0);
            return [ consultant.name, App.Helpers.formatCurrency(forecastedAmount), App.Helpers.formatCurrency(collectedAmount), forecastedAmount > 0 ? ((collectedAmount / forecastedAmount) * 100).toFixed(2) + '%' : 'N/A' ];
        });
        this.displayReport(`Forecast Performance for ${monthFilter}`, ['Consultant', 'Forecasted Amount', 'Collected Amount', 'Performance'], reportData);
    },
    generateStatusTargetPerformanceReport: function() {
        const consultantIdFilter = document.getElementById('report-status-target-consultant-select').value;
        const monthVal = document.getElementById('report-status-target-month-select').value;
        const yearVal = document.getElementById('report-status-target-year-select').value;
        const monthFilter = `${yearVal}-${monthVal}`;
        if (!monthVal || !yearVal) return App.UI.toast('Please select a month and year.', 'warning');
        
        const consultantsToReportOn = consultantIdFilter === 'all' ? App.DB.get('consultants') : App.DB.get('consultants').filter(c => c.id == consultantIdFilter);
        const allCustomers = App.DB.get('customers');
        const paymentsInMonth = App.DB.get('payments').filter(p => p.date.startsWith(monthFilter) && p.status === 'Completed');
        const allForecasts = App.DB.get('forecasts').filter(f => f.month === monthFilter);

        let reportData = [];
        const customerStatuses = ['Collectors', 'Sales (Above 3 Months)', 'Sales (Above 360 Days)'];

        consultantsToReportOn.forEach(consultant => {
            const consultantForecast = allForecasts.find(f => f.consultantId === consultant.id);
            if (!consultantForecast) return;

            customerStatuses.forEach(status => {
                const key = `amount_${status.replace(/\s/g, '').replace(/[()+]/g, '')}`;
                const targetAmount = consultantForecast[key] || 0;
                
                const customersInStatus = allCustomers.filter(c => c.salesConsultantId === consultant.id && c.customerStatus === status).map(c => c.accountNo);
                const collectedAmount = paymentsInMonth.filter(p => customersInStatus.includes(p.customerId)).reduce((sum, p) => sum + p.amount, 0);
                
                reportData.push([
                    consultant.name,
                    status,
                    App.Helpers.formatCurrency(targetAmount),
                    App.Helpers.formatCurrency(collectedAmount),
                    targetAmount > 0 ? `${((collectedAmount / targetAmount) * 100).toFixed(1)}%` : 'N/A'
                ]);
            });
        });

        this.displayReport(
            `Status Target Performance for ${monthFilter}`,
            ['Consultant', 'Customer Status', 'Target Amount', 'Collected Amount', 'Performance %'],
            reportData
        );
    },
    exportConsultantVisitsCSV: function() {
        if (!this.currentConsultantVisitsData) return App.UI.toast('No report data to export.', 'error');
        let csvContent = `Consultant Visits Report\nGenerated on: ${new Date().toLocaleDateString()}\n\nVISIT SUMMARY\n`;
        csvContent += this.currentConsultantVisitsData.summary.headers.join(",") + "\n";
        this.currentConsultantVisitsData.summary.data.forEach(row => { csvContent += row.join(",") + "\n"; });
        csvContent += "\nDETAILED VISITS\nConsultant,Date,Customer,Account #,Purpose,Status,Outcome,Contact Method,Notes\n";
        this.currentConsultantVisitsData.details.forEach(consultant => {
            consultant.visitDetails.forEach(visit => {
                const row = [consultant.name, visit.date, visit.customer, visit.accountNo, visit.purpose, visit.status, visit.outcome, visit.contactMethod, `"${(visit.notes || '').replace(/"/g, '""')}"`];
                csvContent += row.join(",") + "\n";
            });
        });
        App.Helpers.downloadBlob(csvContent, `Consultant_Visits_Report_${new Date().toLocaleDateString()}.csv`, 'text/csv;charset=utf-8;');
        App.UI.toast('Visits report exported to CSV!', 'success');
    },
    exportConsultantVisitsPDF: function() {
        if (!this.currentConsultantVisitsData) return App.UI.toast('No report data to export.', 'error');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18); doc.text('Consultant Visits Report', 14, 22);
        doc.setFontSize(11); doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 32);
        doc.setFontSize(14); doc.text('Visit Summary', 14, 45);
        doc.autoTable({ head: [this.currentConsultantVisitsData.summary.headers], body: this.currentConsultantVisitsData.summary.data.map(row => row.map(String)), startY: 50, theme: 'grid' });
        let finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(14); doc.text('Detailed Visits (Sample)', 14, finalY);
        const detailedVisits = this.currentConsultantVisitsData.details.flatMap(consultant => consultant.visitDetails.slice(0, 10).map(visit => [consultant.name, visit.date, visit.customer, visit.status, visit.outcome]));
        if (detailedVisits.length > 0) {
            doc.autoTable({ head: [['Consultant', 'Date', 'Customer', 'Status', 'Outcome']], body: detailedVisits, startY: finalY + 10, theme: 'grid' });
        }
        doc.save(`Consultant_Visits_Report_${new Date().toLocaleDateString()}.pdf`);
        App.UI.toast('Visits report exported to PDF!', 'success');
    },
    generateCustomerStatusReport: function() {
        const customers = App.Helpers.getScopedData('customers');
        const totalCustomers = customers.length;
        const totalOutstanding = customers.reduce((sum, c) => sum + c.outstanding, 0);

        const statusCounts = customers.reduce((acc, customer) => {
            const status = customer.customerStatus || 'Uncategorized';
            if (!acc[status]) {
                acc[status] = { count: 0, totalOutstanding: 0, overdueCount: 0 };
            }
            acc[status].count++;
            acc[status].totalOutstanding += customer.outstanding;
            if (customer.paymentStatus === 'Overdue') {
                acc[status].overdueCount++;
            }
            return acc;
        }, {});

        const labels = Object.keys(statusCounts).sort();
        
        const tableHeaders = ['Status', '# of Customers', '% of Customers', 'Total Outstanding', '% of Total Outstanding', 'Avg. Outstanding', 'Overdue Accounts'];
        const tableData = labels.map(label => [
            label,
            statusCounts[label].count,
            totalCustomers > 0 ? `${((statusCounts[label].count / totalCustomers) * 100).toFixed(1)}%` : '0.0%',
            App.Helpers.formatCurrency(statusCounts[label].totalOutstanding),
            totalOutstanding > 0 ? `${((statusCounts[label].totalOutstanding / totalOutstanding) * 100).toFixed(1)}%` : '0.0%',
            App.Helpers.formatCurrency(statusCounts[label].totalOutstanding / statusCounts[label].count),
            statusCounts[label].overdueCount
        ]);

        let content = `
            <div class="table-container mb-6">
                <table class="data-table">
                    <thead><tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>${tableData.map(row => `<tr class="clickable-row" data-status="${row[0]}">${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>
                </table>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-6); margin-top: var(--spacing-6);">
                <div>
                    <h4 class="card-title text-center">Breakdown by Customer Count</h4>
                    <div class="chart-container" style="height: 300px;"><canvas id="customer-status-chart-count"></canvas></div>
                </div>
                 <div>
                    <h4 class="card-title text-center">Breakdown by Outstanding Amount</h4>
                    <div class="chart-container" style="height: 300px;"><canvas id="customer-status-chart-amount"></canvas></div>
                </div>
            </div>`;

        this.displayReport('Customer Status Report', [], [], content);

        if(this.charts.customerStatusCount) this.charts.customerStatusCount.destroy();
        this.charts.customerStatusCount = new Chart(document.getElementById('customer-status-chart-count'), {
            type: 'pie', data: { labels: labels, datasets: [{ data: Object.values(statusCounts).map(s => s.count), backgroundColor: ['#e2000f', '#10b981', '#ffc107', '#dc3545', '#0d6efd'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'var(--text-primary)' } } } }
        });
        
        if(this.charts.customerStatusAmount) this.charts.customerStatusAmount.destroy();
        this.charts.customerStatusAmount = new Chart(document.getElementById('customer-status-chart-amount'), {
            type: 'pie', data: { labels: labels, datasets: [{ data: Object.values(statusCounts).map(s => s.totalOutstanding), backgroundColor: ['#e2000f', '#10b981', '#ffc107', '#dc3545', '#0d6efd'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'var(--text-primary)' } } } }
        });
    },
    generateDrillDownStatusReport: function(status) {
        const customers = App.Helpers.getScopedData('customers').filter(c => (c.customerStatus || 'Uncategorized') === status);
        const headers = ['Account #', 'Company Name', 'Outstanding', 'Consultant', 'Aging Category', 'Payment Status', 'Last Visit'];
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map;}, {});
        const allVisits = App.DB.get('visits');

        const data = customers.map(c => {
            const lastVisit = allVisits.filter(v => v.customerId === c.accountNo && v.status === 'Completed').sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime))[0];
            return [
                c.accountNo,
                c.companyName,
                App.Helpers.formatCurrency(c.outstanding),
                consultantMap[c.salesConsultantId] || 'N/A',
                c.agingCategory,
                c.paymentStatus,
                lastVisit ? App.Helpers.formatDate(lastVisit.dateTime) : 'N/A'
            ];
        });
        
        this.displayReport(`Customers with Status: ${status}`, headers, data);
    },
    displayReport: function(title, headers = [], data = [], customHTML = '', actions = ['csv', 'pdf']) { 
        this.currentReportData = { title, headers, data };
        document.getElementById('report-modal-title').textContent = title;
        const body = document.getElementById('report-modal-body');
        let content = customHTML || '';
        if (headers.length > 0 && data.length > 0) {
            content += `<div class="table-container"><table class="data-table"><thead><tr>${headers.map(i => `<th>${i}</th>`).join('')}</tr></thead><tbody>${data.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
        } else if (!customHTML && headers.length > 0) {
            content += `<p>No data found for this report.</p>`;
        }
        body.innerHTML = content;
        const actionsContainer = document.getElementById('report-modal-actions');
        actionsContainer.innerHTML = actions.map(action => {
            if (action === 'csv') return `<button class="btn btn-outline" onclick="App.Reports.exportCSV()"><i class="fas fa-file-csv"></i> CSV</button>`;
            if (action === 'pdf') return `<button class="btn btn-outline" onclick="App.Reports.exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>`;
            if (action === 'csv_visits') return `<button class="btn btn-outline" onclick="App.Reports.exportConsultantVisitsCSV()"><i class="fas fa-file-csv"></i> CSV</button>`;
            if (action === 'pdf_visits') return `<button class="btn btn-outline" onclick="App.Reports.exportConsultantVisitsPDF()"><i class="fas fa-file-pdf"></i> PDF</button>`;
            return '';
        }).join('');
        App.UI.animateTableRows(body.querySelector('.data-table tbody'));
        App.UI.openModal('report-modal');
    },
    exportCSV: function() { if (!this.currentReportData) return App.UI.toast('No report data to export.', 'error'); const { title: t, headers: h, data: d } = this.currentReportData; App.Helpers.exportToCSV(`${t.replace(/\s/g, '_')}.csv`, h, d); },
    exportPDF: function() { if (!this.currentReportData) return App.UI.toast('No report data to export.', 'error'); const { title: t, headers: h, data: d } = this.currentReportData; App.Helpers.exportToPDF(`${t.replace(/\s/g, '_')}.pdf`, t, h, d); },
});

Object.assign(App.Analytics, {
    charts: {},
    
    render() {
        // --- Layout ---
        const topHTML = `
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-6); margin-bottom: var(--spacing-6);">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">6-Month Recovery Trend</h3></div>
                    <div class="chart-container" style="height: 300px;"><canvas id="recovery-trend-chart"></canvas></div>
                </div>
                
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Collection Efficiency Funnel</h3></div>
                    <div class="chart-container" style="height: 300px;"><canvas id="funnel-chart"></canvas></div>
                </div>
            </div>
        `;

        // --- NEW: Portfolio Health Section ---
        const healthTrendHTML = `
            <div class="card mb-6">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">Portfolio Health Trend (Risk Analysis)</h3>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">
                        <i class="fas fa-circle" style="color: #dc3545;"></i> Critical
                        <i class="fas fa-circle" style="color: #ffc107; margin-left:10px;"></i> Warning
                        <i class="fas fa-circle" style="color: #10b981; margin-left:10px;"></i> Good Standing
                    </div>
                </div>
                <div class="chart-container" style="height: 350px;">
                    <canvas id="portfolio-health-chart"></canvas>
                </div>
            </div>
        `;

        const kpiGrid = `<div id="analytics-kpi-grid" class="kpi-card-grid"></div>`;
        
        const bottomGrid = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--spacing-6);">
                <div class="card"><div class="card-header"><h3 class="card-title">Recovery by Consultant</h3></div><div class="chart-container"><canvas id="recovery-by-consultant-chart"></canvas></div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">Outstanding by Emirate</h3></div><div class="chart-container"><canvas id="recovery-by-emirate-chart"></canvas></div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">Payment Methods</h3></div><div class="chart-container" style="height: 300px; max-width: 300px; margin: auto;"><canvas id="payment-methods-chart"></canvas></div></div>
                <div class="card"><div class="card-header"><h3 class="card-title">Visit Outcomes</h3></div><div class="chart-container" style="height: 300px; max-width: 300px; margin: auto;"><canvas id="visit-outcome-chart"></canvas></div></div>
            </div>
        `;

        document.getElementById('analytics-page').innerHTML = `
            <div class="page-header"><h2>Analytics Dashboard</h2><p>Visual insights into recovery performance and activities.</p></div>
            ${kpiGrid}
            ${healthTrendHTML} ${topHTML}
            ${bottomGrid}
        `;

        this.renderKpiCards();
        this.renderPortfolioHealthChart(); // <--- Call New Function
        this.renderTrendChart();
        this.renderFunnelChart();
        this.renderRecoveryByConsultantChart();
        this.renderRecoveryByEmirateChart();
        this.renderPaymentMethodsChart();
        this.renderVisitOutcomeChart();
    },

    setupEventListeners() {},

    // --- NEW FUNCTION: Portfolio Health Logic ---
    renderPortfolioHealthChart() {
        const ctx = document.getElementById('portfolio-health-chart').getContext('2d');
        if (this.charts.portfolioHealth) this.charts.portfolioHealth.destroy();

        const customers = App.DB.get('customers');
        const payments = App.DB.get('payments');
        const visits = App.DB.get('visits');

        // 1. Generate last 6 months points
        const labels = [];
        const dataCritical = [];
        const dataWarning = [];
        const dataGood = [];

        for (let i = 5; i >= 0; i--) {
            // "Reference Date" is the end of that specific month
            const refDate = new Date();
            refDate.setMonth(refDate.getMonth() - i);
            refDate.setDate(1); // Start of month
            refDate.setMonth(refDate.getMonth() + 1); // Jump to next month
            refDate.setDate(0); // Go back 1 day = End of the target month
            
            labels.push(refDate.toLocaleString('default', { month: 'short', year: '2-digit' }));

            // 2. "Time Machine" Logic: Calculate status AS OF refDate
            let countCritical = 0;
            let countWarning = 0;
            let countGood = 0;

            customers.forEach(c => {
                // Filter data to only see what happened BEFORE refDate
                const histPayments = payments.filter(p => p.customerId === c.accountNo && new Date(p.date) <= refDate && p.status === 'Completed');
                const histVisits = visits.filter(v => v.customerId === c.accountNo && new Date(v.dateTime) <= refDate && v.status === 'Completed');

                // Calculate Balance at that time
                const paidByThen = histPayments.reduce((sum, p) => sum + p.amount, 0);
                const currentBalanceAtTime = c.initialDebt - paidByThen;

                if (currentBalanceAtTime <= 0) return; // Skip if they had paid off by then

                // --- Calculate Health Score (Simplified for speed) ---
                let score = 100;
                
                // Penalty 1: Legacy Debt (Static)
                if (c.balance_lte_2018 > 0) score -= 40;

                // Penalty 2: Payment Recency
                if (histPayments.length > 0) {
                    const lastPayDate = new Date(Math.max(...histPayments.map(p => new Date(p.date))));
                    const daysDiff = (refDate - lastPayDate) / (1000 * 60 * 60 * 24);
                    if (daysDiff > 90) score -= 30;
                    else if (daysDiff > 60) score -= 15;
                } else {
                    // No payments ever (relative to refDate)
                    score -= 30;
                }

                // Penalty 3: Visit Recency
                if (histVisits.length === 0) {
                    // Check if account was created long ago
                    const debtDate = new Date(c.debtSince || new Date());
                    if ((refDate - debtDate) / (1000 * 60 * 60 * 24) > 60) score -= 10;
                }

                // Classify
                if (score >= 80) countGood++;
                else if (score >= 50) countWarning++;
                else countCritical++;
            });

            dataCritical.push(countCritical);
            dataWarning.push(countWarning);
            dataGood.push(countGood);
        }

        // 3. Render Chart
        this.charts.portfolioHealth = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Critical (High Risk)',
                        data: dataCritical,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Warning (Needs Attention)',
                        data: dataWarning,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Good Standing',
                        data: dataGood,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: 'var(--border-color)' },
                        title: { display: true, text: 'Number of Customers' }
                    },
                    x: { grid: { display: false } }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    },

    renderKpiCards() {
        const customers = App.DB.get('customers');
        const payments = App.DB.get('payments').filter(p => p.status === 'Completed');
        const visits = App.DB.get('visits').filter(v => v.status === 'Completed');
        const totalRecovered = payments.reduce((sum, p) => sum + p.amount, 0);
        const totalOutstanding = customers.reduce((sum, c) => sum + c.outstanding, 0);
        const successfulVisits = visits.filter(v => ['Paid in Full', 'Partial Payment', 'Promise to Pay'].includes(v.outcome)).length;
        const visitSuccessRate = visits.length > 0 ? ((successfulVisits / visits.length) * 100).toFixed(1) : 0;
        document.getElementById('analytics-kpi-grid').innerHTML = `<div class="kpi-card"><div class="title">Total Recovered (All Time)</div><div class="value">${App.Helpers.formatCurrency(totalRecovered)}</div></div><div class="kpi-card"><div class="title">Total Outstanding Debt</div><div class="value">${App.Helpers.formatCurrency(totalOutstanding)}</div></div><div class="kpi-card"><div class="title">Visit Success Rate</div><div class="value">${visitSuccessRate}%</div></div><div class="kpi-card"><div class="title">Total Completed Visits</div><div class="value">${visits.length}</div></div>`;
    },
    renderTrendChart() {
        const payments = App.DB.get('payments').filter(p => p.status === 'Completed');
        const last6Months = [];
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        for (let i = 5; i >= 0; i--) {
            const d = new Date(); d.setMonth(d.getMonth() - i);
            const key = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
            const label = `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
            last6Months.push({ key, label, amount: 0 });
        }
        payments.forEach(p => { const monthKey = p.date.substring(0, 7); const monthObj = last6Months.find(m => m.key === monthKey); if (monthObj) monthObj.amount += p.amount; });
        const ctx = document.getElementById('recovery-trend-chart').getContext('2d'); if (this.charts.trend) this.charts.trend.destroy();
        this.charts.trend = new Chart(ctx, { type: 'line', data: { labels: last6Months.map(m => m.label), datasets: [{ label: 'Total Collections', data: last6Months.map(m => m.amount), borderColor: '#e2000f', backgroundColor: 'rgba(226, 0, 15, 0.1)', borderWidth: 3, tension: 0.4, fill: true, pointBackgroundColor: '#fff', pointBorderColor: '#e2000f', pointRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'var(--border-color)' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => App.Helpers.formatCurrency(c.raw) } } } } });
    },
    renderFunnelChart() {
        const customers = App.DB.get('customers');
        const visits = App.DB.get('visits');
        const payments = App.DB.get('payments').filter(p => p.status === 'Completed');

        // CHANGED: Calculate exact Outstanding Debt (was previously adding Initial + Outstanding)
        const totalDebt = customers.reduce((sum, c) => sum + c.outstanding, 0); 
        
        const promisedAmount = visits.filter(v => v.outcome === 'Promise to Pay' && v.promiseAmount).reduce((sum, v) => sum + v.promiseAmount, 0);
        const collectedAmount = payments.reduce((sum, p) => sum + p.amount, 0);

        const ctx = document.getElementById('funnel-chart').getContext('2d');
        if (this.charts.funnel) this.charts.funnel.destroy();

        this.charts.funnel = new Chart(ctx, {
            type: 'bar',
            data: {
                // CHANGED: Label updated to 'Total Outstanding Debt'
                labels: ['Total Outstanding Debt', 'Promised', 'Collected'],
                datasets: [{
                    label: 'Amount (AED)',
                    data: [totalDebt, promisedAmount, collectedAmount],
                    backgroundColor: ['#6c757d', '#ffc107', '#10b981'],
                    borderRadius: 4,
                    barPercentage: 0.6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true, grid: { display: false } }, y: { grid: { display: false } } },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => App.Helpers.formatCurrency(c.raw) } } }
            }
        });
    },
    renderRecoveryByConsultantChart() {
        const consultants = App.DB.get('consultants'); const customers = App.DB.get('customers');
        const data = consultants.map(consultant => { const assigned = customers.filter(c => c.salesConsultantId === consultant.id); const initial = assigned.reduce((s, c) => s + c.initialDebt, 0); const outstanding = assigned.reduce((s, c) => s + c.outstanding, 0); return { name: consultant.name, recovered: initial - outstanding, outstanding }; });
        const ctx = document.getElementById('recovery-by-consultant-chart').getContext('2d'); if (this.charts.consultant) this.charts.consultant.destroy();
        this.charts.consultant = new Chart(ctx, { type: 'bar', data: { labels: data.map(d => d.name), datasets: [{ label: 'Recovered', data: data.map(d => d.recovered), backgroundColor: '#10b981' }, { label: 'Outstanding', data: data.map(d => d.outstanding), backgroundColor: '#dc3545' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } } });
    },
    renderRecoveryByEmirateChart() {
        const customers = App.DB.get('customers'); const data = customers.reduce((acc, c) => { const initial = acc[c.emirate]?.initial || 0; const outstanding = acc[c.emirate]?.outstanding || 0; acc[c.emirate] = { initial: initial + c.initialDebt, outstanding: outstanding + c.outstanding }; return acc; }, {});
        const labels = Object.keys(data); const recoveredData = labels.map(l => data[l].initial - data[l].outstanding); const outstandingData = labels.map(l => data[l].outstanding);
        const ctx = document.getElementById('recovery-by-emirate-chart').getContext('2d'); if (this.charts.emirate) this.charts.emirate.destroy();
        this.charts.emirate = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Recovered', data: recoveredData, backgroundColor: '#10b981' }, { label: 'Outstanding', data: outstandingData, backgroundColor: '#dc3545' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { stacked: true }, y: { stacked: true } } } });
    },
    renderPaymentMethodsChart() {
        const payments = App.DB.get('payments'); const data = payments.reduce((acc, p) => { acc[p.method] = (acc[p.method] || 0) + 1; return acc; }, {});
        const ctx = document.getElementById('payment-methods-chart').getContext('2d'); if (this.charts.paymentMethods) this.charts.paymentMethods.destroy();
        this.charts.paymentMethods = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#e2000f', '#10b981', '#ffc107'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } });
    },
    renderVisitOutcomeChart() {
        const visits = App.DB.get('visits').filter(v => v.status === 'Completed' && v.outcome); const data = visits.reduce((acc, v) => { acc[v.outcome] = (acc[v.outcome] || 0) + 1; return acc; }, {});
        const ctx = document.getElementById('visit-outcome-chart').getContext('2d'); if (this.charts.visitOutcomes) this.charts.visitOutcomes.destroy();
        this.charts.visitOutcomes = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#10b981', '#e2000f', '#ffc107', '#dc3545', '#0d6efd', '#84cc16'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } });
    }
});

Object.assign(App.Consultants, { 
    render: function() { 
        const consultants = App.DB.get('consultants'); 
        const customers = App.DB.get('customers'); 
        const visits = App.DB.get('visits');
        const payments = App.DB.get('payments');
        const forecasts = App.DB.get('forecasts');
        
        const now = new Date();
        const currentMonthStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;

        let data = consultants.map(consultant => { 
            const assignedCustomers = customers.filter(c => c.salesConsultantId === consultant.id);
            const assignedCustomerIds = assignedCustomers.map(c => c.accountNo); 
            
            const totalOutstanding = assignedCustomers.reduce((sum, c) => sum + c.outstanding, 0); 
            const upcomingVisits = visits.filter(v => v.collectorId === consultant.id && v.status === 'Scheduled' && new Date(v.dateTime) >= new Date()).length;
            
            // Target vs Actual Logic
            const currentTarget = forecasts.find(f => f.consultantId === consultant.id && f.month === currentMonthStr)?.amount || 0;
            const collectedThisMonth = payments
                .filter(p => p.status === 'Completed' && p.date.startsWith(currentMonthStr) && assignedCustomerIds.includes(p.customerId))
                .reduce((sum, p) => sum + p.amount, 0);

            return { 
                ...consultant, 
                noOfCustomers: assignedCustomers.length, 
                totalOutstanding, 
                upcomingVisits, 
                currentTarget,
                collectedThisMonth
            }; 
        }); 
        
        const { column, order } = App.state.tableSorts.consultants; 
        data.sort((a, b) => { 
            let valA = a[column]; let valB = b[column]; 
            if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } 
            if (valA < valB) return order === 'asc' ? -1 : 1; 
            if (valA > valB) return order === 'asc' ? 1 : -1; 
            return 0; 
        }); 
        
        const { currentPage, rowsPerPage } = App.state.pagination.consultants; 
        const startIndex = (currentPage - 1) * rowsPerPage; 
        const paginatedData = data.slice(startIndex, startIndex + rowsPerPage); 
        const tbody = document.getElementById('consultant-table-body');

        if (paginatedData.length > 0) { 
            tbody.innerHTML = paginatedData.map(c => {
                // --- 1. Avatar Logic ---
                const avatar = App.Helpers.getAvatarHTML(c.name);
                
                // --- 2. Micro-Progress Bar Logic ---
                let progressHTML = '<span style="color:var(--text-secondary); font-size:0.8rem;">No Target</span>';
                if (c.currentTarget > 0) {
                    const pct = Math.min((c.collectedThisMonth / c.currentTarget) * 100, 100).toFixed(0);
                    // Color code: Green > 80%, Yellow > 50%, Red < 50%
                    let color = '#dc3545';
                    if(pct >= 80) color = '#10b981';
                    else if(pct >= 50) color = '#ffc107';
                    
                    progressHTML = `
                        <div style="font-size:0.8rem; font-weight:600;">
                            ${App.Helpers.formatCurrency(c.collectedThisMonth)} 
                            <span style="color:var(--text-secondary); font-weight:400;">/ ${App.Helpers.formatAbbreviatedCurrency(c.currentTarget)}</span>
                        </div>
                        <div class="micro-progress-container">
                            <div class="micro-progress-bar" style="width: ${pct}%; background-color: ${color};"></div>
                        </div>
                    `;
                }

                return `<tr>
                    <td>
                        <div class="consultant-row-wrapper">
                            ${avatar}
                            <div style="font-weight:600;">${c.name}</div>
                        </div>
                    </td>
                    <td>${c.noOfCustomers}</td>
                    <td>${App.Helpers.formatCurrency(c.totalOutstanding)}</td>
                    
                    <td>${progressHTML}</td>
                    
                    <td>${c.upcomingVisits}</td>
                    <td>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline view-dashboard" data-id="${c.id}" title="View Dashboard"><i class="fas fa-tachometer-alt"></i></button>
                            <button class="btn btn-outline view-customers" data-id="${c.id}" title="View Customers"><i class="fas fa-users"></i></button>
                            <button class="btn btn-outline reassign-customers" data-id="${c.id}" title="Reassign Customers"><i class="fas fa-random"></i></button>
                            <button class="btn btn-outline set-target-btn" data-id="${c.id}" title="Set Monthly Target"><i class="fas fa-bullseye"></i></button>
                            <button class="btn btn-outline edit-consultant" data-id="${c.id}" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger delete-consultant" data-id="${c.id}" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`; 
            }).join(''); 
        } else { 
            const buttonHTML = `<button class="btn btn-primary" onclick="App.Consultants.showConsultantForm()"><i class="fas fa-plus"></i> Add Consultant</button>`; 
            tbody.innerHTML = `<tr><td colspan="100%">${App.UI.getEmptyStateHTML('fa-user-tie', 'No Consultants Found', 'Add a consultant to begin assigning customers.', buttonHTML)}</td></tr>`; 
        } 
        App.UI.animateTableRows(tbody); 
        App.UI.renderPaginationControls('consultants', data.length); 
        App.UI.updateSortIndicators('consultants'); 
    }, 
    setupEventListeners: function() { 
        document.getElementById('add-consultant-btn').addEventListener('click', () => this.showConsultantForm()); 
        document.getElementById('consultant-form').addEventListener('submit', (e) => this.saveConsultant(e)); 
        document.getElementById('consultant-table-body').addEventListener('click', e => { 
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.classList.contains('edit-consultant')) this.showConsultantForm(id); 
            else if (btn.classList.contains('delete-consultant')) this.deleteConsultant(id); 
            else if (btn.classList.contains('view-customers')) this.showViewCustomersModal(id); 
            else if (btn.classList.contains('reassign-customers')) this.showReassignModal(id); 
            else if (btn.classList.contains('set-target-btn')) this.showForecastModal(id);
            else if (btn.classList.contains('view-dashboard')) App.UI.navigateTo('consultantDashboard', parseInt(id));
        }); 
        document.getElementById('reassign-customers-form').addEventListener('submit', e => this.reassignCustomers(e)); 
        document.getElementById('reassign-and-delete-form').addEventListener('submit', e => this.handleReassignAndDelete(e));
        document.querySelector('#consultants-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('consultants', th.dataset.sort); }); 
        document.getElementById('forecast-form').addEventListener('submit', e => this.saveForecast(e)); 
        document.getElementById('existing-forecasts-body').addEventListener('click', e => { 
            const deleteBtn = e.target.closest('.delete-forecast'); 
            const editBtn = e.target.closest('.edit-forecast'); 
            if(deleteBtn) this.deleteForecast(deleteBtn.dataset.id); 
            if(editBtn) this.editForecast(editBtn.dataset.id); 
        }); 
    }, 
    showConsultantForm: function(id = null) { const form = document.getElementById('consultant-form'); form.reset(); if (id) { const consultant = App.DB.get('consultants').find(c => c.id == id); document.getElementById('consultant-modal-title').textContent = 'Edit Consultant'; form.elements['consultant-id-hidden'].value = consultant.id; form.elements['consultantName'].value = consultant.name; form.originalData = {...consultant}; } else { document.getElementById('consultant-modal-title').textContent = 'Add New Consultant'; form.elements['consultant-id-hidden'].value = ''; form.originalData = null; } App.UI.openModal('consultant-modal'); }, 
    saveConsultant: function(e) { e.preventDefault(); const form = e.target; const id = form.elements['consultant-id-hidden'].value; const name = form.elements['consultantName'].value.trim(); if (!name) return App.UI.toast('Consultant name cannot be empty.', 'error'); let consultants = App.DB.get('consultants'); if (id) { const index = consultants.findIndex(c => c.id == id); const originalName = form.originalData.name; consultants[index].name = name; App.Helpers.logChange('Updated', 'Consultant', `'${originalName}'`, `Renamed to '${name}'`); } else { const newId = Date.now(); consultants.push({ id: newId, name }); App.Helpers.logChange('Created', 'Consultant', `'${name}'`); } App.DB.set('consultants', consultants); App.UI.closeModal('consultant-modal'); App.UI.toast(`Consultant ${id ? 'updated' : 'added'}!`); this.render(); }, 
    deleteConsultant: function(consultantId) {
        const customers = App.DB.get('customers');
        const assignedCustomers = customers.filter(c => c.salesConsultantId == consultantId);
        const allConsultants = App.DB.get('consultants');
        const consultantToDelete = allConsultants.find(c => c.id == consultantId);

        if (assignedCustomers.length > 0) {
            const otherConsultants = allConsultants.filter(c => c.id != consultantId);
            if (otherConsultants.length === 0) {
                return App.UI.toast('Cannot delete the only consultant with assigned customers.', 'error');
            }
            
            document.getElementById('delete-consultant-id-hidden').value = consultantId;
            document.getElementById('reassign-delete-message').textContent = `${consultantToDelete.name} has ${assignedCustomers.length} customer(s) assigned. You must reassign them before deletion.`;
            const toConsultantSelect = document.getElementById('reassign-delete-to-consultant');
            toConsultantSelect.innerHTML = otherConsultants.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            App.UI.openModal('reassign-and-delete-consultant-modal');
            
        } else {
            App.UI.confirm('Are you sure?', `This will permanently delete ${consultantToDelete.name}.`, () => {
                const updatedConsultants = allConsultants.filter(c => c.id != consultantId);
                App.DB.set('consultants', updatedConsultants);
                App.Helpers.logChange('Deleted', 'Consultant', `'${consultantToDelete.name}'`);
                App.UI.toast('Consultant deleted.', 'success');
                this.render();
            });
        }
    },
    handleReassignAndDelete: function(e) {
        e.preventDefault();
        const form = e.target;
        const fromConsultantId = parseInt(document.getElementById('delete-consultant-id-hidden').value);
        const toConsultantId = parseInt(form.elements['reassign-delete-to-consultant'].value);

        let customers = App.DB.get('customers');
        customers.forEach(customer => {
            if (customer.salesConsultantId === fromConsultantId) {
                customer.salesConsultantId = toConsultantId;
            }
        });
        App.DB.set('customers', customers);

        let consultants = App.DB.get('consultants');
        const fromConsultantName = consultants.find(c => c.id === fromConsultantId).name;
        const toConsultantName = consultants.find(c => c.id === toConsultantId).name;
        consultants = consultants.filter(c => c.id !== fromConsultantId);
        App.DB.set('consultants', consultants);

        App.Helpers.logChange('Reassigned and Deleted', 'Consultant', `'${fromConsultantName}'`, `Customers moved to ${toConsultantName}.`);
        App.UI.closeModal('reassign-and-delete-consultant-modal');
        App.UI.toast(`${fromConsultantName} deleted and customers reassigned.`, 'success');
        this.render();
        if(App.state.activePage === 'customers') App.Customers.render();
    },
    showViewCustomersModal(consultantId) {
        const consultant = App.DB.get('consultants').find(c => c.id == consultantId);
        document.getElementById('consultant-customers-title').textContent = `Customers of ${consultant.name}`;
        const customers = App.DB.get('customers').filter(c => c.salesConsultantId == consultantId);
        const body = document.getElementById('consultant-customers-body');
        if (customers.length === 0) {
            body.innerHTML = '<p>No customers assigned to this consultant.</p>';
        } else {
            const table = `<table class="data-table"><thead><tr><th>Account #</th><th>Company</th><th>Outstanding</th></tr></thead><tbody>${customers.map(c => `<tr><td>${c.accountNo}</td><td>${c.companyName}</td><td>${App.Helpers.formatCurrency(c.outstanding)}</td></tr>`).join('')}</tbody></table>`;
            body.innerHTML = table;
            App.UI.animateTableRows(body.querySelector('tbody'));
        }
        App.UI.openModal('consultant-customers-modal');
    },
    showReassignModal(fromConsultantId) {
        const fromConsultant = App.DB.get('consultants').find(c => c.id == fromConsultantId);
        document.getElementById('from-consultant-hidden').value = fromConsultant.id;
        document.getElementById('from-consultant-name').textContent = fromConsultant.name;
        
        const customers = App.DB.get('customers').filter(c => c.salesConsultantId == fromConsultant.id);
        const customerListEl = document.getElementById('reassign-customer-list');
        customerListEl.innerHTML = customers.length > 0 ? customers.map(c => `<div class="d-flex align-items-center gap-2"><input type="checkbox" name="customerToReassign" value="${c.accountNo}" id="reassign-${c.accountNo}"><label for="reassign-${c.accountNo}">${c.companyName}</label></div>`).join('') : '<p>No customers to reassign.</p>';

        const consultants = App.DB.get('consultants').filter(c => c.id != fromConsultant.id);
        const toConsultantSelect = document.getElementById('reassign-to-consultant');
        toConsultantSelect.innerHTML = consultants.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

        App.UI.openModal('reassign-customers-modal');
    },
    reassignCustomers(e) {
        e.preventDefault();
        const fromConsultantId = parseInt(document.getElementById('from-consultant-hidden').value);
        const toConsultantId = parseInt(document.getElementById('reassign-to-consultant').value);
        const selectedCustomerNodes = document.querySelectorAll('input[name="customerToReassign"]:checked');
        
        if (!toConsultantId) return App.UI.toast('Please select a consultant to reassign to.', 'error');
        if (selectedCustomerNodes.length === 0) return App.UI.toast('Please select at least one customer to reassign.', 'error');

        const fromConsultantName = App.DB.get('consultants').find(c => c.id === fromConsultantId).name;
        const toConsultantName = App.DB.get('consultants').find(c => c.id === toConsultantId).name;

        const customerIdsToReassign = Array.from(selectedCustomerNodes).map(node => node.value);
        let customers = App.DB.get('customers');
        customerIdsToReassign.forEach(id => {
            const customerIndex = customers.findIndex(c => c.accountNo === id);
            if (customerIndex > -1) {
                customers[customerIndex].salesConsultantId = toConsultantId;
            }
        });
        App.DB.set('customers', customers);
        const details = `Reassigned ${customerIdsToReassign.length} customers from ${fromConsultantName} to ${toConsultantName}`;
        App.Helpers.logChange('Reassigned', 'Customers', details);
        App.UI.closeModal('reassign-customers-modal');
        App.UI.toast('Customers reassigned successfully!', 'success');
        this.render();
        if(App.state.activePage === 'customers') App.Customers.render();
    },
    showForecastModal(consultantId) {
        const consultant = App.DB.get('consultants').find(c => c.id == consultantId);
        document.getElementById('forecast-modal-title').textContent = `Monthly Targets for ${consultant.name}`;
        document.getElementById('forecast-consultant-id').value = consultant.id;
        
        const form = document.getElementById('forecast-form');
        form.reset();
        document.getElementById('forecast-id-hidden').value = '';

        const now = new Date();
        App.Helpers.populateMonthYearDropdowns('forecast-month-select', 'forecast-year-select', now.getMonth(), now.getFullYear());

        document.getElementById('forecast-month-select').disabled = false;
        document.getElementById('forecast-year-select').disabled = false;
        
        this.renderForecastsForConsultant(consultant.id);
        App.UI.openModal('forecast-modal');
    },
    renderForecastsForConsultant(consultantId) {
        const allForecasts = App.DB.get('forecasts');
        const consultantForecasts = allForecasts.filter(f => f.consultantId == consultantId).sort((a, b) => b.month.localeCompare(a.month));
        const tbody = document.getElementById('existing-forecasts-body');
        tbody.innerHTML = consultantForecasts.length > 0
            ? consultantForecasts.map(f => `<tr>
                <td>${f.month}</td>
                <td>${App.Helpers.formatCurrency(f.amount)}</td>
                <td>${App.Helpers.formatCurrency(f.amount_Collectors || 0)}</td>
                <td>${App.Helpers.formatCurrency(f.amount_SalesAbove3Months || 0)}</td>
                <td>${App.Helpers.formatCurrency(f.amount_SalesAbove360Days || 0)}</td>
                <td><div class="d-flex gap-2">
                    <button class="btn btn-outline edit-forecast" data-id="${f.id}"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger delete-forecast" data-id="${f.id}"><i class="fas fa-trash"></i></button>
                </div></td>
            </tr>`).join('')
            : '<tr><td colspan="6">No targets found.</td></tr>';
        App.UI.animateTableRows(tbody);
    },
    saveForecast(e) {
        e.preventDefault();
        const form = e.target;
        const consultantId = parseInt(form.elements['forecast-consultant-id'].value);
        const monthVal = form.elements['forecast-month-select'].value;
        const yearVal = form.elements['forecast-year-select'].value;
        const amount = parseFloat(form.elements['forecast-amount'].value);
        const amountCollectors = parseFloat(form.elements['forecast-amount-collectors'].value) || 0;
        const amountSales3m = parseFloat(form.elements['forecast-amount-sales3m'].value) || 0;
        const amountSales360d = parseFloat(form.elements['forecast-amount-sales360d'].value) || 0;
        const forecastId = form.elements['forecast-id-hidden'].value;

        if (!monthVal || !yearVal || isNaN(amount) || amount <= 0) {
            App.UI.toast('Please select a valid month/year and a positive overall target amount.', 'error');
            return;
        }

        const month = `${yearVal}-${monthVal}`;
        let forecasts = App.DB.get('forecasts');

        const forecastData = { 
            consultantId, 
            month, 
            amount,
            amount_Collectors: amountCollectors,
            amount_SalesAbove3Months: amountSales3m,
            amount_SalesAbove360Days: amountSales360d,
        };

        if (forecastId) { // Editing existing
            const index = forecasts.findIndex(f => f.id === forecastId);
            if (index > -1) {
                forecasts[index] = { ...forecasts[index], ...forecastData };
                App.Helpers.logChange('Updated', 'Target', `for ${month}`, `New amounts set.`);
            }
        } else { // Adding new
            const existingIndex = forecasts.findIndex(f => f.consultantId === consultantId && f.month === month);
            if (existingIndex > -1) { // If user tries to create a duplicate month, update it instead
                forecasts[existingIndex] = { ...forecasts[existingIndex], ...forecastData };
                App.Helpers.logChange('Updated', 'Target', `for ${month}`, `New amounts set.`);
            } else {
                const newForecast = { id: `f-${Date.now()}`, ...forecastData };
                forecasts.push(newForecast);
                App.Helpers.logChange('Created', 'Target', `for ${month}`, `Amounts set.`);
            }
        }
        
        App.DB.set('forecasts', forecasts);
        App.UI.toast('Target saved!', 'success');
        form.reset();
        document.getElementById('forecast-id-hidden').value = '';
        
        const now = new Date();
        App.Helpers.populateMonthYearDropdowns('forecast-month-select', 'forecast-year-select', now.getMonth(), now.getFullYear());
        
        document.getElementById('forecast-month-select').disabled = false;
        document.getElementById('forecast-year-select').disabled = false;
        
        this.renderForecastsForConsultant(consultantId);
        if (App.state.activePage === 'performance') App.Performance.render();
    },
    deleteForecast(forecastId) {
        const forecasts = App.DB.get('forecasts');
        const forecast = forecasts.find(f => f.id === forecastId);
        if (!forecast) return;
        
        App.UI.confirm(
            'Delete this target?', 
            `Are you sure you want to delete the target for ${forecast.month}?`, 
            () => {
                const updatedForecasts = forecasts.filter(f => f.id !== forecastId);
                App.DB.set('forecasts', updatedForecasts);
                App.Helpers.logChange('Deleted', 'Target', `for ${forecast.month}`);
                App.UI.toast('Target deleted.', 'success');
                this.renderForecastsForConsultant(forecast.consultantId);
                if (App.state.activePage === 'performance') App.Performance.render();
            },
            '#forecast-modal'
        );
    },
    editForecast(forecastId) {
        const forecast = App.DB.get('forecasts').find(f => f.id === forecastId);
        if (!forecast) return;
        const form = document.getElementById('forecast-form');
        form.elements['forecast-id-hidden'].value = forecast.id;
        
        const [year, month] = forecast.month.split('-');
        App.Helpers.populateMonthYearDropdowns('forecast-month-select', 'forecast-year-select', parseInt(month, 10) - 1, parseInt(year, 10));

        document.getElementById('forecast-month-select').disabled = true;
        document.getElementById('forecast-year-select').disabled = true;
        
        form.elements['forecast-amount'].value = forecast.amount;
        form.elements['forecast-amount-collectors'].value = forecast.amount_Collectors || '';
        form.elements['forecast-amount-sales3m'].value = forecast.amount_SalesAbove3Months || '';
        form.elements['forecast-amount-sales360d'].value = forecast.amount_SalesAbove360Days || '';
        form.elements['forecast-amount'].focus();
    }
});
Object.assign(App.Users, { 
    render: function() { 
        let users = App.DB.get('users'); 
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const { column, order } = App.state.tableSorts.users;
        users.sort((a,b) => {
            let valA = column === 'assignedConsultantId' ? consultantMap[a.assignedConsultantId] || '' : a[column];
            let valB = column === 'assignedConsultantId' ? consultantMap[b.assignedConsultantId] || '' : b[column];
            if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });

        const { currentPage, rowsPerPage } = App.state.pagination.users;
        const startIndex = (currentPage - 1) * rowsPerPage;
        const paginatedUsers = users.slice(startIndex, startIndex + rowsPerPage);

        const tbody = document.getElementById('user-table-body'); 
        if (paginatedUsers.length > 0) {
            tbody.innerHTML = paginatedUsers.map(u => `<tr><td><div style="font-weight:600;">${u.username}</div></td><td>${u.fullName}</td><td><span class="status-badge ${u.role}">${u.role}</span></td><td>${consultantMap[u.assignedConsultantId] || 'N/A'}</td><td>${u.department || 'N/A'}</td><td>${u.lastLogin ? App.Helpers.timeAgo(u.lastLogin) : 'Never'}</td><td><div class="d-flex gap-2"><button class="btn btn-outline edit-user" data-id="${u.id}" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-user" data-id="${u.id}" title="Delete"><i class="fas fa-trash"></i></button></div></td></tr>`).join('');
        } else {
            tbody.innerHTML = `<tr><td colspan="100%">${App.UI.getEmptyStateHTML('fa-users-cog', 'No Users Found', 'Click the button above to add a new user.')}</td></tr>`;
        }
        App.UI.animateTableRows(tbody);
        App.UI.renderPaginationControls('users', users.length);
        App.UI.updateSortIndicators('users');
    }, 
    setupEventListeners: function() { document.getElementById('add-user-btn').addEventListener('click', () => this.showUserForm()); document.getElementById('user-form').addEventListener('submit', (e) => this.saveUser(e)); document.getElementById('user-table-body').addEventListener('click', e => { const editBtn = e.target.closest('.edit-user'); const deleteBtn = e.target.closest('.delete-user'); if (editBtn) this.showUserForm(editBtn.dataset.id); if (deleteBtn) this.deleteUser(deleteBtn.dataset.id); }); document.getElementById('role').addEventListener('change', e => { document.getElementById('assigned-consultant-group').style.display = e.target.value === 'user' ? 'block' : 'none'; }); document.querySelector('#users-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('users', th.dataset.sort); }); }, 
    showUserForm: function(id = null) { 
        const form = document.getElementById('user-form'); 
        form.reset(); 
        const consultantSelect = form.elements['assignedConsultantId']; 
        const consultants = App.DB.get('consultants'); 
        consultantSelect.innerHTML = `<option value="">N/A</option>` + consultants.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); 
        const passwordInput = form.elements['password'];
        if (id) { 
            const user = App.DB.get('users').find(u => u.id == id); 
            document.getElementById('user-modal-title').textContent = 'Edit User'; 
            form.elements['user-id-hidden'].value = user.id; 
            form.elements['username'].value = user.username; 
            form.elements['username'].readOnly = true; 
            form.elements['fullName'].value = user.fullName; 
            passwordInput.value = '';
            passwordInput.placeholder = 'Leave blank to keep current password';
            passwordInput.required = false;
            form.elements['department'].value = user.department || '';
            form.elements['role'].value = user.role; 
            form.elements['assignedConsultantId'].value = user.assignedConsultantId || ''; 
            form.originalData = {...user};
        } else { 
            document.getElementById('user-modal-title').textContent = 'Add New User'; 
            form.elements['user-id-hidden'].value = ''; 
            form.elements['username'].readOnly = false; 
            passwordInput.placeholder = 'Enter password';
            passwordInput.required = true;
            form.originalData = null;
        } 
        document.getElementById('assigned-consultant-group').style.display = form.elements['role'].value === 'user' ? 'block' : 'none'; 
        App.UI.openModal('user-modal'); 
    }, 
    saveUser: function(e) { 
        e.preventDefault(); 
        const form = e.target; 
        const id = form.elements['user-id-hidden'].value; 
        let users = App.DB.get('users'); 
        const newPassword = form.elements['password'].value;
        const userData = { 
            username: form.elements['username'].value.trim(), 
            fullName: form.elements['fullName'].value.trim(), 
            role: form.elements['role'].value, 
            department: form.elements['department'].value.trim(),
            assignedConsultantId: form.elements['role'].value === 'user' ? parseInt(form.elements['assignedConsultantId'].value) || null : null 
        }; 
        if (!id && !newPassword) return App.UI.toast('Password is required for new users.', 'error');
        if (!userData.username || !userData.fullName) return App.UI.toast('Username and Full Name are required.', 'error'); 
        if (id) { 
            const index = users.findIndex(u => u.id == id);
            if (newPassword) {
                userData.password = btoa(newPassword);
            }
            const original = form.originalData;
            const changes = App.Helpers.getObjectChanges(original, {...original, ...userData});
            users[index] = { ...users[index], ...userData };
            App.Helpers.logChange('Updated', 'User', `'${userData.username}'`, changes);
        } else { 
            if (users.some(u => u.username === userData.username)) { return App.UI.toast('Username already exists.', 'error'); } 
            userData.password = btoa(newPassword);
            users.push({ id: Date.now(), ...userData, lastLogin: null }); 
            App.Helpers.logChange('Created', 'User', `'${userData.username}'`);
        } 
        App.DB.set('users', users); 
        App.UI.closeModal('user-modal'); 
        App.UI.toast(`User ${id ? 'updated' : 'added'}!`); 
        this.render(); 
    }, 
    deleteUser: function(id) { if (id == App.state.currentUser.id) { return App.UI.toast('You cannot delete your own account.', 'error'); } App.UI.confirm('Are you sure?', "This will delete the user account.", () => { let users = App.DB.get('users'); const user = users.find(u => u.id == id); users = users.filter(u => u.id != id); App.DB.set('users', users); App.Helpers.logChange('Deleted', 'User', `'${user.username}'`); App.UI.toast('User deleted.', 'success'); this.render(); }); } 
});
Object.assign(App.Notifications, { init() { document.getElementById('notification-bell-btn').addEventListener('click', (e) => { e.stopPropagation(); this.toggleDropdown(); }); document.body.addEventListener('click', (e) => { const bellBtn = document.getElementById('notification-bell-btn'); const dropdown = document.getElementById('notification-dropdown'); if (dropdown && !dropdown.classList.contains('hidden') && !bellBtn.contains(e.target) && !dropdown.contains(e.target)) { dropdown.classList.add('hidden'); } }); }, create(message) { let notifications = App.DB.get('notifications'); const newNotification = { id: `notif_${Date.now()}`, timestamp: Date.now(), message: message, isRead: false }; notifications.unshift(newNotification); App.DB.set('notifications', notifications); if(App.state.currentUser && App.state.currentUser.role === 'admin') this.render(); }, render() { const notifications = App.DB.get('notifications').sort((a, b) => b.timestamp - a.timestamp); const unreadCount = notifications.filter(n => !n.isRead).length; const badge = document.getElementById('notification-badge'); if (unreadCount > 0) { badge.textContent = unreadCount; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } const list = document.getElementById('notification-list'); list.innerHTML = notifications.length > 0 ? notifications.slice(0, 15).map(n => `<li style="padding: var(--spacing-2) 0; border-bottom: 1px solid var(--border-color); ${!n.isRead ? 'font-weight: 600;' : ''}">${n.message}<div style="font-size: var(--fs-sm); color: var(--text-secondary); font-weight: 400; margin-top: 4px;"><i class="fas fa-clock"></i> ${App.Helpers.timeAgo(n.timestamp)}</div></li>`).join('') : '<li>No new notifications.</li>'; }, toggleDropdown() { const dropdown = document.getElementById('notification-dropdown'); const bellBtn = document.getElementById('notification-bell-btn'); const rect = bellBtn.getBoundingClientRect(); dropdown.style.top = `${rect.bottom + 10}px`; dropdown.style.right = `${window.innerWidth - rect.right}px`; dropdown.classList.toggle('hidden'); if(!dropdown.classList.contains('hidden')) { this.markAllAsRead(); } }, markAllAsRead() { let notifications = App.DB.get('notifications'); if (notifications.some(n => !n.isRead)) { setTimeout(() => { const updatedNotifications = notifications.map(n => ({ ...n, isRead: true })); App.DB.set('notifications', updatedNotifications); this.render(); }, 1500); } } });

Object.assign(App.CommandPalette, {
    selectedIndex: 0,
    results: [],

    init() {
        // 1. Open/Close Shortcut
        window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                this.open();
            }
            if (e.key === 'Escape') this.close();
            
            // Navigation Shortcuts (only if open)
            const modal = document.getElementById('command-palette-modal');
            if (modal.classList.contains('active')) {
                if (e.key === 'ArrowDown') { e.preventDefault(); this.navigate(1); }
                if (e.key === 'ArrowUp') { e.preventDefault(); this.navigate(-1); }
                if (e.key === 'Enter') { e.preventDefault(); this.execute(); }
            }
        });

        // 2. Input Listener
        document.getElementById('command-palette-input').addEventListener('input', (e) => this.search(e.target.value));
        
        // 3. Close on Outside Click
        document.getElementById('command-palette-modal').addEventListener('click', (e) => {
            if (e.target.id === 'command-palette-modal') this.close();
        });
    },

    open() {
        App.UI.openModal('command-palette-modal');
        const input = document.getElementById('command-palette-input');
        input.value = '';
        input.focus();
        this.search(''); 
    },

    close() {
        App.UI.closeModal('command-palette-modal');
    },

    navigate(direction) {
        this.selectedIndex += direction;
        if (this.selectedIndex < 0) this.selectedIndex = this.results.length - 1;
        if (this.selectedIndex >= this.results.length) this.selectedIndex = 0;
        this.renderResults();
        
        // Scroll into view logic
        const selectedEl = document.querySelector('.command-item.selected');
        if(selectedEl) selectedEl.scrollIntoView({ block: 'nearest' });
    },

    execute() {
        if (this.results[this.selectedIndex]) {
            this.results[this.selectedIndex].action();
            this.close();
        }
    },

    search(query) {
        const q = query.toLowerCase();
        this.results = [];

        // A. SYSTEM ACTIONS
        const actions = [
            { group: 'Navigation', title: 'Go to Dashboard', icon: 'fa-chart-pie', action: () => App.UI.navigateTo('dashboard') },
            { group: 'Navigation', title: 'Go to Customers', icon: 'fa-users', action: () => App.UI.navigateTo('customers') },
            { group: 'Navigation', title: 'Go to Visits Map', icon: 'fa-map-marked-alt', action: () => { App.UI.navigateTo('visits'); App.Visits.switchView('map'); } },
            { group: 'Navigation', title: 'Go to Payments', icon: 'fa-credit-card', action: () => App.UI.navigateTo('payments') },
            { group: 'Actions', title: 'Add New Customer', icon: 'fa-user-plus', action: () => App.Customers.showCustomerForm() },
            { group: 'Actions', title: 'Record a Payment', icon: 'fa-file-invoice-dollar', action: () => App.Payments.showPaymentForm() },
            { group: 'Actions', title: 'Schedule a Visit', icon: 'fa-calendar-plus', action: () => App.Visits.showScheduleModal() },
            { group: 'Actions', title: 'Plan Route', icon: 'fa-route', action: () => App.Visits.showRoutePlannerModal() },
            { group: 'System', title: 'Toggle Theme', icon: 'fa-adjust', action: () => App.UI.toggleTheme() },
            { group: 'System', title: 'Backup Data', icon: 'fa-download', action: () => { App.UI.navigateTo('settings'); App.Settings.backupData(); } }
        ];

        // Filter Actions
        if (q === '') {
            this.results = actions.slice(0, 5); // Default view
        } else {
            this.results.push(...actions.filter(a => a.title.toLowerCase().includes(q)));
        }

        // B. CUSTOMER SEARCH (Only if typing)
        if (q.length > 1) {
            const customers = App.DB.get('customers');
            const matches = customers.filter(c => 
                c.companyName.toLowerCase().includes(q) || 
                c.accountNo.toLowerCase().includes(q)
            ).slice(0, 5); // Limit to 5

            matches.forEach(c => {
                this.results.push({
                    group: 'Customers',
                    title: c.companyName,
                    desc: `${c.accountNo}  Bal: ${App.Helpers.formatCurrency(c.outstanding)}`,
                    icon: 'fa-building',
                    action: () => App.Customers.showCustomerDetail(c.accountNo)
                });
            });
        }

        this.selectedIndex = 0;
        this.renderResults();
    },

    renderResults() {
        const container = document.getElementById('command-palette-results');
        
        if (this.results.length === 0) {
            container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);"><i class="fas fa-ghost" style="font-size: 1.5rem; margin-bottom: 10px;"></i><br>No results found.</div>';
            return;
        }

        let html = '';
        let lastGroup = '';

        this.results.forEach((r, i) => {
            // Add Group Header if it changes
            if (r.group !== lastGroup) {
                html += `<div class="command-group-title">${r.group}</div>`;
                lastGroup = r.group;
            }

            const isSelected = i === this.selectedIndex ? 'selected' : '';
            html += `
                <div class="command-item ${isSelected}" onclick="App.CommandPalette.clickItem(${i})">
                    <div style="width: 35px; height: 35px; background: var(--bg-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); border: 1px solid var(--border-color);">
                        <i class="fas ${r.icon}"></i>
                    </div>
                    <div>
                        <div style="font-weight: 500; color: var(--text-primary);">${r.title}</div>
                        ${r.desc ? `<div style="font-size: 0.8rem; color: var(--text-secondary);">${r.desc}</div>` : ''}
                    </div>
                    ${isSelected ? '<i class="fas fa-level-down-alt" style="margin-left: auto; transform: rotate(90deg); color: var(--text-secondary);"></i>' : ''}
                </div>
            `;
        });

        container.innerHTML = html;
    },

    clickItem(index) {
        this.selectedIndex = index;
        this.execute();
    }
});

Object.assign(App.ChangeLog, { 
    render() { 
        let log = App.DB.get('changeLog'); 
        const search = document.getElementById('changelog-search').value.toLowerCase(); 
        const entityFilter = document.getElementById('changelog-entity-filter').value;
        const actionFilter = document.getElementById('changelog-action-filter').value;

        log = log.filter(entry => {
            const searchMatch = (entry.user.toLowerCase().includes(search) || 
                                 entry.action.toLowerCase().includes(search) || 
                                 (entry.details && entry.details.toLowerCase().includes(search)) || 
                                 (entry.entityName && entry.entityName.toLowerCase().includes(search)));
            
            const entityMatch = entityFilter === 'all' || entry.entityType === entityFilter;
            const actionMatch = actionFilter === 'all' || entry.action === actionFilter;
            
            return searchMatch && entityMatch && actionMatch;
        });

        const { column, order } = App.state.tableSorts.changelog; 
        log.sort((a,b) => { 
            let valA = a[column]; let valB = b[column]; 
            if (column === 'timestamp') { return order === 'asc' ? valA - valB : valB - valA; }
            if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } 
            if (valA < valB) return order === 'asc' ? -1 : 1; 
            if (valA > valB) return order === 'asc' ? 1 : -1; 
            return 0; 
        }); 
        
        const { currentPage, rowsPerPage } = App.state.pagination.changelog; 
        const startIndex = (currentPage - 1) * rowsPerPage; 
        const paginatedLog = log.slice(startIndex, startIndex + rowsPerPage); 
        const tbody = document.getElementById('changelog-table-body'); 
        
        if(paginatedLog.length > 0) { 
            tbody.innerHTML = paginatedLog.map(entry => {
                const detailsPreview = entry.details ? entry.details.substring(0, 50) + (entry.details.length > 50 ? '...' : '') : 'N/A';
                const viewButton = entry.details ? `<button class="btn btn-outline view-changelog-detail" data-id="${entry.timestamp}" title="View Details" style="min-width: unset; padding: var(--spacing-1) var(--spacing-2);"><i class="fas fa-eye"></i></button>` : '';

                return `<tr>
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td>${entry.user}</td>
                    <td>${entry.action}</td>
                    <td>${entry.entityType}: ${entry.entityName}</td>
                    <td>${detailsPreview}</td>
                    <td>${viewButton}</td>
                </tr>`;
            }).join(''); 
        } else { 
            tbody.innerHTML = `<tr><td colspan="100%">${App.UI.getEmptyStateHTML('fa-history', 'No Log Entries Found', 'Changes to data will be recorded here.')}</td></tr>`; 
        } 
        App.UI.animateTableRows(tbody); 
        App.UI.renderPaginationControls('changelog', log.length); 
        App.UI.updateSortIndicators('changelog'); 
    }, 
    setupEventListeners() { 
        const debouncedRender = App.Helpers.debounce(() => {App.state.pagination.changelog.currentPage = 1; this.render()}, 300); 
        document.getElementById('changelog-search').addEventListener('input', debouncedRender);
        document.getElementById('changelog-entity-filter').addEventListener('change', debouncedRender);
        document.getElementById('changelog-action-filter').addEventListener('change', debouncedRender);
        document.querySelector('#changelog-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('changelog', th.dataset.sort); }); 
        document.getElementById('changelog-table-body').addEventListener('click', (e) => {
            const detailBtn = e.target.closest('.view-changelog-detail');
            if(detailBtn) this.showChangeDetail(parseInt(detailBtn.dataset.id));
        });
    },
    showChangeDetail(timestamp) {
        const entry = App.DB.get('changeLog').find(e => e.timestamp === timestamp);
        if (!entry) return App.UI.toast('Log entry not found.', 'error');

        const content = document.getElementById('changelog-detail-content');
        content.innerHTML = `
            <div class="detail-info-grid" style="grid-template-columns: 1fr;">
                <div class="detail-info-card"><div class="label">TIMESTAMP</div><div class="value">${new Date(entry.timestamp).toLocaleString()}</div></div>
                <div class="detail-info-card"><div class="label">USER</div><div class="value">${entry.user}</div></div>
                <div class="detail-info-card"><div class="label">ACTION</div><div class="value">${entry.action}</div></div>
                <div class="detail-info-card"><div class="label">ENTITY</div><div class="value">${entry.entityType}: ${entry.entityName}</div></div>
            </div>
            <h4 class="card-title mt-4 mb-2">Change Details</h4>
            <div class="card" style="background: var(--bg-color); padding: var(--spacing-4); white-space: pre-wrap; font-size: var(--fs-sm);">
                ${entry.details || 'No detailed changes recorded.'}
            </div>
        `;

        App.UI.openModal('changelog-detail-modal');
    }
});

Object.assign(App.Import, { 
    isProcessing: false,

    init: function() { 
        const dropZone = document.getElementById('csv-drop-zone'); 
        const fileInput = document.getElementById('csv-file-input'); 
        const sampleLink = document.getElementById('download-sample-csv-link'); 
        
        const modalContent = document.querySelector('#import-csv-modal .modal-content');
        if (modalContent && !document.getElementById('import-progress-container')) {
            const progressHTML = `
                <div id="import-progress-container" class="hidden" style="margin: var(--spacing-4) 0; padding: 15px; background: var(--bg-color); border-radius: 8px;">
                    <div class="d-flex justify-content-between mb-2"><span id="import-status-text">Ready</span><span id="import-progress-text">0%</span></div>
                    <div class="progress-bar"><div id="import-progress-bar" class="progress-bar-inner" style="width: 0%"></div></div>
                    <div id="import-error-log" style="font-size: 0.75rem; color: red; margin-top: 10px; max-height: 100px; overflow-y: auto;"></div>
                </div>`;
            modalContent.querySelector('.modal-footer').insertAdjacentHTML('beforebegin', progressHTML);
        }

        if (dropZone) {
            const newDrop = dropZone.cloneNode(true);
            dropZone.parentNode.replaceChild(newDrop, dropZone);
            newDrop.onclick = () => fileInput.click();
            newDrop.ondragover = (e) => { e.preventDefault(); newDrop.classList.add('dragover'); };
            newDrop.ondragleave = () => newDrop.classList.remove('dragover');
            newDrop.ondrop = (e) => { e.preventDefault(); newDrop.classList.remove('dragover'); if(e.dataTransfer.files.length) this.handleFileSelect(e.dataTransfer.files[0]); };
        }
        
        if (fileInput) fileInput.onchange = (e) => this.handleFileSelect(e.target.files[0]);
        if (sampleLink) sampleLink.onclick = (e) => { e.preventDefault(); this.downloadSampleCSV(); };
    }, 
    
    handleFileSelect: function(file) {
    if (!file || this.isProcessing) return;
    document.getElementById('csv-filename').textContent = file.name;
    this.resetUI(); 
    this.updateProgress(5, "Syncing..."); 
    this.isProcessing = true;
    
    const reader = new FileReader(); 
    reader.onload = async (e) => {
        // 1. FORCE a fresh fetch from the server before processing
        // This ensures we have the LATEST consultant IDs in memory
        await App.DB.initialize(); 
        
        const lines = e.target.result.split(/\r\n|\n/);
        const rawHeaders = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z0-9]/g, ''));
        
        const getColIdx = (names) => {
            for(let n of names) {
                let idx = rawHeaders.indexOf(n.toLowerCase().replace(/[^a-z0-9]/g, ''));
                if(idx > -1) return idx;
            }
            return -1;
        };

        const colMap = {
            accountNo: getColIdx(['accountNumber', 'accountNo']),
            companyName: getColIdx(['companyName', 'name']),
            consultantName: getColIdx(['salesConsultant', 'consultant']),
            bal2025: getColIdx(['balance2020_2025']),
            bal2020: getColIdx(['balance2019_2020']),
            bal18: getColIdx(['balance_lte_2018']),
            initial: getColIdx(['initialDebt']),
            custStatus: getColIdx(['customerStatus'])
        };

        let allConsultants = App.DB.get('consultants');
        let currentCustomers = App.DB.get('customers');
        const newCustomers = [];
        let consultantsUpdated = false;

        const parseNum = (val) => parseFloat(String(val || 0).replace(/[^0-9.-]/g, '')) || 0;

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/"/g, '').trim());

            // --- THE CRITICAL FIX: AGGRESSIVE MATCHING ---
            const rawName = (row[colMap.consultantName] || "Unassigned").trim();
            
            // Normalize name: lowercase and remove all double spaces
            const normalizedImportName = rawName.toLowerCase().replace(/\s+/g, ' ');

            let consultant = allConsultants.find(c => 
                c.name.trim().toLowerCase().replace(/\s+/g, ' ') === normalizedImportName
            );
            
            if (!consultant && rawName !== "Unassigned" && rawName !== "") {
                // Truly a new person
                consultant = { id: Date.now() + i, name: rawName };
                allConsultants.push(consultant);
                consultantsUpdated = true;
                console.log("New Consultant Created:", rawName);
            }

            const b25 = parseNum(row[colMap.bal2025]), b20 = parseNum(row[colMap.bal2020]), b18 = parseNum(row[colMap.bal18]);
            
            newCustomers.push({
                accountNo: row[colMap.accountNo],
                companyName: row[colMap.companyName] || 'Unknown',
                salesConsultantId: consultant ? consultant.id : null,
                customerStatus: row[colMap.custStatus] || 'Collectors',
                initialDebt: parseNum(row[colMap.initial]),
                balance_2020_2025: b25, 
                balance_2019_2020: b20, 
                balance_lte_2018: b18,
                outstanding: b25 + b20 + b18,
                status: 'Active', 
                paymentStatus: 'Negotiation', 
                tags: []
            });
        }

        // 2. Only save consultants if we actually added someone new
        if (consultantsUpdated) {
            App.DB.set('consultants', allConsultants);
        }

        newCustomers.forEach(nc => {
            const idx = currentCustomers.findIndex(c => c.accountNo === nc.accountNo);
            if (idx > -1) currentCustomers[idx] = {...currentCustomers[idx], ...nc};
            else currentCustomers.push(nc);
        });

        // 3. Save customers
        App.DB.set('customers', currentCustomers);
        
        this.updateProgress(100, "Done");
        App.UI.toast("Import Successful. IDs were preserved.");
        App.UI.closeModal('import-csv-modal');
        this.isProcessing = false;

        // 4. RELOAD the app to ensure the User ID mapping is refreshed in the browser
        setTimeout(() => location.reload(), 1500);
    };
    reader.readAsText(file);
	},

    resetUI() {
        document.getElementById('import-progress-container').classList.remove('hidden');
        document.getElementById('import-error-log').innerHTML = '';
        this.updateProgress(0, "Starting...");
    },

    updateProgress(percent, text) {
        document.getElementById('import-progress-bar').style.width = `${percent}%`;
        document.getElementById('import-progress-text').textContent = `${Math.floor(percent)}%`;
        if(text) document.getElementById('import-status-text').textContent = text;
    },

    log(msg) {
        document.getElementById('import-error-log').innerHTML += `<div>${msg}</div>`;
    },

    // --- KEY FIX: PARSER ---
    parseLine(text) {
        const result = []; let cur = ''; let inQ = false;
        for (let i = 0; i < text.length; i++) {
            const c = text[i];
            if (c === '"') { if (inQ && text[i+1] === '"') { cur += '"'; i++; } else { inQ = !inQ; } }
            else if (c === ',' && !inQ) { result.push(cur.trim()); cur = ''; }
            else { cur += c; }
        }
        result.push(cur.trim());
        return result;
    },

    processCSV: function(csvText) {
        const lines = csvText.split(/\r?\n/).filter(l => l.trim() !== '');
        if (lines.length < 2) { this.log("Empty File"); this.isProcessing = false; return; }
        
        const headers = this.parseLine(lines.shift()).map(h => h.toLowerCase().replace(/[^a-z0-9]/g, ''));
        const map = {};
        ['accountnumber', 'companyname', 'initialdebt', 'salesconsultant', 'balance20202025', 'balance20192020', 'balancelte2018', 'latitude', 'longitude'].forEach(k => {
            const idx = headers.indexOf(k); if(idx > -1) map[k] = idx;
        });

        if (map['accountnumber'] === undefined) { this.log("Missing accountNumber"); this.isProcessing = false; return; }

        let customers = [];
        let consultants = App.DB.get('consultants') || [];
        let newCons = new Set();
        let existingIds = new Set((App.DB.get('customers') || []).map(c => String(c.accountNo).toLowerCase()));

        const total = lines.length;
        const chunk = 50;
        let idx = 0;

        const processChunk = () => {
            const end = Math.min(idx + chunk, total);
            for (let i = idx; i < end; i++) {
                try {
                    const row = this.parseLine(lines[i]);
                    const get = (k) => map[k] !== undefined ? row[map[k]] : '';
                    const acc = get('accountnumber');
                    if(!acc || existingIds.has(String(acc).toLowerCase())) continue;

                    const cons = get('salesconsultant');
                    if(cons) newCons.add(cons);

                    const cleanNum = (v) => parseFloat(String(v).replace(/[^0-9.-]/g, '')) || 0;

                    customers.push({
                        accountNo: acc,
                        companyName: get('companyname'),
                        salesConsultantId: null, // Link later
                        tempConsultant: cons,
                        initialDebt: cleanNum(get('initialdebt')),
                        balance_2020_2025: cleanNum(get('balance20202025')),
                        balance_2019_2020: cleanNum(get('balance20192020')),
                        balance_lte_2018: cleanNum(get('balancelte2018')),
                        outstanding: cleanNum(get('initialdebt')) || cleanNum(get('balance20202025')) + cleanNum(get('balance20192020')) + cleanNum(get('balancelte2018')),
                        status: 'Active',
                        paymentStatus: 'Negotiation',
                        tags: []
                    });
                    existingIds.add(String(acc).toLowerCase());
                } catch(e) {}
            }
            idx = end;
            this.updateProgress(Math.floor((idx/total)*90), `Processing ${idx}/${total}`);
            
            if(idx < total) setTimeout(processChunk, 10);
            else this.finalize(customers, newCons, consultants);
        };
        processChunk();
    },

    finalize(customers, newCons, consultants) {
        newCons.forEach(n => {
            if(!consultants.some(c => c.name.toLowerCase() === n.toLowerCase())) {
                consultants.push({ id: Date.now() + Math.floor(Math.random()*1000), name: n });
            }
        });
        App.DB.set('consultants', consultants);

        customers.forEach(c => {
            const m = consultants.find(co => co.name.toLowerCase() === (c.tempConsultant||'').toLowerCase());
            c.salesConsultantId = m ? m.id : null;
            delete c.tempConsultant;
        });

        const all = [...(App.DB.get('customers')||[]), ...customers];
        App.DB.set('customers', all);
        
        this.updateProgress(100, "Done");
        setTimeout(() => {
            this.isProcessing = false;
            App.UI.closeModal('import-csv-modal');
            App.Customers.render();
            App.UI.toast(`Added ${customers.length} customers.`);
        }, 800);
    },
    
    downloadSampleCSV: function() { 
        const headers = "accountNumber,companyName,email,mobile,emirate,area,status,paymentStatus,initialDebt,salesConsultant,customerStatus,debtSince,balance2020_2025,balance2019_2020,balance_lte_2018,latitude,longitude"; 
        const exampleRow = "DXB-123,Sample Trading LLC,contact@sample.com,+971501234567,Dubai,Al Quoz,Active,Negotiation,\"199,859.49\",Mohammad Ashraf,Sales (Above 3 Months),2023-01-15,10000,50000,139859.49,25.1234,55.4321"; 
        const csvContent = headers + "\n" + exampleRow; 
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
        const link = document.createElement("a"); 
        link.href = URL.createObjectURL(blob); 
        link.download = "customer_import_template.csv"; 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
    } 
});

Object.assign(App.Settings, {
    render() {
        // Calculate Data Health
        const customers = App.DB.get('customers');
        const total = customers.length;
        if (total === 0) return;

        const missingMobile = customers.filter(c => !c.mobile || c.mobile.length < 5).length;
        const missingEmail = customers.filter(c => !c.email || !c.email.includes('@')).length;
        const missingGPS = customers.filter(c => !c.latitude || !c.longitude).length;
        const missingConsultant = customers.filter(c => !c.salesConsultantId).length;

        const mobileScore = Math.round(((total - missingMobile) / total) * 100);
        const emailScore = Math.round(((total - missingEmail) / total) * 100);
        const gpsScore = Math.round(((total - missingGPS) / total) * 100);
        const overallScore = Math.round((mobileScore + emailScore + gpsScore) / 3);

        // Color logic
        const getColor = (s) => s > 80 ? 'success' : (s > 50 ? 'warning' : 'danger');

        const html = `
            <div class="page-header"><h2>System Settings & Data Health</h2><p>Manage configuration and monitor data quality.</p></div>
            
            <div class="card mb-6">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title"><i class="fas fa-heartbeat"></i> CRM Data Hygiene</h3>
                    <span class="status-badge ${getColor(overallScore)}" style="font-size: 1rem;">Overall Health: ${overallScore}%</span>
                </div>
                
                <div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    
                    <div style="padding: 15px; background: var(--bg-color); border-radius: 8px;">
                        <div class="d-flex justify-content-between mb-2">
                            <span style="font-weight: 600;">Mobile Numbers</span>
                            <span class="text-${getColor(mobileScore)}">${mobileScore}%</span>
                        </div>
                        <div class="progress-bar mb-2"><div class="progress-bar-inner" style="width: ${mobileScore}%; background-color: var(--${getColor(mobileScore)});"></div></div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${missingMobile} missing records</div>
                        ${missingMobile > 0 ? `<button class="btn btn-outline btn-sm mt-2 w-100" onclick="App.Settings.filterBadData('mobile')">Fix Now</button>` : '<div class="text-success mt-2" style="font-size:0.8rem;"><i class="fas fa-check"></i> All Good</div>'}
                    </div>

                    <div style="padding: 15px; background: var(--bg-color); border-radius: 8px;">
                        <div class="d-flex justify-content-between mb-2">
                            <span style="font-weight: 600;">Email Addresses</span>
                            <span class="text-${getColor(emailScore)}">${emailScore}%</span>
                        </div>
                        <div class="progress-bar mb-2"><div class="progress-bar-inner" style="width: ${emailScore}%; background-color: var(--${getColor(emailScore)});"></div></div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${missingEmail} missing records</div>
                        ${missingEmail > 0 ? `<button class="btn btn-outline btn-sm mt-2 w-100" onclick="App.Settings.filterBadData('email')">Fix Now</button>` : '<div class="text-success mt-2" style="font-size:0.8rem;"><i class="fas fa-check"></i> All Good</div>'}
                    </div>

                    <div style="padding: 15px; background: var(--bg-color); border-radius: 8px;">
                        <div class="d-flex justify-content-between mb-2">
                            <span style="font-weight: 600;">GPS Coordinates</span>
                            <span class="text-${getColor(gpsScore)}">${gpsScore}%</span>
                        </div>
                        <div class="progress-bar mb-2"><div class="progress-bar-inner" style="width: ${gpsScore}%; background-color: var(--${getColor(gpsScore)});"></div></div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${missingGPS} missing records</div>
                        ${missingGPS > 0 ? `<button class="btn btn-outline btn-sm mt-2 w-100" onclick="App.Settings.filterBadData('gps')">Fix Now</button>` : '<div class="text-success mt-2" style="font-size:0.8rem;"><i class="fas fa-check"></i> All Good</div>'}
                    </div>
                    
                </div>
            </div>
        `;
        
        // Prepend to settings page
        const settingsPage = document.getElementById('settings-page');
        // Clear old content first to avoid duplicates if re-rendering, but keep the static HTML structure safe
        // For simplicity in this context, we will just set innerHTML of the top container
        // But since you have other static cards there, let's use a container ID
        
        let healthContainer = document.getElementById('data-health-container');
        if(!healthContainer) {
            healthContainer = document.createElement('div');
            healthContainer.id = 'data-health-container';
            settingsPage.prepend(healthContainer);
        }
        healthContainer.innerHTML = html;
        App.UI.observeProgressBars();
    },
    setupEventListeners() {
        const settingsPage = document.getElementById('settings-page');
        settingsPage.addEventListener('click', e => {
            if (e.target.id === 'backup-data-btn') this.backupData();
            if (e.target.id === 'restore-data-btn') this.handleRestore();
            if (e.target.id === 'enable-offline-mode-btn') App.Offline.enableOfflineMaps();
            
            // NEW: Export Logic
            if (e.target.id === 'smart-export-btn') this.handleSmartExport();
        });

        const restoreInput = document.getElementById('restore-file-input');
        const restoreBtn = document.getElementById('restore-data-btn');
        if (restoreInput) {
            restoreInput.addEventListener('change', () => {
                restoreBtn.disabled = !restoreInput.files.length;
            });
        }
        
        // Add "Smart Export" card to the HTML dynamically if it's missing
        if (!document.getElementById('smart-export-card')) {
            const page = document.getElementById('settings-page');
            const cardHTML = `
                <div id="smart-export-card" class="card mt-4">
                    <div class="card-header"><h3 class="card-title"><i class="fas fa-file-export"></i> Data Export Center</h3></div>
                    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); align-items: end; gap: 15px;">
                        <div class="form-group mb-0">
                            <label>Data Type</label>
                            <select id="export-type" class="form-control">
                                <option value="payments">Payments</option>
                                <option value="visits">Visits</option>
                                <option value="customers">Customers</option>
                            </select>
                        </div>
                        <div class="form-group mb-0">
                            <label>Start Date</label>
                            <input type="date" id="export-start" class="form-control">
                        </div>
                        <div class="form-group mb-0">
                            <label>End Date</label>
                            <input type="date" id="export-end" class="form-control">
                        </div>
                        <button id="smart-export-btn" class="btn btn-primary" style="height: 42px;"><i class="fas fa-download"></i> Export Data</button>
                    </div>
                </div>
            `;
            // Insert before the backup card
            page.insertAdjacentHTML('afterbegin', cardHTML);
            
            // Set defaults
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('export-start').value = firstDay.toISOString().slice(0,10);
            document.getElementById('export-end').value = today.toISOString().slice(0,10);
        }
    },
    
    handleSmartExport() {
        const type = document.getElementById('export-type').value;
        const start = document.getElementById('export-start').value;
        const end = document.getElementById('export-end').value;
        
        if (!start || !end) return App.UI.toast('Please select a date range.', 'warning');
        
        let data = [];
        let headers = [];
        const dateKey = type === 'visits' ? 'dateTime' : 'date'; // Customers don't filter by date usually, but we can filter by 'debtSince' or ignore dates
        
        if (type === 'payments') {
            data = App.DB.get('payments').filter(p => p.date >= start && p.date <= end);
            headers = ['ID', 'Date', 'Customer', 'Amount', 'Method', 'Status'];
            data = data.map(p => [p.id, p.date, p.customerId, p.amount, p.method, p.status]);
        } 
        else if (type === 'visits') {
            data = App.DB.get('visits').filter(v => v.dateTime.slice(0,10) >= start && v.dateTime.slice(0,10) <= end);
            headers = ['Date', 'Customer', 'Purpose', 'Outcome', 'Notes'];
            data = data.map(v => [v.dateTime.slice(0,10), v.customerId, v.purpose, v.outcome || '-', (v.notes || '').replace(/<[^>]*>?/gm, '')]);
        }
        else if (type === 'customers') {
            // For customers, export all, ignore dates
            data = App.DB.get('customers');
            headers = ['Account #', 'Company', 'Outstanding', 'Status', 'Consultant'];
            const consultantMap = App.DB.get('consultants').reduce((m, c) => { m[c.id] = c.name; return m; }, {});
            data = data.map(c => [c.accountNo, c.companyName, c.outstanding, c.status, consultantMap[c.salesConsultantId] || 'N/A']);
        }

        if (data.length === 0) return App.UI.toast('No data found for this period.', 'info');
        
        App.Helpers.exportToCSV(`${type}_export_${start}_to_${end}.csv`, headers, data);
        App.UI.toast(`Exported ${data.length} records.`, 'success');
    },

    backupData() {
        const format = document.querySelector('input[name="backup-format"]:checked').value;
        const dateStr = new Date().toISOString().slice(0, 10);

        if (format === 'json') {
            const dataToBackup = {};
            const keysToBackup = ['customers', 'visits', 'payments', 'users', 'consultants', 'activityLog', 'changeLog', 'notifications', 'dataModelVersion', 'forecasts', 'customerComments', 'customerForecasts', 'paginationSettings'];
            keysToBackup.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    dataToBackup[key] = JSON.parse(data);
                }
            });
            App.Helpers.downloadBlob(JSON.stringify(dataToBackup, null, 2), `erp-backup-${dateStr}.json`, 'application/json');
        } else if (format === 'csv') {
            const tables = ['customers', 'visits', 'payments', 'consultants', 'users', 'forecasts', 'customerComments', 'customerForecasts'];
            tables.forEach(key => {
                const data = App.DB.get(key);
                if (data.length > 0) {
                    const headers = Object.keys(data[0]);
                    const csvData = data.map(row => headers.map(header => row[header]));
                    App.Helpers.exportToCSV(`${key}-backup-${dateStr}.csv`, headers, csvData);
                }
            });
        }
        App.UI.toast('Backup file(s) created!', 'success');
    },
	
	filterBadData: function(type) {
        // Navigate to customers
        App.UI.navigateTo('customers');
        
        // Set a special filter
        setTimeout(() => {
            const searchInput = document.getElementById('customer-search');
            if(!searchInput) return;

            // We hijack the search function slightly or use a custom filtering logic
            // For simplicity, we will clear the list and manually render the bad data
            const customers = App.DB.get('customers');
            let badData = [];
            
            if (type === 'mobile') badData = customers.filter(c => !c.mobile || c.mobile.length < 5);
            if (type === 'email') badData = customers.filter(c => !c.email || !c.email.includes('@'));
            if (type === 'gps') badData = customers.filter(c => !c.latitude || !c.longitude);

            App.Customers.renderListView(badData);
            App.UI.toast(`Showing ${badData.length} customers with missing ${type.toUpperCase()}`, 'info');
        }, 100);
    },
	
    handleRestore() {
        const fileInput = document.getElementById('restore-file-input');
        const file = fileInput.files[0];
        if (!file) return App.UI.toast('Please select a backup file first.', 'warning');

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                if (file.name.endsWith('.json')) {
                    const data = JSON.parse(event.target.result);
                    if (!data.customers || !data.users) throw new Error('Invalid JSON backup file.');
                    App.UI.confirm('Overwrite all data?', 'Restoring will replace all current data. Continue?', () => {
                        localStorage.clear();
                        Object.keys(data).forEach(key => localStorage.setItem(key, JSON.stringify(data[key])));
                        App.UI.toast('Restore successful! Reloading...', 'success');
                        setTimeout(() => location.reload(), 1500);
                    });
                } else if (file.name.endsWith('.csv')) {
                    App.UI.confirm('Overwrite Customers?', 'This will add customers from the CSV. Existing customers with the same Account # will be skipped. Continue?', () => {
                        App.Import.processCSV(event.target.result);
                        App.UI.toast('Customer import from CSV complete!', 'success');
                        fileInput.value = '';
                    });
                } else {
                    throw new Error('Unsupported file type.');
                }
            } catch (error) { App.UI.toast(`Error reading file: ${error.message}`, 'error'); }
        };
        reader.readAsText(file);
    }
});

Object.assign(App.Performance, {
    setupEventListeners() {},
    render() {
        const consultants = App.DB.get('consultants');
        const container = document.getElementById('performance-grid-container');
        container.classList.remove('performance-grid'); 
        
        if (consultants.length === 0) {
            container.innerHTML = App.UI.getEmptyStateHTML('fa-user-tie', 'No Consultants Found', 'Add consultants to see their performance data here.');
            return;
        }

        // 1. Calculate Scores & Badges
        const currentMonthStr = `${App.state.dashboardTimeFrame.year}-${(App.state.dashboardTimeFrame.month).toString().padStart(2, '0')}`;
        const customers = App.DB.get('customers');
        const payments = App.DB.get('payments');
        const visits = App.DB.get('visits');

        const rankedConsultants = consultants.map(c => {
            // A. Base Metrics
            const myCustomers = customers.filter(cust => cust.salesConsultantId === c.id).map(cust => cust.accountNo);
            const paymentsInMonth = payments.filter(p => myCustomers.includes(p.customerId) && p.status === 'Completed' && p.date.startsWith(currentMonthStr));
            const collected = paymentsInMonth.reduce((sum, p) => sum + p.amount, 0);
            const visitCount = visits.filter(v => v.collectorId === c.id && v.status === 'Completed' && v.dateTime.startsWith(currentMonthStr)).length;
            const overdueCount = visits.filter(v => v.collectorId === c.id && v.status === 'Overdue').length;
            
            // B. Badge Logic
            const badges = [];
            
            //  Shark: High Collector (> 100k)
            if (collected >= 100000) {
                badges.push({ icon: 'fa-shark', color: '#0dcaf0', title: 'The Shark (High Value Collector)' });
            }
            
            //  Guardian: Clean Slate (No Overdue)
            if (overdueCount === 0 && myCustomers.length > 0) {
                badges.push({ icon: 'fa-shield-alt', color: '#10b981', title: 'Guardian (Zero Overdue Tasks)' });
            }

            //  On Fire: Recent Activity (Collection in last 48 hours)
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            const hasRecentPayment = payments.some(p => myCustomers.includes(p.customerId) && p.status === 'Completed' && new Date(p.date) >= twoDaysAgo);
            
            if (hasRecentPayment) {
                badges.push({ icon: 'fa-fire', color: '#fd7e14', title: 'On Fire (Active Streak)' });
            }

            // C. Scoring
            const score = Math.floor((collected / 1000) + (visitCount * 10));
            return { ...c, collected, visitCount, score, badges };
        }).sort((a, b) => b.score - a.score);

        const topPerformer = rankedConsultants[0];

        // 2. Build The Layout
        const layoutHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-8);">
                
                <div class="card" style="background: linear-gradient(135deg, var(--dark) 0%, #212529 100%); color: white; border: none; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 300px;">
                    <div style="font-size: var(--fs-sm); color: #ffd700; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; margin-bottom: var(--spacing-4);">
                        <i class="fas fa-crown"></i> Top Performer
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.1); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: var(--spacing-4); font-size: 2.5rem; color: #ffd700; border: 2px solid #ffd700;">
                        ${topPerformer.name.charAt(0)}
                    </div>

                    <div style="font-size: 2rem; font-weight: 800; margin-bottom: var(--spacing-2); text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                        ${topPerformer.name}
                    </div>
                    
                    <div class="d-flex gap-2 mb-4">
                        ${topPerformer.badges.map(b => `<i class="fas ${b.icon}" style="color:${b.color}; font-size: 1.2rem;" title="${b.title}"></i>`).join('')}
                    </div>

                    <div style="display: flex; gap: var(--spacing-4); font-size: var(--fs-sm); color: #adb5bd; border-top: 1px solid rgba(255,255,255,0.1); padding-top: var(--spacing-4); width: 100%; justify-content: center;">
                        <div>
                            <div style="color: white; font-weight: 600;">${App.Helpers.formatCurrency(topPerformer.collected)}</div>
                            <div>Collected</div>
                        </div>
                        <div style="width: 1px; background: rgba(255,255,255,0.2);"></div>
                        <div>
                            <div style="color: white; font-weight: 600;">${topPerformer.visitCount}</div>
                            <div>Visits</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="display: flex; flex-direction: column;">
                    <div class="card-header"><h3 class="card-title"><i class="fas fa-list-ol"></i> Leaderboard Ranking</h3></div>
                    <div class="table-container" style="flex-grow: 1;">
                        <table class="data-table">
                            <thead><tr><th>Rank</th><th>Consultant</th><th>Badges</th><th>Score</th><th>Collected</th></tr></thead>
                            <tbody>
                                ${rankedConsultants.map((c, i) => `
                                    <tr style="${i === 0 ? 'background-color: rgba(255, 215, 0, 0.05);' : ''}">
                                        <td><span style="font-weight:700; color: ${i === 0 ? '#d9a007' : 'var(--text-secondary)'};">#${i + 1}</span></td>
                                        <td style="font-weight: 600;">
                                            ${c.name} 
                                            ${i === 0 ? '<i class="fas fa-crown" style="color: #ffd700; margin-left: 5px;"></i>' : ''}
                                        </td>
                                        <td>
                                            ${c.badges.map(b => `<i class="fas ${b.icon}" style="color:${b.color}; margin-right:5px;" title="${b.title}"></i>`).join('')}
                                        </td>
                                        <td><span class="status-badge" style="background: var(--dark); color: white; border: none;">${c.score}</span></td>
                                        <td>${App.Helpers.formatCurrency(c.collected)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <h3 class="card-title mb-4" style="border-bottom: 2px solid var(--border-color); padding-bottom: var(--spacing-2);">Detailed Metrics</h3>
            <div class="performance-grid">
                ${rankedConsultants.map(c => this.getConsultantCardHTML(c)).join('')}
            </div>
        `;

        container.innerHTML = layoutHTML;
        App.UI.observeProgressBars();
    },
    getConsultantCardHTML(consultant) {
        const currentMonthStr = `${App.state.dashboardTimeFrame.year}-${(App.state.dashboardTimeFrame.month).toString().padStart(2, '0')}`;
        const customers = App.DB.get('customers').filter(c => c.salesConsultantId === consultant.id);
        const customerIds = customers.map(c => c.accountNo);
        const paymentsInMonth = App.DB.get('payments').filter(p => customerIds.includes(p.customerId) && p.status === 'Completed' && p.date.startsWith(currentMonthStr));
        const visits = App.DB.get('visits').filter(v => v.collectorId === consultant.id && v.dateTime.startsWith(currentMonthStr));
        const forecast = App.DB.get('forecasts').find(f => f.consultantId === consultant.id && f.month === currentMonthStr) || {};
        const customerForecasts = App.DB.get('customerForecasts');

        const collectedAmount = paymentsInMonth.reduce((sum, p) => sum + p.amount, 0);
        
        // --- Overall Target ---
        const targetAmount = forecast.amount || 0;
        const targetPercentage = targetAmount > 0 ? ((collectedAmount / targetAmount) * 100).toFixed(0) : 0;

        // --- Customer Forecast ---
        const forecastAmount = customerForecasts.filter(f => f.month === currentMonthStr && customerIds.includes(f.accountNo)).reduce((sum, f) => sum + f.amount, 0);
        const forecastPercentage = forecastAmount > 0 ? ((collectedAmount / forecastAmount) * 100).toFixed(0) : 0;

        // --- Status-wise Targets ---
        const customerStatuses = ['Collectors', 'Sales (Above 3 Months)', 'Sales (Above 360 Days)'];
        let statusProgressHTML = '';
        customerStatuses.forEach(status => {
            const key = `amount_${status.replace(/\s/g, '').replace(/[()+]/g, '')}`;
            const statusTarget = forecast[key] || 0;
            
            const customersInStatus = customers.filter(c => c.customerStatus === status).map(c => c.accountNo);
            const collectedForStatus = paymentsInMonth.filter(p => customersInStatus.includes(p.customerId)).reduce((sum, p) => sum + p.amount, 0);
            
            const percentage = statusTarget > 0 ? ((collectedForStatus / statusTarget) * 100).toFixed(0) : 0;

            statusProgressHTML += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span style="font-size: var(--fs-sm);">${status}</span>
                        <span>${percentage}%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-bar-inner" data-width="${percentage}" style="background-color: var(--success);"></div></div>
                    <div style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${App.Helpers.formatCurrency(collectedForStatus)} of ${App.Helpers.formatCurrency(statusTarget)}</div>
                </div>`;
        });
        
        // --- Outstanding Balances & Collected This Month Breakdown ---
        const balance_lte_2018 = customers.reduce((sum, c) => sum + (c.balance_lte_2018 || 0), 0);
        const collected_lte_2018 = paymentsInMonth.reduce((sum, p) => sum + (p.amount_lte_2018 || 0), 0);
        const initial_balance_lte_2018 = balance_lte_2018 + collected_lte_2018;
        const perc_collected_lte_2018 = initial_balance_lte_2018 > 0 ? (collected_lte_2018 / initial_balance_lte_2018 * 100).toFixed(1) : 0;

        const balance_2019_2020 = customers.reduce((sum, c) => sum + (c.balance_2019_2020 || 0), 0);
        const collected_2019_2020 = paymentsInMonth.reduce((sum, p) => sum + (p.amount_2019_2020 || 0), 0);
        const initial_balance_2019_2020 = balance_2019_2020 + collected_2019_2020;
        const perc_collected_2019_2020 = initial_balance_2019_2020 > 0 ? (collected_2019_2020 / initial_balance_2019_2020 * 100).toFixed(1) : 0;

        const balance_2020_2025 = customers.reduce((sum, c) => sum + (c.balance_2020_2025 || 0), 0);
        const collected_2020_2025 = paymentsInMonth.reduce((sum, p) => sum + (p.amount_2020_2025 || 0), 0);
        const initial_balance_2020_2025 = balance_2020_2025 + collected_2020_2025;
        const perc_collected_2020_2025 = initial_balance_2020_2025 > 0 ? (collected_2020_2025 / initial_balance_2020_2025 * 100).toFixed(1) : 0;

        return `
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title" style="color: var(--text-primary); font-size: var(--fs-lg);">${consultant.name}</h3>
                </div>
                <div>
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>Overall Monthly Target (${currentMonthStr})</span>
                            <span>${targetPercentage}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-bar-inner" data-width="${targetPercentage}"></div></div>
                        <div class="text-right" style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${App.Helpers.formatCurrency(collectedAmount)} of ${App.Helpers.formatCurrency(targetAmount)}</div>
                    </div>
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>Overall Customer Forecast (${currentMonthStr})</span>
                            <span>${forecastPercentage}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-bar-inner" data-width="${forecastPercentage}" style="background-color: var(--warning);"></div></div>
                         <div class="text-right" style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${App.Helpers.formatCurrency(collectedAmount)} of ${App.Helpers.formatCurrency(forecastAmount)}</div>
                    </div>
                    
                    <hr style="border-color: var(--border-color); margin: var(--spacing-4) 0;">
                    <h4 class="card-title" style="font-size: var(--fs-base); margin-bottom: var(--spacing-4);">Status-wise Target Progress</h4>
                    ${statusProgressHTML}

                    <hr style="border-color: var(--border-color); margin: var(--spacing-4) 0;">
                    <h4 class="card-title" style="font-size: var(--fs-base); margin-bottom: var(--spacing-4);">Collected This Month vs Initial Balance</h4>
                    <div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--spacing-2);">
                         <div class="detail-info-card">
                            <div class="label"><=2018</div>
                            <div class="breakdown-item">
                                <span class="value">${App.Helpers.formatCurrency(collected_lte_2018)}</span>
                                <span class="percentage">${perc_collected_lte_2018}%</span>
                            </div>
                        </div>
                         <div class="detail-info-card">
                            <div class="label">2019-2020</div>
                            <div class="breakdown-item">
                                <span class="value">${App.Helpers.formatCurrency(collected_2019_2020)}</span>
                                <span class="percentage">${perc_collected_2019_2020}%</span>
                            </div>
                        </div>
                         <div class="detail-info-card">
                            <div class="label">2020-2025</div>
                            <div class="breakdown-item">
                                <span class="value">${App.Helpers.formatCurrency(collected_2020_2025)}</span>
                                <span class="percentage">${perc_collected_2020_2025}%</span>
                            </div>
                        </div>
                    </div>

                     <hr style="border-color: var(--border-color); margin: var(--spacing-4) 0;">
                    <div class="detail-info-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="detail-info-card"><div class="label">Visits This Month</div><div class="value">${visits.length}</div></div>
                        <div class="detail-info-card"><div class="label">Payments This Month</div><div class="value">${paymentsInMonth.length}</div></div>
                    </div>
                </div>
            </div>
        `;
    }
});
Object.assign(App.Geo, {
    // A mock geocoding service. Replace with a real API call.
    async geocodeAddress(addressString, accountNo) {
        console.log(`Geocoding: ${addressString}`);
        // In a real app, you would make an API call here.
        // For now, we'll use the consistent mock coordinates.
        return new Promise(resolve => {
            setTimeout(() => { // Simulate network delay
                const coords = this.getMockCoordinates(accountNo);
                resolve(coords);
            }, 50);
        });
    },
    getMockCoordinates(accountNo) {
        // This hash function ensures the same account number always gets the same pseudo-random location.
        let hash = 0;
        for (let i = 0; i < accountNo.length; i++) {
            hash = accountNo.charCodeAt(i) + ((hash << 5) - hash);
        }
        // Base coordinates (e.g., Dubai) with a small, deterministic offset
        const lat = 25.2048 + ((hash % 1000) / 10000);
        const lng = 55.2708 + (((hash / 1000) % 1000) / 10000);
        return { lat, lng };
    }
});

Object.assign(App.ContextMenu, {
    init() {
        // 1. Create the Menu DOM Element
        if (!document.getElementById('global-context-menu')) {
            const menu = document.createElement('div');
            menu.id = 'global-context-menu';
            menu.className = 'context-menu';
            document.body.appendChild(menu);
        }

        // 2. Listen for Right Click
        document.addEventListener('contextmenu', (e) => {
            const row = e.target.closest('tr');
            // Only trigger if inside a data-table body
            if (row && row.closest('tbody')) {
                e.preventDefault();
                this.show(e.clientX, e.clientY, row);
            }
        });

        // 3. Close on Left Click
        document.addEventListener('click', () => this.hide());
    },

    show(x, y, row) {
        const menu = document.getElementById('global-context-menu');
        const pageId = App.state.activePage;
        
        // Try to find the ID from buttons
        const btnWithId = row.querySelector('button[data-id]');
        if (!btnWithId) return; 
        
        const id = btnWithId.dataset.id;
        let menuItems = [];

        // --- DEFINE MENUS BASED ON PAGE ---
        if (pageId === 'customers') {
            menuItems = [
                { icon: 'fa-eye', text: 'View Details', action: () => App.Customers.showCustomerDetail(id) },
                { icon: 'fa-file-invoice', text: 'Statement (SOA)', action: () => App.Customers.generateSOA(id) },
                { divider: true },
                { icon: 'fa-credit-card', text: 'Record Payment', action: () => App.Payments.showPaymentForm(id) },
                { icon: 'fa-calendar-plus', text: 'Schedule Visit', action: () => App.Visits.showScheduleModal(null, null, id) },
                { divider: true },
                { icon: 'fa-edit', text: 'Edit Customer', action: () => App.Customers.showCustomerForm(id) }
            ];
        } 
        else if (pageId === 'visits' || pageId === 'myday') {
            menuItems = [
                { icon: 'fa-eye', text: 'View Visit Details', action: () => App.Visits.showVisitDetail(id) },
                { icon: 'fa-check', text: 'Mark as Done', action: () => App.Visits.showMarkDoneModal(id) },
                { divider: true },
                { icon: 'fa-trash', text: 'Delete Visit', action: () => App.Visits.deleteVisit(id) }
            ];
        } 
        else if (pageId === 'payments') {
            menuItems = [
                { icon: 'fa-eye', text: 'View Details', action: () => App.Payments.showPaymentDetail(id) },
                { icon: 'fa-file-pdf', text: 'Download Receipt', action: () => App.Payments.generateReceipt(id) },
                { divider: true },
                { icon: 'fa-trash', text: 'Delete Payment', action: () => App.Payments.deletePayment(id) }
            ];
        }

        // Render Menu
        if (menuItems.length > 0) {
            menu.innerHTML = menuItems.map(item => {
                if (item.divider) return `<div class="context-menu-divider"></div>`;
                return `
                    <div class="context-menu-item" onclick="window.contextAction(${menuItems.indexOf(item)})">
                        <i class="fas ${item.icon}"></i> ${item.text}
                    </div>
                `;
            }).join('');

            menu.style.display = 'block';
            
            // Positioning Logic (Keep on screen)
            const menuWidth = menu.offsetWidth || 180;
            const menuHeight = menu.offsetHeight || 200;
            
            let left = x;
            let top = y;

            if (x + menuWidth > window.innerWidth) left = x - menuWidth;
            if (y + menuHeight > window.innerHeight) top = y - menuHeight;

            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;

            // Helper for click handling
            window.contextAction = (index) => {
                menuItems[index].action();
                this.hide();
            };
        }
    },

    hide() {
        const menu = document.getElementById('global-context-menu');
        if (menu) menu.style.display = 'none';
    }
});

Object.assign(App.FAB, {
    init() {
        // 1. Create HTML
        const container = document.createElement('div');
        container.className = 'fab-container';
        container.innerHTML = `
            <div class="fab-main" id="fab-trigger"><i class="fas fa-plus"></i></div>
            
            <div class="fab-action" data-tooltip="Record Payment" onclick="App.Payments.showPaymentForm()">
                <i class="fas fa-credit-card"></i>
            </div>
            <div class="fab-action" data-tooltip="Schedule Visit" onclick="App.Visits.showScheduleModal()">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="fab-action" data-tooltip="Add Customer" onclick="App.Customers.showCustomerForm()">
                <i class="fas fa-user-plus"></i>
            </div>
        `;
        document.body.appendChild(container);

        // 2. Add Interactions
        const trigger = document.getElementById('fab-trigger');
        
        // Toggle on click
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            container.classList.toggle('active');
            const icon = trigger.querySelector('i');
            if (container.classList.contains('active')) {
                icon.classList.remove('fa-plus');
                icon.classList.add('fa-times');
            } else {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-plus');
            }
        });

        // Close when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!container.contains(e.target)) {
                container.classList.remove('active');
                trigger.querySelector('i').classList.remove('fa-times');
                trigger.querySelector('i').classList.add('fa-plus');
            }
        });
    }
});

Object.assign(App.Offline, {
    init() {
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    },
    enableOfflineMaps() {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            App.UI.confirm('Enable Offline Maps?', 'This will download map data for offline use. This may take some time and use significant storage. Proceed?', () => {
                navigator.serviceWorker.controller.postMessage({ action: 'cache-tiles' });
                App.UI.toast('Map caching started in the background.', 'info');
            });
        } else {
            App.UI.toast('Offline functionality is not available.', 'error');
        }
    }
});
Object.assign(App.Helpers, { 
    tagColors: {},
    formatCurrency: (a) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'AED', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(a),
	highlightMatch: (text, query) => {
        if (!query || query.length < 2 || !text) return text;
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        return String(text).replace(regex, '<mark class="highlight">$1</mark>');
    },
	createSparkline: (dataPoints) => {
        if (!dataPoints || dataPoints.length < 2) return '';
        
        const width = 60;
        const height = 20;
        const max = Math.max(...dataPoints);
        const min = Math.min(...dataPoints);
        const range = max - min || 1; // Avoid division by zero
        
        // Calculate SVG points
        const step = width / (dataPoints.length - 1);
        const points = dataPoints.map((val, i) => {
            const x = i * step;
            // Invert Y because SVG 0 is at top. 
            // We want higher values (debt) at top, lower at bottom.
            const y = height - ((val - min) / range) * height; 
            return `${x},${y}`;
        }).join(' ');

        // Color Logic: If Start > End, debt went down (Green). Else Red.
        const isImprovement = dataPoints[0] > dataPoints[dataPoints.length - 1];
        const color = isImprovement ? '#10b981' : '#dc3545';

        return `<svg width="${width}" height="${height}" style="vertical-align: middle; margin-left: 8px; opacity: 0.8; overflow: visible;">
            <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <circle cx="${width}" cy="${height - ((dataPoints[dataPoints.length-1] - min)/range)*height}" r="2" fill="${color}" />
        </svg>`;
    },
	getAvatarHTML: (name) => {
        if (!name) return '';
        const initials = name.split(' ').map(n => n[0]).slice(0, 2).join('');
        
        // Generate consistent color from name
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        const hue = Math.abs(hash % 360);
        const color = `hsl(${hue}, 60%, 45%)`; // Darker, professional colors
        
        return `<div class="avatar-circle" style="background-color: ${color};">${initials}</div>`;
    },
    parseCurrency: (s) => parseFloat(String(s).replace(/[^0-9.-]+/g,"")),
    formatAbbreviatedCurrency: (num) => { if (num >= 1000000) return 'AED ' + (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M'; if (num >= 1000) return 'AED ' + (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K'; return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'AED' }).format(num); }, 
    debounce: (f, d) => { let t; return function(...a) { clearTimeout(t); t = setTimeout(() => f.apply(this, a), d); }; }, 
    formatDate: (dateString) => {
        if (!dateString) return 'N/A';
        if (dateString === 'Initial') return 'Initial Balance';
        // Check if dateString includes time or is just a date part (ISO format)
        if (dateString.includes('T')) {
             const date = new Date(dateString);
             // Use UTC methods to prevent timezone shifts if it's an ISO date with T00:00:00.000Z
             if (dateString.endsWith('Z') || dateString.includes('T00:00:00')) {
                return date.toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'UTC' });
             }
             // For datetime-local or other times, show date and time
             return date.toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        // Assume simple date string (YYYY-MM-DD)
        const parts = dateString.split('-');
        if (parts.length === 3) {
            // Reconstruct as UTC date to avoid local timezone interpretation shifting the day
            const date = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
            return date.toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'UTC' });
        }
        
        return dateString;
    },
    formatDateTime: (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        // Format: "25 Oct 2025, 10:30 am"
        return date.toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
    }, 
    parseCSVDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return null;
        const parts = dateStr.split(/[/|-]/);
        if (parts.length === 3) {
            let [day, month, year] = parts;
            if (year.length === 2) year = '20' + year;
            if (day.length > 0 && month.length > 0 && year.length === 4) {
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
        }
        if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return dateStr;
        }
        return null;
    },
    formatDuration(ms) {
        if (ms <= 0) return '00:00:00';
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
        const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
    },
    timeAgo(timestamp) { if (!timestamp) return 'Never'; const now = new Date(); const seconds = Math.floor((now - new Date(timestamp)) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago"; return Math.floor(seconds) + " seconds ago"; }, 
    getScopedData(dataType, consultantId = null) {
        let user;
        if (consultantId !== null) {
            user = { role: 'user', assignedConsultantId: consultantId };
        } else {
            user = App.state.currentUser;
        }

        if (!user) return [];
        if (user.role === 'admin' && !consultantId) return App.DB.get(dataType);
        
        const effectiveConsultantId = user.assignedConsultantId;
        const allCustomers = App.DB.get('customers');
        
        // FIX: Match consultant ID as string
        const scopedCustomers = allCustomers.filter(c => String(c.salesConsultantId) === String(effectiveConsultantId));
        
        if (dataType === 'customers') return scopedCustomers;
        
        const scopedCustomerIds = scopedCustomers.map(c => String(c.accountNo));
        
        if (dataType === 'visits') {
            // FIX: Match collector ID as string
            return App.DB.get('visits').filter(v => String(v.collectorId) === String(effectiveConsultantId));
        }
        
        if (dataType === 'payments') {
            // FIX: Match customer IDs as strings
            return App.DB.get('payments').filter(p => scopedCustomerIds.includes(String(p.customerId)));
        }
        
        return App.DB.get(dataType); 
    },
    logActivity(action, details = '', customerId = null, amount = null, visitId = null, duration = null) {
        if (App.state.currentUser.role !== 'user') return;
        const log = App.DB.get('activityLog');
        const now = new Date();
        const newEntry = { 
            id: Date.now(), 
            consultantId: App.state.currentUser.assignedConsultantId, 
            timestamp: now.getTime(), 
            date: now.toISOString().slice(0, 10), 
            time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }), 
            action, 
            details,
            customerId,
            amount: amount,
            visitId: visitId,
            duration: duration
        };
        log.push(newEntry);
        App.DB.set('activityLog', log);
        
        let notificationMessage;
        const consultantName = App.DB.get('consultants').find(c => c.id === newEntry.consultantId)?.name || 'A user';
        if(customerId) {
            const customerName = App.DB.get('customers').find(c => c.accountNo === customerId)?.companyName || 'a customer';
            let messageDetails = details;
            if (amount) {
                messageDetails = `${App.Helpers.formatCurrency(amount)} ${details}`;
            }
            notificationMessage = `${consultantName} ${action.replace(/a |an /, '')} for ${customerName} ${messageDetails}`;
        } else {
             notificationMessage = `${consultantName} has ${action.toLowerCase()}`;
        }
        App.Notifications.create(notificationMessage); 
    }, 
    logChange(action, entityType, entityName, details = '') { const changeLog = App.DB.get('changeLog'); const newEntry = { timestamp: Date.now(), user: App.state.currentUser.fullName, action, entityType, entityName, details }; changeLog.unshift(newEntry); App.DB.set('changeLog', changeLog); },
    getObjectChanges(originalObj, newObj) {
        if (!originalObj) return 'New record created.';
        const changes = [];
        const allKeys = new Set([...Object.keys(originalObj), ...Object.keys(newObj)]);
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map;}, {});

        for (let key of allKeys) {
            if (['id', 'originalData'].includes(key)) continue;
            
            if (key === 'password') {
                if (originalObj.password !== newObj.password) {
                    changes.push('Password was changed.');
                }
                continue;
            }

            let before = originalObj[key];
            let after = newObj[key];

            if (key === 'salesConsultantId' || key === 'assignedConsultantId') {
                before = consultantMap[before] || 'N/A';
                after = consultantMap[after] || 'N/A';
            }
            
            if (String(before) !== String(after)) {
                changes.push(`'${key}' changed from "${before}" to "${after}"`);
            }
        }
        return changes.join('; ');
    },
    stripHtml(html) {
        if (!html) return "";
        const doc = new DOMParser().parseFromString(html, 'text/html');
        return doc.body.textContent || "";
    },
    parsePaymentDetails(details) {
        if (!details) return { method: 'N/A' };
        const match = details.match(/Method:\s*([^)]+)/);
        return {
            method: match ? match[1].trim() : details
        };
    },
    parseVisitDetails(details) {
        if (!details) return { outcome: 'N/A', extra: '-' };
        const outcomeMatch = details.match(/Outcome:\s*([^,)]+)/);
        const outcome = outcomeMatch ? outcomeMatch[1].trim() : 'Completed';
        const extra = details.replace(/KATEX_INLINE_OPENOutcome:[^)]+KATEX_INLINE_CLOSE,?\s*/, '').trim();
        return {
            outcome: outcome,
            extra: extra || '-'
        };
    },
    calculateAgingCategory(debtSince) {
        if (!debtSince) return 'Current (0-30 Days)';
        const debtDate = new Date(debtSince);
        const today = new Date();
        const diffTime = Math.abs(today - debtDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays <= 30) return 'Current (0-30 Days)';
        if (diffDays <= 60) return '31-60 Days';
        if (diffDays <= 90) return '61-90 Days';
        if (diffDays <= 180) return '91-180 Days';
        return '180+ Days';
    },
    calculateCustomerHealth(customer, allPayments, allVisits) {
        let score = 100;
        let reasons = [];

        // --- 1. NEW: Legacy Debt Check (High Impact) ---
        if (customer.balance_lte_2018 > 0) {
            score -= 40; // Immediate heavy penalty
            reasons.push(`Legacy Debt (${App.Helpers.formatCurrency(customer.balance_lte_2018)})`);
        }

        // --- 2. NEW: Ghosting Check (High Impact) ---
        // Check if last 2 completed visits were "No Answer"
        const customerVisits = allVisits
            .filter(v => v.customerId === customer.accountNo && v.status === 'Completed')
            .sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));
            
        const recentOutcomes = customerVisits.slice(0, 2).map(v => v.outcome);
        if (recentOutcomes.length >= 2 && recentOutcomes.every(o => o === 'No Answer')) {
            score -= 30;
            reasons.push("Potential Ghosting");
        }

        // --- 3. EXISTING CHECKS (Refined Weights) ---

        // Outstanding Balance
        if (customer.outstanding > 50000) {
            score -= 20;
            reasons.push("High balance");
        } else if (customer.outstanding > 10000) {
            score -= 10;
            reasons.push("Moderate balance");
        }

        // Last Payment Date
        const customerPayments = allPayments.filter(p => p.customerId === customer.accountNo && p.status === 'Completed').sort((a,b) => new Date(b.date) - new Date(a.date));
        if (customerPayments.length > 0) {
            const lastPaymentDate = new Date(customerPayments[0].date);
            const daysSincePayment = (new Date() - lastPaymentDate) / (1000 * 3600 * 24);
            if (daysSincePayment > 90) {
                score -= 30;
                reasons.push("No payment in 90+ days");
            } else if (daysSincePayment > 60) {
                score -= 15;
                reasons.push("No payment in 60+ days");
            }
        } else {
            score -= 15;
            reasons.push("No payment history");
        }
        
        // Overdue Visits
        const hasOverdueVisit = allVisits.some(v => v.customerId === customer.accountNo && v.status === 'Overdue');
        if (hasOverdueVisit) {
            score -= 15;
            reasons.push("Overdue tasks");
        }

        // Determine Status and Title
        if (score >= 80) {
            return { status: 'good', title: 'Good Standing' };
        } else if (score >= 50) {
            return { status: 'warning', title: `Needs Attention: ${reasons.join(', ')}.` };
        } else {
            return { status: 'critical', title: `Critical: ${reasons.join(', ')}.` };
        }
    },
    getCustomerMarkerIcon(customer, isCompleted = false) {
        const health = isCompleted ? { status: 'completed' } : this.calculateCustomerHealth(customer, App.DB.get('payments'), App.DB.get('visits'));
        return L.divIcon({
            className: 'leaflet-div-icon',
            html: `<i class="fas fa-map-marker-alt status-marker ${health.status}" title="${health.title || ''}"></i>`,
            iconSize: [28, 28],
            iconAnchor: [14, 28]
        });
    },
    getTagColor(tag) {
        const lowerTag = tag.toLowerCase();
        if (this.tagColors[lowerTag]) {
            return this.tagColors[lowerTag];
        }
        // Use a simple hash function to generate a color
        let hash = 0;
        for (let i = 0; i < lowerTag.length; i++) {
            hash = lowerTag.charCodeAt(i) + ((hash << 5) - hash);
        }
        const h = hash % 360;
        const color = `hsl(${h}, 70%, 85%)`;
        const borderColor = `hsl(${h}, 50%, 60%)`;
        const textColor = `hsl(${h}, 50%, 20%)`;
        this.tagColors[lowerTag] = { color, borderColor, textColor };
        return this.tagColors[lowerTag];
    },
    getTagHTML(tag, className = '') {
        const colors = this.getTagColor(tag);
        const style = `background-color: ${colors.color}; border-color: ${colors.borderColor}; color: ${colors.textColor};`;
        return `<span class="customer-tag ${className}" style="${style}" data-tag="${tag}">${tag}</span>`;
    },
    getColumnDataType(columnKey) {
        const numericColumns = ['outstanding', 'initialDebt', 'balance_2020_2025', 'balance_2019_2020', 'balance_lte_2018', 'forecastAmount', 'totalPaid', 'amount', 'promiseAmount', 'amount_2020_2025', 'amount_2019_2020', 'amount_lte_2018'];
        const dateColumns = ['dateTime', 'date', 'promiseDate', 'debtSince', 'lastPaymentDate', 'nextVisitDate', 'activePromiseDate'];
        const selectColumns = {
            status: ['Active', 'Inactive'],
            paymentStatus: ['Negotiation', 'Settlement', 'Legal', 'Write-Off'],
            customerStatus: ['Collectors', 'Sales (Above 3 Months)', 'Sales (Above 360 Days)'],
            agingCategory: ['Current (0-30 Days)', '31-60 Days', '61-90 Days', '91-180 Days', '180+ Days'],
            emirate: ['Dubai', 'Abu Dhabi', 'Sharjah', 'Ajman'],
            method: ['Bank Transfer', 'Cheque', 'Cash'],
            outcome: ['No Answer', 'Promise to Pay', 'Dispute', 'Paid in Full', 'Partial Payment']
        };

        if (numericColumns.includes(columnKey)) return 'number';
        if (dateColumns.includes(columnKey)) return 'date';
        if (selectColumns[columnKey]) return `select:${columnKey}`;
        return 'string';
    },
    getFilterValueInputHTML(dataType) {
        if (dataType.startsWith('select:')) {
            const key = dataType.split(':')[1];
            const selectOptions = {
                status: ['Active', 'Inactive'],
                paymentStatus: ['Negotiation', 'Settlement', 'Legal', 'Write-Off'],
                customerStatus: ['Collectors', 'Sales (Above 3 Months)', 'Sales (Above 360 Days)'],
                agingCategory: ['Current (0-30 Days)', '31-60 Days', '61-90 Days', '91-180 Days', '180+ Days'],
                emirate: ['Dubai', 'Abu Dhabi', 'Sharjah', 'Ajman'],
                method: ['Bank Transfer', 'Cheque', 'Cash'],
                outcome: ['No Answer', 'Promise to Pay', 'Dispute', 'Paid in Full', 'Partial Payment']
            };
            const options = selectOptions[key] || [];
            return `<select class="form-control filter-value-input">${options.map(o => `<option value="${o}">${o}</option>`).join('')}</select>`;
        }
        switch (dataType) {
            case 'number':
                return `<input type="number" class="form-control filter-value-input" placeholder="Value" step="any">`;
            case 'date':
                return `<input type="date" class="form-control filter-value-input" placeholder="YYYY-MM-DD">`;
            case 'string':
            default:
                return `<input type="text" class="form-control filter-value-input" placeholder="Text or phrase">`;
        }
    },
    populateMonthYearDropdowns(monthSelectId, yearSelectId, selectedMonth, selectedYear) {
        const monthSelect = document.getElementById(monthSelectId);
        const yearSelect = document.getElementById(yearSelectId);
        
        if (!monthSelect || !yearSelect) return;

        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        monthSelect.innerHTML = months.map((month, i) => `<option value="${(i + 1).toString().padStart(2, '0')}">${month}</option>`).join('');

        const currentYear = new Date().getFullYear();
        let yearOptions = '';
        for (let y = currentYear + 1; y >= currentYear - 5; y--) {
            yearOptions += `<option value="${y}">${y}</option>`;
        }
        yearSelect.innerHTML = yearOptions;

        monthSelect.value = (selectedMonth + 1).toString().padStart(2, '0');
        yearSelect.value = selectedYear;
    },
    downloadBlob(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);
    },
    exportToCSV(filename, headers, data) {
        let csvContent = headers.join(",") + "\r\n";
        data.forEach(rowArray => {
            let row = rowArray.map(item => `"${String(item || '').replace(/"/g, '""')}"`).join(",");
            csvContent += row + "\r\n";
        });
        this.downloadBlob(csvContent, filename, 'text/csv;charset=utf-8;');
    },
    exportToPDF(filename, title, headers, data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(title, 14, 16);
        doc.autoTable({ head: [headers], body: data, startY: 20 });
        doc.save(filename);
    },
    exportTableData(format, entityName, getDataCallback, displayColumns) {
        const allData = getDataCallback();
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c.companyName; return map; }, {});
        const customerForecasts = App.DB.get('customerForecasts');
        const currentMonthStr = `${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}`;

        const allColumnLabels = {
            accountNo: 'Account #', companyName: 'Company Name', customerStatus: 'Customer Status', agingCategory: 'Aging Category', outstanding: 'Balance',
            balance_2020_2025: '2020-2025', balance_2019_2020: '2019-2020', balance_lte_2018: '<=2018', forecastAmount: 'Forecast', salesConsultantId: 'Consultant',
            paymentStatus: 'Payment Status', email: 'Email', mobile: 'Mobile', dateTime: 'Date', date: 'Date', customerId: 'Customer',
            purpose: 'Purpose', collectorId: 'Consultant', status: 'Status', consultantId: 'Consultant', amount: 'Amount', method: 'Method'
        };

        const headers = displayColumns.map(key => allColumnLabels[key] || key);

        const data = allData.map(item => {
            return displayColumns.map(key => {
                let value = item[key];
                switch(key) {
                    case 'salesConsultantId':
                    case 'collectorId':
                    case 'consultantId':
                        return consultantMap[value] || 'N/A';
                    case 'customerId':
                        return customerMap[value] || 'N/A';
                    case 'dateTime':
                    case 'date':
                        return App.Helpers.formatDate(value);
                    case 'forecastAmount':
                        const forecast = customerForecasts.find(f => f.accountNo === item.accountNo && f.month === currentMonthStr);
                        return forecast ? forecast.amount.toFixed(2) : '0.00';
                    case 'outstanding':
                    case 'amount':
                    case 'balance_2020_2025':
                    case 'balance_2019_2020':
                    case 'balance_lte_2018':
                        return value ? value.toFixed(2) : '0.00'; // Return as raw number for CSV
                    default:
                        return value || '';
                }
            });
        });

        const filename = `${entityName}_Report_${new Date().toLocaleDateString()}`;
        if (format === 'csv') {
            App.Helpers.exportToCSV(filename + '.csv', headers, data);
        } else {
            // For PDF, format currency values
            const pdfData = allData.map(item => {
                return displayColumns.map(key => {
                    let value = item[key];
                    switch(key) {
                        case 'salesConsultantId':
                        case 'collectorId':
                        case 'consultantId':
                            return consultantMap[value] || 'N/A';
                        case 'customerId':
                            return customerMap[value] || 'N/A';
                        case 'dateTime':
                        case 'date':
                            return App.Helpers.formatDate(value);
                        case 'forecastAmount':
                             const forecast = customerForecasts.find(f => f.accountNo === item.accountNo && f.month === currentMonthStr);
                             return App.Helpers.formatCurrency(forecast ? forecast.amount : 0);
                        case 'outstanding':
                        case 'amount':
                        case 'balance_2020_2025':
                        case 'balance_2019_2020':
                        case 'balance_lte_2018':
                            return App.Helpers.formatCurrency(value || 0);
                        default:
                            return value || '';
                    }
                });
            });
            App.Helpers.exportToPDF(filename + '.pdf', `${entityName} List`, headers, pdfData);
        }
    },
    getReportData(dataSource, selectedColumns, filters = {}) {
        const { consultantId, startDate, endDate, dynamicFilters = [] } = filters;
        
        const allCustomers = App.DB.get('customers');
        const allPayments = App.DB.get('payments');
        const allVisits = App.DB.get('visits');
        const allCustomerForecasts = App.DB.get('customerForecasts');
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const customerMap = allCustomers.reduce((map, c) => { map[c.accountNo] = c; return map; }, {});

        const headers = selectedColumns.map(key => App.Reports.availableColumns[dataSource][key]);
        let items = [];

        if (dataSource === 'customers') {
            items = allCustomers.filter(c => consultantId === 'all' || c.salesConsultantId == consultantId);
        } else if (dataSource === 'payments') {
            items = allPayments.filter(p => p.status === 'Completed');
        } else if (dataSource === 'visits') {
            items = allVisits.filter(v => v.status === 'Completed');
        }
        
        // --- Filter by Date Range ---
        if (startDate && endDate) {
            items = items.filter(item => {
                const dateKey = dataSource === 'visits' ? 'dateTime' : 'date';
                const itemDate = item[dateKey]?.slice(0, 10);
                if (!itemDate) return false;
                return itemDate >= startDate && itemDate <= endDate;
            });
        }
        
        // --- Filter by Consultant (linking via Customer) ---
        if (dataSource !== 'customers' && consultantId !== 'all') {
            items = items.filter(item => customerMap[item.customerId]?.salesConsultantId == consultantId);
        }

        // --- Apply Dynamic Filters ---
        items = items.filter(item => {
            const fullItem = {
                ...item,
                customerName: customerMap[item.customerId || item.accountNo]?.companyName,
                consultantName: consultantMap[item.salesConsultantId || item.collectorId]
            };
            
            return dynamicFilters.every(filter => {
                let itemValue = fullItem[filter.column];
                let filterValue = filter.value;
                const dataType = App.Helpers.getColumnDataType(filter.column);

                if (itemValue === undefined || itemValue === null) return false;

                if (dataType === 'number') {
                    itemValue = parseFloat(itemValue) || 0;
                    filterValue = parseFloat(filterValue) || 0;
                    if (isNaN(filterValue)) return true; // Filter value is invalid, skip filtering
                } else if (dataType === 'string' || dataType.startsWith('select')) {
                    itemValue = String(itemValue).toLowerCase();
                    filterValue = String(filterValue).toLowerCase();
                }

                switch (filter.operator) {
                    case 'EQUALS':
                    case 'ON':
                    case 'EQ':
                        return itemValue === filterValue;
                    case 'NEQ':
                        return itemValue !== filterValue;
                    case 'CONTAINS':
                        return itemValue.includes(filterValue);
                    case 'STARTS_WITH':
                        return itemValue.startsWith(filterValue);
                    case 'GT':
                    case 'AFTER':
                        return itemValue > filterValue;
                    case 'LT':
                    case 'BEFORE':
                        return itemValue < filterValue;
                    default:
                        return itemValue === filterValue;
                }
            });
        });

        // Map data for final output
        const data = items.map(item => {
            const customer = customerMap[item.customerId || item.accountNo];
            const customerPayments = allPayments.filter(p => p.customerId === item.accountNo || p.customerId === customer?.accountNo);
            const customerVisits = allVisits.filter(v => v.customerId === item.accountNo || v.customerId === customer?.accountNo);

            const fullData = { ...item };
            let outputRow = [];

            if (dataSource === 'customers') {
                const totalPaid = customerPayments.filter(p => p.status === 'Completed').reduce((sum, p) => sum + p.amount, 0);
                const lastPayment = customerPayments.filter(p => p.status === 'Completed').sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                const lastVisit = customerVisits.filter(v => v.status === 'Completed').sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime))[0];
                const nextVisit = customerVisits.filter(v => v.status === 'Scheduled' && new Date(v.dateTime) >= new Date()).sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime))[0];
                const activePromise = customerVisits.filter(v => v.outcome === 'Promise to Pay' && v.promiseDate && new Date(v.promiseDate) >= new Date()).sort((a,b) => new Date(a.promiseDate) - new Date(b.promiseDate))[0];
                
                Object.assign(fullData, {
                    salesConsultant: consultantMap[item.salesConsultantId] || 'N/A',
                    tags: item.tags ? item.tags.join(', ') : '',
                    totalPaid: totalPaid,
                    lastPaymentDate: lastPayment ? App.Helpers.formatDate(lastPayment.date) : 'N/A',
                    lastVisitDate: lastVisit ? App.Helpers.formatDateTime(lastVisit.dateTime) : 'N/A',
                    nextVisitDate: nextVisit ? App.Helpers.formatDateTime(nextVisit.dateTime) : 'N/A',
                    activePromiseDate: activePromise ? App.Helpers.formatDate(activePromise.promiseDate) : 'N/A',
                    activePromiseAmount: activePromise ? App.Helpers.formatCurrency(activePromise.promiseAmount) : 'N/A'
                });
            } else if (dataSource === 'payments') {
                Object.assign(fullData, {
                    customerName: customer?.companyName || 'N/A',
                    consultantName: consultantMap[customer?.salesConsultantId] || 'N/A',
                });
            } else if (dataSource === 'visits') {
                Object.assign(fullData, {
                    customerName: customer?.companyName || 'N/A',
                    consultantName: consultantMap[item.collectorId] || 'N/A',
                    notes: App.Helpers.stripHtml(item.notes || '')
                });
            }

            selectedColumns.forEach(col => {
                let val = fullData[col];
                
                if (typeof val === 'number') {
                    if (['initialDebt', 'outstanding', 'balance_2020_2025', 'balance_2019_2020', 'balance_lte_2018', 'totalPaid', 'amount', 'promiseAmount', 'amount_2020_2025', 'amount_2019_2020', 'amount_lte_2018'].includes(col)) {
                        outputRow.push(App.Helpers.formatCurrency(val));
                    } else {
                        outputRow.push(val);
                    }
                } else if (['dateTime', 'date', 'promiseDate', 'debtSince', 'lastPaymentDate'].includes(col)) {
                    outputRow.push(App.Helpers.formatDate(val));
                } else {
                    outputRow.push(val !== undefined ? val : '');
                }
            });

            return outputRow;
        });

        return { data, headers };
    },
    optimizeRoute(customerIds) {
        if (customerIds.length < 2) return customerIds;

        const customerMap = App.DB.get('customers').reduce((map, c) => {
            map[c.accountNo] = c;
            return map;
        }, {});

        // Simple TSP solver (Nearest Neighbor)
        let unvisited = customerIds.map(id => customerMap[id]).filter(c => c && c.latitude && c.longitude);
        if (unvisited.length < 2) return customerIds;

        let route = [];
        let current = unvisited.shift();
        route.push(current.accountNo);

        const getDist = (c1, c2) => Math.sqrt(Math.pow(c1.latitude - c2.latitude, 2) + Math.pow(c1.longitude - c2.longitude, 2));

        while (unvisited.length > 0) {
            let nearestIndex = -1;
            let minDistance = Infinity;
            for (let i = 0; i < unvisited.length; i++) {
                let distance = getDist(current, unvisited[i]);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestIndex = i;
                }
            }
            current = unvisited[nearestIndex];
            route.push(current.accountNo);
            unvisited.splice(nearestIndex, 1);
        }
        return route;
    }
});

</script></body> </html>
