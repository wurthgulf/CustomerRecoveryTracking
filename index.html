<!--
Enhanced Recovery Pro - Version 4.9.0 (Advanced Activity Reporting)
Changelog v4.9.0:
- FEATURE: Upgraded Consultant Activity Report to support date ranges (From/To).
- FEATURE: Added "Customer" and "Date" columns to the activity report table for enhanced detail.
- UI/UX: The report now defaults to showing activity for the current month.
- UI/UX: The summary view for the activity report is now adapted for date ranges.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Recovery App</title>

    <!-- Dependencies -->
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            /* Wuerth Group Inspired Color Palette */
            --primary: #e2000f; /* Wuerth Red */
            --success: #10b981;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #212529; /* Black/Dark Grey */
            --light: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d; /* Grey */
            --bg-color: #f0f2f5; /* Light Grey Background */
            --card-bg: #ffffff; /* White */
            --border-color: #dee2e6;

            --font-family: 'Inter', sans-serif;
            --fs-sm: 0.875rem; --fs-base: 1rem; --fs-lg: 1.125rem; --fs-xl: 1.25rem; --fs-2xl: 1.5rem; --fs-3xl: 1.875rem;
            --spacing-1: 0.25rem; --spacing-2: 0.5rem; --spacing-4: 1rem; --spacing-6: 1.5rem; --spacing-8: 2rem;
            --transition-speed: 0.2s;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-primary); font-size: var(--fs-base); line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        .app-container { display: grid; grid-template-columns: 250px 1fr; grid-template-rows: auto 1fr; grid-template-areas: "sidebar header" "sidebar main"; height: 100vh; transition: grid-template-columns var(--transition-speed) ease; }
        .sidebar { grid-area: sidebar; background-color: var(--card-bg); border-right: 1px solid var(--border-color); padding: var(--spacing-4); display: flex; flex-direction: column; transition: transform var(--transition-speed) ease; z-index: 1000; }
        .main-header { grid-area: header; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: var(--spacing-4) var(--spacing-6); display: flex; justify-content: space-between; align-items: center; }
        .main-content { grid-area: main; overflow-y: auto; padding: var(--spacing-6); background-color: var(--bg-color); }
        .page { display: none; } .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 1024px) { .app-container { grid-template-columns: 80px 1fr; } .sidebar .logo-text, .sidebar .nav-text, .sidebar-heading { display: none; } .sidebar .nav-link { justify-content: center; } }
        @media (max-width: 768px) { .app-container { grid-template-columns: 1fr; grid-template-areas: "header" "main"; } .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: var(--shadow); } .sidebar.open { transform: translateX(0); } .sidebar .logo-text, .sidebar .nav-text, .sidebar-heading { display: inline; } .sidebar .nav-link { justify-content: flex-start; } .hamburger { display: block !important; } }
        #login-page { display: flex; justify-content: center; align-items: center; height: 100vh; background: transparent; }
        
        .login-card { width: 100%; max-width: 400px; padding: var(--spacing-8); background-color: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow-lg); text-align: center; }
        #login-page .form-group label { text-align: left; } 
        
        .logo { font-size: 2rem; font-weight: 800; margin-bottom: var(--spacing-8); text-align: left; padding: 0 var(--spacing-4); }
        
        .logo img {
            max-width: 220px; 
            height: auto;
            margin: 0 auto;
        }
        .sidebar .logo img {
            max-width: 150px;
            margin: 0;
        }

        .sidebar-heading { font-size: var(--fs-sm); color: var(--text-secondary); text-transform: uppercase; font-weight: 600; padding: var(--spacing-4); margin-top: var(--spacing-4); }
        .nav-link { display: flex; align-items: center; gap: var(--spacing-4); padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-weight: 600; margin-bottom: var(--spacing-1); transition: background-color var(--transition-speed), color var(--transition-speed); }
        .nav-link:hover { background-color: var(--bg-color); color: var(--text-primary); }
        .nav-link.active { background-color: var(--primary); color: white; box-shadow: 0 4px 8px rgba(226, 0, 15, 0.3); }
        .nav-link.active i { color: white; }
        .nav-link i { width: 20px; text-align: center; color: var(--text-secondary); transition: color var(--transition-speed); }
        .hamburger { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.25rem; cursor: pointer; }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4); padding-bottom: var(--spacing-4); border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: var(--fs-base); font-weight: 600; color: var(--text-secondary); }
        .chart-container { position: relative; height: 350px; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        .data-table thead { border-bottom: 2px solid var(--dark); }
        .data-table tbody tr { border-bottom: 1px solid var(--border-color); }
        .data-table th, .data-table td { padding: var(--spacing-4); text-align: left; vertical-align: middle; border-bottom: none; }
        .data-table th { font-weight: 600; cursor: pointer; text-transform: uppercase; font-size: var(--fs-sm); color: var(--text-secondary); }
        .data-table tbody tr:hover { background-color: #f8f9fa; }
        .btn { padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; min-height: 44px; min-width: 44px; transition: all var(--transition-speed) ease; display: inline-flex; justify-content: center; align-items: center; gap: var(--spacing-2); text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(to bottom, #ff1a28, #e2000f); color: white; border-color: #c0000d; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-primary:hover:not(:disabled) { background: linear-gradient(to bottom, #ff333f, #e2000f); }
        .btn-success { background: linear-gradient(to bottom, #12d493, #10b981); color: white; border-color: #0e9a6b; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-success:hover:not(:disabled) { background: linear-gradient(to bottom, #24e0a1, #10b981); }
        .btn-danger { background: linear-gradient(to bottom, #e34654, #dc3545); color: white; border-color: #b02a37; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-danger:hover:not(:disabled) { background: linear-gradient(to bottom, #ea5c69, #dc3545); }
        .btn-outline { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); text-shadow: none; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5); } .btn-outline:hover:not(:disabled) { background-color: var(--bg-color); }
        .form-group { margin-bottom: var(--spacing-4); }
        .form-group label { display: block; font-weight: 500; margin-bottom: var(--spacing-2); }
        .form-control { width: 100%; padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-primary); font-size: var(--fs-base); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        .modal-content { width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4); }
        .modal-footer { margin-top: var(--spacing-6); display: flex; justify-content: flex-end; gap: var(--spacing-2); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-badge { padding: 4px 10px; border-radius: 999px; font-size: var(--fs-sm); font-weight: 600; text-transform: uppercase; border: 1px solid; }
        .status-badge.admin { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; border-color: #dc3545; }
        .status-badge.user { background-color: rgba(226, 0, 15, 0.1); color: #e2000f; border-color: #e2000f; }
        .status-badge.paid, .status-badge.active, .status-badge.cleared, .status-badge.complete, .status-badge.completed { background-color: rgba(16, 185, 129, 0.1); color: #10b981; border-color: #10b981; }
        .status-badge.pending { background-color: rgba(255, 193, 7, 0.1); color: #d9a007; border-color: #ffc107;}
        .status-badge.overdue { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; border-color: #dc3545; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4); }
        .form-grid .full-width { grid-column: 1 / -1; }
        .detail-info-grid, .kpi-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-6); }
        .detail-info-card { background: var(--bg-color); padding: var(--spacing-4); border-radius: 8px; border: 1px solid var(--border-color); }
        .detail-info-card .label { font-size: var(--fs-sm); color: var(--text-secondary); margin-bottom: var(--spacing-1); text-transform: uppercase; }
        .detail-info-card .value, .kpi-card .value { font-weight: 600; font-size: var(--fs-lg); }
        .kpi-card {background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .kpi-card .title {font-size: var(--fs-base); font-weight: 600; color: var(--text-secondary);}
        .kpi-card .value {font-size: var(--fs-3xl); font-weight: 700;}
        .filter-btn { box-shadow: none; }
        .filter-btn.active { background-color: var(--dark); color: white; border-color: var(--dark); }
        .detail-tab-btn { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: var(--spacing-1) var(--spacing-4); font-size: var(--fs-sm); font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; gap: var(--spacing-2); color: var(--text-secondary); }
        .detail-tab-btn:hover { background-color: var(--dark); color: white; border-color: var(--dark); }
        .detail-tab-btn.active { background-color: var(--dark); color: white; border-color: var(--dark); box-shadow: var(--shadow); }
        .page-header { color: var(--text-primary); margin-bottom: var(--spacing-4); } .page-header h2 { font-size: var(--fs-2xl); font-weight: 700; } .page-header p { color: var(--text-secondary); }
        .progress-bar { width: 100%; height: 8px; background-color: var(--bg-color); border-radius: 999px; overflow: hidden; border: 1px solid var(--border-color); }
        .progress-bar-inner { height: 100%; background-color: var(--primary); border-radius: 999px; transition: width 0.5s ease-in-out; }
        .hidden { display: none !important; } .d-flex { display: flex; } .gap-2 { gap: var(--spacing-2); } .gap-4 { gap: var(--spacing-4); } .mt-4 { margin-top: var(--spacing-4); } .mb-4 { margin-bottom: var(--spacing-4); }
        .justify-content-between { justify-content: space-between; } .align-items-center { align-items: center; } .flex-wrap { flex-wrap: wrap; }
        
        .file-upload-wrapper { border: 2px dashed var(--border-color); border-radius: 8px; padding: var(--spacing-6); text-align: center; cursor: pointer; transition: border-color var(--transition-speed); }
        .file-upload-wrapper:hover, .file-upload-wrapper.dragover { border-color: var(--primary); }
        .file-upload-wrapper p { margin-top: var(--spacing-2); margin-bottom: var(--spacing-2); }
        .info-box { background: var(--bg-color); border: 1px solid var(--border-color); padding: var(--spacing-4); border-radius: 8px; margin: var(--spacing-4) 0; font-size: var(--fs-sm); }
        .info-box p { margin-bottom: var(--spacing-2); }
        .info-box code { background: var(--border-color); padding: 2px 6px; border-radius: 4px; }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-6);
        }
        .report-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: var(--spacing-6);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            text-decoration: none;
            color: var(--text-primary);
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        .report-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        .report-card .icon {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: var(--spacing-4);
        }
        .report-card h4 {
            font-weight: 600;
            font-size: var(--fs-lg);
            margin-bottom: var(--spacing-2);
        }
        .report-card p {
            font-size: var(--fs-sm);
            color: var(--text-secondary);
        }
    </style>
    
    <style id="wuerth-glossy-theme">
        /* Glossy Theme Enhancements */
        .card, .sidebar, .main-header, .modal-content {
            background: linear-gradient(to bottom, #ffffff, #fdfdfd);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: inset 0 2px 2px rgba(0,0,0,0.1);
        }
        .nav-link.active {
            background: linear-gradient(to bottom, #ff1a28, #e2000f);
            border: 1px solid #c0000d;
        }
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(226, 0, 15, 0.2);
        }
    </style>
</head>
<body>
    <!-- App containers that will be populated by JavaScript -->
    <div id="login-page"></div>
    <div id="app" class="app-container hidden"></div>

    <!-- Modal containers -->
    <div id="customer-modal" class="modal"></div>
    <div id="user-modal" class="modal"></div>
    <div id="payment-modal" class="modal"></div>
    <div id="visit-modal" class="modal"></div>
    <div id="import-csv-modal" class="modal"></div>
    <div id="customer-detail-modal" class="modal"></div>
    <div id="visit-notes-modal" class="modal"></div>
    <div id="payment-detail-modal" class="modal"></div>
    <div id="consultant-modal" class="modal"></div>
    <div id="visit-detail-modal" class="modal"></div>
    <div id="consultant-customers-modal" class="modal"></div>
    <div id="reassign-customers-modal" class="modal"></div>

    <!-- Notification Dropdown -->
    <div id="notification-dropdown" class="card hidden" style="position: absolute; width: 350px; z-index: 1001; max-height: 400px; overflow-y: auto; padding: var(--spacing-4);">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 style="margin: 0;">Notifications</h4>
        </div>
        <ul id="notification-list" style="list-style: none; padding: 0; margin: 0;">
            <!-- Notifications will be rendered here -->
        </ul>
    </div>
    
    <!-- Command Palette Modal -->
    <div id="command-palette-modal" class="modal" style="align-items: flex-start; padding-top: 10vh;">
        <div class="modal-content" style="max-width: 600px; padding: 0;">
            <div class="d-flex align-items-center gap-2 p-3" style="border-bottom: 1px solid var(--border-color);">
                <i class="fas fa-search" style="color: var(--text-secondary);"></i>
                <input type="text" id="command-palette-input" class="form-control" placeholder="Search customers or payments..." style="border: none; background: transparent; box-shadow: none;">
            </div>
            <div id="command-palette-results" style="max-height: 400px; overflow-y: auto; padding: var(--spacing-2);"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => App.init());
    
    const App = {
        state: { currentUser: null, customerSort: { column: 'accountNo', order: 'asc' }, reports: { activityView: 'summary' }, activePage: 'dashboard', activeCustomerId: null, visits: { activeView: 'list', filter: 'Upcoming', startDate: '', endDate: '' }, adminDashboardView: 'overview', dayTimerInterval: null, paymentFlowOrigin: null },
        init() { this.UI.hydrate(); this.DB.initialize(); this.Auth.checkSession(); this.UI.setupEventListeners(); this.CommandPalette.init(); this.Notifications.init(); this.Import.init(); },
        Auth: {}, DB: {}, UI: {}, Dashboard: {}, Customers: {}, Visits: {}, Payments: {}, Reports: {}, Consultants: {}, Users: {}, Notifications: {}, CommandPalette: {}, Helpers: {}, AuditLog: {}, Import: {}
    };
    
    Object.assign(App.Auth, { 
        login(u, p) { 
            const users = App.DB.get('users');
            const userIndex = users.findIndex(user => user.username === u && user.password === p);
            if (userIndex > -1) { 
                const user = users[userIndex];
                user.lastLogin = Date.now();
                App.DB.set('users', users);
                App.state.currentUser = user; 
                sessionStorage.setItem('user', JSON.stringify(App.state.currentUser)); 
                App.UI.showApp(); 
                return true; 
            } 
            return false; 
        }, 
        logout() { App.state.currentUser = null; sessionStorage.removeItem('user'); clearInterval(App.state.dayTimerInterval); App.UI.showLogin(); }, 
        checkSession() { const user = sessionStorage.getItem('user'); if (user) { App.state.currentUser = JSON.parse(user); App.UI.showApp(); } else { App.UI.showLogin(); } }, 
        checkRole() { document.querySelectorAll('[data-role="admin"]').forEach(el => { el.style.display = (App.state.currentUser.role === 'admin') ? '' : 'none'; }); document.querySelectorAll('[data-role="user"]').forEach(el => { el.style.display = (App.state.currentUser.role === 'user') ? '' : 'none'; }); } 
    });
    Object.assign(App.DB, { 
        initialize() { if (!localStorage.getItem('consultants')) localStorage.setItem('consultants', JSON.stringify(this.getSampleConsultants())); if (!localStorage.getItem('users')) localStorage.setItem('users', JSON.stringify(this.getSampleUsers())); if (!localStorage.getItem('customers')) localStorage.setItem('customers', JSON.stringify(this.getSampleCustomers())); if (!localStorage.getItem('visits')) localStorage.setItem('visits', JSON.stringify(this.getSampleVisits())); if (!localStorage.getItem('payments')) localStorage.setItem('payments', JSON.stringify(this.getSamplePayments())); if (!localStorage.getItem('activityLog')) localStorage.setItem('activityLog', JSON.stringify([])); if (!localStorage.getItem('notifications')) localStorage.setItem('notifications', JSON.stringify([])); if (!localStorage.getItem('auditLog')) localStorage.setItem('auditLog', JSON.stringify([])); }, 
        get: (key) => JSON.parse(localStorage.getItem(key) || '[]'), 
        set: (key, data) => localStorage.setItem(key, JSON.stringify(data)), 
        getSampleConsultants: () => [], 
        getSampleUsers: () => [ { id: 1, username: 'admin', fullName: 'Admin User', password: 'admin123', role: 'admin', department: 'Administration', lastLogin: null, assignedConsultant: 'N/A' }, { id: 2, username: 'user', fullName: 'Standard User', password: 'user123', role: 'user', department: 'Collections', lastLogin: null, assignedConsultant: 'N/A' } ], 
        getSampleCustomers: () => [], getSampleVisits: () => [], getSamplePayments: () => [] 
    });
    Object.assign(App.UI, { 
        hydrate() { 
            document.getElementById('login-page').innerHTML = `<div class="login-card"><div class="logo"><img src="https://i.ibb.co/pvvsMy1X/Wurth-Gulf-CMYK-PNG-01.png" alt="Wuerth Gulf Logo"></div><h2 style="font-weight: 500; color: var(--text-secondary); margin-bottom: var(--spacing-6);">Customer Recovery App</h2><p id="login-error" class="text-danger mb-4 hidden">Invalid credentials.</p><form id="login-form"><div class="form-group"><label for="username">Username</label><input type="text" id="username" class="form-control" required value=""></div><div class="form-group"><label for="password">Password</label><input type="password" id="password" class="form-control" required value=""></div><button type="submit" class="btn btn-primary" style="width: 100%;">Login</button></form><div class="mt-4" style="color: var(--text-secondary); font-size: var(--fs-sm);"></div></div>`; 
            document.getElementById('app').innerHTML = `<aside class="sidebar"><div class="logo logo-text"><img src="https://i.ibb.co/pvvsMy1X/Wurth-Gulf-CMYK-PNG-01.png" alt="Wuerth Gulf Logo"></div><nav><div class="sidebar-heading">Main</div><ul style="list-style:none;"><li><a href="#dashboard" class="nav-link active" data-page="dashboard"><i class="fas fa-chart-pie"></i> <span class="nav-text">Dashboard</span></a></li><li><a href="#customers" class="nav-link" data-page="customers"><i class="fas fa-users"></i> <span class="nav-text">Customers</span></a></li><li><a href="#visits" class="nav-link" data-page="visits"><i class="fas fa-calendar-alt"></i> <span class="nav-text">Visits & Follow-ups</span></a></li><li><a href="#payments" class="nav-link" data-page="payments"><i class="fas fa-credit-card"></i> <span class="nav-text">Payments</span></a></li><li data-role="admin"><a href="#reports" class="nav-link" data-page="reports"><i class="fas fa-file-alt"></i> <span class="nav-text">Reports</span></a></li></ul><div data-role="admin"><div class="sidebar-heading">Administration</div><ul style="list-style:none;"><li><a href="#consultants" class="nav-link" data-page="consultants"><i class="fas fa-user-tie"></i> <span class="nav-text">Consultants</span></a></li><li><a href="#users" class="nav-link" data-page="users"><i class="fas fa-users-cog"></i> <span class="nav-text">User Management</span></a></li><li><a href="#auditlog" class="nav-link" data-page="auditlog"><i class="fas fa-history"></i> <span class="nav-text">Audit Log</span></a></li></ul></div></nav></aside><header class="main-header"><button class="hamburger" id="hamburger-menu"><i class="fas fa-bars"></i></button><div id="page-title" style="font-weight: 600; font-size: var(--fs-lg);">Dashboard</div><div class="d-flex gap-4 align-items-center"><div id="notification-bell-wrapper" data-role="admin" style="position: relative;"><button id="notification-bell-btn" class="btn btn-outline" style="min-width:auto; padding: 0.5rem; border-radius: 50%; width: 44px; height: 44px;"><i class="fas fa-bell"></i></button><span id="notification-badge" class="hidden" style="position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: var(--fs-sm); display: flex; justify-content: center; align-items: center; font-weight: 600; border: 2px solid var(--card-bg);">0</span></div><div class="d-flex gap-2 align-items-center"><span id="username-display" style="font-weight: 500;"></span><button id="logout-btn" class="btn btn-outline" style="min-width:auto; padding: 0.5rem;"><i class="fas fa-sign-out-alt"></i></button></div></div></header><main class="main-content"><section id="dashboard-page" class="page active"></section><section id="customers-page" class="page"></section><section id="visits-page" class="page"></section><section id="payments-page" class="page"></section><section id="reports-page" class="page" data-role="admin"></section><section id="consultants-page" class="page" data-role="admin"></section><section id="users-page" class="page" data-role="admin"></section><section id="auditlog-page" class="page" data-role="admin"></section></main>`; 
            document.getElementById('customers-page').innerHTML = `<div class="kpi-card-grid"><div class="kpi-card"><div class="title">Total Customers</div><div id="customer-kpi-total" class="value">0</div></div><div class="kpi-card"><div class="title">Total Outstanding</div><div id="customer-kpi-outstanding" class="value">0</div></div><div class="kpi-card"><div class="title">Active Accounts</div><div id="customer-kpi-active" class="value">0</div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><h3 class="card-title">Manage Customers</h3><div class="d-flex gap-2 flex-wrap align-items-center"><input type="search" id="customer-search" placeholder="Search customers..." class="form-control" style="width: auto;"><select id="customer-status-filter" class="form-control" style="width: auto;"><option value="all">All Status</option><option value="Active">Active</option><option value="Inactive">Inactive</option></select><select id="customer-payment-filter" class="form-control" style="width: auto;"><option value="all">All Payments</option><option value="Pending">Pending</option><option value="Paid">Paid</option><option value="Cleared">Cleared</option><option value="Overdue">Overdue</option></select><div data-role="admin" class="d-flex gap-2"><button class="btn btn-outline" id="export-customers-csv"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" id="export-customers-pdf"><i class="fas fa-file-pdf"></i> PDF</button><button class="btn btn-outline" id="import-customer-btn"><i class="fas fa-upload"></i> Import</button><button class="btn btn-primary" id="add-customer-btn"><i class="fas fa-plus"></i> Add Customer</button></div></div></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="accountNo">Account #</th><th data-sort="companyName">Company Name</th><th data-sort="outstanding">Outstanding</th><th data-sort="salesConsultant">Consultant</th><th data-sort="paymentStatus">Payment Status</th><th>Actions</th></tr></thead><tbody id="customer-table-body"></tbody></table></div></div>`; 
            document.getElementById('users-page').innerHTML = `<div class="page-header"><h2 >User Management</h2><p >Home > Users</p></div><div class="card"><div class="card-header"><h3 class="card-title">User List</h3><button id="add-user-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add User</button></div><div class="table-container"><table class="data-table"><thead><tr><th>Username</th><th>Full Name</th><th>Role</th><th>Assigned Consultant</th><th>Department</th><th>Last Login</th><th>Actions</th></tr></thead><tbody id="user-table-body"></tbody></table></div></div>`; 
            document.getElementById('user-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 id="user-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('user-modal')">&times;</button></div><form id="user-form"><input type="hidden" id="user-id-hidden"><div class="form-grid"><div class="form-group"><label for="username">Username*</label><input type="text" id="username" class="form-control" required></div><div class="form-group"><label for="fullName">Full Name*</label><input type="text" id="fullName" class="form-control" required></div></div><div class="form-group"><label for="password">Password*</label><input type="password" id="password" class="form-control" required></div><div class="form-group"><label for="department">Department</label><input type="text" id="department" class="form-control" placeholder="e.g., Collections"></div><div class="form-group"><label for="role">Role</label><select id="role" class="form-control"><option value="user">User</option><option value="admin">Admin</option></select></div><div class="form-group" id="assigned-consultant-group"><label for="assignedConsultant">Assigned Sales Consultant</label><select id="assignedConsultant" class="form-control"></select></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('user-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save User</button></div></form></div>`;
            document.getElementById('dashboard-page').innerHTML = `<div id="admin-dashboard-wrapper" class="hidden"><div class="d-flex justify-content-between align-items-center mb-4 flex-wrap"><h2 class="page-header" style="margin-bottom: 0;">Admin Dashboard</h2><button id="toggle-dashboard-view-btn" class="btn btn-outline"><i class="fas fa-chart-bar"></i> Switch to Chart View</button></div><div id="admin-dashboard-content"></div></div><div id="chart-dashboard-wrapper"><div id="attendance-controls" class="mb-4"></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-6);"><div class="card"><div class="card-title">Total Customers</div><div id="stat-total-customers" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card"><div class="card-title">Total Outstanding</div><div id="stat-outstanding-debt" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card"><div class="card-title">Recovered This Month</div><div id="stat-recovered-this-month" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card"><div class="card-title">Upcoming Visits</div><div id="stat-upcoming-visits" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div></div><div id="recovery-progress-card" class="card mb-4"></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);"><div class="card"><div class="card-header"><h3 class="card-title">Outstanding Debt by Emirate</h3></div><div class="chart-container"><canvas id="debt-chart"></canvas></div></div><div class="card"><div class="card-header"><h3 class="card-title">Monthly Payment Recovery</h3></div><div class="chart-container"><canvas id="payment-chart"></canvas></div></div><div class="card hidden" id="payment-trend-card" data-role="admin"><div class="card-header d-flex justify-content-between align-items-center flex-wrap"><h3 class="card-title">Payments Trend</h3><div class="d-flex align-items-center gap-4"><select id="payment-trend-year" class="form-control" style="width:auto;"></select><label class="d-flex align-items-center gap-2" style="font-size:var(--fs-sm); font-weight:500; cursor:pointer;"><input type="checkbox" id="payment-trend-yoy" checked> YoY</label></div></div><div class="chart-container" style="height:400px;"><canvas id="payment-trend-chart"></canvas></div></div></div></div>`; 
            document.getElementById('visits-page').innerHTML = `<div class="kpi-card-grid"><div class="kpi-card"><div class="title">Upcoming Visits</div><div id="visit-kpi-upcoming" class="value">0</div></div><div class="kpi-card"><div class="title">Overdue Visits</div><div id="visit-kpi-overdue" class="value">0</div></div><div class="kpi-card"><div class="title">Completed Today</div><div id="visit-kpi-completed-today" class="value">0</div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><div class="d-flex gap-2"><button class="btn btn-outline visit-view-tab active" data-view="list"><i class="fas fa-list"></i> List View</button><button class="btn btn-outline visit-view-tab" data-view="calendar"><i class="fas fa-calendar"></i> Calendar View</button></div><div class="d-flex gap-2"><div data-role="admin" class="d-flex gap-2"><button class="btn btn-outline" id="export-visits-csv"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" id="export-visits-pdf"><i class="fas fa-file-pdf"></i> PDF</button></div><button class="btn btn-primary" id="schedule-visit-btn"><i class="fas fa-plus"></i> Schedule a Visit</button></div></div><div id="list-view-content" class="visit-view-content"><div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-4"><div class="d-flex gap-2 flex-wrap"><button class="btn filter-btn visit-filter-btn active" data-filter="Upcoming">Upcoming</button><button class="btn filter-btn visit-filter-btn" data-filter="Today">Today</button><button class="btn filter-btn visit-filter-btn" data-filter="Overdue">Overdue</button><button class="btn filter-btn visit-filter-btn" data-filter="All">All Visits</button></div><div class="d-flex gap-2 align-items-center flex-wrap"><input type="date" id="visit-start-date" class="form-control" style="width:auto;"><span>to</span><input type="date" id="visit-end-date" class="form-control" style="width:auto;"><button class="btn btn-primary" id="visit-date-apply">Apply</button></div></div><div class="table-container"><table class="data-table"><thead></thead><tbody id="visit-table-body"></tbody></table></div></div><div id="calendar-view-content" class="visit-view-content hidden"><div id="calendar-view" style="min-height: 600px;"></div></div></div>`; 
            document.getElementById('payments-page').innerHTML = `<div class="kpi-card-grid"><div class="kpi-card"><div class="title">Recovered This Month</div><div id="payment-kpi-recovered-month" class="value">0</div></div><div class="kpi-card"><div class="title">Total Payments Recorded</div><div id="payment-kpi-total-count" class="value">0</div></div><div class="kpi-card"><div class="title">Pending Payments</div><div id="payment-kpi-pending" class="value">0</div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h3 class="card-title">Recent Payments</h3><div class="d-flex gap-2"><div data-role="admin" class="d-flex gap-2"><button class="btn btn-outline" id="export-payments-csv"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" id="export-payments-pdf"><i class="fas fa-file-pdf"></i> PDF</button></div><button class="btn btn-success" id="record-payment-btn"><i class="fas fa-plus"></i> Record Payment</button></div></div><div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Customer</th><th>Amount</th><th>Method</th><th>Status</th><th>Actions</th></tr></thead><tbody id="payment-table-body"></tbody></table></div></div>`; 
            document.getElementById('reports-page').innerHTML = `
                <div class="card mb-4"><div class="card-header"><h3 class="card-title">Key Performance Reports</h3></div>
                    <div class="report-grid">
                        <a href="#" class="report-card" id="generate-collection-report-btn">
                            <div class="icon"><i class="fas fa-chart-line"></i></div>
                            <h4>Collection Report</h4><p>Daily, weekly, and monthly collection summaries</p>
                        </a>
                        <a href="#" class="report-card" id="generate-aging-report-btn">
                            <div class="icon"><i class="fas fa-hourglass-half"></i></div>
                            <h4>Customer Aging Report</h4><p>Outstanding balance aging analysis</p>
                        </a>
                        <a href="#" class="report-card" id="generate-collector-perf-btn">
                            <div class="icon"><i class="fas fa-user-check"></i></div>
                            <h4>Collector Performance</h4><p>Individual collector performance metrics</p>
                        </a>
                        <a href="#" class="report-card" id="generate-risk-analysis-btn">
                            <div class="icon"><i class="fas fa-shield-alt"></i></div>
                            <h4>Risk Analysis Report</h4><p>Customer risk score distribution</p>
                        </a>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);"><div><div class="card mb-4" data-role="admin"><div class="card-header"><h3 class="card-title">Consultant Daily Activity</h3></div><div class="d-flex gap-4 flex-wrap align-items-center"><div class="d-flex gap-2 align-items-center"><select id="report-consultant-select" class="form-control" style="width:auto;"></select><input type="date" id="report-activity-start-date" class="form-control" style="width:auto;"> <span class="mx-2">to</span> <input type="date" id="report-activity-end-date" class="form-control" style="width:auto;"><button id="generate-activity-report-btn" class="btn btn-primary"><i class="fas fa-cogs"></i> Generate</button></div><div class="d-flex gap-2"><button id="activity-report-summary-btn" class="btn btn-outline filter-btn active"><i class="fas fa-chart-pie"></i> Summary</button><button id="activity-report-table-btn" class="btn btn-outline filter-btn"><i class="fas fa-table"></i> Table</button></div></div></div><div class="card mb-4"><div class="card-header"><h3 class="card-title">Standard Reports</h3></div><div class="d-flex gap-2 flex-wrap"><button id="generate-customer-report-btn" class="btn btn-primary"><i class="fas fa-users"></i> Customer Report</button><button id="generate-consultant-report-btn" class="btn btn-primary"><i class="fas fa-user-tie"></i> Consultant Report</button><button id="generate-overdue-report-btn" class="btn btn-warning"><i class="fas fa-exclamation-triangle"></i> Overdue Accounts</button><button id="generate-recovery-report-btn" class="btn btn-success"><i class="fas fa-chart-line"></i> Recovery Performance</button></div></div></div><div><div class="card mb-4"><div class="card-header"><h3 class="card-title">Customer Statement of Account</h3></div><div class="form-group"><label for="statement-customer-select">Select Customer</label><select id="statement-customer-select" class="form-control"></select></div><button id="generate-statement-btn" class="btn btn-primary"><i class="fas fa-file-invoice-dollar"></i> Generate Statement</button></div><div class="card"><div class="card-header"><h3 class="card-title">Visit Outcome Analysis</h3></div><p class="text-secondary" style="margin-bottom: var(--spacing-4);">Analyzes the results of all completed visits.</p><button id="generate-outcome-analysis-btn" class="btn btn-primary"><i class="fas fa-poll"></i> Generate Analysis</button></div></div></div><div id="report-output" class="mt-4"></div>`; 
            document.getElementById('consultants-page').innerHTML = `<div class="page-header"><h2 >Sales Consultant Management</h2><p >Home > Consultants</p></div><div class="card"><div class="card-header"><h3 class="card-title">Consultant List</h3><button id="add-consultant-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Consultant</button></div><div class="table-container"><table class="data-table"><thead><tr><th>Consultant Name</th><th>No. of Customers</th><th>Total Outstanding</th><th>Overdue Customers</th><th>Upcoming Visits</th><th>Actions</th></tr></thead><tbody id="consultant-table-body"></tbody></table></div></div>`; 
            document.getElementById('auditlog-page').innerHTML = `<div class="page-header"><h2>Audit Log</h2><p>Tracks critical administrative actions.</p></div><div class="card"><div class="card-header"><h3 class="card-title">Log Entries</h3><input type="search" id="audit-log-search" placeholder="Search log..." class="form-control" style="width: auto;"></div><div class="table-container"><table class="data-table"><thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Reason</th></tr></thead><tbody id="audit-log-table-body"></tbody></table></div></div>`; 
            document.getElementById('customer-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="customer-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-modal')">&times;</button></div><form id="customer-form"><input type="hidden" id="customer-id-hidden"><div class="form-grid"><div class="form-group"><label for="accountNo">Account Number*</label><input type="text" id="accountNo" class="form-control"></div><div class="form-group"><label for="companyName">Company Name*</label><input type="text" id="companyName" class="form-control" required></div><div class="form-group"><label for="emirate">Emirate*</label><select id="emirate" class="form-control" required><option>Dubai</option><option>Abu Dhabi</option><option>Sharjah</option><option>Ajman</option></select></div><div class="form-group"><label for="area">Area*</label><input type="text" id="area" class="form-control" required></div><div class="form-group"><label for="status">Status</label><select id="status" class="form-control"><option>Active</option><option>Inactive</option></select></div><div class="form-group"><label for="paymentStatus">Payment Status</label><select id="paymentStatus" class="form-control"><option>Pending</option><option>Paid</option><option>Cleared</option><option>Overdue</option></select></div><div class="form-group"><label for="initialDebt">Initial Debt (AED)*</label><input type="number" id="initialDebt" class="form-control" required></div><div class="form-group"><label for="outstanding">Current Outstanding (AED)*</label><input type="number" id="outstanding" class="form-control" required></div><div class="form-group full-width"><label for="salesConsultant">Sales Consultant*</label><select id="salesConsultant" class="form-control" required></select></div></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('customer-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save Customer</button></div></form></div>`; 
            document.getElementById('payment-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3>Record a Payment</h3><button class="btn btn-outline" onclick="App.UI.closeModal('payment-modal')">&times;</button></div><form id="payment-form"><div class="form-group"><label for="payment-customer-id">Customer*</label><select id="payment-customer-id" class="form-control" required></select></div><div class="form-group"><label for="payment-amount">Amount*</label><input type="number" id="payment-amount" class="form-control" required></div><div class="form-group"><label for="payment-method">Payment Method*</label><select id="payment-method" class="form-control" required><option>Bank Transfer</option><option>Cheque</option><option>Cash</option></select></div><div class="form-group"><label for="payment-date">Date*</label><input type="date" id="payment-date" class="form-control" required></div><div class="form-group"><label for="payment-status">Status</label><select id="payment-status" class="form-control"><option>Completed</option><option>Pending</option><option>Failed</option></select></div><button type="submit" class="btn btn-primary">Record Payment</button></form></div>`; 
            document.getElementById('visit-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3>Schedule Visit</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-modal')">&times;</button></div><form id="visit-form"><input type="hidden" id="visit-id"><div class="form-group"><label for="visit-customer-id">Customer*</label><select id="visit-customer-id" class="form-control" required></select></div><div class="form-group"><label for="visit-purpose">Purpose*</label><input type="text" id="visit-purpose" class="form-control" required></div><div class="form-group"><label for="visit-date">Date*</label><input type="date" id="visit-date" class="form-control" required></div><button type="submit" class="btn btn-primary">Save Visit</button></form></div>`; 
            document.getElementById('import-csv-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 class="card-title">Upload CSV File</h3><button class="btn btn-outline" onclick="App.UI.closeModal('import-csv-modal')">&times;</button></div><div class="file-upload-wrapper" id="csv-drop-zone"><i class="fas fa-upload" style="font-size: 1.5rem; color: var(--text-secondary);"></i><p>Click to browse or drag & drop file here</p><span id="csv-filename" style="font-weight: 600; color: var(--primary);"></span><input type="file" id="csv-file-input" class="hidden" accept=".csv"></div><div class="info-box"><p>Ensure headers match:</p><code>accountNumber,companyName,emirate,area,status,paymentStatus,initialDebt,outstandingAmount,salesConsultant</code></div><a href="#" id="download-sample-csv-link"><i class="fas fa-download"></i> Download Sample Template</a><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('import-csv-modal')">Close</button></div></div>`; 
            document.getElementById('customer-detail-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="customer-detail-title" class="card-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-detail-modal')">&times;</button></div><div class="d-flex gap-2 mb-4"><button class="detail-tab-btn active" data-tab="overview"><i class="fas fa-info-circle"></i> Overview</button><button class="detail-tab-btn" data-tab="visit-notes"><i class="fas fa-pen-alt"></i> Visit Notes</button></div><div id="customer-detail-content"><div class="tab-content active" id="overview-content"></div><div class="tab-content hidden" id="visit-notes-content"></div></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('customer-detail-modal')">Close</button></div></div>`; 
            document.getElementById('visit-notes-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 class="card-title">Mark Visit as Done</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-notes-modal')">&times;</button></div><form id="visit-notes-form"><input type="hidden" id="mark-done-visit-id"><input type="hidden" id="log-location-hidden"><div class="form-grid"><div class="form-group"><label>CONTACT METHOD</label><select id="log-contact-method" class="form-control"><option>Site Visit</option><option>Phone Call</option><option>Email</option></select></div><div class="form-group"><label>OUTCOME</label><select id="log-outcome" class="form-control"><option>No Answer</option><option>Promise to Pay</option><option>Dispute</option><option>Paid in Full</option><option>Partial Payment</option></select></div></div><div class="form-group"><label>NOTES</label><div id="log-notes-editor" style="height:150px;"></div></div><div class="form-grid"><div class="form-group"><label>SCHEDULE NEXT VISIT (Optional)</label><input type="date" id="log-next-date" class="form-control"></div><div class="form-group"><label>LOCATION</label><button type="button" class="btn btn-outline" id="log-location-btn" style="width:100%;"><i class="fas fa-map-marker-alt"></i> <span id="log-location-text">Tag Current Location</span></button></div></div><div class="modal-footer" data-role="user"><button type="button" id="log-record-payment-btn" class="btn btn-success"><i class="fas fa-dollar-sign"></i> Record Payment</button><button type="submit" class="btn btn-primary">Save Notes</button></div></form></div>`; 
            document.getElementById('payment-detail-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="card-title">Payment Details</h3><button class="btn btn-outline" onclick="App.UI.closeModal('payment-detail-modal')">&times;</button></div><div id="payment-detail-content"></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('payment-detail-modal')">Close</button></div></div>`; 
            document.getElementById('consultant-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 id="consultant-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('consultant-modal')">&times;</button></div><form id="consultant-form"><input type="hidden" id="consultant-id-hidden"><div class="form-group"><label for="consultantName">Consultant Name*</label><input type="text" id="consultantName" class="form-control" required></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('consultant-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save Consultant</button></div></form></div>`; 
            document.getElementById('visit-detail-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="card-title">Visit Details</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-detail-modal')">&times;</button></div><div id="visit-detail-content"></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('visit-detail-modal')">Close</button></div></div>`;
            document.getElementById('consultant-customers-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="consultant-customers-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('consultant-customers-modal')">&times;</button></div><div id="consultant-customers-body" class="table-container"></div></div>`;
            document.getElementById('reassign-customers-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 id="reassign-customers-title">Reassign Customers</h3><button class="btn btn-outline" onclick="App.UI.closeModal('reassign-customers-modal')">&times;</button></div><form id="reassign-customers-form"><input type="hidden" id="from-consultant-hidden"><div class="form-group"><label>Customers assigned to <strong id="from-consultant-name"></strong></label><div id="reassign-customer-list" style="height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: var(--spacing-2); border-radius: 8px;"></div></div><div class="form-group"><label for="reassign-to-consultant">Reassign selected to</label><select id="reassign-to-consultant" class="form-control" required></select></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('reassign-customers-modal')">Cancel</button><button type="submit" class="btn btn-primary">Reassign</button></div></form></div>`;
        }, 
        setupEventListeners() { document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); const u = e.target.username.value, p = e.target.password.value; if (!App.Auth.login(u, p)) document.getElementById('login-error').classList.remove('hidden'); }); document.getElementById('logout-btn').addEventListener('click', () => App.Auth.logout()); document.getElementById('hamburger-menu').addEventListener('click', () => document.querySelector('.sidebar').classList.toggle('open')); document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo(link.dataset.page); })); App.Dashboard.setupEventListeners(); App.Customers.setupEventListeners(); App.Payments.setupEventListeners(); App.Reports.setupEventListeners(); App.Visits.setupEventListeners(); App.Consultants.setupEventListeners(); App.Users.setupEventListeners(); App.AuditLog.setupEventListeners(); document.body.addEventListener('click', (e) => { const s = document.querySelector('.sidebar'); if (s.classList.contains('open') && !s.contains(e.target) && !document.getElementById('hamburger-menu').contains(e.target)) { s.classList.remove('open'); } }); }, showApp() { document.getElementById('login-page').style.display = 'none'; document.getElementById('app').classList.remove('hidden'); document.getElementById('username-display').textContent = App.state.currentUser.fullName; App.Auth.checkRole(); if (App.state.currentUser.role === 'admin') { App.Notifications.render(); } this.navigateTo('dashboard'); }, showLogin() { document.getElementById('login-page').style.display = 'flex'; document.getElementById('app').classList.add('hidden'); }, navigateTo(pageId) { App.state.activePage = pageId; document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(`${pageId}-page`).classList.add('active'); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active'); const title = document.querySelector(`.nav-link[data-page="${pageId}"] .nav-text`).textContent; document.getElementById('page-title').textContent = title; const pageRenderers = { dashboard: App.Dashboard, customers: App.Customers, visits: App.Visits, payments: App.Payments, reports: App.Reports, consultants: App.Consultants, users: App.Users, auditlog: App.AuditLog }; if (pageRenderers[pageId]) { pageRenderers[pageId].render(); } }, 
        openModal(id) { 
            const modal = document.getElementById(id);
            if (!modal) return;
            const activeModals = document.querySelectorAll('.modal.active').length;
            modal.style.zIndex = 2000 + activeModals;
            modal.classList.add('active'); 
        }, 
        closeModal(id) { 
            const modal = document.getElementById(id);
            if (!modal) return;
            modal.classList.remove('active'); 
            modal.style.zIndex = '';
            if (id === 'visit-notes-modal') {
                App.state.paymentFlowOrigin = null; 
            }
            if (id === 'payment-modal' && App.state.paymentFlowOrigin) {
                App.Visits.updateVisitNotesUI();
            }
        }, 
        toast: (title, icon = 'success') => Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, icon, title, background: 'var(--card-bg)', color: 'var(--text-primary)' }), confirm: (title, text, cb) => Swal.fire({ title, text, icon: 'warning', showCancelButton: true, confirmButtonColor: 'var(--primary)', cancelButtonColor: 'var(--danger)', confirmButtonText: 'Yes, do it!', background: 'var(--card-bg)', color: 'var(--text-primary)' }).then(r => r.isConfirmed && cb()) });
    
    Object.assign(App.Dashboard, { charts: {}, setupEventListeners() { document.getElementById('dashboard-page').addEventListener('click', e => { if (e.target.id === 'start-day-btn') this.startDay(); if (e.target.id === 'end-day-btn') this.endDay(); if (e.target.closest('#toggle-dashboard-view-btn')) { App.state.adminDashboardView = App.state.adminDashboardView === 'overview' ? 'chart_view' : 'overview'; this.render(); } }); }, render() { const adminWrapper = document.getElementById('admin-dashboard-wrapper'); const chartWrapper = document.getElementById('chart-dashboard-wrapper'); const toggleBtn = document.getElementById('toggle-dashboard-view-btn'); if (App.state.currentUser.role === 'admin') { adminWrapper.classList.remove('hidden'); if (App.state.adminDashboardView === 'overview') { chartWrapper.classList.add('hidden'); toggleBtn.innerHTML = `<i class="fas fa-chart-bar"></i> Switch to Chart View`; this.renderAdminDashboard(); } else { chartWrapper.classList.remove('hidden'); document.getElementById('admin-dashboard-content').innerHTML = ''; document.getElementById('payment-trend-card').classList.remove('hidden'); toggleBtn.innerHTML = `<i class="fas fa-tachometer-alt"></i> Switch to Overview`; App.Reports.renderPaymentTrendChart(); this.renderUserDashboard(); } } else { adminWrapper.classList.add('hidden'); chartWrapper.classList.remove('hidden'); document.getElementById('payment-trend-card').classList.add('hidden'); this.renderUserDashboard(); } }, renderAdminDashboard() { const container = document.getElementById('admin-dashboard-content'); const customers = App.DB.get('customers'); const activityLog = App.DB.get('activityLog'); const consultants = App.DB.get('consultants'); const totalInitial = customers.reduce((s, c) => s + c.initialDebt, 0); const totalOutstanding = customers.reduce((s, c) => s + c.outstanding, 0); const totalRecovered = totalInitial - totalOutstanding; const companyRecoveryRate = totalInitial > 0 ? ((totalRecovered / totalInitial) * 100).toFixed(2) : 0; const leaderboard = consultants.map(consultant => { const assigned = customers.filter(c => c.salesConsultant === consultant.name); const cInitial = assigned.reduce((s, c) => s + c.initialDebt, 0); const cOutstanding = assigned.reduce((s, c) => s + c.outstanding, 0); const cRecovered = cInitial - cOutstanding; const cRate = cInitial > 0 ? ((cRecovered / cInitial) * 100) : 0; return { name: consultant.name, recovered: cRecovered, rate: cRate.toFixed(2) }; }).sort((a, b) => b.recovered - a.recovered); 
        const consultantProgressHTML = consultants.map(consultant => {
            const assignedCustomers = customers.filter(c => c.salesConsultant === consultant.name);
            const initialDebt = assignedCustomers.reduce((sum, c) => sum + c.initialDebt, 0);
            const outstandingDebt = assignedCustomers.reduce((sum, c) => sum + c.outstanding, 0);
            const collected = initialDebt - outstandingDebt;
            const percentage = initialDebt > 0 ? ((collected / initialDebt) * 100).toFixed(0) : 0;
            return `<div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span style="font-weight: 600;">${consultant.name}</span>
                            <span style="font-size: var(--fs-sm); color: var(--text-secondary);">${percentage}%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-bar-inner" style="width: ${percentage}%;"></div></div>
                        <div style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${App.Helpers.formatCurrency(collected)} of ${App.Helpers.formatCurrency(initialDebt)}</div>
                    </div>`;
        }).join('');
        const upcomingVisits = App.DB.get('visits').filter(v => new Date(v.dateTime) >= new Date() && v.status === 'Scheduled').sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime)).slice(0, 10);
        const customerMap = App.DB.get('customers').reduce((map, customer) => { map[customer.accountNo] = customer.companyName; return map; }, {});
        container.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-6);"><div class="card"><div class="card-title">Company Recovery Rate</div><div style="font-size: var(--fs-3xl); font-weight: 700; color:var(--success);">${companyRecoveryRate}%</div></div><div class="card"><div class="card-title">Total Recovered (All Time)</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalRecovered)}</div></div><div class="card"><div class="card-title">Total Outstanding</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalOutstanding)}</div></div><div class="card"><div class="card-title">Active Consultants</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${consultants.length}</div></div></div><div class="card mb-4"><div class="card-header"><h3 class="card-title">Consultant Recovery Progress</h3></div>${consultantProgressHTML}</div><div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-6);"><div class="card"><div class="card-header"><h3 class="card-title">Consultant Leaderboard (by Amount Recovered)</h3></div><div class="table-container"><table class="data-table"><thead><tr><th>#</th><th>Consultant</th><th>Amount Recovered</th><th>Recovery Rate</th></tr></thead><tbody>${leaderboard.map((c, i) => `<tr><td>${i + 1}</td><td>${c.name}</td><td>${App.Helpers.formatCurrency(c.recovered)}</td><td><span class="status-badge complete">${c.rate}%</span></td></tr>`).join('')}</tbody></table></div></div><div class="card"><div class="card-header"><h3 class="card-title">Recent Activities</h3></div><ul style="list-style:none; padding:0; max-height: 400px; overflow-y:auto;">${activityLog.sort((a,b) => b.timestamp - a.timestamp).slice(0, 10).map(log => `<li style="border-bottom: 1px solid var(--border-color); padding: var(--spacing-2) 0;"><div style="font-weight: 600;">${log.consultant}</div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${log.action}${log.details ? ': ' + log.details : ''}</div><div style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${log.time}</div></li>`).join('')}</ul></div></div><div class="card mt-4"><div class="card-header"><h3 class="card-title">Next 10 Upcoming Visits</h3></div><div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Company Name</th><th>Sales Consultant</th></tr></thead><tbody>${upcomingVisits.length > 0 ? upcomingVisits.map(v => `<tr><td>${App.Helpers.formatDate(v.dateTime)}</td><td>${customerMap[v.customerId] || 'N/A'}</td><td>${v.collector}</td></tr>`).join('') : '<tr><td colspan="3">No upcoming visits found.</td></tr>'}</tbody></table></div></div>`; }, renderUserDashboard() { const attendanceControls = document.getElementById('attendance-controls'); if (App.state.currentUser.role === 'user') { attendanceControls.classList.remove('hidden'); this.renderAttendanceControls(); } else { attendanceControls.classList.add('hidden'); } this.renderRecoveryProgress(); const c = App.Helpers.getScopedData('customers'), p = App.Helpers.getScopedData('payments'), v = App.Helpers.getScopedData('visits'); this.animateCounter('stat-total-customers', c.length); this.animateCounter('stat-outstanding-debt', c.reduce((s, i) => s + i.outstanding, 0), true); this.animateCounter('stat-recovered-this-month', p.filter(i => new Date(i.date).getMonth() === new Date().getMonth()).reduce((s, i) => s + i.amount, 0), true); this.animateCounter('stat-upcoming-visits', v.filter(i => new Date(i.dateTime) >= new Date() && i.status === 'Scheduled').length); this.renderCharts(); }, renderAttendanceControls() { const todayStr = new Date().toISOString().slice(0, 10); const consultantName = App.state.currentUser.assignedConsultant; const log = App.DB.get('activityLog'); const startEntry = log.find(entry => entry.consultant === consultantName && entry.date === todayStr && entry.action === 'Started Day'); const dayStarted = !!startEntry; const dayEnded = log.some(entry => entry.consultant === consultantName && entry.date === todayStr && entry.action === 'Ended Day'); let html = '<div class="card d-flex gap-4 justify-content-between align-items-center flex-wrap">'; if (dayStarted) { html += `<div><h3 class="card-title" style="margin:0; font-size:var(--fs-base)">Daily Attendance</h3><p style="color:var(--text-secondary); font-size:var(--fs-sm);" id="attendance-status">Day Started at: ${startEntry.time}</p></div>`; } else { html += `<div><h3 class="card-title" style="margin:0; font-size:var(--fs-base)">Daily Attendance</h3><p style="color:var(--text-secondary); font-size:var(--fs-sm);" id="attendance-status">Log your work day.</p></div>`; } html += `<div class="d-flex gap-4 align-items-center">`; html += `<span id="work-timer" style="font-weight:600; font-size:var(--fs-lg); color:var(--primary); min-width: 100px; text-align: right;"></span>`; html += `<button id="start-day-btn" class="btn btn-success" ${dayStarted ? 'disabled' : ''}><i class="fas fa-play"></i> Start Day</button>`; html += `<button id="end-day-btn" class="btn btn-danger" ${!dayStarted || dayEnded ? 'disabled' : ''}><i class="fas fa-stop"></i> End Day</button>`; html += `</div></div>`; document.getElementById('attendance-controls').innerHTML = html; if (dayStarted && !dayEnded) { this.startTimer(startEntry.timestamp); } }, startDay() { App.Helpers.logActivity('Started Day'); App.UI.toast('Day Started! Good luck.', 'success'); this.render(); }, endDay() { clearInterval(App.state.dayTimerInterval); App.Helpers.logActivity('Ended Day'); App.UI.toast('Day Ended! Well done.', 'info'); this.render(); }, startTimer(startTime) { clearInterval(App.state.dayTimerInterval); const timerElement = document.getElementById('work-timer'); if (!timerElement) return; const startTimestamp = startTime; App.state.dayTimerInterval = setInterval(() => { const now = new Date(); const diff = now.getTime() - startTimestamp; if (diff < 0) { timerElement.textContent = '00:00:00'; return; } const hours = Math.floor(diff / 3600000).toString().padStart(2, '0'); const minutes = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0'); const seconds = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0'); timerElement.textContent = `${hours}:${minutes}:${seconds}`; }, 1000); }, animateCounter(id, t, isC = false) { let e = document.getElementById(id); if (!e) return; let n = 0, i = Math.max(1, Math.ceil(t / 100)); const u = () => { n += i; if (n < t) { e.textContent = isC ? App.Helpers.formatCurrency(Math.ceil(n)) : Math.ceil(n); requestAnimationFrame(u) } else { e.textContent = isC ? App.Helpers.formatCurrency(t) : t } }; u() }, 
        renderCharts() { 
            const c = App.Helpers.getScopedData('customers'), p = App.Helpers.getScopedData('payments'), tc = '#212529', bc = '#dee2e6'; const dbe = c.reduce((a, i) => { a[i.emirate] = (a[i.emirate] || 0) + i.outstanding; return a }, {}); 
            const debtChartEl = document.getElementById('debt-chart'); if (!debtChartEl) return; 
            if (this.charts.debt) this.charts.debt.destroy(); 
            this.charts.debt = new Chart(debtChartEl, { 
                type: 'bar', 
                data: { labels: Object.keys(dbe), datasets: [{ label: 'Outstanding Debt', data: Object.values(dbe), backgroundColor: ['#e2000f', '#10b981', '#ffc107', '#6c757d'], borderWidth: 0 }] }, 
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } 
            }); 
            const mp = p.reduce((a, i) => { const m = new Date(i.date).toLocaleString('default', { month: 'short' }); a[m] = (a[m] || 0) + i.amount; return a }, {}); 
            const paymentChartEl = document.getElementById('payment-chart'); if (!paymentChartEl) return; 
            if (this.charts.payment) this.charts.payment.destroy(); 
            this.charts.payment = new Chart(paymentChartEl, { type: 'bar', data: { labels: Object.keys(mp), datasets: [{ label: 'Payments', data: Object.values(mp), backgroundColor: '#e2000f', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: tc }, grid: { color: bc } }, x: { ticks: { color: tc }, grid: { color: 'transparent' } } }, plugins: { legend: { labels: { color: tc } } } } }); 
        }, 
        renderRecoveryProgress() { const customers = App.Helpers.getScopedData('customers'); const totalInitialDebt = customers.reduce((sum, c) => sum + c.initialDebt, 0); const totalOutstanding = customers.reduce((sum, c) => sum + c.outstanding, 0); const totalCollected = totalInitialDebt - totalOutstanding; const percentage = totalInitialDebt > 0 ? ((totalCollected / totalInitialDebt) * 100).toFixed(0) : 0; const container = document.getElementById('recovery-progress-card'); container.innerHTML = `<div class="d-flex align-items-center gap-2 mb-4"><i class="fas fa-bullseye" style="color: var(--primary);"></i><h3 class="card-title" style="margin:0;">Recovery Progress</h3></div><div><div class="mb-2" style="font-weight: 600; text-transform: uppercase; font-size: var(--fs-sm); color: var(--text-secondary);">Total Debt vs Collected</div><div class="progress-bar mb-2"><div class="progress-bar-inner" style="width: ${percentage}%;"></div></div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${App.Helpers.formatCurrency(totalCollected)} collected of ${App.Helpers.formatCurrency(totalInitialDebt)} (${percentage}%)</div></div>`; } });
    
    Object.assign(App.Customers, { quill: null, setupEventListeners: function() { document.getElementById('add-customer-btn').addEventListener('click', () => this.showCustomerForm()); document.getElementById('import-customer-btn').addEventListener('click', () => { document.getElementById('csv-filename').textContent = ''; App.UI.openModal('import-csv-modal'); }); document.getElementById('export-customers-csv').addEventListener('click', () => this.exportData('csv')); document.getElementById('export-customers-pdf').addEventListener('click', () => this.exportData('pdf')); document.getElementById('customer-form').addEventListener('submit', (e) => this.saveCustomer(e)); document.querySelector('#customers-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) this.sortCustomers(th.dataset.sort); }); const debouncedSearch = App.Helpers.debounce(() => this.render(), 300); document.getElementById('customer-search').addEventListener('input', debouncedSearch); document.getElementById('customer-status-filter').addEventListener('change', () => this.render()); document.getElementById('customer-payment-filter').addEventListener('change', () => this.render()); document.getElementById('customer-table-body').addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; const id = button.dataset.id; if (button.classList.contains('view-customer')) this.showCustomerDetail(id); else if (button.classList.contains('edit-customer')) this.showCustomerForm(id); else if (button.classList.contains('delete-customer')) this.deleteCustomer(id); }); document.getElementById('customer-detail-modal').addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; if (button.classList.contains('detail-tab-btn')) this.switchDetailTab(button.dataset.tab); else if (button.id === 'save-visit-notes-btn') this.saveVisitNoteFromDetail(); }); }, 
    getCurrentFilteredData: function() {
        const { value: search } = document.getElementById('customer-search'); 
        const { value: statusFilter } = document.getElementById('customer-status-filter'); 
        const { value: paymentFilter } = document.getElementById('customer-payment-filter'); 
        let customers = App.Helpers.getScopedData('customers').filter(c => 
            (c.companyName.toLowerCase().includes(search.toLowerCase()) || c.accountNo.toLowerCase().includes(search.toLowerCase()) || c.salesConsultant.toLowerCase().includes(search.toLowerCase())) && 
            (statusFilter === 'all' || c.status === statusFilter) && 
            (paymentFilter === 'all' || c.paymentStatus === paymentFilter)
        );
        const { column, order } = App.state.customerSort; 
        customers.sort((a, b) => { if (a[column] < b[column]) return order === 'asc' ? -1 : 1; if (a[column] > b[column]) return order === 'asc' ? 1 : -1; return 0; });
        return customers;
    },
    exportData: function(format) {
        const customers = this.getCurrentFilteredData();
        const headers = ['Account #', 'Company Name', 'Outstanding', 'Consultant', 'Payment Status', 'Status'];
        const data = customers.map(c => [c.accountNo, c.companyName, c.outstanding, c.salesConsultant, c.paymentStatus, c.status]);
        const filename = `Customers_Report_${new Date().toLocaleDateString()}`;
        if (format === 'csv') {
            App.Helpers.exportToCSV(filename + '.csv', headers, data);
        } else {
            App.Helpers.exportToPDF(filename + '.pdf', 'Customer List', headers, data);
        }
    },
    render: function() { 
        // Render KPI Cards
        const customers = App.DB.get('customers');
        App.Dashboard.animateCounter('customer-kpi-total', customers.length);
        App.Dashboard.animateCounter('customer-kpi-outstanding', customers.reduce((sum, c) => sum + c.outstanding, 0), true);
        App.Dashboard.animateCounter('customer-kpi-active', customers.filter(c => c.status === 'Active').length);

        const filteredCustomers = this.getCurrentFilteredData();
        const tbody = document.getElementById('customer-table-body'); tbody.innerHTML = filteredCustomers.length ? filteredCustomers.map(c => `<tr><td>${c.accountNo}</td><td><div class="company-info"><div class="name">${c.companyName}</div><div class="location" style="color: var(--text-secondary); font-size: var(--fs-sm);">${c.emirate}</div></div></td><td>${App.Helpers.formatCurrency(c.outstanding)}</td><td>${c.salesConsultant}</td><td><span class="status-badge ${c.paymentStatus.toLowerCase()}">${c.paymentStatus}</span></td><td class="d-flex gap-2"><button class="btn btn-outline view-customer" data-id="${c.accountNo}" title="View"><i class="fas fa-eye"></i></button>${App.state.currentUser.role === 'admin' ? `<button class="btn btn-outline edit-customer" data-id="${c.accountNo}" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-customer" data-id="${c.accountNo}" title="Delete"><i class="fas fa-trash"></i></button>` : ''}</td></tr>`).join('') : '<tr><td colspan="6">No customers found.</td></tr>'; }, showCustomerForm: function(accountNo = null) { const form = document.getElementById('customer-form'); const accountNoInput = form.elements.accountNo; form.reset(); const consultantSelect = form.elements['salesConsultant']; consultantSelect.innerHTML = App.DB.get('consultants').map(c => `<option value="${c.name}">${c.name}</option>`).join(''); if (accountNo) { const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); document.getElementById('customer-modal-title').textContent = 'Edit Customer'; document.getElementById('customer-id-hidden').value = customer.accountNo; Object.keys(customer).forEach(key => { if (form.elements[key]) form.elements[key].value = customer[key]; }); accountNoInput.readOnly = true; accountNoInput.required = false; } else { document.getElementById('customer-modal-title').textContent = 'Add New Customer'; document.getElementById('customer-id-hidden').value = ''; accountNoInput.readOnly = false; accountNoInput.required = true; accountNoInput.placeholder = 'e.g., DXB-007'; } App.UI.openModal('customer-modal'); }, saveCustomer: function(e) { e.preventDefault(); const form = e.target; const id = form.elements['customer-id-hidden'].value; let customers = App.DB.get('customers'); const customerData = { companyName: form.elements.companyName.value, emirate: form.elements.emirate.value, area: form.elements.area.value, initialDebt: parseFloat(form.elements.initialDebt.value), outstanding: parseFloat(form.elements.outstanding.value), salesConsultant: form.elements.salesConsultant.value, status: form.elements.status.value, paymentStatus: form.elements.paymentStatus.value }; if (id) { const index = customers.findIndex(c => c.accountNo === id); customers[index] = { ...customers[index], ...customerData }; } else { const newAccountNo = form.elements.accountNo.value.trim(); if (!newAccountNo) { App.UI.toast('Account Number is required.', 'error'); return; } const accountExists = customers.some(c => c.accountNo.toLowerCase() === newAccountNo.toLowerCase()); if (accountExists) { App.UI.toast('Account Number already exists.', 'error'); return; } customerData.accountNo = newAccountNo; customers.push(customerData); App.Helpers.logActivity('added a new customer', `${customerData.companyName}`); } App.DB.set('customers', customers); App.UI.closeModal('customer-modal'); App.UI.toast(`Customer ${id ? 'updated' : 'added'}!`); this.render(); }, sortCustomers: function(column) { const { customerSort } = App.state; if (customerSort.column === column) customerSort.order = customerSort.order === 'asc' ? 'desc' : 'asc'; else { customerSort.column = column; customerSort.order = 'asc'; } this.render(); }, showCustomerDetail: function(accountNo) { App.state.activeCustomerId = accountNo; const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); if (!customer) return; document.getElementById('customer-detail-title').innerHTML = `Customer: ${customer.companyName} <span style="color:var(--text-secondary); font-weight:500;">(${customer.accountNo})</span>`; this.renderDetailOverview(customer); this.renderDetailVisitNotes(customer); this.switchDetailTab('overview'); App.UI.openModal('customer-detail-modal'); }, renderDetailOverview: function(customer) { const payments = App.DB.get('payments').filter(p => p.customerId === customer.accountNo); const visits = App.DB.get('visits').filter(v => v.customerId === customer.accountNo).sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)); document.getElementById('overview-content').innerHTML = `<div class="detail-info-grid"><div class="detail-info-card"><div class="label">Account #</div><div class="value">${customer.accountNo}</div></div><div class="detail-info-card"><div class="label">Location</div><div class="value">${customer.area}, ${customer.emirate}</div></div><div class="detail-info-card"><div class="label">Account Status</div><div class="value"><span class="status-badge ${customer.status.toLowerCase()}">${customer.status}</span></div></div><div class="detail-info-card"><div class="label">Payment Status</div><div class="value"><span class="status-badge ${customer.paymentStatus.toLowerCase()}">${customer.paymentStatus}</span></div></div><div class="detail-info-card"><div class="label">Outstanding</div><div class="value">${App.Helpers.formatCurrency(customer.outstanding)}</div></div><div class="detail-info-card"><div class="label">Sales Consultant</div><div class="value">${customer.salesConsultant}</div></div></div><h4 class="card-title mb-4">Payment History</h4>${payments.length > 0 ? `<div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Amount</th><th>Method</th><th>Status</th></tr></thead><tbody>${payments.map(p => `<tr><td>${App.Helpers.formatDate(p.date)}</td><td>${App.Helpers.formatCurrency(p.amount)}</td><td>${p.method}</td><td><span class="status-badge ${p.status.toLowerCase()}">${p.status}</span></td></tr>`).join('')}</tbody></table></div>` : '<p>No payments recorded.</p>'}<h4 class="card-title mt-4 mb-4">Visit Notes History</h4>${visits.length > 0 ? visits.map(v => `<div class="card mb-4" style="background:var(--bg-color);"><p><strong>${App.Helpers.formatDate(v.dateTime)}: ${v.contactMethod || v.purpose} ${v.outcome ? `(${v.outcome})` : ''}</strong></p>${v.notes || ''}</div>`).join('') : '<p>No visit notes recorded.</p>'}`; }, renderDetailVisitNotes: function(customer) { document.getElementById('visit-notes-content').innerHTML = `<div class="form-grid"><div class="form-group"><label>CONTACT METHOD</label><select id="visit-contact-method" class="form-control"><option>Site Visit</option><option>Phone Call</option><option>Email</option></select></div><div class="form-group"><label>OUTCOME</label><select id="visit-outcome" class="form-control"><option>No Answer</option><option>Promise to Pay</option><option>Dispute</option><option>Paid in Full</option><option>Partial Payment</option></select></div></div><div class="form-group"><label>NOTES</label><div id="quill-editor" style="height:150px;"></div></div><div class="form-grid"><div class="form-group"><label>SCHEDULE NEXT VISIT (Optional)</label><input type="date" id="visit-next-date" class="form-control"></div><div class="form-group"><label>LOCATION</label><button type="button" class="btn btn-outline" id="tag-location-btn" style="width:100%;"><i class="fas fa-map-marker-alt"></i> <span id="location-tag-text">Tag Current Location</span></button></div></div><div class="d-flex" style="justify-content:flex-end;"><button type="button" class="btn btn-primary" id="save-visit-notes-btn">Save Notes</button></div>`; if (this.quill) { this.quill = null; } this.quill = new Quill('#quill-editor', { theme: 'snow', placeholder: 'Enter contact notes...' }); }, switchDetailTab: function(tabId) { document.querySelectorAll('.detail-tab-btn').forEach(btn => btn.classList.remove('active')); document.querySelector(`.detail-tab-btn[data-tab="${tabId}"]`)?.classList.add('active'); document.querySelectorAll('#customer-detail-content .tab-content').forEach(c => c.classList.add('hidden')); document.getElementById(`${tabId}-content`).classList.remove('hidden'); }, saveVisitNoteFromDetail: function() { const customerId = App.state.activeCustomerId; const contactMethod = document.getElementById('visit-contact-method').value; const outcome = document.getElementById('visit-outcome').value; const notes = this.quill.root.innerHTML; const nextVisitDate = document.getElementById('visit-next-date').value; let visits = App.DB.get('visits'); const customer = App.DB.get('customers').find(c => c.accountNo === customerId); const newNote = { id: `v${Date.now()}`, customerId, dateTime: new Date().toISOString(), purpose: `Follow-up: ${outcome}`, collector: customer.salesConsultant, status: "Completed", contactMethod, outcome, notes, }; visits.push(newNote); if (nextVisitDate) { visits.push({ id: `v${Date.now() + 1}`, customerId, dateTime: `${nextVisitDate}`, purpose: 'Scheduled Follow-up', collector: newNote.collector, status: "Scheduled" }); } App.DB.set('visits', visits); App.UI.toast('Visit note saved!'); App.UI.closeModal('customer-detail-modal'); }, deleteCustomer(accountNo) { const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); Swal.fire({ title: `Delete ${customer.companyName}?`, text: "This will permanently delete the customer and all their associated payments and visits. This action cannot be undone.", input: 'textarea', inputLabel: 'Reason for deletion', inputPlaceholder: 'Enter your reason here...', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: 'var(--danger)', background: 'var(--card-bg)', color: 'var(--text-primary)', inputValidator: (value) => { if (!value) { return 'You must provide a reason for deletion!' } } }).then(result => { if (result.isConfirmed && result.value) { let customers = App.DB.get('customers'); let visits = App.DB.get('visits'); let payments = App.DB.get('payments'); App.DB.set('customers', customers.filter(c => c.accountNo !== accountNo)); App.DB.set('visits', visits.filter(v => v.customerId !== accountNo)); App.DB.set('payments', payments.filter(p => p.customerId !== accountNo)); App.Helpers.logAdminActivity(`Deleted Customer: ${customer.companyName} (${accountNo})`, result.value); App.UI.toast('Customer deleted permanently.', 'success'); this.render(); } }); } });
    Object.assign(App.Visits, { calendar: null, logNotesQuill: null, setupEventListeners: function() { document.getElementById('visit-notes-form').addEventListener('submit', e => this.saveCompletedVisit(e)); document.getElementById('visit-form').addEventListener('submit', (e) => this.saveScheduledVisit(e)); document.getElementById('export-visits-csv').addEventListener('click', () => this.exportData('csv')); document.getElementById('export-visits-pdf').addEventListener('click', () => this.exportData('pdf')); const page = document.getElementById('visits-page'); page.addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; if (button.classList.contains('visit-view-tab')) this.switchView(button.dataset.view); if (button.classList.contains('visit-filter-btn')) this.setFilter(button.dataset.filter); if (button.id === 'visit-date-apply') this.applyDateFilter(); if (button.classList.contains('mark-done-btn')) this.showMarkDoneModal(button.dataset.id); if (button.classList.contains('view-visit-btn')) this.showVisitDetail(button.dataset.id); if (button.id === 'schedule-visit-btn') this.showScheduleModal(); if (button.classList.contains('delete-visit')) this.deleteVisit(button.dataset.id); }); 
        document.getElementById('visit-notes-modal').addEventListener('click', e => { 
            const button = e.target.closest('button');
            if (!button) return;
            if (button.id === 'log-location-btn') this.tagLocationForVisitLog(); 
            if (button.id === 'log-record-payment-btn') {
                const visitId = document.getElementById('mark-done-visit-id').value;
                const visit = App.DB.get('visits').find(v => v.id === visitId);
                if (visit) {
                    App.state.paymentFlowOrigin = { visitId: visit.id, paymentLogged: false };
                    App.Payments.showPaymentForm(visit.customerId);
                }
            }
        }); 
    }, 
    getCurrentFilteredData: function() {
        let visits = App.Helpers.getScopedData('visits'); 
        const { filter, startDate, endDate } = App.state.visits; 
        const today = new Date().setHours(0, 0, 0, 0); 
        if (filter !== 'All' && !(startDate && endDate)) { visits = visits.filter(v => { const visitDate = new Date(v.dateTime).setHours(0, 0, 0, 0); if (filter === 'Overdue') return (v.status === 'Scheduled' || v.status === 'Overdue') && visitDate < today; if (filter === 'Today') return visitDate === today; if (filter === 'Upcoming') return v.status === 'Scheduled' && visitDate >= today; return false; }); } 
        if (startDate && endDate) { visits = visits.filter(v => { const visitDateOnly = new Date(v.dateTime).toISOString().slice(0, 10); return visitDateOnly >= startDate && visitDateOnly <= endDate; }); }
        return visits.sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));
    },
    exportData: function(format) {
        const visits = this.getCurrentFilteredData();
        const customers = App.DB.get('customers');
        const isAdmin = App.state.currentUser.role === 'admin';
        const headers = ['Date', 'Customer', 'Purpose', ...(isAdmin ? ['Consultant'] : []), 'Status'];
        const data = visits.map(v => {
            const row = [
                App.Helpers.formatDate(v.dateTime),
                customers.find(c => c.accountNo === v.customerId)?.companyName || 'N/A',
                v.purpose,
            ];
            if(isAdmin) row.push(v.collector || 'N/A');
            row.push(v.status);
            return row;
        });
        const filename = `Visits_Report_${new Date().toLocaleDateString()}`;
        if (format === 'csv') {
            App.Helpers.exportToCSV(filename + '.csv', headers, data);
        } else {
            App.Helpers.exportToPDF(filename + '.pdf', 'Visits List', headers, data);
        }
    },
    render: function() { 
        this.checkOverdueVisits();
        
        // Render KPI cards
        const allVisits = App.DB.get('visits');
        const todayStr = new Date().toISOString().slice(0,10);
        App.Dashboard.animateCounter('visit-kpi-upcoming', allVisits.filter(v => v.status === 'Scheduled' && new Date(v.dateTime) >= new Date()).length);
        App.Dashboard.animateCounter('visit-kpi-overdue', allVisits.filter(v => v.status === 'Overdue').length);
        App.Dashboard.animateCounter('visit-kpi-completed-today', allVisits.filter(v => v.status === 'Completed' && v.dateTime.startsWith(todayStr)).length);

        if (App.state.visits.activeView === 'calendar') this.renderCalendarView(); else this.renderListView(); 
    }, 
    switchView: function(view) { App.state.visits.activeView = view; document.querySelectorAll('.visit-view-tab').forEach(t => t.classList.remove('active')); document.querySelector(`.visit-view-tab[data-view="${view}"]`).classList.add('active'); document.querySelectorAll('.visit-view-content').forEach(c => c.classList.add('hidden')); document.getElementById(`${view}-view-content`).classList.remove('hidden'); this.render(); }, setFilter: function(filter) { App.state.visits.filter = filter; document.getElementById('visit-start-date').value = ''; document.getElementById('visit-end-date').value = ''; App.state.visits.startDate = ''; App.state.visits.endDate = ''; document.querySelectorAll('.visit-filter-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.visit-filter-btn[data-filter="${filter}"]`).classList.add('active'); this.renderListView(); }, applyDateFilter: function() { const startDate = document.getElementById('visit-start-date').value; const endDate = document.getElementById('visit-end-date').value; if (!startDate || !endDate) { App.UI.toast('Please select both a start and end date.', 'warning'); return; } App.state.visits.startDate = startDate; App.state.visits.endDate = endDate; App.state.visits.filter = 'Custom'; document.querySelectorAll('.visit-filter-btn').forEach(b => b.classList.remove('active')); this.renderListView(); }, 
        renderListView: function() { 
            const visits = this.getCurrentFilteredData();
            const isAdmin = App.state.currentUser.role === 'admin';
            let headers = ['Date', 'Customer', 'Purpose'];
            if (isAdmin) {
                headers.push('Consultant');
            }
            headers.push('Status', 'Actions');
            const thead = document.querySelector('#visits-page .data-table thead');
            thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            const customers = App.DB.get('customers'); 
            const tbody = document.getElementById('visit-table-body'); 
            tbody.innerHTML = visits.length ? visits.map(v => { 
                const consultantCell = isAdmin ? `<td>${v.collector || 'N/A'}</td>` : '';
                
                const actions = [];
                const isPending = v.status === 'Scheduled' || v.status === 'Overdue';
                
                if (isPending) {
                    if (isAdmin) {
                        actions.push(`<button class="btn btn-outline view-visit-btn" data-id="${v.id}" title="View Details"><i class="fas fa-eye"></i></button>`);
                    } else {
                        actions.push(`<button class="btn btn-success mark-done-btn" data-id="${v.id}" title="Mark as Done"><i class="fas fa-check"></i></button>`);
                    }
                } else if (v.status === 'Completed') {
                    actions.push(`<button class="btn btn-outline view-visit-btn" data-id="${v.id}" title="View Details"><i class="fas fa-eye"></i></button>`);
                }

                if (isAdmin) {
                    actions.push(`<button class="btn btn-danger delete-visit" data-id="${v.id}" title="Delete"><i class="fas fa-trash"></i></button>`);
                }
                
                return `<tr><td>${App.Helpers.formatDate(v.dateTime)}</td><td>${customers.find(c => c.accountNo === v.customerId)?.companyName || 'N/A'}</td><td>${v.purpose}</td>${consultantCell}<td><span class="status-badge ${v.status.toLowerCase()}">${v.status}</span></td><td><div class="d-flex gap-2">${actions.join('')}</div></td></tr>`; 
            }).join('') : `<tr><td colspan="${headers.length}">No visits found.</td></tr>`; 
        }, 
        renderCalendarView: function() { const el = document.getElementById('calendar-view'); if (this.calendar) this.calendar.destroy(); const v = App.Helpers.getScopedData('visits'), c = App.DB.get('customers'); const ev = v.map(i => ({ id: i.id, title: `${c.find(cu => cu.accountNo === i.customerId)?.companyName || 'N/A'} - ${i.purpose}`, start: i.dateTime, backgroundColor: i.status === 'Completed' ? 'var(--success)' : i.status === 'Overdue' ? 'var(--danger)' : 'var(--primary)' })); this.calendar = new FullCalendar.Calendar(el, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, events: ev, editable: true, dateClick: (info) => this.showScheduleModal(null, info.dateStr), eventClick: (info) => this.showScheduleModal(info.event.id) }); this.calendar.render(); }, showScheduleModal: function(id = null, d = null) { const f = document.getElementById('visit-form'); f.reset(); f.elements['visit-id'].value = ''; document.getElementById('visit-customer-id').innerHTML = App.Helpers.getScopedData('customers').map(c => `<option value="${c.accountNo}">${c.companyName}</option>`).join(''); if (id) { const visit = App.DB.get('visits').find(v => v.id === id); if (visit) { f.elements['visit-id'].value = visit.id; f.elements['visit-customer-id'].value = visit.customerId; f.elements['visit-purpose'].value = visit.purpose; f.elements['visit-date'].value = visit.dateTime.slice(0, 10); } } else if (d) f.elements['visit-date'].value = d; App.UI.openModal('visit-modal'); }, saveScheduledVisit: function(e) { e.preventDefault(); const f = e.target; const customer = App.DB.get('customers').find(c => c.accountNo === f.elements['visit-customer-id'].value); const vd = { customerId: f.elements['visit-customer-id'].value, purpose: f.elements['visit-purpose'].value, dateTime: f.elements['visit-date'].value, status: 'Scheduled', collector: customer ? customer.salesConsultant : 'N/A' }; let v = App.DB.get('visits'), id = f.elements['visit-id'].value; if (id) { const i = v.findIndex(vi => vi.id === id); v[i] = { ...v[i], ...vd, id: id }; } else { vd.id = `visit-${Date.now()}`; v.push(vd); } App.DB.set('visits', v); App.UI.closeModal('visit-modal'); App.UI.toast('Visit saved!'); this.render(); }, 
        showMarkDoneModal: function(visitId) { 
            document.getElementById('visit-notes-form').reset(); 
            document.getElementById('mark-done-visit-id').value = visitId; 
            document.getElementById('log-location-text').textContent = 'Tag Current Location'; 
            document.getElementById('log-location-hidden').value = ''; 
            if (!this.logNotesQuill) this.logNotesQuill = new Quill('#log-notes-editor', { theme: 'snow', placeholder: 'Enter contact notes...' }); 
            this.logNotesQuill.root.innerHTML = ''; 
            App.state.paymentFlowOrigin = null; 
            this.updateVisitNotesUI();
            App.UI.openModal('visit-notes-modal'); 
        }, 
        updateVisitNotesUI: function() {
            const button = document.getElementById('log-record-payment-btn');
            if (!button) return;

            if (App.state.paymentFlowOrigin && App.state.paymentFlowOrigin.paymentLogged) {
                button.innerHTML = `<i class="fas fa-check-circle"></i> Payment Logged`;
                button.disabled = true;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline');
            } else {
                button.innerHTML = `<i class="fas fa-dollar-sign"></i> Record Payment`;
                button.disabled = false;
                button.classList.add('btn-success');
                button.classList.remove('btn-outline');
            }
        },
        showVisitDetail: function(visitId) { const visit = App.DB.get('visits').find(v => v.id === visitId); if (!visit) return App.UI.toast('Visit not found.', 'error'); const customer = App.DB.get('customers').find(c => c.accountNo === visit.customerId); const contentEl = document.getElementById('visit-detail-content'); const locationHTML = visit.location ? `<a href="https://www.google.com/maps?q=${visit.location}" target="_blank" style="color:var(--primary);">${visit.location}</a>` : 'N/A'; contentEl.innerHTML = `<div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));"><div class="detail-info-card"><div class="label">Customer</div><div class="value">${customer ? customer.companyName : 'N/A'}</div></div><div class="detail-info-card"><div class="label">Visit Date</div><div class="value">${App.Helpers.formatDate(visit.dateTime)}</div></div><div class="detail-info-card"><div class="label">Contact Method</div><div class="value">${visit.contactMethod || 'N/A'}</div></div><div class="detail-info-card"><div class="label">Outcome</div><div class="value">${visit.outcome || 'N/A'}</div></div><div class="detail-info-card"><div class="label">Location</div><div class="value">${locationHTML}</div></div></div><hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-6) 0;"><h4 class="card-title mb-4">Notes</h4><div class="card" style="background:var(--bg-color);">${visit.notes || '<p>No notes were entered for this visit.</p>'}</div>`; App.UI.openModal('visit-detail-modal'); }, 
        saveCompletedVisit: function(e) { 
            e.preventDefault(); 
            const form = e.target; 
            const visitId = form.elements['mark-done-visit-id'].value; 
            const location = document.getElementById('log-location-hidden').value; 
            let visits = App.DB.get('visits'); 
            const visitIndex = visits.findIndex(v => v.id === visitId); 
            if (visitIndex > -1) { 
                const visit = visits[visitIndex]; 
                visit.status = "Completed"; 
                visit.contactMethod = form.elements['log-contact-method'].value; 
                visit.outcome = form.elements['log-outcome'].value; 
                visit.notes = this.logNotesQuill.root.innerHTML; 
                if (location) { 
                    visit.location = location; 
                } 
                const nextVisitDate = document.getElementById('log-next-date').value; 
                if (nextVisitDate) { visits.push({ id: `v${Date.now() + 1}`, customerId: visit.customerId, dateTime: nextVisitDate, purpose: 'Scheduled Follow-up', collector: visit.collector, status: "Scheduled" }); } 
                let logDetails = `${App.DB.get('customers').find(c=>c.accountNo === visit.customerId).companyName} (Outcome: ${visit.outcome})`; 
                if(visit.location) { 
                    logDetails += ', Location Tagged'; 
                } 
                App.Helpers.logActivity(`completed visit for`, logDetails); 
            } 
            App.DB.set('visits', visits); 
            App.UI.closeModal('visit-notes-modal'); 
            App.UI.toast('Visit marked as done!'); 
            this.render(); 
        }, 
        checkOverdueVisits: function() { let v = App.DB.get('visits'), c = false; const today = new Date(); today.setHours(0, 0, 0, 0); v.forEach(i => { if (i.status === 'Scheduled' && new Date(i.dateTime) < today) { i.status = 'Overdue'; c = true; } }); if (c) App.DB.set('visits', v); }, 
        tagLocationForVisitLog: function() { 
            if (!navigator.geolocation) return App.UI.toast('Geolocation not supported.', 'error'); 
            navigator.geolocation.getCurrentPosition(p => { 
                const coords = `${p.coords.latitude.toFixed(5)},${p.coords.longitude.toFixed(5)}`; 
                document.getElementById('log-location-text').textContent = `Tagged: ${coords}`; 
                document.getElementById('log-location-hidden').value = coords; 
                App.UI.toast('Location tagged for this note!'); 
            }, () => App.UI.toast('Unable to get location.', 'error')); 
        }, 
        deleteVisit(visitId) { const visit = App.DB.get('visits').find(v => v.id === visitId); Swal.fire({ title: `Delete this visit?`, text: "This action cannot be undone.", input: 'textarea', inputLabel: 'Reason for deletion', inputPlaceholder: 'Enter your reason here...', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: 'var(--danger)', background: 'var(--card-bg)', color: 'var(--text-primary)', inputValidator: (value) => { if (!value) { return 'You must provide a reason for deletion!' } } }).then(result => { if (result.isConfirmed && result.value) { let visits = App.DB.get('visits').filter(v => v.id !== visitId); App.DB.set('visits', visits); App.Helpers.logAdminActivity(`Deleted Visit: ${visit.purpose} for customer ${visit.customerId}`, result.value); App.UI.toast('Visit deleted.', 'success'); this.render(); } }); } 
    });
    Object.assign(App.Payments, { 
        getCurrentFilteredData: function() {
            return App.Helpers.getScopedData('payments').sort((a, b) => new Date(b.date) - new Date(a.date));
        },
        exportData: function(format) {
            const payments = this.getCurrentFilteredData();
            const customers = App.DB.get('customers');
            const headers = ['Date', 'Customer', 'Amount', 'Method', 'Status'];
            const data = payments.map(p => {
                const customer = customers.find(c => c.accountNo === p.customerId);
                return [ App.Helpers.formatDate(p.date), customer ? customer.companyName : 'N/A', p.amount, p.method, p.status ];
            });
            const filename = `Payments_Report_${new Date().toLocaleDateString()}`;
            if (format === 'csv') {
                App.Helpers.exportToCSV(filename + '.csv', headers, data);
            } else {
                App.Helpers.exportToPDF(filename + '.pdf', 'Payments List', headers, data);
            }
        },
        render: function() { 
            // Render KPI cards
            const payments = App.DB.get('payments');
            const recoveredThisMonth = payments.filter(p => new Date(p.date).getMonth() === new Date().getMonth() && p.status === 'Completed').reduce((sum, p) => sum + p.amount, 0);
            App.Dashboard.animateCounter('payment-kpi-recovered-month', recoveredThisMonth, true);
            App.Dashboard.animateCounter('payment-kpi-total-count', payments.length);
            App.Dashboard.animateCounter('payment-kpi-pending', payments.filter(p => p.status === 'Pending').length);

            const filteredPayments = this.getCurrentFilteredData(); 
            const customers = App.DB.get('customers'); 
            const tbody = document.getElementById('payment-table-body'); 
            tbody.innerHTML = filteredPayments.length > 0 ? filteredPayments.map(p => { const customer = customers.find(c => c.accountNo === p.customerId); const actions = [ `<button class="btn btn-outline view-payment" data-id="${p.id}" title="View Details"><i class="fas fa-eye"></i></button>`, App.state.currentUser.role === 'admin' ? `<button class="btn btn-danger delete-payment" data-id="${p.id}" title="Delete"><i class="fas fa-trash"></i></button>` : '' ].join(''); return `<tr><td>${App.Helpers.formatDate(p.date)}</td><td>${customer ? customer.companyName : 'N/A'}</td><td>${App.Helpers.formatCurrency(p.amount)}</td><td>${p.method}</td><td><span class="status-badge ${p.status.toLowerCase()}">${p.status}</span></td><td><div class="d-flex gap-2">${actions}</div></td></tr>`; }).join('') : '<tr><td colspan="6">No payments recorded.</td></tr>'; 
        }, 
        setupEventListeners: function() { document.getElementById('record-payment-btn').addEventListener('click', () => this.showPaymentForm()); document.getElementById('payment-form').addEventListener('submit', (e) => this.savePayment(e)); document.getElementById('payment-table-body').addEventListener('click', (e) => { const viewButton = e.target.closest('.view-payment'); if (viewButton) this.showPaymentDetail(viewButton.dataset.id); const deleteButton = e.target.closest('.delete-payment'); if (deleteButton) this.deletePayment(deleteButton.dataset.id); }); document.getElementById('export-payments-csv').addEventListener('click', () => this.exportData('csv')); document.getElementById('export-payments-pdf').addEventListener('click', () => this.exportData('pdf')); }, 
        showPaymentForm: function(customerId = null) { 
            const form = document.getElementById('payment-form');
            form.reset(); 
            document.getElementById('payment-customer-id').innerHTML = App.Helpers.getScopedData('customers').map(c => `<option value="${c.accountNo}">${c.companyName} (${c.accountNo})</option>`).join(''); 
            if (customerId) {
                form.elements['payment-customer-id'].value = customerId;
            }
            document.getElementById('payment-date').valueAsDate = new Date(); 
            App.UI.openModal('payment-modal'); 
        }, 
        savePayment: function(e) { 
            e.preventDefault(); 
            const f = e.target, cid = f.elements['payment-customer-id'].value, a = parseFloat(f.elements['payment-amount'].value); 
            const pd = { id: `p${Date.now()}`, customerId: cid, amount: a, method: f.elements['payment-method'].value, date: f.elements['payment-date'].value, status: f.elements['payment-status'].value }; 
            App.DB.set('payments', [...App.DB.get('payments'), pd]); 
            if (pd.status === 'Completed') { 
                let c = App.DB.get('customers'); 
                const ci = c.findIndex(cu => cu.accountNo === cid); 
                if (ci !== -1) { 
                    c[ci].outstanding -= a; 
                    if (c[ci].outstanding <= 0) { c[ci].outstanding = 0; c[ci].paymentStatus = 'Cleared'; } else { c[ci].paymentStatus = 'Pending';} 
                    App.DB.set('customers', c); 
                } 
                App.Helpers.logActivity(`recorded a payment`, `${App.Helpers.formatCurrency(a)} from ${c.find(cust=>cust.accountNo === cid).companyName} (Method: ${pd.method})`); 
            } 
            
            App.UI.toast('Payment recorded!'); 
            
            if (App.state.paymentFlowOrigin) {
                App.state.paymentFlowOrigin.paymentLogged = true;
                App.UI.closeModal('payment-modal');
            } else {
                App.UI.closeModal('payment-modal');
                this.render(); 
                if (App.state.activePage === 'dashboard') App.Dashboard.render(); 
                if (App.state.activePage === 'customers') App.Customers.render();
            }
        }, 
        showPaymentDetail: function(paymentId) { const payment = App.DB.get('payments').find(p => p.id === paymentId); if (!payment) return; const customer = App.DB.get('customers').find(c => c.accountNo === payment.customerId); const contentEl = document.getElementById('payment-detail-content'); contentEl.innerHTML = `<div class="detail-info-grid" style="grid-template-columns: 1fr 1fr; gap: var(--spacing-6);"><div class="detail-info-card"><div class="label">TRANSACTION ID</div><div class="value">${payment.id}</div></div><div class="detail-info-card"><div class="label">AMOUNT</div><div class="value" style="color: var(--success);">${App.Helpers.formatCurrency(payment.amount)}</div></div><div class="detail-info-card"><div class="label">PAYMENT DATE</div><div class="value">${App.Helpers.formatDate(payment.date)}</div></div><div class="detail-info-card"><div class="label">PAYMENT METHOD</div><div class="value">${payment.method}</div></div><div class="detail-info-card"><div class="label">STATUS</div><div class="value"><span class="status-badge ${payment.status.toLowerCase()}">${payment.status}</span></div></div></div><hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-6) 0;"><h4 class="card-title mb-4">Customer Information</h4>${customer ? `<div class="detail-info-grid" style="grid-template-columns: 1fr 1fr;"><div class="detail-info-card"><div class="label">COMPANY NAME</div><div class="value">${customer.companyName}</div></div><div class="detail-info-card"><div class="label">ACCOUNT #</div><div class="value">${customer.accountNo}</div></div><div class="detail-info-card"><div class="label">SALES CONSULTANT</div><div class="value">${customer.salesConsultant}</div></div><div class="detail-info-card"><div class="label">CURRENT OUTSTANDING</div><div class="value">${App.Helpers.formatCurrency(customer.outstanding)}</div></div></div>` : '<p>No customer associated with this payment.</p>'}`; App.UI.openModal('payment-detail-modal'); }, deletePayment(paymentId) { const payment = App.DB.get('payments').find(p => p.id === paymentId); Swal.fire({ title: `Delete this payment?`, text: "This will add the amount back to the customer's outstanding balance. This action cannot be undone.", input: 'textarea', inputLabel: 'Reason for deletion', inputPlaceholder: 'Enter your reason here...', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: 'var(--danger)', background: 'var(--card-bg)', color: 'var(--text-primary)', inputValidator: (value) => { if (!value) { return 'You must provide a reason for deletion!' } } }).then(result => { if (result.isConfirmed && result.value) { let payments = App.DB.get('payments'); let customers = App.DB.get('customers'); const customerIndex = customers.findIndex(c => c.accountNo === payment.customerId); if (customerIndex !== -1) { customers[customerIndex].outstanding += payment.amount; if (customers[customerIndex].outstanding > 0) { customers[customerIndex].paymentStatus = 'Pending'; } App.DB.set('customers', customers); } App.DB.set('payments', payments.filter(p => p.id !== paymentId)); App.Helpers.logAdminActivity(`Deleted Payment: ${App.Helpers.formatCurrency(payment.amount)} for customer ${payment.customerId}`, result.value); App.UI.toast('Payment deleted and balance adjusted.', 'success'); this.render(); if(App.state.activePage === 'dashboard') App.Dashboard.render(); if(App.state.activePage === 'customers') App.Customers.render(); } }); } 
    });
    Object.assign(App.Reports, { charts: {}, currentReportData: null, currentStatementData: null,  render: function() { 
        const consultantSelect = document.getElementById('report-consultant-select'); 
        if (consultantSelect) { 
            consultantSelect.innerHTML = App.DB.get('consultants').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('report-activity-start-date').value = firstDayOfMonth.toISOString().slice(0, 10);
            document.getElementById('report-activity-end-date').valueAsDate = today;
        } 
        const customerSelect = document.getElementById('statement-customer-select'); 
        if(customerSelect) { 
            customerSelect.innerHTML = App.DB.get('customers').map(c => `<option value="${c.accountNo}">${c.companyName} (${c.accountNo})</option>`).join(''); 
        } 
        document.getElementById('report-output').innerHTML = ''; 
    }, 
        setupEventListeners: function() { 
            document.getElementById('generate-customer-report-btn').addEventListener('click', () => this.generateCustomerReport()); 
            document.getElementById('generate-consultant-report-btn').addEventListener('click', () => this.generateConsultantReport()); 
            document.getElementById('generate-overdue-report-btn').addEventListener('click', () => this.generateOverdueReport()); 
            document.getElementById('generate-recovery-report-btn').addEventListener('click', () => this.generateRecoveryPerformanceReport()); 
            document.getElementById('generate-statement-btn').addEventListener('click', () => this.generateCustomerStatement()); 
            document.getElementById('generate-outcome-analysis-btn').addEventListener('click', () => this.generateVisitOutcomeReport()); 
            document.getElementById('generate-activity-report-btn').addEventListener('click', () => this.generateActivityReport()); 
            document.getElementById('payment-trend-year').addEventListener('change', () => this.renderPaymentTrendChart()); 
            document.getElementById('payment-trend-yoy').addEventListener('change', () => this.renderPaymentTrendChart()); 
            const summaryBtn = document.getElementById('activity-report-summary-btn'); 
            const tableBtn = document.getElementById('activity-report-table-btn'); 
            summaryBtn.addEventListener('click', () => { App.state.reports.activityView = 'summary'; summaryBtn.classList.add('active'); tableBtn.classList.remove('active'); if (document.getElementById('report-output').innerHTML !== '') this.generateActivityReport(); }); 
            tableBtn.addEventListener('click', () => { App.state.reports.activityView = 'table'; tableBtn.classList.add('active'); summaryBtn.classList.remove('active'); if (document.getElementById('report-output').innerHTML !== '') this.generateActivityReport(); });
            document.getElementById('generate-collection-report-btn').addEventListener('click', (e) => { e.preventDefault(); this.generateCollectionReport(); });
            document.getElementById('generate-aging-report-btn').addEventListener('click', (e) => { e.preventDefault(); this.generateAgingReport()});
            document.getElementById('generate-collector-perf-btn').addEventListener('click', (e) => { e.preventDefault(); this.generateCollectorPerformanceReport()});
            document.getElementById('generate-risk-analysis-btn').addEventListener('click', (e) => { e.preventDefault(); this.generateRiskAnalysisReport()});
        }, 
        renderPaymentTrendChart: function() { 
            const yearSelect = document.getElementById('payment-trend-year');
            const payments = App.DB.get('payments');
            const years = [...new Set(payments.map(p => new Date(p.date).getFullYear()))].sort((a, b) => b - a);
            if (yearSelect.options.length === 0) {
                yearSelect.innerHTML = years.map(y => `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`).join('');
                if (years.length === 0) { 
                    const currentYear = new Date().getFullYear(); 
                    yearSelect.innerHTML = `<option value="${currentYear}">${currentYear}</option>`;
                }
            }
            const selectedYear = parseInt(yearSelect.value); 
            const compareYoY = document.getElementById('payment-trend-yoy').checked; 
            const getYearlyData = (year) => { let monthlyTotals = Array(12).fill(0); payments.filter(p => new Date(p.date).getFullYear() === year).forEach(p => { const month = new Date(p.date).getMonth(); monthlyTotals[month] += p.amount; }); return monthlyTotals; }; const currentYearData = getYearlyData(selectedYear); const datasets = [{ label: selectedYear, data: currentYearData, borderColor: 'var(--primary)', backgroundColor: 'rgba(226, 0, 15, 0.2)', fill: true, tension: 0.4 }]; if(compareYoY && selectedYear) { const prevYearData = getYearlyData(selectedYear - 1); datasets.push({ label: selectedYear - 1, data: prevYearData, borderColor: 'var(--success)', backgroundColor: 'rgba(16, 185, 129, 0.2)', fill: true, tension: 0.4 }); } const ctx = document.getElementById('payment-trend-chart'); if(this.charts.paymentTrend) { this.charts.paymentTrend.destroy(); } this.charts.paymentTrend = new Chart(ctx, { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: 'var(--text-primary)' } }, x: { ticks: { color: 'var(--text-primary)' } } }, plugins: { legend: { labels: { color: 'var(--text-primary)' } } } } }); },  
        generateActivityReport: function() { 
            const consultantName = document.getElementById('report-consultant-select').value; 
            const startDate = document.getElementById('report-activity-start-date').value; 
            const endDate = document.getElementById('report-activity-end-date').value;
            if (!startDate || !endDate) { return App.UI.toast('Please select both a start and end date.', 'warning'); }
            const log = App.DB.get('activityLog').filter(entry => entry.consultant === consultantName && entry.date >= startDate && entry.date <= endDate); 
            
            const output = document.getElementById('report-output'); 
            if (log.length === 0) { output.innerHTML = `<div class="card"><p>No activity recorded for ${consultantName} between ${App.Helpers.formatDate(startDate)} and ${App.Helpers.formatDate(endDate)}.</p></div>`; return; } 
            
            const reportTitle = `Activity for ${consultantName} from ${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)}`; 
            
            if (App.state.reports.activityView === 'summary') { 
                const activeDays = [...new Set(log.filter(e => e.action === 'Started Day').map(e => e.date))].length;
                const completedVisits = log.filter(e => e.action.includes('completed visit')).length; 
                const recordedPayments = log.filter(e => e.action.includes('recorded a payment')); 
                const totalRecovered = recordedPayments.reduce((sum, p) => { const amountMatch = p.details.match(/AED\s?([\d,]+\.\d{2})/); return sum + (amountMatch ? parseFloat(amountMatch[1].replace(/,/g, '')) : 0); }, 0); 
                const timelineHTML = log.sort((a, b) => b.timestamp - a.timestamp).slice(0, 20).map(entry => { let detail = entry.details || entry.action; let icon = "fa-info-circle"; if (entry.action.includes("completed visit")) { icon = "fa-check-circle"; detail = `<strong>Completed Visit:</strong> ${entry.details}`; } if (entry.action.includes("recorded a payment")) { icon = "fa-dollar-sign"; detail = `<strong>Recorded Payment:</strong> ${entry.details}`; } if (entry.action === 'Started Day') { icon = "fa-play-circle"; detail = 'Started Day'; } if (entry.action === 'Ended Day') { icon = "fa-stop-circle"; detail = 'Ended Day'; } return `<li class="d-flex align-items-center gap-4 mb-4"><div class="d-flex align-items-center" style="min-width: 130px; color: var(--text-secondary); font-size: var(--fs-sm);"><i class="fas ${icon}" style="color: var(--primary); font-size: 1.2rem; margin-right: var(--spacing-2);"></i><span style="font-weight: 500;">${entry.time}</span></div><div style="font-weight: 500;">${detail}</div></li>`; }).join(''); 
                output.innerHTML = `<div class="card"><div class="card-header" style="border-bottom: none;"><h3 class="card-title">${reportTitle}</h3></div><h4 class="card-title" style="font-size: var(--fs-lg); margin-bottom: var(--spacing-4);">Summary</h4><div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));"><div class="detail-info-card"><div class="label">ACTIVE DAYS</div><div class="value">${activeDays}</div></div><div class="detail-info-card"><div class="label">VISITS COMPLETED</div><div class="value">${completedVisits}</div></div><div class="detail-info-card"><div class="label">PAYMENTS RECORDED</div><div class="value">${recordedPayments.length}</div></div><div class="detail-info-card"><div class="label">TOTAL RECOVERED</div><div class="value" style="color:var(--success);">${App.Helpers.formatCurrency(totalRecovered)}</div></div></div><hr style="margin: var(--spacing-6) 0; border-color: var(--border-color);"><h4 class="card-title" style="font-size: var(--fs-lg); margin-bottom: var(--spacing-4);">Recent Timeline (Last 20)</h4><ul style="list-style:none;">${timelineHTML}</ul></div>`; 
            } else { 
                const headers = ['Date', 'Time', 'Customer', 'Category', 'Details', 'Amount']; 
                const data = log.sort((a, b) => a.timestamp - b.timestamp).map(entry => { 
                    let category = 'General', details = entry.details || entry.action, amount = '-', customer = 'N/A'; 
                    if(entry.action.includes('Day')) { category = 'Attendance'; } 
                    else if (entry.action.includes('payment')) {
                        category = 'Payment';
                        const customerMatch = entry.details.match(/from (.*?) KATEX_INLINE_OPEN/);
                        if(customerMatch) customer = customerMatch[1];
                        details = entry.details.substring(entry.details.indexOf('('));
                        const amountMatch = entry.details.match(/AED\s?([\d,]+\.\d{2})/); 
                        if (amountMatch) amount = App.Helpers.formatCurrency(parseFloat(amountMatch[1].replace(/,/g, '')));
                    } else if (entry.action.includes('visit')) {
                        category = 'Visit';
                        const customerMatch = entry.details.match(/(.*?) KATEX_INLINE_OPEN/);
                        if(customerMatch) customer = customerMatch[1];
                        details = entry.details.substring(entry.details.indexOf('('));
                    } else if (entry.action.includes('added a new customer')) {
                        category = 'Customer';
                        customer = entry.details;
                        details = 'New Account';
                    }
                    return [App.Helpers.formatDate(entry.date), entry.time, customer, category, details, amount]; 
                }); 
                this.displayReport(reportTitle, headers, data); 
            } 
        }, 
        generateCollectionReport: function() {
            const payments = App.DB.get('payments').filter(p => p.status === 'Completed');
            const now = new Date();
            const todayStr = now.toISOString().slice(0, 10);
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            startOfWeek.setHours(0,0,0,0);

            const dailyTotal = payments.filter(p => p.date === todayStr).reduce((sum, p) => sum + p.amount, 0);
            const weeklyTotal = payments.filter(p => new Date(p.date) >= startOfWeek).reduce((sum, p) => sum + p.amount, 0);
            const monthlyTotal = payments.filter(p => new Date(p.date).getMonth() === new Date().getFullYear()).reduce((sum, p) => sum + p.amount, 0);

            document.getElementById('report-output').innerHTML = `
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Collection Summary Report</h3></div>
                    <div class="detail-info-grid">
                        <div class="detail-info-card"><div class="label">Collected Today</div><div class="value">${App.Helpers.formatCurrency(dailyTotal)}</div></div>
                        <div class="detail-info-card"><div class="label">Collected This Week</div><div class="value">${App.Helpers.formatCurrency(weeklyTotal)}</div></div>
                        <div class="detail-info-card"><div class="label">Collected This Month</div><div class="value">${App.Helpers.formatCurrency(monthlyTotal)}</div></div>
                    </div>
                </div>
            `;
        },
        generateAgingReport: function() {
            const customers = App.DB.get('customers').filter(c => c.paymentStatus === 'Overdue');
            const headers = ['Company Name', 'Outstanding Amount', 'Consultant', 'Aging Category'];
            const data = customers.map(c => [c.companyName, App.Helpers.formatCurrency(c.outstanding), c.salesConsultant, '30+ Days Overdue']);
            this.displayReport('Customer Aging Report (Overdue)', headers, data);
        },
        generateCollectorPerformanceReport: function() {
            const consultants = App.DB.get('consultants');
            const customers = App.DB.get('customers');
            const visits = App.DB.get('visits');
            const payments = App.DB.get('payments');

            const headers = ['Collector', 'Assigned Customers', 'Total Recovered', 'Visits Made', 'Success Rate (%)'];
            const data = consultants.map(consultant => {
                const assignedCustomers = customers.filter(c => c.salesConsultant === consultant.name);
                const assignedCustomerIds = new Set(assignedCustomers.map(c => c.accountNo));
                const totalRecovered = payments.filter(p => assignedCustomerIds.has(p.customerId) && p.status === 'Completed').reduce((sum, p) => sum + p.amount, 0);
                const visitsMade = visits.filter(v => v.collector === consultant.name && v.status === 'Completed');
                const successfulVisits = visitsMade.filter(v => v.outcome === 'Paid in Full' || v.outcome === 'Partial Payment').length;
                const successRate = visitsMade.length > 0 ? ((successfulVisits / visitsMade.length) * 100).toFixed(2) : 0;
                return [consultant.name, assignedCustomers.length, App.Helpers.formatCurrency(totalRecovered), visitsMade.length, successRate];
            });
            this.displayReport('Collector Performance Report', headers, data);
        },
        generateRiskAnalysisReport: function() {
            const customers = App.DB.get('customers').filter(c => c.outstanding > 0);
            const headers = ['Company Name', 'Outstanding Amount', 'Status', 'Risk Level'];
            const data = customers.map(c => {
                let riskLevel = 'Low';
                if (c.paymentStatus === 'Overdue') riskLevel = 'High';
                else if (c.outstanding > 20000) riskLevel = 'Medium';
                return [c.companyName, App.Helpers.formatCurrency(c.outstanding), c.paymentStatus, riskLevel];
            }).sort((a,b) => { const order = {'High': 0, 'Medium': 1, 'Low': 2}; return order[a[3]] - order[b[3]]; });
            this.displayReport('Customer Risk Analysis Report', headers, data);
        },
        generateCustomerReport: function() { const c = App.Helpers.getScopedData('customers'), h = ['Account #', 'Company Name', 'Emirate', 'Outstanding', 'Consultant', 'Status'], d = c.map(i => [i.accountNo, i.companyName, i.emirate, App.Helpers.formatCurrency(i.outstanding), i.salesConsultant, i.status]); this.displayReport('Customer List Report', h, d); },
        generateConsultantReport: function() { const c = App.Helpers.getScopedData('customers'), v = App.DB.get('visits'); const rd = c.reduce((a, i) => { const con = i.salesConsultant; if (!a[con]) a[con] = { customers: 0, totalDebt: 0, visits: 0 }; a[con].customers++; a[con].totalDebt += i.outstanding; return a; }, {}); v.forEach(i => { if (rd[i.collector]) rd[i.collector].visits++; }); const h = ['Consultant', 'Assigned Customers', 'Total Outstanding', 'Total Visits'], d = Object.entries(rd).map(([n, s]) => [n, s.customers, App.Helpers.formatCurrency(s.totalDebt), s.visits]); this.displayReport('Consultant Activity Report', h, d); },
        generateOverdueReport: function() { const customers = App.Helpers.getScopedData('customers').filter(c => c.paymentStatus === 'Overdue'); const headers = ['Account #', 'Company Name', 'Outstanding', 'Consultant', 'Emirate']; const data = customers.map(c => [c.accountNo, c.companyName, App.Helpers.formatCurrency(c.outstanding), c.salesConsultant, c.emirate]); this.displayReport('Overdue Accounts Report', headers, data); },
        generateRecoveryPerformanceReport: function() { const consultants = App.DB.get('consultants'); const customers = App.Helpers.getScopedData('customers'); const headers = ['Consultant', 'Total Initial Debt', 'Total Outstanding', 'Total Recovered', 'Recovery Rate']; const data = consultants.map(consultant => { const assignedCustomers = customers.filter(c => c.salesConsultant === consultant.name); const initialDebt = assignedCustomers.reduce((sum, c) => sum + c.initialDebt, 0); const outstandingDebt = assignedCustomers.reduce((sum, c) => sum + c.outstanding, 0); const recovered = initialDebt - outstandingDebt; const recoveryRate = initialDebt > 0 ? ((recovered / initialDebt) * 100).toFixed(2) + '%' : 'N/A'; return [consultant.name, App.Helpers.formatCurrency(initialDebt), App.Helpers.formatCurrency(outstandingDebt), App.Helpers.formatCurrency(recovered), recoveryRate]; }); this.displayReport('Debt Recovery Performance Report', headers, data); },
        generateCustomerStatement: function() { const customerId = document.getElementById('statement-customer-select').value; if (!customerId) { App.UI.toast('Please select a customer.', 'warning'); return; } const customer = App.DB.get('customers').find(c => c.accountNo === customerId); const payments = App.DB.get('payments').filter(p => p.customerId === customerId && p.status === 'Completed').sort((a,b) => new Date(a.date) - new Date(b.date)); let transactions = []; transactions.push({ date: 'Initial', description: 'Initial Debt Amount', debit: customer.initialDebt, credit: 0 }); payments.forEach(p => { transactions.push({ date: p.date, description: `Payment Received (${p.method})`, debit: 0, credit: p.amount }); }); let balance = 0; const transactionsWithBalance = transactions.map(t => { balance += t.debit - t.credit; return {...t, balance}; }); const body = transactionsWithBalance.map(t => { return `<tr><td>${t.date === 'Initial' ? 'N/A' : App.Helpers.formatDate(t.date)}</td><td>${t.description}</td><td>${t.debit > 0 ? App.Helpers.formatCurrency(t.debit) : '-'}</td><td>${t.credit > 0 ? App.Helpers.formatCurrency(t.credit) : '-'}</td><td>${App.Helpers.formatCurrency(t.balance)}</td></tr>` }).join(''); const reportTitle = `Statement for ${customer.companyName} (${customer.accountNo})`; this.currentStatementData = { customer, transactionsWithBalance }; const exportButtons = `<div class="d-flex gap-2"><button class="btn btn-outline" onclick="App.Reports.exportStatementCSV()"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" onclick="App.Reports.exportStatementPDF()"><i class="fas fa-file-pdf"></i> PDF</button></div>`; document.getElementById('report-output').innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">${reportTitle}</h3>${exportButtons}</div><div class="detail-info-grid" style="grid-template-columns: repeat(3, 1fr);"><div class="detail-info-card"><div class="label">Total Billed</div><div class="value">${App.Helpers.formatCurrency(customer.initialDebt)}</div></div><div class="detail-info-card"><div class="label">Total Paid</div><div class="value">${App.Helpers.formatCurrency(customer.initialDebt - customer.outstanding)}</div></div><div class="detail-info-card"><div class="label">Balance Due</div><div class="value" style="color:var(--danger);">${App.Helpers.formatCurrency(customer.outstanding)}</div></div></div><div class="table-container mt-4"><table class="data-table"><thead><tr><th>Date</th><th>Description</th><th>Debit (Billed)</th><th>Credit (Paid)</th><th>Balance</th></tr></thead><tbody>${body}</tbody></table></div></div>`; },
        generateVisitOutcomeReport: function() { const visits = App.DB.get('visits').filter(v => v.status === 'Completed' && v.outcome); const outcomeCounts = visits.reduce((acc, visit) => { acc[visit.outcome] = (acc[visit.outcome] || 0) + 1; return acc; }, {}); const labels = Object.keys(outcomeCounts); const data = Object.values(outcomeCounts); document.getElementById('report-output').innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Visit Outcome Analysis</h3></div><div class="chart-container" style="height: 400px;"><canvas id="outcome-chart"></canvas></div></div>`; if(this.charts && this.charts.outcome) this.charts.outcome.destroy(); this.charts.outcome = new Chart(document.getElementById('outcome-chart'), { type: 'pie', data: { labels: labels, datasets: [{ label: 'Visit Outcomes', data: data, backgroundColor: ['#e2000f', '#10b981', '#ffc107', '#dc3545', '#0d6efd', '#84cc16'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'var(--text-primary)' } } } } }); },
        displayReport: function(t, h, d) { this.currentReportData = { title: t, headers: h, data: d }; document.getElementById('report-output').innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">${t}</h3><div class="d-flex gap-2"><button class="btn btn-outline" onclick="App.Reports.exportCSV()"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" onclick="App.Reports.exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button></div></div><div class="table-container"><table class="data-table"><thead><tr>${h.map(i => `<th>${i}</th>`).join('')}</tr></thead><tbody>${d.length ? d.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('') : `<tr><td colspan="${h.length}">No data found for this report.</td></tr>`}</tbody></table></div></div>`; },
        exportCSV: function() { if (!this.currentReportData) return App.UI.toast('No report data to export.', 'error'); const { title: t, headers: h, data: d } = this.currentReportData; App.Helpers.exportToCSV(`${t.replace(/\s/g, '_')}.csv`, h, d); },
        exportPDF: function() { if (!this.currentReportData) return App.UI.toast('No report data to export.', 'error'); const { title: t, headers: h, data: d } = this.currentReportData; App.Helpers.exportToPDF(`${t.replace(/\s/g, '_')}.pdf`, t, h, d); },
        exportStatementCSV: function() { if (!this.currentStatementData) return App.UI.toast('No statement data to export.', 'error'); const { customer, transactionsWithBalance } = this.currentStatementData; const title = `Statement_for_${customer.companyName.replace(/\s/g, '_')}`; let csvContent = "data:text/csv;charset=utf-8,"; csvContent += `Statement for:,"${customer.companyName} (${customer.accountNo})"\n`; csvContent += `Total Billed:,${App.Helpers.formatCurrency(customer.initialDebt)}\n`; csvContent += `Total Paid:,${App.Helpers.formatCurrency(customer.initialDebt - customer.outstanding)}\n`; csvContent += `Balance Due:,${App.Helpers.formatCurrency(customer.outstanding)}\n\n`; const headers = ['Date', 'Description', 'Debit (Billed)', 'Credit (Paid)', 'Balance']; csvContent += headers.join(',') + '\r\n'; transactionsWithBalance.forEach(t => { const row = [ t.date === 'Initial' ? 'N/A' : App.Helpers.formatDate(t.date), `"${t.description}"`, t.debit > 0 ? t.debit.toFixed(2) : '0.00', t.credit > 0 ? t.credit.toFixed(2) : '0.00', t.balance.toFixed(2) ]; csvContent += row.join(',') + '\r\n'; }); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", `${title}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); },
        exportStatementPDF: function() { if (!this.currentStatementData) return App.UI.toast('No statement data to export.', 'error'); const { customer, transactionsWithBalance } = this.currentStatementData; const title = `Statement for ${customer.companyName} (${customer.accountNo})`; const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(18); doc.text(title, 14, 22); doc.setFontSize(11); doc.setTextColor(100); doc.text(`Total Billed: ${App.Helpers.formatCurrency(customer.initialDebt)}`, 14, 32); doc.text(`Total Paid: ${App.Helpers.formatCurrency(customer.initialDebt - customer.outstanding)}`, 70, 32); doc.text(`Balance Due: ${App.Helpers.formatCurrency(customer.outstanding)}`, 130, 32); const tableData = transactionsWithBalance.map(t => [ t.date === 'Initial' ? 'N/A' : App.Helpers.formatDate(t.date), t.description, t.debit > 0 ? App.Helpers.formatCurrency(t.debit) : '-', t.credit > 0 ? App.Helpers.formatCurrency(t.credit) : '-', App.Helpers.formatCurrency(t.balance) ]); doc.autoTable({ head: [['Date', 'Description', 'Debit (Billed)', 'Credit (Paid)', 'Balance']], body: tableData, startY: 40 }); doc.save(`Statement_${customer.companyName.replace(/\s/g, '_')}.pdf`); }
    });
    Object.assign(App.Consultants, { render: function() { const consultants = App.DB.get('consultants'); const customers = App.DB.get('customers'); const visits = App.DB.get('visits'); const tbody = document.getElementById('consultant-table-body'); const data = consultants.map(consultant => { const assignedCustomers = customers.filter(c => c.salesConsultant === consultant.name); const totalOutstanding = assignedCustomers.reduce((sum, c) => sum + c.outstanding, 0); const overdueCustomers = assignedCustomers.filter(c => c.paymentStatus === 'Overdue').length; const upcomingVisits = visits.filter(v => v.collector === consultant.name && v.status === 'Scheduled' && new Date(v.dateTime) >= new Date()).length; return { ...consultant, noOfCustomers: assignedCustomers.length, totalOutstanding, overdueCustomers, upcomingVisits }; }); tbody.innerHTML = data.length ? data.map(c => `<tr><td><div style="font-weight:600;">${c.name}</div></td><td>${c.noOfCustomers}</td><td>${App.Helpers.formatCurrency(c.totalOutstanding)}</td><td>${c.overdueCustomers}</td><td>${c.upcomingVisits}</td><td><div class="d-flex gap-2"><button class="btn btn-outline view-customers" data-name="${c.name}" title="View Customers"><i class="fas fa-users"></i></button><button class="btn btn-outline reassign-customers" data-name="${c.name}" title="Reassign Customers"><i class="fas fa-random"></i></button><button class="btn btn-outline edit-consultant" data-id="${c.id}" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-consultant" data-id="${c.id}" title="Delete"><i class="fas fa-trash"></i></button></div></td></tr>`).join('') : `<tr><td colspan="6">No consultants found.</td></tr>`; }, setupEventListeners: function() { document.getElementById('add-consultant-btn').addEventListener('click', () => this.showConsultantForm()); document.getElementById('consultant-form').addEventListener('submit', (e) => this.saveConsultant(e)); document.getElementById('consultant-table-body').addEventListener('click', e => { const editBtn = e.target.closest('.edit-consultant'); const deleteBtn = e.target.closest('.delete-consultant'); const viewBtn = e.target.closest('.view-customers'); const reassignBtn = e.target.closest('.reassign-customers'); if (editBtn) this.showConsultantForm(editBtn.dataset.id); if (deleteBtn) this.deleteConsultant(deleteBtn.dataset.id); if (viewBtn) this.showViewCustomersModal(viewBtn.dataset.name); if(reassignBtn) this.showReassignModal(reassignBtn.dataset.name); }); document.getElementById('reassign-customers-form').addEventListener('submit', e => this.reassignCustomers(e));}, showConsultantForm: function(id = null) { const form = document.getElementById('consultant-form'); form.reset(); if (id) { const consultant = App.DB.get('consultants').find(c => c.id == id); document.getElementById('consultant-modal-title').textContent = 'Edit Consultant'; form.elements['consultant-id-hidden'].value = consultant.id; form.elements['consultantName'].value = consultant.name; } else { document.getElementById('consultant-modal-title').textContent = 'Add New Consultant'; form.elements['consultant-id-hidden'].value = ''; } App.UI.openModal('consultant-modal'); }, saveConsultant: function(e) { e.preventDefault(); const form = e.target; const id = form.elements['consultant-id-hidden'].value; const name = form.elements['consultantName'].value.trim(); if (!name) return App.UI.toast('Consultant name cannot be empty.', 'error'); let consultants = App.DB.get('consultants'); if (id) { const index = consultants.findIndex(c => c.id == id); consultants[index].name = name; } else { consultants.push({ id: Date.now(), name }); } App.DB.set('consultants', consultants); App.UI.closeModal('consultant-modal'); App.UI.toast(`Consultant ${id ? 'updated' : 'added'}!`); this.render(); }, deleteConsultant: function(id) { App.UI.confirm('Are you sure?', "This will delete the consultant.", () => { let consultants = App.DB.get('consultants').filter(c => c.id != id); App.DB.set('consultants', consultants); App.UI.toast('Consultant deleted.', 'success'); this.render(); }); },
        showViewCustomersModal(consultantName) {
            document.getElementById('consultant-customers-title').textContent = `Customers of ${consultantName}`;
            const customers = App.DB.get('customers').filter(c => c.salesConsultant === consultantName);
            const body = document.getElementById('consultant-customers-body');
            if (customers.length === 0) {
                body.innerHTML = '<p>No customers assigned to this consultant.</p>';
            } else {
                const table = `<table class="data-table"><thead><tr><th>Account #</th><th>Company</th><th>Outstanding</th></tr></thead><tbody>${customers.map(c => `<tr><td>${c.accountNo}</td><td>${c.companyName}</td><td>${App.Helpers.formatCurrency(c.outstanding)}</td></tr>`).join('')}</tbody></table>`;
                body.innerHTML = table;
            }
            App.UI.openModal('consultant-customers-modal');
        },
        showReassignModal(fromConsultantName) {
            document.getElementById('from-consultant-hidden').value = fromConsultantName;
            document.getElementById('from-consultant-name').textContent = fromConsultantName;
            
            const customers = App.DB.get('customers').filter(c => c.salesConsultant === fromConsultantName);
            const customerListEl = document.getElementById('reassign-customer-list');
            customerListEl.innerHTML = customers.length > 0 ? customers.map(c => `<div class="d-flex align-items-center gap-2"><input type="checkbox" name="customerToReassign" value="${c.accountNo}" id="reassign-${c.accountNo}"><label for="reassign-${c.accountNo}">${c.companyName}</label></div>`).join('') : '<p>No customers to reassign.</p>';

            const consultants = App.DB.get('consultants').filter(c => c.name !== fromConsultantName);
            const toConsultantSelect = document.getElementById('reassign-to-consultant');
            toConsultantSelect.innerHTML = consultants.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            App.UI.openModal('reassign-customers-modal');
        },
        reassignCustomers(e) {
            e.preventDefault();
            const fromConsultant = document.getElementById('from-consultant-hidden').value;
            const toConsultant = document.getElementById('reassign-to-consultant').value;
            const selectedCustomerNodes = document.querySelectorAll('input[name="customerToReassign"]:checked');
            
            if (!toConsultant) return App.UI.toast('Please select a consultant to reassign to.', 'error');
            if (selectedCustomerNodes.length === 0) return App.UI.toast('Please select at least one customer to reassign.', 'error');

            const customerIdsToReassign = Array.from(selectedCustomerNodes).map(node => node.value);
            let customers = App.DB.get('customers');
            customerIdsToReassign.forEach(id => {
                const customerIndex = customers.findIndex(c => c.accountNo === id);
                if (customerIndex > -1) {
                    customers[customerIndex].salesConsultant = toConsultant;
                }
            });
            App.DB.set('customers', customers);
            App.Helpers.logAdminActivity(`Reassigned ${customerIdsToReassign.length} customers`, `From: ${fromConsultant} -> To: ${toConsultant}`);
            App.UI.closeModal('reassign-customers-modal');
            App.UI.toast('Customers reassigned successfully!', 'success');
            this.render();
            if(App.state.activePage === 'customers') App.Customers.render();
        }
    });
    Object.assign(App.Users, { 
        render: function() { 
            const users = App.DB.get('users'); 
            const tbody = document.getElementById('user-table-body'); 
            tbody.innerHTML = users.length ? users.map(u => `<tr><td><div style="font-weight:600;">${u.username}</div></td><td>${u.fullName}</td><td><span class="status-badge ${u.role}">${u.role}</span></td><td>${u.assignedConsultant || 'N/A'}</td><td>${u.department || 'N/A'}</td><td>${u.lastLogin ? App.Helpers.timeAgo(u.lastLogin) : 'Never'}</td><td><div class="d-flex gap-2"><button class="btn btn-outline edit-user" data-id="${u.id}" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-user" data-id="${u.id}" title="Delete"><i class="fas fa-trash"></i></button></div></td></tr>`).join('') : `<tr><td colspan="7">No users found.</td></tr>`; 
        }, 
        setupEventListeners: function() { document.getElementById('add-user-btn').addEventListener('click', () => this.showUserForm()); document.getElementById('user-form').addEventListener('submit', (e) => this.saveUser(e)); document.getElementById('user-table-body').addEventListener('click', e => { const editBtn = e.target.closest('.edit-user'); const deleteBtn = e.target.closest('.delete-user'); if (editBtn) this.showUserForm(editBtn.dataset.id); if (deleteBtn) this.deleteUser(deleteBtn.dataset.id); }); document.getElementById('role').addEventListener('change', e => { document.getElementById('assigned-consultant-group').style.display = e.target.value === 'user' ? 'block' : 'none'; }); }, 
        showUserForm: function(id = null) { 
            const form = document.getElementById('user-form'); 
            form.reset(); 
            const consultantSelect = form.elements['assignedConsultant']; 
            const consultants = App.DB.get('consultants'); 
            consultantSelect.innerHTML = `<option value="N/A">N/A</option>` + consultants.map(c => `<option value="${c.name}">${c.name}</option>`).join(''); 
            if (id) { 
                const user = App.DB.get('users').find(u => u.id == id); 
                document.getElementById('user-modal-title').textContent = 'Edit User'; 
                form.elements['user-id-hidden'].value = user.id; 
                form.elements['username'].value = user.username; 
                form.elements['username'].readOnly = true; 
                form.elements['fullName'].value = user.fullName; 
                form.elements['password'].value = user.password; 
                form.elements['department'].value = user.department || '';
                form.elements['role'].value = user.role; 
                form.elements['assignedConsultant'].value = user.assignedConsultant || 'N/A'; 
            } else { 
                document.getElementById('user-modal-title').textContent = 'Add New User'; 
                form.elements['user-id-hidden'].value = ''; 
                form.elements['username'].readOnly = false; 
            } 
            document.getElementById('assigned-consultant-group').style.display = form.elements['role'].value === 'user' ? 'block' : 'none'; 
            App.UI.openModal('user-modal'); 
        }, 
        saveUser: function(e) { 
            e.preventDefault(); 
            const form = e.target; 
            const id = form.elements['user-id-hidden'].value; 
            let users = App.DB.get('users'); 
            const userData = { 
                username: form.elements['username'].value.trim(), 
                fullName: form.elements['fullName'].value.trim(), 
                password: form.elements['password'].value, 
                role: form.elements['role'].value, 
                department: form.elements['department'].value.trim(),
                assignedConsultant: form.elements['role'].value === 'user' ? form.elements['assignedConsultant'].value : 'N/A' 
            }; 
            if (!userData.username || !userData.fullName || !userData.password) return App.UI.toast('All fields are required.', 'error'); 
            if (id) { 
                const index = users.findIndex(u => u.id == id); 
                users[index] = { ...users[index], ...userData }; 
            } else { 
                if (users.some(u => u.username === userData.username)) { return App.UI.toast('Username already exists.', 'error'); } 
                users.push({ id: Date.now(), ...userData, lastLogin: null }); 
            } 
            App.DB.set('users', users); 
            App.UI.closeModal('user-modal'); 
            App.UI.toast(`User ${id ? 'updated' : 'added'}!`); 
            this.render(); 
        }, 
        deleteUser: function(id) { if (id == App.state.currentUser.id) { return App.UI.toast('You cannot delete your own account.', 'error'); } App.UI.confirm('Are you sure?', "This will delete the user account.", () => { let users = App.DB.get('users').filter(u => u.id != id); App.DB.set('users', users); App.UI.toast('User deleted.', 'success'); this.render(); }); } 
    });
    Object.assign(App.Notifications, { init() { document.getElementById('notification-bell-btn').addEventListener('click', (e) => { e.stopPropagation(); this.toggleDropdown(); }); document.body.addEventListener('click', (e) => { const bellBtn = document.getElementById('notification-bell-btn'); const dropdown = document.getElementById('notification-dropdown'); if (dropdown && !dropdown.classList.contains('hidden') && !bellBtn.contains(e.target) && !dropdown.contains(e.target)) { dropdown.classList.add('hidden'); } }); }, create(message) { let notifications = App.DB.get('notifications'); const newNotification = { id: `notif_${Date.now()}`, timestamp: Date.now(), message: message, isRead: false }; notifications.unshift(newNotification); App.DB.set('notifications', notifications); if(App.state.currentUser && App.state.currentUser.role === 'admin') this.render(); }, render() { const notifications = App.DB.get('notifications').sort((a, b) => b.timestamp - a.timestamp); const unreadCount = notifications.filter(n => !n.isRead).length; const badge = document.getElementById('notification-badge'); if (unreadCount > 0) { badge.textContent = unreadCount; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } const list = document.getElementById('notification-list'); list.innerHTML = notifications.length > 0 ? notifications.slice(0, 15).map(n => `<li style="padding: var(--spacing-2) 0; border-bottom: 1px solid var(--border-color); ${!n.isRead ? 'font-weight: 600;' : ''}">${n.message}<div style="font-size: var(--fs-sm); color: var(--text-secondary); font-weight: 400; margin-top: 4px;"><i class="fas fa-clock"></i> ${App.Helpers.timeAgo(n.timestamp)}</div></li>`).join('') : '<li>No new notifications.</li>'; }, toggleDropdown() { const dropdown = document.getElementById('notification-dropdown'); const bellBtn = document.getElementById('notification-bell-btn'); const rect = bellBtn.getBoundingClientRect(); dropdown.style.top = `${rect.bottom + 10}px`; dropdown.style.right = `${window.innerWidth - rect.right}px`; dropdown.classList.toggle('hidden'); if(!dropdown.classList.contains('hidden')) { this.markAllAsRead(); } }, markAllAsRead() { let notifications = App.DB.get('notifications'); if (notifications.some(n => !n.isRead)) { setTimeout(() => { const updatedNotifications = notifications.map(n => ({ ...n, isRead: true })); App.DB.set('notifications', updatedNotifications); this.render(); }, 1500); } } });
    Object.assign(App.CommandPalette, { init() { window.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'k') { e.preventDefault(); this.open(); } }); document.getElementById('command-palette-input').addEventListener('input', App.Helpers.debounce(e => this.search(e.target.value), 200)); document.getElementById('command-palette-modal').addEventListener('click', (e) => { if (e.target.id === 'command-palette-modal') this.close(); }); }, open() { App.UI.openModal('command-palette-modal'); document.getElementById('command-palette-input').focus(); }, close() { document.getElementById('command-palette-input').value = ''; document.getElementById('command-palette-results').innerHTML = ''; App.UI.closeModal('command-palette-modal'); }, search(query) { const resultsContainer = document.getElementById('command-palette-results'); if (!query || query.length < 2) { resultsContainer.innerHTML = ''; return; } const q = query.toLowerCase(); let results = []; App.DB.get('customers').forEach(c => { if (c.companyName.toLowerCase().includes(q) || c.accountNo.toLowerCase().includes(q)) { results.push({ type: 'Customer', title: c.companyName, description: `Account: ${c.accountNo} | Consultant: ${c.salesConsultant}`, action: () => { App.Customers.showCustomerDetail(c.accountNo); } }); } }); App.DB.get('payments').forEach(p => { if (p.id.toLowerCase().includes(q)) { const customer = App.DB.get('customers').find(c => c.accountNo === p.customerId); results.push({ type: 'Payment', title: `Payment: ${App.Helpers.formatCurrency(p.amount)}`, description: `ID: ${p.id} | For: ${customer ? customer.companyName : 'N/A'}`, action: () => { App.Payments.showPaymentDetail(p.id); } }); } }); this.renderResults(results); }, renderResults(results) { const container = document.getElementById('command-palette-results'); if (results.length === 0) { container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">No results found.</div>'; return; } container.innerHTML = results.map(r => `<div class="command-result-item" role="button" tabindex="0"><div style="font-size: var(--fs-sm); color: var(--primary); font-weight: 600;">${r.type}</div><div style="font-weight: 500;">${r.title}</div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${r.description}</div></div>`).join(''); document.querySelectorAll('.command-result-item').forEach((item, index) => { item.addEventListener('click', () => { results[index].action(); this.close(); }); }); if (!document.getElementById('command-palette-styles')) { const style = document.createElement('style'); style.id = 'command-palette-styles'; style.innerHTML = `.command-result-item { padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; margin-bottom: 0.25rem; } .command-result-item:hover, .command-result-item:focus { background-color: var(--bg-color); outline: none; }`; document.head.appendChild(style); } } });
    Object.assign(App.AuditLog, { render() { const search = document.getElementById('audit-log-search').value.toLowerCase(); const log = App.DB.get('auditLog').filter(entry => entry.user.toLowerCase().includes(search) || entry.action.toLowerCase().includes(search) || entry.reason.toLowerCase().includes(search)); const tbody = document.getElementById('audit-log-table-body'); tbody.innerHTML = log.length ? log.map(entry => `<tr><td>${new Date(entry.timestamp).toLocaleString()}</td><td>${entry.user}</td><td>${entry.action}</td><td>${entry.reason}</td></tr>`).join('') : '<tr><td colspan="4">No audit log entries found.</td></tr>'; }, setupEventListeners() { const debouncedSearch = App.Helpers.debounce(() => this.render(), 300); document.getElementById('audit-log-search').addEventListener('input', debouncedSearch); } });
    Object.assign(App.Import, { init: function() { const dropZone = document.getElementById('csv-drop-zone'); const fileInput = document.getElementById('csv-file-input'); const sampleLink = document.getElementById('download-sample-csv-link'); dropZone.addEventListener('click', () => fileInput.click()); fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files[0])); dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); }); dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover')); dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length) { this.handleFileSelect(e.dataTransfer.files[0]); } }); sampleLink.addEventListener('click', (e) => { e.preventDefault(); this.downloadSampleCSV(); }); }, handleFileSelect: function(file) { if (!file || !file.type.match('text/csv')) { App.UI.toast('Please select a valid CSV file.', 'error'); return; } document.getElementById('csv-filename').textContent = file.name; const reader = new FileReader(); reader.onload = (event) => { this.processCSV(event.target.result); }; reader.readAsText(file); }, 
    processCSV: function(csvText) {
        const rows = csvText.split(/\r?\n/).filter(row => row.trim() !== '');
        if (rows.length < 2) { App.UI.toast('CSV file is empty or has no data rows.', 'error'); return; }

        let headerRow = rows.shift().replace(/^\uFEFF/, '');
        const delimiter = headerRow.includes(';') ? ';' : ',';
        const headers = headerRow.split(delimiter);

        if (headers.length < 2) {
            return App.UI.toast('Invalid CSV format. Please ensure it is properly comma-separated.', 'error');
        }

        const expectedHeaders = ['accountnumber', 'companyname', 'emirate', 'area', 'status', 'paymentstatus', 'initialdebt', 'outstandingamount', 'salesconsultant'];
        const headerMap = {};
        
        expectedHeaders.forEach(eh => {
            const cleanExpected = eh.replace(/[^a-z0-9]/gi, '');
            const index = headers.findIndex(h => h.trim().toLowerCase().replace(/[^a-z0-9]/gi, '') === cleanExpected);
            if (index !== -1) headerMap[eh] = index;
        });

        if (!headerMap.accountnumber || !headerMap.companyname) { App.UI.toast('CSV must contain "accountNumber" and "companyName" headers.', 'error'); return; }
        
        let existingCustomers = App.DB.get('customers');
        const existingAccountNos = new Set(existingCustomers.map(c => c.accountNo.toLowerCase()));
        let newCustomers = [];
        let skippedCount = 0;
        
        rows.forEach(row => {
            const cells = row.split(delimiter);
            const accountNo = cells[headerMap.accountnumber]?.trim();
            if (!accountNo || existingAccountNos.has(accountNo.toLowerCase())) { skippedCount++; return; }
            const newCustomer = { accountNo: accountNo, companyName: cells[headerMap.companyname]?.trim() || 'N/A', emirate: cells[headerMap.emirate]?.trim() || 'Dubai', area: cells[headerMap.area]?.trim() || 'N/A', status: cells[headerMap.status]?.trim() || 'Active', paymentStatus: cells[headerMap.paymentstatus]?.trim() || 'Pending', initialDebt: parseFloat(cells[headerMap.initialdebt]) || 0, outstanding: parseFloat(cells[headerMap.outstandingamount]) || 0, salesConsultant: cells[headerMap.salesconsultant]?.trim() || 'Unassigned' };
            newCustomers.push(newCustomer);
            existingAccountNos.add(accountNo.toLowerCase());
        });
        
        if (newCustomers.length > 0) {
            App.DB.set('customers', [...existingCustomers, ...newCustomers]);
            App.UI.toast(`Import successful! Added ${newCustomers.length} new customers.`, 'success');
            if (skippedCount > 0) { App.UI.toast(`${skippedCount} rows were skipped (duplicates or missing account #).`, 'warning'); }
        } else { App.UI.toast('No new customers to import.', 'info'); }
        
        App.UI.closeModal('import-csv-modal');
        App.Customers.render();
    }, 
    downloadSampleCSV: function() { 
        const headers = "accountNumber,companyName,emirate,area,status,paymentStatus,initialDebt,outstandingAmount,salesConsultant"; 
        const exampleRow = "DXB-123,Sample Trading LLC,Dubai,Al Quoz,Active,Overdue,50000,12500,John Doe"; 
        const csvContent = headers + "\n" + exampleRow; 
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
        const link = document.createElement("a"); const url = URL.createObjectURL(blob); 
        link.setAttribute("href", url); 
        link.setAttribute("download", "customer_import_template.csv"); 
        link.style.visibility = 'hidden'; 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
    } 
});
    Object.assign(App.Helpers, { formatCurrency: (a) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'AED', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(a), formatAbbreviatedCurrency: (num) => { if (num >= 1000000) return 'AED ' + (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M'; if (num >= 1000) return 'AED ' + (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K'; return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'AED' }).format(num); }, debounce: (f, d) => { let t; return function(...a) { clearTimeout(t); t = setTimeout(() => f.apply(this, a), d); }; }, formatDate: (dateString) => { const date = new Date(dateString); const timeZoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + timeZoneOffset).toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }); }, timeAgo(timestamp) { if (!timestamp) return 'Never'; const now = new Date(); const seconds = Math.floor((now - new Date(timestamp)) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago"; return Math.floor(seconds) + " seconds ago"; }, getScopedData(dataType) { const { currentUser } = App.state; if (!currentUser) return []; if (currentUser.role === 'admin') return App.DB.get(dataType); if (currentUser.role === 'user') { const consultantName = currentUser.assignedConsultant; const allCustomers = App.DB.get('customers'); const scopedCustomers = allCustomers.filter(c => c.salesConsultant === consultantName); if (dataType === 'customers') return scopedCustomers; const scopedCustomerIds = scopedCustomers.map(c => c.accountNo); if (dataType === 'visits') return App.DB.get('visits').filter(v => scopedCustomerIds.includes(v.customerId)); if (dataType === 'payments') return App.DB.get('payments').filter(p => scopedCustomerIds.includes(p.customerId)); } return App.DB.get(dataType); }, logActivity(action, details = '') { if (App.state.currentUser.role !== 'user') return; const log = App.DB.get('activityLog'); const now = new Date(); const newEntry = { id: Date.now(), consultant: App.state.currentUser.assignedConsultant, timestamp: now.getTime(), date: now.toISOString().slice(0, 10), time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }), action, details }; log.push(newEntry); App.DB.set('activityLog', log); let notificationMessage = `${newEntry.consultant} has ${action.toLowerCase()}`; if (details) { notificationMessage = `${newEntry.consultant} ${action.toLowerCase()} for ${details}`; } if (action.includes('recorded a payment')) { notificationMessage = `${newEntry.consultant} ${action} of ${details}`; } App.Notifications.create(notificationMessage); }, logAdminActivity(action, reason) { const auditLog = App.DB.get('auditLog'); const newEntry = { timestamp: Date.now(), user: App.state.currentUser.fullName, action, reason }; auditLog.unshift(newEntry); App.DB.set('auditLog', auditLog); },
    exportToCSV(filename, headers, data) {
        let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\r\n";
        data.forEach(rowArray => {
            let row = rowArray.map(item => `"${String(item || '').replace(/"/g, '""')}"`).join(",");
            csvContent += row + "\r\n";
        });
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },
    exportToPDF(filename, title, headers, data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(title, 14, 16);
        doc.autoTable({ head: [headers], body: data, startY: 20 });
        doc.save(filename);
    }
});
</script>
</body>
</html>
