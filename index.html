<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Recovery App - v1.9</title>

    <!-- Dependencies -->
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            /* Wuerth Group Inspired Color Palette */
            --primary: #e2000f; /* Wuerth Red */
            --success: #10b981;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #212529; /* Black/Dark Grey */
            --light: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d; /* Grey */
            --bg-color: #f0f2f5; /* Light Grey Background */
            --card-bg: #ffffff; /* White */
            --border-color: #dee2e6;

            --font-family: 'Inter', sans-serif;
            --fs-sm: 0.875rem; --fs-base: 1rem; --fs-lg: 1.125rem; --fs-xl: 1.25rem; --fs-2xl: 1.5rem; --fs-3xl: 1.875rem;
            --spacing-1: 0.25rem; --spacing-2: 0.5rem; --spacing-4: 1rem; --spacing-6: 1.5rem; --spacing-8: 2rem;
            --transition-speed: 0.2s;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        /* --- Dark Theme --- */
        body[data-theme="dark"] {
            --primary: #e2000f;
            --success: #10b981;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #f8f9fa;
            --light: #212529;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #343a40;
        }
        body[data-theme="dark"] .btn-primary:hover:not(:disabled) { background: linear-gradient(to bottom, #ff333f, #e2000f); }
        body[data-theme="dark"] .btn-outline { background-color: var(--card-bg); border-color: var(--border-color); color: var(--text-primary); }
        body[data-theme="dark"] .btn-outline:hover:not(:disabled) { background-color: var(--bg-color); }
        body[data-theme="dark"] .data-table tbody tr:hover { background-color: #2c2c2c; }
        body[data-theme="dark"] .searchable-dropdown-item:hover { background-color: var(--bg-color); }
        body[data-theme="dark"] .detail-tab-btn:hover, body[data-theme="dark"] .detail-tab-btn.active { background-color: var(--dark); color: black; border-color: var(--dark); }
        body[data-theme="dark"] .leaflet-tile { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }


        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-primary); font-size: var(--fs-base); line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        .app-container { display: grid; grid-template-columns: 250px 1fr; grid-template-rows: auto 1fr; grid-template-areas: "sidebar header" "sidebar main"; height: 100vh; transition: grid-template-columns var(--transition-speed) ease; }
        .sidebar { grid-area: sidebar; background-color: var(--card-bg); border-right: 1px solid var(--border-color); padding: var(--spacing-4); display: flex; flex-direction: column; transition: transform var(--transition-speed) ease, background-color var(--transition-speed) ease; z-index: 1000; }
        .main-header { grid-area: header; background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); padding: var(--spacing-4) var(--spacing-6); display: flex; justify-content: space-between; align-items: center; transition: background-color var(--transition-speed) ease; }
        .main-content { grid-area: main; overflow-y: auto; padding: var(--spacing-6); background-color: var(--bg-color); }
        .page { display: none; } .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 1024px) { .app-container { grid-template-columns: 80px 1fr; } .sidebar .logo-text, .sidebar .nav-text, .sidebar-heading { display: none; } .sidebar .nav-link { justify-content: center; } }
        @media (max-width: 768px) { .app-container { grid-template-columns: 1fr; grid-template-areas: "header" "main"; } .sidebar { position: fixed; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: var(--shadow); } .sidebar.open { transform: translateX(0); } .sidebar .logo-text, .sidebar .nav-text, .sidebar-heading { display: inline; } .sidebar .nav-link { justify-content: flex-start; } .hamburger { display: block !important; } }
        
        /* --- Login Page Enhancements --- */
        #login-page {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: linear-gradient(135deg, #f0f2f5 0%, #e6e9ed 100%);
            overflow: hidden;
            position: relative;
        }
        .background-bubbles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; list-style: none; }
        .background-bubbles li { position: absolute; bottom: -160px; width: 40px; height: 40px; background-color: rgba(226, 0, 15, 0.15); border-radius: 50%; animation: floatUp 20s infinite linear; }
        .background-bubbles li:nth-child(1) { left: 10%; width: 80px; height: 80px; animation-delay: 0s; }
        .background-bubbles li:nth-child(2) { left: 20%; width: 30px; height: 30px; animation-delay: 2s; animation-duration: 12s; }
        .background-bubbles li:nth-child(3) { left: 25%; width: 50px; height: 50px; animation-delay: 4s; }
        .background-bubbles li:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .background-bubbles li:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .background-bubbles li:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; background-color: rgba(226, 0, 15, 0.1); }
        .background-bubbles li:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; background-color: rgba(226, 0, 15, 0.08); }
        .background-bubbles li:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .background-bubbles li:nth-child(9) { left: 85%; width: 45px; height: 45px; animation-delay: 2s; animation-duration: 25s; }
        .background-bubbles li:nth-child(10) { left: 90%; width: 15px; height: 15px; animation-delay: 11s; animation-duration: 35s; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-120vh); opacity: 0; } }

        #login-page .login-card {
            width: 100%; max-width: 400px; padding: var(--spacing-8); border-radius: 16px; text-align: center;
            animation: fadeInUp 0.6s ease-out both;
            z-index: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        #login-page .form-group label { text-align: left; } 
        .login-card .logo { animation: fadeIn 0.8s 0.2s ease-out both; text-align: center; }
        .login-card h2 { animation: fadeIn 0.8s 0.4s ease-out both; }
        .login-card .form-group { animation: slideInFromBottom 0.6s ease-out both; }
        .login-card .form-group:nth-of-type(1) { animation-delay: 0.6s; }
        .login-card .form-group:nth-of-type(2) { animation-delay: 0.7s; }
        #login-page button[type="submit"] {
            animation: slideInFromBottom 0.6s 0.8s ease-out both;
            padding: 0.75rem 1.5rem;
            font-size: var(--fs-lg);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        #login-page button[type="submit"]:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 20px -5px rgba(226, 0, 15, 0.4);
        }
        #login-page .input-wrapper { position: relative; }
        #login-page .input-wrapper i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); transition: color 0.2s ease; }
        #login-page .input-wrapper .form-control { padding-left: 2.75rem; background-color: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.3); color: var(--text-primary); }
        #login-page .input-wrapper .form-control::placeholder { color: var(--text-secondary); opacity: 0.8; }
        #login-page .input-wrapper .form-control:focus { background-color: rgba(255, 255, 255, 0.3); border-color: var(--primary); box-shadow: 0 0 0 3px rgba(226, 0, 15, 0.2); }
        #login-page .input-wrapper .form-control:focus ~ i { color: var(--primary); }
        
        #login-error { background-color: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); padding: var(--spacing-2); border-radius: 8px; font-weight: 500; display: none; }
        #login-error.show { display: block; animation: shakeError 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shakeError { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        /* --- End Login Page Enhancements --- */

        .logo img { max-width: 250px; height: auto; margin: 0 auto; }
        .sidebar .logo { text-align: center; }
        .sidebar .logo img { max-width: 180px; margin: 0 auto; }

        .sidebar-heading { font-size: var(--fs-sm); color: var(--text-secondary); text-transform: uppercase; font-weight: 600; padding: var(--spacing-4); margin-top: var(--spacing-4); }
        .nav-link { display: flex; align-items: center; gap: var(--spacing-4); padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-weight: 600; margin-bottom: var(--spacing-1); transition: background-color var(--transition-speed), color var(--transition-speed); }
        .nav-link:hover { background-color: var(--bg-color); color: var(--text-primary); }
        .nav-link.active { background-color: var(--primary); color: white; box-shadow: 0 4px 8px rgba(226, 0, 15, 0.3); }
        .nav-link.active i { color: white; }
        .nav-link i { width: 20px; text-align: center; color: var(--text-secondary); transition: color var(--transition-speed); }
        .hamburger { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.25rem; cursor: pointer; }
        .card { background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); box-shadow: var(--shadow); border: 1px solid var(--border-color); transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease, background-color var(--transition-speed) ease; }
        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4); padding-bottom: var(--spacing-4); border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: var(--fs-base); font-weight: 600; color: var(--text-secondary); }
        .chart-container { position: relative; height: 350px; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        .data-table thead { border-bottom: 2px solid var(--dark); }
        .data-table tbody tr { border-bottom: 1px solid var(--border-color); opacity: 0; transform: translateY(10px); animation: fadeInUpTableRow 0.5s ease-out forwards; }
        .data-table th, .data-table td { padding: var(--spacing-4); text-align: left; vertical-align: middle; border-bottom: none; }
        .data-table th { font-weight: 600; cursor: pointer; text-transform: uppercase; font-size: var(--fs-sm); color: var(--text-secondary); }
        .data-table tbody tr:hover { background-color: #f8f9fa; }
        .data-table th[data-sort]::after { content: ' \f0dc'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #ccc; }
        .data-table th[data-sort].sort-asc::after { content: ' \f0de'; color: var(--primary); }
        .data-table th[data-sort].sort-desc::after { content: ' \f0dd'; color: var(--primary); }
        .btn { padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; min-height: 44px; min-width: 44px; transition: all var(--transition-speed) ease; display: inline-flex; justify-content: center; align-items: center; gap: var(--spacing-2); text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:active:not(:disabled) { transform: translateY(0); box-shadow: inset 0 2px 2px rgba(0,0,0,0.1); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(to bottom, #ff1a28, #e2000f); color: white; border-color: #c0000d; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-primary:hover:not(:disabled) { background: linear-gradient(to bottom, #ff333f, #e2000f); }
        .btn-success { background: linear-gradient(to bottom, #12d493, #10b981); color: white; border-color: #0e9a6b; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-success:hover:not(:disabled) { background: linear-gradient(to bottom, #24e0a1, #10b981); }
        .btn-danger { background: linear-gradient(to bottom, #e34654, #dc3545); color: white; border-color: #b02a37; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-danger:hover:not(:disabled) { background: linear-gradient(to bottom, #ea5c69, #dc3545); }
        .btn-warning { background: linear-gradient(to bottom, #ffca2c, #ffc107); color: var(--dark); border-color: #d39e00; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), var(--shadow); } .btn-warning:hover:not(:disabled) { background: linear-gradient(to bottom, #ffd55b, #ffc107); }
        .btn-outline { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); text-shadow: none; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5); } .btn-outline:hover:not(:disabled) { background-color: var(--bg-color); }
        .form-group { margin-bottom: var(--spacing-4); }
        .form-group label { display: block; font-weight: 500; margin-bottom: var(--spacing-2); }
        .form-control { width: 100%; padding: var(--spacing-2) var(--spacing-4); border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-primary); font-size: var(--fs-base); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal.active { display: flex; animation: fadeIn 0.3s; }
        .modal-content { width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); transition: background-color var(--transition-speed) ease; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-4); }
        .modal-footer { margin-top: var(--spacing-6); display: flex; justify-content: flex-end; gap: var(--spacing-2); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInFromBottom { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUpTableRow { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .status-badge { padding: 4px 10px; border-radius: 999px; font-size: var(--fs-sm); font-weight: 600; text-transform: uppercase; border: 1px solid; }
        .status-badge.admin { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; border-color: #dc3545; }
        .status-badge.user { background-color: rgba(226, 0, 15, 0.1); color: #e2000f; border-color: #e2000f; }
        .status-badge.paid, .status-badge.active, .status-badge.cleared, .status-badge.complete, .status-badge.completed { background-color: rgba(16, 185, 129, 0.1); color: #10b981; border-color: #10b981; }
        .status-badge.pending { background-color: rgba(255, 193, 7, 0.1); color: #d9a007; border-color: #ffc107;}
        .status-badge.overdue { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; border-color: #dc3545; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4); }
        .form-grid .full-width { grid-column: 1 / -1; }
        .detail-info-grid, .kpi-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-6); }
        .detail-info-card { background: var(--bg-color); padding: var(--spacing-4); border-radius: 8px; border: 1px solid var(--border-color); }
        .detail-info-card .label { font-size: var(--fs-sm); color: var(--text-secondary); margin-bottom: var(--spacing-1); text-transform: uppercase; }
        .detail-info-card .value, .kpi-card .value { font-weight: 600; font-size: var(--fs-lg); }
        .kpi-card {background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .kpi-card .title {font-size: var(--fs-base); font-weight: 600; color: var(--text-secondary);}
        .kpi-card .value {font-size: var(--fs-3xl); font-weight: 700;}
        .filter-btn { box-shadow: none; }
        .filter-btn.active { background-color: var(--dark); color: white; border-color: var(--dark); }
        .detail-tab-btn { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: var(--spacing-1) var(--spacing-4); font-size: var(--fs-sm); font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; gap: var(--spacing-2); color: var(--text-secondary); }
        .detail-tab-btn:hover { background-color: var(--dark); color: white; border-color: var(--dark); }
        .detail-tab-btn.active { background-color: var(--dark); color: white; border-color: var(--dark); box-shadow: var(--shadow); }
        .page-header { color: var(--text-primary); margin-bottom: var(--spacing-4); } .page-header h2 { font-size: var(--fs-2xl); font-weight: 700; } .page-header p { color: var(--text-secondary); }
        .progress-bar { width: 100%; height: 8px; background-color: var(--bg-color); border-radius: 999px; overflow: hidden; border: 1px solid var(--border-color); }
        .progress-bar-inner { height: 100%; background-color: var(--primary); border-radius: 999px; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); width: 0; }
        .hidden { display: none !important; } .d-flex { display: flex; } .gap-2 { gap: var(--spacing-2); } .gap-4 { gap: var(--spacing-4); } .mt-4 { margin-top: var(--spacing-4); } .mb-4 { margin-bottom: var(--spacing-4); }
        .justify-content-between { justify-content: space-between; } .align-items-center { align-items: center; } .flex-wrap { flex-wrap: wrap; }
        
        .file-upload-wrapper { border: 2px dashed var(--border-color); border-radius: 8px; padding: var(--spacing-6); text-align: center; cursor: pointer; transition: border-color var(--transition-speed); }
        .file-upload-wrapper:hover, .file-upload-wrapper.dragover { border-color: var(--primary); }
        .file-upload-wrapper p { margin-top: var(--spacing-2); margin-bottom: var(--spacing-2); }
        .info-box { background: var(--bg-color); border: 1px solid var(--border-color); padding: var(--spacing-4); border-radius: 8px; margin: var(--spacing-4) 0; font-size: var(--fs-sm); }
        .info-box p { margin-bottom: var(--spacing-2); }
        .info-box code { background: var(--border-color); padding: 2px 6px; border-radius: 4px; }

        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-6); }
        .report-card { background-color: var(--card-bg); border-radius: 12px; padding: var(--spacing-6); box-shadow: var(--shadow); border: 1px solid var(--border-color); text-decoration: none; color: var(--text-primary); transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .report-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .report-card .icon { font-size: 1.5rem; color: var(--primary); margin-bottom: var(--spacing-4); }
        .report-card h4 { font-weight: 600; font-size: var(--fs-lg); margin-bottom: var(--spacing-2); }
        .report-card p { font-size: var(--fs-sm); color: var(--text-secondary); }

        .searchable-dropdown { position: relative; }
        .searchable-dropdown-results { position: absolute; top: 100%; left: 0; right: 0; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 2010; box-shadow: var(--shadow); }
        .searchable-dropdown-item { padding: var(--spacing-2) var(--spacing-4); cursor: pointer; line-height: 1.4; }
        .searchable-dropdown-item:hover { background-color: var(--bg-color); }
        .searchable-dropdown-item.no-results { color: var(--text-secondary); cursor: default; }
        .sdi-main { font-weight: 500; color: var(--text-primary); }
        .sdi-secondary { font-size: var(--fs-sm); color: var(--text-secondary); }

        .input-with-icon { position: relative; }
        .input-with-icon .form-control { padding-right: 2.5rem; }
        .input-with-icon .icon { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); cursor: pointer; }

        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; transition: opacity 0.3s; }

        .pagination-controls { display: flex; justify-content: space-between; align-items: center; padding-top: var(--spacing-4); border-top: 1px solid var(--border-color); margin-top: var(--spacing-4); }
        .empty-state { text-align: center; padding: var(--spacing-8); color: var(--text-secondary); }
        .empty-state i { font-size: 3rem; margin-bottom: var(--spacing-4); display: block; }
        .empty-state h4 { font-size: var(--fs-lg); margin-bottom: var(--spacing-2); color: var(--text-primary); }
        .empty-state p { margin-bottom: var(--spacing-4); }
        
        .numbered-marker {
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }

        /* --- Accessibility --- */
        *:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; border-radius: 4px; }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
    
    <style id="wuerth-glossy-theme">
        /* Glossy Theme Enhancements */
        .card, .sidebar, .main-header, .modal-content {
            background: linear-gradient(to bottom, #ffffff, #fdfdfd);
        }
        body[data-theme="dark"] .card,
        body[data-theme="dark"] .sidebar,
        body[data-theme="dark"] .main-header,
        body[data-theme="dark"] .modal-content {
            background: linear-gradient(to bottom, #2a2a2a, #1e1e1e);
        }

        .nav-link.active {
            background: linear-gradient(to bottom, #ff1a28, #e2000f);
            border: 1px solid #c0000d;
        }
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(226, 0, 15, 0.2);
        }
    </style>
</head>
<body>
    <!-- App containers that will be populated by JavaScript -->
    <div id="login-page"></div>
    <div id="app" class="app-container hidden"></div>

    <!-- Modal containers -->
    <div id="customer-modal" class="modal"></div>
    <div id="user-modal" class="modal"></div>
    <div id="payment-modal" class="modal"></div>
    <div id="visit-modal" class="modal"></div>
    <div id="import-csv-modal" class="modal"></div>
    <div id="customer-detail-modal" class="modal"></div>
    <div id="visit-notes-modal" class="modal"></div>
    <div id="payment-detail-modal" class="modal"></div>
    <div id="consultant-modal" class="modal"></div>
    <div id="visit-detail-modal" class="modal"></div>
    <div id="consultant-customers-modal" class="modal"></div>
    <div id="reassign-customers-modal" class="modal"></div>
    <div id="forecast-modal" class="modal"></div>
    <div id="customer-forecast-modal" class="modal"></div>
    <div id="report-modal" class="modal"></div>

    <!-- Notification Dropdown -->
    <div id="notification-dropdown" class="card hidden" style="position: absolute; width: 350px; z-index: 1001; max-height: 400px; overflow-y: auto; padding: var(--spacing-4);">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 style="margin: 0;">Notifications</h4>
        </div>
        <ul id="notification-list" style="list-style: none; padding: 0; margin: 0;">
            <!-- Notifications will be rendered here -->
        </ul>
    </div>
    
    <!-- Command Palette Modal -->
    <div id="command-palette-modal" class="modal" style="align-items: flex-start; padding-top: 10vh;">
        <div class="modal-content" style="max-width: 600px; padding: 0;">
            <div class="d-flex align-items-center gap-2 p-3" style="border-bottom: 1px solid var(--border-color);">
                <i class="fas fa-search" style="color: var(--text-secondary);"></i>
                <input type="text" id="command-palette-input" class="form-control" placeholder="Search customers or payments..." style="border: none; background: transparent; box-shadow: none;">
            </div>
            <div id="command-palette-results" style="max-height: 400px; overflow-y: auto; padding: var(--spacing-2);"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div id="sidebar-overlay" class="hidden"></div>
		<script>
    document.addEventListener('DOMContentLoaded', () => App.init());
    
    const App = {
        state: { currentUser: null, reports: { activityView: 'summary' }, activePage: 'dashboard', activeCustomerId: null, 
            visits: { activeView: 'list', filter: 'Upcoming', startDate: '', endDate: '', search: '', consultantFilter: 'all', mapDate: new Date().toISOString().slice(0, 10), mapConsultant: 'all' },
            payments: { search: '', statusFilter: 'all', methodFilter: 'all'},
            adminDashboardView: 'overview', dayTimerInterval: null, dashboardInterval: null, paymentFlowOrigin: null, breakStartTime: null, totalBreakTime: 0,
            tableSorts: {
                customers: { column: 'accountNo', order: 'asc' },
                users: { column: 'username', order: 'asc' },
                consultants: { column: 'name', order: 'asc' },
                visits: { column: 'dateTime', order: 'desc' },
                payments: { column: 'date', order: 'desc' },
                changelog: { column: 'timestamp', order: 'desc' },
            },
            pagination: {
                customers: { currentPage: 1, rowsPerPage: 10 },
                users: { currentPage: 1, rowsPerPage: 10 },
                consultants: { currentPage: 1, rowsPerPage: 10 },
                visits: { currentPage: 1, rowsPerPage: 10 },
                payments: { currentPage: 1, rowsPerPage: 10 },
                changelog: { currentPage: 1, rowsPerPage: 25 },
            }
        },
        init() { this.UI.hydrate(); this.DB.initialize(); this.Auth.checkSession(); this.UI.setupEventListeners(); this.CommandPalette.init(); this.Notifications.init(); this.Import.init(); this.UI.applyTheme(); },
        Auth: {}, DB: {}, UI: {}, Dashboard: {}, Customers: {}, Visits: {}, Payments: {}, Reports: {}, Analytics: {}, Consultants: {}, Users: {}, Notifications: {}, CommandPalette: {}, Helpers: {}, ChangeLog: {}, Import: {}, Settings: {}
    };
    
    Object.assign(App.Auth, { 
        login(u, p) { 
            const users = App.DB.get('users');
            const encodedP = btoa(p); // Encode the password the user entered
            const userIndex = users.findIndex(user => user.username === u && user.password === encodedP); // Compare with the encoded password
            if (userIndex > -1) { 
                const user = users[userIndex];
                user.lastLogin = Date.now();
                App.DB.set('users', users);
                App.state.currentUser = user; 
                sessionStorage.setItem('user', JSON.stringify(App.state.currentUser)); 
                App.UI.showApp(); 
                return true; 
            } 
            return false; 
        }, 
        logout() { App.state.currentUser = null; sessionStorage.removeItem('user'); clearInterval(App.state.dayTimerInterval); clearInterval(App.state.dashboardInterval); App.UI.showLogin(); }, 
        checkSession() { const user = sessionStorage.getItem('user'); if (user) { App.state.currentUser = JSON.parse(user); App.UI.showApp(); } else { App.UI.showLogin(); } }, 
        checkRole() { document.querySelectorAll('[data-role="admin"]').forEach(el => { el.style.display = (App.state.currentUser.role === 'admin') ? '' : 'none'; }); document.querySelectorAll('[data-role="user"]').forEach(el => { el.style.display = (App.state.currentUser.role === 'user') ? '' : 'none'; }); } 
    });
    Object.assign(App.DB, { 
        initialize() {
            if (!localStorage.getItem('consultants')) localStorage.setItem('consultants', JSON.stringify([]));
            if (!localStorage.getItem('users')) localStorage.setItem('users', JSON.stringify([]));
            if (!localStorage.getItem('customers')) localStorage.setItem('customers', JSON.stringify([]));
            if (!localStorage.getItem('visits')) localStorage.setItem('visits', JSON.stringify([]));
            if (!localStorage.getItem('payments')) localStorage.setItem('payments', JSON.stringify([]));
            if (!localStorage.getItem('activityLog')) localStorage.setItem('activityLog', JSON.stringify([]));
            if (!localStorage.getItem('notifications')) localStorage.setItem('notifications', JSON.stringify([]));
            if (!localStorage.getItem('changeLog')) localStorage.setItem('changeLog', JSON.stringify([]));
            if (!localStorage.getItem('forecasts')) localStorage.setItem('forecasts', JSON.stringify([]));

            const users = this.get('users');
            if (users.length === 0) {
                console.log("No users found. Creating a default admin account.");
                const defaultAdmin = { 
                    id: 1, 
                    username: 'admin', 
                    fullName: 'Admin User', 
                    password: btoa('admin123'), // Encode the default password
                    role: 'admin', 
                    department: 'Administration', 
                    lastLogin: null, 
                    assignedConsultantId: null 
                };
                this.set('users', [defaultAdmin]);
                console.log("Default admin created. Username: admin, Password: admin123");
            }

            this.runMigrations();
        }, 
        runMigrations() {
            const dataModelVersion = parseInt(localStorage.getItem('dataModelVersion') || '1');
            if (dataModelVersion < 2) {
                console.log("Running data migration to v2 (Consultant IDs)...");
                const consultants = this.get('consultants');
                const consultantMap = consultants.reduce((map, c) => { map[c.name] = c.id; return map; }, {});

                let customers = this.get('customers');
                customers.forEach(c => { if (c.salesConsultant && !c.salesConsultantId) c.salesConsultantId = consultantMap[c.salesConsultant]; });
                this.set('customers', customers);

                let users = this.get('users');
                users.forEach(u => { if (u.assignedConsultant && !u.assignedConsultantId) u.assignedConsultantId = consultantMap[u.assignedConsultant]; });
                this.set('users', users);

                let visits = this.get('visits');
                visits.forEach(v => { if (v.collector && !v.collectorId) v.collectorId = consultantMap[v.collector]; });
                this.set('visits', visits);

                let activityLog = this.get('activityLog');
                activityLog.forEach(log => { if (log.consultant && !log.consultantId) log.consultantId = consultantMap[log.consultant]; });
                this.set('activityLog', activityLog);

                localStorage.setItem('dataModelVersion', '2');
                console.log("Migration to v2 complete.");
            }
            if (dataModelVersion < 3) {
                console.log("Running data migration to v3 (Encode Passwords)...");
                let users = this.get('users');
                let updated = false;
                users.forEach(user => {
                    // Check if password is not already encoded (simple check)
                    try {
                        atob(user.password);
                    } catch(e) {
                        user.password = btoa(user.password);
                        updated = true;
                    }
                });
                if (updated) {
                    this.set('users', users);
                    console.log("All existing user passwords have been encoded.");
                }
                localStorage.setItem('dataModelVersion', '3');
                console.log("Migration to v3 complete.");
            }
        },
        get: (key) => JSON.parse(localStorage.getItem(key) || '[]'), 
        set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
    });
    Object.assign(App.UI, { 
        intersectionObserver: null,
        hydrate() { 
            document.getElementById('login-page').innerHTML = `
                <ul class="background-bubbles"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul>
                <div class="login-card">
                    <div class="logo"><img src="https://i.ibb.co/pvvsMy1X/Wurth-Gulf-CMYK-PNG-01.png" alt="Wuerth Gulf Logo"></div>
                    <h2 style="font-weight: 500; color: var(--text-secondary); margin-bottom: var(--spacing-6);">Customer Recovery App</h2>
                    <p id="login-error">Invalid credentials.</p>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <div class="input-wrapper">
                                <i class="fas fa-user"></i>
                                <input type="text" id="username" class="form-control" required placeholder="Enter your username">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <div class="input-wrapper">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="password" class="form-control" required placeholder="Enter your password">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                    </form>
                    <div class="mt-4" style="color: var(--text-secondary); font-size: var(--fs-sm);"></div>
                </div>`; 
            document.getElementById('app').innerHTML = `<aside class="sidebar"><div class="logo logo-text"><img src="https://i.ibb.co/pvvsMy1X/Wurth-Gulf-CMYK-PNG-01.png" alt="Wuerth Gulf Logo"></div><nav><div class="sidebar-heading">Main</div><ul style="list-style:none;"><li><a href="#dashboard" class="nav-link active" data-page="dashboard"><i class="fas fa-chart-pie"></i> <span class="nav-text">Dashboard</span></a></li><li><a href="#customers" class="nav-link" data-page="customers"><i class="fas fa-users"></i> <span class="nav-text">Customers</span></a></li><li><a href="#visits" class="nav-link" data-page="visits"><i class="fas fa-calendar-alt"></i> <span class="nav-text">Visits & Follow-ups</span></a></li><li><a href="#payments" class="nav-link" data-page="payments"><i class="fas fa-credit-card"></i> <span class="nav-text">Payments</span></a></li><li data-role="admin"><a href="#analytics" class="nav-link" data-page="analytics"><i class="fas fa-chart-line"></i> <span class="nav-text">Analytics</span></a></li><li data-role="admin"><a href="#reports" class="nav-link" data-page="reports"><i class="fas fa-file-alt"></i> <span class="nav-text">Reports</span></a></li></ul><div data-role="admin"><div class="sidebar-heading">Administration</div><ul style="list-style:none;"><li><a href="#consultants" class="nav-link" data-page="consultants"><i class="fas fa-user-tie"></i> <span class="nav-text">Consultants</span></a></li><li><a href="#users" class="nav-link" data-page="users"><i class="fas fa-users-cog"></i> <span class="nav-text">User Management</span></a></li><li><a href="#changelog" class="nav-link" data-page="changelog"><i class="fas fa-history"></i> <span class="nav-text">Change Log</span></a></li><li><a href="#settings" class="nav-link" data-page="settings"><i class="fas fa-cog"></i> <span class="nav-text">Settings</span></a></li></ul></div></nav></aside><header class="main-header"><button class="hamburger" id="hamburger-menu"><i class="fas fa-bars"></i></button><div id="page-title" style="font-weight: 600; font-size: var(--fs-lg);">Dashboard</div><div class="d-flex gap-4 align-items-center"><div id="notification-bell-wrapper" data-role="admin" style="position: relative;"><button id="notification-bell-btn" class="btn btn-outline" style="min-width:auto; padding: 0.5rem; border-radius: 50%; width: 44px; height: 44px;"><i class="fas fa-bell"></i></button><span id="notification-badge" class="hidden" style="position: absolute; top: -5px; right: -5px; background-color: var(--danger); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: var(--fs-sm); display: flex; justify-content: center; align-items: center; font-weight: 600; border: 2px solid var(--card-bg);">0</span></div><button id="theme-toggle-btn" class="btn btn-outline" style="min-width:auto; padding: 0.5rem; border-radius: 50%; width: 44px; height: 44px;"><i class="fas fa-moon"></i></button><div class="d-flex gap-2 align-items-center"><span id="username-display" style="font-weight: 500;"></span><button id="logout-btn" class="btn btn-outline" style="min-width:auto; padding: 0.5rem;"><i class="fas fa-sign-out-alt"></i></button></div></div></header><main class="main-content"><section id="dashboard-page" class="page active"></section><section id="customers-page" class="page"></section><section id="visits-page" class="page"></section><section id="payments-page" class="page"></section><section id="analytics-page" class="page" data-role="admin"></section><section id="reports-page" class="page" data-role="admin"></section><section id="consultants-page" class="page" data-role="admin"></section><section id="users-page" class="page" data-role="admin"></section><section id="changelog-page" class="page" data-role="admin"></section><section id="settings-page" class="page" data-role="admin"></section></main>`; 
            document.getElementById('customers-page').innerHTML = `<div class="kpi-card-grid" data-role="admin"><div class="kpi-card"><div class="title">Total Customers</div><div id="customer-kpi-total" class="value">0</div></div><div class="kpi-card"><div class="title">Total Outstanding</div><div id="customer-kpi-outstanding" class="value">0</div></div><div class="kpi-card"><div class="title">Active Accounts</div><div id="customer-kpi-active" class="value">0</div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><h3 class="card-title">Manage Customers</h3><div class="d-flex gap-2 flex-wrap align-items-center"><input type="search" id="customer-search" placeholder="Search customers..." class="form-control" style="width: auto;"><select id="customer-status-filter" class="form-control" style="width: auto;"><option value="all">All Status</option><option value="Active">Active</option><option value="Inactive">Inactive</option></select><select id="customer-payment-filter" class="form-control" style="width: auto;"><option value="all">All Payments</option><option value="Pending">Pending</option><option value="Paid">Paid</option><option value="Cleared">Cleared</option><option value="Overdue">Overdue</option></select><div data-role="admin" class="d-flex gap-2"><button class="btn btn-outline" id="export-customers-csv"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" id="export-customers-pdf"><i class="fas fa-file-pdf"></i> PDF</button><button class="btn btn-outline" id="import-customer-btn"><i class="fas fa-upload"></i> Import</button><button class="btn btn-primary" id="add-customer-btn"><i class="fas fa-plus"></i> Add Customer</button></div></div></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="accountNo">Account #</th><th data-sort="companyName">Company Name</th><th data-sort="outstanding">Outstanding</th><th data-sort="forecastAmount">Forecast</th><th data-sort="salesConsultantId">Consultant</th><th data-sort="paymentStatus">Payment Status</th><th>Actions</th></tr></thead><tbody id="customer-table-body"></tbody></table></div><div id="customers-pagination" class="pagination-controls"></div></div>`; 
            document.getElementById('users-page').innerHTML = `<div class="page-header"><h2 >User Management</h2><p >Home > Users</p></div><div class="card"><div class="card-header"><h3 class="card-title">User List</h3><button id="add-user-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add User</button></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="username">Username</th><th data-sort="fullName">Full Name</th><th data-sort="role">Role</th><th data-sort="assignedConsultantId">Assigned Consultant</th><th data-sort="department">Department</th><th data-sort="lastLogin">Last Login</th><th>Actions</th></tr></thead><tbody id="user-table-body"></tbody></table></div><div id="users-pagination" class="pagination-controls"></div></div>`; 
            document.getElementById('user-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 id="user-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('user-modal')">&times;</button></div><form id="user-form"><input type="hidden" id="user-id-hidden"><div class="form-grid"><div class="form-group"><label for="username">Username*</label><input type="text" id="username" class="form-control" required></div><div class="form-group"><label for="fullName">Full Name*</label><input type="text" id="fullName" class="form-control" required></div></div><div class="form-group"><label for="password">Password*</label><input type="password" id="password" class="form-control" required></div><div class="form-group"><label for="department">Department</label><input type="text" id="department" class="form-control" placeholder="e.g., Collections"></div><div class="form-group"><label for="role">Role</label><select id="role" class="form-control"><option value="user">User</option><option value="admin">Admin</option></select></div><div class="form-group" id="assigned-consultant-group"><label for="assignedConsultantId">Assigned Sales Consultant</label><select id="assignedConsultantId" class="form-control"></select></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('user-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save User</button></div></form></div>`;
            document.getElementById('dashboard-page').innerHTML = `<div id="admin-dashboard-wrapper" class="hidden"><div class="d-flex justify-content-between align-items-center mb-4 flex-wrap"><h2 class="page-header" style="margin-bottom: 0;">Admin Dashboard</h2><button id="toggle-dashboard-view-btn" class="btn btn-outline"><i class="fas fa-chart-bar"></i> Switch to Chart View</button></div><div id="admin-dashboard-content"></div></div><div id="chart-dashboard-wrapper"><div id="attendance-controls" class="mb-4"></div><div id="todays-agenda" class="mb-4"></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-6);"><div class="card"><div class="card-title">Total Customers</div><div id="stat-total-customers" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card"><div class="card-title">Total Outstanding</div><div id="stat-outstanding-debt" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card" id="user-dashboard-forecast-card"><div class="card-title">Total Forecast</div><div id="stat-total-forecast" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card"><div class="card-title">Recovered This Month</div><div id="stat-recovered-this-month" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div><div class="card"><div class="card-title">Upcoming Visits</div><div id="stat-upcoming-visits" style="font-size: var(--fs-3xl); font-weight: 700;">0</div></div></div><div id="recovery-progress-card" class="card mb-4"></div><div id="dashboard-bottom-content"></div></div>`; 
            document.getElementById('visits-page').innerHTML = `<div class="kpi-card-grid"><div class="kpi-card"><div class="title">Upcoming Visits</div><div id="visit-kpi-upcoming" class="value">0</div></div><div class="kpi-card"><div class="title">Overdue Visits</div><div id="visit-kpi-overdue" class="value">0</div></div><div class="kpi-card"><div class="title">Completed Today</div><div id="visit-kpi-completed-today" class="value">0</div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><div class="d-flex gap-2"><button class="btn btn-outline visit-view-tab active" data-view="list"><i class="fas fa-list"></i> List View</button><button class="btn btn-outline visit-view-tab" data-view="calendar"><i class="fas fa-calendar"></i> Calendar View</button><button class="btn btn-outline visit-view-tab" data-view="map"><i class="fas fa-map-marked-alt"></i> Map View</button></div><div class="d-flex gap-2"><div data-role="admin" class="d-flex gap-2"><button class="btn btn-outline" id="export-visits-csv"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" id="export-visits-pdf"><i class="fas fa-file-pdf"></i> PDF</button></div><button class="btn btn-primary" id="schedule-visit-btn"><i class="fas fa-plus"></i> Schedule a Visit</button></div></div><div id="list-view-controls" class="d-flex justify-content-between align-items-center my-4 flex-wrap gap-4"><div class="d-flex gap-2 flex-wrap"><div class="d-flex gap-2" data-role="admin"><input type="search" id="visit-search" placeholder="Search customer or purpose..." class="form-control" style="width: auto;"><select id="visit-consultant-filter" class="form-control" style="width: auto;"><option value="all">All Consultants</option></select></div><button class="btn filter-btn visit-filter-btn active" data-filter="Upcoming">Upcoming</button><button class="btn filter-btn visit-filter-btn" data-filter="Today">Today</button><button class="btn filter-btn visit-filter-btn" data-filter="Overdue">Overdue</button><button class="btn filter-btn visit-filter-btn" data-filter="All">All Visits</button></div><div class="d-flex gap-2 align-items-center flex-wrap"><input type="date" id="visit-start-date" class="form-control" style="width:auto;"><div class="d-flex gap-1"><button class="btn btn-outline" id="set-visit-date-today">Today</button><button class="btn btn-outline" id="set-visit-date-tomorrow">Tomorrow</button></div><span>to</span><input type="date" id="visit-end-date" class="form-control" style="width:auto;"><button class="btn btn-primary" id="visit-date-apply">Apply</button></div></div><div id="map-view-controls" class="hidden d-flex justify-content-between align-items-center my-4 flex-wrap gap-4"><div class="d-flex gap-2 flex-wrap align-items-center"><div data-role="admin" class="form-group mb-0"><label for="map-consultant-filter">Consultant</label><select id="map-consultant-filter" class="form-control"></select></div><div class="form-group mb-0"><label for="map-date-filter">Date</label><input type="date" id="map-date-filter" class="form-control"></div></div></div><div id="list-view-content" class="visit-view-content"><div class="table-container"><table class="data-table"><thead></thead><tbody id="visit-table-body"></tbody></table></div><div id="visits-pagination" class="pagination-controls"></div></div><div id="calendar-view-content" class="visit-view-content hidden"><div id="calendar-view" style="min-height: 600px;"></div></div><div id="map-view-content" class="visit-view-content hidden"><div id="map-view" style="height: 600px; border-radius: 8px;"></div></div></div>`; 
            document.getElementById('payments-page').innerHTML = `<div class="kpi-card-grid"><div class="kpi-card"><div class="title">Recovered This Month</div><div id="payment-kpi-recovered-month" class="value">0</div></div><div class="kpi-card"><div class="title">Total Payments Recorded</div><div id="payment-kpi-total-count" class="value">0</div></div><div class="kpi-card"><div class="title">Pending Payments</div><div id="payment-kpi-pending" class="value">0</div></div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2"><h3 class="card-title">Recent Payments</h3><div class="d-flex gap-2"><input type="search" id="payment-search" placeholder="Search customer..." class="form-control" style="width: auto;"><select id="payment-status-filter" class="form-control" style="width: auto;"><option value="all">All Status</option><option>Completed</option><option>Pending</option><option>Failed</option></select><select id="payment-method-filter" class="form-control" style="width: auto;"><option value="all">All Methods</option><option>Bank Transfer</option><option>Cheque</option><option>Cash</option></select></div><div class="d-flex gap-2"><div data-role="admin" class="d-flex gap-2"><button class="btn btn-outline" id="export-payments-csv"><i class="fas fa-file-csv"></i> CSV</button><button class="btn btn-outline" id="export-payments-pdf"><i class="fas fa-file-pdf"></i> PDF</button></div><button class="btn btn-success" id="record-payment-btn"><i class="fas fa-plus"></i> Record Payment</button></div></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="date">Date</th><th data-sort="customerId">Customer</th><th data-sort="consultantId">Consultant</th><th data-sort="amount">Amount</th><th data-sort="method">Method</th><th data-sort="status">Status</th><th>Actions</th></tr></thead><tbody id="payment-table-body"></tbody></table></div><div id="payments-pagination" class="pagination-controls"></div></div>`; 
            document.getElementById('analytics-page').innerHTML = `<div class="page-header"><h2>Analytics Dashboard</h2><p>Visual insights into recovery performance and activities.</p></div><div id="analytics-kpi-grid" class="kpi-card-grid"></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);"><div class="card"><div class="card-header"><h3 class="card-title">Recovery Performance by Consultant</h3></div><div class="chart-container"><canvas id="recovery-by-consultant-chart"></canvas></div></div><div class="card"><div class="card-header"><h3 class="card-title">Outstanding Debt by Emirate</h3></div><div class="chart-container"><canvas id="recovery-by-emirate-chart"></canvas></div></div><div class="card"><div class="card-header"><h3 class="card-title">Payment Methods</h3></div><div class="chart-container" style="height: 300px; max-width: 300px; margin: auto;"><canvas id="payment-methods-chart"></canvas></div></div><div class="card"><div class="card-header"><h3 class="card-title">Visit Outcome Analysis</h3></div><div class="chart-container" style="height: 300px; max-width: 300px; margin: auto;"><canvas id="visit-outcome-chart"></canvas></div></div></div>`;
            document.getElementById('reports-page').innerHTML = `
                <div class="card mb-4">
                    <div class="card-header"><h3 class="card-title">Collection Details Report</h3></div>
                    <p class="text-secondary" style="margin-bottom: var(--spacing-4);">Generate a detailed list of all collections within a specific date range.</p>
                    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="form-group">
                            <label for="report-collection-start-date">Start Date</label>
                            <input type="date" id="report-collection-start-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="report-collection-end-date">End Date</label>
                            <input type="date" id="report-collection-end-date" class="form-control">
                        </div>
                    </div>
                    <button id="generate-collection-report-btn" class="btn btn-primary mt-4" style="align-self: flex-start;"><i class="fas fa-cogs"></i> Generate Report</button>
                </div>
                 <div class="card mb-4"><div class="card-header"><h3 class="card-title">Other Key Performance Reports</h3></div>
                    <div class="report-grid">
                        <a href="#" class="report-card" id="generate-aging-report-btn">
                            <div class="icon"><i class="fas fa-hourglass-half"></i></div>
                            <h4>Customer Aging Report</h4><p>Outstanding balance aging analysis</p>
                        </a>
                        <a href="#" class="report-card" id="generate-collector-perf-btn">
                            <div class="icon"><i class="fas fa-user-check"></i></div>
                            <h4>Collector Performance</h4><p>Individual collector performance metrics</p>
                        </a>
                        <a href="#" class="report-card" id="generate-risk-analysis-btn">
                            <div class="icon"><i class="fas fa-shield-alt"></i></div>
                            <h4>Risk Analysis Report</h4><p>Customer risk score distribution</p>
                        </a>
                    </div>
                </div>
                 <div class="card mb-4">
                    <div class="card-header"><h3 class="card-title">Forecast Performance Report</h3></div>
                     <p class="text-secondary" style="margin-bottom: var(--spacing-4);">Track monthly forecast vs actual collections for selected consultants.</p>
                    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="form-group">
                            <label for="report-forecast-consultant-select">Consultant</label>
                            <select id="report-forecast-consultant-select" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="report-forecast-month">Month</label>
                            <div class="input-with-icon">
                                <input type="month" id="report-forecast-month" class="form-control">
                                <label for="report-forecast-month" class="icon fas fa-calendar-alt"></label>
                            </div>
                        </div>
                    </div>
                    <button id="generate-forecast-report-btn-new" class="btn btn-primary mt-4" style="align-self: flex-start;"><i class="fas fa-cogs"></i> Generate Report</button>
                </div>
                <div class="card mb-4">
                    <div class="card-header"><h3 class="card-title">Consultant Visits Report</h3></div>
                    <p class="text-secondary" style="margin-bottom: var(--spacing-4);">Generate a detailed visit history and performance report for a selected consultant and date range.</p>
                    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="form-group">
                            <label for="report-visits-consultant-select">Consultant</label>
                            <select id="report-visits-consultant-select" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label for="report-visits-start-date">Start Date</label>
                            <input type="date" id="report-visits-start-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="report-visits-end-date">End Date</label>
                            <input type="date" id="report-visits-end-date" class="form-control">
                        </div>
                    </div>
                    <button id="generate-consultant-visits-btn-new" class="btn btn-primary mt-4" style="align-self: flex-start;"><i class="fas fa-cogs"></i> Generate Report</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);"><div><div class="card mb-4" data-role="admin"><div class="card-header"><h3 class="card-title">Consultant Daily Activity</h3></div><div class="d-flex gap-4 flex-wrap align-items-center"><div class="d-flex gap-2 align-items-center"><select id="report-consultant-select" class="form-control" style="width:auto;"></select><input type="date" id="report-activity-start-date" class="form-control" style="width:auto;"> <span class="mx-2">to</span> <input type="date" id="report-activity-end-date" class="form-control" style="width:auto;"><button id="generate-activity-report-btn" class="btn btn-primary"><i class="fas fa-cogs"></i> Generate</button></div><div class="d-flex gap-2"><button id="activity-report-summary-btn" class="btn btn-outline filter-btn active"><i class="fas fa-chart-pie"></i> Summary</button><button id="activity-report-table-btn" class="btn btn-outline filter-btn"><i class="fas fa-table"></i> Table</button></div></div></div><div class="card mb-4"><div class="card-header"><h3 class="card-title">Standard Reports</h3></div><div class="d-flex gap-2 flex-wrap"><button id="generate-customer-report-btn" class="btn btn-primary"><i class="fas fa-users"></i> Customer Report</button><button id="generate-consultant-report-btn" class="btn btn-primary"><i class="fas fa-user-tie"></i> Consultant Report</button><button id="generate-overdue-report-btn" class="btn btn-warning"><i class="fas fa-exclamation-triangle"></i> Overdue Accounts</button><button id="generate-recovery-report-btn" class="btn btn-success"><i class="fas fa-chart-line"></i> Recovery Performance</button></div></div></div><div><div class="card mb-4"><div class="card-header"><h3 class="card-title">Customer Statement of Account</h3></div><div class="form-group"><label for="statement-customer-select">Select Customer</label><div id="statement-customer-select-container"></div></div><button id="generate-statement-btn" class="btn btn-primary"><i class="fas fa-file-invoice-dollar"></i> Generate Statement</button></div><div class="card"><div class="card-header"><h3 class="card-title">Visit Outcome Analysis Report</h3></div><p class="text-secondary" style="margin-bottom: var(--spacing-4);">Analyzes the results of all completed visits.</p><button id="generate-outcome-analysis-btn" class="btn btn-primary"><i class="fas fa-poll"></i> Generate Analysis</button></div></div></div><div id="report-output" class="mt-4"></div>`; 
            document.getElementById('consultants-page').innerHTML = `<div class="page-header"><h2 >Sales Consultant Management</h2><p >Home > Consultants</p></div><div class="card"><div class="card-header"><h3 class="card-title">Consultant List</h3><button id="add-consultant-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Consultant</button></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="name">Consultant Name</th><th data-sort="noOfCustomers">No. of Customers</th><th data-sort="totalOutstanding">Total Outstanding</th><th data-sort="overdueCustomers">Overdue Customers</th><th data-sort="upcomingVisits">Upcoming Visits</th><th>Actions</th></tr></thead><tbody id="consultant-table-body"></tbody></table></div><div id="consultants-pagination" class="pagination-controls"></div></div>`; 
            document.getElementById('changelog-page').innerHTML = `<div class="page-header"><h2>Change Log</h2><p>Tracks all data modifications in the system.</p></div><div class="card"><div class="card-header"><h3 class="card-title">Log Entries</h3><input type="search" id="changelog-search" placeholder="Search log..." class="form-control" style="width: auto;"></div><div class="table-container"><table class="data-table"><thead><tr><th data-sort="timestamp">Timestamp</th><th data-sort="user">User</th><th data-sort="action">Action</th><th data-sort="entityName">Entity</th><th>Change Details</th></tr></thead><tbody id="changelog-table-body"></tbody></table></div><div id="changelog-pagination" class="pagination-controls"></div></div>`; 
            document.getElementById('settings-page').innerHTML = `
                <div class="page-header"><h2>System Settings</h2><p>Manage application-wide configurations and data.</p></div>
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Backup & Restore</h3></div>
                    <p class="text-secondary mb-4">Save all your application data to a file or restore it from a backup.</p>
                    <div class="d-flex align-items-center gap-4 mb-4">
                        <div class="form-group mb-0">
                            <label class="d-flex align-items-center gap-2"><input type="radio" name="backup-format" value="json" checked> JSON (Full Backup)</label>
                            <label class="d-flex align-items-center gap-2"><input type="radio" name="backup-format" value="csv"> CSV (Data Tables)</label>
                        </div>
                        <button id="backup-data-btn" class="btn btn-primary"><i class="fas fa-download"></i> Backup Data</button>
                    </div>
                    <hr style="margin: var(--spacing-4) 0; border-color: var(--border-color);">
                    <h4>Restore from Backup</h4>
                    <div class="info-box" style="background: rgba(255, 193, 7, 0.1); border-color: var(--warning);">
                        <p><strong>Warning:</strong> Restoring will <strong style="color: var(--danger);">completely overwrite</strong> all current data. JSON restores everything. CSV restore only supports the <strong>customers.csv</strong> file.</p>
                    </div>
                    <div class="form-group">
                        <label for="restore-file-input">Select Backup File (.json, .csv)</label>
                        <input type="file" id="restore-file-input" class="form-control" accept=".json,.csv">
                    </div>
                    <button id="restore-data-btn" class="btn btn-warning" disabled><i class="fas fa-upload"></i> Restore Data</button>
                </div>`;
            document.getElementById('customer-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="customer-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-modal')">&times;</button></div><form id="customer-form"><input type="hidden" id="customer-id-hidden"><div class="form-grid"><div class="form-group"><label for="accountNo">Account Number*</label><input type="text" id="accountNo" class="form-control"></div><div class="form-group"><label for="companyName">Company Name*</label><input type="text" id="companyName" class="form-control" required></div><div class="form-group"><label for="emirate">Emirate*</label><select id="emirate" class="form-control" required><option>Dubai</option><option>Abu Dhabi</option><option>Sharjah</option><option>Ajman</option></select></div><div class="form-group"><label for="area">Area*</label><input type="text" id="area" class="form-control" required></div><div class="form-group"><label for="status">Status</label><select id="status" class="form-control"><option>Active</option><option>Inactive</option></select></div><div class="form-group"><label for="paymentStatus">Payment Status</label><select id="paymentStatus" class="form-control"><option>Pending</option><option>Paid</option><option>Cleared</option><option>Overdue</option></select></div><div class="form-group"><label for="initialDebt">Initial Debt (AED)*</label><input type="number" id="initialDebt" class="form-control" required></div><div class="form-group"><label for="outstanding">Current Outstanding (AED)*</label><input type="number" id="outstanding" class="form-control" required></div><div class="form-group"><label for="forecastAmount">Forecast Amount (AED)</label><input type="number" id="forecastAmount" class="form-control"></div><div class="form-group"><label for="salesConsultantId">Sales Consultant*</label><select id="salesConsultantId" class="form-control" required></select></div></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('customer-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save Customer</button></div></form></div>`; 
            document.getElementById('payment-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3>Record a Payment</h3><button class="btn btn-outline" onclick="App.UI.closeModal('payment-modal')">&times;</button></div><form id="payment-form"><div class="form-group"><label for="payment-customer-id">Customer*</label><div id="payment-customer-select-container"></div></div><div class="form-group"><label for="payment-amount">Amount*</label><input type="number" id="payment-amount" class="form-control" required></div><div class="form-group"><label for="payment-method">Payment Method*</label><select id="payment-method" class="form-control" required><option>Bank Transfer</option><option>Cheque</option><option>Cash</option></select></div><div class="form-group"><label for="payment-date">Date*</label><input type="date" id="payment-date" class="form-control" required></div><div class="form-group"><label for="payment-status">Status</label><select id="payment-status" class="form-control"><option>Completed</option><option>Pending</option><option>Failed</option></select></div><button type="submit" class="btn btn-primary">Record Payment</button></form></div>`; 
            document.getElementById('visit-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3>Schedule Visit</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-modal')">&times;</button></div><form id="visit-form"><input type="hidden" id="visit-id"><div class="form-group"><label for="visit-customer-id">Customer*</label><div id="visit-customer-select-container"></div></div><div class="form-group"><label for="visit-purpose">Purpose*</label><input type="text" id="visit-purpose" class="form-control" required></div><div class="form-group"><label for="visit-date">Date & Time*</label><input type="datetime-local" id="visit-date" class="form-control" required></div><button type="submit" class="btn btn-primary">Save Visit</button></form></div>`; 
            document.getElementById('import-csv-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 class="card-title">Upload CSV File</h3><button class="btn btn-outline" onclick="App.UI.closeModal('import-csv-modal')">&times;</button></div><div class="file-upload-wrapper" id="csv-drop-zone"><i class="fas fa-upload" style="font-size: 1.5rem; color: var(--text-secondary);"></i><p>Click to browse or drag & drop file here</p><span id="csv-filename" style="font-weight: 600; color: var(--primary);"></span><input type="file" id="csv-file-input" class="hidden" accept=".csv"></div><div class="info-box"><p>Ensure headers match:</p><code>accountNumber,companyName,emirate,area,status,paymentStatus,initialDebt,outstandingAmount,salesConsultant</code></div><a href="#" id="download-sample-csv-link"><i class="fas fa-download"></i> Download Sample Template</a><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('import-csv-modal')">Close</button></div></div>`; 
            document.getElementById('customer-detail-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="customer-detail-title" class="card-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-detail-modal')">&times;</button></div><div class="d-flex gap-2 mb-4"><button class="detail-tab-btn active" data-tab="overview"><i class="fas fa-info-circle"></i> Overview</button><button class="detail-tab-btn" data-tab="visit-notes"><i class="fas fa-pen-alt"></i> Visit Notes</button></div><div id="customer-detail-content"><div class="tab-content active" id="overview-content"></div><div class="tab-content hidden" id="visit-notes-content"></div></div><div class="modal-footer" style="justify-content: space-between;"><div class="d-flex gap-2"><button class="btn btn-success" id="detail-record-payment-btn"><i class="fas fa-dollar-sign"></i> Record Payment</button><button class="btn btn-primary" id="detail-schedule-visit-btn"><i class="fas fa-calendar-plus"></i> Schedule Visit</button></div><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('customer-detail-modal')">Close</button></div></div>`; 
            document.getElementById('visit-notes-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 class="card-title">Mark Visit as Done</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-notes-modal')">&times;</button></div><form id="visit-notes-form"><input type="hidden" id="mark-done-visit-id"><input type="hidden" id="log-location-hidden"><div class="form-grid"><div class="form-group"><label>CONTACT METHOD</label><select id="log-contact-method" class="form-control"><option>Site Visit</option><option>Phone Call</option><option>Email</option></select></div><div class="form-group"><label>OUTCOME</label><select id="log-outcome" class="form-control"><option>No Answer</option><option>Promise to Pay</option><option>Dispute</option><option>Paid in Full</option><option>Partial Payment</option></select></div></div><div id="promise-to-pay-fields" class="form-grid hidden"><div class="form-group"><label for="log-promise-amount">Promised Amount (AED)</label><input type="number" id="log-promise-amount" class="form-control"></div><div class="form-group"><label for="log-promise-date">Promised Date</label><input type="date" id="log-promise-date" class="form-control"></div></div><div class="form-group"><label>NOTES</label><div id="log-notes-editor" style="height:150px;"></div></div><div class="form-grid"><div class="form-group"><label>SCHEDULE NEXT VISIT (Optional)</label><input type="date" id="log-next-date" class="form-control"></div><div class="form-group"><label>LOCATION</label><button type="button" class="btn btn-outline" id="log-location-btn" style="width:100%;"><i class="fas fa-map-marker-alt"></i> <span id="log-location-text">Tag Current Location</span></button></div></div><div class="modal-footer" data-role="user"><button type="button" id="log-record-payment-btn" class="btn btn-success"><i class="fas fa-dollar-sign"></i> Record Payment</button><button type="submit" class="btn btn-primary">Save Notes</button></div></form></div>`; 
            document.getElementById('payment-detail-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="card-title">Payment Details</h3><button class="btn btn-outline" onclick="App.UI.closeModal('payment-detail-modal')">&times;</button></div><div id="payment-detail-content"></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('payment-detail-modal')">Close</button></div></div>`; 
            document.getElementById('consultant-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 id="consultant-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('consultant-modal')">&times;</button></div><form id="consultant-form"><input type="hidden" id="consultant-id-hidden"><div class="form-group"><label for="consultantName">Consultant Name*</label><input type="text" id="consultantName" class="form-control" required></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('consultant-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save Consultant</button></div></form></div>`; 
            document.getElementById('visit-detail-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="card-title">Visit Details</h3><button class="btn btn-outline" onclick="App.UI.closeModal('visit-detail-modal')">&times;</button></div><div id="visit-detail-content"></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('visit-detail-modal')">Close</button></div></div>`;
            document.getElementById('consultant-customers-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="consultant-customers-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('consultant-customers-modal')">&times;</button></div><div id="consultant-customers-body" class="table-container"></div></div>`;
            document.getElementById('reassign-customers-modal').innerHTML = `<div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 id="reassign-customers-title">Reassign Customers</h3><button class="btn btn-outline" onclick="App.UI.closeModal('reassign-customers-modal')">&times;</button></div><form id="reassign-customers-form"><input type="hidden" id="from-consultant-hidden"><div class="form-group"><label>Customers assigned to <strong id="from-consultant-name"></strong></label><div id="reassign-customer-list" style="height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: var(--spacing-2); border-radius: 8px;"></div></div><div class="form-group"><label for="reassign-to-consultant">Reassign selected to</label><select id="reassign-to-consultant" class="form-control" required></select></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('reassign-customers-modal')">Cancel</button><button type="submit" class="btn btn-primary">Reassign</button></div></form></div>`;
            document.getElementById('forecast-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h3 id="forecast-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('forecast-modal')">&times;</button></div><form id="forecast-form"><input type="hidden" id="forecast-consultant-id"><div class="form-grid"><div class="form-group"><label for="forecast-month">Month</label><input type="month" id="forecast-month" class="form-control" required></div><div class="form-group"><label for="forecast-amount">Target Amount (AED)</label><input type="number" id="forecast-amount" class="form-control" required></div></div><button type="submit" class="btn btn-primary">Save Target</button></form><hr style="margin: var(--spacing-6) 0; border-color: var(--border-color);"><h4 class="card-title mb-4">Target History</h4><div class="table-container"><table class="data-table"><thead><tr><th>Month</th><th>Target Amount</th><th>Actions</th></tr></thead><tbody id="existing-forecasts-body"></tbody></table></div></div>`;
            document.getElementById('customer-forecast-modal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h3 id="customer-forecast-modal-title"></h3><button class="btn btn-outline" onclick="App.UI.closeModal('customer-forecast-modal')">&times;</button></div><form id="customer-forecast-form"><input type="hidden" id="customer-forecast-accountNo"><div class="form-group"><label for="customer-forecast-amount">Forecast Amount (AED)</label><input type="number" id="customer-forecast-amount" class="form-control" required></div><div class="modal-footer"><button type="button" class="btn btn-outline" onclick="App.UI.closeModal('customer-forecast-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save Forecast</button></div></form></div>`;
            document.getElementById('report-modal').innerHTML = `<div class="modal-content" style="max-width: 90%; width: 1200px;"><div class="modal-header"><h3 id="report-modal-title" style="flex-grow: 1;"></h3><div id="report-modal-actions" class="d-flex gap-2"></div><button class="btn btn-outline" onclick="App.UI.closeModal('report-modal')" style="margin-left: 1rem;">&times;</button></div><div id="report-modal-body" style="margin-top: var(--spacing-4);"></div></div>`;
        }, 
        setupEventListeners() { 
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const hamburger = document.getElementById('hamburger-menu');

            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const loginError = document.getElementById('login-error');
                loginError.classList.remove('show');
                const u = e.target.username.value, p = e.target.password.value;
                if (!App.Auth.login(u, p)) {
                    setTimeout(() => loginError.classList.add('show'), 50);
                }
            }); 
            document.getElementById('logout-btn').addEventListener('click', () => {
                App.UI.confirm('Confirm Logout', 'Are you sure you want to log out?', () => {
                    App.Auth.logout();
                });
            });
            document.getElementById('theme-toggle-btn').addEventListener('click', () => this.toggleTheme()); 
            hamburger.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('hidden');
            });
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
            });
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); this.navigateTo(link.dataset.page); })); 
            App.Dashboard.setupEventListeners(); App.Customers.setupEventListeners(); App.Payments.setupEventListeners(); App.Reports.setupEventListeners(); App.Visits.setupEventListeners(); App.Consultants.setupEventListeners(); App.Users.setupEventListeners(); App.ChangeLog.setupEventListeners(); App.Settings.setupEventListeners(); App.Analytics.setupEventListeners(); 
            document.body.addEventListener('click', (e) => { if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !hamburger.contains(e.target)) { sidebar.classList.remove('open'); overlay.classList.add('hidden'); } }); 
        }, 
        showApp() { document.getElementById('login-page').style.display = 'none'; document.getElementById('app').classList.remove('hidden'); document.getElementById('username-display').textContent = App.state.currentUser.fullName; App.Auth.checkRole(); if (App.state.currentUser.role === 'admin') { App.Notifications.render(); } this.navigateTo('dashboard'); }, showLogin() { document.getElementById('login-page').style.display = 'flex'; document.getElementById('app').classList.add('hidden'); }, navigateTo(pageId) { clearInterval(App.state.dashboardInterval); App.state.dashboardInterval = null; App.state.activePage = pageId; document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(`${pageId}-page`).classList.add('active'); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active'); const title = document.querySelector(`.nav-link[data-page="${pageId}"] .nav-text`).textContent; document.getElementById('page-title').textContent = title; const pageRenderers = { dashboard: App.Dashboard, customers: App.Customers, visits: App.Visits, payments: App.Payments, reports: App.Reports, analytics: App.Analytics, consultants: App.Consultants, users: App.Users, changelog: App.ChangeLog, settings: App.Settings }; if (pageRenderers[pageId]) { pageRenderers[pageId].render(); } }, 
        handleTableSort(pageKey, column) {
            const sortState = App.state.tableSorts[pageKey];
            if (sortState.column === column) {
                sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.order = 'asc';
            }
            App.state.pagination[pageKey].currentPage = 1;
            const renderer = App[pageKey.charAt(0).toUpperCase() + pageKey.slice(1)];
            if(renderer && typeof renderer.render === 'function') {
                renderer.render();
            } else if (pageKey === 'visits' && renderer.renderListView) {
                renderer.renderListView();
            }
        },
        updateSortIndicators(pageKey) {
            const { column, order } = App.state.tableSorts[pageKey];
            const pageElement = document.getElementById(`${pageKey}-page`);
            if (!pageElement) return;

            pageElement.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const activeTh = pageElement.querySelector(`th[data-sort="${column}"]`);
            if (activeTh) {
                activeTh.classList.add(order === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        },
        openModal(id) { 
            const modal = document.getElementById(id);
            if (!modal) return;
            const activeModals = document.querySelectorAll('.modal.active').length;
            modal.style.zIndex = 2000 + activeModals;
            modal.classList.add('active'); 
        }, 
        closeModal(id) { 
            const modal = document.getElementById(id);
            if (!modal) return;
            modal.classList.remove('active'); 
            modal.style.zIndex = '';
            if (id === 'visit-notes-modal') {
                App.state.paymentFlowOrigin = null; 
            }
            if (id === 'payment-modal' && App.state.paymentFlowOrigin) {
                App.Visits.updateVisitNotesUI();
            }
        }, 
        toast: (title, icon = 'success') => Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, icon, title, background: 'var(--card-bg)', color: 'var(--text-primary)' }), confirm: (title, text, cb) => Swal.fire({ title, text, icon: 'warning', showCancelButton: true, confirmButtonColor: 'var(--primary)', cancelButtonColor: 'var(--danger)', confirmButtonText: 'Yes, do it!', background: 'var(--card-bg)', color: 'var(--text-primary)' }).then(r => r.isConfirmed && cb()),
        createSearchableDropdown(container, items, onSelect, placeholder = 'Select an option...') {
            container.innerHTML = `
                <div class="searchable-dropdown">
                    <input type="text" class="form-control" placeholder="${placeholder}" autocomplete="off">
                    <input type="hidden">
                    <div class="searchable-dropdown-results hidden"></div>
                </div>
            `;
            const searchInput = container.querySelector('input[type="text"]');
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const resultsContainer = container.querySelector('.searchable-dropdown-results');

            const renderResults = (filter = '') => {
                const lowerFilter = filter.toLowerCase();
                const filteredItems = items.filter(item => 
                    item.mainText.toLowerCase().includes(lowerFilter) || 
                    (item.secondaryText && item.secondaryText.toLowerCase().includes(lowerFilter))
                );
                if (filteredItems.length === 0) {
                    resultsContainer.innerHTML = '<div class="searchable-dropdown-item no-results">No results found</div>';
                } else {
                    resultsContainer.innerHTML = filteredItems.map(item => `
                        <div class="searchable-dropdown-item" data-id="${item.id}">
                            <div class="sdi-main">${item.mainText}</div>
                            <div class="sdi-secondary">${item.secondaryText}</div>
                        </div>
                    `).join('');
                }
                resultsContainer.classList.remove('hidden');
            };

            searchInput.addEventListener('focus', () => renderResults());
            searchInput.addEventListener('input', () => renderResults(searchInput.value));

            resultsContainer.addEventListener('click', (e) => {
                const item = e.target.closest('.searchable-dropdown-item');
                if (item && item.dataset.id) {
                    const selectedItem = items.find(i => i.id == item.dataset.id);
                    searchInput.value = selectedItem.mainText;
                    hiddenInput.value = selectedItem.id;
                    resultsContainer.classList.add('hidden');
                    if(onSelect) onSelect(selectedItem.id);
                }
            });

            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    resultsContainer.classList.add('hidden');
                }
            });

            return {
                getValue: () => hiddenInput.value,
                setValue: (id) => {
                    const selectedItem = items.find(i => i.id == id);
                    if (selectedItem) {
                        searchInput.value = selectedItem.mainText;
                        hiddenInput.value = selectedItem.id;
                    }
                }
            };
        },
        animateTableRows(tbody) {
            if(!tbody) return;
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.style.animationDelay = `${index * 0.05}s`;
            });
        },
        observeProgressBars() {
            if (!this.intersectionObserver) {
                this.intersectionObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const progressBar = entry.target;
                            const innerBar = progressBar.querySelector('.progress-bar-inner');
                            if (innerBar && innerBar.dataset.width) {
                                setTimeout(() => { innerBar.style.width = innerBar.dataset.width + '%' }, 100);
                            }
                            observer.unobserve(progressBar);
                        }
                    });
                }, { threshold: 0.5 });
            }
            document.querySelectorAll('.progress-bar').forEach(bar => {
                const inner = bar.querySelector('.progress-bar-inner');
                if (inner) inner.style.width = '0%'; // Reset before observing
                this.intersectionObserver.observe(bar)
            });
        },
        toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            this.applyTheme();
        },
        applyTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', theme);
            const themeIcon = document.querySelector('#theme-toggle-btn i');
            if (theme === 'dark') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        },
        getEmptyStateHTML(iconClass, title, message, buttonHTML = '') {
            return `
                <tr>
                    <td colspan="100%" style="padding: 0;">
                        <div class="empty-state">
                            <i class="fas ${iconClass}"></i>
                            <h4>${title}</h4>
                            <p>${message}</p>
                            ${buttonHTML}
                        </div>
                    </td>
                </tr>
            `;
        },
        renderPaginationControls(pageKey, totalRows) {
            const container = document.getElementById(`${pageKey}-pagination`);
            if (!container) return;

            const { currentPage, rowsPerPage } = App.state.pagination[pageKey];
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <span>Page ${currentPage} of ${totalPages}</span>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline" ${currentPage === 1 ? 'disabled' : ''} onclick="App.UI.changePage('${pageKey}', -1)">Previous</button>
                    <button class="btn btn-outline" ${currentPage === totalPages ? 'disabled' : ''} onclick="App.UI.changePage('${pageKey}', 1)">Next</button>
                </div>
            `;
        },
        changePage(pageKey, direction) {
            App.state.pagination[pageKey].currentPage += direction;
            const renderer = App[pageKey.charAt(0).toUpperCase() + pageKey.slice(1)];
            if(renderer && typeof renderer.render === 'function') {
                renderer.render();
            } else if (pageKey === 'visits' && renderer.renderListView) {
                renderer.renderListView();
            }
        }
    });
	    Object.assign(App.Dashboard, { 
        charts: {}, 
        setupEventListeners() { 
            document.getElementById('dashboard-page').addEventListener('click', e => { 
                if (e.target.id === 'start-day-btn') this.startDay(); 
                if (e.target.id === 'end-day-btn') this.endDay(); 
                if (e.target.id === 'start-break-btn') this.startBreak(); 
                if (e.target.id === 'end-break-btn') this.endBreak(); 
                if (e.target.closest('#toggle-dashboard-view-btn')) { 
                    App.state.adminDashboardView = App.state.adminDashboardView === 'overview' ? 'chart_view' : 'overview'; this.render(); 
                } 
            });
        }, 
        render() { 
            if(App.state.dashboardInterval) clearInterval(App.state.dashboardInterval); 
            const adminWrapper = document.getElementById('admin-dashboard-wrapper'); 
            const chartWrapper = document.getElementById('chart-dashboard-wrapper'); 
            const toggleBtn = document.getElementById('toggle-dashboard-view-btn'); 
            if (App.state.currentUser.role === 'admin') { 
                adminWrapper.classList.remove('hidden'); 
                if (App.state.adminDashboardView === 'overview') { 
                    chartWrapper.classList.add('hidden'); 
                    toggleBtn.innerHTML = `<i class="fas fa-chart-bar"></i> Switch to Chart View`; 
                    this.renderAdminDashboard(); 
                    App.state.dashboardInterval = setInterval(() => this.renderAdminDashboard(), 15000); 
                } else { 
                    chartWrapper.classList.remove('hidden'); 
                    document.getElementById('admin-dashboard-content').innerHTML = ''; 
                    toggleBtn.innerHTML = `<i class="fas fa-tachometer-alt"></i> Switch to Overview`; 
                    this.renderUserDashboard();
                } 
            } else { 
                adminWrapper.classList.add('hidden'); 
                chartWrapper.classList.remove('hidden'); 
                this.renderUserDashboard(); 
            } 
        }, 
        renderAdminDashboard() { 
            const container = document.getElementById('admin-dashboard-content'); 
            const customers = App.DB.get('customers'); 
            const activityLog = App.DB.get('activityLog'); 
            const consultants = App.DB.get('consultants');
            const payments = App.DB.get('payments');

            const now = new Date();
            const recoveredThisMonth = payments.filter(p => p.status === 'Completed' && new Date(p.date).getMonth() === now.getMonth() && new Date(p.date).getFullYear() === now.getFullYear()).reduce((sum, p) => sum + p.amount, 0);

            const currentCustomerForecasts = customers.reduce((sum, c) => sum + (c.forecastAmount || 0), 0);
            const totalForecastTarget = currentCustomerForecasts + recoveredThisMonth;
            const forecastPercentage = totalForecastTarget > 0 ? ((recoveredThisMonth / totalForecastTarget) * 100).toFixed(0) : 0;
            
            const totalInitial = customers.reduce((s, c) => s + c.initialDebt, 0); 
            const totalOutstanding = customers.reduce((s, c) => s + c.outstanding, 0); 
            const totalRecovered = totalInitial - totalOutstanding; 
            const companyRecoveryRate = totalInitial > 0 ? ((totalRecovered / totalInitial) * 100).toFixed(2) : 0; 
            
            let forecastHTML = `<div class="card"><div class="card-title">Forecast (This Month)</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalForecastTarget)}</div><div class="progress-bar mt-4 mb-2"><div class="progress-bar-inner" data-width="${forecastPercentage}"></div></div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${App.Helpers.formatCurrency(recoveredThisMonth)} collected (${forecastPercentage}%)</div></div>`;
            
            container.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-6); margin-bottom: var(--spacing-6);"><div class="card"><div class="card-title">Company Recovery Rate</div><div style="font-size: var(--fs-3xl); font-weight: 700; color:var(--success);">${companyRecoveryRate}%</div></div><div class="card"><div class="card-title">Total Recovered (All Time)</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalRecovered)}</div></div><div class="card"><div class="card-title">Total Outstanding</div><div style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalOutstanding)}</div></div>${forecastHTML}</div><div id="admin-dashboard-bottom-section"></div>`; 

            const bottomSection = document.getElementById('admin-dashboard-bottom-section');
            bottomSection.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);">
                    <div id="admin-consultant-progress"></div>
                    <div id="admin-customer-progress"></div>
                    <div id="admin-pending-promises"></div>
                    <div id="admin-recent-activities"></div>
                </div>
                <div id="admin-upcoming-visits" class="mt-4"></div>
            `;
            
            this.renderConsultantForecastProgress(document.getElementById('admin-consultant-progress'), consultants, customers, payments, App.DB.get('forecasts'));
            this.renderCustomerForecastProgress(document.getElementById('admin-customer-progress'), customers);
            this.renderPendingPromisesWidget(document.getElementById('admin-pending-promises'));

            const upcomingVisits = App.DB.get('visits').filter(v => new Date(v.dateTime) >= new Date() && v.status === 'Scheduled').sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime)).slice(0, 10);
            const customerMap = App.DB.get('customers').reduce((map, customer) => { map[customer.accountNo] = customer.companyName; return map; }, {});
            const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
            
            document.getElementById('admin-recent-activities').innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Recent Activities</h3></div><ul style="list-style:none; padding:0; max-height: 400px; overflow-y:auto;">${activityLog.sort((a,b) => b.timestamp - a.timestamp).slice(0, 10).map(log => `<li style="border-bottom: 1px solid var(--border-color); padding: var(--spacing-2) 0;"><div style="font-weight: 600;">${consultantMap[log.consultantId] || 'N/A'}</div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${log.action}${log.details ? ': ' + log.details : ''}</div><div style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${log.time}</div></li>`).join('')}</ul></div>`;
            document.getElementById('admin-upcoming-visits').innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Next 10 Upcoming Visits</h3></div><div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Company Name</th><th>Sales Consultant</th></tr></thead><tbody>${upcomingVisits.length > 0 ? upcomingVisits.map(v => `<tr><td>${App.Helpers.formatDateTime(v.dateTime)}</td><td>${customerMap[v.customerId] || 'N/A'}</td><td>${consultantMap[v.collectorId] || 'N/A'}</td></tr>`).join('') : '<tr><td colspan="3">No upcoming visits found.</td></tr>'}</tbody></table></div></div>`;
            
            App.UI.observeProgressBars(); 
        },
        renderUserDashboard() { 
            const attendanceControls = document.getElementById('attendance-controls'); 
            const todaysAgenda = document.getElementById('todays-agenda');
            if (App.state.currentUser.role === 'user') { 
                attendanceControls.classList.remove('hidden'); 
                todaysAgenda.classList.remove('hidden');
                this.renderAttendanceControls(); 
                this.renderTodaysAgenda(todaysAgenda);
            } else { 
                attendanceControls.classList.add('hidden'); 
                todaysAgenda.classList.add('hidden');
            } 
            this.renderRecoveryProgress(); 
            const c = App.Helpers.getScopedData('customers'), p = App.Helpers.getScopedData('payments'), v = App.Helpers.getScopedData('visits'); 
            const now = new Date();
            const recoveredThisMonth = p.filter(i => new Date(i.date).getMonth() === now.getMonth() && new Date(i.date).getFullYear() === now.getFullYear() && i.status === 'Completed').reduce((s, i) => s + i.amount, 0);
            
            let totalForecast = 0;
            if(App.state.currentUser.role === 'admin') {
                const currentCustomerForecasts = App.DB.get('customers').reduce((sum, cust) => sum + (cust.forecastAmount || 0), 0);
                totalForecast = currentCustomerForecasts + recoveredThisMonth;
            } else {
                const initialForecast = c.reduce((s, i) => s + (i.forecastAmount || 0), 0);
                totalForecast = initialForecast + recoveredThisMonth;
            }
            
            const forecastPercentage = totalForecast > 0 ? ((recoveredThisMonth / totalForecast) * 100).toFixed(0) : 0;
            const forecastCard = document.getElementById('user-dashboard-forecast-card');
            
            if (forecastCard) {
                forecastCard.innerHTML = `
                    <div class="card-title">Forecast Progress</div>
                    <div class="value" style="font-size: var(--fs-3xl); font-weight: 700;">${App.Helpers.formatCurrency(totalForecast)}</div>
                    <div class="progress-bar mt-4 mb-2"><div class="progress-bar-inner" data-width="${forecastPercentage}"></div></div>
                    <div style="font-size: var(--fs-sm); color: var(--text-secondary);">${App.Helpers.formatCurrency(recoveredThisMonth)} collected (${forecastPercentage}%)</div>
                `;
            }

            this.animateCounter('stat-total-customers', c.length); 
            this.animateCounter('stat-outstanding-debt', c.reduce((s, i) => s + i.outstanding, 0), true); 
            this.animateCounter('stat-recovered-this-month', recoveredThisMonth, true); 
            this.animateCounter('stat-upcoming-visits', v.filter(i => new Date(i.dateTime) >= new Date() && i.status === 'Scheduled').length); 
            
            const bottomContainer = document.getElementById('dashboard-bottom-content');
            
            let bottomHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--spacing-6);">
                    <div id="pending-promises-container"></div>
                    <div class="card"><div class="card-header"><h3 class="card-title">Outstanding Debt by Emirate</h3></div><div class="chart-container"><canvas id="debt-chart"></canvas></div></div>
                    <div class="card"><div class="card-header"><h3 class="card-title">Monthly Payment Recovery</h3></div><div class="chart-container"><canvas id="payment-chart"></canvas></div></div>
                    ${App.state.currentUser.role === 'user' ? `
                        <div id="user-consultant-progress"></div>
                        <div id="user-customer-progress"></div>
                    ` : ''}
                </div>
            `;
            
            bottomContainer.innerHTML = bottomHTML;
            this.renderPendingPromisesWidget(document.getElementById('pending-promises-container'));
            this.renderCharts(); 

            if(App.state.currentUser.role === 'user'){
                this.renderConsultantForecastProgress(
                    document.getElementById('user-consultant-progress'), 
                    App.DB.get('consultants').filter(con => con.id === App.state.currentUser.assignedConsultantId), 
                    c, p, App.DB.get('forecasts')
                );
                this.renderCustomerForecastProgress(
                    document.getElementById('user-customer-progress'),
                    c
                );
            }
            
            App.UI.observeProgressBars();
        },
        renderTodaysAgenda(container) {
            const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c.companyName; return map; }, {});
            const visits = App.Helpers.getScopedData('visits');
            const today = new Date().toISOString().slice(0, 10);
            
            const todaysVisits = visits.filter(v => v.dateTime.startsWith(today) && v.status === 'Scheduled');
            const todaysPromises = visits.filter(v => v.promiseDate === today && v.outcome === 'Promise to Pay');
            const overdueVisits = visits.filter(v => v.status === 'Overdue');
            const overduePromises = visits.filter(v => v.promiseDate && v.promiseDate < today && v.outcome === 'Promise to Pay');

            const createList = (items, type) => {
                if (items.length === 0) return `<p>No ${type} for today.</p>`;
                return `<ul style="list-style-type: none;">${items.map(item => `<li style="margin-bottom: var(--spacing-2);">${item}</li>`).join('')}</ul>`;
            };

            const visitList = createList(todaysVisits.map(v => `${customerMap[v.customerId] || 'N/A'}: ${v.purpose}`), 'visits');
            const promiseList = createList(todaysPromises.map(p => `${customerMap[p.customerId] || 'N/A'}: ${App.Helpers.formatCurrency(p.promiseAmount)}`), 'promises due');

            const overdueCount = overdueVisits.length + overduePromises.length;
            const overdueHTML = overdueCount > 0 
                ? `<div class="detail-info-card" style="background-color: rgba(220, 53, 69, 0.1); border-color: var(--danger);"><div class="label">Overdue Tasks</div><div class="value" style="color: var(--danger);">${overdueCount}</div></div>` 
                : `<div class="detail-info-card"><div class="label">Overdue Tasks</div><div class="value">0</div></div>`;

            container.innerHTML = `
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Today's Agenda</h3></div>
                    <div class="detail-info-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="detail-info-card"><div class="label">Visits for Today</div>${visitList}</div>
                        <div class="detail-info-card"><div class="label">Promises Due Today</div>${promiseList}</div>
                        ${overdueHTML}
                    </div>
                </div>`;
        },
        renderPendingPromisesWidget(container) {
            const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c.companyName; return map; }, {});
            const promises = App.Helpers.getScopedData('visits').filter(v => v.outcome === 'Promise to Pay' && v.promiseDate && v.status === 'Completed').sort((a, b) => new Date(a.promiseDate) - new Date(b.promiseDate));
            let content;
            if (promises.length === 0) {
                content = '<p>No pending payment promises.</p>';
            } else {
                const today = new Date().toISOString().slice(0, 10);
                content = `<div class="table-container"><table class="data-table"><thead><tr><th>Customer</th><th>Amount</th><th>Due Date</th></tr></thead><tbody>
                    ${promises.map(p => `<tr>
                        <td>${customerMap[p.customerId] || 'N/A'}</td>
                        <td>${App.Helpers.formatCurrency(p.promiseAmount || 0)}</td>
                        <td style="${p.promiseDate < today ? 'color: var(--danger); font-weight: 600;' : ''}">${App.Helpers.formatDate(p.promiseDate)}</td>
                    </tr>`).join('')}
                </tbody></table></div>`;
            }
            container.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Pending Promises</h3></div>${content}</div>`;
        },
        renderConsultantForecastProgress(container, consultants, allCustomers, allPayments) {
            const now = new Date();
            const recoveredThisMonth = allPayments.filter(p => p.status === 'Completed' && new Date(p.date).getMonth() === now.getMonth() && new Date(p.date).getFullYear() === now.getFullYear());

            const progressHTML = consultants.map(consultant => {
                const assignedCustomers = allCustomers.filter(c => c.salesConsultantId === consultant.id);
                const assignedCustomerIds = new Set(assignedCustomers.map(c => c.accountNo));

                const collectedThisMonth = recoveredThisMonth.filter(p => assignedCustomerIds.has(p.customerId)).reduce((sum, p) => sum + p.amount, 0);
                
                const remainingForecast = assignedCustomers.reduce((sum, c) => sum + (c.forecastAmount || 0), 0);
                const totalForecast = remainingForecast + collectedThisMonth;

                const percentage = totalForecast > 0 ? ((collectedThisMonth / totalForecast) * 100).toFixed(0) : 0;

                return `<div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span style="font-weight: 600;">${consultant.name}</span>
                                <span style="font-size: var(--fs-sm); color: var(--text-secondary);">${percentage}%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-bar-inner" data-width="${percentage}"></div></div>
                            <div style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${App.Helpers.formatCurrency(collectedThisMonth)} of ${App.Helpers.formatCurrency(totalForecast)}</div>
                        </div>`;
            }).join('');
            
            container.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Consultant Forecast Progress (This Month)</h3></div><div style="max-height: 400px; overflow-y: auto; padding-right: 1rem;">${progressHTML}</div></div>`;
        },
        renderCustomerForecastProgress(container, customers) {
            const progressHTML = customers.filter(c => (c.initialDebt > 0 && c.outstanding < c.initialDebt) || (c.forecastAmount || 0) > 0).map(customer => {
                const collected = customer.initialDebt - customer.outstanding;
                const totalTarget = collected + (customer.forecastAmount || 0);
                const percentage = totalTarget > 0 ? ((collected / totalTarget) * 100).toFixed(0) : (customer.outstanding <= 0 ? 100 : 0);

                return `<div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span style="font-weight: 600;">${customer.companyName}</span>
                                <span style="font-size: var(--fs-sm); color: var(--text-secondary);">${percentage}%</span>
                            </div>
                            <div class="progress-bar"><div class="progress-bar-inner" data-width="${percentage}"></div></div>
                            <div style="font-size: var(--fs-sm); color: var(--text-secondary); text-align: right;">${App.Helpers.formatCurrency(collected)} of ${App.Helpers.formatCurrency(totalTarget)}</div>
                        </div>`;
            }).join('');

            container.innerHTML = `<div class="card"><div class="card-header"><h3 class="card-title">Customer Forecast Progress</h3></div><div style="max-height: 400px; overflow-y: auto; padding-right: 1rem;">${progressHTML}</div></div>`;
        },
        renderAttendanceControls() {
            const todayStr = new Date().toISOString().slice(0, 10);
            const consultantId = App.state.currentUser.assignedConsultantId;
            const log = App.DB.get('activityLog');
            const startEntry = log.find(entry => entry.consultantId === consultantId && entry.date === todayStr && entry.action === 'Started Day');
            const dayStarted = !!startEntry;
            const dayEnded = log.some(entry => entry.consultantId === consultantId && entry.date === todayStr && entry.action === 'Ended Day');
            const onBreak = !!App.state.breakStartTime;
            
            let html = '<div class="card d-flex gap-4 justify-content-between align-items-center flex-wrap">';
            
            if (dayStarted) {
                let statusText = `Day Started at: ${startEntry.time}`;
                if (onBreak) { statusText = `<span style="color:var(--warning);">On Break</span>`; }
                html += `<div><h3 class="card-title" style="margin:0; font-size:var(--fs-base)">Daily Attendance</h3><p style="font-size:var(--fs-sm);" id="attendance-status">${statusText}</p></div>`;
            } else {
                html += `<div><h3 class="card-title" style="margin:0; font-size:var(--fs-base)">Daily Attendance</h3><p style="color:var(--text-secondary); font-size:var(--fs-sm);" id="attendance-status">Log your work day.</p></div>`;
            }

            html += `<div class="d-flex gap-4 align-items-center">`;
            html += `<span id="work-timer" style="font-weight:600; font-size:var(--fs-lg); color:var(--primary); min-width: 100px; text-align: right;"></span>`;

            if (!dayStarted) {
                html += `<button id="start-day-btn" class="btn btn-success"><i class="fas fa-play"></i> Start Day</button>`;
            } else if (dayEnded) {
                html += `<p style="font-weight:600; color:var(--success);">Day Completed!</p>`;
            } else if (onBreak) {
                html += `<button id="end-break-btn" class="btn btn-success"><i class="fas fa-play"></i> End Break</button>`;
            } else {
                html += `<button id="start-break-btn" class="btn btn-outline" style="border-color: var(--warning); color: var(--warning);"><i class="fas fa-pause"></i> Start Break</button>`;
                html += `<button id="end-day-btn" class="btn btn-danger"><i class="fas fa-stop"></i> End Day</button>`;
            }

            html += `</div></div>`;
            document.getElementById('attendance-controls').innerHTML = html;

            if (dayStarted && !dayEnded) {
                App.state.totalBreakTime = log
                    .filter(e => e.consultantId === consultantId && e.date === todayStr && e.action === 'Ended Break' && e.duration)
                    .reduce((sum, e) => sum + e.duration, 0);
                this.startTimer(startEntry.timestamp);
            }
        },
        startDay() {
            App.state.totalBreakTime = 0;
            App.state.breakStartTime = null;
            App.Helpers.logActivity('Started Day');
            App.UI.toast('Day Started! Good luck.', 'success');
            this.render();
        },
        endDay() {
            clearInterval(App.state.dayTimerInterval);
            const consultantId = App.state.currentUser.assignedConsultantId;
            const todayStr = new Date().toISOString().slice(0, 10);
            const todaysLog = App.DB.get('activityLog').filter(e => e.consultantId === consultantId && e.date === todayStr);

            const visitsCompleted = todaysLog.filter(e => e.action.includes('completed visit')).length;
            const paymentsRecorded = todaysLog.filter(e => e.action.includes('recorded a payment'));
            const totalCollected = paymentsRecorded.reduce((sum, p) => sum + (p.amount || 0), 0);
            const workTime = document.getElementById('work-timer')?.textContent || 'N/A';
            
            Swal.fire({
                title: 'Day Summary',
                html: `
                    <div style="text-align: left; padding: 0 1rem;">
                        <p><strong>Total Work Time:</strong> ${workTime}</p>
                        <p><strong>Visits Completed:</strong> ${visitsCompleted}</p>
                        <p><strong>Payments Collected:</strong> ${paymentsRecorded.length} (${App.Helpers.formatCurrency(totalCollected)})</p>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'Great!',
                background: 'var(--card-bg)',
                color: 'var(--text-primary)'
            }).then(() => {
                App.Helpers.logActivity('Ended Day');
                App.UI.toast('Day Ended! Well done.', 'info');
                this.render();
            });
        },
        startBreak() {
            clearInterval(App.state.dayTimerInterval);
            App.state.breakStartTime = Date.now();
            App.Helpers.logActivity('Started Break');
            this.render();
        },
        endBreak() {
            if (!App.state.breakStartTime) return;
            const breakDuration = Date.now() - App.state.breakStartTime;
            App.state.totalBreakTime += breakDuration;
            App.Helpers.logActivity('Ended Break', `Duration: ${Math.round(breakDuration/60000)} min`, null, null, null, breakDuration);
            App.state.breakStartTime = null;
            this.render(); 
        },
        startTimer(startTime) {
            clearInterval(App.state.dayTimerInterval);
            const timerElement = document.getElementById('work-timer');
            if (!timerElement) return;

            if (App.state.breakStartTime) {
                const activeTimeBeforeBreak = (App.state.breakStartTime - startTime) - App.state.totalBreakTime;
                timerElement.textContent = App.Helpers.formatDuration(Math.max(0, activeTimeBeforeBreak));
                return;
            }
            
            const startTimestamp = startTime;
            App.state.dayTimerInterval = setInterval(() => {
                const activeTime = (Date.now() - startTimestamp) - App.state.totalBreakTime;
                timerElement.textContent = App.Helpers.formatDuration(Math.max(0, activeTime));
            }, 1000);
        },
        animateCounter(id, t, isC = false) { let e = document.getElementById(id); if (!e) return; let n = 0, i = Math.max(1, Math.ceil(t / 100)); const u = () => { n += i; if (n < t) { e.textContent = isC ? App.Helpers.formatCurrency(Math.ceil(n)) : Math.ceil(n); requestAnimationFrame(u) } else { e.textContent = isC ? App.Helpers.formatCurrency(t) : t } }; u() }, 
        renderCharts() { 
            const c = App.Helpers.getScopedData('customers'), p = App.Helpers.getScopedData('payments'), tc = '#212529', bc = '#dee2e6'; const dbe = c.reduce((a, i) => { a[i.emirate] = (a[i.emirate] || 0) + i.outstanding; return a }, {}); 
            const debtChartEl = document.getElementById('debt-chart'); if (!debtChartEl) return; 
            if (this.charts.debt) this.charts.debt.destroy(); 
            this.charts.debt = new Chart(debtChartEl, { 
                type: 'bar', 
                data: { labels: Object.keys(dbe), datasets: [{ label: 'Outstanding Debt', data: Object.values(dbe), backgroundColor: ['#e2000f', '#10b981', '#ffc107', '#6c757d'], borderWidth: 0 }] }, 
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } 
            }); 
            
            // Monthly Payment Recovery Chart with Targets
            const paymentChartEl = document.getElementById('payment-chart'); if (!paymentChartEl) return; 
            if (this.charts.payment) this.charts.payment.destroy(); 

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            const monthlyData = { collected: Array(12).fill(0), target: Array(12).fill(0) };
            
            p.filter(payment => new Date(payment.date).getFullYear() === currentYear && payment.status === 'Completed').forEach(payment => {
                const monthIndex = new Date(payment.date).getMonth();
                monthlyData.collected[monthIndex] += payment.amount;
            });
            
            App.DB.get('forecasts').filter(f => f.month.startsWith(currentYear)).forEach(forecast => {
                const monthIndex = parseInt(forecast.month.split('-')[1], 10) - 1;
                monthlyData.target[monthIndex] += forecast.amount;
            });

            this.charts.payment = new Chart(paymentChartEl, { 
                type: 'bar', 
                data: { 
                    labels: months, 
                    datasets: [
                        { label: 'Target', data: monthlyData.target, backgroundColor: 'rgba(220, 53, 69, 0.5)', borderRadius: 4 },
                        { label: 'Collected', data: monthlyData.collected, backgroundColor: 'rgba(16, 185, 129, 0.7)', borderRadius: 4 }
                    ] 
                }, 
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: tc }, grid: { color: bc } }, x: { ticks: { color: tc }, grid: { color: 'transparent' } } }, plugins: { legend: { labels: { color: tc } } } } 
            }); 
        }, 
        renderRecoveryProgress() { const customers = App.Helpers.getScopedData('customers'); const totalInitialDebt = customers.reduce((sum, c) => sum + c.initialDebt, 0); const totalOutstanding = customers.reduce((sum, c) => sum + c.outstanding, 0); const totalCollected = totalInitialDebt - totalOutstanding; const percentage = totalInitialDebt > 0 ? ((totalCollected / totalInitialDebt) * 100).toFixed(0) : 0; const container = document.getElementById('recovery-progress-card'); container.innerHTML = `<div class="d-flex align-items-center gap-2 mb-4"><i class="fas fa-bullseye" style="color: var(--primary);"></i><h3 class="card-title" style="margin:0;">Recovery Progress</h3></div><div><div class="mb-2" style="font-weight: 600; text-transform: uppercase; font-size: var(--fs-sm); color: var(--text-secondary);">Total Debt vs Collected</div><div class="progress-bar mb-2"><div class="progress-bar-inner" data-width="${percentage}"></div></div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${App.Helpers.formatCurrency(totalCollected)} collected of ${App.Helpers.formatCurrency(totalInitialDebt)} (${percentage}%)</div></div>`; App.UI.observeProgressBars(); } 
    });
	    Object.assign(App.Customers, { quill: null, setupEventListeners: function() { document.getElementById('add-customer-btn').addEventListener('click', () => this.showCustomerForm()); document.getElementById('import-customer-btn').addEventListener('click', () => { document.getElementById('csv-filename').textContent = ''; App.UI.openModal('import-csv-modal'); }); document.getElementById('export-customers-csv').addEventListener('click', () => App.Helpers.exportTableData('csv', 'Customers', this.getCurrentFilteredData, ['accountNo', 'companyName', 'outstanding', 'forecastAmount', 'salesConsultantId', 'paymentStatus'])); document.getElementById('export-customers-pdf').addEventListener('click', () => App.Helpers.exportTableData('pdf', 'Customers', this.getCurrentFilteredData, ['accountNo', 'companyName', 'outstanding', 'forecastAmount', 'salesConsultantId', 'paymentStatus'])); document.getElementById('customer-form').addEventListener('submit', (e) => this.saveCustomer(e)); document.getElementById('customer-forecast-form').addEventListener('submit', (e) => this.saveCustomerForecast(e)); document.querySelector('#customers-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('customers', th.dataset.sort); }); const debouncedSearch = App.Helpers.debounce(() => {App.state.pagination.customers.currentPage = 1; this.render()}, 300); document.getElementById('customer-search').addEventListener('input', debouncedSearch); document.getElementById('customer-status-filter').addEventListener('change', () => {App.state.pagination.customers.currentPage = 1; this.render()}); document.getElementById('customer-payment-filter').addEventListener('change', () => {App.state.pagination.customers.currentPage = 1; this.render()}); document.getElementById('customer-table-body').addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; const id = button.dataset.id; if (button.classList.contains('view-customer')) this.showCustomerDetail(id); else if (button.classList.contains('edit-customer')) this.showCustomerForm(id); else if (button.classList.contains('delete-customer')) this.deleteCustomer(id); else if (button.classList.contains('set-forecast')) this.showCustomerForecastForm(id); }); 
        const detailModal = document.getElementById('customer-detail-modal');
        detailModal.addEventListener('click', (e) => { 
            const button = e.target.closest('button'); 
            if (!button) return; 
            if (button.classList.contains('detail-tab-btn')) this.switchDetailTab(button.dataset.tab); 
            else if (button.id === 'save-visit-notes-btn') this.saveVisitNoteFromDetail();
            else if (button.id === 'detail-record-payment-btn') {
                App.UI.closeModal('customer-detail-modal');
                App.Payments.showPaymentForm(App.state.activeCustomerId);
            } else if (button.id === 'detail-schedule-visit-btn') {
                App.UI.closeModal('customer-detail-modal');
                App.Visits.showScheduleModal(null, null, App.state.activeCustomerId);
            }
        }); 
    }, 
    getCurrentFilteredData: function() {
        const { value: search } = document.getElementById('customer-search'); 
        const { value: statusFilter } = document.getElementById('customer-status-filter'); 
        const { value: paymentFilter } = document.getElementById('customer-payment-filter'); 
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        let customers = App.Helpers.getScopedData('customers').filter(c => 
            (c.companyName.toLowerCase().includes(search.toLowerCase()) || 
             c.accountNo.toLowerCase().includes(search.toLowerCase()) || 
             (consultantMap[c.salesConsultantId] || '').toLowerCase().includes(search.toLowerCase())) &&
            (statusFilter === 'all' || c.status === statusFilter) && 
            (paymentFilter === 'all' || c.paymentStatus === paymentFilter)
        );
        const { column, order } = App.state.tableSorts.customers; 
        customers.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            if(column === 'salesConsultantId') {
                valA = consultantMap[valA] || '';
                valB = consultantMap[valB] || '';
            }
            if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            if (valA < valB) return order === 'asc' ? -1 : 1; 
            if (valA > valB) return order === 'asc' ? 1 : -1; 
            return 0; 
        });
        return customers;
    },
    render: function() { 
        if(App.state.currentUser.role === 'admin') {
            const customers = App.DB.get('customers');
            App.Dashboard.animateCounter('customer-kpi-total', customers.length);
            App.Dashboard.animateCounter('customer-kpi-outstanding', customers.reduce((sum, c) => sum + c.outstanding, 0), true);
            App.Dashboard.animateCounter('customer-kpi-active', customers.filter(c => c.status === 'Active').length);
        }
        App.Auth.checkRole(); 

        const filteredCustomers = this.getCurrentFilteredData();
        const { currentPage, rowsPerPage } = App.state.pagination.customers;
        const startIndex = (currentPage - 1) * rowsPerPage;
        const paginatedCustomers = filteredCustomers.slice(startIndex, startIndex + rowsPerPage);
        
        const customerHasPromise = (customerId) => {
            const today = new Date().toISOString().slice(0, 10);
            return App.DB.get('visits').some(v => v.customerId === customerId && v.outcome === 'Promise to Pay' && v.promiseDate && v.promiseDate >= today);
        };

        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const tbody = document.getElementById('customer-table-body'); 
        if (paginatedCustomers.length > 0) {
            tbody.innerHTML = paginatedCustomers.map(c => {
                const adminButtons = App.state.currentUser.role === 'admin' ? `<button class="btn btn-outline edit-customer" data-id="${c.accountNo}" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-customer" data-id="${c.accountNo}" title="Delete"><i class="fas fa-trash"></i></button>` : '';
                const userButtons = App.state.currentUser.role === 'user' ? `<button class="btn btn-outline set-forecast" data-id="${c.accountNo}" title="Set Forecast"><i class="fas fa-bullseye"></i></button>` : '';
                const promiseIcon = customerHasPromise(c.accountNo) ? '<span title="Has active promise"> </span>' : '';

                return `<tr>
                    <td>${c.accountNo}</td>
                    <td><div class="company-info"><div class="name">${c.companyName}${promiseIcon}</div><div class="location" style="color: var(--text-secondary); font-size: var(--fs-sm);">${c.emirate}</div></div></td>
                    <td>${App.Helpers.formatCurrency(c.outstanding)}</td>
                    <td>${App.Helpers.formatCurrency(c.forecastAmount || 0)}</td>
                    <td>${consultantMap[c.salesConsultantId] || 'N/A'}</td>
                    <td><span class="status-badge ${c.paymentStatus.toLowerCase()}">${c.paymentStatus}</span></td>
                    <td class="d-flex gap-2">
                        <button class="btn btn-outline view-customer" data-id="${c.accountNo}" title="View"><i class="fas fa-eye"></i></button>
                        ${userButtons}
                        ${adminButtons}
                    </td>
                </tr>`
            }).join('');
        } else {
            const buttonHTML = App.state.currentUser.role === 'admin' ? `<button class="btn btn-primary" onclick="App.Customers.showCustomerForm()"><i class="fas fa-plus"></i> Add First Customer</button>` : '';
            tbody.innerHTML = App.UI.getEmptyStateHTML('fa-users-slash', 'No Customers Found', 'Add a customer to get started.', buttonHTML);
        }
        App.UI.animateTableRows(tbody);
        App.UI.renderPaginationControls('customers', filteredCustomers.length);
        App.UI.updateSortIndicators('customers');
    }, 
    showCustomerForm: function(accountNo = null) { const form = document.getElementById('customer-form'); const accountNoInput = form.elements.accountNo; form.reset(); const consultantSelect = form.elements['salesConsultantId']; consultantSelect.innerHTML = App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join(''); let originalCustomer = null; if (accountNo) { const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); originalCustomer = {...customer}; document.getElementById('customer-modal-title').textContent = 'Edit Customer'; document.getElementById('customer-id-hidden').value = customer.accountNo; Object.keys(customer).forEach(key => { if (form.elements[key]) form.elements[key].value = customer[key]; }); accountNoInput.readOnly = true; accountNoInput.required = false; } else { document.getElementById('customer-modal-title').textContent = 'Add New Customer'; document.getElementById('customer-id-hidden').value = ''; accountNoInput.readOnly = false; accountNoInput.required = true; accountNoInput.placeholder = 'e.g., DXB-007'; } App.UI.openModal('customer-modal'); form.originalData = originalCustomer; }, 
    saveCustomer: function(e) { e.preventDefault(); const form = e.target; const id = form.elements['customer-id-hidden'].value; let customers = App.DB.get('customers'); const customerData = { companyName: form.elements.companyName.value, emirate: form.elements.emirate.value, area: form.elements.area.value, initialDebt: parseFloat(form.elements.initialDebt.value), outstanding: parseFloat(form.elements.outstanding.value), salesConsultantId: parseInt(form.elements.salesConsultantId.value), status: form.elements.status.value, paymentStatus: form.elements.paymentStatus.value, forecastAmount: parseFloat(form.elements.forecastAmount.value) || 0 }; if (id) { const index = customers.findIndex(c => c.accountNo === id); const original = form.originalData; const changes = App.Helpers.getObjectChanges(original, {...original, ...customerData}); customers[index] = { ...customers[index], ...customerData }; App.Helpers.logChange('Updated', 'Customer', `${customerData.companyName} (${id})`, changes); } else { const newAccountNo = form.elements.accountNo.value.trim(); if (!newAccountNo) { App.UI.toast('Account Number is required.', 'error'); return; } const accountExists = customers.some(c => c.accountNo.toLowerCase() === newAccountNo.toLowerCase()); if (accountExists) { App.UI.toast('Account Number already exists.', 'error'); return; } customerData.accountNo = newAccountNo; customers.push(customerData); App.Helpers.logActivity('added a new customer', customerData.companyName, customerData.accountNo); App.Helpers.logChange('Created', 'Customer', `${customerData.companyName} (${newAccountNo})`); } App.DB.set('customers', customers); App.UI.closeModal('customer-modal'); App.UI.toast(`Customer ${id ? 'updated' : 'added'}!`); this.render(); }, 
    showCustomerForecastForm(accountNo) {
        const customer = App.DB.get('customers').find(c => c.accountNo === accountNo);
        if (!customer) return App.UI.toast('Customer not found.', 'error');

        document.getElementById('customer-forecast-modal-title').textContent = `Set Forecast for ${customer.companyName}`;
        const form = document.getElementById('customer-forecast-form');
        form.elements['customer-forecast-accountNo'].value = customer.accountNo;
        form.elements['customer-forecast-amount'].value = customer.forecastAmount || '';
        App.UI.openModal('customer-forecast-modal');
    },
    saveCustomerForecast(e) {
        e.preventDefault();
        const form = e.target;
        const accountNo = form.elements['customer-forecast-accountNo'].value;
        const amount = parseFloat(form.elements['customer-forecast-amount'].value);

        if (isNaN(amount) || amount < 0) {
            return App.UI.toast('Please enter a valid forecast amount.', 'error');
        }

        let customers = App.DB.get('customers');
        const customerIndex = customers.findIndex(c => c.accountNo === accountNo);

        if (customerIndex > -1) {
            const originalAmount = customers[customerIndex].forecastAmount || 0;
            customers[customerIndex].forecastAmount = amount;
            App.DB.set('customers', customers);
            App.Helpers.logChange('Updated', 'Customer Forecast', `${customers[customerIndex].companyName}`, `'forecastAmount' changed from "${originalAmount}" to "${amount}"`);
            App.UI.toast('Forecast updated!', 'success');
            App.UI.closeModal('customer-forecast-modal');
            this.render();
        } else {
            App.UI.toast('Could not find customer to update.', 'error');
        }
    },
    showCustomerDetail: function(accountNo) { App.state.activeCustomerId = accountNo; const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {}); if (!customer) return; document.getElementById('customer-detail-title').innerHTML = `Customer: ${customer.companyName} <span style="color:var(--text-secondary); font-weight:500;">(${customer.accountNo})</span>`; this.renderDetailOverview(customer, consultantMap); this.renderDetailVisitNotes(customer); this.switchDetailTab('overview'); App.UI.openModal('customer-detail-modal'); }, renderDetailOverview: function(customer, consultantMap) { const payments = App.DB.get('payments').filter(p => p.customerId === customer.accountNo); const visits = App.DB.get('visits').filter(v => v.customerId === customer.accountNo).sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)); document.getElementById('overview-content').innerHTML = `<div class="detail-info-grid"><div class="detail-info-card"><div class="label">Account #</div><div class="value">${customer.accountNo}</div></div><div class="detail-info-card"><div class="label">Location</div><div class="value">${customer.area}, ${customer.emirate}</div></div><div class="detail-info-card"><div class="label">Account Status</div><div class="value"><span class="status-badge ${customer.status.toLowerCase()}">${customer.status}</span></div></div><div class="detail-info-card"><div class="label">Payment Status</div><div class="value"><span class="status-badge ${customer.paymentStatus.toLowerCase()}">${customer.paymentStatus}</span></div></div><div class="detail-info-card"><div class="label">Outstanding</div><div class="value">${App.Helpers.formatCurrency(customer.outstanding)}</div></div><div class="detail-info-card"><div class="label">Sales Consultant</div><div class="value">${consultantMap[customer.salesConsultantId] || 'N/A'}</div></div></div><h4 class="card-title mb-4">Payment History</h4>${payments.length > 0 ? `<div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Amount</th><th>Method</th><th>Status</th></tr></thead><tbody>${payments.map(p => `<tr><td>${App.Helpers.formatDate(p.date)}</td><td>${App.Helpers.formatCurrency(p.amount)}</td><td>${p.method}</td><td><span class="status-badge ${p.status.toLowerCase()}">${p.status}</span></td></tr>`).join('')}</tbody></table></div>` : '<p>No payments recorded.</p>'}<h4 class="card-title mt-4 mb-4">Visit Notes History</h4>${visits.length > 0 ? visits.map(v => `<div class="card mb-4" style="background:var(--bg-color);"><p><strong>${App.Helpers.formatDateTime(v.dateTime)}: ${v.contactMethod || v.purpose} ${v.outcome ? `(${v.outcome})` : ''}</strong></p>${v.notes || ''}</div>`).join('') : '<p>No visit notes recorded.</p>'}`; App.UI.animateTableRows(document.querySelector('#overview-content .data-table tbody')); }, renderDetailVisitNotes: function(customer) { document.getElementById('visit-notes-content').innerHTML = `<div class="form-grid"><div class="form-group"><label>CONTACT METHOD</label><select id="visit-contact-method" class="form-control"><option>Site Visit</option><option>Phone Call</option><option>Email</option></select></div><div class="form-group"><label>OUTCOME</label><select id="visit-outcome" class="form-control"><option>No Answer</option><option>Promise to Pay</option><option>Dispute</option><option>Paid in Full</option><option>Partial Payment</option></select></div></div><div class="form-group"><label>NOTES</label><div id="quill-editor" style="height:150px;"></div></div><div class="form-grid"><div class="form-group"><label>SCHEDULE NEXT VISIT (Optional)</label><input type="date" id="visit-next-date" class="form-control"></div><div class="form-group"><label>LOCATION</label><button type="button" class="btn btn-outline" id="tag-location-btn" style="width:100%;"><i class="fas fa-map-marker-alt"></i> <span id="location-tag-text">Tag Current Location</span></button></div></div><div class="d-flex" style="justify-content:flex-end;"><button type="button" class="btn btn-primary" id="save-visit-notes-btn">Save Notes</button></div>`; if (this.quill) { this.quill = null; } this.quill = new Quill('#quill-editor', { theme: 'snow', placeholder: 'Enter contact notes...' }); }, switchDetailTab: function(tabId) { document.querySelectorAll('.detail-tab-btn').forEach(btn => btn.classList.remove('active')); document.querySelector(`.detail-tab-btn[data-tab="${tabId}"]`)?.classList.add('active'); document.querySelectorAll('#customer-detail-content .tab-content').forEach(c => c.classList.add('hidden')); document.getElementById(`${tabId}-content`).classList.remove('hidden'); }, saveVisitNoteFromDetail: function() { const customerId = App.state.activeCustomerId; const contactMethod = document.getElementById('visit-contact-method').value; const outcome = document.getElementById('visit-outcome').value; const notes = this.quill.root.innerHTML; const nextVisitDate = document.getElementById('visit-next-date').value; let visits = App.DB.get('visits'); const customer = App.DB.get('customers').find(c => c.accountNo === customerId); const newNote = { id: `v${Date.now()}`, customerId, dateTime: new Date().toISOString(), purpose: `Follow-up: ${outcome}`, collectorId: customer.salesConsultantId, status: "Completed", contactMethod, outcome, notes, }; visits.push(newNote); if (nextVisitDate) { visits.push({ id: `v${Date.now() + 1}`, customerId, dateTime: `${nextVisitDate}`, purpose: 'Scheduled Follow-up', collectorId: newNote.collectorId, status: "Scheduled" }); } App.DB.set('visits', visits); App.Helpers.logChange('Added', 'Visit Note', `For ${customer.companyName}`); App.UI.toast('Visit note saved!'); App.UI.closeModal('customer-detail-modal'); }, deleteCustomer(accountNo) { const customer = App.DB.get('customers').find(c => c.accountNo === accountNo); Swal.fire({ title: `Delete ${customer.companyName}?`, text: "This will permanently delete the customer and all their associated payments and visits. This action cannot be undone.", input: 'textarea', inputLabel: 'Reason for deletion', inputPlaceholder: 'Enter your reason here...', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: 'var(--danger)', background: 'var(--card-bg)', color: 'var(--text-primary)', inputValidator: (value) => { if (!value) { return 'You must provide a reason for deletion!' } } }).then(result => { if (result.isConfirmed && result.value) { let customers = App.DB.get('customers'); let visits = App.DB.get('visits'); let payments = App.DB.get('payments'); App.DB.set('customers', customers.filter(c => c.accountNo !== accountNo)); App.DB.set('visits', visits.filter(v => v.customerId !== accountNo)); App.DB.set('payments', payments.filter(p => p.customerId !== accountNo)); App.Helpers.logChange('Deleted', 'Customer', `${customer.companyName} (${accountNo})`, `Reason: ${result.value}`); App.UI.toast('Customer deleted permanently.', 'success'); this.render(); } }); } });
	    Object.assign(App.Visits, { calendar: null, logNotesQuill: null, map: null, setupEventListeners: function() { document.getElementById('visit-notes-form').addEventListener('submit', e => this.saveCompletedVisit(e)); document.getElementById('visit-form').addEventListener('submit', (e) => this.saveScheduledVisit(e)); document.getElementById('export-visits-csv').addEventListener('click', () => App.Helpers.exportTableData('csv', 'Visits', this.getCurrentFilteredData, ['dateTime', 'customerId', 'purpose', 'collectorId', 'status'])); document.getElementById('export-visits-pdf').addEventListener('click', () => App.Helpers.exportTableData('pdf', 'Visits', this.getCurrentFilteredData, ['dateTime', 'customerId', 'purpose', 'collectorId', 'status'])); const page = document.getElementById('visits-page'); const debouncedRender = App.Helpers.debounce(() => {App.state.pagination.visits.currentPage = 1; this.renderListView()}, 300); page.addEventListener('click', (e) => { const button = e.target.closest('button'); if (!button) return; if (button.classList.contains('visit-view-tab')) this.switchView(button.dataset.view); if (button.classList.contains('visit-filter-btn')) this.setFilter(button.dataset.filter); if (button.id === 'visit-date-apply') this.applyDateFilter(); if (button.classList.contains('mark-done-btn')) this.showMarkDoneModal(button.dataset.id); if (button.classList.contains('view-visit-btn')) this.showVisitDetail(button.dataset.id); if (button.id === 'schedule-visit-btn') this.showScheduleModal(); if (button.classList.contains('delete-visit')) this.deleteVisit(button.dataset.id); if(button.id === 'set-visit-date-today') this.setQuickDate('today'); if(button.id === 'set-visit-date-tomorrow') this.setQuickDate('tomorrow'); }); 
        document.getElementById('visit-search').addEventListener('input', (e) => { App.state.visits.search = e.target.value; debouncedRender(); });
        document.getElementById('visit-consultant-filter').addEventListener('change', (e) => { App.state.pagination.visits.currentPage = 1; App.state.visits.consultantFilter = e.target.value; this.renderListView(); });
        document.getElementById('map-consultant-filter').addEventListener('change', (e) => { App.state.visits.mapConsultant = e.target.value; this.renderMapView(); });
        document.getElementById('map-date-filter').addEventListener('change', (e) => { App.state.visits.mapDate = e.target.value; this.renderMapView(); });
        document.querySelector('#visits-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('visits', th.dataset.sort); });
        
        const visitNotesModal = document.getElementById('visit-notes-modal');
        visitNotesModal.addEventListener('click', e => { 
            const button = e.target.closest('button');
            if (!button) return;
            if (button.id === 'log-location-btn') this.tagLocationForVisitLog(); 
            if (button.id === 'log-record-payment-btn') {
                const visitId = document.getElementById('mark-done-visit-id').value;
                const visit = App.DB.get('visits').find(v => v.id === visitId);
                if (visit) {
                    App.state.paymentFlowOrigin = { visitId: visit.id, paymentLogged: false };
                    App.Payments.showPaymentForm(visit.customerId);
                }
            }
        }); 
        visitNotesModal.addEventListener('change', e => {
            if (e.target.id === 'log-outcome') {
                document.getElementById('promise-to-pay-fields').classList.toggle('hidden', e.target.value !== 'Promise to Pay');
            }
        });
    }, 
    setQuickDate(period) {
        const date = new Date();
        if(period === 'tomorrow') date.setDate(date.getDate() + 1);
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        document.getElementById('visit-start-date').value = `${yyyy}-${mm}-${dd}`;
        document.getElementById('visit-end-date').value = `${yyyy}-${mm}-${dd}`;
    },
    getCurrentFilteredData: function() {
        let visits = App.Helpers.getScopedData('visits'); 
        const { filter, startDate, endDate, search, consultantFilter } = App.state.visits; 
        const today = new Date().setHours(0, 0, 0, 0); 
        const customerMap = App.DB.get('customers').reduce((map, c) => {map[c.accountNo] = c.companyName; return map;}, {});

        if (search) {
            const lowerSearch = search.toLowerCase();
            visits = visits.filter(v => 
                (customerMap[v.customerId] || '').toLowerCase().includes(lowerSearch) ||
                (v.purpose || '').toLowerCase().includes(lowerSearch)
            );
        }

        if (consultantFilter !== 'all') {
            visits = visits.filter(v => v.collectorId == consultantFilter);
        }

        if (filter !== 'All' && !(startDate && endDate)) { visits = visits.filter(v => { const visitDate = new Date(v.dateTime).setHours(0, 0, 0, 0); if (filter === 'Overdue') return (v.status === 'Scheduled' || v.status === 'Overdue') && visitDate < today; if (filter === 'Today') return visitDate === today; if (filter === 'Upcoming') return v.status === 'Scheduled' && visitDate >= today; return false; }); } 
        if (startDate && endDate) { visits = visits.filter(v => { const visitDateOnly = new Date(v.dateTime).toISOString().slice(0, 10); return visitDateOnly >= startDate && visitDateOnly <= endDate; }); }
        
        const { column, order } = App.state.tableSorts.visits;
        const consultants = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});

        visits.sort((a, b) => {
            let valA, valB;
            if (column === 'customerId') { valA = customerMap[a.customerId] || ''; valB = customerMap[b.customerId] || ''; } 
            else if (column === 'collectorId') { valA = consultants[a.collectorId] || ''; valB = consultants[b.collectorId] || ''; } 
            else { valA = a[column]; valB = b[column]; }

            if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });

        return visits;
    },
    render: function() { 
        this.checkOverdueVisits();
        
        const allVisits = App.DB.get('visits');
        const todayStr = new Date().toISOString().slice(0,10);
        App.Dashboard.animateCounter('visit-kpi-upcoming', allVisits.filter(v => v.status === 'Scheduled' && new Date(v.dateTime) >= new Date()).length);
        App.Dashboard.animateCounter('visit-kpi-overdue', allVisits.filter(v => v.status === 'Overdue').length);
        App.Dashboard.animateCounter('visit-kpi-completed-today', allVisits.filter(v => v.status === 'Completed' && v.dateTime.startsWith(todayStr)).length);
        
        const consultantFilter = document.getElementById('visit-consultant-filter');
        consultantFilter.innerHTML = '<option value="all">All Consultants</option>' + App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        consultantFilter.value = App.state.visits.consultantFilter;

        if (App.state.visits.activeView === 'list') this.renderListView(); 
        else if (App.state.visits.activeView === 'calendar') this.renderCalendarView();
        else if (App.state.visits.activeView === 'map') this.renderMapView();
    }, 
    switchView: function(view) { 
        App.state.visits.activeView = view; 
        document.querySelectorAll('.visit-view-tab').forEach(t => t.classList.remove('active')); 
        document.querySelector(`.visit-view-tab[data-view="${view}"]`).classList.add('active'); 
        document.querySelectorAll('.visit-view-content').forEach(c => c.classList.add('hidden')); 
        document.getElementById(`${view}-view-content`).classList.remove('hidden'); 
        
        document.getElementById('list-view-controls').style.display = view === 'list' ? 'flex' : 'none';
        document.getElementById('map-view-controls').classList.toggle('hidden', view !== 'map');
        document.getElementById('map-view-controls').style.display = view === 'map' ? 'flex' : 'none';
        
        this.render(); 
    }, 
    setFilter: function(filter) { App.state.visits.filter = filter; App.state.pagination.visits.currentPage = 1; document.getElementById('visit-start-date').value = ''; document.getElementById('visit-end-date').value = ''; App.state.visits.startDate = ''; App.state.visits.endDate = ''; document.querySelectorAll('.visit-filter-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.visit-filter-btn[data-filter="${filter}"]`).classList.add('active'); this.renderListView(); }, 
    applyDateFilter: function() { const startDate = document.getElementById('visit-start-date').value; const endDate = document.getElementById('visit-end-date').value; if (!startDate || !endDate) { App.UI.toast('Please select both a start and end date.', 'warning'); return; } App.state.pagination.visits.currentPage = 1; App.state.visits.startDate = startDate; App.state.visits.endDate = endDate; App.state.visits.filter = 'Custom'; document.querySelectorAll('.visit-filter-btn').forEach(b => b.classList.remove('active')); this.renderListView(); }, 
    renderListView: function() { 
        const isAdmin = App.state.currentUser.role === 'admin';
        let headers = [
            { text: 'Date', sortKey: 'dateTime' },
            { text: 'Customer', sortKey: 'customerId' },
            { text: 'Purpose', sortKey: 'purpose' }
        ];
        if (isAdmin) {
            headers.push({ text: 'Consultant', sortKey: 'collectorId' });
        }
        headers.push({ text: 'Status', sortKey: 'status' }, { text: 'Actions', sortKey: null });

        const thead = document.querySelector('#visits-page .data-table thead');
        thead.innerHTML = `<tr>${headers.map(h => `<th ${h.sortKey ? `data-sort="${h.sortKey}"` : ''}>${h.text}</th>`).join('')}</tr>`;

        const visits = this.getCurrentFilteredData();
        const { currentPage, rowsPerPage } = App.state.pagination.visits;
        const startIndex = (currentPage - 1) * rowsPerPage;
        const paginatedVisits = visits.slice(startIndex, startIndex + rowsPerPage);
        
        const customers = App.DB.get('customers'); 
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const tbody = document.getElementById('visit-table-body'); 
        if (paginatedVisits.length > 0) {
            tbody.innerHTML = paginatedVisits.map(v => { 
                const consultantCell = isAdmin ? `<td>${consultantMap[v.collectorId] || 'N/A'}</td>` : '';
                
                const actions = [];
                const isPending = v.status === 'Scheduled' || v.status === 'Overdue';
                
                if (isPending) {
                    if (isAdmin) {
                        actions.push(`<button class="btn btn-outline view-visit-btn" data-id="${v.id}" title="View Details"><i class="fas fa-eye"></i></button>`);
                    } else {
                        actions.push(`<button class="btn btn-success mark-done-btn" data-id="${v.id}" title="Mark as Done"><i class="fas fa-check"></i></button>`);
                    }
                } else if (v.status === 'Completed') {
                    actions.push(`<button class="btn btn-outline view-visit-btn" data-id="${v.id}" title="View Details"><i class="fas fa-eye"></i></button>`);
                }

                if (isAdmin) {
                    actions.push(`<button class="btn btn-danger delete-visit" data-id="${v.id}" title="Delete"><i class="fas fa-trash"></i></button>`);
                }
                
                return `<tr><td>${App.Helpers.formatDateTime(v.dateTime)}</td><td>${customers.find(c => c.accountNo === v.customerId)?.companyName || 'N/A'}</td><td>${v.purpose}</td>${consultantCell}<td><span class="status-badge ${v.status.toLowerCase()}">${v.status}</span></td><td><div class="d-flex gap-2">${actions.join('')}</div></td></tr>`; 
            }).join('');
        } else {
            const buttonHTML = `<button class="btn btn-primary" onclick="App.Visits.showScheduleModal()"><i class="fas fa-plus"></i> Schedule a Visit</button>`;
            tbody.innerHTML = App.UI.getEmptyStateHTML('fa-calendar-times', 'No Visits Found', 'Try adjusting your filters or schedule a new visit.', buttonHTML);
        }
        App.UI.animateTableRows(tbody);
        App.UI.renderPaginationControls('visits', visits.length);
        App.UI.updateSortIndicators('visits');
    }, 
    renderCalendarView: function() { const el = document.getElementById('calendar-view'); if (this.calendar) this.calendar.destroy(); const v = App.Helpers.getScopedData('visits'), c = App.DB.get('customers'); const ev = v.map(i => ({ id: i.id, title: `${c.find(cu => cu.accountNo === i.customerId)?.companyName || 'N/A'} - ${i.purpose}`, start: i.dateTime, backgroundColor: i.status === 'Completed' ? 'var(--success)' : i.status === 'Overdue' ? 'var(--danger)' : 'var(--primary)' })); this.calendar = new FullCalendar.Calendar(el, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, events: ev, editable: true, dateClick: (info) => this.showScheduleModal(null, info.dateStr), eventClick: (info) => this.showScheduleModal(info.event.id) }); this.calendar.render(); }, 
    renderMapView: function() {
        const mapContainer = document.getElementById('map-view');
        if (!mapContainer) return;

        const isAdmin = App.state.currentUser.role === 'admin';
        const consultantFilterEl = document.getElementById('map-consultant-filter');
        const dateFilterEl = document.getElementById('map-date-filter');
        
        if (isAdmin) {
            consultantFilterEl.innerHTML = '<option value="all">All Consultants</option>' + App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            consultantFilterEl.value = App.state.visits.mapConsultant;
        }
        dateFilterEl.value = App.state.visits.mapDate;


        if (this.map) {
            this.map.remove();
            this.map = null;
        }
        
        this.map = L.map('map-view').setView([25.2048, 55.2708], 10);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(this.map);

        let visitsToDisplay = App.DB.get('visits')
            .filter(v => v.status === 'Completed' && v.location && v.dateTime.startsWith(App.state.visits.mapDate));

        if (isAdmin && App.state.visits.mapConsultant !== 'all') {
            visitsToDisplay = visitsToDisplay.filter(v => v.collectorId == App.state.visits.mapConsultant);
        } else if (!isAdmin) {
            visitsToDisplay = visitsToDisplay.filter(v => v.collectorId === App.state.currentUser.assignedConsultantId);
        }
        
        visitsToDisplay.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

        const customers = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c.companyName; return map; }, {});
        const consultants = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        
        const markers = [];
        const latLngs = [];

        if (visitsToDisplay.length > 0) {
            visitsToDisplay.forEach((visit, index) => {
                const [lat, lon] = visit.location.split(',').map(coord => parseFloat(coord.trim()));

                if (!isNaN(lat) && !isNaN(lon)) {
                    let popupContent = `
                        <b>${index + 1}. ${customers[visit.customerId] || 'N/A'}</b><br>
                        <b>Time:</b> ${App.Helpers.formatDateTime(visit.dateTime)}<br>
                        <b>Outcome:</b> ${visit.outcome || 'N/A'}
                    `;
                    if (isAdmin) {
                        popupContent += `<br><b>Consultant:</b> ${consultants[visit.collectorId] || 'N/A'}`;
                    }
                    
                    const numberedIcon = L.divIcon({
                        className: 'numbered-marker',
                        html: `<div>${index + 1}</div>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });

                    const marker = L.marker([lat, lon], { icon: numberedIcon }).addTo(this.map).bindPopup(popupContent);
                    markers.push(marker);
                    latLngs.push([lat, lon]);
                }
            });

            if (latLngs.length > 1) {
                L.polyline(latLngs, { color: 'var(--primary)', weight: 3, opacity: 0.7 }).addTo(this.map);
            }
            
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                this.map.fitBounds(group.getBounds().pad(0.2));
            }
        } else {
             mapContainer.innerHTML = '<div class="empty-state"><i class="fas fa-map-marker-slash"></i><h4>No Tagged Visits Found</h4><p>No completed visits with tagged locations found for the selected consultant and date.</p></div>';
        }
    },
    showScheduleModal: function(id = null, d = null, customerId = null) { 
        const f = document.getElementById('visit-form'); 
        f.reset(); 
        f.elements['visit-id'].value = ''; 
        const dateInput = f.elements['visit-date'];

        const container = document.getElementById('visit-customer-select-container');
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const customers = App.Helpers.getScopedData('customers').map(c => ({
            id: c.accountNo, 
            mainText: `${c.companyName}`,
            secondaryText: `${c.accountNo}  |  ${consultantMap[c.salesConsultantId] || 'Unassigned'}`
        }));
        const dropdown = App.UI.createSearchableDropdown(container, customers, null, 'Search by Name, Account #, or Consultant...');

        if (id) { 
            const visit = App.DB.get('visits').find(v => v.id === id); 
            if (visit) { 
                f.elements['visit-id'].value = visit.id; 
                dropdown.setValue(visit.customerId);
                f.elements['visit-purpose'].value = visit.purpose; 
                dateInput.value = visit.dateTime.slice(0, 16); // Format for datetime-local
            } 
        } else if (d) { 
            dateInput.value = d + 'T09:00'; // Default to 9 AM on the clicked date
        }
        if (customerId) {
            dropdown.setValue(customerId);
        }
        App.UI.openModal('visit-modal'); 
    }, 
    saveScheduledVisit: function(e) { 
        e.preventDefault(); 
        const f = e.target; 
        const customerId = document.querySelector('#visit-customer-select-container input[type="hidden"]').value; 
        if(!customerId) return App.UI.toast('Please select a customer.', 'error'); 
        const customer = App.DB.get('customers').find(c => c.accountNo === customerId); 
        const vd = { 
            customerId: customerId, 
            purpose: f.elements['visit-purpose'].value, 
            dateTime: f.elements['visit-date'].value, 
            status: 'Scheduled', 
            collectorId: customer ? customer.salesConsultantId : null 
        }; 
        let v = App.DB.get('visits'), id = f.elements['visit-id'].value; 
        if (id) { 
            const i = v.findIndex(vi => vi.id === id);
            const original = v[i];
            const changes = App.Helpers.getObjectChanges(original, {...original, ...vd});
            v[i] = { ...v[i], ...vd, id: id }; 
            App.Helpers.logChange('Updated', 'Visit', `For ${customer.companyName}`, changes); 
        } else { 
            vd.id = `visit-${Date.now()}`; 
            v.push(vd); 
            App.Helpers.logChange('Scheduled', 'Visit', `For ${customer.companyName}`); 
        } 
        App.DB.set('visits', v); 
        App.UI.closeModal('visit-modal'); 
        App.UI.toast('Visit saved!'); 
        this.render(); 
    },
    showMarkDoneModal: function(visitId) { 
        document.getElementById('visit-notes-form').reset(); 
        document.getElementById('mark-done-visit-id').value = visitId; 
        document.getElementById('log-location-text').textContent = 'Tag Current Location'; 
        document.getElementById('log-location-hidden').value = ''; 
        if (!this.logNotesQuill) this.logNotesQuill = new Quill('#log-notes-editor', { theme: 'snow', placeholder: 'Enter contact notes...' }); 
        this.logNotesQuill.root.innerHTML = ''; 
        App.state.paymentFlowOrigin = null;
        document.getElementById('promise-to-pay-fields').classList.add('hidden');
        this.updateVisitNotesUI();
        App.UI.openModal('visit-notes-modal'); 
    }, 
    updateVisitNotesUI: function() {
        const button = document.getElementById('log-record-payment-btn');
        if (!button) return;

        if (App.state.paymentFlowOrigin && App.state.paymentFlowOrigin.paymentLogged) {
            button.innerHTML = `<i class="fas fa-check-circle"></i> Payment Logged`;
            button.disabled = true;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline');
        } else {
            button.innerHTML = `<i class="fas fa-dollar-sign"></i> Record Payment`;
            button.disabled = false;
            button.classList.add('btn-success');
            button.classList.remove('btn-outline');
        }
    },
    showVisitDetail: function(visitId) { const visit = App.DB.get('visits').find(v => v.id === visitId); if (!visit) return App.UI.toast('Visit not found.', 'error'); const customer = App.DB.get('customers').find(c => c.accountNo === visit.customerId); const contentEl = document.getElementById('visit-detail-content'); const locationHTML = visit.location ? `<a href="https://www.google.com/maps?q=${visit.location}" target="_blank" style="color:var(--primary);">${visit.location}</a>` : 'N/A'; contentEl.innerHTML = `<div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));"><div class="detail-info-card"><div class="label">Customer</div><div class="value">${customer ? customer.companyName : 'N/A'}</div></div><div class="detail-info-card"><div class="label">Visit Date</div><div class="value">${App.Helpers.formatDateTime(visit.dateTime)}</div></div><div class="detail-info-card"><div class="label">Contact Method</div><div class="value">${visit.contactMethod || 'N/A'}</div></div><div class="detail-info-card"><div class="label">Outcome</div><div class="value">${visit.outcome || 'N/A'}</div></div><div class="detail-info-card"><div class="label">Location</div><div class="value">${locationHTML}</div></div></div><hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-6) 0;"><h4 class="card-title mb-4">Notes</h4><div class="card" style="background:var(--bg-color);">${visit.notes || '<p>No notes were entered for this visit.</p>'}</div>`; App.UI.openModal('visit-detail-modal'); }, 
    saveCompletedVisit: function(e) { 
        e.preventDefault(); 
        const form = e.target; 
        const visitId = form.elements['mark-done-visit-id'].value; 
        const location = document.getElementById('log-location-hidden').value; 
        let visits = App.DB.get('visits'); 
        const visitIndex = visits.findIndex(v => v.id === visitId); 
        if (visitIndex > -1) { 
            const visit = visits[visitIndex]; 
            visit.status = "Completed"; 
            visit.dateTime = new Date().toISOString(); // Update dateTime to now on completion
            visit.contactMethod = form.elements['log-contact-method'].value; 
            visit.outcome = form.elements['log-outcome'].value; 
            visit.notes = this.logNotesQuill.root.innerHTML; 
            if (location) { 
                visit.location = location; 
            }
            
            if (visit.outcome === 'Promise to Pay') {
                visit.promiseAmount = parseFloat(document.getElementById('log-promise-amount').value);
                visit.promiseDate = document.getElementById('log-promise-date').value;
                if (!visit.promiseAmount || !visit.promiseDate) {
                    return App.UI.toast('Please enter a promised amount and date.', 'error');
                }
            }
            
            const nextVisitDate = document.getElementById('log-next-date').value; 
            if (nextVisitDate) { visits.push({ id: `v${Date.now() + 1}`, customerId: visit.customerId, dateTime: `${nextVisitDate}T09:00`, purpose: 'Scheduled Follow-up', collectorId: visit.collectorId, status: "Scheduled" }); } 
            
            let logDetails = `(Outcome: ${visit.outcome})`;
            if(visit.location) { logDetails += ', Location Tagged'; }
            App.Helpers.logActivity('completed visit', logDetails, visit.customerId, null, visit.id); 
            App.Helpers.logChange('Completed', 'Visit', `For customer ${visit.customerId}`);
        } 
        App.DB.set('visits', visits); 
        App.UI.closeModal('visit-notes-modal'); 
        App.UI.toast('Visit marked as done!'); 
        this.render(); 
    }, 
    checkOverdueVisits: function() { let v = App.DB.get('visits'), c = false; const today = new Date(); today.setHours(0, 0, 0, 0); v.forEach(i => { if (i.status === 'Scheduled' && new Date(i.dateTime) < today) { i.status = 'Overdue'; c = true; } }); if (c) App.DB.set('visits', v); }, 
    tagLocationForVisitLog: function() { 
        if (!navigator.geolocation) return App.UI.toast('Geolocation not supported.', 'error'); 
        navigator.geolocation.getCurrentPosition(p => { 
            const coords = `${p.coords.latitude.toFixed(5)},${p.coords.longitude.toFixed(5)}`; 
            document.getElementById('log-location-text').textContent = `Tagged: ${coords}`; 
            document.getElementById('log-location-hidden').value = coords; 
            App.UI.toast('Location tagged for this note!'); 
        }, () => App.UI.toast('Unable to get location.', 'error')); 
    }, 
    deleteVisit(visitId) { const visit = App.DB.get('visits').find(v => v.id === visitId); Swal.fire({ title: `Delete this visit?`, text: "This action cannot be undone.", input: 'textarea', inputLabel: 'Reason for deletion', inputPlaceholder: 'Enter your reason here...', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: 'var(--danger)', background: 'var(--card-bg)', color: 'var(--text-primary)', inputValidator: (value) => { if (!value) { return 'You must provide a reason for deletion!' } } }).then(result => { if (result.isConfirmed && result.value) { let visits = App.DB.get('visits'); App.DB.set('visits', visits.filter(v => v.id !== visitId)); App.Helpers.logChange('Deleted', 'Visit', `${visit.purpose} for customer ${visit.customerId}`, `Reason: ${result.value}`); App.UI.toast('Visit deleted.', 'success'); this.render(); } }); } 
    });
	Object.assign(App.Payments, { 
        getCurrentFilteredData: function() {
            let payments = App.Helpers.getScopedData('payments');
            const { search, statusFilter, methodFilter } = App.state.payments;
            const customerMap = App.DB.get('customers').reduce((map, c) => {map[c.accountNo] = c.companyName; return map;}, {});
            const consultants = App.DB.get('consultants').reduce((map, c) => {map[c.id] = c.name; return map;}, {});
            const customerConsultantMap = App.DB.get('customers').reduce((map, c) => {map[c.accountNo] = consultants[c.salesConsultantId] || ''; return map;}, {});

            if (search) {
                const lowerSearch = search.toLowerCase();
                payments = payments.filter(p => (customerMap[p.customerId] || '').toLowerCase().includes(lowerSearch));
            }
            if (statusFilter !== 'all') {
                payments = payments.filter(p => p.status === statusFilter);
            }
            if (methodFilter !== 'all') {
                payments = payments.filter(p => p.method === methodFilter);
            }
            
            const { column, order } = App.state.tableSorts.payments;
            payments.sort((a, b) => {
                let valA, valB;
                if (column === 'customerId') {
                    valA = customerMap[a.customerId] || '';
                    valB = customerMap[b.customerId] || '';
                } else if (column === 'consultantId') {
                    valA = customerConsultantMap[a.customerId] || '';
                    valB = customerConsultantMap[b.customerId] || '';
                } else {
                    valA = a[column];
                    valB = b[column];
                }

                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            return payments;
        },
        render: function() { 
            const payments = App.DB.get('payments');
            const recoveredThisMonth = payments.filter(p => new Date(p.date).getMonth() === new Date().getMonth() && p.status === 'Completed').reduce((sum, p) => sum + p.amount, 0);
            App.Dashboard.animateCounter('payment-kpi-recovered-month', recoveredThisMonth, true);
            App.Dashboard.animateCounter('payment-kpi-total-count', payments.length);
            App.Dashboard.animateCounter('payment-kpi-pending', payments.filter(p => p.status === 'Pending').length);

            const filteredPayments = this.getCurrentFilteredData(); 
            const { currentPage, rowsPerPage } = App.state.pagination.payments;
            const startIndex = (currentPage - 1) * rowsPerPage;
            const paginatedPayments = filteredPayments.slice(startIndex, startIndex + rowsPerPage);
            
            const customers = App.DB.get('customers');
            const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
            const tbody = document.getElementById('payment-table-body');
            if (paginatedPayments.length > 0) {
                tbody.innerHTML = paginatedPayments.map(p => { 
                    const customer = customers.find(c => c.accountNo === p.customerId); 
                    const consultantName = customer ? consultantMap[customer.salesConsultantId] || 'N/A' : 'N/A';
                    const actions = [ `<button class="btn btn-outline view-payment" data-id="${p.id}" title="View Details"><i class="fas fa-eye"></i></button>`, App.state.currentUser.role === 'admin' ? `<button class="btn btn-danger delete-payment" data-id="${p.id}" title="Delete"><i class="fas fa-trash"></i></button>` : '' ].join(''); 
                    return `<tr><td>${App.Helpers.formatDate(p.date)}</td><td>${customer ? customer.companyName : 'N/A'}</td><td>${consultantName}</td><td>${App.Helpers.formatCurrency(p.amount)}</td><td>${p.method}</td><td><span class="status-badge ${p.status.toLowerCase()}">${p.status}</span></td><td><div class="d-flex gap-2">${actions}</div></td></tr>`; 
                }).join('');
            } else {
                const buttonHTML = `<button class="btn btn-success" onclick="App.Payments.showPaymentForm()"><i class="fas fa-plus"></i> Record First Payment</button>`;
                tbody.innerHTML = App.UI.getEmptyStateHTML('fa-credit-card', 'No Payments Found', 'Record a payment to see it listed here.', buttonHTML);
            }
            App.UI.animateTableRows(tbody);
            App.UI.renderPaginationControls('payments', filteredPayments.length);
            App.UI.updateSortIndicators('payments');
        }, 
        setupEventListeners: function() { 
            const debouncedRender = App.Helpers.debounce(() => {App.state.pagination.payments.currentPage = 1; this.render()}, 300);
            document.getElementById('record-payment-btn').addEventListener('click', () => this.showPaymentForm()); 
            document.getElementById('payment-form').addEventListener('submit', (e) => this.savePayment(e)); 
            document.getElementById('payment-table-body').addEventListener('click', (e) => { const viewButton = e.target.closest('.view-payment'); if (viewButton) this.showPaymentDetail(viewButton.dataset.id); const deleteButton = e.target.closest('.delete-payment'); if (deleteButton) this.deletePayment(deleteButton.dataset.id); }); 
            document.getElementById('export-payments-csv').addEventListener('click', () => App.Helpers.exportTableData('csv', 'Payments', this.getCurrentFilteredData, ['date', 'customerId', 'consultantId', 'amount', 'method', 'status'])); 
            document.getElementById('export-payments-pdf').addEventListener('click', () => App.Helpers.exportTableData('pdf', 'Payments', this.getCurrentFilteredData, ['date', 'customerId', 'consultantId', 'amount', 'method', 'status']));
            document.querySelector('#payments-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('payments', th.dataset.sort); });
            document.getElementById('payment-search').addEventListener('input', (e) => { App.state.payments.search = e.target.value; debouncedRender(); });
            document.getElementById('payment-status-filter').addEventListener('change', (e) => { App.state.pagination.payments.currentPage = 1; App.state.payments.statusFilter = e.target.value; this.render(); });
            document.getElementById('payment-method-filter').addEventListener('change', (e) => { App.state.pagination.payments.currentPage = 1; App.state.payments.methodFilter = e.target.value; this.render(); });
        }, 
        showPaymentForm: function(customerId = null) { 
            const form = document.getElementById('payment-form');
            form.reset(); 
            
            const container = document.getElementById('payment-customer-select-container');
            const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
            const customers = App.Helpers.getScopedData('customers').map(c => ({
                id: c.accountNo, 
                mainText: `${c.companyName}`,
                secondaryText: `${c.accountNo}  |  ${consultantMap[c.salesConsultantId] || 'Unassigned'}`
            }));
            const dropdown = App.UI.createSearchableDropdown(container, customers, null, 'Search by Name, Account #, or Consultant...');
            
            if (customerId) {
                dropdown.setValue(customerId);
            }
            document.getElementById('payment-date').valueAsDate = new Date(); 
            App.UI.openModal('payment-modal'); 
        }, 
        savePayment: function(e) { 
            e.preventDefault(); 
            const f = e.target;
            const cid = document.querySelector('#payment-customer-select-container input[type="hidden"]').value;
            if(!cid) return App.UI.toast('Please select a customer.', 'error');
            const a = parseFloat(f.elements['payment-amount'].value); 

            if (isNaN(a) || a <= 0) {
                return App.UI.toast('Please enter a valid, positive payment amount.', 'error');
            }

            const pd = { id: `p${Date.now()}`, customerId: cid, amount: a, method: f.elements['payment-method'].value, date: f.elements['payment-date'].value, status: f.elements['payment-status'].value }; 
            
            // If payment is completed, check if it fulfills a promise
            if (pd.status === 'Completed') {
                let visits = App.DB.get('visits');
                const promiseVisitIndex = visits.findIndex(v => v.customerId === cid && v.outcome === 'Promise to Pay' && v.promiseDate);
                if(promiseVisitIndex > -1) {
                    // Mark the promise as fulfilled by removing the date and amount
                    visits[promiseVisitIndex].promiseAmount = null;
                    visits[promiseVisitIndex].promiseDate = null;
                    App.DB.set('visits', visits);
                }
            }

            App.DB.set('payments', [...App.DB.get('payments'), pd]); 
            if (pd.status === 'Completed') { 
                let c = App.DB.get('customers'); 
                const ci = c.findIndex(cu => cu.accountNo === cid); 
                if (ci !== -1) { 
                    c[ci].outstanding -= a;
                    if (c[ci].forecastAmount) {
                        c[ci].forecastAmount = Math.max(0, c[ci].forecastAmount - a);
                    }
                    if (c[ci].outstanding <= 0) { c[ci].outstanding = 0; c[ci].paymentStatus = 'Cleared'; } else { c[ci].paymentStatus = 'Pending';} 
                    App.DB.set('customers', c); 
                } 
                App.Helpers.logActivity('recorded a payment', `(Method: ${pd.method})`, pd.customerId, pd.amount); 
                App.Helpers.logChange('Recorded', 'Payment', `${App.Helpers.formatCurrency(pd.amount)} for ${cid}`);
            } 
            
            App.UI.toast('Payment recorded!'); 
            
            if (App.state.paymentFlowOrigin) {
                App.state.paymentFlowOrigin.paymentLogged = true;
                App.UI.closeModal('payment-modal');
            } else {
                App.UI.closeModal('payment-modal');
                this.render(); 
                if (App.state.activePage === 'dashboard') App.Dashboard.render(); 
                if (App.state.activePage === 'customers') App.Customers.render();
            }
        }, 
        showPaymentDetail: function(paymentId) { const payment = App.DB.get('payments').find(p => p.id === paymentId); if (!payment) return; const customer = App.DB.get('customers').find(c => c.accountNo === payment.customerId); const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {}); const contentEl = document.getElementById('payment-detail-content'); contentEl.innerHTML = `<div class="detail-info-grid" style="grid-template-columns: 1fr 1fr; gap: var(--spacing-6);"><div class="detail-info-card"><div class="label">TRANSACTION ID</div><div class="value">${payment.id}</div></div><div class="detail-info-card"><div class="label">AMOUNT</div><div class="value" style="color: var(--success);">${App.Helpers.formatCurrency(payment.amount)}</div></div><div class="detail-info-card"><div class="label">PAYMENT DATE</div><div class="value">${App.Helpers.formatDate(payment.date)}</div></div><div class="detail-info-card"><div class="label">PAYMENT METHOD</div><div class="value">${payment.method}</div></div><div class="detail-info-card"><div class="label">STATUS</div><div class="value"><span class="status-badge ${payment.status.toLowerCase()}">${payment.status}</span></div></div></div><hr style="border: none; border-top: 1px solid var(--border-color); margin: var(--spacing-6) 0;"><h4 class="card-title mb-4">Customer Information</h4>${customer ? `<div class="detail-info-grid" style="grid-template-columns: 1fr 1fr;"><div class="detail-info-card"><div class="label">COMPANY NAME</div><div class="value">${customer.companyName}</div></div><div class="detail-info-card"><div class="label">ACCOUNT #</div><div class="value">${customer.accountNo}</div></div><div class="detail-info-card"><div class="label">SALES CONSULTANT</div><div class="value">${consultantMap[customer.salesConsultantId] || 'N/A'}</div></div><div class="detail-info-card"><div class="label">CURRENT OUTSTANDING</div><div class="value">${App.Helpers.formatCurrency(customer.outstanding)}</div></div></div>` : '<p>No customer associated with this payment.</p>'}`; App.UI.openModal('payment-detail-modal'); }, deletePayment(paymentId) { const payment = App.DB.get('payments').find(p => p.id === paymentId); Swal.fire({ title: `Delete this payment?`, text: "This will add the amount back to the customer's outstanding balance. This action cannot be undone.", input: 'textarea', inputLabel: 'Reason for deletion', inputPlaceholder: 'Enter your reason here...', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: 'var(--danger)', background: 'var(--card-bg)', color: 'var(--text-primary)', inputValidator: (value) => { if (!value) { return 'You must provide a reason for deletion!' } } }).then(result => { if (result.isConfirmed && result.value) { let payments = App.DB.get('payments'); let customers = App.DB.get('customers'); const customerIndex = customers.findIndex(c => c.accountNo === payment.customerId); if (customerIndex !== -1) { customers[customerIndex].outstanding += payment.amount; if (customers[customerIndex].outstanding > 0) { customers[customerIndex].paymentStatus = 'Pending'; } App.DB.set('customers', customers); } App.DB.set('payments', payments.filter(p => p.id !== paymentId)); App.Helpers.logChange('Deleted', 'Payment', `${App.Helpers.formatCurrency(payment.amount)} for customer ${payment.customerId}`, `Reason: ${result.value}`); App.UI.toast('Payment deleted and balance adjusted.', 'success'); this.render(); if(App.state.activePage === 'dashboard') App.Dashboard.render(); if(App.state.activePage === 'customers') App.Customers.render(); } }); } 
    });
	    Object.assign(App.Reports, { charts: {}, currentReportData: null, currentStatementData: null, currentConsultantVisitsData: null,  render: function() { 
        const consultantSelect = document.getElementById('report-consultant-select'); 
        if (consultantSelect) { 
            consultantSelect.innerHTML = App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('report-activity-start-date').value = firstDayOfMonth.toISOString().slice(0, 10);
            document.getElementById('report-activity-end-date').valueAsDate = today;
        } 
        
        const visitConsultantSelect = document.getElementById('report-visits-consultant-select');
        if (visitConsultantSelect) {
            visitConsultantSelect.innerHTML = '<option value="all">All Consultants</option>' + App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const today = new Date();
            document.getElementById('report-visits-start-date').valueAsDate = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('report-visits-end-date').valueAsDate = today;
        }

        const forecastConsultantSelect = document.getElementById('report-forecast-consultant-select');
        if(forecastConsultantSelect) {
            forecastConsultantSelect.innerHTML = '<option value="all">All Consultants</option>' + App.DB.get('consultants').map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            document.getElementById('report-forecast-month').value = currentMonth;
        }
        
        const container = document.getElementById('statement-customer-select-container');
        if(container) {
            const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
            const customers = App.DB.get('customers').map(c => ({
                id: c.accountNo,
                mainText: `${c.companyName}`,
                secondaryText: `${c.accountNo}  |  ${consultantMap[c.salesConsultantId] || 'Unassigned'}`
            }));
            App.UI.createSearchableDropdown(container, customers, null, 'Search by Name, Account #, or Consultant...');
        }
        
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('report-collection-start-date').value = firstDayOfMonth.toISOString().slice(0, 10);
        document.getElementById('report-collection-end-date').valueAsDate = today;

        document.getElementById('report-output').innerHTML = ''; 
    }, 
        setupEventListeners: function() { 
            const reportsPage = document.getElementById('reports-page');
            reportsPage.addEventListener('click', (e) => {
                if(e.target.closest('.input-with-icon .icon')) {
                    const input = e.target.closest('.input-with-icon').querySelector('input');
                    if(input && typeof input.showPicker === 'function') {
                        input.showPicker();
                    }
                }
                const target = e.target.closest('button, a, label');
                if (!target) return;
                
                const reportActions = {
                    'generate-customer-report-btn': () => this.generateCustomerReport(),
                    'generate-consultant-report-btn': () => this.generateConsultantReport(),
                    'generate-overdue-report-btn': () => this.generateOverdueReport(),
                    'generate-recovery-report-btn': () => this.generateRecoveryPerformanceReport(),
                    'generate-statement-btn': () => this.generateCustomerStatement(),
                    'generate-outcome-analysis-btn': () => this.generateVisitOutcomeReport(),
                    'generate-activity-report-btn': () => this.generateActivityReport(),
                    'activity-report-summary-btn': () => { App.state.reports.activityView = 'summary'; this.updateActivityReportView(); },
                    'activity-report-table-btn': () => { App.state.reports.activityView = 'table'; this.updateActivityReportView(); },
                    'generate-collection-report-btn': () => this.generateCollectionReport(),
                    'generate-aging-report-btn': () => this.generateAgingReport(),
                    'generate-collector-perf-btn': () => this.generateCollectorPerformanceReport(),
                    'generate-risk-analysis-btn': () => this.generateRiskAnalysisReport(),
                    'generate-consultant-visits-btn-new': () => this.generateConsultantVisitsReport(),
                    'generate-forecast-report-btn-new': () => this.generateForecastPerformanceReport()
                };

                if (reportActions[target.id]) {
                    e.preventDefault();
                    reportActions[target.id]();
                }
            });
        }, 
        updateActivityReportView() {
            document.getElementById('activity-report-summary-btn').classList.toggle('active', App.state.reports.activityView === 'summary');
            document.getElementById('activity-report-table-btn').classList.toggle('active', App.state.reports.activityView === 'table');
            if (document.getElementById('report-modal-body').innerHTML.trim() !== '') {
                this.generateActivityReport();
            }
        },
        renderPaymentTrendChart: function() { 
            const yearSelect = document.getElementById('payment-trend-year');
            const payments = App.DB.get('payments');
            const years = [...new Set(payments.map(p => new Date(p.date).getFullYear()))].sort((a, b) => b - a);
            if (yearSelect.options.length === 0 && years.length > 0) {
                yearSelect.innerHTML = years.map(y => `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`).join('');
            } else if (years.length === 0) {
                const currentYear = new Date().getFullYear(); 
                yearSelect.innerHTML = `<option value="${currentYear}">${currentYear}</option>`;
            }
            const selectedYear = parseInt(yearSelect.value); 
            const compareYoY = document.getElementById('payment-trend-yoy').checked; 
            const getYearlyData = (year) => { let monthlyTotals = Array(12).fill(0); payments.filter(p => new Date(p.date).getFullYear() === year).forEach(p => { const month = new Date(p.date).getMonth(); monthlyTotals[month] += p.amount; }); return monthlyTotals; }; const currentYearData = getYearlyData(selectedYear); const datasets = [{ label: selectedYear, data: currentYearData, borderColor: 'var(--primary)', backgroundColor: 'rgba(226, 0, 15, 0.2)', fill: true, tension: 0.4 }]; if(compareYoY && selectedYear) { const prevYearData = getYearlyData(selectedYear - 1); datasets.push({ label: selectedYear - 1, data: prevYearData, borderColor: 'var(--success)', backgroundColor: 'rgba(16, 185, 129, 0.2)', fill: true, tension: 0.4 }); } const ctx = document.getElementById('payment-trend-chart'); if(this.charts.paymentTrend) { this.charts.paymentTrend.destroy(); } this.charts.paymentTrend = new Chart(ctx, { type: 'line', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: 'var(--text-primary)' } }, x: { ticks: { color: 'var(--text-primary)' } } }, plugins: { legend: { labels: { color: 'var(--text-primary)' } } } } }); },  
        generateActivityReport: function() { 
            const consultantId = parseInt(document.getElementById('report-consultant-select').value);
            const consultant = App.DB.get('consultants').find(c => c.id === consultantId);
            if(!consultant) return App.UI.toast('Please select a valid consultant', 'error');
            const consultantName = consultant.name;

            const startDate = document.getElementById('report-activity-start-date').value; 
            const endDate = document.getElementById('report-activity-end-date').value;
            if (!startDate || !endDate) { return App.UI.toast('Please select both a start and end date.', 'warning'); }
            const log = App.DB.get('activityLog').filter(entry => entry.consultantId === consultantId && entry.date >= startDate && entry.date <= endDate); 
            
            const output = document.getElementById('report-output'); 
            if (log.length === 0) { 
                this.displayReport(`Activity for ${consultantName}`, [], []);
                return;
            } 
            
            const reportTitle = `Activity for ${consultantName} from ${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)}`; 
            
            if (App.state.reports.activityView === 'summary') { 
                const activityByDay = log.reduce((acc, entry) => { (acc[entry.date] = acc[entry.date] || []).push(entry); return acc; }, {});
                const attendanceSummary = Object.entries(activityByDay).map(([date, entries]) => {
                    const startEntry = entries.find(e => e.action === 'Started Day');
                    const endEntry = entries.find(e => e.action === 'Ended Day');
                    const totalBreakTime = entries.filter(e => e.action === 'Ended Break' && e.duration).reduce((sum, e) => sum + e.duration, 0);
                    const workDuration = startEntry && endEntry ? (endEntry.timestamp - startEntry.timestamp) - totalBreakTime : 0;
                    return { date, startTime: startEntry ? startEntry.time : 'N/A', endTime: endEntry ? endEntry.time : 'N/A', breakDuration: App.Helpers.formatDuration(totalBreakTime), workDuration: workDuration > 0 ? App.Helpers.formatDuration(workDuration) : 'N/A' };
                }).sort((a,b) => new Date(a.date) - new Date(b.date));

                const completedVisits = log.filter(e => e.action.includes('completed visit')).length; 
                const recordedPayments = log.filter(e => e.action.includes('recorded a payment')); 
                const totalRecovered = recordedPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
                
                const summaryContent = `<h4 class="card-title" style="font-size: var(--fs-lg); margin-bottom: var(--spacing-4);">Performance Summary</h4><div class="detail-info-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));"><div class="detail-info-card"><div class="label">ACTIVE DAYS</div><div class="value">${attendanceSummary.length}</div></div><div class="detail-info-card"><div class="label">VISITS COMPLETED</div><div class="value">${completedVisits}</div></div><div class="detail-info-card"><div class="label">PAYMENTS RECORDED</div><div class="value">${recordedPayments.length}</div></div><div class="detail-info-card"><div class="label">TOTAL RECOVERED</div><div class="value" style="color:var(--success);">${App.Helpers.formatCurrency(totalRecovered)}</div></div></div>`;
                
                this.displayReport(reportTitle, [], [], summaryContent); 
            } else { 
                const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c; return map;}, {});
                const visitMap = App.DB.get('visits').reduce((map, v) => { map[v.id] = v; return map; }, {});
                const headers = ['Date', 'Time', 'Category', 'Customer', 'Account #', 'Action/Outcome', 'Notes', 'Amount', 'Outstanding'];
                const data = log.sort((a, b) => a.timestamp - b.timestamp).map(entry => {
                    const customer = entry.customerId ? customerMap[entry.customerId] : null;
                    let customerName = customer ? customer.companyName : 'N/A'; let accountNo = customer ? customer.accountNo : 'N/A';
                    let category = 'General'; let actionOutcome = entry.action; let notes = '-'; let amount = '-'; let outstanding = customer ? App.Helpers.formatCurrency(customer.outstanding) : '-';

                    if (entry.action.includes('Day') || entry.action.includes('Break')) { category = 'Attendance';
                    } else if (entry.action.includes('payment')) {
                        category = 'Payment';
                        const paymentDetails = App.Helpers.parsePaymentDetails(entry.details);
                        actionOutcome = paymentDetails.method;
                        if (entry.amount && typeof entry.amount === 'number') amount = App.Helpers.formatCurrency(entry.amount);
                    } else if (entry.action.includes('visit')) {
                        category = 'Visit';
                        const visitDetails = App.Helpers.parseVisitDetails(entry.details);
                        actionOutcome = visitDetails.outcome;
                        const visit = visitMap[entry.visitId];
                        if (visit && visit.notes) notes = App.Helpers.stripHtml(visit.notes);
                    } else if (entry.action.includes('added a new customer')) {
                        category = 'Customer'; actionOutcome = 'New Account';
                    }
                    return [App.Helpers.formatDate(entry.date), entry.time, category, customerName, accountNo, actionOutcome, notes, amount, outstanding];
                });
                this.displayReport(reportTitle, headers, data); 
            } 
        }, 
        generateCollectionReport: function() {
            const startDate = document.getElementById('report-collection-start-date').value;
            const endDate = document.getElementById('report-collection-end-date').value;

            if (!startDate || !endDate) {
                return App.UI.toast('Please select a start and end date.', 'warning');
            }

            const payments = App.DB.get('payments').filter(p => {
                const paymentDate = p.date;
                return p.status === 'Completed' && paymentDate >= startDate && paymentDate <= endDate;
            });

            const totalCollected = payments.reduce((sum, p) => sum + p.amount, 0);
            
            const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
            const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = { name: c.companyName, consultantId: c.salesConsultantId }; return map; }, {});

            const headers = ['Date', 'Customer', 'Amount', 'Method', 'Consultant'];
            const data = payments
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map(p => {
                    const customer = customerMap[p.customerId];
                    const consultantName = customer ? consultantMap[customer.consultantId] : 'N/A';
                    return [
                        App.Helpers.formatDate(p.date),
                        customer ? customer.name : 'N/A',
                        App.Helpers.formatCurrency(p.amount),
                        p.method,
                        consultantName
                    ];
                });

            const summaryContent = `
                <div class="detail-info-grid" style="grid-template-columns: 1fr; margin-bottom: var(--spacing-4);">
                    <div class="detail-info-card">
                        <div class="label">Total Collected from ${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)}</div>
                        <div class="value" style="color: var(--success);">${App.Helpers.formatCurrency(totalCollected)}</div>
                    </div>
                </div>
            `;
            
            const reportTitle = `Collection Details from ${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)}`;
            this.displayReport(reportTitle, headers, data, summaryContent);
        },
        generateAgingReport: function() {
            const customers = App.DB.get('customers').filter(c => c.paymentStatus === 'Overdue');
            const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
            const headers = ['Company Name', 'Outstanding Amount', 'Consultant', 'Aging Category'];
            const data = customers.map(c => [c.companyName, App.Helpers.formatCurrency(c.outstanding), consultantMap[c.salesConsultantId], '30+ Days Overdue']);
            this.displayReport('Customer Aging Report (Overdue)', headers, data);
        },
        generateCollectorPerformanceReport: function() {
            const consultants = App.DB.get('consultants');
            const customers = App.DB.get('customers');
            const visits = App.DB.get('visits');
            const payments = App.DB.get('payments');

            const headers = ['Collector', 'Assigned Customers', 'Total Recovered', 'Visits Made', 'Success Rate (%)'];
            const data = consultants.map(consultant => {
                const assignedCustomers = customers.filter(c => c.salesConsultantId === consultant.id);
                const assignedCustomerIds = new Set(assignedCustomers.map(c => c.accountNo));
                const totalRecovered = payments.filter(p => assignedCustomerIds.has(p.customerId) && p.status === 'Completed').reduce((sum, p) => sum + p.amount, 0);
                const visitsMade = visits.filter(v => v.collectorId === consultant.id && v.status === 'Completed');
                const successfulVisits = visitsMade.filter(v => v.outcome === 'Paid in Full' || v.outcome === 'Partial Payment').length;
                const successRate = visitsMade.length > 0 ? ((successfulVisits / visitsMade.length) * 100).toFixed(2) : 0;
                return [consultant.name, assignedCustomers.length, App.Helpers.formatCurrency(totalRecovered), visitsMade.length, successRate];
            });
            this.displayReport('Collector Performance Report', headers, data);
        },
        generateRiskAnalysisReport: function() {
            const customers = App.DB.get('customers').filter(c => c.outstanding > 0);
            const headers = ['Company Name', 'Outstanding Amount', 'Status', 'Risk Level'];
            const data = customers.map(c => {
                let riskLevel = 'Low';
                if (c.paymentStatus === 'Overdue') riskLevel = 'High';
                else if (c.outstanding > 20000) riskLevel = 'Medium';
                return [c.companyName, App.Helpers.formatCurrency(c.outstanding), c.paymentStatus, riskLevel];
            }).sort((a,b) => { const order = {'High': 0, 'Medium': 1, 'Low': 2}; return order[a[3]] - order[b[3]]; });
            this.displayReport('Customer Risk Analysis Report', headers, data);
        },
        generateCustomerReport: function() { const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {}); const c = App.Helpers.getScopedData('customers'), h = ['Account #', 'Company Name', 'Emirate', 'Outstanding', 'Consultant', 'Status'], d = c.map(i => [i.accountNo, i.companyName, i.emirate, App.Helpers.formatCurrency(i.outstanding), consultantMap[i.salesConsultantId], i.status]); this.displayReport('Customer List Report', h, d); },
        generateConsultantReport: function() { const c = App.Helpers.getScopedData('customers'), v = App.DB.get('visits'); const consultantMap = App.DB.get('consultants').reduce((map, con) => { map[con.id] = { name: con.name, customers: 0, totalDebt: 0, visits: 0 }; return map; }, {}); c.forEach(i => { if (consultantMap[i.salesConsultantId]) { consultantMap[i.salesConsultantId].customers++; consultantMap[i.salesConsultantId].totalDebt += i.outstanding; } }); v.forEach(i => { if (consultantMap[i.collectorId]) consultantMap[i.collectorId].visits++; }); const h = ['Consultant', 'Assigned Customers', 'Total Outstanding', 'Total Visits'], d = Object.values(consultantMap).map(s => [s.name, s.customers, App.Helpers.formatCurrency(s.totalDebt), s.visits]); this.displayReport('Consultant Activity Report', h, d); },
        generateOverdueReport: function() { const customers = App.Helpers.getScopedData('customers').filter(c => c.paymentStatus === 'Overdue'); const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {}); const headers = ['Account #', 'Company Name', 'Outstanding', 'Consultant', 'Emirate']; const data = customers.map(c => [c.accountNo, c.companyName, App.Helpers.formatCurrency(c.outstanding), consultantMap[c.salesConsultantId], c.emirate]); this.displayReport('Overdue Accounts Report', headers, data); },
        generateRecoveryPerformanceReport: function() { const consultants = App.DB.get('consultants'); const customers = App.Helpers.getScopedData('customers'); const headers = ['Consultant', 'Total Initial Debt', 'Total Outstanding', 'Total Recovered', 'Recovery Rate']; const data = consultants.map(consultant => { const assignedCustomers = customers.filter(c => c.salesConsultantId === consultant.id); const initialDebt = assignedCustomers.reduce((sum, c) => sum + c.initialDebt, 0); const outstandingDebt = assignedCustomers.reduce((sum, c) => sum + c.outstanding, 0); const recovered = initialDebt - outstandingDebt; const recoveryRate = initialDebt > 0 ? ((recovered / initialDebt) * 100).toFixed(2) + '%' : 'N/A'; return [consultant.name, App.Helpers.formatCurrency(initialDebt), App.Helpers.formatCurrency(outstandingDebt), App.Helpers.formatCurrency(recovered), recoveryRate]; }); this.displayReport('Debt Recovery Performance Report', headers, data); },
        generateCustomerStatement: function() { const customerId = document.querySelector('#statement-customer-select-container input[type="hidden"]').value; if (!customerId) { App.UI.toast('Please select a customer.', 'warning'); return; } const customer = App.DB.get('customers').find(c => c.accountNo === customerId); const payments = App.DB.get('payments').filter(p => p.customerId === customerId && p.status === 'Completed').sort((a,b) => new Date(a.date) - new Date(b.date)); let transactions = []; transactions.push({ date: 'Initial', description: 'Initial Debt Amount', debit: customer.initialDebt, credit: 0 }); payments.forEach(p => { transactions.push({ date: p.date, description: `Payment Received (${p.method})`, debit: 0, credit: p.amount }); }); let balance = 0; const transactionsWithBalance = transactions.map(t => { balance += t.debit - t.credit; return {...t, balance}; }); const body = transactionsWithBalance.map(t => { return `<tr><td>${t.date === 'Initial' ? 'N/A' : App.Helpers.formatDate(t.date)}</td><td>${t.description}</td><td>${t.debit > 0 ? App.Helpers.formatCurrency(t.debit) : '-'}</td><td>${t.credit > 0 ? App.Helpers.formatCurrency(t.credit) : '-'}</td><td>${App.Helpers.formatCurrency(t.balance)}</td></tr>` }).join(''); const reportTitle = `Statement for ${customer.companyName} (${customer.accountNo})`; this.currentStatementData = { customer, transactionsWithBalance }; const content = `<div class="detail-info-grid" style="grid-template-columns: repeat(3, 1fr);"><div class="detail-info-card"><div class="label">Total Billed</div><div class="value">${App.Helpers.formatCurrency(customer.initialDebt)}</div></div><div class="detail-info-card"><div class="label">Total Paid</div><div class="value">${App.Helpers.formatCurrency(customer.initialDebt - customer.outstanding)}</div></div><div class="detail-info-card"><div class="label">Balance Due</div><div class="value" style="color:var(--danger);">${App.Helpers.formatCurrency(customer.outstanding)}</div></div></div><div class="table-container mt-4"><table class="data-table"><thead><tr><th>Date</th><th>Description</th><th>Debit (Billed)</th><th>Credit (Paid)</th><th>Balance</th></tr></thead><tbody>${body}</tbody></table></div>`; this.displayReport(reportTitle, [], [], content, ['csv', 'pdf']);},
        generateVisitOutcomeReport: function() { const visits = App.DB.get('visits').filter(v => v.status === 'Completed' && v.outcome); const outcomeCounts = visits.reduce((acc, visit) => { acc[visit.outcome] = (acc[visit.outcome] || 0) + 1; return acc; }, {}); const labels = Object.keys(outcomeCounts); const data = Object.values(outcomeCounts); const content = `<div class="chart-container" style="height: 400px;"><canvas id="outcome-chart"></canvas></div>`; this.displayReport('Visit Outcome Analysis', [], [], content); if(this.charts && this.charts.outcome) this.charts.outcome.destroy(); this.charts.outcome = new Chart(document.getElementById('outcome-chart'), { type: 'pie', data: { labels: labels, datasets: [{ label: 'Visit Outcomes', data: data, backgroundColor: ['#e2000f', '#10b981', '#ffc107', '#dc3545', '#0d6efd', '#84cc16'], }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'var(--text-primary)' } } } } }); },
        generateConsultantVisitsReport: function() {
            const consultantFilter = document.getElementById('report-visits-consultant-select').value;
            const startDate = document.getElementById('report-visits-start-date').value;
            const endDate = document.getElementById('report-visits-end-date').value;

            if (!startDate || !endDate) return App.UI.toast('Please select a start and end date.', 'warning');
            
            let visits = App.DB.get('visits').filter(visit => { const visitDate = visit.dateTime.slice(0, 10); return visitDate >= startDate && visitDate <= endDate; });
            let consultantsToReportOn;
            if (consultantFilter === 'all') { consultantsToReportOn = App.DB.get('consultants'); } else { const selectedConsultant = App.DB.get('consultants').find(c => c.id == consultantFilter); if (!selectedConsultant) return App.UI.toast('Selected consultant not found.', 'error'); consultantsToReportOn = [selectedConsultant]; visits = visits.filter(v => v.collectorId == consultantFilter); }

            const customers = App.DB.get('customers'); const consultantData = {};
            consultantsToReportOn.forEach(consultant => { consultantData[consultant.id] = { name: consultant.name, totalVisits: 0, completedVisits: 0, scheduledVisits: 0, overdueVisits: 0, successfulVisits: 0, visitDetails: [] }; });
            visits.forEach(visit => {
                const consultantId = visit.collectorId; if (!consultantData[consultantId]) return;
                const customer = customers.find(c => c.accountNo === visit.customerId); const customerName = customer ? customer.companyName : 'N/A';
                consultantData[consultantId].totalVisits++;
                if (visit.status === 'Completed') { consultantData[consultantId].completedVisits++; if (['Paid in Full', 'Partial Payment', 'Promise to Pay'].includes(visit.outcome)) consultantData[consultantId].successfulVisits++; } 
                else if (visit.status === 'Scheduled') { consultantData[consultantId].scheduledVisits++; } 
                else if (visit.status === 'Overdue') { consultantData[consultantId].overdueVisits++; }
                consultantData[consultantId].visitDetails.push({ date: App.Helpers.formatDateTime(visit.dateTime), customer: customerName, accountNo: visit.customerId, purpose: visit.purpose, status: visit.status, outcome: visit.outcome || 'N/A', contactMethod: visit.contactMethod || 'N/A', notes: visit.notes ? App.Helpers.stripHtml(visit.notes).substring(0, 100) + '...' : 'N/A' });
            });
            
            let content = `<div class="mb-4"><p class="text-secondary">Showing data from ${App.Helpers.formatDate(startDate)} to ${App.Helpers.formatDate(endDate)}</p></div>`;
            const summaryHeaders = ['Consultant', 'Total Visits', 'Completed', 'Scheduled', 'Overdue', 'Success Rate'];
            const summaryData = Object.values(consultantData).map(data => { const successRate = data.completedVisits > 0 ? ((data.successfulVisits / data.completedVisits) * 100).toFixed(1) + '%' : '0%'; return [data.name, data.totalVisits, data.completedVisits, data.scheduledVisits, data.overdueVisits, successRate]; });
            content += `<h4 class="card-title mb-4">Visit Summary by Consultant</h4><div class="table-container mb-6"><table class="data-table"><thead><tr>${summaryHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${summaryData.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
            content += '<h4 class="card-title mb-4">Detailed Visit History</h4>';
            Object.values(consultantData).forEach(consultant => { if (consultant.visitDetails.length > 0) { content += `<div class="card mb-4" style="background: var(--bg-color);"><div class="card-header"><h5 style="margin: 0; color: var(--primary);">${consultant.name} - ${consultant.totalVisits} Visits</h5></div><div class="table-container"><table class="data-table"><thead><tr><th>Date</th><th>Customer</th><th>Account #</th><th>Purpose</th><th>Status</th><th>Outcome</th><th>Contact Method</th><th>Notes</th></tr></thead><tbody>${consultant.visitDetails.map(visit => `<tr><td>${visit.date}</td><td>${visit.customer}</td><td>${visit.accountNo}</td><td>${visit.purpose}</td><td><span class="status-badge ${visit.status.toLowerCase()}">${visit.status}</span></td><td>${visit.outcome}</td><td>${visit.contactMethod}</td><td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${visit.notes}</td></tr>`).join('')}</tbody></table></div></div>`; } });
            
            this.currentConsultantVisitsData = { summary: { headers: summaryHeaders, data: summaryData }, details: Object.values(consultantData) };
            this.displayReport('Consultant Visits Report', [], [], content, ['csv_visits', 'pdf_visits']);
        },
        generateForecastPerformanceReport: function() {
            const consultantIdFilter = document.getElementById('report-forecast-consultant-select').value;
            const monthFilter = document.getElementById('report-forecast-month').value;
            if (!monthFilter) return App.UI.toast('Please select a month.', 'warning');

            const allConsultants = App.DB.get('consultants');
            const allForecasts = App.DB.get('forecasts');
            const allPayments = App.DB.get('payments');
            const allCustomers = App.DB.get('customers');
            
            const consultantsToReportOn = consultantIdFilter === 'all' 
                ? allConsultants 
                : allConsultants.filter(c => c.id == consultantIdFilter);

            const reportData = consultantsToReportOn.map(consultant => {
                const forecastEntry = allForecasts.find(f => f.consultantId === consultant.id && f.month === monthFilter);
                const forecastAmount = forecastEntry ? forecastEntry.amount : 0;
                
                const consultantCustomers = allCustomers.filter(c => c.salesConsultantId === consultant.id).map(c => c.accountNo);
                const collectedAmount = allPayments
                    .filter(p => p.status === 'Completed' && consultantCustomers.includes(p.customerId) && p.date.startsWith(monthFilter))
                    .reduce((sum, p) => sum + p.amount, 0);

                const performance = forecastAmount > 0 ? ((collectedAmount / forecastAmount) * 100).toFixed(2) + '%' : 'N/A';
                
                return [ consultant.name, App.Helpers.formatCurrency(forecastAmount), App.Helpers.formatCurrency(collectedAmount), performance ];
            });
            
            const headers = ['Consultant', 'Forecasted Amount', 'Collected Amount', 'Performance'];
            this.displayReport(`Forecast Performance for ${monthFilter}`, headers, reportData);
        },
        exportConsultantVisitsCSV: function() {
            if (!this.currentConsultantVisitsData) return App.UI.toast('No report data to export.', 'error');
            let csvContent = "Consultant Visits Report\n";
            csvContent += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
            csvContent += "VISIT SUMMARY\n";
            csvContent += this.currentConsultantVisitsData.summary.headers.join(",") + "\n";
            this.currentConsultantVisitsData.summary.data.forEach(row => { csvContent += row.join(",") + "\n"; });
            csvContent += "\nDETAILED VISITS\n";
            csvContent += "Consultant,Date,Customer,Account #,Purpose,Status,Outcome,Contact Method,Notes\n";
            this.currentConsultantVisitsData.details.forEach(consultant => {
                consultant.visitDetails.forEach(visit => {
                    const row = [consultant.name, visit.date, visit.customer, visit.accountNo, visit.purpose, visit.status, visit.outcome, visit.contactMethod, `"${visit.notes.replace(/"/g, '""')}"`];
                    csvContent += row.join(",") + "\n";
                });
            });
            App.Helpers.downloadBlob(csvContent, `Consultant_Visits_Report_${new Date().toLocaleDateString()}.csv`, 'text/csv;charset=utf-8;');
            App.UI.toast('Visits report exported to CSV!', 'success');
        },
        exportConsultantVisitsPDF: function() {
            if (!this.currentConsultantVisitsData) return App.UI.toast('No report data to export.', 'error');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18); doc.text('Consultant Visits Report', 14, 22);
            doc.setFontSize(11); doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 32);
            doc.setFontSize(14); doc.text('Visit Summary', 14, 45);
            const summaryTableData = this.currentConsultantVisitsData.summary.data.map(row => row.map(cell => cell.toString()));
            doc.autoTable({ head: [this.currentConsultantVisitsData.summary.headers], body: summaryTableData, startY: 50, theme: 'grid' });
            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(14); doc.text('Detailed Visits (Sample)', 14, finalY);
            const detailedVisits = [];
            this.currentConsultantVisitsData.details.forEach(consultant => {
                consultant.visitDetails.slice(0, 10).forEach(visit => {
                    detailedVisits.push([consultant.name, visit.date, visit.customer, visit.status, visit.outcome]);
                });
            });
            if (detailedVisits.length > 0) {
                doc.autoTable({ head: [['Consultant', 'Date', 'Customer', 'Status', 'Outcome']], body: detailedVisits, startY: finalY + 10, theme: 'grid' });
            }
            doc.save(`Consultant_Visits_Report_${new Date().toLocaleDateString()}.pdf`);
            App.UI.toast('Visits report exported to PDF!', 'success');
        },
        displayReport: function(title, headers = [], data = [], customHTML = '', actions = ['csv', 'pdf']) { 
            this.currentReportData = { title, headers, data };
            document.getElementById('report-modal-title').textContent = title;
            const body = document.getElementById('report-modal-body');
            let content = '';

            if (customHTML) {
                content += customHTML;
            }

            if (headers.length > 0 && data.length > 0) {
                content += `<div class="table-container"><table class="data-table"><thead><tr>${headers.map(i => `<th>${i}</th>`).join('')}</tr></thead><tbody>${data.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
            } else if (!customHTML && headers.length > 0) {
                content += `<p>No data found for this report.</p>`;
            }
            
            body.innerHTML = content;
            const actionsContainer = document.getElementById('report-modal-actions');
            actionsContainer.innerHTML = '';
            if(actions.includes('csv')) actionsContainer.innerHTML += `<button class="btn btn-outline" onclick="App.Reports.exportCSV()"><i class="fas fa-file-csv"></i> CSV</button>`;
            if(actions.includes('pdf')) actionsContainer.innerHTML += `<button class="btn btn-outline" onclick="App.Reports.exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>`;
            if(actions.includes('csv_visits')) actionsContainer.innerHTML += `<button class="btn btn-outline" onclick="App.Reports.exportConsultantVisitsCSV()"><i class="fas fa-file-csv"></i> CSV</button>`;
            if(actions.includes('pdf_visits')) actionsContainer.innerHTML += `<button class="btn btn-outline" onclick="App.Reports.exportConsultantVisitsPDF()"><i class="fas fa-file-pdf"></i> PDF</button>`;


            App.UI.animateTableRows(body.querySelector('.data-table tbody'));
            App.UI.openModal('report-modal');
        },
        exportCSV: function() { if (!this.currentReportData) return App.UI.toast('No report data to export.', 'error'); const { title: t, headers: h, data: d } = this.currentReportData; App.Helpers.exportToCSV(`${t.replace(/\s/g, '_')}.csv`, h, d); },
        exportPDF: function() { if (!this.currentReportData) return App.UI.toast('No report data to export.', 'error'); const { title: t, headers: h, data: d } = this.currentReportData; App.Helpers.exportToPDF(`${t.replace(/\s/g, '_')}.pdf`, t, h, d); },
        exportStatementCSV: function() { if (!this.currentStatementData) return App.UI.toast('No statement data to export.', 'error'); const { customer, transactionsWithBalance } = this.currentStatementData; const title = `Statement_for_${customer.companyName.replace(/\s/g, '_')}`; let csvContent = "data:text/csv;charset=utf-8,"; csvContent += `Statement for:,"${customer.companyName} (${customer.accountNo})"\n`; csvContent += `Total Billed:,${App.Helpers.formatCurrency(customer.initialDebt)}\n`; csvContent += `Total Paid:,${App.Helpers.formatCurrency(customer.initialDebt - customer.outstanding)}\n`; csvContent += `Balance Due:,${App.Helpers.formatCurrency(customer.outstanding)}\n\n`; const headers = ['Date', 'Description', 'Debit (Billed)', 'Credit (Paid)', 'Balance']; csvContent += headers.join(',') + '\r\n'; transactionsWithBalance.forEach(t => { const row = [ t.date === 'Initial' ? 'N/A' : App.Helpers.formatDate(t.date), `"${t.description}"`, t.debit > 0 ? t.debit.toFixed(2) : '0.00', t.credit > 0 ? t.credit.toFixed(2) : '0.00', t.balance.toFixed(2) ]; csvContent += row.join(',') + '\r\n'; }); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", `${title}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); },
        exportStatementPDF: function() { if (!this.currentStatementData) return App.UI.toast('No statement data to export.', 'error'); const { customer, transactionsWithBalance } = this.currentStatementData; const title = `Statement for ${customer.companyName} (${customer.accountNo})`; const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(18); doc.text(title, 14, 22); doc.setFontSize(11); doc.setTextColor(100); doc.text(`Total Billed: ${App.Helpers.formatCurrency(customer.initialDebt)}`, 14, 32); doc.text(`Total Paid: ${App.Helpers.formatCurrency(customer.initialDebt - customer.outstanding)}`, 70, 32); doc.text(`Balance Due: ${App.Helpers.formatCurrency(customer.outstanding)}`, 130, 32); const tableData = transactionsWithBalance.map(t => [ t.date === 'Initial' ? 'N/A' : App.Helpers.formatDate(t.date), t.description, t.debit > 0 ? App.Helpers.formatCurrency(t.debit) : '-', t.credit > 0 ? App.Helpers.formatCurrency(t.credit) : '-', App.Helpers.formatCurrency(t.balance) ]); doc.autoTable({ head: [['Date', 'Description', 'Debit (Billed)', 'Credit (Paid)', 'Balance']], body: tableData, startY: 40 }); doc.save(`Statement_${customer.companyName.replace(/\s/g, '_')}.pdf`); }
    });
	    Object.assign(App.Analytics, {
        charts: {},
        render() {
            this.renderKpiCards();
            this.renderRecoveryByConsultantChart();
            this.renderRecoveryByEmirateChart();
            this.renderPaymentMethodsChart();
            this.renderVisitOutcomeChart();
        },
        setupEventListeners() {
            // Add any event listeners for future filters on the analytics page here
        },
        renderKpiCards() {
            const customers = App.DB.get('customers');
            const payments = App.DB.get('payments').filter(p => p.status === 'Completed');
            const visits = App.DB.get('visits').filter(v => v.status === 'Completed');
            
            const totalRecovered = payments.reduce((sum, p) => sum + p.amount, 0);
            const totalOutstanding = customers.reduce((sum, c) => sum + c.outstanding, 0);
            const successfulVisits = visits.filter(v => ['Paid in Full', 'Partial Payment', 'Promise to Pay'].includes(v.outcome)).length;
            const visitSuccessRate = visits.length > 0 ? ((successfulVisits / visits.length) * 100).toFixed(1) : 0;

            const kpiGrid = document.getElementById('analytics-kpi-grid');
            kpiGrid.innerHTML = `
                <div class="kpi-card"><div class="title">Total Recovered (All Time)</div><div class="value">${App.Helpers.formatCurrency(totalRecovered)}</div></div>
                <div class="kpi-card"><div class="title">Total Outstanding Debt</div><div class="value">${App.Helpers.formatCurrency(totalOutstanding)}</div></div>
                <div class="kpi-card"><div class="title">Visit Success Rate</div><div class="value">${visitSuccessRate}%</div></div>
                <div class="kpi-card"><div class="title">Total Completed Visits</div><div class="value">${visits.length}</div></div>
            `;
        },
        renderRecoveryByConsultantChart() {
            const consultants = App.DB.get('consultants');
            const customers = App.DB.get('customers');
            const data = consultants.map(consultant => {
                const assigned = customers.filter(c => c.salesConsultantId === consultant.id);
                const initial = assigned.reduce((s, c) => s + c.initialDebt, 0);
                const outstanding = assigned.reduce((s, c) => s + c.outstanding, 0);
                return { name: consultant.name, recovered: initial - outstanding, outstanding };
            });

            const ctx = document.getElementById('recovery-by-consultant-chart').getContext('2d');
            if (this.charts.consultant) this.charts.consultant.destroy();
            this.charts.consultant = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [
                        { label: 'Recovered', data: data.map(d => d.recovered), backgroundColor: 'var(--success)' },
                        { label: 'Outstanding', data: data.map(d => d.outstanding), backgroundColor: 'var(--danger)' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
            });
        },
        renderRecoveryByEmirateChart() {
            const customers = App.DB.get('customers');
            const data = customers.reduce((acc, c) => {
                const initial = acc[c.emirate]?.initial || 0;
                const outstanding = acc[c.emirate]?.outstanding || 0;
                acc[c.emirate] = { initial: initial + c.initialDebt, outstanding: outstanding + c.outstanding };
                return acc;
            }, {});
            
            const labels = Object.keys(data);
            const recoveredData = labels.map(l => data[l].initial - data[l].outstanding);
            const outstandingData = labels.map(l => data[l].outstanding);

            const ctx = document.getElementById('recovery-by-emirate-chart').getContext('2d');
            if (this.charts.emirate) this.charts.emirate.destroy();
            this.charts.emirate = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Recovered', data: recoveredData, backgroundColor: 'var(--success)' }, { label: 'Outstanding', data: outstandingData, backgroundColor: 'var(--danger)' }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
        },
        renderPaymentMethodsChart() {
            const payments = App.DB.get('payments');
            const data = payments.reduce((acc, p) => { acc[p.method] = (acc[p.method] || 0) + 1; return acc; }, {});
            const ctx = document.getElementById('payment-methods-chart').getContext('2d');
            if (this.charts.paymentMethods) this.charts.paymentMethods.destroy();
            this.charts.paymentMethods = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#e2000f', '#10b981', '#ffc107'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });
        },
        renderVisitOutcomeChart() {
            const visits = App.DB.get('visits').filter(v => v.status === 'Completed' && v.outcome);
            const data = visits.reduce((acc, v) => { acc[v.outcome] = (acc[v.outcome] || 0) + 1; return acc; }, {});
            const ctx = document.getElementById('visit-outcome-chart').getContext('2d');
            if (this.charts.visitOutcomes) this.charts.visitOutcomes.destroy();
            this.charts.visitOutcomes = new Chart(ctx, {
                type: 'pie',
                data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#10b981', '#e2000f', '#ffc107', '#dc3545', '#0d6efd', '#84cc16'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });
        }
    });
    Object.assign(App.Consultants, { render: function() { const consultants = App.DB.get('consultants'); const customers = App.DB.get('customers'); const visits = App.DB.get('visits'); const tbody = document.getElementById('consultant-table-body'); let data = consultants.map(consultant => { const assignedCustomers = customers.filter(c => c.salesConsultantId === consultant.id); const totalOutstanding = assignedCustomers.reduce((sum, c) => sum + c.outstanding, 0); const overdueCustomers = assignedCustomers.filter(c => c.paymentStatus === 'Overdue').length; const upcomingVisits = visits.filter(v => v.collectorId === consultant.id && v.status === 'Scheduled' && new Date(v.dateTime) >= new Date()).length; return { ...consultant, noOfCustomers: assignedCustomers.length, totalOutstanding, overdueCustomers, upcomingVisits }; }); const { column, order } = App.state.tableSorts.consultants; data.sort((a, b) => { let valA = a[column]; let valB = b[column]; if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } if (valA < valB) return order === 'asc' ? -1 : 1; if (valA > valB) return order === 'asc' ? 1 : -1; return 0; }); const { currentPage, rowsPerPage } = App.state.pagination.consultants; const startIndex = (currentPage - 1) * rowsPerPage; const paginatedData = data.slice(startIndex, startIndex + rowsPerPage); if (paginatedData.length > 0) { tbody.innerHTML = paginatedData.map(c => `<tr><td><div style="font-weight:600;">${c.name}</div></td><td>${c.noOfCustomers}</td><td>${App.Helpers.formatCurrency(c.totalOutstanding)}</td><td>${c.overdueCustomers}</td><td>${c.upcomingVisits}</td><td><div class="d-flex gap-2"><button class="btn btn-outline view-customers" data-id="${c.id}" title="View Customers"><i class="fas fa-users"></i></button><button class="btn btn-outline reassign-customers" data-id="${c.id}" title="Reassign Customers"><i class="fas fa-random"></i></button><button class="btn btn-outline set-target-btn" data-id="${c.id}" title="Set Monthly Target"><i class="fas fa-bullseye"></i></button><button class="btn btn-outline edit-consultant" data-id="${c.id}" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-consultant" data-id="${c.id}" title="Delete"><i class="fas fa-trash"></i></button></div></td></tr>`).join(''); } else { const buttonHTML = `<button class="btn btn-primary" onclick="App.Consultants.showConsultantForm()"><i class="fas fa-plus"></i> Add Consultant</button>`; tbody.innerHTML = App.UI.getEmptyStateHTML('fa-user-tie', 'No Consultants Found', 'Add a consultant to begin assigning customers.', buttonHTML); } App.UI.animateTableRows(tbody); App.UI.renderPaginationControls('consultants', data.length); App.UI.updateSortIndicators('consultants'); }, setupEventListeners: function() { document.getElementById('add-consultant-btn').addEventListener('click', () => this.showConsultantForm()); document.getElementById('consultant-form').addEventListener('submit', (e) => this.saveConsultant(e)); document.getElementById('consultant-table-body').addEventListener('click', e => { const editBtn = e.target.closest('.edit-consultant'); const deleteBtn = e.target.closest('.delete-consultant'); const viewBtn = e.target.closest('.view-customers'); const reassignBtn = e.target.closest('.reassign-customers'); const targetBtn = e.target.closest('.set-target-btn'); if (editBtn) this.showConsultantForm(editBtn.dataset.id); if (deleteBtn) this.deleteConsultant(deleteBtn.dataset.id); if (viewBtn) this.showViewCustomersModal(viewBtn.dataset.id); if (reassignBtn) this.showReassignModal(reassignBtn.dataset.id); if (targetBtn) this.showForecastModal(targetBtn.dataset.id); }); document.getElementById('reassign-customers-form').addEventListener('submit', e => this.reassignCustomers(e)); document.querySelector('#consultants-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('consultants', th.dataset.sort); }); document.getElementById('forecast-form').addEventListener('submit', e => this.saveForecast(e)); document.getElementById('existing-forecasts-body').addEventListener('click', e => { const deleteBtn = e.target.closest('.delete-forecast'); if (deleteBtn) this.deleteForecast(deleteBtn.dataset.id); }); }, showConsultantForm: function(id = null) { const form = document.getElementById('consultant-form'); form.reset(); if (id) { const consultant = App.DB.get('consultants').find(c => c.id == id); document.getElementById('consultant-modal-title').textContent = 'Edit Consultant'; form.elements['consultant-id-hidden'].value = consultant.id; form.elements['consultantName'].value = consultant.name; form.originalData = {...consultant}; } else { document.getElementById('consultant-modal-title').textContent = 'Add New Consultant'; form.elements['consultant-id-hidden'].value = ''; form.originalData = null; } App.UI.openModal('consultant-modal'); }, saveConsultant: function(e) { e.preventDefault(); const form = e.target; const id = form.elements['consultant-id-hidden'].value; const name = form.elements['consultantName'].value.trim(); if (!name) return App.UI.toast('Consultant name cannot be empty.', 'error'); let consultants = App.DB.get('consultants'); if (id) { const index = consultants.findIndex(c => c.id == id); const originalName = form.originalData.name; consultants[index].name = name; App.Helpers.logChange('Updated', 'Consultant', `'${originalName}'`, `Renamed to '${name}'`); } else { const newId = Date.now(); consultants.push({ id: newId, name }); App.Helpers.logChange('Created', 'Consultant', `'${name}'`); } App.DB.set('consultants', consultants); App.UI.closeModal('consultant-modal'); App.UI.toast(`Consultant ${id ? 'updated' : 'added'}!`); this.render(); }, 
        deleteConsultant: function(id) {
            const customers = App.DB.get('customers');
            const assignedCustomers = customers.filter(c => c.salesConsultantId == id);

            if (assignedCustomers.length > 0) {
                App.UI.toast(`Cannot delete consultant. They have ${assignedCustomers.length} customer(s) assigned. Please reassign them first.`, 'error');
                return;
            }

            App.UI.confirm('Are you sure?', "This will permanently delete the consultant.", () => {
                let consultants = App.DB.get('consultants');
                const consultant = consultants.find(c => c.id == id);
                consultants = consultants.filter(c => c.id != id);
                App.DB.set('consultants', consultants);
                App.Helpers.logChange('Deleted', 'Consultant', `'${consultant.name}'`);
                App.UI.toast('Consultant deleted.', 'success');
                this.render();
            });
        },
        showViewCustomersModal(consultantId) {
            const consultant = App.DB.get('consultants').find(c => c.id == consultantId);
            document.getElementById('consultant-customers-title').textContent = `Customers of ${consultant.name}`;
            const customers = App.DB.get('customers').filter(c => c.salesConsultantId == consultantId);
            const body = document.getElementById('consultant-customers-body');
            if (customers.length === 0) {
                body.innerHTML = '<p>No customers assigned to this consultant.</p>';
            } else {
                const table = `<table class="data-table"><thead><tr><th>Account #</th><th>Company</th><th>Outstanding</th></tr></thead><tbody>${customers.map(c => `<tr><td>${c.accountNo}</td><td>${c.companyName}</td><td>${App.Helpers.formatCurrency(c.outstanding)}</td></tr>`).join('')}</tbody></table>`;
                body.innerHTML = table;
                App.UI.animateTableRows(body.querySelector('tbody'));
            }
            App.UI.openModal('consultant-customers-modal');
        },
        showReassignModal(fromConsultantId) {
            const fromConsultant = App.DB.get('consultants').find(c => c.id == fromConsultantId);
            document.getElementById('from-consultant-hidden').value = fromConsultant.id;
            document.getElementById('from-consultant-name').textContent = fromConsultant.name;
            
            const customers = App.DB.get('customers').filter(c => c.salesConsultantId == fromConsultant.id);
            const customerListEl = document.getElementById('reassign-customer-list');
            customerListEl.innerHTML = customers.length > 0 ? customers.map(c => `<div class="d-flex align-items-center gap-2"><input type="checkbox" name="customerToReassign" value="${c.accountNo}" id="reassign-${c.accountNo}"><label for="reassign-${c.accountNo}">${c.companyName}</label></div>`).join('') : '<p>No customers to reassign.</p>';

            const consultants = App.DB.get('consultants').filter(c => c.id != fromConsultant.id);
            const toConsultantSelect = document.getElementById('reassign-to-consultant');
            toConsultantSelect.innerHTML = consultants.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            App.UI.openModal('reassign-customers-modal');
        },
        reassignCustomers(e) {
            e.preventDefault();
            const fromConsultantId = parseInt(document.getElementById('from-consultant-hidden').value);
            const toConsultantId = parseInt(document.getElementById('reassign-to-consultant').value);
            const selectedCustomerNodes = document.querySelectorAll('input[name="customerToReassign"]:checked');
            
            if (!toConsultantId) return App.UI.toast('Please select a consultant to reassign to.', 'error');
            if (selectedCustomerNodes.length === 0) return App.UI.toast('Please select at least one customer to reassign.', 'error');

            const fromConsultantName = App.DB.get('consultants').find(c => c.id === fromConsultantId).name;
            const toConsultantName = App.DB.get('consultants').find(c => c.id === toConsultantId).name;

            const customerIdsToReassign = Array.from(selectedCustomerNodes).map(node => node.value);
            let customers = App.DB.get('customers');
            customerIdsToReassign.forEach(id => {
                const customerIndex = customers.findIndex(c => c.accountNo === id);
                if (customerIndex > -1) {
                    customers[customerIndex].salesConsultantId = toConsultantId;
                }
            });
            App.DB.set('customers', customers);
            const details = `Reassigned ${customerIdsToReassign.length} customers from ${fromConsultantName} to ${toConsultantName}`;
            App.Helpers.logChange('Reassigned', 'Customers', details);
            App.UI.closeModal('reassign-customers-modal');
            App.UI.toast('Customers reassigned successfully!', 'success');
            this.render();
            if(App.state.activePage === 'customers') App.Customers.render();
        },
        showForecastModal(consultantId) {
            const consultant = App.DB.get('consultants').find(c => c.id == consultantId);
            document.getElementById('forecast-modal-title').textContent = `Monthly Targets for ${consultant.name}`;
            document.getElementById('forecast-consultant-id').value = consultant.id;
            
            const monthInput = document.getElementById('forecast-month');
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            monthInput.value = `${year}-${month}`;
            
            this.renderForecastsForConsultant(consultant.id);
            App.UI.openModal('forecast-modal');
        },
        renderForecastsForConsultant(consultantId) {
            const allForecasts = App.DB.get('forecasts');
            const consultantForecasts = allForecasts.filter(f => f.consultantId == consultantId).sort((a, b) => b.month.localeCompare(a.month));
            const tbody = document.getElementById('existing-forecasts-body');
            tbody.innerHTML = consultantForecasts.length > 0
                ? consultantForecasts.map(f => `<tr><td>${f.month}</td><td>${App.Helpers.formatCurrency(f.amount)}</td><td><button class="btn btn-danger delete-forecast" data-id="${f.id}"><i class="fas fa-trash"></i></button></td></tr>`).join('')
                : '<tr><td colspan="3">No targets found.</td></tr>';
            App.UI.animateTableRows(tbody);
        },
        saveForecast(e) {
            e.preventDefault();
            const form = e.target;
            const consultantId = parseInt(form.elements['forecast-consultant-id'].value);
            const month = form.elements['forecast-month'].value;
            const amount = parseFloat(form.elements['forecast-amount'].value);

            if (!month || isNaN(amount) || amount <= 0) {
                App.UI.toast('Please enter a valid month and positive amount.', 'error');
                return;
            }

            let forecasts = App.DB.get('forecasts');
            const existingIndex = forecasts.findIndex(f => f.consultantId === consultantId && f.month === month);

            if (existingIndex > -1) {
                // Update existing forecast
                forecasts[existingIndex].amount = amount;
                App.Helpers.logChange('Updated', 'Target', `for ${month}`, `New amount: ${App.Helpers.formatCurrency(amount)}`);
            } else {
                // Add new forecast
                const newForecast = { id: `f-${Date.now()}`, consultantId, month, amount };
                forecasts.push(newForecast);
                App.Helpers.logChange('Created', 'Target', `for ${month}`, `Amount: ${App.Helpers.formatCurrency(amount)}`);
            }
            
            App.DB.set('forecasts', forecasts);
            App.UI.toast('Target saved!', 'success');
            form.elements['forecast-amount'].value = '';

            this.renderForecastsForConsultant(consultantId);
        },
        deleteForecast(forecastId) {
            const forecasts = App.DB.get('forecasts');
            const forecast = forecasts.find(f => f.id === forecastId);
            if (!forecast) return;
            
            App.UI.confirm('Delete this target?', `Are you sure you want to delete the target for ${forecast.month}?`, () => {
                const updatedForecasts = forecasts.filter(f => f.id !== forecastId);
                App.DB.set('forecasts', updatedForecasts);
                App.Helpers.logChange('Deleted', 'Target', `for ${forecast.month}`);
                App.UI.toast('Target deleted.', 'success');
                this.renderForecastsForConsultant(forecast.consultantId);
            });
        }
    });
	Object.assign(App.Users, { 
        render: function() { 
            let users = App.DB.get('users'); 
            const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
            const { column, order } = App.state.tableSorts.users;
            users.sort((a,b) => {
                let valA = column === 'assignedConsultantId' ? consultantMap[a.assignedConsultantId] || '' : a[column];
                let valB = column === 'assignedConsultantId' ? consultantMap[b.assignedConsultantId] || '' : b[column];
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            const { currentPage, rowsPerPage } = App.state.pagination.users;
            const startIndex = (currentPage - 1) * rowsPerPage;
            const paginatedUsers = users.slice(startIndex, startIndex + rowsPerPage);

            const tbody = document.getElementById('user-table-body'); 
            if (paginatedUsers.length > 0) {
                tbody.innerHTML = paginatedUsers.map(u => `<tr><td><div style="font-weight:600;">${u.username}</div></td><td>${u.fullName}</td><td><span class="status-badge ${u.role}">${u.role}</span></td><td>${consultantMap[u.assignedConsultantId] || 'N/A'}</td><td>${u.department || 'N/A'}</td><td>${u.lastLogin ? App.Helpers.timeAgo(u.lastLogin) : 'Never'}</td><td><div class="d-flex gap-2"><button class="btn btn-outline edit-user" data-id="${u.id}" title="Edit"><i class="fas fa-edit"></i></button><button class="btn btn-danger delete-user" data-id="${u.id}" title="Delete"><i class="fas fa-trash"></i></button></div></td></tr>`).join('');
            } else {
                tbody.innerHTML = App.UI.getEmptyStateHTML('fa-users-cog', 'No Users Found', 'Click the button above to add a new user.');
            }
            App.UI.animateTableRows(tbody);
            App.UI.renderPaginationControls('users', users.length);
            App.UI.updateSortIndicators('users');
        }, 
        setupEventListeners: function() { document.getElementById('add-user-btn').addEventListener('click', () => this.showUserForm()); document.getElementById('user-form').addEventListener('submit', (e) => this.saveUser(e)); document.getElementById('user-table-body').addEventListener('click', e => { const editBtn = e.target.closest('.edit-user'); const deleteBtn = e.target.closest('.delete-user'); if (editBtn) this.showUserForm(editBtn.dataset.id); if (deleteBtn) this.deleteUser(deleteBtn.dataset.id); }); document.getElementById('role').addEventListener('change', e => { document.getElementById('assigned-consultant-group').style.display = e.target.value === 'user' ? 'block' : 'none'; }); document.querySelector('#users-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('users', th.dataset.sort); }); }, 
        showUserForm: function(id = null) { 
            const form = document.getElementById('user-form'); 
            form.reset(); 
            const consultantSelect = form.elements['assignedConsultantId']; 
            const consultants = App.DB.get('consultants'); 
            consultantSelect.innerHTML = `<option value="">N/A</option>` + consultants.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); 
            const passwordInput = form.elements['password'];
            if (id) { 
                const user = App.DB.get('users').find(u => u.id == id); 
                document.getElementById('user-modal-title').textContent = 'Edit User'; 
                form.elements['user-id-hidden'].value = user.id; 
                form.elements['username'].value = user.username; 
                form.elements['username'].readOnly = true; 
                form.elements['fullName'].value = user.fullName; 
                passwordInput.value = atob(user.password); // Decode for viewing/editing
                form.elements['department'].value = user.department || '';
                form.elements['role'].value = user.role; 
                form.elements['assignedConsultantId'].value = user.assignedConsultantId || ''; 
                form.originalData = {...user};
            } else { 
                document.getElementById('user-modal-title').textContent = 'Add New User'; 
                form.elements['user-id-hidden'].value = ''; 
                form.elements['username'].readOnly = false; 
                form.originalData = null;
            } 
            document.getElementById('assigned-consultant-group').style.display = form.elements['role'].value === 'user' ? 'block' : 'none'; 
            App.UI.openModal('user-modal'); 
        }, 
        saveUser: function(e) { 
            e.preventDefault(); 
            const form = e.target; 
            const id = form.elements['user-id-hidden'].value; 
            let users = App.DB.get('users'); 
            const userData = { 
                username: form.elements['username'].value.trim(), 
                fullName: form.elements['fullName'].value.trim(), 
                password: btoa(form.elements['password'].value), // Encode password on save
                role: form.elements['role'].value, 
                department: form.elements['department'].value.trim(),
                assignedConsultantId: form.elements['role'].value === 'user' ? parseInt(form.elements['assignedConsultantId'].value) || null : null 
            }; 
            if (!userData.username || !userData.fullName || !form.elements['password'].value) return App.UI.toast('All fields are required.', 'error'); 
            if (id) { 
                const index = users.findIndex(u => u.id == id);
                const original = form.originalData;
                const changes = App.Helpers.getObjectChanges(original, {...original, ...userData});
                users[index] = { ...users[index], ...userData };
                App.Helpers.logChange('Updated', 'User', `'${userData.username}'`, changes);
            } else { 
                if (users.some(u => u.username === userData.username)) { return App.UI.toast('Username already exists.', 'error'); } 
                users.push({ id: Date.now(), ...userData, lastLogin: null }); 
                App.Helpers.logChange('Created', 'User', `'${userData.username}'`);
            } 
            App.DB.set('users', users); 
            App.UI.closeModal('user-modal'); 
            App.UI.toast(`User ${id ? 'updated' : 'added'}!`); 
            this.render(); 
        }, 
        deleteUser: function(id) { if (id == App.state.currentUser.id) { return App.UI.toast('You cannot delete your own account.', 'error'); } App.UI.confirm('Are you sure?', "This will delete the user account.", () => { let users = App.DB.get('users'); const user = users.find(u => u.id == id); users = users.filter(u => u.id != id); App.DB.set('users', users); App.Helpers.logChange('Deleted', 'User', `'${user.username}'`); App.UI.toast('User deleted.', 'success'); this.render(); }); } 
    });
    Object.assign(App.Notifications, { init() { document.getElementById('notification-bell-btn').addEventListener('click', (e) => { e.stopPropagation(); this.toggleDropdown(); }); document.body.addEventListener('click', (e) => { const bellBtn = document.getElementById('notification-bell-btn'); const dropdown = document.getElementById('notification-dropdown'); if (dropdown && !dropdown.classList.contains('hidden') && !bellBtn.contains(e.target) && !dropdown.contains(e.target)) { dropdown.classList.add('hidden'); } }); }, create(message) { let notifications = App.DB.get('notifications'); const newNotification = { id: `notif_${Date.now()}`, timestamp: Date.now(), message: message, isRead: false }; notifications.unshift(newNotification); App.DB.set('notifications', notifications); if(App.state.currentUser && App.state.currentUser.role === 'admin') this.render(); }, render() { const notifications = App.DB.get('notifications').sort((a, b) => b.timestamp - a.timestamp); const unreadCount = notifications.filter(n => !n.isRead).length; const badge = document.getElementById('notification-badge'); if (unreadCount > 0) { badge.textContent = unreadCount; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } const list = document.getElementById('notification-list'); list.innerHTML = notifications.length > 0 ? notifications.slice(0, 15).map(n => `<li style="padding: var(--spacing-2) 0; border-bottom: 1px solid var(--border-color); ${!n.isRead ? 'font-weight: 600;' : ''}">${n.message}<div style="font-size: var(--fs-sm); color: var(--text-secondary); font-weight: 400; margin-top: 4px;"><i class="fas fa-clock"></i> ${App.Helpers.timeAgo(n.timestamp)}</div></li>`).join('') : '<li>No new notifications.</li>'; }, toggleDropdown() { const dropdown = document.getElementById('notification-dropdown'); const bellBtn = document.getElementById('notification-bell-btn'); const rect = bellBtn.getBoundingClientRect(); dropdown.style.top = `${rect.bottom + 10}px`; dropdown.style.right = `${window.innerWidth - rect.right}px`; dropdown.classList.toggle('hidden'); if(!dropdown.classList.contains('hidden')) { this.markAllAsRead(); } }, markAllAsRead() { let notifications = App.DB.get('notifications'); if (notifications.some(n => !n.isRead)) { setTimeout(() => { const updatedNotifications = notifications.map(n => ({ ...n, isRead: true })); App.DB.set('notifications', updatedNotifications); this.render(); }, 1500); } } });
    Object.assign(App.CommandPalette, { init() { window.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'k') { e.preventDefault(); this.open(); } }); document.getElementById('command-palette-input').addEventListener('input', App.Helpers.debounce(e => this.search(e.target.value), 200)); document.getElementById('command-palette-modal').addEventListener('click', (e) => { if (e.target.id === 'command-palette-modal') this.close(); }); }, open() { App.UI.openModal('command-palette-modal'); document.getElementById('command-palette-input').focus(); }, close() { document.getElementById('command-palette-input').value = ''; document.getElementById('command-palette-results').innerHTML = ''; App.UI.closeModal('command-palette-modal'); }, search(query) { const resultsContainer = document.getElementById('command-palette-results'); if (!query || query.length < 2) { resultsContainer.innerHTML = ''; return; } const q = query.toLowerCase(); let results = []; App.DB.get('customers').forEach(c => { if (c.companyName.toLowerCase().includes(q) || c.accountNo.toLowerCase().includes(q)) { results.push({ type: 'Customer', title: c.companyName, description: `Account: ${c.accountNo} | Consultant: ${c.salesConsultant}`, action: () => { App.Customers.showCustomerDetail(c.accountNo); } }); } }); App.DB.get('payments').forEach(p => { if (p.id.toLowerCase().includes(q)) { const customer = App.DB.get('customers').find(c => c.accountNo === p.customerId); results.push({ type: 'Payment', title: `Payment: ${App.Helpers.formatCurrency(p.amount)}`, description: `ID: ${p.id} | For: ${customer ? customer.companyName : 'N/A'}`, action: () => { App.Payments.showPaymentDetail(p.id); } }); } }); this.renderResults(results); }, renderResults(results) { const container = document.getElementById('command-palette-results'); if (results.length === 0) { container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-secondary);">No results found.</div>'; return; } container.innerHTML = results.map(r => `<div class="command-result-item" role="button" tabindex="0"><div style="font-size: var(--fs-sm); color: var(--primary); font-weight: 600;">${r.type}</div><div style="font-weight: 500;">${r.title}</div><div style="font-size: var(--fs-sm); color: var(--text-secondary);">${r.description}</div></div>`).join(''); document.querySelectorAll('.command-result-item').forEach((item, index) => { item.addEventListener('click', () => { results[index].action(); this.close(); }); }); if (!document.getElementById('command-palette-styles')) { const style = document.createElement('style'); style.id = 'command-palette-styles'; style.innerHTML = `.command-result-item { padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; margin-bottom: 0.25rem; } .command-result-item:hover, .command-result-item:focus { background-color: var(--bg-color); outline: none; }`; document.head.appendChild(style); } } });
    Object.assign(App.ChangeLog, { render() { let log = App.DB.get('changeLog'); const search = document.getElementById('changelog-search').value.toLowerCase(); if (search) { log = log.filter(entry => entry.user.toLowerCase().includes(search) || entry.action.toLowerCase().includes(search) || (entry.details && entry.details.toLowerCase().includes(search)) || (entry.entityName && entry.entityName.toLowerCase().includes(search))); } const { column, order } = App.state.tableSorts.changelog; log.sort((a,b) => { let valA = a[column]; let valB = b[column]; if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } if (valA < valB) return order === 'asc' ? -1 : 1; if (valA > valB) return order === 'asc' ? 1 : -1; return 0; }); const { currentPage, rowsPerPage } = App.state.pagination.changelog; const startIndex = (currentPage - 1) * rowsPerPage; const paginatedLog = log.slice(startIndex, startIndex + rowsPerPage); const tbody = document.getElementById('changelog-table-body'); if(paginatedLog.length > 0) { tbody.innerHTML = paginatedLog.map(entry => `<tr><td>${new Date(entry.timestamp).toLocaleString()}</td><td>${entry.user}</td><td>${entry.action}</td><td>${entry.entityType}: ${entry.entityName}</td><td>${entry.details || 'N/A'}</td></tr>`).join(''); } else { tbody.innerHTML = App.UI.getEmptyStateHTML('fa-history', 'No Log Entries Found', 'Changes to data will be recorded here.'); } App.UI.animateTableRows(tbody); App.UI.renderPaginationControls('changelog', log.length); App.UI.updateSortIndicators('changelog'); }, setupEventListeners() { const debouncedSearch = App.Helpers.debounce(() => {App.state.pagination.changelog.currentPage = 1; this.render()}, 300); document.getElementById('changelog-search').addEventListener('input', debouncedSearch); document.querySelector('#changelog-page .data-table thead').addEventListener('click', (e) => { const th = e.target.closest('th'); if (th && th.dataset.sort) App.UI.handleTableSort('changelog', th.dataset.sort); }); } });
    Object.assign(App.Import, { init: function() { const dropZone = document.getElementById('csv-drop-zone'); const fileInput = document.getElementById('csv-file-input'); const sampleLink = document.getElementById('download-sample-csv-link'); dropZone.addEventListener('click', () => fileInput.click()); fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files[0])); dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); }); dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover')); dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length) { this.handleFileSelect(e.dataTransfer.files[0]); } }); sampleLink.addEventListener('click', (e) => { e.preventDefault(); this.downloadSampleCSV(); }); }, 
    handleFileSelect: function(file) {
        if (!file) return;
        const isCSVType = file.type === 'text/csv';
        const isCSVExtension = file.name.toLowerCase().endsWith('.csv');
        if (!(isCSVType || isCSVExtension)) {
            App.UI.toast('Please select a valid CSV file.', 'error');
            return;
        }
        document.getElementById('csv-filename').textContent = file.name;
        const reader = new FileReader();
        reader.onload = (event) => { this.processCSV(event.target.result); };
        reader.readAsText(file);
    },
    processCSV: function(csvText) {
        const rows = csvText.split(/\r?\n/).filter(row => row.trim() !== '');
        if (rows.length < 2) { App.UI.toast('CSV file is empty or has no data rows.', 'error'); return; }

        let headerRow = rows.shift().replace(/^\uFEFF/, '');
        const delimiter = headerRow.includes(';') ? ';' : ',';
        const originalHeaders = headerRow.split(delimiter);
        const cleanedHeaders = originalHeaders.map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());

        if (cleanedHeaders.length < 2) {
            return App.UI.toast('Invalid CSV format. Please ensure it is properly comma-separated.', 'error');
        }

        const expectedHeaders = ['accountnumber', 'companyname', 'emirate', 'area', 'status', 'paymentstatus', 'initialdebt', 'outstandingamount', 'salesconsultant'];
        const headerMap = {};
        
        expectedHeaders.forEach(eh => {
            const index = cleanedHeaders.findIndex(ch => ch === eh);
            if (index !== -1) headerMap[eh] = index;
        });
        
        if (!headerMap.hasOwnProperty('accountnumber') || !headerMap.hasOwnProperty('companyname')) {
            App.UI.toast('CSV must contain "accountNumber" and "companyName" headers.', 'error');
            return;
        }
        
        let existingCustomers = App.DB.get('customers');
        const existingAccountNos = new Set(existingCustomers.map(c => c.accountNo.toLowerCase()));
        let newCustomers = [];
        let skippedCount = 0;
        let consultants = App.DB.get('consultants');
        let newConsultantNames = new Set();
        
        rows.forEach(row => {
            const cells = row.split(delimiter);
            const getCellValue = (key) => {
                const index = headerMap[key];
                if (index !== undefined && cells[index] !== undefined) {
                    return cells[index].trim().replace(/^"|"$/g, '');
                }
                return undefined;
            };

            const accountNo = getCellValue('accountnumber');
            if (!accountNo || existingAccountNos.has(accountNo.toLowerCase())) { 
                skippedCount++; 
                return; 
            }
            
            const salesConsultantName = getCellValue('salesconsultant') || 'Unassigned';
            if (salesConsultantName !== 'Unassigned' && !consultants.some(c => c.name.toLowerCase() === salesConsultantName.toLowerCase())) {
                newConsultantNames.add(salesConsultantName);
            }
            newCustomers.push({ rowData: cells, consultantName: salesConsultantName });
            existingAccountNos.add(accountNo.toLowerCase());
        });

        let newConsultantCount = 0;
        if (newConsultantNames.size > 0) {
            newConsultantNames.forEach(name => {
                const newId = Date.now() + newConsultantCount;
                consultants.push({ id: newId, name: name });
                App.Helpers.logChange('Created', 'Consultant', `'${name}'`, 'Auto-created via CSV import.');
                newConsultantCount++;
            });
            App.DB.set('consultants', consultants);
        }

        const finalCustomers = newCustomers.map(item => {
            const cells = item.rowData;
            const getCellValue = (key) => {
                const index = headerMap[key];
                return (index !== undefined && cells[index] !== undefined) ? cells[index].trim().replace(/^"|"$/g, '') : undefined;
            };
            const consultant = consultants.find(c => c.name.toLowerCase() === item.consultantName.toLowerCase());
            return {
                accountNo: getCellValue('accountnumber'), 
                companyName: getCellValue('companyname') || 'N/A', 
                emirate: getCellValue('emirate') || 'Dubai', 
                area: getCellValue('area') || 'N/A', 
                status: getCellValue('status') || 'Active', 
                paymentStatus: getCellValue('paymentstatus') || 'Pending', 
                initialDebt: parseFloat(getCellValue('initialdebt')) || 0, 
                outstanding: parseFloat(getCellValue('outstandingamount')) || 0, 
                salesConsultantId: consultant ? consultant.id : null
            };
        });

        if (finalCustomers.length > 0) {
            App.DB.set('customers', [...existingCustomers, ...finalCustomers]);
            let feedback = `Import successful! Added ${finalCustomers.length} new customers.`;
            if (newConsultantCount > 0) {
                feedback += ` Added ${newConsultantCount} new consultants.`;
            }
            App.UI.toast(feedback, 'success');
            if (skippedCount > 0) { App.UI.toast(`${skippedCount} rows were skipped (duplicates or missing account #).`, 'warning'); }
        } else { App.UI.toast('No new customers to import.', 'info'); }
        
        App.UI.closeModal('import-csv-modal');
        App.Customers.render();
        if(App.state.activePage === 'consultants') App.Consultants.render();
    }, 
    downloadSampleCSV: function() { 
        const headers = "accountNumber,companyName,emirate,area,status,paymentStatus,initialDebt,outstandingAmount,salesConsultant"; 
        const exampleRow = "DXB-123,Sample Trading LLC,Dubai,Al Quoz,Active,Overdue,50000,12500,John Doe"; 
        const csvContent = headers + "\n" + exampleRow; 
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
        const link = document.createElement("a"); const url = URL.createObjectURL(blob); 
        link.setAttribute("href", url); 
        link.setAttribute("download", "customer_import_template.csv"); 
        link.style.visibility = 'hidden'; 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
    } 
});
    Object.assign(App.Settings, {
        render() {},
        setupEventListeners() {
            const settingsPage = document.getElementById('settings-page');
            settingsPage.addEventListener('click', e => {
                if (e.target.id === 'backup-data-btn') this.backupData();
                if (e.target.id === 'restore-data-btn') this.handleRestore();
            });

            const restoreInput = document.getElementById('restore-file-input');
            const restoreBtn = document.getElementById('restore-data-btn');
            if (restoreInput) {
                restoreInput.addEventListener('change', () => {
                    restoreBtn.disabled = !restoreInput.files.length;
                });
            }
        },
        backupData() {
            const format = document.querySelector('input[name="backup-format"]:checked').value;
            const dateStr = new Date().toISOString().slice(0, 10);

            if (format === 'json') {
                const dataToBackup = {};
                const keysToBackup = ['customers', 'visits', 'payments', 'users', 'consultants', 'activityLog', 'changeLog', 'notifications', 'dataModelVersion', 'forecasts'];
                keysToBackup.forEach(key => {
                    dataToBackup[key] = JSON.parse(localStorage.getItem(key));
                });
                App.Helpers.downloadBlob(JSON.stringify(dataToBackup, null, 2), `erp-backup-${dateStr}.json`, 'application/json');
            } else if (format === 'csv') {
                const tables = ['customers', 'visits', 'payments', 'consultants', 'users', 'forecasts'];
                tables.forEach(key => {
                    const data = App.DB.get(key);
                    if (data.length > 0) {
                        const headers = Object.keys(data[0]);
                        const csvData = data.map(row => headers.map(header => row[header]));
                        App.Helpers.exportToCSV(`${key}-backup-${dateStr}.csv`, headers, csvData);
                    }
                });
            }
            App.UI.toast('Backup file(s) created!', 'success');
        },
        handleRestore() {
            const fileInput = document.getElementById('restore-file-input');
            const file = fileInput.files[0];
            if (!file) return App.UI.toast('Please select a backup file first.', 'warning');

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(event.target.result);
                        if (!data.customers || !data.users) throw new Error('Invalid JSON backup file.');
                        App.UI.confirm('Overwrite all data?', 'Restoring will replace all current data. Continue?', () => {
                            localStorage.clear();
                            Object.keys(data).forEach(key => localStorage.setItem(key, JSON.stringify(data[key])));
                            App.UI.toast('Restore successful! Reloading...', 'success');
                            setTimeout(() => location.reload(), 1500);
                        });
                    } else if (file.name.endsWith('.csv')) {
                        App.UI.confirm('Overwrite Customers?', 'This will add customers from the CSV. Existing customers with the same Account # will be skipped. Continue?', () => {
                            App.Import.processCSV(event.target.result);
                            App.UI.toast('Customer import from CSV complete!', 'success');
                            fileInput.value = '';
                        });
                    } else {
                        throw new Error('Unsupported file type.');
                    }
                } catch (error) { App.UI.toast(`Error reading file: ${error.message}`, 'error'); }
            };
            reader.readAsText(file);
        }
    });
    Object.assign(App.Helpers, { formatCurrency: (a) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'AED', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(a), formatAbbreviatedCurrency: (num) => { if (num >= 1000000) return 'AED ' + (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M'; if (num >= 1000) return 'AED ' + (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K'; return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'AED' }).format(num); }, debounce: (f, d) => { let t; return function(...a) { clearTimeout(t); t = setTimeout(() => f.apply(this, a), d); }; }, 
    formatDate: (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    },
    formatDateTime: (dateString) => {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
    }, 
    formatDuration(ms) {
        if (ms <= 0) return '00:00:00';
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
        const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
    },
    timeAgo(timestamp) { if (!timestamp) return 'Never'; const now = new Date(); const seconds = Math.floor((now - new Date(timestamp)) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago"; return Math.floor(seconds) + " seconds ago"; }, getScopedData(dataType) { const { currentUser } = App.state; if (!currentUser) return []; if (currentUser.role === 'admin') return App.DB.get(dataType); if (currentUser.role === 'user') { const consultantId = currentUser.assignedConsultantId; const allCustomers = App.DB.get('customers'); const scopedCustomers = allCustomers.filter(c => c.salesConsultantId === consultantId); if (dataType === 'customers') return scopedCustomers; const scopedCustomerIds = scopedCustomers.map(c => c.accountNo); if (dataType === 'visits') return App.DB.get('visits').filter(v => scopedCustomerIds.includes(v.customerId)); if (dataType === 'payments') return App.DB.get('payments').filter(p => scopedCustomerIds.includes(p.customerId)); } return App.DB.get(dataType); }, 
    logActivity(action, details = '', customerId = null, amount = null, visitId = null, duration = null) {
        if (App.state.currentUser.role !== 'user') return;
        const log = App.DB.get('activityLog');
        const now = new Date();
        const newEntry = { 
            id: Date.now(), 
            consultantId: App.state.currentUser.assignedConsultantId, 
            timestamp: now.getTime(), 
            date: now.toISOString().slice(0, 10), 
            time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }), 
            action, 
            details,
            customerId,
            amount: amount,
            visitId: visitId,
            duration: duration
        };
        log.push(newEntry);
        App.DB.set('activityLog', log);
        
        let notificationMessage;
        const consultantName = App.DB.get('consultants').find(c => c.id === newEntry.consultantId)?.name || 'A user';
        if(customerId) {
            const customerName = App.DB.get('customers').find(c => c.accountNo === customerId)?.companyName || 'a customer';
            let messageDetails = details;
            if (amount) {
                messageDetails = `${App.Helpers.formatCurrency(amount)} ${details}`;
            }
            notificationMessage = `${consultantName} ${action.replace(/a |an /, '')} for ${customerName} ${messageDetails}`;
        } else {
             notificationMessage = `${consultantName} has ${action.toLowerCase()}`;
        }
        App.Notifications.create(notificationMessage); 
    }, 
    logChange(action, entityType, entityName, details = '') { const changeLog = App.DB.get('changeLog'); const newEntry = { timestamp: Date.now(), user: App.state.currentUser.fullName, action, entityType, entityName, details }; changeLog.unshift(newEntry); App.DB.set('changeLog', changeLog); },
    getObjectChanges(originalObj, newObj) {
        if (!originalObj) return 'New record created.';
        const changes = [];
        const allKeys = new Set([...Object.keys(originalObj), ...Object.keys(newObj)]);
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map;}, {});

        for (let key of allKeys) {
            if (['id', 'originalData'].includes(key)) continue;
            
            if (key === 'password') {
                if (originalObj.password !== newObj.password) {
                    changes.push('Password was changed.');
                }
                continue;
            }

            let before = originalObj[key];
            let after = newObj[key];

            if (key === 'salesConsultantId' || key === 'assignedConsultantId') {
                before = consultantMap[before] || 'N/A';
                after = consultantMap[after] || 'N/A';
            }
            
            if (String(before) !== String(after)) {
                changes.push(`'${key}' changed from "${before}" to "${after}"`);
            }
        }
        return changes.join('; ');
    },
    stripHtml(html) {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        return doc.body.textContent || "";
    },
    parsePaymentDetails(details) {
        if (!details) return { method: 'N/A' };
        const match = details.match(/Method:\s*([^)]+)/);
        return {
            method: match ? match[1].trim() : details
        };
    },
    parseVisitDetails(details) {
        if (!details) return { outcome: 'N/A', extra: '-' };
        const outcomeMatch = details.match(/Outcome:\s*([^,)]+)/);
        const outcome = outcomeMatch ? outcomeMatch[1].trim() : 'Completed';
        const extra = details.replace(/KATEX_INLINE_OPENOutcome:[^)]+KATEX_INLINE_CLOSE,?\s*/, '').trim();
        return {
            outcome: outcome,
            extra: extra || '-'
        };
    },
    downloadBlob(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);
    },
    exportToCSV(filename, headers, data) {
        let csvContent = headers.join(",") + "\r\n";
        data.forEach(rowArray => {
            let row = rowArray.map(item => `"${String(item || '').replace(/"/g, '""')}"`).join(",");
            csvContent += row + "\r\n";
        });
        this.downloadBlob(csvContent, filename, 'text/csv;charset=utf-8;');
    },
    exportToPDF(filename, title, headers, data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(title, 14, 16);
        doc.autoTable({ head: [headers], body: data, startY: 20 });
        doc.save(filename);
    },
    exportTableData(format, entityName, getDataCallback, displayColumns) {
        const allData = getDataCallback();
        const consultantMap = App.DB.get('consultants').reduce((map, c) => { map[c.id] = c.name; return map; }, {});
        const customerMap = App.DB.get('customers').reduce((map, c) => { map[c.accountNo] = c.companyName; return map; }, {});

        const headers = displayColumns.map(key => {
            if (key === 'accountNo') return 'Account #';
            if (key === 'companyName') return 'Company Name';
            if (key === 'salesConsultantId') return 'Consultant';
            if (key === 'customerId') return 'Customer';
            if (key === 'collectorId') return 'Consultant';
            if (key === 'dateTime') return 'Date';
            return key.charAt(0).toUpperCase() + key.slice(1);
        });

        const data = allData.map(item => {
            return displayColumns.map(key => {
                let value = item[key];
                if (key === 'salesConsultantId' || key === 'collectorId') {
                    return consultantMap[value] || 'N/A';
                }
                if (key === 'customerId') {
                    return customerMap[value] || 'N/A';
                }
                if (key === 'dateTime' || key === 'date') {
                    return App.Helpers.formatDate(value);
                }
                return value || '';
            });
        });

        const filename = `${entityName}_Report_${new Date().toLocaleDateString()}`;
        if (format === 'csv') {
            App.Helpers.exportToCSV(filename + '.csv', headers, data);
        } else {
            App.Helpers.exportToPDF(filename + '.pdf', `${entityName} List`, headers, data);
        }
    }
});
</script>
</body>
</html>
